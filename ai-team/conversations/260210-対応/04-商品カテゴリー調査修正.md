# T4: 商品カテゴリーが全て「未分類」になる問題の調査・修正

## 概要
前年同月比分析画面で、商品カテゴリーが全て「未分類」と表示される問題。

## 事象
- 前年同月比分析画面の商品カテゴリーが全て「未分類」表示
- 商品タイプ（productType）は取得できている
- 商品カテゴリー（category）が取得できていない可能性

## 調査結果

### Shopify APIの仕様
- Shopify **REST API** には独立した `category` フィールドが存在しない
- REST APIで取得可能なのは `product_type`（商品タイプ）
- Shopify の商品カテゴリー（商品分類）は **GraphQL API** で `productCategory { productTaxonomyNode { name } }` として取得可能

### 現在のマッピングロジック

**ファイル**: `backend/ShopifyAnalyticsApi/Services/ShopifyApiService.cs`

#### 商品更新時（685-689行目）
```csharp
existingProduct.ProductType = product.ProductType;
existingProduct.Category = !string.IsNullOrWhiteSpace(product.ProductType)
  ? product.ProductType
  : null;
```

#### 商品作成時（727-735行目）
```csharp
var newProduct = new Product {
  ProductType = product.ProductType,
  Category = !string.IsNullOrWhiteSpace(product.ProductType)
    ? product.ProductType
    : null,
  ...
}
```

**コメント（685行目付近）**: 「RESTに商品カテゴリーがないため、商品タイプをCategoryにマッピング」

### データベースモデル
**ファイル**: `backend/ShopifyAnalyticsApi/Models/DatabaseModels.cs` 328-334行目

```csharp
[MaxLength(100)]
public string? Category { get; set; }

[MaxLength(100)]
public string? ProductType { get; set; }  // 商品タイプ
```

両方のフィールドが存在し、`Category` には `ProductType` の値がコピーされる。

### 前年同月比クエリ
**ファイル**: `backend/ShopifyAnalyticsApi/Services/YearOverYearService.cs` 453-459行目

```csharp
var productTypes = await _context.OrderItems
  .Join(_context.Orders, oi => oi.OrderId, o => o.Id, (oi, o) => new { oi, o })
  .Where(x => x.o.StoreId == storeId && !x.o.IsTest)
  .Select(x => x.oi.ProductType ?? "未分類")  // ← ProductTypeがnullなら「未分類」
  .Distinct()
  .ToListAsync();
```

`OrderItems` テーブルの `ProductType` がnullの場合、「未分類」と表示される。

## 原因の可能性

### 可能性1: ProductTypeがShopifyストアで未設定
テストストアの商品に `product_type` が設定されていない場合、全て「未分類」になる。
→ Shopify管理画面で商品の「商品タイプ」を確認

### 可能性2: OrderItemsにProductTypeが同期されていない
OrderItemsテーブルにProductTypeを保存する際のマッピングが不足している可能性。
→ OrderItem作成時のマッピングロジックを確認

### 可能性3: 商品カテゴリーとProductTypeは別物
ユーザーが期待しているのはShopifyの「商品カテゴリー（taxonomy）」であり、「商品タイプ」とは異なるフィールド。
→ GraphQL APIでの取得が必要

## 対応方針

### Step 1: データ確認（最優先）
1. テストストアのShopify管理画面で商品の「商品タイプ」と「商品カテゴリー」の設定状況を確認
2. DBの `Products` テーブルで `ProductType` と `Category` の値を確認
3. DBの `OrderItems` テーブルで `ProductType` の値を確認

### Step 2: 原因に応じた対応

#### ProductTypeが未設定の場合
- テストデータに商品タイプを設定してデータ同期を再実行
- ユーザーへの案内: 商品タイプを設定すればカテゴリーとして表示される

#### OrderItemsへのマッピング不足の場合
- OrderItem作成/更新時に関連するProductのProductTypeをコピーするロジックを追加

#### GraphQLでのカテゴリー取得が必要な場合
- 商品同期ジョブにGraphQLクエリを追加して `productCategory.productTaxonomyNode.name` を取得
- Productテーブルの `Category` フィールドにGraphQLから取得した値を保存
- 影響範囲が大きいため、他の対応と優先度を比較して判断

## 確認チェックリスト
- [ ] テストストアの商品にproductTypeが設定されているか確認
- [ ] DBのProductsテーブルでCategory/ProductTypeの値を確認
- [ ] DBのOrderItemsテーブルでProductTypeの値を確認
- [ ] 前年同月比分析画面でカテゴリーが正しく表示されることを確認
