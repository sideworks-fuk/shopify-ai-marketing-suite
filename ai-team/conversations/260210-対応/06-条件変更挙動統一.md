# T6: 条件変更時の挙動統一（前年同月比・購入回数分析）

## 概要
前年同月比分析画面と購入回数分析画面で、条件変更時の挙動がバラバラで分かりづらい。条件の種類ごとにルールを決め、両画面で統一する。

## 現状の事象

### 前年同月比分析画面
**ファイル**: `frontend/src/components/dashboards/YearOverYearProductAnalysis.tsx`

| 条件 | 現在の挙動 | 該当行 |
|------|-----------|--------|
| 並び順 | 即時再描画（クライアント側ソート） | 532行目 |
| フィルター（成長率） | 即時再描画（クライアント側フィルタ） | 549行目 |
| 表示データ（viewMode） | データクリア → 「分析実行」ボタン必要 | 510-516行目 |
| 対象年 | **タイトルのみ変更、データは再取得されない** | 481行目 |
| 分析実行ボタン | API再取得 | 593-610行目 |

### 購入回数分析画面
**ファイル**: `frontend/src/components/dashboards/PurchaseCountAnalysis.tsx`

| 条件 | 現在の挙動 | 該当行 |
|------|-----------|--------|
| 条件変更全般 | `conditions.timestamp` が変わった時のみ再取得 | 103-105行目 |
| 分析実行ボタン | 親コンポーネントから `timestamp` 更新で再取得 | - |

## 問題点

1. **対象年を変更した場合**: テーブルタイトルの年は変わるが、データは前の年のまま表示される。ユーザーはデータが切り替わったと誤認する可能性がある
2. **表示データの変更**: 「分析実行」ボタンが必要だが、並び順変更は即時反映される。同じ画面内で操作方法が異なる
3. **画面間の不統一**: 前年同月比分析と購入回数分析で異なる挙動パターン

## 対応方針

### 条件の分類ルール

| 条件の種類 | 挙動 | 理由 |
|-----------|------|------|
| 並び順・フィルタ | **即時再描画** | クライアント側で完結。API呼び出し不要 |
| 対象年・表示データ・分析期間 | **「分析実行」ボタンで再取得** | サーバーからのデータ再取得が必要 |

### 対象年変更時の挙動改善

**現状**: タイトルだけ変わりデータは古いまま
**改善案（2択）**:

#### 案A: 条件変更時に自動で再取得
- 対象年やviewModeを変更した瞬間にAPIを自動呼び出し
- メリット: ユーザーが「分析実行」を押す手間がない
- デメリット: 条件を複数変更する際にAPI呼び出しが頻発

#### 案B: 条件変更時にデータをクリアし、「分析実行」を必須にする（推奨）
- 対象年を変更した時点で表示データをクリア（グラフ・テーブルを非表示）
- 「条件が変更されました。分析実行を押してください」のメッセージを表示
- メリット: APIリクエスト数を制御可能、複数条件を変更してから一括取得できる
- デメリット: 1クリック多い

## 対応内容

### Step 1: 対象年変更時の挙動修正
**ファイル**: `frontend/src/components/dashboards/YearOverYearProductAnalysis.tsx`

対象年の `onValueChange` ハンドラで:
1. `setSelectedYear(parseInt(value))` に加えて
2. `setApiData(null)` と `setHasData(false)` を実行してデータをクリア
3. 既に `viewMode` 変更時（510-516行目）で同様のクリア処理があるため、そのパターンに合わせる

### Step 2: 視覚的フィードバックの追加
データがクリアされた後の状態で:
- グラフエリアに「分析実行を押してデータを取得してください」と表示
- または `hasData === false` の場合のプレースホルダーメッセージを追加

### Step 3: 購入回数分析画面との統一
`PurchaseCountAnalysis.tsx` でも同様のパターンを適用:
- サーバー依存の条件変更 → データクリア + 「分析実行」必須
- クライアント側の条件変更 → 即時再描画

### Step 4: 両画面での一貫性確認
- 前年同月比分析と購入回数分析の両方で、同種の条件変更が同じ挙動になること
- UI上のフィードバック（ボタンの有効/無効、メッセージ表示）も統一

## 確認チェックリスト
- [ ] 対象年変更時: データがクリアされ、古いデータが残らないこと
- [ ] 表示データ変更時: 「分析実行」ボタンで正しくデータが再取得されること
- [ ] 並び順変更時: 即時再描画されること（API呼び出しなし）
- [ ] フィルタ変更時: 即時再描画されること（API呼び出しなし）
- [ ] 前年同月比分析と購入回数分析で同じ操作パターンであること
- [ ] 条件変更後のプレースホルダーメッセージが表示されること
