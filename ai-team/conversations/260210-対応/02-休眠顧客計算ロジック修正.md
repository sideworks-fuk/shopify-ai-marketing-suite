# T2: 休眠顧客計算ロジック修正

## 概要
総休眠顧客数の計算に購入履歴のない顧客が含まれている問題。全ての指標を「購入履歴ありの顧客のみ」で統一する。

## 事象
- 右側2つの指標は購入履歴ありの顧客のみで算出されている
- 左側の総休眠顧客数は全顧客を対象にしており、不整合が発生
- 例: テストストア100名中、購入履歴なし9名 → 右側は91名ベース、左側は100名ベース
- 休眠率が54.9%と表示されるが、正しくは50/91≒54.9%（結果は同じだが母数の考え方が不一致）

## 調査結果

### バックエンド: フィルタは既に適用済み

#### DormantStatisticsService.cs
**ファイル**: `backend/ShopifyAnalyticsApi/Services/Dormant/DormantStatisticsService.cs`

- **64行目**: `totalCustomersWithOrders` で `TotalOrders > 0` フィルタ適用済み
- **150行目**: `GetDormantCustomersAsync` 内で `TotalOrders > 0` フィルタ適用済み
- **70行目**: `TotalDormantCustomers = dormantCustomers.Count` → フィルタ済みリストのカウント
- **74行目**: `DormantRate = dormantCustomers.Count / totalCustomersWithOrders * 100`

#### DormantCustomerQueryService.cs
**ファイル**: `backend/ShopifyAnalyticsApi/Services/Dormant/DormantCustomerQueryService.cs`

- **255行目**: `BuildBaseQuery` で `customer.TotalOrders > 0` フィルタ適用済み
- **146行目**: `GetDormantCustomerCountAsync` も `BuildBaseQuery` 経由でフィルタ適用済み

### 確認が必要な点

バックエンドのコードを見る限り、`TotalOrders > 0` フィルタは適用されている。以下を確認する必要がある：

1. **打合せ時点（2/4）と現在のコードに差異がないか**: 打合せ後に既に修正された可能性
2. **フロントエンドのKPIカード表示**: バックエンドAPIとは別のロジックで集計していないか
3. **テストデータでの実際の表示確認**: 購入履歴なし顧客がカウントに含まれていないことを実データで確認

## 対応内容

### 1. バックエンドの確認（最優先）
- `DormantStatisticsService.cs` の `GetDormantSummaryStatsAsync` のレスポンスをAPIで直接確認
- テストストアで購入履歴なし顧客が除外されていることを確認
- `.http` ファイルでAPIレスポンスの値を確認

### 2. フロントエンドの表示確認・修正
**ファイル**: `frontend/src/components/dashboards/dormant/DormantKPICards.tsx`

- **119行目**: 総休眠顧客数のサブタイトル「アクティブ顧客の対象外」
  - → 「購入履歴のある顧客のみで算出」に変更を検討
- **142行目**: 休眠率のサブタイトル「全顧客に対する比率」
  - → 「購入履歴のある顧客に対する比率」に変更を検討
- フロントエンド側で独自に集計していないか確認

### 3. テストデータでの検証
- テストストア（100名、うち購入履歴なし9名）でAPIレスポンスを確認
- 総休眠顧客数が購入履歴あり91名ベースで算出されていることを確認
- 各KPIカードの値が一貫していることを確認

## 確認チェックリスト
- [ ] APIレスポンスで `totalDormantCustomers` が購入履歴あり顧客のみの値であることを確認
- [ ] 休眠率が `dormantCustomers / customersWithOrders * 100` で計算されていることを確認
- [ ] KPIカードの表記が「購入履歴のある顧客のみで算出」に統一されていること
- [ ] テストストアで実際のデータ表示が正しいことを確認
