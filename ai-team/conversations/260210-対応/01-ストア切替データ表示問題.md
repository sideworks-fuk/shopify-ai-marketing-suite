# T1: 複数ストア切替時のデータ表示問題 調査・修正

## 概要
初回アクセス時にデータが表示されず、リロードすると表示される。複数ストアを切り替えた際にデータ表示に不整合が発生する。

## 事象
1. ECレンジャーを起動した瞬間、休眠顧客ページが表示されるがデータが出てこない
2. ページをリロードするとデータが表示される
3. ストアを切り替えた後に元のストアのデータが残る/混在する
4. 再現方法が不安定（出る時と出ない時がある）

## 調査対象ファイル

### 主要ファイル
| ファイル | 役割 |
|---------|------|
| `frontend/src/contexts/StoreContext.tsx` | ストア管理の中核。switchStore関数、localStorage管理 |
| `frontend/src/app/customers/dormant/page.tsx` | 休眠顧客ページ。初期ロード時のデータ取得 |
| `frontend/src/contexts/SubscriptionContext.tsx` | サブスクリプション状態管理。storeId依存 |

### 関連ファイル
| ファイル | 役割 |
|---------|------|
| `frontend/src/contexts/FilterContext.tsx` | フィルタ状態管理（メモリのみ、localStorage使用なし） |
| `frontend/src/stores/appStore.ts` | アプリケーション状態ストア |

## 調査で判明した問題点

### 問題1: switchStore関数のタイミング問題
**ファイル**: `frontend/src/contexts/StoreContext.tsx` 160-174行目

```typescript
const switchStore = (storeId: number) => {
  const store = availableStores.find(s => s.id === storeId)
  if (!store) return
  setIsLoading(true)
  setTimeout(() => {
    setCurrentStore(store)
    localStorage.setItem('currentStoreId', storeId.toString())
    setIsLoading(false)
    window.location.reload()  // ← 全ページリロード
  }, 500)
}
```

- `setTimeout(500ms)` の遅延中に他のコンポーネントが古いストアIDでAPIを呼ぶ可能性
- `localStorage.setItem` が `setCurrentStore` の後にあるため、リロード前にlocalStorageへの書き込みが間に合わない可能性

### 問題2: localStorage復元のレース条件
**ファイル**: `frontend/src/contexts/StoreContext.tsx` 87-98行目

```typescript
useEffect(() => {
  const savedStoreId = localStorage.getItem('currentStoreId')
  if (savedStoreId) {
    const store = availableStores.find(s => s.id === parseInt(savedStoreId))
    if (store) {
      setCurrentStore(store)
    }
  }
}, [availableStores])
```

- `availableStores` がAPIから取得される前にlocalStorageからの復元が試行される
- `availableStores` がまだデフォルト値の場合、`find()` が失敗してストアが設定されない

### 問題3: 休眠顧客ページの初期データ取得
**ファイル**: `frontend/src/app/customers/dormant/page.tsx` 95-130行目, 205-269行目

- Phase 1: localStorageからstoreIdを復元 → `setCurrentStoreId(storeId)` でAuthProvider更新
- Phase 2: `isInitializing` と `isApiClientReady` を待ってからデータ取得
- `resolveStoreId()` がnullを返した場合、サイレントにreturnしてリトライなし
- 複数の非同期処理（StoreContext.fetchStores, AuthProvider, DormantPage.fetchSummaryData）が独立して動作し、調整メカニズムがない

## 対応方針

### 方針A: switchStore関数の修正（推奨）
1. `localStorage.setItem` を `setTimeout` の外（`setCurrentStore` の前）に移動
2. `window.location.reload()` の代わりに、React状態更新で画面を再描画する方法を検討
3. ストア切替時に全データキャッシュをクリアする処理を追加

### 方針B: 初期ロードの安定化
1. `resolveStoreId()` がnullを返した場合のリトライ機構を追加
2. `availableStores` がAPIから取得完了するまでローディング状態を維持
3. ストアIDが確定してからデータ取得を開始する明示的な制御フローを実装

### 方針C: 段階的対応（AとBの組合せ）
1. まず方針Aで即座の改善を実施
2. 次に方針Bで根本的な安定化を実施

## 確認チェックリスト
- [ ] 初回アクセス時にデータが正しく表示されること
- [ ] ストアを切り替えた後、切替先のデータが正しく表示されること
- [ ] ストアを切り替えた後、元のストアに戻した際にデータが正しく表示されること
- [ ] ブラウザリロードなしでデータが表示されること
- [ ] 複数回ストアを切り替えてもデータが混在しないこと
