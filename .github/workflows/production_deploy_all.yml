name: Production Full Deploy (Frontend + Backend)

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - æœ¬ç•ªç’°å¢ƒã«å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'

jobs:
  confirm-deployment:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ›¡ï¸ Production deployment confirmation
      if: github.event.inputs.confirm_production != 'YES - æœ¬ç•ªç’°å¢ƒã«å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
      run: |
        echo "âŒ Production deployment cancelled by user"
        exit 1

    - name: ğŸ“ Display deployment plan
      run: |
        echo "================================================"
        echo "ğŸš€ PRODUCTION FULL DEPLOYMENT PLAN"
        echo "================================================"
        echo "This workflow will deploy:"
        echo "  1. Backend API to Azure App Service (Japan West)"
        echo "  2. Frontend to Azure Static Web Apps (Japan East)"
        echo ""
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "================================================"
        echo "âš ï¸ WARNING: This will update the PRODUCTION environment!"
        echo "================================================"

  deploy-backend:
    needs: confirm-deployment
    runs-on: windows-latest
    environment: ec-ranger-prod
    env:
      DOTNET_VERSION: '8.x'
      APP_NAME: 'ec-ranger-backend-prod'  # Japan West ã® App Service
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Setup NuGet cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: ğŸ”§ Configure NuGet
      run: |
        # NuGet source is already configured in NuGet.Config file
        dotnet nuget list source
      shell: pwsh

    - name: ğŸ“ Backend deployment info
      run: |
        echo "ğŸš€ Starting Backend Deployment"
        echo "Target: Azure App Service (Japan West)"
        echo "App: ${{ env.APP_NAME }}"

    - name: ğŸ” Restore dependencies
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet restore --disable-parallel --verbosity normal
      shell: pwsh

    - name: ğŸ—ï¸ Build project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet build --configuration Release --no-restore

    # - name: ğŸ§ª Run tests
    #   run: |
    #     cd backend
    #     if (Test-Path "*.Tests") {
    #       dotnet test --configuration Release --no-build --verbosity normal
    #     } else {
    #       Write-Host "No test projects found, skipping tests"
    #     }
    #   shell: pwsh
    # Note: Tests temporarily disabled for production deployment - will re-enable after environment stabilization
      continue-on-error: true

    - name: ğŸ“¦ Publish project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet publish -c Release -o ./published --no-restore --no-build

    - name: ğŸš€ Deploy Backend to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION }}
        package: backend/ShopifyAnalyticsApi/published
        app-settings: |
          ASPNETCORE_ENVIRONMENT=Production

    - name: âœ… Backend deployment complete
      run: |
        echo "âœ… Backend deployment completed!"
        echo "ğŸŒ Backend URL: https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net"

  deploy-frontend:
    needs: confirm-deployment
    runs-on: ubuntu-latest
    environment: ec-ranger-prod
    env:
      NODE_VERSION: '20.x'
      APP_LOCATION: '/frontend'
      OUTPUT_LOCATION: ''
      AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Frontend deployment info
      run: |
        echo "ğŸš€ Starting Frontend Deployment"
        echo "Target: Azure Static Web Apps (Japan East)"

    - name: ğŸš€ Deploy Frontend to Azure
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # ç©ºã«ã™ã‚‹ã“ã¨ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: 'https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net'  # Japan West ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ vars.SHOPIFY_API_KEY_PRODUCTION }}'
        NEXT_PUBLIC_SHOPIFY_APP_URL: 'https://white-island-08e0a6300-2.azurestaticapps.net'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        NODE_VERSION: 20

    - name: âœ… Frontend deployment complete
      run: |
        echo "âœ… Frontend deployment completed!"
        echo "ğŸŒ Frontend URL: https://white-island-08e0a6300-2.azurestaticapps.net"

  deployment-summary:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ Final deployment summary
      run: |
        echo "================================================"
        echo "ğŸ‰ PRODUCTION DEPLOYMENT SUMMARY"
        echo "================================================"
        echo "Status:"
        echo "  Backend: ${{ needs.deploy-backend.result }}"
        echo "  Frontend: ${{ needs.deploy-frontend.result }}"
        echo ""
        echo "URLs:"
        echo "  Frontend: https://white-island-08e0a6300.1.azurestaticapps.net"
        echo "  Backend API: https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net"
        echo ""
        echo "Deployed by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Deployment time: $(date)"
        echo "================================================"
        
        if [ "${{ needs.deploy-backend.result }}" = "success" ] && [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
          echo "âœ… All deployments completed successfully!"
        else
          echo "âš ï¸ Some deployments may have issues. Please check the logs."
          exit 1
        fi

    - name: ğŸ¥ Production health check
      if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
      run: |
        echo "Waiting 60 seconds for services to stabilize..."
        sleep 60
        
        echo "Checking Backend API..."
        backend_response=$(curl -s -o /dev/null -w "%{http_code}" https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net/api/health || echo "000")
        
        echo "Checking Frontend..."
        frontend_response=$(curl -s -o /dev/null -w "%{http_code}" https://white-island-08e0a6300.1.azurestaticapps.net || echo "000")
        
        echo ""
        echo "Health Check Results:"
        echo "  Backend API: $backend_response"
        echo "  Frontend: $frontend_response"
        
        if [ "$backend_response" = "200" ] && ([ "$frontend_response" = "200" ] || [ "$frontend_response" = "401" ]); then
          echo "âœ… All services are healthy!"
        else
          echo "âš ï¸ Some services may need attention. Please verify manually."
        fi
