name: Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠ'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

env:
  NODE_VERSION: '18.x'
  APP_LOCATION: '/frontend'
  OUTPUT_LOCATION: '.next'
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BRAVE_SEA_038F17A00 }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Manual Frontend Deployment Started"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Install dependencies
      run: |
        cd frontend
        npm ci --legacy-peer-deps
        echo "âœ… Dependencies installed"

    - name: ğŸ” Run type check
      run: |
        cd frontend
        npm run type-check || true
        echo "âœ… Type check completed"

    - name: ğŸ—ï¸ Build application
      run: |
        cd frontend
        npm run build
        echo "âœ… Build completed"
      env:
        NEXT_PUBLIC_ENVIRONMENT: ${{ github.event.inputs.environment }}
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
        NEXT_PUBLIC_SHOPIFY_API_KEY: ${{ vars.NEXT_PUBLIC_SHOPIFY_API_KEY }}

    - name: ğŸš€ Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        skip_app_build: true

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Frontend deployment completed successfully!"
        echo "ğŸŒ App URL: https://brave-sea-038f17a00.1.azurestaticapps.net"
        echo "ğŸ“Š Check Azure Portal for detailed logs"

    - name: ğŸ¥ Health check
      run: |
        echo "Waiting 30 seconds for deployment to stabilize..."
        sleep 30
        echo "Performing health check..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://brave-sea-038f17a00.1.azurestaticapps.net)
        if [ "$response" = "200" ]; then
          echo "âœ… Health check passed!"
        else
          echo "âš ï¸ Health check returned status: $response"
        fi