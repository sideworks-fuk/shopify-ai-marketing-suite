name: Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      target_environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ï¼ˆ1=develop / 2=staging / 3=productionï¼‰'
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
        default: '1'
      confirm_deployment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'

env:
  NODE_VERSION: '20.x'
  APP_LOCATION: '/frontend'
  # Next.js ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¯ .next é…ä¸‹ï¼ˆStatic Web Apps ãŒ next export ã¨èª¤åˆ¤å®šã—ãªã„ã‚ˆã†æ˜ç¤ºï¼‰
  OUTPUT_LOCATION: '.next'
  # Static Web Apps API ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BRAVE_SEA_038F17A00 }}

  # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆURLï¼ˆãƒ­ã‚°/ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  # æ³¨æ„: å®Ÿéš›ã®URLã¯ç’°å¢ƒåˆ¥ã«ç•°ãªã‚‹ãŸã‚ã€ã‚¹ãƒ†ãƒƒãƒ—å†…ã§å‹•çš„ã«ç”Ÿæˆ
  # - 1(develop): brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net
  # - 2(staging): brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net
  # - 3(production): brave-sea-038f17a00.1.azurestaticapps.net

jobs:
  frontend-deploy:
    runs-on: ubuntu-latest
    # ç’°å¢ƒåˆ¥ã®GitHub Environment Variablesã‚’ä½¿ç”¨
    environment: ${{ github.event.inputs.target_environment == '1' && 'development' || github.event.inputs.target_environment == '2' && 'staging' || 'production' }}
    
    steps:
    - name: ğŸ›¡ï¸ Deployment confirmation
      if: github.event.inputs.confirm_deployment != 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™'
      run: |
        echo "âŒ Deployment cancelled by user"
        exit 1

    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Frontend Deployment Started"
        TARGET="${{ github.event.inputs.target_environment }}"
        if [ "$TARGET" = "1" ]; then
          ENV_NAME="develop"
        elif [ "$TARGET" = "2" ]; then
          ENV_NAME="staging"
        else
          ENV_NAME="production"
        fi
        echo "Environment: $ENV_NAME"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Target: $TARGET"
        echo "Timestamp: $(date)"

    - name: ğŸ”§ Set deployment environment variables
      id: env
      run: |
        TARGET="${{ github.event.inputs.target_environment }}"
        if [ "$TARGET" = "1" ]; then
          echo "deployment_environment=development" >> $GITHUB_OUTPUT
          echo "environment_name=develop" >> $GITHUB_OUTPUT
          echo "next_public_environment=development" >> $GITHUB_OUTPUT
          echo "frontend_url=https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net" >> $GITHUB_OUTPUT
        elif [ "$TARGET" = "2" ]; then
          echo "deployment_environment=staging" >> $GITHUB_OUTPUT
          echo "environment_name=staging" >> $GITHUB_OUTPUT
          echo "next_public_environment=staging" >> $GITHUB_OUTPUT
          echo "frontend_url=https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net" >> $GITHUB_OUTPUT
        elif [ "$TARGET" = "3" ]; then
          echo "deployment_environment=" >> $GITHUB_OUTPUT
          echo "environment_name=production" >> $GITHUB_OUTPUT
          echo "next_public_environment=production" >> $GITHUB_OUTPUT
          echo "frontend_url=https://brave-sea-038f17a00.1.azurestaticapps.net" >> $GITHUB_OUTPUT
        fi
        echo "ğŸ” Environment Configuration:"
        echo "  - Target: $TARGET"
        if [ "$TARGET" = "1" ]; then
          echo "  - Environment Name: develop"
          echo "  - Deployment Environment: development"
          echo "  - Frontend URL: https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net"
        elif [ "$TARGET" = "2" ]; then
          echo "  - Environment Name: staging"
          echo "  - Deployment Environment: staging"
          echo "  - Frontend URL: https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net"
        elif [ "$TARGET" = "3" ]; then
          echo "  - Environment Name: production"
          echo "  - Deployment Environment: (empty - production)"
          echo "  - Frontend URL: https://brave-sea-038f17a00.1.azurestaticapps.net"
        fi

    - name: ğŸš€ Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ${{ steps.env.outputs.deployment_environment }}
      env:
        # ç’°å¢ƒå¤‰æ•°ï¼ˆGitHub Environment Variablesã‹ã‚‰å–å¾—ï¼‰
        NEXT_PUBLIC_ENVIRONMENT: ${{ steps.env.outputs.next_public_environment }}
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
        NEXT_PUBLIC_SHOPIFY_API_KEY: ${{ vars.NEXT_PUBLIC_SHOPIFY_API_KEY }}
        NEXT_PUBLIC_SHOPIFY_APP_URL: ${{ vars.NEXT_PUBLIC_SHOPIFY_APP_URL }}  # èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ã§å¿…é ˆï¼ˆ2025-10-27è¿½åŠ ï¼‰
        NEXT_PUBLIC_USE_HTTPS: ${{ vars.NEXT_PUBLIC_USE_HTTPS }}  # HTTPSä½¿ç”¨è¨­å®š
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: ${{ vars.NEXT_PUBLIC_DISABLE_FEATURE_GATES }}
        NEXT_PUBLIC_DEV_PASSWORD: ${{ secrets.NEXT_PUBLIC_DEV_PASSWORD }}  # ç’°å¢ƒåˆ¥ã«è¨­å®šå¯èƒ½
        NODE_VERSION: 20

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Frontend deployment completed successfully!"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Environment: ${{ steps.env.outputs.environment_name }}"
        echo "ğŸŒ Frontend URL: ${{ steps.env.outputs.frontend_url }}"
        echo "ğŸ“Š Check Azure Portal for detailed logs"

    - name: ğŸ¥ Health check
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ steps.env.outputs.frontend_url }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "âœ… Health check passed! (Status: $response)"
        else
          echo "âš ï¸ Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: ğŸ“‹ Deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Frontend Deployment Summary"
        echo "================================================"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Environment: ${{ steps.env.outputs.environment_name }}"
        echo "Frontend URL: ${{ steps.env.outputs.frontend_url }}"
        echo "Backend API: ${{ vars.NEXT_PUBLIC_API_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Deployment time: $(date)"
        echo "================================================"
