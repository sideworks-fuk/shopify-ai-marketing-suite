name: ãƒ•ãƒ­ãƒ³ãƒˆé–‹ç™ºç’°å¢ƒã€€Azure Static Web Apps (Development)

on:
  push:
    branches: [ main, develop, staging ]
    paths:
      - 'frontend/**'
  pull_request:
    branches: [ main, develop, staging ]
    paths:
      - 'frontend/**'
  # æ‰‹å‹•å®Ÿè¡Œæ©Ÿèƒ½ã‚’è¿½åŠ 
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'Production'
        type: choice
        options:
          - Production
          - staging
          - development
      force_rebuild:
        description: 'å¼·åˆ¶ãƒªãƒ“ãƒ«ãƒ‰'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get build info
      id: build_info
      run: |
        echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
        echo "git_commit=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "git_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: Set deployment environment
      id: env
      run: |
        # mainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯å¸¸ã«Productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "deployment_environment=" >> $GITHUB_OUTPUT
          echo "environment_name=Production" >> $GITHUB_OUTPUT
          echo "next_public_environment=production" >> $GITHUB_OUTPUT
        # stagingãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯stagingç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          echo "deployment_environment=staging" >> $GITHUB_OUTPUT
          echo "environment_name=staging" >> $GITHUB_OUTPUT
          echo "next_public_environment=staging" >> $GITHUB_OUTPUT
        # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸç’°å¢ƒã‚’ä½¿ç”¨
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.environment }}" = "Production" ]; then
            echo "deployment_environment=" >> $GITHUB_OUTPUT
            echo "environment_name=Production" >> $GITHUB_OUTPUT
            echo "next_public_environment=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "deployment_environment=staging" >> $GITHUB_OUTPUT
            echo "environment_name=staging" >> $GITHUB_OUTPUT
            echo "next_public_environment=staging" >> $GITHUB_OUTPUT
          else
            echo "deployment_environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "environment_name=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "next_public_environment=development" >> $GITHUB_OUTPUT
          fi
        # ãã®ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã¯developmentç’°å¢ƒ
        else
          echo "deployment_environment=development" >> $GITHUB_OUTPUT
          echo "environment_name=development" >> $GITHUB_OUTPUT
          echo "next_public_environment=development" >> $GITHUB_OUTPUT
        fi
        
        # ç’°å¢ƒè¨­å®šã®æ•´åˆæ€§ç¢ºèªï¼ˆå¤‰æ•°ã‚’ç›´æ¥å‚ç…§ï¼‰
        echo "ğŸ” Environment Configuration:"
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "  NEXT_PUBLIC_ENVIRONMENT: production"
          echo "  Deployment Target: Production"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          echo "  NEXT_PUBLIC_ENVIRONMENT: staging"
          echo "  Deployment Target: staging"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.environment }}" = "Production" ]; then
          echo "  NEXT_PUBLIC_ENVIRONMENT: production"
          echo "  Deployment Target: Production"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          echo "  NEXT_PUBLIC_ENVIRONMENT: staging"
          echo "  Deployment Target: staging"
        else
          echo "  NEXT_PUBLIC_ENVIRONMENT: development"
          echo "  Deployment Target: development"
        fi
        echo "  Note: Next.js will automatically set NODE_ENV=production during build"

    - name: Deploy to Azure Static Web Apps
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BRAVE_SEA_038F17A00 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/frontend"
        api_location: ""
        output_location: ".next"
        # ä¿®æ­£: mainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯deployment_environmentã‚’ç©ºã«ã—ã¦æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        # ãã®ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        deployment_environment: ${{ steps.env.outputs.deployment_environment }}
        # ç’°å¢ƒå¤‰æ•°ã‚’Azure Static Web Appsã«æ¸¡ã™
        app_build_command: "npm run build"
        api_build_command: ""
      # ãƒ“ãƒ«ãƒ‰æ™‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      env:
        NEXT_PUBLIC_ENVIRONMENT: ${{ steps.env.outputs.next_public_environment }}
        NEXT_PUBLIC_BUILD_NUMBER: ${{ steps.build_info.outputs.build_number }}
        NEXT_PUBLIC_GIT_COMMIT: ${{ steps.build_info.outputs.git_commit }}
        NEXT_PUBLIC_GIT_BRANCH: ${{ steps.build_info.outputs.git_branch }}
        NEXT_PUBLIC_BUILD_DATE: ${{ steps.build_info.outputs.build_date }}
        # Azure Static Web Appsã§è¨­å®šã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        # ã“ã‚Œã‚‰ã®å€¤ã¯Azure Portalã§è¨­å®šã•ã‚ŒãŸå€¤ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™
        NEXT_PUBLIC_BACKEND_URL: ${{ secrets.NEXT_PUBLIC_BACKEND_URL || 'https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net' }}
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net' }}

    - name: Deploy Status
      run: |
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: ${{ steps.builddeploy.outputs.app_url }}"
        echo "ğŸŒ ç’°å¢ƒ: ${{ steps.env.outputs.environment_name }}"
        echo "ğŸ”§ ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ: ${{ steps.env.outputs.deployment_environment == '' && 'Production (æœ¬ç•ªç’°å¢ƒ)' || format('Preview ({0})', steps.env.outputs.deployment_environment) }}"
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ID: ${{ steps.builddeploy.outputs.build_id }}"
        echo "ğŸ”¢ ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ steps.build_info.outputs.build_number }}"
        echo "ğŸ“… ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: ${{ steps.build_info.outputs.build_date }}"
        echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—: ${{ github.event_name }}"

    # é–‹ç™ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    - name: Debug info (non-production only)
      if: steps.env.outputs.next_public_environment != 'production'
      run: |
        echo "ğŸ”§ ç’°å¢ƒè¨­å®šæƒ…å ±:"
        echo "  - ç’°å¢ƒ: ${{ steps.env.outputs.next_public_environment }}"
        echo "  - ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: ${{ steps.env.outputs.deployment_environment }}"
        echo "  - Note: NODE_ENV is automatically set to 'production' by Next.js during build"