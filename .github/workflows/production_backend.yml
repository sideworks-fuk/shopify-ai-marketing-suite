name: Production Backend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'

env:
  DOTNET_VERSION: '8.x'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  APP_NAME: 'ec-ranger-backend-prod'  # Japan West ã® App Service
  APP_URL: 'https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net/'

jobs:
  production-deploy:
    runs-on: windows-latest
    environment: ec-ranger-prod
    
    steps:
    - name: ğŸ›¡ï¸ Production deployment confirmation
      if: github.event.inputs.confirm_production != 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
      run: |
        echo "âŒ Production deployment cancelled by user"
        exit 1
      shell: bash

    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Setup NuGet cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: ğŸ”§ Configure NuGet
      run: |
        dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org --configfile backend/ShopifyAnalyticsApi/NuGet.Config || echo "Source already exists"
        dotnet nuget list source
      shell: pwsh

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Production Backend Deployment Started"
        echo "Environment: PRODUCTION (Japan West)"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "Target App: ${{ env.APP_NAME }}"
        echo "âš ï¸ WARNING: This will deploy to the PRODUCTION environment!"

    - name: ğŸ” Restore dependencies (with retry)
      run: |
        cd backend/ShopifyAnalyticsApi
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."
            
            # Clear NuGet caches if retry
            if ($retryCount -gt 1) {
              dotnet nuget locals all --clear
            }
            
            # Restore with timeout and retry settings
            dotnet restore --disable-parallel --verbosity normal
            
            $success = $true
            Write-Host "âœ… Dependencies restored successfully!"
          }
          catch {
            Write-Host "âŒ Restore failed on attempt $retryCount"
            Write-Host $_.Exception.Message
            
            if ($retryCount -eq $maxRetries) {
              throw "Failed to restore dependencies after $maxRetries attempts"
            }
            
            Write-Host "Waiting 10 seconds before retry..."
            Start-Sleep -Seconds 10
          }
        }
      shell: pwsh

    - name: ğŸ—ï¸ Build project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet build --configuration Release --no-restore

    - name: ğŸ§ª Run tests
      run: |
        cd backend
        if (Test-Path "*.Tests") {
          dotnet test --configuration Release --no-build --verbosity normal
        } else {
          Write-Host "No test projects found, skipping tests"
        }
      shell: pwsh

    - name: ğŸ“¦ Publish project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet publish -c Release -o ./published --no-restore --no-build

    - name: ğŸš€ Deploy to Azure App Service (Production - Japan West)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION }}
        package: backend/ShopifyAnalyticsApi/published
        app-settings: |
          ASPNETCORE_ENVIRONMENT=Production

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Production backend deployment completed successfully!"
        echo "ğŸŒ App URL: ${{ env.APP_URL }}"
        echo "ğŸ“Š Check Azure Portal for detailed logs"
        echo "âš ï¸ PRODUCTION environment is now live!"

    - name: ğŸ¥ Health check
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        Start-Sleep -Seconds 45
        echo "Performing health check..."
        try {
          $response = Invoke-WebRequest -Uri "${{ env.APP_URL }}api/health" -UseBasicParsing -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
            echo "âœ… Health check passed!"
          } else {
            echo "âš ï¸ Health check returned status: $($response.StatusCode)"
          }
        } catch {
          echo "âŒ Health check failed: $_"
          echo "âš ï¸ Note: Please check the application manually"
        }
      shell: pwsh

    - name: ğŸ“‹ Production deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Environment: PRODUCTION"
        echo "Region: Japan West"
        echo "App Service: ${{ env.APP_NAME }}"
        echo "URL: ${{ env.APP_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Deployment time: $(date)"
        echo "================================================"
