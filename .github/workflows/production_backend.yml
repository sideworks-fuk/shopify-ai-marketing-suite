name: Production Backend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'

env:
  DOTNET_VERSION: '8.x'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  APP_NAME: 'ec-ranger-backend-prod'  # Japan West ã® App Service
  APP_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/'
  STAGING_URL: 'https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net/'

jobs:
  production-deploy:
    runs-on: windows-latest
    environment: ec-ranger-prod
    
    steps:
    - name: ğŸ›¡ï¸ Production deployment confirmation
      if: github.event.inputs.confirm_production != 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
      run: |
        echo "âŒ Production deployment cancelled by user"
        exit 1
      shell: bash

    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Setup NuGet cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: ğŸ”§ Configure NuGet
      run: |
        dotnet nuget list source
      shell: pwsh

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Production Backend Deployment Started"
        echo "Environment: PRODUCTION (Japan West)"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "Target: Staging Slot â†’ Manual Swap Required"
        echo ""
        echo "âš ï¸ NOTE: After deployment, manually swap slots in Azure Portal"
      shell: bash

    - name: ğŸ” Restore dependencies (with retry)
      run: |
        cd backend/ShopifyAnalyticsApi
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."
            
            if ($retryCount -gt 1) {
              dotnet nuget locals all --clear
            }
            
            dotnet restore --disable-parallel --verbosity normal
            
            $success = $true
            Write-Host "âœ… Dependencies restored successfully!"
          }
          catch {
            Write-Host "âŒ Restore failed on attempt $retryCount"
            Write-Host $_.Exception.Message
            
            if ($retryCount -eq $maxRetries) {
              throw "Failed to restore dependencies after $maxRetries attempts"
            }
            
            Write-Host "Waiting 10 seconds before retry..."
            Start-Sleep -Seconds 10
          }
        }
      shell: pwsh

    - name: ğŸ—ï¸ Build project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet build --configuration Release --no-restore

    - name: ğŸ“¦ Publish project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet publish -c Release -o ./published --no-restore --no-build

    - name: ğŸ” Verify published files
      run: |
        cd backend/ShopifyAnalyticsApi/published
        Write-Host "ğŸ“¦ Published files:"
        Get-ChildItem -Filter "*.dll" | Select-Object Name, LastWriteTime, Length | Format-Table
        Write-Host "ğŸ“„ Configuration files:"
        Get-ChildItem -Filter "appsettings*.json" | Select-Object Name, LastWriteTime | Format-Table
        
        if (-not (Test-Path "ShopifyAnalyticsApi.dll")) {
          throw "âŒ ShopifyAnalyticsApi.dll not found!"
        }
        Write-Host "âœ… Verification complete"
      shell: pwsh

    # ========================================
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¹ãƒ­ãƒƒãƒˆã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    # ========================================
    - name: ğŸš€ Deploy to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        slot-name: 'staging'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING }}
        package: backend/ShopifyAnalyticsApi/published
      continue-on-error: false

    - name: ğŸ¥ Health check (Staging Slot)
      run: |
        echo "Waiting 30 seconds for staging deployment to stabilize..."
        Start-Sleep -Seconds 30
        
        $stagingUrl = "${{ env.STAGING_URL }}api/health"
        Write-Host "Performing health check on: $stagingUrl"
        
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          $retryCount++
          try {
            Write-Host "Health check attempt $retryCount of $maxRetries..."
            $response = Invoke-WebRequest -Uri $stagingUrl -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ… Staging slot health check passed!"
              $success = $true
            }
          } catch {
            Write-Host "âš ï¸ Attempt $retryCount failed: $_"
            if ($retryCount -lt $maxRetries) {
              Start-Sleep -Seconds 10
            }
          }
        }
        
        if (-not $success) {
          Write-Host "âŒ Staging health check failed - DO NOT SWAP"
          Write-Host "âš ï¸ Please investigate the issue before swapping slots"
          exit 1
        }
      shell: pwsh

    # ========================================
    # å®Œäº†å‡¦ç†
    # ========================================
    - name: âœ… Deployment complete
      run: |
        echo "================================================"
        echo "âœ… Staging Deployment Completed!"
        echo "================================================"
        echo ""
        echo "ğŸ”„ MANUAL ACTION REQUIRED:"
        echo "   1. Azure Portal â†’ App Service â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆ"
        echo "   2. ã€Œã‚¹ãƒ¯ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"
        echo "   3. staging â†’ production ã‚’ã‚¹ãƒ¯ãƒƒãƒ—"
        echo ""
        echo "ğŸ“ Staging URL: ${{ env.STAGING_URL }}"
        echo "ğŸ“ Production URL: ${{ env.APP_URL }}"
        echo ""
        echo "ğŸ” Verification steps:"
        echo "1. Check staging slot health: ${{ env.STAGING_URL }}api/health"
        echo "2. Test staging endpoints if needed"
        echo "3. Swap slots in Azure Portal"
        echo "4. Verify production after swap"
        echo "================================================"
      shell: bash

    - name: ğŸ“‹ Deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Status: ${{ job.status }}"
        echo "Environment: PRODUCTION (Japan West)"
        echo "App Service: ${{ env.APP_NAME }}"
        echo "Deployed to: Staging Slot"
        echo "Staging URL: ${{ env.STAGING_URL }}"
        echo "Production URL: ${{ env.APP_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Method: Semi-Automatic (Manual Swap Required)"
        echo "Message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "================================================"
      shell: bash

    - name: ğŸ”” Notify on failure
      if: failure()
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo ""
        echo "ğŸ”§ Troubleshooting:"
        echo "1. Check Azure Portal for App Service status"
        echo "2. Review Kudu logs"
        echo "3. Verify publish profile secrets"
        echo "4. Verify staging slot exists"
        echo "5. Check staging slot health: ${{ env.STAGING_URL }}api/health"
      shell: bash
