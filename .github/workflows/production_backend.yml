name: Production Backend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
      use_deployment_slot:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨: ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ï¼‰'
        required: true
        type: choice
        options:
          - 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'
          - 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
        default: 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'

env:
  DOTNET_VERSION: '8.x'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  APP_NAME: 'ec-ranger-backend-prod'  # Japan West ã® App Service
  RESOURCE_GROUP: 'ec-ranger-prod'
  APP_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/'

jobs:
  production-deploy:
    runs-on: windows-latest
    environment: ec-ranger-prod
    
    steps:
    - name: ğŸ›¡ï¸ Production deployment confirmation
      if: github.event.inputs.confirm_production != 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
      run: |
        echo "âŒ Production deployment cancelled by user"
        exit 1
      shell: bash

    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Setup NuGet cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: ğŸ”§ Configure NuGet
      run: |
        # NuGet source is already configured in NuGet.Config file
        dotnet nuget list source
      shell: pwsh

    - name: ğŸ” Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Production Backend Deployment Started"
        echo "Environment: PRODUCTION (Japan West)"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "Target App: ${{ env.APP_NAME }}"
        echo "Deployment Method: ${{ github.event.inputs.use_deployment_slot }}"
        if [ "${{ github.event.inputs.use_deployment_slot }}" = "YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰" ]; then
          echo "âœ… Using deployment slot (zero downtime)"
        else
          echo "âš ï¸ Direct deployment (requires app stop)"
        fi
        echo "âš ï¸ WARNING: This will deploy to the PRODUCTION environment!"
      shell: bash

    - name: ğŸ” Restore dependencies (with retry)
      run: |
        cd backend/ShopifyAnalyticsApi
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."
            
            # Clear NuGet caches if retry
            if ($retryCount -gt 1) {
              dotnet nuget locals all --clear
            }
            
            # Restore with timeout and retry settings
            dotnet restore --disable-parallel --verbosity normal
            
            $success = $true
            Write-Host "âœ… Dependencies restored successfully!"
          }
          catch {
            Write-Host "âŒ Restore failed on attempt $retryCount"
            Write-Host $_.Exception.Message
            
            if ($retryCount -eq $maxRetries) {
              throw "Failed to restore dependencies after $maxRetries attempts"
            }
            
            Write-Host "Waiting 10 seconds before retry..."
            Start-Sleep -Seconds 10
          }
        }
      shell: pwsh

    - name: ğŸ—ï¸ Build project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet build --configuration Release --no-restore

    # - name: ğŸ§ª Run tests
    #   run: |
    #     cd backend
    #     if (Test-Path "*.Tests") {
    #       dotnet test --configuration Release --no-build --verbosity normal
    #     } else {
    #       Write-Host "No test projects found, skipping tests"
    #     }
    #   shell: pwsh
    # Note: Tests temporarily disabled for production deployment - will re-enable after environment stabilization

    - name: ğŸ“¦ Publish project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet publish -c Release -o ./published --no-restore --no-build

    - name: ğŸ” Verify published files before deployment
      run: |
        cd backend/ShopifyAnalyticsApi/published
        Write-Host "ğŸ“¦ Published files:"
        Get-ChildItem -Filter "*.dll" | Select-Object Name, LastWriteTime, Length | Format-Table
        Write-Host "ğŸ“„ Configuration files:"
        Get-ChildItem -Filter "appsettings*.json" | Select-Object Name, LastWriteTime | Format-Table
        
        if (-not (Test-Path "ShopifyAnalyticsApi.dll")) {
          throw "âŒ ShopifyAnalyticsApi.dll not found!"
        }
        Write-Host "âœ… Verification complete"
      shell: pwsh

    # ========================================
    # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæ¨å¥¨ï¼‰
    # ========================================
    - name: ğŸ” Get Staging Slot URL
      if: github.event.inputs.use_deployment_slot == 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'
      id: get_staging_url
      uses: azure/CLI@v2
      with:
        inlineScript: |
          STAGING_HOSTNAME=$(az webapp deployment slot list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.APP_NAME }} \
            --query "[?name=='staging'].defaultHostName" -o tsv)
          
          if [ -z "$STAGING_HOSTNAME" ]; then
            echo "âŒ Staging slot not found!"
            exit 1
          fi
          
          echo "staging_url=https://${STAGING_HOSTNAME}" >> $GITHUB_OUTPUT
          echo "âœ… Staging URL: https://${STAGING_HOSTNAME}"

    - name: ğŸš€ Deploy to Staging Slot
      if: github.event.inputs.use_deployment_slot == 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        slot-name: 'staging'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING }}
        package: backend/ShopifyAnalyticsApi/published
      continue-on-error: false

    - name: ğŸ¥ Health check (Staging Slot)
      if: github.event.inputs.use_deployment_slot == 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'
      id: staging_health
      run: |
        echo "Waiting 30 seconds for staging deployment to stabilize..."
        Start-Sleep -Seconds 30
        
        $stagingUrl = "${{ steps.get_staging_url.outputs.staging_url }}/api/health"
        Write-Host "Performing health check on: $stagingUrl"
        
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          $retryCount++
          try {
            Write-Host "Health check attempt $retryCount of $maxRetries..."
            $response = Invoke-WebRequest -Uri $stagingUrl -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ… Staging slot health check passed!"
              $success = $true
              echo "health_status=success" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "âš ï¸ Attempt $retryCount failed: $_"
            if ($retryCount -lt $maxRetries) {
              Start-Sleep -Seconds 10
            }
          }
        }
        
        if (-not $success) {
          Write-Host "âŒ Staging health check failed after $maxRetries attempts"
          echo "health_status=failed" >> $env:GITHUB_OUTPUT
          exit 1
        }
      shell: pwsh

    - name: ğŸ”„ Swap slots (Production â†” Staging)
      if: github.event.inputs.use_deployment_slot == 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰' && steps.staging_health.outputs.health_status == 'success'
      uses: azure/CLI@v2
      with:
        inlineScript: |
          echo "ğŸ”„ Swapping slots: staging â†” production"
          az webapp deployment slot swap \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.APP_NAME }} \
            --slot staging \
            --target-slot production
          echo "âœ… Slot swap completed successfully!"

    - name: ğŸ¥ Health check (Production after swap)
      if: github.event.inputs.use_deployment_slot == 'YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰'
      run: |
        echo "Waiting 15 seconds for production to stabilize..."
        Start-Sleep -Seconds 15
        
        try {
          $response = Invoke-WebRequest -Uri "${{ env.APP_URL }}api/health" -UseBasicParsing -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
            Write-Host "âœ… Production health check passed after swap!"
          } else {
            Write-Host "âš ï¸ Production returned status: $($response.StatusCode)"
          }
        } catch {
          Write-Host "âŒ Production health check failed: $_"
          Write-Host "âš ï¸ Consider rolling back with another swap"
        }
      shell: pwsh

    # ========================================
    # ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆï¼ˆapp_offline.htmä½¿ç”¨ï¼‰
    # ========================================
    - name: ğŸ“„ Create app_offline.htm
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      run: |
        echo "<html><head><title>Updating...</title><meta http-equiv='refresh' content='10'></head><body style='font-family: Arial, sans-serif; text-align: center; padding: 50px;'><h1>Application is being updated</h1><p>Please wait while we update the application. This page will automatically refresh.</p><p>If this page does not refresh automatically, please try again in a few moments.</p></body></html>" > app_offline.htm
        echo "âœ… app_offline.htm created"
      shell: bash

    - name: ğŸš€ Deploy app_offline.htm (Shutdown App)
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION }}
        package: app_offline.htm
      continue-on-error: false

    - name: â³ Wait for app shutdown
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      run: |
        echo "â³ Waiting 15 seconds for application to shut down..."
        sleep 15
        echo "âœ… Application shutdown complete (file locks should be released)"
      shell: bash

    - name: ğŸš€ Deploy application
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION }}
        package: backend/ShopifyAnalyticsApi/published
      continue-on-error: false

    - name: ğŸ—‘ï¸ Remove app_offline.htm (Restart App)
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      uses: azure/CLI@v2
      with:
        inlineScript: |
          echo "ğŸ—‘ï¸ Attempting to remove app_offline.htm..."
          az webapp deploy \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.APP_NAME }} \
            --src-path /dev/null \
            --target-path app_offline.htm \
            --type static \
            --clean true 2>/dev/null || echo "â„¹ï¸ File may have been auto-removed"
      continue-on-error: true

    - name: ğŸ¥ Health check (Direct Deploy)
      if: github.event.inputs.use_deployment_slot == 'NO - ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆåœæ­¢ãŒå¿…è¦ï¼‰'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        Start-Sleep -Seconds 45
        
        $maxRetries = 3
        $retryCount = 0
        
        while ($retryCount -lt $maxRetries) {
          $retryCount++
          try {
            Write-Host "Health check attempt $retryCount of $maxRetries..."
            $response = Invoke-WebRequest -Uri "${{ env.APP_URL }}api/health" -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ… Health check passed!"
              break
            }
          } catch {
            Write-Host "âš ï¸ Attempt $retryCount failed: $_"
            if ($retryCount -lt $maxRetries) {
              Start-Sleep -Seconds 10
            }
          }
        }
      shell: pwsh

    # ========================================
    # å®Œäº†å‡¦ç†
    # ========================================
    - name: âœ… Deployment complete
      run: |
        echo "================================================"
        echo "âœ… Production Backend Deployment Completed!"
        echo "================================================"
        echo "ğŸŒ App URL: ${{ env.APP_URL }}"
        echo ""
        if [ "${{ github.event.inputs.use_deployment_slot }}" = "YES - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰" ]; then
          echo "âœ… Deployment method: Deployment Slot (Zero Downtime)"
        else
          echo "âš ï¸ Deployment method: Direct Deployment"
        fi
        echo ""
        echo "ğŸ” Verification steps:"
        echo "1. Check Azure Portal â†’ Deployment Center"
        echo "2. Verify file timestamps in Kudu"
        echo "3. Test API endpoints"
      shell: bash

    - name: ğŸ“‹ Deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Status: ${{ job.status }}"
        echo "Environment: PRODUCTION (Japan West)"
        echo "App Service: ${{ env.APP_NAME }}"
        echo "URL: ${{ env.APP_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Method: ${{ github.event.inputs.use_deployment_slot }}"
        echo "Message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "================================================"
      shell: bash

    - name: ğŸ”” Notify on failure
      if: failure()
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo ""
        echo "ğŸ”§ Troubleshooting:"
        echo "1. Check Azure Portal for App Service status"
        echo "2. Review Kudu logs"
        echo "3. Verify publish profile secrets"
        echo "4. If using slot, verify staging slot exists"
      shell: bash
