name: Production Backend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: '„Éá„Éó„É≠„Ç§„É°„ÉÉ„Çª„Éº„Ç∏Ôºà‰ªªÊÑèÔºâ'
        required: false
        type: string

env:
  DOTNET_VERSION: '8.x'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  APP_NAME: 'ec-ranger-backend-prod'  # Japan West „ÅÆ App Service
  APP_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/'
  STAGING_URL: 'https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net/'

jobs:
  production-deploy:
    runs-on: windows-latest
    environment: ec-ranger-prod
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üîß Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ Setup NuGet cache
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: üîß Configure NuGet
      run: |
        dotnet nuget list source
      shell: pwsh

    - name: üìù Display deployment info
      run: |
        echo "üöÄ Production Backend Deployment Started"
        echo "Environment: PRODUCTION (Japan West)"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "Target: Staging Slot ‚Üí Manual Swap Required"
        echo ""
        echo "‚ö†Ô∏è NOTE: After deployment, manually swap slots in Azure Portal"
      shell: bash

    - name: üîç Restore dependencies (with retry)
      run: |
        cd backend/ShopifyAnalyticsApi
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          try {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."
            
            if ($retryCount -gt 1) {
              dotnet nuget locals all --clear
            }
            
            dotnet restore --disable-parallel --verbosity normal
            
            $success = $true
            Write-Host "‚úÖ Dependencies restored successfully!"
          }
          catch {
            Write-Host "‚ùå Restore failed on attempt $retryCount"
            Write-Host $_.Exception.Message
            
            if ($retryCount -eq $maxRetries) {
              throw "Failed to restore dependencies after $maxRetries attempts"
            }
            
            Write-Host "Waiting 10 seconds before retry..."
            Start-Sleep -Seconds 10
          }
        }
      shell: pwsh

    - name: üèóÔ∏è Build project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet build --configuration Release --no-restore

    - name: üì¶ Publish project
      run: |
        cd backend/ShopifyAnalyticsApi
        dotnet publish -c Release -o ./published --no-restore --no-build

    - name: üîç Verify published files
      run: |
        cd backend/ShopifyAnalyticsApi/published
        Write-Host "üì¶ Published files:"
        Get-ChildItem -Filter "*.dll" | Select-Object Name, LastWriteTime, Length | Format-Table
        Write-Host "üìÑ Configuration files:"
        Get-ChildItem -Filter "appsettings*.json" | Select-Object Name, LastWriteTime | Format-Table
        
        if (-not (Test-Path "ShopifyAnalyticsApi.dll")) {
          throw "‚ùå ShopifyAnalyticsApi.dll not found!"
        }
        Write-Host "‚úÖ Verification complete"
      shell: pwsh

    # ========================================
    # „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„Çπ„É≠„ÉÉ„Éà„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
    # ========================================
    - name: üöÄ Deploy to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        slot-name: 'staging'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING }}
        package: backend/ShopifyAnalyticsApi/published
      continue-on-error: false

    - name: üè• Health check (Staging Slot)
      run: |
        echo "Waiting 30 seconds for staging deployment to stabilize..."
        Start-Sleep -Seconds 30
        
        $stagingUrl = "${{ env.STAGING_URL }}api/health"
        Write-Host "Performing health check on: $stagingUrl"
        
        $maxRetries = 3
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
          $retryCount++
          try {
            Write-Host "Health check attempt $retryCount of $maxRetries..."
            $response = Invoke-WebRequest -Uri $stagingUrl -UseBasicParsing -TimeoutSec 30
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ Staging slot health check passed!"
              $success = $true
            }
          } catch {
            Write-Host "‚ö†Ô∏è Attempt $retryCount failed: $_"
            if ($retryCount -lt $maxRetries) {
              Start-Sleep -Seconds 10
            }
          }
        }
        
        if (-not $success) {
          Write-Host "‚ùå Staging health check failed - DO NOT SWAP"
          Write-Host "‚ö†Ô∏è Please investigate the issue before swapping slots"
          exit 1
        }
      shell: pwsh

    # ========================================
    # ÂÆå‰∫ÜÂá¶ÁêÜ
    # ========================================
    - name: ‚úÖ Deployment complete
      run: |
        echo "================================================"
        echo "‚úÖ Staging Deployment Completed!"
        echo "================================================"
        echo ""
        echo "üîÑ MANUAL ACTION REQUIRED:"
        echo "   1. Azure Portal ‚Üí App Service ‚Üí „Éá„Éó„É≠„Ç§„Çπ„É≠„ÉÉ„Éà"
        echo "   2. „Äå„Çπ„ÉØ„ÉÉ„Éó„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ"
        echo "   3. staging ‚Üí production „Çí„Çπ„ÉØ„ÉÉ„Éó"
        echo ""
        echo "üìç Staging URL: ${{ env.STAGING_URL }}"
        echo "üìç Production URL: ${{ env.APP_URL }}"
        echo ""
        echo "üîç Verification steps:"
        echo "1. Check staging slot health: ${{ env.STAGING_URL }}api/health"
        echo "2. Test staging endpoints if needed"
        echo "3. Swap slots in Azure Portal"
        echo "4. Verify production after swap"
        echo "================================================"
      shell: bash

    - name: üìã Deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Status: ${{ job.status }}"
        echo "Environment: PRODUCTION (Japan West)"
        echo "App Service: ${{ env.APP_NAME }}"
        echo "Deployed to: Staging Slot"
        echo "Staging URL: ${{ env.STAGING_URL }}"
        echo "Production URL: ${{ env.APP_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Method: Semi-Automatic (Manual Swap Required)"
        echo "Message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "================================================"
      shell: bash

    - name: üîî Notify on failure
      if: failure()
      run: |
        echo "‚ùå DEPLOYMENT FAILED!"
        echo ""
        echo "üîß Troubleshooting:"
        echo "1. Check Azure Portal for App Service status"
        echo "2. Review Kudu logs"
        echo "3. Verify publish profile secrets"
        echo "4. Verify staging slot exists"
        echo "5. Check staging slot health: ${{ env.STAGING_URL }}api/health"
      shell: bash
