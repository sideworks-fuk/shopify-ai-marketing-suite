name: Production Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª'
        required: true
        type: choice
        options:
          - 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
          - 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'
        default: 'NO - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™'

env:
  NODE_VERSION: '20.x'
  APP_LOCATION: '/frontend'
  OUTPUT_LOCATION: ''
  # æœ¬ç•ªç’°å¢ƒç”¨ã®Static Web Apps API ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆJapan Eastï¼‰
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION }}

jobs:
  production-deploy:
    runs-on: ubuntu-latest
    environment: ec-ranger-prod
    
    steps:
    - name: ğŸ›¡ï¸ Production deployment confirmation
      if: github.event.inputs.confirm_production != 'YES - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™'
      run: |
        echo "âŒ Production deployment cancelled by user"
        exit 1

    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Production Frontend Deployment Started"
        echo "Environment: PRODUCTION"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"
        echo "âš ï¸ WARNING: This will deploy to the PRODUCTION environment!"

    - name: ğŸš€ Deploy to Azure Static Web Apps (Production)
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # ç©ºã«ã™ã‚‹ã“ã¨ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        # æœ¬ç•ªç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: 'https://ec-ranger-backend-prod-ghf3bbargbc4hfgh.japanwest-01.azurewebsites.net'  # Japan West ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ vars.SHOPIFY_API_KEY_PRODUCTION }}'
        NEXT_PUBLIC_SHOPIFY_APP_URL: 'https://white-island-08e0a6300.1.azurestaticapps.net'  # æœ¬ç•ªç”¨ Static Web Apps
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        NODE_VERSION: 20

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Production frontend deployment completed successfully!"
        echo "ğŸŒ App URL: https://white-island-08e0a6300.1.azurestaticapps.net"
        echo "ğŸ“Š Environment: PRODUCTION"
        echo "ğŸ“Š Check Azure Portal for detailed logs"
        echo "âš ï¸ PRODUCTION environment is now live!"

    - name: ğŸ¥ Health check
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="https://white-island-08e0a6300.1.azurestaticapps.net"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "âœ… Health check passed! (Status: $response)"
        else
          echo "âš ï¸ Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: ğŸ“‹ Production deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Environment: PRODUCTION"
        echo "Frontend URL: https://shopify-ai-marketing-suite-prod.azurestaticapps.net"
        echo "Backend URL: https://shopifyapp-backend-prod.azurewebsites.net"
        echo "Deployed by: ${{ github.actor }}"
        echo "Deployment time: $(date)"
        echo "================================================"
