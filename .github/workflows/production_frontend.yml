name: Production Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      target_environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡: Production1=EC Ranger(å…¬é–‹) / Production2=EC Ranger-xn-fbkq6e5da0fpb(ã‚«ã‚¹ã‚¿ãƒ ) / Production3=EC Ranger-demo(ã‚«ã‚¹ã‚¿ãƒ ) / Both=Prod1+2 / All=å…¨ç’°å¢ƒ'
        required: true
        type: choice
        options:
          - 'Production1'
          - 'Production2'
          - 'Production3'
          - 'Both'
          - 'All'
        default: 'Production1'

env:
  NODE_VERSION: '20'
  APP_LOCATION: '/frontend'
  # Next.js ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¯ .next é…ä¸‹ï¼ˆStatic Web Apps ãŒ next export ã¨èª¤åˆ¤å®šã—ãªã„ã‚ˆã†æ˜ç¤ºï¼‰
  OUTPUT_LOCATION: '.next'
  # Production1 / Production2 / Production3 ã®Static Web Apps API ãƒˆãƒ¼ã‚¯ãƒ³
  # å‘½åè¦å‰‡: AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_{ç•ªå·}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD1: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_1 }}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD2: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_2 }}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD3: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_3 }}

  # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆURLï¼ˆãƒ­ã‚°/ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
  # - PROD1: EC Ranger (white-island) / å…¬é–‹ã‚¢ãƒ—ãƒª / ãƒªã‚½ãƒ¼ã‚¹å: ec-ranger-frontend-prod-1 / ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: https://ec-ranger.access-net.co.jp
  # - PROD2: EC Ranger-xn-fbkq6e5da0fpb (black-flower) / ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª / ãƒªã‚½ãƒ¼ã‚¹å: ec-ranger-frontend-prod-2
  # - PROD3: EC Ranger-demo (ashy-plant) / ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª / ãƒªã‚½ãƒ¼ã‚¹å: ec-ranger-frontend-prod-3
  PROD1_FRONTEND_URL: 'https://white-island-08e0a6300.2.azurestaticapps.net'
  PROD1_CUSTOM_DOMAIN: 'https://ec-ranger.access-net.co.jp'
  PROD2_FRONTEND_URL: 'https://black-flower-004e1de00.2.azurestaticapps.net'
  PROD3_FRONTEND_URL: 'https://ashy-plant-01b5c4100.1.azurestaticapps.net'

  # Shopify App ã®å…¬é–‹APIã‚­ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã®App Bridgeç”¨ï¼‰
  # - ç¾çŠ¶ã€GitHub Environment ã« Secrets ã¨ Variables ã®ä¸¡æ–¹ãŒæ··åœ¨ã—ã¦ã„ã‚‹ãŸã‚ã€
  #   secrets ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã° vars ã‚’å‚ç…§ã™ã‚‹ï¼ˆç©ºæ³¨å…¥ã‚’é˜²ãï¼‰
  PROD1_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION || vars.SHOPIFY_API_KEY_PRODUCTION }}
  PROD2_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION_2 || vars.SHOPIFY_API_KEY_PRODUCTION_2 }}
  PROD3_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION_3 || vars.SHOPIFY_API_KEY_PRODUCTION_3 }}

jobs:
  production-deploy:
    runs-on: ubuntu-latest
    environment: ec-ranger-prod
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # ============================================
    # ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
    # ============================================
    - name: ğŸ“¦ Setup Node.js with npm cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ Cache Next.js build
      uses: actions/cache@v4
      with:
        path: |
          frontend/.next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package-lock.json') }}-${{ hashFiles('frontend/**/*.ts', 'frontend/**/*.tsx', 'frontend/**/*.js', 'frontend/**/*.jsx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package-lock.json') }}-
          ${{ runner.os }}-nextjs-

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Production Frontend Deployment Started"
        echo "Environment: PRODUCTION"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Timestamp: $(date)"
        echo "âš ï¸ WARNING: This will deploy to the PRODUCTION environment!"

    - name: ğŸš€ Deploy to Azure Static Web Apps (Production1)
      if: github.event.inputs.target_environment == 'Production1' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD1 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # ç©ºã«ã™ã‚‹ã“ã¨ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        # æœ¬ç•ªç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variablesã‹ã‚‰å–å¾—ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: https://ec-ranger-api.access-net.co.jpï¼‰
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD1_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install ãƒšãƒ¼ã‚¸ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç”¨ï¼ˆProduction1: å…¬é–‹ã‚¢ãƒ—ãƒªï¼‰
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: 'https://apps.shopify.com/ec-ranger'
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Public'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    - name: ğŸš€ Deploy to Azure Static Web Apps (Production2)
      if: github.event.inputs.target_environment == 'Production2' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD2 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # ç©ºã«ã™ã‚‹ã“ã¨ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        # æœ¬ç•ªç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variablesã‹ã‚‰å–å¾—ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: https://ec-ranger-api.access-net.co.jpï¼‰
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD2_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install ãƒšãƒ¼ã‚¸ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç”¨ï¼ˆProduction2: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒªï¼‰
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: ''
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Custom'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    - name: ğŸš€ Deploy to Azure Static Web Apps (Production3)
      if: github.event.inputs.target_environment == 'Production3' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD3 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # ç©ºã«ã™ã‚‹ã“ã¨ã§æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
      env:
        # æœ¬ç•ªç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variablesã‹ã‚‰å–å¾—ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: https://ec-ranger-api.access-net.co.jpï¼‰
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD3_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install ãƒšãƒ¼ã‚¸ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç”¨ï¼ˆProduction3: ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒªï¼‰
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: ''
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Custom'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Production frontend deployment completed successfully!"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "ğŸŒ Production1 (EC Ranger): ${{ env.PROD1_FRONTEND_URL }}"
        echo "ğŸŒ Production1 Custom Domain: ${{ env.PROD1_CUSTOM_DOMAIN }}"
        echo "ğŸŒ Production2 (EC Ranger-xn-fbkq6e5da0fpb): ${{ env.PROD2_FRONTEND_URL }}"
        echo "ğŸŒ Production3 (EC Ranger-demo): ${{ env.PROD3_FRONTEND_URL }}"
        echo "ğŸ“Š Environment: PRODUCTION"
        echo "ğŸ“Š Check Azure Portal for detailed logs"
        echo "âš ï¸ PRODUCTION environment is now live!"

    - name: ğŸ¥ Health check (Production1)
      if: github.event.inputs.target_environment == 'Production1' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD1_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "âœ… Health check passed! (Status: $response)"
        else
          echo "âš ï¸ Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: ğŸ¥ Health check (Production2)
      if: github.event.inputs.target_environment == 'Production2' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD2_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "âœ… Health check passed! (Status: $response)"
        else
          echo "âš ï¸ Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: ğŸ¥ Health check (Production3)
      if: github.event.inputs.target_environment == 'Production3' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD3_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "âœ… Health check passed! (Status: $response)"
        else
          echo "âš ï¸ Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: ğŸ“‹ Production deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Environment: PRODUCTION"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Frontend (Production1 - EC Ranger): ${{ env.PROD1_FRONTEND_URL }}"
        echo "Frontend (Production1 - Custom Domain): ${{ env.PROD1_CUSTOM_DOMAIN }}"
        echo "Frontend (Production2 - EC Ranger-xn-fbkq6e5da0fpb): ${{ env.PROD2_FRONTEND_URL }}"
        echo "Frontend (Production3 - EC Ranger-demo): ${{ env.PROD3_FRONTEND_URL }}"
        echo "Backend API: ${{ vars.NEXT_PUBLIC_API_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Deployment time: $(date)"
        echo "================================================"
