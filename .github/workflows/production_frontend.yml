name: Production Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: '„Éá„Éó„É≠„Ç§„É°„ÉÉ„Çª„Éº„Ç∏Ôºà‰ªªÊÑèÔºâ'
        required: false
        type: string
      target_environment:
        description: '„Éá„Éó„É≠„Ç§ÂØæË±°: Production1=EC Ranger(ÂÖ¨Èñã) / Production2=EC Ranger-xn-fbkq6e5da0fpb(„Ç´„Çπ„Çø„É†) / Production3=EC Ranger-demo(„Ç´„Çπ„Çø„É†) / Both=Prod1+2 / All=ÂÖ®Áí∞Â¢É'
        required: true
        type: choice
        options:
          - 'Production1'
          - 'Production2'
          - 'Production3'
          - 'Both'
          - 'All'
        default: 'Production1'

env:
  NODE_VERSION: '20'
  APP_LOCATION: '/frontend'
  # Next.js „ÅÆ„Éì„É´„ÉâÊàêÊûúÁâ©„ÅØ .next ÈÖç‰∏ãÔºàStatic Web Apps „Åå next export „Å®Ë™§Âà§ÂÆö„Åó„Å™„ÅÑ„Çà„ÅÜÊòéÁ§∫Ôºâ
  OUTPUT_LOCATION: '.next'
  # Production1 / Production2 / Production3 „ÅÆStatic Web Apps API „Éà„Éº„ÇØ„É≥
  # ÂëΩÂêçË¶èÂâá: AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_{Áï™Âè∑}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD1: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_1 }}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD2: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_2 }}
  AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD3: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION_3 }}

  # „Éá„Éó„É≠„Ç§ÂÖàURLÔºà„É≠„Ç∞/„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
  # - PROD1: EC Ranger (white-island) / ÂÖ¨Èñã„Ç¢„Éó„É™ / „É™„ÇΩ„Éº„ÇπÂêç: ec-ranger-frontend-prod-1 / „Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥: https://ec-ranger.access-net.co.jp
  # - PROD2: EC Ranger-xn-fbkq6e5da0fpb (black-flower) / „Ç´„Çπ„Çø„É†„Ç¢„Éó„É™ / „É™„ÇΩ„Éº„ÇπÂêç: ec-ranger-frontend-prod-2
  # - PROD3: EC Ranger-demo (ashy-plant) / „Ç´„Çπ„Çø„É†„Ç¢„Éó„É™ / „É™„ÇΩ„Éº„ÇπÂêç: ec-ranger-frontend-prod-3
  PROD1_FRONTEND_URL: 'https://white-island-08e0a6300.2.azurestaticapps.net'
  PROD1_CUSTOM_DOMAIN: 'https://ec-ranger.access-net.co.jp'
  PROD2_FRONTEND_URL: 'https://black-flower-004e1de00.2.azurestaticapps.net'
  PROD3_FRONTEND_URL: 'https://ashy-plant-01b5c4100.1.azurestaticapps.net'

  # Shopify App „ÅÆÂÖ¨ÈñãAPI„Ç≠„ÉºÔºà„Éï„É≠„É≥„Éà„ÅÆApp BridgeÁî®Ôºâ
  # - ÁèæÁä∂„ÄÅGitHub Environment „Å´ Secrets „Å® Variables „ÅÆ‰∏°Êñπ„ÅåÊ∑∑Âú®„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ
  #   secrets „ÇíÂÑ™ÂÖà„Åó„ÄÅ„Å™„Åë„Çå„Å∞ vars „ÇíÂèÇÁÖß„Åô„ÇãÔºàÁ©∫Ê≥®ÂÖ•„ÇíÈò≤„ÅêÔºâ
  PROD1_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION || vars.SHOPIFY_API_KEY_PRODUCTION }}
  PROD2_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION_2 || vars.SHOPIFY_API_KEY_PRODUCTION_2 }}
  PROD3_SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY_PRODUCTION_3 || vars.SHOPIFY_API_KEY_PRODUCTION_3 }}

jobs:
  production-deploy:
    runs-on: ubuntu-latest
    environment: ec-ranger-prod
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    # ============================================
    # üöÄ „Ç≠„É£„ÉÉ„Ç∑„É•Ë®≠ÂÆöÔºà„Éì„É´„ÉâÊôÇÈñìÁü≠Á∏Æ„Éª„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂØæÁ≠ñÔºâ
    # ============================================
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: üì¶ Cache npm dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          frontend/node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: üì¶ Cache Next.js build
      uses: actions/cache@v4
      with:
        path: |
          frontend/.next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package.json') }}-${{ hashFiles('frontend/**/*.ts', 'frontend/**/*.tsx', 'frontend/**/*.js', 'frontend/**/*.jsx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('frontend/package.json') }}-
          ${{ runner.os }}-nextjs-

    - name: üìù Display deployment info
      run: |
        echo "üöÄ Production Frontend Deployment Started"
        echo "Environment: PRODUCTION"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Timestamp: $(date)"
        echo "‚ö†Ô∏è WARNING: This will deploy to the PRODUCTION environment!"

    # ============================================
    # üìä „Éì„É´„ÉâÂâç„ÅÆ„Çµ„Ç§„Ç∫Á¢∫Ë™çÔºàÂèÇËÄÉÊÉÖÂ†±Ôºâ
    # ============================================
    - name: üìä Check source code size
      working-directory: frontend
      run: |
        echo "=== Source code size (before build) ==="
        echo "Total frontend directory size:"
        du -sh . 2>/dev/null || echo "Unable to calculate"
        echo ""
        echo "Largest source directories:"
        du -h src/ 2>/dev/null | sort -rh | head -5 || echo "No src directory"
        echo ""
        echo "Node modules size (if exists):"
        du -sh node_modules/ 2>/dev/null || echo "node_modules not found (will be installed by Oryx)"
        echo ""
        echo "‚úÖ Standard Plan: Enabled (faster deployment expected)"
        echo ""
        echo "‚úÖ Standard Plan: Enabled (faster deployment expected)"

    # ============================================
    # ‚è±Ô∏è „Éá„Éó„É≠„Ç§ÈñãÂßãÊôÇÂàª„ÅÆË®òÈå≤
    # ============================================
    - name: ‚è±Ô∏è Record deployment start time
      id: deploy_start
      run: |
        echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
        echo "Deployment started at: $(date)"

    - name: üöÄ Deploy to Azure Static Web Apps (Production1)
      if: github.event.inputs.target_environment == 'Production1' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD1 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # Á©∫„Å´„Åô„Çã„Åì„Å®„ÅßÊú¨Áï™Áí∞Â¢É„Å´„Éá„Éó„É≠„Ç§
      env:
        # Êú¨Áï™Áí∞Â¢ÉÁî®„ÅÆÁí∞Â¢ÉÂ§âÊï∞
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variables„Åã„ÇâÂèñÂæóÔºà„Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥: https://ec-ranger-api.access-net.co.jpÔºâ
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD1_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install „Éö„Éº„Ç∏ „Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°Áî®ÔºàProduction1: ÂÖ¨Èñã„Ç¢„Éó„É™Ôºâ
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: 'https://apps.shopify.com/ec-ranger'
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Public'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    - name: üöÄ Deploy to Azure Static Web Apps (Production2)
      if: github.event.inputs.target_environment == 'Production2' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD2 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # Á©∫„Å´„Åô„Çã„Åì„Å®„ÅßÊú¨Áï™Áí∞Â¢É„Å´„Éá„Éó„É≠„Ç§
      env:
        # Êú¨Áï™Áí∞Â¢ÉÁî®„ÅÆÁí∞Â¢ÉÂ§âÊï∞
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variables„Åã„ÇâÂèñÂæóÔºà„Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥: https://ec-ranger-api.access-net.co.jpÔºâ
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD2_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install „Éö„Éº„Ç∏ „Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°Áî®ÔºàProduction2: „Ç´„Çπ„Çø„É†„Ç¢„Éó„É™Ôºâ
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: ''
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Custom'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    - name: üöÄ Deploy to Azure Static Web Apps (Production3)
      if: github.event.inputs.target_environment == 'Production3' || github.event.inputs.target_environment == 'All'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN_SECRET_PROD3 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: ${{ env.APP_LOCATION }}
        output_location: ${{ env.OUTPUT_LOCATION }}
        app_build_command: 'npm run build'
        deployment_environment: ''  # Á©∫„Å´„Åô„Çã„Åì„Å®„ÅßÊú¨Áï™Áí∞Â¢É„Å´„Éá„Éó„É≠„Ç§
      env:
        # Êú¨Áï™Áí∞Â¢ÉÁî®„ÅÆÁí∞Â¢ÉÂ§âÊï∞
        NEXT_PUBLIC_ENVIRONMENT: 'production'
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variables„Åã„ÇâÂèñÂæóÔºà„Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥: https://ec-ranger-api.access-net.co.jpÔºâ
        NEXT_PUBLIC_SHOPIFY_API_KEY: '${{ env.PROD3_SHOPIFY_API_KEY }}'
        NEXT_PUBLIC_USE_HTTPS: 'true'
        NEXT_PUBLIC_DISABLE_FEATURE_GATES: 'false'
        # /install „Éö„Éº„Ç∏ „Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°Áî®ÔºàProduction3: „Ç´„Çπ„Çø„É†„Ç¢„Éó„É™Ôºâ
        NEXT_PUBLIC_SHOPIFY_APP_STORE_URL: ''
        NEXT_PUBLIC_SHOPIFY_APP_TYPE: 'Custom'
        NODE_VERSION: ${{ env.NODE_VERSION }}

    # ============================================
    # üìä „Éá„Éó„É≠„Ç§„Çµ„Ç§„Ç∫ÂàÜÊûêÔºàÂèÇËÄÉÊÉÖÂ†±Ôºâ
    # ============================================
    - name: üìä Analyze deployment size
      if: always()
      run: |
        echo "=== Deployment Size Analysis ==="
        echo ""
        echo "üìù Note: Build size is determined by Oryx builder in Azure."
        echo "   Check the deployment logs above for 'Zipping App Artifacts' section."
        echo ""
        echo "üí° Optimization status:"
        echo "   1. productionBrowserSourceMaps: false (‚úÖ enabled)"
        echo "   2. Standard plan (‚úÖ upgraded)"
        echo "   3. Build caching (‚úÖ enabled)"
        echo "   4. Next.js build cache (‚úÖ enabled)"
        echo ""
        echo "üìä Expected build sizes:"
        echo "   - Small Next.js app: 10-30 MB"
        echo "   - Medium Next.js app: 30-60 MB"
        echo "   - Large Next.js app: 60-100 MB"
        echo "   - ‚ö†Ô∏è  If >100 MB, consider optimization"

    - name: ‚úÖ Deployment complete
      run: |
        echo "================================================"
        echo "‚úÖ Production Frontend Deployment Completed"
        echo "================================================"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo ""
        echo "üåê Frontend URLs:"
        echo "   Production1 (EC Ranger): ${{ env.PROD1_FRONTEND_URL }}"
        echo "   Production1 Custom Domain: ${{ env.PROD1_CUSTOM_DOMAIN }}"
        echo "   Production2 (EC Ranger-xn-fbkq6e5da0fpb): ${{ env.PROD2_FRONTEND_URL }}"
        echo "   Production3 (EC Ranger-demo): ${{ env.PROD3_FRONTEND_URL }}"
        echo ""
        echo "üìä Environment: PRODUCTION"
        echo "üìä Plan: Standard (optimized for faster deployment)"
        echo "üìä Check Azure Portal for detailed logs"
        echo ""
        echo "‚ö†Ô∏è PRODUCTION environment is now live!"
        echo "================================================"

    - name: üè• Health check (Production1)
      if: github.event.inputs.target_environment == 'Production1' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD1_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "‚úÖ Health check passed! (Status: $response)"
        else
          echo "‚ö†Ô∏è Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: üè• Health check (Production2)
      if: github.event.inputs.target_environment == 'Production2' || github.event.inputs.target_environment == 'Both' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD2_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "‚úÖ Health check passed! (Status: $response)"
        else
          echo "‚ö†Ô∏è Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: üè• Health check (Production3)
      if: github.event.inputs.target_environment == 'Production3' || github.event.inputs.target_environment == 'All'
      run: |
        echo "Waiting 45 seconds for deployment to stabilize..."
        sleep 45
        echo "Performing health check..."
        url="${{ env.PROD3_FRONTEND_URL }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" $url)
        if [ "$response" = "200" ] || [ "$response" = "401" ]; then
          echo "‚úÖ Health check passed! (Status: $response)"
        else
          echo "‚ö†Ô∏è Health check returned status: $response"
          echo "Note: Please verify the application manually"
        fi

    - name: üìã Production deployment summary
      if: always()
      run: |
        echo "================================================"
        echo "Production Deployment Summary"
        echo "================================================"
        echo "Environment: PRODUCTION"
        echo "Target: ${{ github.event.inputs.target_environment }}"
        echo "Frontend (Production1 - EC Ranger): ${{ env.PROD1_FRONTEND_URL }}"
        echo "Frontend (Production1 - Custom Domain): ${{ env.PROD1_CUSTOM_DOMAIN }}"
        echo "Frontend (Production2 - EC Ranger-xn-fbkq6e5da0fpb): ${{ env.PROD2_FRONTEND_URL }}"
        echo "Frontend (Production3 - EC Ranger-demo): ${{ env.PROD3_FRONTEND_URL }}"
        echo "Backend API: ${{ vars.NEXT_PUBLIC_API_URL }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Deployment time: $(date)"
        echo "================================================"
