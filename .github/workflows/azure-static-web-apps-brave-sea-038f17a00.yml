name: Frontend Deploy to Azure Static Web Apps

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
  # æ‰‹å‹•å®Ÿè¡Œæ©Ÿèƒ½ã‚’è¿½åŠ 
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'Production'
        type: choice
        options:
          - Production
          - development
      force_rebuild:
        description: 'å¼·åˆ¶ãƒªãƒ“ãƒ«ãƒ‰'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get build info
      id: build_info
      run: |
        echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
        echo "git_commit=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "git_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: Set deployment environment
      id: env
      run: |
        # mainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯å¸¸ã«Productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "deployment_environment=" >> $GITHUB_OUTPUT
          echo "environment_name=Production" >> $GITHUB_OUTPUT
          echo "node_env=production" >> $GITHUB_OUTPUT
          echo "build_environment=production" >> $GITHUB_OUTPUT
          echo "deploy_environment=production" >> $GITHUB_OUTPUT
          echo "app_environment=production" >> $GITHUB_OUTPUT
        # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸç’°å¢ƒã‚’ä½¿ç”¨
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.environment }}" = "Production" ]; then
            echo "deployment_environment=" >> $GITHUB_OUTPUT
            echo "environment_name=Production" >> $GITHUB_OUTPUT
            echo "node_env=production" >> $GITHUB_OUTPUT
            echo "build_environment=production" >> $GITHUB_OUTPUT
            echo "deploy_environment=production" >> $GITHUB_OUTPUT
            echo "app_environment=production" >> $GITHUB_OUTPUT
          else
            echo "deployment_environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "environment_name=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "node_env=development" >> $GITHUB_OUTPUT
            echo "build_environment=development" >> $GITHUB_OUTPUT
            echo "deploy_environment=development" >> $GITHUB_OUTPUT
            echo "app_environment=development" >> $GITHUB_OUTPUT
          fi
        # ãã®ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã¯developmentç’°å¢ƒ
        else
          echo "deployment_environment=development" >> $GITHUB_OUTPUT
          echo "environment_name=development" >> $GITHUB_OUTPUT
          echo "node_env=development" >> $GITHUB_OUTPUT
          echo "build_environment=development" >> $GITHUB_OUTPUT
          echo "deploy_environment=development" >> $GITHUB_OUTPUT
          echo "app_environment=development" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to Azure Static Web Apps
      id: builddeploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BRAVE_SEA_038F17A00 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/frontend"
        api_location: ""
        output_location: "out"
        # ä¿®æ­£: mainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯deployment_environmentã‚’ç©ºã«ã—ã¦æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        # ãã®ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        deployment_environment: ${{ steps.env.outputs.deployment_environment }}
        # ç’°å¢ƒå¤‰æ•°ã‚’Azure Static Web Appsã«æ¸¡ã™
        app_build_command: "npm run build"
        api_build_command: ""
        # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        app_settings: |
          NODE_ENV=${{ steps.env.outputs.node_env }}
          NEXT_PUBLIC_BUILD_ENVIRONMENT=${{ steps.env.outputs.build_environment }}
          NEXT_PUBLIC_DEPLOY_ENVIRONMENT=${{ steps.env.outputs.deploy_environment }}
          NEXT_PUBLIC_APP_ENVIRONMENT=${{ steps.env.outputs.app_environment }}
          NEXT_PUBLIC_BUILD_NUMBER=${{ steps.build_info.outputs.build_number }}
          NEXT_PUBLIC_GIT_COMMIT=${{ steps.build_info.outputs.git_commit }}
          NEXT_PUBLIC_GIT_BRANCH=${{ steps.build_info.outputs.git_branch }}
          NEXT_PUBLIC_BUILD_DATE=${{ steps.build_info.outputs.build_date }}

    - name: Deploy Status
      run: |
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: ${{ steps.builddeploy.outputs.app_url }}"
        echo "ğŸŒ ç’°å¢ƒ: ${{ steps.env.outputs.environment_name }}"
        echo "ğŸ”§ ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ: ${{ steps.env.outputs.deployment_environment == '' && 'Production (æœ¬ç•ªç’°å¢ƒ)' || format('Preview ({0})', steps.env.outputs.deployment_environment) }}"
        echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ID: ${{ steps.builddeploy.outputs.build_id }}"
        echo "ğŸ”¢ ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ steps.build_info.outputs.build_number }}"
        echo "ğŸ“… ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: ${{ steps.build_info.outputs.build_date }}"
        echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—: ${{ github.event_name }}"