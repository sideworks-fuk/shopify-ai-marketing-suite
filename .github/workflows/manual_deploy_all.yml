name: Deploy All (Frontend & Backend)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠž'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      deploy_frontend:
        description: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤'
        required: true
        type: boolean
        default: true
      deploy_backend:
        description: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤'
        required: true
        type: boolean
        default: true
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

jobs:
  deploy-backend:
    if: ${{ github.event.inputs.deploy_backend == 'true' }}
    runs-on: windows-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'

    - name: ðŸ“ Backend deployment info
      run: |
        echo "ðŸš€ Backend Deployment Started"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Message: ${{ github.event.inputs.deploy_message }}"

    - name: ðŸ”§ Set deployment target
      id: deploy_target
      run: |
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "app_name=shopifyapp-backend-develop" >> $GITHUB_OUTPUT
          echo "app_url=https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/" >> $GITHUB_OUTPUT
        else
          echo "app_name=ShopifyTestApi20250720173320" >> $GITHUB_OUTPUT
          echo "app_url=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net/" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: ðŸ” Restore dependencies
      run: dotnet restore
      working-directory: ./backend/ShopifyAnalyticsApi

    - name: ðŸ—ï¸ Build project
      run: dotnet build --configuration Release --no-restore
      working-directory: ./backend/ShopifyAnalyticsApi

    - name: ðŸ“¦ Publish project
      run: dotnet publish -c Release -o ./published
      working-directory: ./backend/ShopifyAnalyticsApi

    - name: ðŸš€ Deploy to Azure App Service (Production)
      if: github.event.inputs.environment == 'production'
      uses: azure/webapps-deploy@v3
      with:
        app-name: shopifyapp-backend-develop
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_C60B318531324C8F9CC369407A7D3DF7 }}
        package: ./backend/ShopifyAnalyticsApi/published

    - name: ðŸš€ Deploy to Azure App Service (Dev/Staging)
      if: github.event.inputs.environment != 'production'
      uses: azure/webapps-deploy@v3
      with:
        app-name: ShopifyTestApi20250720173320
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./backend/ShopifyAnalyticsApi/published

    - name: âœ… Backend deployment complete
      run: echo "âœ… Backend deployed successfully!"

  deploy-frontend:
    if: ${{ github.event.inputs.deploy_frontend == 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    needs: [deploy-backend]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ“ Frontend deployment info
      run: |
        echo "ðŸš€ Frontend Deployment Started"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Message: ${{ github.event.inputs.deploy_message }}"

    - name: ðŸ”§ Set deployment environment
      id: env
      run: |
        # productionã®å ´åˆã¯deployment_environmentã‚’ç©ºã«ã—ã¦æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "deployment_environment=" >> $GITHUB_OUTPUT
          echo "next_public_environment=production" >> $GITHUB_OUTPUT
        # stagingã®å ´åˆã¯stagingç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
          echo "deployment_environment=staging" >> $GITHUB_OUTPUT
          echo "next_public_environment=staging" >> $GITHUB_OUTPUT
        # developmentã®å ´åˆã¯developmentç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        else
          echo "deployment_environment=development" >> $GITHUB_OUTPUT
          echo "next_public_environment=development" >> $GITHUB_OUTPUT
        fi

    - name: ðŸš€ Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BRAVE_SEA_038F17A00 }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: '/frontend'
        output_location: '.next'
        app_build_command: 'npm run build'
        deployment_environment: ${{ steps.env.outputs.deployment_environment }}
      env:
        NEXT_PUBLIC_ENVIRONMENT: ${{ steps.env.outputs.next_public_environment }}
        NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
        NEXT_PUBLIC_SHOPIFY_API_KEY: ${{ vars.NEXT_PUBLIC_SHOPIFY_API_KEY }}
        NODE_VERSION: 20

    - name: âœ… Frontend deployment complete
      run: echo "âœ… Frontend deployed successfully!"

  summary:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "========================================="
        echo "ðŸ“Š DEPLOYMENT SUMMARY"
        echo "========================================="
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Frontend Deploy: ${{ github.event.inputs.deploy_frontend }}"
        echo "Backend Deploy: ${{ github.event.inputs.deploy_backend }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Message: ${{ github.event.inputs.deploy_message }}"
        echo ""
        echo "ðŸ”— URLs:"
        echo "Frontend: https://brave-sea-038f17a00.1.azurestaticapps.net"
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "Backend: https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/"
        else
          echo "Backend: https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net/"
        fi
        echo "========================================="