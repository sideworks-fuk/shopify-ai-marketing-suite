name: Backend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠ'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

env:
  AZURE_WEBAPP_PACKAGE_PATH: './backend/ShopifyAnalyticsApi'
  DOTNET_VERSION: '8.x'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ”§ Set deployment target
      id: deploy_target
      run: |
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "app_name=shopifyapp-backend-develop" >> $GITHUB_OUTPUT
          echo "app_url=https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/" >> $GITHUB_OUTPUT
          echo "publish_profile=AZUREAPPSERVICE_PUBLISHPROFILE_C60B318531324C8F9CC369407A7D3DF7" >> $GITHUB_OUTPUT
        else
          echo "app_name=ShopifyTestApi20250720173320" >> $GITHUB_OUTPUT
          echo "app_url=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net/" >> $GITHUB_OUTPUT
          echo "publish_profile=AZURE_WEBAPP_PUBLISH_PROFILE" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: ğŸ“ Display deployment info
      run: |
        echo "ğŸš€ Manual Backend Deployment Started"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Deploy message: ${{ github.event.inputs.deploy_message }}"
        echo "Timestamp: $(date)"

    - name: ğŸ” Restore dependencies
      run: dotnet restore
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: ğŸ—ï¸ Build project
      run: dotnet build --configuration Release --no-restore
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: ğŸ“¦ Publish project
      run: dotnet publish -c Release -o ./published
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    - name: ğŸš€ Deploy to Azure App Service (Production)
      if: github.event.inputs.environment == 'production'
      uses: azure/webapps-deploy@v3
      with:
        app-name: shopifyapp-backend-develop
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_C60B318531324C8F9CC369407A7D3DF7 }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/published

    - name: ğŸš€ Deploy to Azure App Service (Dev/Staging)
      if: github.event.inputs.environment != 'production'
      uses: azure/webapps-deploy@v3
      with:
        app-name: ShopifyTestApi20250720173320
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/published

    - name: âœ… Deployment complete
      run: |
        echo "âœ… Backend deployment completed successfully!"
        echo "ğŸŒ App URL: ${{ steps.deploy_target.outputs.app_url }}"
        echo "ğŸ“Š Check Azure Portal for detailed logs"

    - name: ğŸ¥ Health check
      run: |
        echo "Waiting 30 seconds for deployment to stabilize..."
        Start-Sleep -Seconds 30
        echo "Performing health check..."
        try {
          $response = Invoke-WebRequest -Uri "${{ steps.deploy_target.outputs.app_url }}api/health" -UseBasicParsing
          if ($response.StatusCode -eq 200) {
            echo "âœ… Health check passed!"
          } else {
            echo "âš ï¸ Health check returned status: $($response.StatusCode)"
          }
        } catch {
          echo "âŒ Health check failed: $_"
          exit 1
        }
      shell: pwsh