# Shopify公式ドキュメント準拠 - 課金システムテスト方法まとめ

**作成日**: 2026年1月14日  
**作成者**: AI Assistant  
**目的**: Shopify公式ドキュメントに基づいた課金システムのテスト方法を整理し、実装状況を確認してテストを実施する

---

## 📋 目次

1. [Shopify公式ドキュメントの確認結果](#shopify公式ドキュメントの確認結果)
2. [実装状況の確認](#実装状況の確認)
3. [テスト方法のまとめ](#テスト方法のまとめ)
4. [テストシナリオ](#テストシナリオ)
5. [残タスクの整理](#残タスクの整理)
6. [ドキュメント更新計画](#ドキュメント更新計画)

---

## Shopify公式ドキュメントの確認結果

### 1. App Subscription API（GraphQL Admin API）

#### 1.1 ミューテーション仕様

**`appSubscriptionCreate` ミューテーション**

```graphql
mutation appSubscriptionCreate($input: AppSubscriptionCreateInput!) {
  appSubscriptionCreate(appSubscription: $input) {
    confirmationUrl
    appSubscription {
      id
      status
      test
    }
    userErrors {
      field
      message
    }
  }
}
```

**重要なパラメータ**:
- `test: Boolean = false` - **テストモードフラグ（重要）**
  - `true` に設定すると、実際の請求が発生しない
  - 開発ストアやテストストアでは自動的に請求が発生しない
  - テストモードで作成されたサブスクリプションには `test: true` フラグが付与される

**公式ドキュメント**: [App Subscription API](https://shopify.dev/docs/api/admin-graphql/latest/mutations/appSubscriptionCreate)

#### 1.2 テストモードの動作

**公式ドキュメントの要点**:
- **テストモード**: `test: true` を指定すると、実際のクレジットカードへの請求が発生しない
- **開発ストア**: 開発ストアやデモストアでは自動的に請求が発生しない
- **テストフラグ**: テストモードで作成されたサブスクリプションには `test: true` フラグが付与される
- **承認画面**: テストモードの場合、Shopifyの承認画面に「TEST」ラベルが表示され、金額が `$0.00` になる

**参考**: [Pass app review - Test your app's billing system](https://shopify.dev/docs/apps/launch/app-store-review/pass-app-review#test-your-apps-billing-system)

---

## 実装状況の確認

### 1. バックエンド実装

#### 1.1 ShopifySubscriptionService.cs

**実装箇所**: `backend/ShopifyAnalyticsApi/Services/ShopifySubscriptionService.cs`

**確認結果**:
- ✅ **テストモード対応**: `test` パラメータが実装済み
  ```csharp
  test = _configuration.GetValue<bool>("Shopify:TestMode", true)
  ```
- ✅ **GraphQL API統合**: `appSubscriptionCreate` ミューテーション実装済み
- ✅ **エラーハンドリング**: `userErrors` の処理実装済み
- ✅ **confirmationUrl取得**: 承認URLの取得実装済み

**設定ファイル**:
- `appsettings.Development.json`: `Shopify:TestMode` 設定の確認が必要
- `appsettings.Production.json`: 本番環境では `TestMode: false` に設定する必要がある

#### 1.2 設定ファイルの確認

**確認すべき設定**:
- [ ] `appsettings.Development.json` に `Shopify:TestMode` が設定されているか
- [ ] `appsettings.Production.json` に `Shopify:TestMode: false` が設定されているか
- [ ] 環境変数での設定方法が明確か

### 2. フロントエンド実装

#### 2.1 課金管理画面

**実装箇所**: `frontend/src/app/billing/page.tsx`

**確認項目**:
- [ ] プラン選択UIが実装されているか
- [ ] テストモード時の表示が適切か（「TEST」ラベル、`$0.00` 表示）
- [ ] エラーハンドリングが実装されているか

### 3. Webhook処理

#### 3.1 WebhookController.cs

**実装箇所**: `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

**確認項目**:
- [ ] `app_subscriptions/update` Webhook処理が実装されているか
- [ ] `app_subscriptions/cancel` Webhook処理が実装されているか
- [ ] HMAC署名検証が実装されているか
- [ ] 冪等性処理（IdempotencyKey）が実装されているか

---

## テスト方法のまとめ

### 1. テスト環境の準備

#### 1.1 開発ストアの準備

**必須条件**:
- ✅ Shopify Partner Dashboardで開発ストアを作成
- ✅ アプリを開発ストアにインストール
- ✅ OAuth認証が完了していること

**手順**:
1. [Partner Dashboard](https://partners.shopify.com/) にログイン
2. **Apps** → 対象アプリを選択
3. **Test your app** セクションで **Select store** をクリック
4. 開発ストアを選択して **Install app** をクリック

#### 1.2 バックエンド設定

**appsettings.Development.json**:
```json
{
  "Shopify": {
    "TestMode": true,
    "ApiKey": "YOUR_API_KEY",
    "ApiSecret": "YOUR_API_SECRET",
    "WebhookSecret": "YOUR_WEBHOOK_SECRET"
  }
}
```

**重要**: `TestMode: true` を設定することで、すべてのサブスクリプション作成がテストモードで実行される

#### 1.3 Webhook設定

**ngrok設定（ローカルテスト用）**:
```bash
# ngrokを起動
ngrok http 7140

# 生成されたURLをメモ
# 例: https://abc123.ngrok.io
```

**Shopify Partner Dashboardでの設定**:
1. **Apps** → 対象アプリ → **Configuration**
2. **Webhooks** セクションで以下を登録:
   - `app_subscriptions/update`: `https://abc123.ngrok.io/api/webhook/app_subscriptions/update`
   - `app_subscriptions/cancel`: `https://abc123.ngrok.io/api/webhook/app_subscriptions/cancel`

### 2. テストモードでの動作確認

#### 2.1 サブスクリプション作成テスト

**テスト手順**:
1. **アプリにログイン**
   - 開発ストアの管理画面からアプリにアクセス
   - OAuth認証が完了していることを確認

2. **プラン選択画面にアクセス**
   - `/billing` ページにアクセス
   - プラン一覧が表示されることを確認

3. **プランを選択**
   - 例: Professional Plan ($80/月)
   - 「選択」ボタンをクリック

4. **Shopify承認画面の確認**
   - ✅ **「TEST」ラベルが表示されているか確認**
   - ✅ **金額が `$0.00` になっているか確認**
   - ✅ **プラン名、価格、トライアル日数が正しく表示されているか確認**

5. **承認を実行**
   - 「Approve」ボタンをクリック
   - アプリにリダイレクトされることを確認

6. **データベースの確認**
   ```sql
   SELECT * FROM StoreSubscriptions 
   WHERE StoreId = {storeId} 
   ORDER BY CreatedAt DESC;
   ```
   - ✅ 状態が `active` になっているか確認
   - ✅ `test` フラグが `true` になっているか確認（Shopify APIから取得した場合）

7. **Webhook受信の確認**
   - ✅ `app_subscriptions/update` Webhookが受信されているか確認
   - ✅ データベースの状態が更新されているか確認

#### 2.2 プラン変更テスト

**テスト手順**:
1. **現在のプラン確認**
   - `/billing` ページで現在のプランを確認

2. **プラン変更を実行**
   - 例: Professional → Enterprise
   - 「プラン変更」ボタンをクリック

3. **Shopify承認画面の確認**
   - ✅ テストモードで `$0.00` が表示されることを確認

4. **承認後の確認**
   - ✅ データベースのプランが更新されているか確認
   - ✅ Webhookが受信されているか確認

#### 2.3 サブスクリプションキャンセルテスト

**テスト手順**:
1. **キャンセルを実行**
   - `/billing` ページで「キャンセル」ボタンをクリック

2. **Shopify承認画面の確認**
   - ✅ テストモードで `$0.00` が表示されることを確認

3. **承認後の確認**
   - ✅ データベースの状態が `cancelled` になっているか確認
   - ✅ `app_subscriptions/cancel` Webhookが受信されているか確認

#### 2.4 トライアル機能テスト

**テスト手順**:
1. **トライアル付きプランを選択**
   - トライアル日数が設定されているプランを選択

2. **トライアル開始の確認**
   - ✅ データベースの `TrialEndsAt` が正しく設定されているか確認
   - ✅ 状態が `trialing` になっているか確認

3. **トライアル期限切れのテスト**
   - ✅ トライアル期限切れ後の状態遷移を確認
   - ✅ 自動的に `active` 状態に遷移するか確認

### 3. エラーハンドリングテスト

#### 3.1 GraphQL APIエラーのテスト

**テストケース**:
- [ ] 無効なプランIDを指定した場合のエラー処理
- [ ] ネットワークエラー時のリトライ処理
- [ ] Rate Limit（429エラー）時のリトライ処理
- [ ] `userErrors` が返却された場合のエラー表示

#### 3.2 Webhookエラーのテスト

**テストケース**:
- [ ] HMAC署名検証エラーの処理
- [ ] 重複Webhookの処理（冪等性）
- [ ] 不正なWebhookデータの処理

---

## テストシナリオ

### Phase 1: 基本機能テスト（必須）

#### シナリオ1: 新規サブスクリプション作成（テストモード）

**目的**: テストモードでサブスクリプションが正常に作成されることを確認

**前提条件**:
- 開発ストアにアプリがインストール済み
- `Shopify:TestMode: true` が設定されている
- Webhookが設定されている

**手順**:
1. アプリにログイン
2. `/billing` ページにアクセス
3. Professional Planを選択
4. Shopify承認画面で以下を確認:
   - 「TEST」ラベルが表示されている
   - 金額が `$0.00` になっている
5. 「Approve」をクリック
6. アプリにリダイレクトされることを確認
7. データベースで以下を確認:
   - `StoreSubscriptions` テーブルにレコードが作成されている
   - 状態が `active` になっている
   - `ShopifyChargeId` が設定されている
8. Webhookログで以下を確認:
   - `app_subscriptions/update` Webhookが受信されている

**期待結果**:
- ✅ サブスクリプションが正常に作成される
- ✅ テストモードで請求が発生しない
- ✅ データベースの状態が正しく更新される
- ✅ Webhookが正常に受信される

**確認方法**:
```bash
# API直接テスト
curl -X POST https://localhost:7140/api/billing/subscribe \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{"planId": "2", "returnUrl": "/billing"}'

# データベース確認
SELECT * FROM StoreSubscriptions WHERE StoreId = {storeId} ORDER BY CreatedAt DESC;
```

#### シナリオ2: プラン変更（テストモード）

**目的**: プラン変更が正常に動作することを確認

**前提条件**:
- アクティブなサブスクリプションが存在する
- `Shopify:TestMode: true` が設定されている

**手順**:
1. `/billing` ページで現在のプランを確認
2. 「プラン変更」ボタンをクリック
3. Enterprise Planを選択
4. Shopify承認画面でテストモードであることを確認
5. 「Approve」をクリック
6. データベースで以下を確認:
   - プランIDが更新されている
   - `CurrentPeriodEnd` が更新されている
7. Webhookログで以下を確認:
   - `app_subscriptions/update` Webhookが受信されている

**期待結果**:
- ✅ プランが正常に変更される
- ✅ データベースの状態が正しく更新される
- ✅ Webhookが正常に受信される

#### シナリオ3: サブスクリプションキャンセル（テストモード）

**目的**: サブスクリプションキャンセルが正常に動作することを確認

**前提条件**:
- アクティブなサブスクリプションが存在する
- `Shopify:TestMode: true` が設定されている

**手順**:
1. `/billing` ページで「キャンセル」ボタンをクリック
2. Shopify承認画面でテストモードであることを確認
3. 「Approve」をクリック
4. データベースで以下を確認:
   - 状態が `cancelled` になっている
   - `CancelledAt` が設定されている
5. Webhookログで以下を確認:
   - `app_subscriptions/cancel` Webhookが受信されている

**期待結果**:
- ✅ サブスクリプションが正常にキャンセルされる
- ✅ データベースの状態が正しく更新される
- ✅ Webhookが正常に受信される

### Phase 2: エラーハンドリングテスト

#### シナリオ4: Rate Limitエラーのテスト

**目的**: Rate Limit（429エラー）時のリトライ処理が正常に動作することを確認

**前提条件**:
- `Shopify:TestMode: true` が設定されている
- リトライポリシーが実装されている

**手順**:
1. 大量のリクエストを短時間で送信（Rate Limitを発生させる）
2. リトライ処理が実行されることを確認
3. ログで以下を確認:
   - リトライ回数
   - `Retry-After` ヘッダーの値
   - 指数バックオフの動作

**期待結果**:
- ✅ Rate Limitエラー時にリトライが実行される
- ✅ 指数バックオフが正しく動作する
- ✅ 最終的にリクエストが成功する

#### シナリオ5: Webhook署名検証エラーのテスト

**目的**: Webhook署名検証エラーが正しく処理されることを確認

**前提条件**:
- Webhookが設定されている
- HMAC署名検証が実装されている

**手順**:
1. 不正な署名でWebhookを送信
2. エラーログで以下を確認:
   - HMAC署名検証エラーが記録されている
   - リクエストが拒否されている

**期待結果**:
- ✅ 不正な署名のWebhookが拒否される
- ✅ エラーログが記録される
- ✅ データベースが更新されない

### Phase 3: 統合テスト

#### シナリオ6: エンドツーエンドテスト

**目的**: インストールからサブスクリプション作成までの一連の流れを確認

**前提条件**:
- 開発ストアが準備されている
- `Shopify:TestMode: true` が設定されている

**手順**:
1. **アプリインストール**
   - Partner Dashboardからアプリをインストール
   - OAuth認証が完了することを確認

2. **初期設定**
   - 初期設定画面が表示されることを確認
   - 設定を完了

3. **プラン選択**
   - `/billing` ページにアクセス
   - プラン一覧が表示されることを確認

4. **サブスクリプション作成**
   - Professional Planを選択
   - Shopify承認画面でテストモードであることを確認
   - 「Approve」をクリック

5. **機能アクセステスト**
   - 有料プランの機能にアクセスできることを確認
   - 機能制限が正しく動作することを確認

**期待結果**:
- ✅ 一連の流れが正常に動作する
- ✅ テストモードで請求が発生しない
- ✅ 機能アクセス制限が正しく動作する

---

## 残タスクの整理

### 1. 実装確認タスク

#### 1.1 設定ファイルの確認
- [ ] `appsettings.Development.json` に `Shopify:TestMode` が設定されているか確認
- [ ] `appsettings.Production.json` に `Shopify:TestMode: false` が設定されているか確認
- [ ] 環境変数での設定方法を確認

#### 1.2 コード実装の確認
- [ ] `ShopifySubscriptionService.cs` の `test` パラメータ設定を確認
- [ ] エラーハンドリングの実装を確認
- [ ] Webhook処理の実装を確認

### 2. テスト実施タスク

#### 2.1 基本機能テスト
- [ ] シナリオ1: 新規サブスクリプション作成（テストモード）
- [ ] シナリオ2: プラン変更（テストモード）
- [ ] シナリオ3: サブスクリプションキャンセル（テストモード）

#### 2.2 エラーハンドリングテスト
- [ ] シナリオ4: Rate Limitエラーのテスト
- [ ] シナリオ5: Webhook署名検証エラーのテスト

#### 2.3 統合テスト
- [ ] シナリオ6: エンドツーエンドテスト

### 3. ドキュメント更新タスク

#### 3.1 既存ドキュメントの更新
- [ ] `課金0円テスト完全手順書.md` を最新の実装に合わせて更新
- [ ] `テスト手順書-課金と無料プラン.md` を最新の実装に合わせて更新
- [ ] `実装状況サマリー-2026-01-07.md` を更新（テスト実施状況を反映）

#### 3.2 新規ドキュメントの作成
- [ ] テスト結果レポートの作成
- [ ] 不具合レポートの作成（該当する場合）

---

## ドキュメント更新計画

### 1. 既存ドキュメントの更新

#### 1.1 `課金0円テスト完全手順書.md`
**更新内容**:
- Shopify公式ドキュメントの最新情報を反映
- `test` パラメータの使用方法を明確化
- エラーハンドリングのテスト方法を追加

#### 1.2 `テスト手順書-課金と無料プラン.md`
**更新内容**:
- テストモードの動作を明確化
- エラーハンドリングのテストシナリオを追加
- 統合テストのシナリオを追加

#### 1.3 `実装状況サマリー-2026-01-07.md`
**更新内容**:
- テスト実施状況を反映
- 不具合の有無を記録
- 改善点を記録

### 2. 新規ドキュメントの作成

#### 2.1 テスト結果レポート
**作成タイミング**: テスト実施後  
**内容**:
- 各シナリオのテスト結果
- 発見された不具合
- 改善提案

#### 2.2 不具合レポート（該当する場合）
**作成タイミング**: 不具合発見時  
**内容**:
- 不具合の詳細
- 再現手順
- 修正内容

---

## 次のアクション

### 即座に実施すべきこと

1. **設定ファイルの確認**
   - [ ] `appsettings.Development.json` に `Shopify:TestMode: true` が設定されているか確認
   - [ ] 設定されていない場合は追加

2. **実装コードの確認**
   - [ ] `ShopifySubscriptionService.cs` の `test` パラメータ設定を確認
   - [ ] エラーハンドリングの実装を確認

3. **テスト環境の準備**
   - [ ] 開発ストアの準備
   - [ ] Webhook設定の確認

### 1週間以内に実施すべきこと

4. **基本機能テストの実施**
   - [ ] シナリオ1: 新規サブスクリプション作成
   - [ ] シナリオ2: プラン変更
   - [ ] シナリオ3: サブスクリプションキャンセル

5. **エラーハンドリングテストの実施**
   - [ ] シナリオ4: Rate Limitエラーのテスト
   - [ ] シナリオ5: Webhook署名検証エラーのテスト

6. **統合テストの実施**
   - [ ] シナリオ6: エンドツーエンドテスト

### テスト完了後に実施すべきこと

7. **ドキュメントの更新**
   - [ ] テスト結果レポートの作成
   - [ ] 既存ドキュメントの更新
   - [ ] 不具合レポートの作成（該当する場合）

---

## 参考資料

### Shopify公式ドキュメント

1. **App Subscription API**
   - [GraphQL Admin API - appSubscriptionCreate](https://shopify.dev/docs/api/admin-graphql/latest/mutations/appSubscriptionCreate)
   - [App Subscriptions](https://shopify.dev/docs/apps/launch/billing/app-subscriptions)

2. **テスト方法**
   - [Pass app review - Test your app's billing system](https://shopify.dev/docs/apps/launch/app-store-review/pass-app-review#test-your-apps-billing-system)

3. **Webhook**
   - [Webhooks](https://shopify.dev/docs/apps/webhooks)

### 内部ドキュメント

1. **実装状況**
   - `docs/00-production-release/04-billing-system/実装状況サマリー-2026-01-07.md`
   - `docs/00-production-release/04-billing-system/課金システムテストタスクリスト-2026-01-07.md`

2. **テスト手順**
   - `docs/08-shopify/02-課金システム/04-理解と運用/課金0円テスト完全手順書.md`
   - `docs/08-shopify/02-課金システム/03-実装管理/テスト手順書-課金と無料プラン.md`

3. **技術仕様**
   - `docs/08-shopify/02-課金システム/02-技術仕様/Shopifyサブスクリプション技術ガイド.md`
   - `docs/08-shopify/02-課金システム/02-技術仕様/GraphQL_API最新仕様.md`

---

**最終更新**: 2026-01-14  
**次回更新予定**: テスト実施後、結果を反映
