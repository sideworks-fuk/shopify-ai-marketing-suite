# 課金システムテスト - 残タスク整理

**作成日**: 2026年1月14日  
**作成者**: AI Assistant  
**目的**: 実装状況の確認、テスト実施、残タスクの実装、ドキュメント更新の進捗管理

---

## 📊 実装状況確認結果

### 1. バックエンド実装

#### 1.1 ShopifySubscriptionService.cs

**確認結果**: ✅ **実装済み**

**実装内容**:
- ✅ `appSubscriptionCreate` ミューテーション実装済み
- ✅ `test` パラメータ設定実装済み
  ```csharp
  test = _configuration.GetValue<bool>("Shopify:TestMode", true)
  ```
- ✅ `confirmationUrl` 取得実装済み
- ✅ エラーハンドリング（`userErrors`）実装済み
- ✅ データベースへの保存実装済み

**ファイル**: `backend/ShopifyAnalyticsApi/Services/ShopifySubscriptionService.cs` (行129)

#### 1.2 設定ファイル

**確認結果**: ⚠️ **要確認**

**確認すべき設定**:
- [ ] `appsettings.Development.json` に `Shopify:TestMode` が設定されているか
- [ ] `appsettings.Production.json` に `Shopify:TestMode: false` が設定されているか
- [ ] 環境変数での設定方法が明確か

**推奨設定**:
```json
{
  "Shopify": {
    "TestMode": true,  // Development環境では true
    "ApiKey": "...",
    "ApiSecret": "...",
    "WebhookSecret": "..."
  }
}
```

#### 1.3 Webhook処理

**確認結果**: ✅ **実装済み**（要詳細確認）

**実装内容**:
- ✅ `app_subscriptions/update` Webhook処理
- ✅ `app_subscriptions/cancel` Webhook処理
- ✅ HMAC署名検証
- ✅ 冪等性処理（IdempotencyKey）

**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

### 2. フロントエンド実装

#### 2.1 課金管理画面

**確認結果**: ✅ **実装済み**（要詳細確認）

**実装内容**:
- ✅ プラン選択UI
- ✅ プラン比較表
- ✅ トライアルバナー

**ファイル**: `frontend/src/app/billing/page.tsx`

**確認項目**:
- [ ] テストモード時の表示が適切か（「TEST」ラベル、`$0.00` 表示）
- [ ] エラーハンドリングが実装されているか

### 3. データベース

#### 3.1 テーブル

**確認結果**: ✅ **実装済み**

**実装済みテーブル**:
- ✅ `SubscriptionPlans` - プラン情報
- ✅ `StoreSubscriptions` - サブスクリプション情報
- ✅ `FeatureLimits` - 機能制限マスタ
- ✅ `UserFeatureSelections` - 無料プラン機能選択
- ✅ `FeatureUsageLogs` - 機能使用ログ
- ✅ `WebhookEvents` - Webhook受信履歴

---

## 🧪 テスト実施計画

### Phase 1: 実装確認テスト（1-2日）

#### タスク1: 設定ファイルの確認と修正

**優先度**: 🔴 Critical  
**推定時間**: 30分  
**担当**: 開発者

**作業内容**:
1. `appsettings.Development.json` の確認
   - [ ] `Shopify:TestMode` が設定されているか確認
   - [ ] 設定されていない場合は `true` を追加

2. `appsettings.Production.json` の確認
   - [ ] `Shopify:TestMode: false` が設定されているか確認
   - [ ] 設定されていない場合は `false` を追加

3. 環境変数での設定方法の確認
   - [ ] Azure App Serviceの設定を確認
   - [ ] GitHub Actionsの設定を確認

**確認方法**:
```bash
# 設定ファイルの確認
cat backend/ShopifyAnalyticsApi/appsettings.Development.json | grep -i testmode
cat backend/ShopifyAnalyticsApi/appsettings.Production.json | grep -i testmode
```

**期待結果**:
- ✅ Development環境では `TestMode: true` が設定されている
- ✅ Production環境では `TestMode: false` が設定されている

#### タスク2: 実装コードの詳細確認

**優先度**: 🔴 Critical  
**推定時間**: 1時間  
**担当**: 開発者

**作業内容**:
1. `ShopifySubscriptionService.cs` の確認
   - [ ] `test` パラメータが正しく設定されているか確認
   - [ ] エラーハンドリングが適切か確認
   - [ ] ログ出力が適切か確認

2. `WebhookController.cs` の確認
   - [ ] HMAC署名検証が実装されているか確認
   - [ ] 冪等性処理が実装されているか確認
   - [ ] エラーハンドリングが適切か確認

3. `BillingController.cs` の確認
   - [ ] APIエンドポイントが正しく実装されているか確認
   - [ ] エラーハンドリングが適切か確認

**確認方法**:
- コードレビュー
- ログ出力の確認

**期待結果**:
- ✅ すべての実装が正しく動作する
- ✅ エラーハンドリングが適切に実装されている

### Phase 2: 基本機能テスト（2-3日）

#### タスク3: 新規サブスクリプション作成テスト

**優先度**: 🔴 Critical  
**推定時間**: 2時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] プラン選択画面が表示される
- [ ] プランを選択できる
- [ ] Shopify承認画面に「TEST」ラベルが表示される
- [ ] Shopify承認画面で金額が `$0.00` になる
- [ ] 承認後にアプリにリダイレクトされる
- [ ] データベースにサブスクリプションが作成される
- [ ] Webhookが受信される

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ1を参照

#### タスク4: プラン変更テスト

**優先度**: 🟡 High  
**推定時間**: 1.5時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] 現在のプランが表示される
- [ ] プラン変更が実行できる
- [ ] Shopify承認画面でテストモードであることが確認できる
- [ ] 承認後にプランが更新される
- [ ] データベースのプランが更新される
- [ ] Webhookが受信される

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ2を参照

#### タスク5: サブスクリプションキャンセルテスト

**優先度**: 🟡 High  
**推定時間**: 1.5時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] キャンセルが実行できる
- [ ] Shopify承認画面でテストモードであることが確認できる
- [ ] 承認後にサブスクリプションがキャンセルされる
- [ ] データベースの状態が `cancelled` になる
- [ ] Webhookが受信される

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ3を参照

### Phase 3: エラーハンドリングテスト（1-2日）

#### タスク6: Rate Limitエラーのテスト

**優先度**: 🟡 High  
**推定時間**: 2時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] Rate Limit（429エラー）が発生した場合のリトライ処理
- [ ] 指数バックオフの動作確認
- [ ] `Retry-After` ヘッダーの処理確認
- [ ] ログ出力の確認

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ4を参照

#### タスク7: Webhook署名検証エラーのテスト

**優先度**: 🟡 High  
**推定時間**: 1時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] 不正な署名のWebhookが拒否される
- [ ] エラーログが記録される
- [ ] データベースが更新されない

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ5を参照

### Phase 4: 統合テスト（1-2日）

#### タスク8: エンドツーエンドテスト

**優先度**: 🟡 High  
**推定時間**: 3時間  
**担当**: テスト担当者

**テスト内容**:
- [ ] アプリインストールからサブスクリプション作成までの一連の流れ
- [ ] 機能アクセス制限の動作確認
- [ ] エラーハンドリングの動作確認

**詳細**: [Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md](./Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md) のシナリオ6を参照

---

## 🔧 残タスクの実装

### 1. 設定ファイルの修正（必要に応じて）

#### 1.1 appsettings.Development.json の更新

**作業内容**:
- [ ] `Shopify:TestMode: true` が設定されているか確認
- [ ] 設定されていない場合は追加

**ファイル**: `backend/ShopifyAnalyticsApi/appsettings.Development.json`

#### 1.2 appsettings.Production.json の更新

**作業内容**:
- [ ] `Shopify:TestMode: false` が設定されているか確認
- [ ] 設定されていない場合は追加

**ファイル**: `backend/ShopifyAnalyticsApi/appsettings.Production.json`

### 2. コード修正（必要に応じて）

#### 2.1 エラーハンドリングの強化

**作業内容**:
- [ ] GraphQL APIエラーの詳細なログ出力
- [ ] Webhookエラーの詳細なログ出力
- [ ] ユーザー向けエラーメッセージの改善

#### 2.2 テストモード表示の改善

**作業内容**:
- [ ] フロントエンドでテストモードであることを明示的に表示
- [ ] テストモード時の警告メッセージの追加

---

## 📝 ドキュメント更新計画

### 1. 既存ドキュメントの更新

#### 1.1 課金0円テスト完全手順書.md

**更新内容**:
- [ ] Shopify公式ドキュメントの最新情報を反映
- [ ] `test` パラメータの使用方法を明確化
- [ ] エラーハンドリングのテスト方法を追加
- [ ] 実装状況に合わせて内容を更新

**ファイル**: `docs/08-shopify/02-課金システム/04-理解と運用/課金0円テスト完全手順書.md`

#### 1.2 テスト手順書-課金と無料プラン.md

**更新内容**:
- [ ] テストモードの動作を明確化
- [ ] エラーハンドリングのテストシナリオを追加
- [ ] 統合テストのシナリオを追加
- [ ] 実装状況に合わせて内容を更新

**ファイル**: `docs/08-shopify/02-課金システム/03-実装管理/テスト手順書-課金と無料プラン.md`

#### 1.3 実装状況サマリー-2026-01-07.md

**更新内容**:
- [ ] テスト実施状況を反映
- [ ] 不具合の有無を記録
- [ ] 改善点を記録
- [ ] テスト完了日時を記録

**ファイル**: `docs/00-production-release/04-billing-system/実装状況サマリー-2026-01-07.md`

### 2. 新規ドキュメントの作成

#### 2.1 テスト結果レポート

**作成タイミング**: テスト実施後  
**ファイル名**: `docs/08-shopify/02-課金システム/03-実装管理/課金システムテスト結果レポート-YYYY-MM-DD.md`

**内容**:
- 各シナリオのテスト結果
- 発見された不具合
- 改善提案
- 次のアクション

#### 2.2 不具合レポート（該当する場合）

**作成タイミング**: 不具合発見時  
**ファイル名**: `docs/08-shopify/02-課金システム/03-実装管理/不具合レポート-YYYY-MM-DD.md`

**内容**:
- 不具合の詳細
- 再現手順
- 修正内容
- 修正後の検証結果

---

## 📋 タスク一覧（優先順位順）

### 🔴 Critical（即座に実施）

1. **設定ファイルの確認と修正**
   - [ ] `appsettings.Development.json` に `Shopify:TestMode: true` を設定
   - [ ] `appsettings.Production.json` に `Shopify:TestMode: false` を設定
   - **推定時間**: 30分
   - **担当**: 開発者

2. **実装コードの詳細確認**
   - [ ] `ShopifySubscriptionService.cs` の確認
   - [ ] `WebhookController.cs` の確認
   - [ ] `BillingController.cs` の確認
   - **推定時間**: 1時間
   - **担当**: 開発者

### 🟡 High（1週間以内に実施）

3. **新規サブスクリプション作成テスト**
   - **推定時間**: 2時間
   - **担当**: テスト担当者

4. **プラン変更テスト**
   - **推定時間**: 1.5時間
   - **担当**: テスト担当者

5. **サブスクリプションキャンセルテスト**
   - **推定時間**: 1.5時間
   - **担当**: テスト担当者

6. **Rate Limitエラーのテスト**
   - **推定時間**: 2時間
   - **担当**: テスト担当者

7. **Webhook署名検証エラーのテスト**
   - **推定時間**: 1時間
   - **担当**: テスト担当者

8. **エンドツーエンドテスト**
   - **推定時間**: 3時間
   - **担当**: テスト担当者

### 🟢 Medium（テスト完了後に実施）

9. **ドキュメントの更新**
   - [ ] テスト結果レポートの作成
   - [ ] 既存ドキュメントの更新
   - [ ] 不具合レポートの作成（該当する場合）
   - **推定時間**: 2-4時間
   - **担当**: テスト担当者 / 開発者

---

## 🎯 進捗管理

### 進捗状況

| タスク | 状態 | 担当 | 開始日 | 完了日 | 備考 |
|--------|------|------|--------|--------|------|
| 設定ファイルの確認と修正 | ⏳ 未着手 | - | - | - | - |
| 実装コードの詳細確認 | ⏳ 未着手 | - | - | - | - |
| 新規サブスクリプション作成テスト | ⏳ 未着手 | - | - | - | - |
| プラン変更テスト | ⏳ 未着手 | - | - | - | - |
| サブスクリプションキャンセルテスト | ⏳ 未着手 | - | - | - | - |
| Rate Limitエラーのテスト | ⏳ 未着手 | - | - | - | - |
| Webhook署名検証エラーのテスト | ⏳ 未着手 | - | - | - | - |
| エンドツーエンドテスト | ⏳ 未着手 | - | - | - | - |
| ドキュメントの更新 | ⏳ 未着手 | - | - | - | - |

### 進捗更新方法

各タスク完了時に以下を更新:
- 状態を「完了」に変更
- 完了日を記録
- 備考に結果や課題を記録

---

## 📚 参考資料

### Shopify公式ドキュメント

1. **App Subscription API**
   - [GraphQL Admin API - appSubscriptionCreate](https://shopify.dev/docs/api/admin-graphql/latest/mutations/appSubscriptionCreate)
   - [App Subscriptions](https://shopify.dev/docs/apps/launch/billing/app-subscriptions)

2. **テスト方法**
   - [Pass app review - Test your app's billing system](https://shopify.dev/docs/apps/launch/app-store-review/pass-app-review#test-your-apps-billing-system)

### 内部ドキュメント

1. **テスト方法まとめ**
   - `docs/08-shopify/02-課金システム/03-実装管理/Shopify公式ドキュメント準拠-テスト方法まとめ-2026-01-14.md`

2. **実装状況**
   - `docs/00-production-release/04-billing-system/実装状況サマリー-2026-01-07.md`
   - `docs/00-production-release/04-billing-system/課金システムテストタスクリスト-2026-01-07.md`

3. **既存テスト手順**
   - `docs/08-shopify/02-課金システム/04-理解と運用/課金0円テスト完全手順書.md`
   - `docs/08-shopify/02-課金システム/03-実装管理/テスト手順書-課金と無料プラン.md`

---

**最終更新**: 2026-01-14  
**次回更新予定**: テスト実施後、進捗を反映
