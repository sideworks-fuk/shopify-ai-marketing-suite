# 仕様書レビュー: /install ページ アクセス制御仕様書

**レビュー日**: 2025-12-31
**レビュアー**: AI Assistant
**対象仕様書**: `/install ページ アクセス制御仕様書`

---

## ✅ 良い点

1. **明確な目的と背景**: 不正なインストール経路の防止とShopify審査基準への準拠という目的が明確
2. **詳細なフロー図**: 正規/非正規のアクセス経路が視覚的に理解しやすい
3. **セキュリティ考慮事項**: クライアントサイド制御の限界について適切に言及
4. **テスト計画**: テストケースが網羅的
5. **ロールバック計画**: 問題発生時の対応が明確

---

## ⚠️ 修正が必要な点

### 1. 環境変数の値（重要）

**問題**: 仕様書で `Development` と `development` が混在している

**修正箇所**:
- セクション3.1: `isDevelopment = environment === 'development' || environment === 'Development'`
- セクション6.1: 環境定義表

**修正内容**:
```typescript
// ❌ 誤り
const isDevelopment = environment === 'development' || environment === 'Development';

// ✅ 正しい（既存コードに合わせる）
const isDevelopment = environment === 'development';
```

**理由**: 既存コード（`frontend/src/lib/config/environments.ts`）では、環境変数の値は全て小文字（`development`, `staging`, `production`）で定義されている。

---

### 2. 環境判定方法（重要）

**問題**: 直接 `process.env.NEXT_PUBLIC_ENVIRONMENT` を使用しているが、既存の `getCurrentEnvironment()` 関数を使用すべき

**修正箇所**: セクション3.3、5.2

**修正内容**:
```typescript
// ❌ 仕様書のコード
const environment = process.env.NEXT_PUBLIC_ENVIRONMENT;
const isDevelopment = environment === 'development';

// ✅ 既存コードに合わせる
import { getCurrentEnvironment } from '@/lib/config/environments';
const environment = getCurrentEnvironment();
const isDevelopment = environment === 'development';
```

**理由**: 
- 既存コードで `getCurrentEnvironment()` が実装されており、環境判定のロジックが集約されている
- フォールバック処理やデバッグログが含まれている
- 一貫性を保つため

---

### 3. 既存の状態変数との整合性（重要）

**問題**: 既存コードに `isDirectAccess` という状態変数が既に存在しているが、仕様書では新しく `shouldBlockManualInput` を定義している

**修正箇所**: セクション5.2

**修正内容**:
```typescript
// 既存の状態変数を活用
const [isDirectAccess, setIsDirectAccess] = useState<boolean>(false); // 既存

// 判定ロジック（既存のisDirectAccessを活用）
const hasShopParam = searchParams.get('shop') !== null;
const isDevelopment = getCurrentEnvironment() === 'development';
const isLegitimateAccess = isEmbedded || hasShopParam || isDevelopment;

// 既存のisDirectAccessと統合
const shouldBlockManualInput = !isLegitimateAccess && !isDevelopment;
```

**理由**: 
- 既存コード（`frontend/src/app/install/page.tsx` 54行目）で `isDirectAccess` が既に定義されている
- 重複を避け、既存コードとの整合性を保つ

---

### 4. Polaris Bannerコンポーネントの使い方

**問題**: 仕様書のコード例で `Box` と `Button` の使い方が不正確

**修正箇所**: セクション5.3.1

**修正内容**:
```tsx
// ❌ 仕様書のコード（不正確）
<Banner
  title="Shopify App Storeからインストールしてください"
  tone="warning"
>
  <p>
    このアプリは直接アクセスからのインストールには対応していません。
    Shopify App Storeからインストールしてください。
  </p>
  <Box paddingBlockStart="300">
    <Button
      url={APP_STORE_URL}
      external
    >
      App Storeでインストール
    </Button>
  </Box>
</Banner>

// ✅ 正しい（既存コードのパターンに合わせる）
<Banner
  title="Shopify App Storeからインストールしてください"
  tone="warning"
>
  <Text>
    このアプリは直接アクセスからのインストールには対応していません。
    Shopify App Storeからインストールしてください。
  </Text>
  <Box paddingBlockStart="400">
    <Button
      url={APP_STORE_URL}
      external
    >
      App Storeでインストール
    </Button>
  </Box>
</Banner>
```

**理由**: 
- 既存コード（`frontend/src/app/install/page.tsx` 1206-1218行目）では `Text` コンポーネントと `paddingBlockStart="400"` を使用
- Polarisの推奨パターンに合わせる

---

### 5. App Store URL定数の定義場所

**問題**: App Store URLの定義場所が不明確

**修正箇所**: セクション5.4

**修正内容**:
```typescript
// 推奨: 定数ファイルを作成
// frontend/src/constants/shopify.ts
export const SHOPIFY_APP_STORE_URL = 'https://apps.shopify.com/ec-ranger'; // TODO: 実際のApp Store URLに置換

// または、環境変数として定義
// NEXT_PUBLIC_SHOPIFY_APP_STORE_URL=https://apps.shopify.com/ec-ranger
```

**理由**: 
- 環境変数として定義することで、環境ごとに異なるURLを設定可能
- 定数ファイルに集約することで、管理が容易

---

### 6. 判定フロー図の修正

**問題**: 判定フロー図で「開発環境」の判定が最後になっているが、実装では `isLegitimateAccess` の条件に含まれる

**修正箇所**: セクション3.2

**修正内容**: フロー図を以下のように修正

```
                    ┌─────────────────┐
                    │  /install アクセス │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ isEmbedded?     │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ YES                         │ NO
              ▼                             ▼
       ┌──────────┐                ┌────────────────┐
       │ ✅ 許可   │                │ shop パラメータ? │
       └──────────┘                └────────┬───────┘
                                            │
                             ┌──────────────┴──────────────┐
                             │ YES                         │ NO
                             ▼                             ▼
                      ┌──────────┐                ┌────────────────┐
                      │ ✅ 許可   │                │ 開発環境?       │
                      └──────────┘                └────────┬───────┘
                                                           │
                                            ┌──────────────┴──────────────┐
                                            │ YES                         │ NO
                                            ▼                             ▼
                                     ┌──────────┐                  ┌──────────┐
                                     │ ✅ 許可   │                  │ ❌ ブロック │
                                     └──────────┘                  └──────────┘
```

**理由**: フロー図は実装ロジックと一致させる必要がある

---

### 7. テストケースの追加

**問題**: ステージング環境のテストケースが不足

**修正箇所**: セクション7.1

**追加するテストケース**:

| # | 環境 | 条件 | 期待結果 |
|---|------|------|---------|
| 7 | ステージング | 直接アクセス（パラメータなし） | ❌ ボタン無効、警告表示 |
| 8 | ステージング | `shop`パラメータあり | ✅ ボタン有効、自動リダイレクト |
| 9 | ステージング | 埋め込みモード | ✅ ボタン有効 |

---

### 8. 既存コードとの統合方法

**問題**: 既存の `autoRedirecting` などの状態変数との統合方法が不明確

**修正箇所**: セクション5.3.3

**修正内容**:
```typescript
// 既存のdisabled条件に追加
<Button
  variant="primary"
  size="large"
  fullWidth
  onClick={handleInstall}
  loading={loading}
  disabled={
    !shopDomain.trim() || 
    autoRedirecting || 
    shouldBlockManualInput  // 追加
  }
>
  {loading ? '接続中...' : '接続を開始'}
</Button>
```

**理由**: 既存の `autoRedirecting` などの状態変数との整合性を保つ

---

## 📝 追加検討事項

### 1. カスタムアプリの考慮

**質問**: カスタムアプリの場合、直接アクセスを許可する必要があるか？

**推奨**: 仕様書に以下を追加

```markdown
### カスタムアプリの考慮

カスタムアプリの場合、直接アクセスが必要なケースがあるため、
アプリタイプ（Public/Custom）を判定して制御を分岐することを検討。

```typescript
// アプリタイプを取得（環境変数またはAPIから）
const appType = process.env.NEXT_PUBLIC_SHOPIFY_APP_TYPE || 'Public';
const shouldBlockManualInput = 
  !isLegitimateAccess && 
  !isDevelopment && 
  appType === 'Public'; // カスタムアプリは許可
```
```

---

### 2. ログ記録

**推奨**: 非正規アクセスを検出した場合、ログを記録する

```typescript
useEffect(() => {
  if (shouldBlockManualInput) {
    console.warn('⚠️ [Install] Non-standard access detected:', {
      isEmbedded,
      hasShopParam,
      environment: getCurrentEnvironment(),
      url: window.location.href,
      timestamp: new Date().toISOString()
    });
    
    // 必要に応じて、バックエンドにログを送信
    // fetch('/api/logs', { method: 'POST', body: JSON.stringify({...}) });
  }
}, [shouldBlockManualInput]);
```

---

### 3. エラーメッセージの多言語対応

**推奨**: 将来的な多言語対応を考慮

```typescript
// 将来的に多言語対応する場合
const messages = {
  warning: {
    title: 'Shopify App Storeからインストールしてください',
    message: 'このアプリは直接アクセスからのインストールには対応していません。',
    button: 'App Storeでインストール'
  }
};
```

---

## ✅ 承認条件

以下の条件を満たした場合、仕様書を承認可能：

1. [ ] 環境変数の値を小文字に統一
2. [ ] `getCurrentEnvironment()` を使用するように修正
3. [ ] 既存の `isDirectAccess` 状態変数との統合方法を明確化
4. [ ] Polaris Bannerコンポーネントの使い方を修正
5. [ ] App Store URLの定義場所を明確化
6. [ ] 判定フロー図を実装ロジックと一致させる
7. [ ] ステージング環境のテストケースを追加
8. [ ] 既存コードとの統合方法を明確化

---

## 📋 次のステップ

1. **仕様書の修正**: 上記の指摘事項を反映
2. **実装前レビュー**: 修正後の仕様書を再レビュー
3. **実装**: 修正後の仕様書に基づいて実装
4. **テスト**: セクション7のテスト計画に基づいてテスト実施
5. **ドキュメント更新**: 実装完了後、関連ドキュメントを更新

---

## 参考資料

- [既存コード: frontend/src/app/install/page.tsx](../../../frontend/src/app/install/page.tsx)
- [既存コード: frontend/src/lib/config/environments.ts](../../../frontend/src/lib/config/environments.ts)
- [既存コード: frontend/src/hooks/useIsEmbedded.ts](../../../frontend/src/hooks/useIsEmbedded.ts)
- [Shopify Polaris Banner Documentation](https://polaris.shopify.com/components/banner)

---

**レビュー完了日**: 2025-12-31
**次回レビュー予定**: 仕様書修正後
