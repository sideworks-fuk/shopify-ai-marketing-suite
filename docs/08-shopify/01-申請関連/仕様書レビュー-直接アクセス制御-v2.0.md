# 仕様書レビュー: /install ページ アクセス制御仕様書 v2.0（最終レビュー）

**レビュー日**: 2025-12-31
**レビュアー**: AI Assistant
**対象仕様書**: `/install ページ アクセス制御仕様書 v2.0`
**レビュー種別**: 最終レビュー（修正版）

---

## ✅ レビュー指摘事項の反映状況

| # | 指摘事項 | 反映状況 | 確認結果 |
|---|---------|---------|---------|
| 1 | 環境変数の値を小文字に統一 | ✅ 反映済み | セクション3.3、6.1で `development` に統一 |
| 2 | `getCurrentEnvironment()` を使用 | ✅ 反映済み | セクション3.3、5.3、6.3で明記 |
| 3 | 既存の`isDirectAccess`との整合性 | ✅ 反映済み | セクション5.3、10.3で明記 |
| 4 | Polaris Bannerの使い方 | ✅ 反映済み | セクション5.4で `Text` と `paddingBlockStart="400"` を使用 |
| 5 | App Store URL定数の定義場所 | ✅ 反映済み | セクション5.2で `constants/shopify.ts` を新規作成 |
| 6 | 判定フロー図の修正 | ✅ 反映済み | セクション3.2で `isLegitimateAccess` 一括判定に変更 |
| 7 | ステージング環境のテストケース | ✅ 反映済み | セクション8.1でテストケース4-6を追加 |
| 8 | 既存コードとの統合方法 | ✅ 反映済み | セクション10.3で明記 |

---

## ✅ 追加検討事項の反映状況

| # | 検討事項 | 反映状況 | 確認結果 |
|---|---------|---------|---------|
| 1 | カスタムアプリの考慮 | ✅ 反映済み | セクション7で `SHOPIFY_APP_TYPE` による分岐を追加 |
| 2 | ログ記録 | ✅ 反映済み | セクション5.7で非正規アクセス検出時のログ記録を追加 |
| 3 | 多言語対応 | ✅ 反映済み | セクション11.1で将来の拡張性を考慮した構造を追加 |

---

## ✅ 最終レビュー結果

### 承認可能

修正版仕様書（v2.0）は、**すべてのレビュー指摘事項と追加検討事項が適切に反映**されており、**実装開始可能**な状態です。

---

## 📋 実装前の最終確認事項

### 1. 新規ファイルの作成

- [ ] `frontend/src/constants/shopify.ts` を作成
  - `SHOPIFY_APP_STORE_URL` を定義（実際のApp Store URLに置換）
  - `SHOPIFY_APP_TYPE` を定義（`'Public'` または `'Custom'`）

### 2. 既存ファイルの変更

- [ ] `frontend/src/app/install/page.tsx` を更新
  - セクション5.3の判定ロジックを追加
  - セクション5.4の警告バナーを追加
  - セクション5.5の入力フィールド無効化を追加
  - セクション5.6のボタン無効化を追加
  - セクション5.7のログ記録を追加

### 3. 環境変数の確認

- [ ] 各環境で `NEXT_PUBLIC_ENVIRONMENT` が正しく設定されていることを確認
  - 開発環境: `development`
  - ステージング環境: `staging`
  - 本番環境: `production`

---

## ⚠️ 実装時の注意事項

### 1. App Store URLの置換

**重要**: `SHOPIFY_APP_STORE_URL` は実際のApp Store URLに置換する必要があります。

```typescript
// frontend/src/constants/shopify.ts
export const SHOPIFY_APP_STORE_URL = 'https://apps.shopify.com/ec-ranger'; // TODO: 実際のURLに置換
```

**置換タイミング**: アプリがApp Storeに公開された後

---

### 2. アプリタイプの設定

**現在**: `SHOPIFY_APP_TYPE = 'Public'`（公開アプリ）

**カスタムアプリの場合**: `SHOPIFY_APP_TYPE = 'Custom'` に変更すると、直接アクセスが許可されます。

```typescript
// カスタムアプリの場合
export const SHOPIFY_APP_TYPE = 'Custom' as const;
```

---

### 3. 既存コードとの統合

**重要**: 既存の `isDirectAccess` 状態変数と `autoRedirecting` 状態変数との整合性を保つこと。

```typescript
// 既存の状態変数
const [isDirectAccess, setIsDirectAccess] = useState<boolean>(false);
const [autoRedirecting, setAutoRedirecting] = useState(false);

// 新規追加の判定
const shouldBlockManualInput = !isLegitimateAccess && SHOPIFY_APP_TYPE === 'Public';

// ボタンのdisabled条件（既存 + 新規）
disabled={
  !shopDomain.trim() ||      // 既存
  autoRedirecting ||         // 既存
  shouldBlockManualInput     // 新規追加
}
```

---

### 4. テストの実施

**必須**: セクション8のテスト計画に基づいて、すべてのテストケースを実施すること。

特に重要なテストケース：
- **テストケース4**: ステージング環境での直接アクセス（警告表示確認）
- **テストケース7**: 本番環境での直接アクセス（警告表示確認）
- **テストケース8**: 本番環境でのApp Store経由アクセス（正常動作確認）

---

## 📝 追加の推奨事項

### 1. エラーハンドリングの強化

非正規アクセス検出時に、バックエンドにログを送信することを検討：

```typescript
// オプション: バックエンドにログを送信
useEffect(() => {
  if (shouldBlockManualInput) {
    // バックエンドにログを送信（オプション）
    fetch('/api/logs/non-standard-access', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        isEmbedded,
        hasShopParam,
        environment: getCurrentEnvironment(),
        url: typeof window !== 'undefined' ? window.location.href : '',
        timestamp: new Date().toISOString()
      })
    }).catch(err => console.error('Failed to send log:', err));
  }
}, [shouldBlockManualInput]);
```

---

### 2. アクセシビリティの考慮

警告バナーのアクセシビリティを確保：

```tsx
<Banner
  title="Shopify App Storeからインストールしてください"
  tone="warning"
  role="alert"  // スクリーンリーダー用
  aria-live="polite"  // スクリーンリーダー用
>
  {/* ... */}
</Banner>
```

---

### 3. パフォーマンスの考慮

`useEffect` の依存配列を適切に設定：

```typescript
useEffect(() => {
  if (shouldBlockManualInput) {
    console.warn('⚠️ [Install] Non-standard access detected:', {
      isEmbedded,
      hasShopParam,
      environment: getCurrentEnvironment(),
      url: typeof window !== 'undefined' ? window.location.href : '',
      timestamp: new Date().toISOString()
    });
  }
}, [shouldBlockManualInput, isEmbedded, hasShopParam]); // 依存配列を適切に設定
```

---

## ✅ 承認チェックリスト（最終確認）

以下の条件をすべて満たしていることを確認：

- [x] 環境変数の値が小文字（`development`）に統一されている
- [x] `getCurrentEnvironment()` を使用している
- [x] 既存の `isDirectAccess` 状態変数との統合方法が明確
- [x] Polaris Bannerコンポーネントの使い方が既存パターンに準拠
- [x] App Store URLの定義場所（`constants/shopify.ts`）が明確
- [x] 判定フロー図が実装ロジックと一致
- [x] ステージング環境のテストケースが含まれている
- [x] 既存コードとの統合方法が明確
- [x] カスタムアプリの考慮が含まれている
- [x] ログ記録が実装されている
- [x] 多言語対応の将来拡張性が考慮されている

---

## 🎯 最終判定

### ✅ **承認**

修正版仕様書（v2.0）は、すべてのレビュー指摘事項と追加検討事項が適切に反映されており、**実装開始可能**です。

---

## 📋 次のステップ

1. **実装開始**: 修正版仕様書（v2.0）に基づいて実装を開始
2. **テスト実施**: セクション8のテスト計画に基づいてテストを実施
3. **ドキュメント更新**: 実装完了後、関連ドキュメントを更新
4. **本番デプロイ**: テスト完了後、本番環境にデプロイ

---

## 参考資料

- [修正版仕様書 v2.0](./仕様書-直接アクセス制御-v2.0.md)（ユーザーが作成）
- [初回レビュー結果](./仕様書レビュー-直接アクセス制御.md)
- [既存コード: frontend/src/app/install/page.tsx](../../../frontend/src/app/install/page.tsx)
- [既存コード: frontend/src/lib/config/environments.ts](../../../frontend/src/lib/config/environments.ts)
- [既存コード: frontend/src/hooks/useIsEmbedded.ts](../../../frontend/src/hooks/useIsEmbedded.ts)

---

**レビュー完了日**: 2025-12-31
**承認状態**: ✅ **承認済み**
**実装開始可能**: ✅ **はい**
