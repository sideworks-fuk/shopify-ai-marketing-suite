# .env.local 環境変数使用状況調査

## 作業情報
- 開始日時: 2025-12-29
- 完了日時: 2025-12-29
- 担当: 福田＋AI Assistant

## 作業概要
`.env.local`ファイルの以下の環境変数が実際に使用されているかを調査：
- `NEXT_PUBLIC_SHOPIFY_APP_URL`
- `NEXT_PUBLIC_SHOPIFY_API_KEY`

---

## ✅ `NEXT_PUBLIC_SHOPIFY_APP_URL` の使用状況

### 使用箇所

#### 1. フロントエンドコールバックプロキシ

**ファイル**: `frontend/src/app/api/shopify/callback/route.ts`

**使用箇所**: `getFrontendUrl()` 関数 (line 65-88)

```typescript
function getFrontendUrl(request: NextRequest): string {
  // 優先順位:
  // 1. 環境変数 NEXT_PUBLIC_SHOPIFY_APP_URL
  // 2. 環境変数 NEXT_PUBLIC_FRONTEND_URL
  // 3. リクエストヘッダーから取得
  const appUrl = process.env.NEXT_PUBLIC_SHOPIFY_APP_URL || 
                 process.env.NEXT_PUBLIC_FRONTEND_URL;
  
  if (appUrl) {
    return appUrl;
  }
  
  // リクエストヘッダーから取得
  const xForwardedHost = request.headers.get('x-forwarded-host');
  const xForwardedProto = request.headers.get('x-forwarded-proto') || 'https';
  const host = xForwardedHost || request.headers.get('host');
  
  if (host) {
    return `${xForwardedProto}://${host}`;
  }
  
  // 最終フォールバック
  return 'http://localhost:3000';
}
```

**用途**: 
- OAuthコールバック処理後のリダイレクトURL生成
- エラーページへのリダイレクトURL生成
- 成功ページへのリダイレクトURL生成

**優先順位**: **1位**（最優先）

**結論**: ✅ **使用されている（重要）**

---

## ✅ `NEXT_PUBLIC_SHOPIFY_API_KEY` の使用状況

### 使用箇所

#### 1. App Bridge Provider

**ファイル**: `frontend/src/lib/shopify/app-bridge-provider.tsx`

**使用箇所**: line 50

```typescript
const apiKey = useMemo(() => process.env.NEXT_PUBLIC_SHOPIFY_API_KEY || '', [])
```

**用途**: 
- Shopify App Bridgeの初期化
- 埋め込みアプリとして動作する際のAPI Key設定

**結論**: ✅ **使用されている（重要）**

#### 2. App Bridge Provider (旧実装)

**ファイル**: `frontend/src/providers/AppBridgeProvider.tsx`

**使用箇所**: line 33

```typescript
apiKey: process.env.NEXT_PUBLIC_SHOPIFY_API_KEY || '',
```

**用途**: 
- App Bridge初期化（旧実装）

**結論**: ✅ **使用されている（旧実装）**

#### 3. インストールページ

**ファイル**: `frontend/src/app/install/page.tsx`

**使用箇所**: line 294

```typescript
// API Keyを環境変数から取得（マルチアプリ対応）
const apiKey = process.env.NEXT_PUBLIC_SHOPIFY_API_KEY;

// API Keyが設定されている場合は追加
if (apiKey) {
  installParams.append('apiKey', apiKey);
}
```

**用途**: 
- OAuthインストール時にバックエンドにAPI Keyを送信
- マルチアプリ対応（複数のShopifyアプリを管理する場合）

**結論**: ✅ **使用されている（重要）**

#### 4. 認証成功ページ

**ファイル**: `frontend/src/app/auth/success/page.tsx`

**使用箇所**: line 254

```typescript
const apiKey = process.env.NEXT_PUBLIC_SHOPIFY_API_KEY;
if (typeof window !== 'undefined' && host && resolvedShop && apiKey) {
  const isTopWindow = window.top === window.self;
  if (isTopWindow) {
    const adminAppUrl = `https://${resolvedShop}/admin/apps/${apiKey}?host=${encodeURIComponent(host)}`;
    console.log('🔄 Shopify管理画面にリダイレクト:', adminAppUrl);
    // ...
  }
}
```

**用途**: 
- 認証成功後、Shopify管理画面へのリダイレクトURL生成

**結論**: ✅ **使用されている**

#### 5. 認証エラーコンポーネント

**ファイル**: `frontend/src/components/errors/AuthenticationRequired.tsx`

**使用箇所**: line 57

```typescript
const apiKey = process.env.NEXT_PUBLIC_SHOPIFY_API_KEY
```

**用途**: 
- 認証エラー時の処理

**結論**: ✅ **使用されている**

#### 6. 設定検証

**ファイル**: `frontend/src/lib/config/validation.ts`

**使用箇所**: line 57

```typescript
const shopifyApiKey = process.env.NEXT_PUBLIC_SHOPIFY_API_KEY;
if (!shopifyApiKey) {
  warnings.push('SHOPIFY_API_KEY is not configured. This may be required for Shopify App Bridge.');
}
```

**用途**: 
- 環境設定の検証（警告のみ）

**結論**: ✅ **使用されている（検証用）**

---

## 📊 使用状況まとめ

### `NEXT_PUBLIC_SHOPIFY_APP_URL`

| ファイル | 使用箇所 | 用途 | 重要度 |
|---------|---------|------|--------|
| `frontend/src/app/api/shopify/callback/route.ts` | `getFrontendUrl()` | フロントエンドURL取得（最優先） | ⭐⭐⭐ 必須 |

**結論**: ✅ **使用されている（必須）**

**用途**:
- OAuthコールバック処理後のリダイレクトURL生成
- エラーページへのリダイレクトURL生成
- 成功ページへのリダイレクトURL生成

**フォールバック**:
- `NEXT_PUBLIC_FRONTEND_URL`（2位）
- リクエストヘッダーから取得（3位）
- `http://localhost:3000`（最終フォールバック）

---

### `NEXT_PUBLIC_SHOPIFY_API_KEY`

| ファイル | 使用箇所 | 用途 | 重要度 |
|---------|---------|------|--------|
| `frontend/src/lib/shopify/app-bridge-provider.tsx` | line 50 | App Bridge初期化 | ⭐⭐⭐ 必須 |
| `frontend/src/providers/AppBridgeProvider.tsx` | line 33 | App Bridge初期化（旧実装） | ⭐⭐ 重要 |
| `frontend/src/app/install/page.tsx` | line 294 | OAuthインストール時のAPI Key送信 | ⭐⭐⭐ 必須 |
| `frontend/src/app/auth/success/page.tsx` | line 254 | 認証成功後のShopify管理画面リダイレクト | ⭐⭐ 重要 |
| `frontend/src/components/errors/AuthenticationRequired.tsx` | line 57 | 認証エラー時の処理 | ⭐⭐ 重要 |
| `frontend/src/lib/config/validation.ts` | line 57 | 環境設定検証（警告のみ） | ⭐ 参考 |

**結論**: ✅ **使用されている（必須）**

**用途**:
- Shopify App Bridgeの初期化（埋め込みアプリとして動作する場合）
- OAuthインストール時にバックエンドに送信（マルチアプリ対応）
- 認証成功後のShopify管理画面へのリダイレクトURL生成
- 認証エラー時の処理

**フォールバック**:
- 空文字列（`''`）がデフォルト値として使用される場合がある

---

## ✅ 結論

### `NEXT_PUBLIC_SHOPIFY_APP_URL`

- ✅ **使用されている（必須）**
- **用途**: OAuthコールバック処理後のリダイレクトURL生成
- **優先順位**: 最優先（1位）
- **フォールバック**: `NEXT_PUBLIC_FRONTEND_URL` → リクエストヘッダー → `http://localhost:3000`

### `NEXT_PUBLIC_SHOPIFY_API_KEY`

- ✅ **使用されている（必須）**
- **用途**: 
  - App Bridge初期化（埋め込みアプリとして動作する場合）
  - OAuthインストール時のAPI Key送信（マルチアプリ対応）
  - 認証成功後のShopify管理画面へのリダイレクトURL生成
  - 認証エラー時の処理
- **使用箇所**: 6箇所
- **重要度**: 必須

---

## 📚 関連ドキュメント

- [ngrok-コールバックプロキシ実装](../05-development/01-環境構築/ngrok-コールバックプロキシ実装.md)
- [ngrok-ローカルテスト設定手順](../05-development/01-環境構築/ngrok-ローカルテスト設定手順.md)
- [env.sample](../../frontend/env.sample)
