# ngrok ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆè¨­å®šå®Œäº†

## ä½œæ¥­æƒ…å ±
- é–‹å§‹æ—¥æ™‚: 2025-12-29
- å®Œäº†æ—¥æ™‚: 2025-12-29
- æ‹…å½“: ç¦ç”°ï¼‹AI Assistant

## ä½œæ¥­æ¦‚è¦
ngrokã‚’ä½¿ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®Shopify OAuthèªè¨¼ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®è¨­å®šã‚’å®Œäº†ã€‚

---

## âœ… å®Œäº†ã—ãŸè¨­å®šé …ç›®

### 1. ngrokãƒˆãƒ³ãƒãƒ«ã®èµ·å‹• âœ…

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ngrokãƒˆãƒ³ãƒãƒ«**: èµ·å‹•æ¸ˆã¿
- **URL**: `https://unsavagely-repressive-terrance.ngrok-free.dev`
- **ãƒãƒ¼ãƒˆ**: 3000ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
- **æ³¨æ„**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ngrokãƒˆãƒ³ãƒãƒ«ã¯ä¸è¦ï¼ˆ`localhost:7088`ã§ç›´æ¥æ¥ç¶šï¼‰

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã®è¨­å®š âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/.env.local`

è¨­å®šå†…å®¹ï¼š
```env
NEXT_PUBLIC_API_URL=https://localhost:7088
NEXT_PUBLIC_SHOPIFY_APP_URL=https://unsavagely-repressive-terrance.ngrok-free.dev
NEXT_PUBLIC_SHOPIFY_API_KEY=2d7e0e1f5da14eb9d299aa746738e44b
NEXT_PUBLIC_ENVIRONMENT=development
NEXT_PUBLIC_USE_HTTPS=true
NEXT_PUBLIC_DISABLE_FEATURE_GATES=true
```

### 3. `ShopifyApps`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`AppUrl`ã‚’æ›´æ–° âœ…

**æ›´æ–°å†…å®¹**:
- **Id**: 6
- **AppUrl**: `https://unsavagely-repressive-terrance.ngrok-free.dev`
- **RedirectUri**: `https://unsavagely-repressive-terrance.ngrok-free.dev/api/shopify/callback`

**å®Ÿè¡ŒSQL**:
```sql
UPDATE [dbo].[ShopifyApps]
SET 
    [AppUrl] = 'https://unsavagely-repressive-terrance.ngrok-free.dev',
    [RedirectUri] = 'https://unsavagely-repressive-terrance.ngrok-free.dev/api/shopify/callback',
    [UpdatedAt] = GETUTCDATE()
WHERE [Id] = 6
  AND [ApiKey] = '706a757915dedce54806c0a179bee05d'
  AND [IsActive] = 1;
```

### 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šï¼ˆAllowedOriginsï¼‰ âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/appsettings.Development.json`

**è¨­å®šå†…å®¹**:
```json
{
  "Cors": {
    "AllowedOrigins": [
      "http://localhost:3000",
      "https://unsavagely-repressive-terrance.ngrok-free.dev",
      "https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net",
      "https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net",
      "https://brave-sea-038f17a00.1.azurestaticapps.net"
    ]
  }
}
```

**ç¢ºèª**: âœ… ngrok URLãŒè¿½åŠ æ¸ˆã¿

### 5. Shopify Partners Dashboardã®è¨­å®š âœ…

**è¨­å®šå†…å®¹**:
- **App URL**: `https://unsavagely-repressive-terrance.ngrok-free.dev`
- **Allowed redirection URL(s)**:
  1. `https://unsavagely-repressive-terrance.ngrok-free.dev/api/shopify/callback`
  2. `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
  3. `https://unsavagely-repressive-terrance.ngrok-free.dev/auth/success`ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### 6. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šï¼ˆUseFrontendProxyï¼‰ âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/appsettings.LocalDevelopment.json`

**è¨­å®šå†…å®¹**:
```json
{
  "Shopify": {
    "UseFrontendProxy": true
  },
  "Cors": {
    "AllowedOrigins": [
      "https://unsavagely-repressive-terrance.ngrok-free.dev",
      ...
    ]
  }
}
```

**ç¢ºèª**: âœ… è¨­å®šæ¸ˆã¿

**æ³¨æ„**: 
- `launchSettings.json`ã§`ASPNETCORE_ENVIRONMENT=LocalDevelopment`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`appsettings.LocalDevelopment.json`ãŒä½¿ç”¨ã•ã‚Œã¾ã™
- `Cors:AllowedOrigins`ã«ã‚‚ç¾åœ¨ã®ngrok URLã‚’è¿½åŠ æ¸ˆã¿
- **é‡è¦**: `Frontend:BaseUrl`ã¯è¨­å®šä¸è¦ã§ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLã¯`ShopifyApps`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`AppUrl`ã‹ã‚‰è‡ªå‹•çš„ã«å–å¾—ã•ã‚Œã¾ã™

---

## âœ… ã™ã¹ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ

ã™ã¹ã¦ã®è¨­å®šé …ç›®ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã¯OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ‰‹é †

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•

```powershell
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
cd backend/ShopifyAnalyticsApi
dotnet run
```

**æ³¨æ„**: 
- `launchSettings.json`ã§`ASPNETCORE_ENVIRONMENT=LocalDevelopment`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`appsettings.LocalDevelopment.json`ãŒè‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™
- ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã¯ä¸è¦ã§ã™

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®èµ·å‹•

```powershell
# åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ
cd frontend
npm run dev
```

### 3. OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `https://unsavagely-repressive-terrance.ngrok-free.dev/install?shop=your-dev-store.myshopify.com` ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œæ¥ç¶šã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. Shopify OAuthèªè¨¼ç”»é¢ã§æ¨©é™ã‚’æ‰¿èª
4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®`/api/shopify/callback`ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®`/api/shopify/callback`ã«ãƒ—ãƒ­ã‚­ã‚·è»¢é€ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ­ã‚°ã§ç¢ºèªï¼‰
6. `/auth/success`ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
7. `/setup/initial`ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°**:
```
ğŸ” [CallbackProxy] Shopify OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å—ä¿¡: { shop: 'xxx.myshopify.com', ... }
ğŸ“¤ [CallbackProxy] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸è»¢é€: { url: 'https://localhost:7088/api/shopify/callback', ... }
ğŸ“¡ [CallbackProxy] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¿œç­”: { status: 302, location: '/auth/success?shop=xxx&storeId=xxx&success=true' }
â†ªï¸ [CallbackProxy] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: /auth/success?shop=xxx&storeId=xxx&success=true
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°**:
```
Redirect URI generated (frontend proxy): FrontendUrl=https://unsavagely-repressive-terrance.ngrok-free.dev, RedirectUri=https://unsavagely-repressive-terrance.ngrok-free.dev/api/shopify/callback
OAuth callback processing started. Shop: xxx.myshopify.com
Built embedded app URL (direct to /auth/success): https://unsavagely-repressive-terrance.ngrok-free.dev/auth/success?shop=xxx&storeId=xxx&success=true
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

**Storesãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª**:
```sql
SELECT TOP 10 
    [Id],
    [Domain],
    [ShopifyShopId],
    [AccessToken],
    [CreatedAt],
    [UpdatedAt]
FROM [dbo].[Stores]
ORDER BY [CreatedAt] DESC;
```

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

**ç—‡çŠ¶**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã«ã€ŒRedirect URI generated (backend direct)ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **: 
- `appsettings.LocalDevelopment.json`ã®`Shopify:UseFrontendProxy`ãŒ`false`
- `ShopifyApps`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`AppUrl`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯`IsActive`ãŒ`false`

**è§£æ±ºæ–¹æ³•**:
1. `appsettings.LocalDevelopment.json`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
```json
{
  "Shopify": {
    "UseFrontendProxy": true
  }
}
```

2. `ShopifyApps`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`AppUrl`ã‚’ç¢ºèªãƒ»æ›´æ–°ï¼š
```sql
UPDATE [dbo].[ShopifyApps]
SET 
    [AppUrl] = 'https://unsavagely-repressive-terrance.ngrok-free.dev',
    [RedirectUri] = 'https://unsavagely-repressive-terrance.ngrok-free.dev/api/shopify/callback',
    [UpdatedAt] = GETUTCDATE()
WHERE [Id] = 6
  AND [ApiKey] = '706a757915dedce54806c0a179bee05d'
  AND [IsActive] = 1;
```

**ç¢ºèª**: âœ… æ—¢ã«è¨­å®šæ¸ˆã¿

### å•é¡Œ2: CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**ç—‡çŠ¶**: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«CORSã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **: `appsettings.Development.json`ã®`Cors:AllowedOrigins`ã«ngrok URLãŒå«ã¾ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**: âœ… æ—¢ã«è¿½åŠ æ¸ˆã¿ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

### å•é¡Œ3: Invalid callback URL ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: Shopify OAuthèªè¨¼ç”»é¢ã§ã€ŒInvalid callback URLã€ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**åŸå› **: Shopify Partners Dashboardã®Allowed redirection URLsã«ngrok URLãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**: âœ… æ—¢ã«è¨­å®šæ¸ˆã¿ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

### å•é¡Œ4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·ãŒå‹•ä½œã—ãªã„

**ç—‡çŠ¶**: `/api/shopify/callback`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

**åŸå› **: `frontend/src/app/api/shopify/callback/route.ts`ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**: 
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèª
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®æ¥ç¶šãŒæˆåŠŸã—ã¦ã„ã‚‹ã‹ç¢ºèª

---

## âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•**: `dotnet run`ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
2. **ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š**: [OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼-ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](./2025-12-29-OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼-ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆ.md)ã‚’å‚ç…§ã—ã¦ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
3. **OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ**: ä¸Šè¨˜ã®ãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’å®Ÿè¡Œ
4. **ãƒ­ã‚°ç¢ºèª**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèª
5. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª**: `Stores`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

**æ³¨æ„**: ã™ã¹ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•ã—ã¦ã™ãã«ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚

**ãƒ‡ãƒãƒƒã‚°æ¨å¥¨**: åˆå›ãƒ†ã‚¹ãƒˆæ™‚ã¯ã€[ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](./2025-12-29-OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼-ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆ.md)ã®ã€Œæœ€å„ªå…ˆï¼ˆå¿…é ˆç¢ºèªï¼‰ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ngrok-ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…](../05-development/01-ç’°å¢ƒæ§‹ç¯‰/ngrok-ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£….md)
- [ngrok-ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆè¨­å®šæ‰‹é †](../05-development/01-ç’°å¢ƒæ§‹ç¯‰/ngrok-ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆè¨­å®šæ‰‹é †.md)
- [ngrok-ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ-SQLæ›´æ–°](../05-development/01-ç’°å¢ƒæ§‹ç¯‰/ngrok-ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ-SQLæ›´æ–°.md)
- [ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ©Ÿèƒ½è¨­è¨ˆæ›¸](../../03-feature-development/ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼æ”¹å–„æ©Ÿèƒ½/ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ©Ÿèƒ½è¨­è¨ˆæ›¸.md)

---

## ğŸ“ æ›´æ–°å±¥æ­´

- 2025-12-29: åˆç‰ˆä½œæˆ
  - å®Œäº†ã—ãŸè¨­å®šé …ç›®ã‚’è¨˜éŒ²
  - æ®‹ã‚Šã®è¨­å®šé …ç›®ã‚’æ˜ç¢ºåŒ–
  - ãƒ†ã‚¹ãƒˆæ‰‹é †ã¨ç¢ºèªãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
