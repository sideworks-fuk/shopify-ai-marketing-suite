# OAuth認証フロー デバッグポイントガイド

## 📋 概要

ngrokを使用したローカルテスト環境でのOAuth認証フローのデバッグポイントを整理しました。

## 🔍 デバッグポイント一覧

### フロントエンド

#### 1. `/install` ページ
**ファイル**: `frontend/src/app/install/page.tsx`

**ブレークポイント設定箇所**:
- OAuth URL取得前（`/api/shopify/install-url`呼び出し前）
- `ExitIframe`ページへのリダイレクト前

**確認項目**:
- `shop`パラメータが正しく取得できているか
- `apiKey`が正しく取得できているか（オプション）
- `ExitIframe`へのリダイレクトURLが正しく生成されているか

---

#### 2. `/auth/exit-iframe` ページ
**ファイル**: `frontend/src/app/auth/exit-iframe/page.tsx`

**ブレークポイント設定箇所**:
- `redirectUri`パラメータ取得後
- 外部URL判定後（`window.top.location.href`設定前）
- App Bridgeリダイレクト前（相対パスの場合）

**確認項目**:
- `redirectUri`が正しく取得できているか
- 外部URL判定が正しく動作しているか
- `window.top.location.href`が正しく設定されているか

---

#### 3. `/api/shopify/callback` (コールバックプロキシ)
**ファイル**: `frontend/src/app/api/shopify/callback/route.ts`

**ブレークポイント設定箇所**:
- **Line 90-116**: コールバック受信時（パラメータ取得後）
- **Line 118-133**: 必須パラメータ検証後
- **Line 148-162**: バックエンドURL取得後
- **Line 172-181**: バックエンド転送URL構築後
- **Line 197-201**: バックエンドAPI呼び出し前
- **Line 204-212**: バックエンド応答受信後
- **Line 215-221**: リダイレクトレスポンス処理時
- **Line 224-244**: 成功レスポンス処理時
- **Line 247-274**: エラーレスポンス処理時

**確認項目**:
- すべてのクエリパラメータ（`code`, `shop`, `state`, `hmac`, `host`など）が正しく取得できているか
- バックエンドURLが正しく取得できているか（`getBackendApiUrl()`）
- バックエンドへの転送URLが正しく構築されているか
- バックエンドからのレスポンスステータスコード
- リダイレクト先URLが正しく取得できているか

**重要**: このプロキシはngrok経由でShopifyから直接呼ばれるため、デバッグが困難な場合があります。ログを詳細に確認してください。

---

#### 4. `/auth/success` ページ
**ファイル**: `frontend/src/app/auth/success/page.tsx`

**ブレークポイント設定箇所**:
- **Line 26-43**: `useEffect`開始時（処理済みチェック後）
- **Line 45-48**: URLパラメータ取得後
- **Line 59-71**: `shop`パラメータ検証後
- **Line 77-96**: `handleAuthCallback`開始時
- **Line 98-120**: 認証コールバック情報取得後
- **Line 122-150**: API呼び出し前（`/api/store`）
- **Line 152-180**: API呼び出し後（ストア情報取得後）
- **Line 182-220**: 認証状態更新後
- **Line 222-250**: リダイレクト処理時

**確認項目**:
- `shop`, `storeId`, `success`パラメータが正しく取得できているか
- `hasProcessedRef`と`sessionStorage`の状態
- API呼び出しのレスポンス（ストア情報）
- `localStorage`への保存内容
- リダイレクト先URL

---

### バックエンド

#### 5. `/api/shopify/install` (OAuth URL生成)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**メソッド**: `GetInstallUrl()` → `BuildOAuthUrlAsync()`

**ブレークポイント設定箇所**:
- **Line 161-188**: `GetInstallUrl()`メソッド開始時
- **Line 193-200**: ショップドメイン検証後
- **Line 208-230**: API Key/Secret取得後
- **Line 232-237**: データベースから認証情報取得後
- **Line 245-248**: state生成後
- **Line 271**: `GetRedirectUriAsync()`呼び出し前
- **Line 233-237**: OAuth URL構築後

**確認項目**:
- `shop`パラメータが正しく取得できているか
- `apiKey`が正しく取得できているか
- `ShopifyApps`テーブルから正しく認証情報が取得できているか
- `state`が正しく生成されているか
- `redirectUri`が正しく生成されているか（**重要**: データベースから取得）
- 最終的なOAuth URLが正しく構築されているか

---

#### 6. `GetRedirectUriAsync()` (リダイレクトURI生成)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**メソッド**: `GetRedirectUriAsync(string? apiKey = null)`

**ブレークポイント設定箇所**:
- **Line 67-72**: メソッド開始時（`UseFrontendProxy`判定前）
- **Line 73**: `UseFrontendProxy`判定後
- **Line 78-91**: `apiKey`指定時のデータベース取得処理
- **Line 95-108**: デフォルトAppUrl取得処理（`apiKey`未指定時）
- **Line 111-120**: 環境変数からのフォールバック処理
- **Line 122-127**: フロントエンドプロキシURL生成後
- **Line 132-151**: バックエンドURL生成処理（フォールバック）

**確認項目**:
- `UseFrontendProxy`が`true`になっているか
- `apiKey`が正しく渡されているか
- `ShopifyApps`テーブルから`AppUrl`が正しく取得できているか
- 取得した`AppUrl`が`https://unsavagely-repressive-terrance.ngrok-free.dev`になっているか
- 最終的な`redirectUri`が`{AppUrl}/api/shopify/callback`になっているか

**重要**: このメソッドは今回の変更でデータベースから取得するように修正されました。必ず確認してください。

---

#### 7. `/api/shopify/callback` (OAuthコールバック処理)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**メソッド**: `Callback()`

**ブレークポイント設定箇所**:
- **Line 340-360**: メソッド開始時（パラメータ取得後）
- **Line 362-375**: state検証後
- **Line 377-390**: HMAC検証後
- **Line 395-405**: アクセストークン取得後
- **Line 408-414**: `ProcessOAuthSuccessAsync()`呼び出し前
- **Line 417**: セッションCookie設定前
- **Line 420-422**: `BuildRedirectUrlAsync()`呼び出し前
- **Line 424**: リダイレクト実行前

**確認項目**:
- すべてのクエリパラメータ（`code`, `shop`, `state`, `hmac`, `host`など）が正しく取得できているか
- `state`が正しく検証できているか
- HMAC検証が成功しているか
- アクセストークンが正しく取得できているか
- `ProcessOAuthSuccessAsync()`の戻り値（`storeId`）が正しく取得できているか
- `BuildRedirectUrlAsync()`の戻り値（リダイレクトURL）が正しく生成されているか
- リダイレクトURLに`storeId`が含まれているか

---

#### 8. `ProcessOAuthSuccessAsync()` (ストア保存・Webhook登録)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**メソッド**: `ProcessOAuthSuccessAsync()`

**ブレークポイント設定箇所**:
- **Line 1864-1870**: メソッド開始時（パラメータ受信後）
- **Line 1873-1879**: `apiSecret`検証・取得後
- **Line 1881-1885**: `scopes`検証後
- **Line 1888-1894**: `SaveOrUpdateStore()`呼び出し前
- **Line 1897**: `RegisterWebhooks()`呼び出し前
- **Line 1900**: `EnsureTrialSubscriptionAsync()`呼び出し前
- **Line 1902-1905**: メソッド終了時（`storeId`返却前）

**確認項目**:
- すべてのパラメータ（`shop`, `accessToken`, `apiKey`, `apiSecret`, `shopifyAppId`, `scopes`）が正しく渡されているか
- `SaveOrUpdateStore()`が成功し、`storeId`が正しく返却されているか
- `Stores`テーブルにレコードが正しく作成・更新されているか
- `RegisterWebhooks()`が成功しているか
- `EnsureTrialSubscriptionAsync()`が成功しているか

**重要**: `Stores`テーブルにレコードが作成されない問題の原因を特定するため、必ず確認してください。

---

#### 9. `BuildRedirectUrlAsync()` (リダイレクトURL生成)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**メソッド**: `BuildRedirectUrlAsync()`

**ブレークポイント設定箇所**:
- **Line 1917-1927**: メソッド開始時（パラメータ受信後）
- **Line 1929-1933**: `host`パラメータデコード後
- **Line 1934-1951**: 埋め込みアプリ用URL生成処理
- **Line 1952-1960**: `host`デコード失敗時のフォールバック処理
- **Line 1961-1976**: 埋め込みアプリ用URL生成（フォールバック）
- **Line 1934-1951**: 非埋め込みアプリ用URL生成処理
- **Line 1945-1951**: 最終リダイレクトURL生成後

**確認項目**:
- すべてのパラメータ（`shop`, `storeId`, `apiKey`, `hostParam`, `embeddedParam`）が正しく渡されているか
- `host`パラメータが正しくデコードできているか
- `GetShopifyAppUrlAsync()`が正しく`AppUrl`を取得できているか
- 最終的なリダイレクトURLに`storeId`が含まれているか
- リダイレクトURLが`{AppUrl}/auth/success?shop=xxx&storeId=xxx&success=true`の形式になっているか

**重要**: `storeId`がリダイレクトURLに含まれていないと、フロントエンドで`storeId: null`の問題が発生します。必ず確認してください。

---

## 🎯 優先度の高いデバッグポイント

### 最優先（必須確認）

1. **`GetRedirectUriAsync()` (Line 67-151)**
   - データベースから`AppUrl`が正しく取得できているか
   - `redirectUri`が`{AppUrl}/api/shopify/callback`になっているか

2. **`/api/shopify/callback` コールバックプロキシ (Line 90-336)**
   - すべてのクエリパラメータが正しく取得できているか
   - バックエンドへの転送が正しく動作しているか

3. **`ProcessOAuthSuccessAsync()` (Line 1864-1906)**
   - `Stores`テーブルにレコードが正しく作成されているか
   - `storeId`が正しく返却されているか

4. **`BuildRedirectUrlAsync()` (Line 1917-1951)**
   - リダイレクトURLに`storeId`が含まれているか
   - `AppUrl`が正しく取得できているか

### 次優先（問題発生時）

5. **`/auth/success` ページ (Line 26-250)**
   - URLパラメータが正しく取得できているか
   - `storeId`が`null`になっていないか

6. **`Callback()` メソッド (Line 340-431)**
   - state検証が成功しているか
   - HMAC検証が成功しているか
   - アクセストークンが正しく取得できているか

---

## 🔧 デバッグ時の確認チェックリスト

### バックエンド

- [ ] `UseFrontendProxy`が`true`になっているか
- [ ] `ShopifyApps`テーブルの`AppUrl`が正しく設定されているか
- [ ] `GetRedirectUriAsync()`が正しく`AppUrl`を取得できているか
- [ ] `redirectUri`が`{AppUrl}/api/shopify/callback`になっているか
- [ ] OAuth URLに正しい`redirect_uri`が含まれているか
- [ ] `ProcessOAuthSuccessAsync()`が成功し、`storeId`が返却されているか
- [ ] `Stores`テーブルにレコードが作成されているか
- [ ] `BuildRedirectUrlAsync()`の戻り値に`storeId`が含まれているか

### フロントエンド

- [ ] `/api/shopify/callback`が正しく呼ばれているか
- [ ] すべてのクエリパラメータが正しく取得できているか
- [ ] バックエンドへの転送が正しく動作しているか
- [ ] `/auth/success`ページで`storeId`が正しく取得できているか
- [ ] `localStorage`に正しく保存されているか

---

## 📝 ログ確認ポイント

### バックエンドログ

以下のログメッセージを確認してください：

1. **`GetRedirectUriAsync`関連**:
   ```
   GetRedirectUriAsync: AppUrl found from database for apiKey=..., AppUrl=...
   Redirect URI generated (frontend proxy): FrontendUrl=..., RedirectUri=...
   ```

2. **`BuildOAuthUrlAsync`関連**:
   ```
   OAuth authentication started. Shop: ..., State: ..., ApiKey: ...
   OAuth redirect_uri決定. Shop: ..., ApiKey: ..., RedirectUri: ...
   Generated OAuth authorization URL: ...
   ```

3. **`Callback`関連**:
   ```
   OAuth callback received. Shop: ..., State: ...
   State validation successful. Shop: ...
   HMAC validation successful. Shop: ...
   Access token obtained. Shop: ...
   ```

4. **`ProcessOAuthSuccessAsync`関連**:
   ```
   OAuth authentication success processing completed. Shop: ..., StoreId: ..., ShopifyAppId: ...
   ```

5. **`BuildRedirectUrlAsync`関連**:
   ```
   BuildRedirectUrlAsync: apiKey=..., appUrl=...
   Built embedded app URL: ...
   Built non-embedded app URL: ...
   ```

### フロントエンドログ（ブラウザコンソール）

1. **`/api/shopify/callback`関連**:
   ```
   [CallbackProxy] Shopify OAuthコールバック受信: ...
   [CallbackProxy] バックエンドへ転送: ...
   [CallbackProxy] バックエンド応答: ...
   ```

2. **`/auth/success`関連**:
   ```
   [AuthSuccess] 処理開始: ...
   [AuthSuccess] handleAuthCallback開始
   [AuthSuccess] 認証成功: ...
   ```

---

## ⚠️ 注意事項

1. **ngrok URLの変更**: ngrokのURLが変更された場合は、`ShopifyApps`テーブルの`AppUrl`を更新してください。

2. **データベース接続**: バックエンドがデータベースに接続できているか確認してください。

3. **CORS設定**: `appsettings.LocalDevelopment.json`の`Cors:AllowedOrigins`にngrok URLが含まれているか確認してください。

4. **Shopify Partners Dashboard**: `Allowed redirection URL(s)`に`{AppUrl}/api/shopify/callback`が登録されているか確認してください。

5. **SSL証明書**: ローカル開発環境でのSSL証明書エラーは、フロントエンドのコールバックプロキシで自動的にHTTPにフォールバックされます。

---

## 📚 関連ドキュメント

- [ngrok-ローカルテスト設定手順](./ngrok-ローカルテスト設定手順.md)
- [ngrok-コールバックプロキシ実装](./ngrok-コールバックプロキシ実装.md)
- [ngrok-ローカルテスト設定完了](./2025-12-29-ngrok-ローカルテスト設定完了.md)
- [インストール機能設計書](../../03-feature-development/インストールフロー改善機能/インストール機能設計書.md)
- [インストール機能-調査対象シーケンス](../../03-feature-development/インストールフロー改善機能/インストール機能-調査対象シーケンス.md)

---

## 更新履歴

- 2025-12-29: 初版作成
