# 課金システム最終実装計画
作成日: 2025-08-24
作成者: Kenji（AIプロジェクトマネージャー）

## 本日の目標
アプリ公開のため、課金システムの要件定義、実装、テストを完了する

## 現状分析

### 実装済み
- ✅ Backend: `SubscriptionController`と`ShopifySubscriptionService`の土台実装
- ✅ Database: WebhookEventsテーブルのスキーマ追加
- ✅ Docs: 課金システム技術ガイド一式作成済み
- ✅ Frontend: 開発用ページの本番除外設定

### 未実装（本日完了必須）
- ❌ 課金プランの要件最終確定
- ❌ GraphQL APIの完全実装
- ❌ Webhook処理の実装
- ❌ フロントエンドUI実装
- ❌ E2Eテストの実行

## 実装タスクリスト

### Phase 1: 要件定義（9:00-10:00）
#### 担当: Kenji
- [ ] 価格プランの最終確定（$50/$80/$100）
- [ ] 無料トライアル日数の確定（7日/14日）
- [ ] 機能制限の明確化
- [ ] 課金トリガーの定義

### Phase 2: バックエンド実装（10:00-14:00）
#### 担当: Takashi
- [ ] GraphQL API完全実装
  - [ ] RecurringApplicationCharge作成
  - [ ] 課金URL生成処理
  - [ ] 承認確認処理
  - [ ] アクティベート処理
- [ ] Webhook実装
  - [ ] app_subscriptions/update
  - [ ] app_subscriptions/cancel
  - [ ] app/uninstalled
- [ ] エラーハンドリング強化
- [ ] Rate Limit対策

### Phase 3: フロントエンド実装（10:00-14:00）
#### 担当: Yuki
- [ ] 課金コンポーネント作成
  - [ ] PlanSelector（プラン選択）
  - [ ] BillingStatus（課金状態表示）
  - [ ] TrialBanner（トライアル通知）
- [ ] 画面実装
  - [ ] /settings/billing ページ
  - [ ] アップグレード促進UI
  - [ ] 機能制限表示
- [ ] Context/Hook実装
  - [ ] SubscriptionContext
  - [ ] useSubscription
  - [ ] useFeatureAccess

### Phase 4: 統合・テスト（14:00-17:00）
#### 担当: 全員
- [ ] API統合テスト
- [ ] UI動作確認
- [ ] E2Eテスト実行
  - [ ] 新規課金フロー
  - [ ] アップグレードフロー
  - [ ] キャンセルフロー
- [ ] Webhook動作確認

### Phase 5: デプロイ準備（17:00-18:00）
#### 担当: Kenji調整
- [ ] 環境変数確認
- [ ] マイグレーション適用
- [ ] ステージング環境デプロイ
- [ ] 最終動作確認

## タスク割り振り

### Takashi（バックエンド）への依頼
```
1. SubscriptionControllerの完全実装
2. ShopifySubscriptionServiceのGraphQL処理
3. Webhook処理の実装
4. 単体テスト作成
```

### Yuki（フロントエンド）への依頼
```
1. 課金管理画面の実装
2. プラン選択UIの作成
3. 課金状態管理のContext実装
4. 機能制限UIの実装
```

### Kenji（PM）の役割
```
1. 要件定義の最終化
2. 進捗管理・調整
3. テスト計画・実行
4. ドキュメント更新
```

## 成功基準
- [ ] 3つのプラン（$50/$80/$100）が選択可能
- [ ] 無料トライアルが機能する
- [ ] 課金承認後に機能が解放される
- [ ] Webhookで状態が同期される
- [ ] エラー時の適切な処理

## リスクと対策
| リスク | 対策 |
|--------|------|
| API実装の遅延 | 最小機能から段階的実装 |
| テスト不足 | 重要フローに絞って実施 |
| 環境設定ミス | 早期に環境変数確認 |

## コミュニケーション
- 1時間ごとに進捗共有
- ブロッカーは即座に報告
- Slackで随時連携

## 次のステップ
1. このドキュメントをチーム全体に共有
2. 各担当者への詳細タスク依頼
3. 進捗の定期確認開始