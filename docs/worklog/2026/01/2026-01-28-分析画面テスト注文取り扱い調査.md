# 作業ログ: 分析画面「テスト注文」取り扱い調査

## 作業情報
- 開始日時: 2026-01-28 18:00:00
- 完了日時: 2026-01-28 18:20:00
- 所要時間: 約20分
- 担当: 福田＋AI Assistant

## 作業概要
前年同月比・購入回数・休眠顧客の3分析画面において、「テスト注文」の取り扱いが一定かどうかを調査した。

## 実施内容
1. 各分析のAPI・コントローラ・サービス層の特定
2. Order モデルおよび Shopify 同期処理での `Test` / テスト注文の有無を確認
3. YearOverYearService、PurchaseCountDataService、DormantCustomerQueryService 等の注文参照クエリを確認
4. Customer の TotalOrders / LastOrderDate 更新元（CustomerDataMaintenanceService 等）の確認
5. 調査結果のとりまとめとドキュメント化

## 成果物
- `docs/03-feature-development/分析機能/分析画面-テスト注文取り扱い調査報告.md`（新規）
- `docs/worklog/2026/01/2026-01-28-分析画面テスト注文取り扱い調査.md`（本ファイル）

## 主な結論
- **3画面ともテスト注文を除外していない。** 取り扱いは「すべて含める」で一致。
- **テスト注文を識別・除外する仕様は未実装。** Order に `Test` がなく、同期でも Shopify の `test` を保存していない。
- テスト注文を除外する方針にする場合は、Order への `Test` 追加・同期での取得・全分析クエリでの統一除外が必要。

## 続報：テスト注文除外の実装（2026-01-28）

「テスト注文を除外する」仕様で統一する実装を実施した。

### 実施内容
1. **Order に IsTest 追加**：`DatabaseModels.cs` に `IsTest` 追加。EF マイグレーション `20260128092303_AddIsTestToOrders` 作成。tracking 更新。
2. **同期で test 取得・保存**：ShopifyOrder DTO に `test`、Upsert/ConvertToOrderEntity/SaveOrUpdate で `IsTest` 反映。LastOrderDate 更新はテスト注文時は行わない。`UpdateCustomerLastOrderDatesAsync` で `!o.IsTest` 適用。
3. **分析クエリで統一除外**：YearOverYearService・PurchaseCountDataService・DormantCustomerQueryService の全 Order/OrderItems 参照に `!o.IsTest` 等を追加。YoY キャッシュキー `YearOverYear_ExcludeTest`、休眠 `dormant_query_v4` に更新。
4. **Customer 集計で除外**：CustomerDataMaintenanceService・DatabaseController の TotalOrders/LastOrderDate 集計、CustomerController デバッグの休眠用 Orders 参照で `!o.IsTest` 適用。

### 成果物（追加）
- `backend/.../Migrations/20260128092303_AddIsTestToOrders.cs`
- 上記サービス・コントローラ・ジョブの修正
- `docs/03-feature-development/分析機能/分析画面-テスト注文取り扱い調査報告.md` に §5 実装済み対応を追記

### 運用注意
- マイグレーション適用後に `POST /api/database/update-customer-totals` で Customer 再集計を推奨。

## 課題・注意点
- 除外は全分析で統一済み。一部だけ除外すると取り扱いがずれるため、今後も統一を維持すること。

## 関連ファイル
- `docs/01-project-management/backlog-tickets/260128-Backlogチケット-データ同期画面改善.md`
- `backend/ShopifyAnalyticsApi/Controllers/AnalyticsController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/PurchaseController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/CustomerController.cs`
