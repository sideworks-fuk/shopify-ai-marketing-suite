# APIエラー トラブルシューティングガイド

## エラー詳細
```
ApiError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
```
または
```
データの取得に失敗しました。リクエストがタイムアウトしました。
```

## 問題の概要
- **現象**: APIレスポンスがJSONではなくHTML（エラーページ）を返している、またはタイムアウトエラーが発生
- **原因**: Static Web Appsのプロキシ設定に問題がある、または大量データ処理によるタイムアウト
- **影響**: フロントエンドで休眠顧客分析が表示されない

## 現在の状況
- ✅ **バックエンドAPI**: 正常稼働（Swagger UIが表示、直接API呼び出しで200 OK）
- ❌ **フロントエンド**: Static Web Appsのプロキシ経由でAPIエラーが発生、またはタイムアウト

## 問題の特定
**Static Web Appsのプロキシ設定問題** または **大量データ処理によるタイムアウト**
- フロントエンドから `/api/*` へのリクエストが正しくバックエンドに転送されていない
- 大量データの処理に時間がかかりすぎている
- ページサイズが大きすぎる

## 解決手順

### ステップ1: Static Web Apps設定の改善（完了）
1. より詳細なAPIルーティング設定を追加
2. CORSヘッダーの強化
3. 特定エンドポイントの明示的な設定
4. **ルーティング順序の修正**（ワイルドカードルートの競合解決）

### ステップ2: パフォーマンス改善（完了）
1. フロントエンドのページサイズを1000から100に調整
2. APIタイムアウト時間を60秒から120秒に延長
3. バックエンドのクエリ最適化
4. エラーハンドリングの改善

### ステップ3: フロントエンドの再デプロイ
1. GitHub Actionsでフロントエンドを再デプロイ
2. デプロイ完了まで待機（約5-10分）

### ステップ4: 動作確認
1. ブラウザでフロントエンドにアクセス
2. 休眠顧客分析ページでAPIエラーが解決されたか確認
3. 開発者ツールでNetworkタブを確認

## 修正内容

### 1. Static Web Apps設定の改善
- より具体的なルートを先に配置
- CORSヘッダーの強化
- APIプロキシ設定の強化

### 2. パフォーマンス改善
- **フロントエンド**: ページサイズを1000→100に調整
- **APIタイムアウト**: 60秒→120秒に延長
- **バックエンド**: クエリ最適化（Include最適化）

### 3. エラーハンドリング改善
- タイムアウトエラーの特別処理
- ユーザーフレンドリーなエラーメッセージ
- デバッグ情報の充実

## 予防策

### 1. 定期的なヘルスチェック
- バックエンドAPIの定期的な監視
- フロントエンドのAPI接続テスト

### 2. ログ監視
- Azure Application Insightsの活用
- エラーログの自動収集

### 3. デプロイ監視
- GitHub Actionsのデプロイ状況監視
- デプロイ失敗時の自動通知

## 参考リンク
- [Azure App Service トラブルシューティング](https://docs.microsoft.com/ja-jp/azure/app-service/troubleshoot-diagnostic-logs)
- [Azure Static Web Apps 設定](https://docs.microsoft.com/ja-jp/azure/static-web-apps/configuration)
- [GitHub Actions ワークフロー](https://docs.github.com/ja/actions/using-workflows)

## 緊急時の連絡先
- 開発チーム: 福田
- インフラ担当: 要確認 