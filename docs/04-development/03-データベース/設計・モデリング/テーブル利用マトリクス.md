# テーブル利用マトリクス（Controllers / Services / IN-OUT）

作成日: 2025-08-24
作成者: ERIS（補助: 福田）
対象: `backend/ShopifyAnalyticsApi` の `Controllers/` `Services/` `Models/`

---

## 凡例
- IN: 主に書き込み（Insert/Update）イベントの起点
- OUT: 主に読み取り（Select）イベントの起点

---

## マトリクス

| テーブル | 主担当Controllers | 主担当Services | INタイミング | OUTタイミング |
|---|---|---|---|---|
| Stores | `SetupController`, `StoreController`, `ManualSyncController` | `StoreService`, `ShopifyOAuthService` | OAuth完了・初期設定完了 | 多数APIのStore絞り込み |
| Customers | `CustomerController`, `DatabaseController` | `ShopifyApiService`, `CustomerDataMaintenanceService` | 同期取込・集計更新 | ダッシュボード/休眠/購入回数分析 |
| Orders | `DashboardController` | `ShopifyApiService`, `MonthlySalesService` | 同期取込 | KPI/売上集計/トレンド |
| OrderItems | （間接: `AnalyticsController`） | `MonthlySalesService`, `YearOverYear*` | 同期取込 | 商品/月次/カテゴリ集計 |
| Products | `DashboardController` | `ShopifyApiService`, `MonthlySalesService` | 同期取込 | 集計・商品参照 |
| ProductVariants | - | `ShopifyApiService` | 同期取込 | 商品詳細参照 |
| WebhookEvents | `WebhookController` | （将来の再処理サービス想定） | Webhook受信時 | 監査/障害解析 |
| InstallationHistory | `ShopifyAuthController` | - | インストール/アンインストール | 監査 |
| GDPRComplianceLog | `WebhookController` | `DataCleanupService` | GDPR系Webhook受信時 | 法令対応確認 |
| SubscriptionPlans | `SubscriptionController` | `ShopifySubscriptionService` | 運用投入（DDL/管理UI） | プラン表示 |
| StoreSubscriptions | `SubscriptionController` | `ShopifySubscriptionService` | 申込/変更/キャンセル/Webhook | 課金状態表示/機能ゲート |
| SyncStates | `ManualSyncController`, `SyncManagementController` | `ShopifyDataSyncService`, `SyncProgressTracker` | 同期開始/進捗/完了 | 同期状況/履歴表示 |
| SyncProgressDetails | 同上 | 同上 | 同期中バッチ進捗 | 進捗明細表示 |
| SyncRangeSettings | `SyncManagementController` | `SyncRangeManager` | 範囲登録/更新 | 範囲参照 |
| SyncCheckpoints | `SyncManagementController` | `CheckpointManager` | 中断/再開時保存 | 再開時参照 |
| SyncHistories | `SyncManagementController` | `SyncProgressTracker` | 完了時記録 | 履歴表示 |
| SyncStatuses | `DashboardController` | - | 旧/簡易トラッキング | 表示（互換） |
| Tenants | - | - | 運用登録 | 参照（Stores経由） |

---

## 補足
- 詳細な利用フローは `データベース設計書.md` の「9. テーブル利用詳細」「10. 代表的なIN/OUTイベント時系列」を参照。


