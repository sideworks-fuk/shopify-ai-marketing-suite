# コストシミュレーション実践ワークシート

## 事前準備チェックリスト

### アカウント・ツール準備
- [ ] Azure無料アカウント作成（¥22,500クレジット取得）
- [ ] Azure Pricing Calculator をブックマーク
- [ ] Cost Management へのアクセス確認
- [ ] 請求アラート用のメールアドレス準備

---

## Phase別コスト記録シート

### Phase 1: Azure Functions デプロイ時
```
デプロイ日時: ____年____月____日
初期設定:
- [ ] リソースグループ名: _________________
- [ ] Functionsアプリ名: _________________
- [ ] プラン: Consumption
- [ ] リージョン: Japan East

コストタグ設定:
{
  "Environment": "Development",
  "Phase": "1",
  "Purpose": "FunctionTest"
}

予想月額コスト: ¥0（無料枠内）
```

### Phase 2: フロントエンドデプロイ時
```
Static Web Apps:
- [ ] 無料プラン選択確認
- [ ] カスタムドメイン設定（2個まで無料）

予想追加コスト: ¥0
```

### Phase 3: GitHub Actions設定時
```
GitHub Actions使用時間:
- [ ] 月間使用分数: ______分（2,000分まで無料）
- [ ] ストレージ使用量: ______GB（500MBまで無料）

予想追加コスト: ¥0
```

### Phase 4: データベース追加時
```
PostgreSQL設定:
- [ ] SKU選択: B1ms (2GB RAM)
- [ ] ストレージ: 32GB
- [ ] バックアップ保持: 7日

予想月額コスト: ¥2,870 + ¥459（ストレージ） = ¥3,329
```

### Phase 5: Shopify連携時
```
追加リソース:
- [ ] Application Insights データ量: ____GB
- [ ] 外部API呼び出し増加: ____回/月

予想追加コスト: ¥____
```

---

## 週次コストレビューテンプレート

### Week 1 レビュー
```
期間: ____/____ 〜 ____/____

Azure Cost Management 確認:
- 現在までの使用料金: ¥________
- 月末予測: ¥________
- 予算に対する進捗: ____%

最もコストが高いサービス:
1. _________________ (¥_____)
2. _________________ (¥_____)
3. _________________ (¥_____)

改善アクション:
- [ ] _________________________
- [ ] _________________________
```

---

## コスト最適化チェックリスト

### 即座に実施できる項目
- [ ] 未使用リソースの削除
- [ ] 開発環境の自動シャットダウン設定
- [ ] Functionsの実行ログレベル調整（Verboseは高い）

### 検討すべき項目（使用量増加時）
- [ ] 予約インスタンスの購入（1年で42%、3年で72%割引）
- [ ] PostgreSQLのスケジュール起動/停止
- [ ] Application Insightsのサンプリング設定

---

## Azure Pricing Calculator 実践演習

### 演習1: 最小構成の見積もり
1. https://azure.microsoft.com/ja-jp/pricing/calculator/ にアクセス
2. 以下を追加:
   - Azure Functions (月10万実行、200ms、512MB)
   - PostgreSQL Flexible (B1ms, 32GB)
   - Static Web Apps (Free)
3. 見積もりを保存・共有

結果URL: _________________________________
月額合計: ¥________

### 演習2: スケールアップ見積もり
1. 演習1の構成をコピー
2. 以下に変更:
   - Functions: 月200万実行
   - PostgreSQL: B2s, 64GB
   - Redis Cache C1追加
3. 差額を計算

スケールアップ後: ¥________
差額: ¥________

---

## トラブルシューティング

### よくある課金トラブル
| 症状 | 原因 | 対策 |
|------|------|------|
| 予想外の課金 | Application Insightsの大量ログ | サンプリング設定 |
| 帯域幅課金 | 大きなファイルの頻繁なダウンロード | CDN検討 |
| ストレージ課金 | 古いバックアップの蓄積 | 保持期間設定 |

### 緊急時の対応
1. **予算超過アラート受信時**
   - Cost Managementで原因特定
   - 不要リソースの即時停止
   - スケールダウンの検討

2. **開発完了後**
   - リソースグループごと削除
   - 課金が0になったことを確認

---

## 月間コスト実績記録

### 月次サマリーテンプレート
```
対象月: ____年____月

【実績】
総額: ¥________
予算比: ____%

【内訳】
- PostgreSQL: ¥________ (__%)
- Functions: ¥________ (__%)
- Storage: ¥________ (__%)
- その他: ¥________ (__%)

【前月比】
増減額: ¥________
主な変動要因: _________________

【来月の見通し】
予測額: ¥________
対策: _________________________
```

---

## PowerShell コマンド集

### コスト関連の便利コマンド
```powershell
# Azure CLIでログイン
az login

# 現在の課金情報を確認
az consumption usage list --start-date 2025-01-01 --end-date 2025-01-31

# リソースグループごとのコストを表示
az consumption usage list --query "[?resourceGroup=='myResourceGroup']"

# 予算の作成
az consumption budget create \
  --amount 5000 \
  --budget-name "dev-budget" \
  --category cost \
  --time-grain Monthly

# タグ付きリソースのコスト確認
az consumption usage list --query "[?tags.Environment=='Development']"
```

---

## 月次コスト管理テンプレート

### 環境別コスト追跡シート

| 環境 | 当月予算 | 現在までの使用 | 進捗率 | 前月比 | アクション |
|------|----------|----------------|--------|---------|-----------|
| 開発 | ¥10,000 | ¥______ | ___% | ___% | ____________ |
| ステージング | ¥15,000 | ¥______ | ___% | ___% | ____________ |
| 本番 | ¥50,000 | ¥______ | ___% | ___% | ____________ |
| 共通（ネットワーク等） | ¥5,000 | ¥______ | ___% | ___% | ____________ |
| **合計** | **¥80,000** | **¥______** | **___%** | **___%** | ____________ |

### コスト異常検知チェックリスト

#### 日次チェック（自動アラート設定推奨）
- [ ] 前日比50%以上の増加がないか
- [ ] 特定リソースの急激な使用量増加
- [ ] エラーによる無限ループ処理

#### 週次チェック
- [ ] 予算に対する進捗率が想定内か
- [ ] 未使用リソースの確認
- [ ] 開発環境の稼働時間

#### 月次詳細レビュー
- [ ] サービス別コスト分析
- [ ] タグ別コスト配分
- [ ] 最適化機会の特定

---

## 即効性のあるコスト削減アクション

### すぐできる対策（1日で実施可能）

#### 1. 開発環境の自動停止設定
```bash
# Azure CLI例
az vm auto-shutdown -g MyResourceGroup -n MyVM --time 1900
```
**削減効果**: 約50%（12時間/日×土日停止）

#### 2. 未使用リソースの削除
- 孤立したディスク
- 未接続のPublic IP
- 古いスナップショット

**削減効果**: 月¥5,000〜20,000

#### 3. ログレベルの調整
```csharp
// Application Insights
logging.AddFilter<ApplicationInsightsLoggerProvider>("", LogLevel.Warning);
```
**削減効果**: 80%のログ量削減

### 1週間で実施可能な対策

#### 1. 適切なSKUへの変更
- PostgreSQL: B2s → B1ms（使用率低い場合）
- **削減効果**: 月¥2,870

#### 2. ストレージ階層の最適化
- Hot → Cool（アクセス頻度低いデータ）
- **削減効果**: 50%のストレージコスト

### 1ヶ月で実施可能な対策

#### 1. 予約インスタンスの購入
- 1年予約: 42%割引
- 3年予約: 72%割引

#### 2. アーキテクチャの見直し
- サーバーレス化
- キャッシュ戦略の改善

---

## 環境構成のベストプラクティス

### 開発環境
```yaml
特徴:
  - 平日9-19時のみ稼働
  - 最小スペック
  - 本番データのマスキング版使用

推奨設定:
  PostgreSQL: B1s + 自動停止
  Functions: Consumption Plan
  Storage: Cool Tier
  
月額目安: ¥5,000 → ¥2,000（60%削減）
```

### ステージング環境
```yaml
特徴:
  - リリース前のみ起動
  - 本番の70%スペック
  - 本番同等の構成

推奨設定:
  PostgreSQL: B1ms + スケジュール起動
  Functions: Consumption Plan
  負荷テスト: 実施時のみPremium
  
月額目安: ¥15,000 → ¥7,000（53%削減）
```

### 本番環境
```yaml
特徴:
  - 24/365稼働
  - 自動スケーリング
  - 高可用性構成

推奨設定:
  PostgreSQL: General Purpose + HA
  Functions: Premium Plan（必要時）
  監視: Application Insights Standard
  
月額目安: ¥50,000（削減より安定性優先）
```

---

## 関連リソース

- [コスト影響要因 チェックリスト](./cost-factors-checklist.md) ⭐NEW
- [Azure価格情報・コストシミュレーション リソース集](./azure-pricing-resources.md)
- [Azureサービス コスト試算ガイド](./azure-cost-estimation-guide.md)
- [コスト監視計画（簡略版）](./cost-monitoring-plan.md) 