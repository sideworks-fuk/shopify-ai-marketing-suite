# ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“‹ æ¦‚è¦

### ç›®çš„
é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆæ™‚ã«ã‚¹ãƒˆã‚¢1ï¼ˆæœ¬ç•ªãƒ‡ãƒ¼ã‚¿ï¼‰ã¨ã‚¹ãƒˆã‚¢2ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’æ‰‹å‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã€‚
å°†æ¥çš„ã«ã¯Shopify OAuthèªè¨¼ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«ã‚¹ãƒˆã‚¢ãŒæ±ºå®šã•ã‚Œã‚‹äºˆå®šã€‚

### å¯¾è±¡ç”»é¢
- å‰å¹´åŒæœˆæ¯”ã€å•†å“ã€‘ç”»é¢
- è³¼å…¥å›æ•°åˆ†æã€è³¼è²·ã€‘ç”»é¢  
- ä¼‘çœ é¡§å®¢åˆ†æã€é¡§å®¢ã€‘ç”»é¢
- ãã®ä»–ã™ã¹ã¦ã®åˆ†æç”»é¢

## ğŸ¯ è¦ä»¶å®šç¾©

### æ©Ÿèƒ½è¦ä»¶
1. **ã‚¹ãƒˆã‚¢é¸æŠUI**: ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã§ã‚¹ãƒˆã‚¢ã‚’é¸æŠå¯èƒ½
2. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ‡ã‚Šæ›¿ãˆ**: é¸æŠå¾Œã€å³åº§ã«ãƒ‡ãƒ¼ã‚¿ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
3. **çŠ¶æ…‹ä¿æŒ**: ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒ
4. **è¦–è¦šçš„è¡¨ç¤º**: ç¾åœ¨ã®ã‚¹ãƒˆã‚¢ãŒæ˜ç¢ºã«åˆ†ã‹ã‚‹
5. **é–‹ç™ºå°‚ç”¨**: æœ¬ç•ªç’°å¢ƒã§ã¯éè¡¨ç¤ºï¼ˆå°†æ¥å¯¾å¿œï¼‰

### éæ©Ÿèƒ½è¦ä»¶
- **å¿œç­”æ€§**: åˆ‡ã‚Šæ›¿ãˆæ™‚3ç§’ä»¥å†…ã§ãƒ‡ãƒ¼ã‚¿æ›´æ–°
- **äº’æ›æ€§**: æ—¢å­˜APIã¨ã®å®Œå…¨äº’æ›æ€§
- **æ‹¡å¼µæ€§**: å°†æ¥ã®Shopifyèªè¨¼ã¸ã®ç§»è¡Œå®¹æ˜“æ€§

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### å…¨ä½“æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚     Backend     â”‚    â”‚    Database     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚StoreSelectorâ”‚ â”‚    â”‚ â”‚Store Contextâ”‚ â”‚    â”‚ â”‚  Store 1    â”‚ â”‚
â”‚ â”‚   Component â”‚ â”‚    â”‚ â”‚   Service   â”‚ â”‚    â”‚ â”‚   Data      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚        â”‚    â”‚        â”‚        â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚  Store 2    â”‚ â”‚
â”‚ â”‚Store Contextâ”‚ â”‚    â”‚ â”‚   API       â”‚ â”‚    â”‚ â”‚ Test Data   â”‚ â”‚
â”‚ â”‚  Provider   â”‚ â”‚â—„â”€â”€â”€â”¤ â”‚Controllers  â”‚ â”‚â—„â”€â”€â”€â”¤ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                 â”‚
â”‚        â”‚        â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”‚ Analysis    â”‚ â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”‚ Components  â”‚ â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 1. Store Context Provider

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/contexts/StoreContext.tsx`

```tsx
"use client"

import { createContext, useContext, useState, useEffect, ReactNode } from 'react'

interface StoreInfo {
  id: number
  name: string
  description: string
  dataType: 'production' | 'test'
  isActive: boolean
}

interface StoreContextType {
  currentStore: StoreInfo
  availableStores: StoreInfo[]
  switchStore: (storeId: number) => void
  isLoading: boolean
}

const AVAILABLE_STORES: StoreInfo[] = [
  {
    id: 1,
    name: "æœ¬ç•ªã‚¹ãƒˆã‚¢",
    description: "å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸãƒ¡ã‚¤ãƒ³åˆ†æç’°å¢ƒ",
    dataType: "production",
    isActive: true
  },
  {
    id: 2,
    name: "ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢",
    description: "2020-2025å¹´ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç’°å¢ƒ",
    dataType: "test", 
    isActive: true
  }
]

const StoreContext = createContext<StoreContextType | undefined>(undefined)

export function StoreProvider({ children }: { children: ReactNode }) {
  const [currentStore, setCurrentStore] = useState<StoreInfo>(AVAILABLE_STORES[0])
  const [isLoading, setIsLoading] = useState(false)

  // åˆæœŸåŒ–ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›é¸æŠã‚’å¾©å…ƒ
  useEffect(() => {
    const savedStoreId = localStorage.getItem('selectedStoreId')
    if (savedStoreId) {
      const store = AVAILABLE_STORES.find(s => s.id === parseInt(savedStoreId))
      if (store) {
        setCurrentStore(store)
      }
    }
  }, [])

  const switchStore = async (storeId: number) => {
    const store = AVAILABLE_STORES.find(s => s.id === storeId)
    if (!store) return

    setIsLoading(true)
    
    try {
      // ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆ
      setCurrentStore(store)
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem('selectedStoreId', storeId.toString())
      
      // åˆ†æãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ï¼ˆæ¬¡å›å–å¾—æ™‚ã«æ–°ã—ã„ã‚¹ãƒˆã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã®å®Ÿè£…ã¯ã“ã“ã«è¿½åŠ 
      
      console.log(`ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆå®Œäº†: ${store.name} (ID: ${storeId})`)
    } catch (error) {
      console.error('ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <StoreContext.Provider value={{
      currentStore,
      availableStores: AVAILABLE_STORES,
      switchStore,
      isLoading
    }}>
      {children}
    </StoreContext.Provider>
  )
}

export function useStore() {
  const context = useContext(StoreContext)
  if (context === undefined) {
    throw new Error('useStore must be used within a StoreProvider')
  }
  return context
}
```

### 2. Store Selector Component

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/common/StoreSelector.tsx`

```tsx
"use client"

import { useStore } from '@/contexts/StoreContext'
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from '@/components/ui/select'
import { Badge } from '@/components/ui/badge'
import { Store, Database, TestTube, Loader2 } from 'lucide-react'

export function StoreSelector() {
  const { currentStore, availableStores, switchStore, isLoading } = useStore()

  // æœ¬ç•ªç’°å¢ƒã§ã¯éè¡¨ç¤ºï¼ˆå°†æ¥å®Ÿè£…ï¼‰
  if (process.env.NODE_ENV === 'production' && !process.env.NEXT_PUBLIC_ENABLE_STORE_SWITCHER) {
    return null
  }

  return (
    <div className="flex items-center gap-3">
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Store className="w-4 h-4" />
        <span>ã‚¹ãƒˆã‚¢:</span>
      </div>
      
      <Select
        value={currentStore.id.toString()}
        onValueChange={(value) => switchStore(parseInt(value))}
        disabled={isLoading}
      >
        <SelectTrigger className="w-48">
          <SelectValue>
            <div className="flex items-center gap-2">
              {isLoading ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : currentStore.dataType === 'production' ? (
                <Database className="w-4 h-4 text-blue-600" />
              ) : (
                <TestTube className="w-4 h-4 text-orange-600" />
              )}
              <span>{currentStore.name}</span>
              <Badge variant={currentStore.dataType === 'production' ? 'default' : 'secondary'}>
                {currentStore.dataType === 'production' ? 'æœ¬ç•ª' : 'ãƒ†ã‚¹ãƒˆ'}
              </Badge>
            </div>
          </SelectValue>
        </SelectTrigger>
        
        <SelectContent>
          {availableStores.map((store) => (
            <SelectItem key={store.id} value={store.id.toString()}>
              <div className="flex items-center gap-2">
                {store.dataType === 'production' ? (
                  <Database className="w-4 h-4 text-blue-600" />
                ) : (
                  <TestTube className="w-4 h-4 text-orange-600" />
                )}
                <div className="flex flex-col">
                  <span className="font-medium">{store.name}</span>
                  <span className="text-xs text-muted-foreground">
                    {store.description}
                  </span>
                </div>
                <Badge variant={store.dataType === 'production' ? 'default' : 'secondary'}>
                  {store.dataType === 'production' ? 'æœ¬ç•ª' : 'ãƒ†ã‚¹ãƒˆ'}
                </Badge>
              </div>
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  )
}
```

### 3. API Hook ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/hooks/useStoreAwareApi.ts`

```tsx
import { useStore } from '@/contexts/StoreContext'
import { getApiUrl } from '@/lib/api-config'

export function useStoreAwareApi() {
  const { currentStore } = useStore()

  const buildApiUrl = (endpoint: string, params?: Record<string, any>) => {
    const baseUrl = getApiUrl()
    const url = new URL(`${baseUrl}${endpoint}`)
    
    // ã‚¹ãƒˆã‚¢IDã‚’è‡ªå‹•è¿½åŠ 
    url.searchParams.set('storeId', currentStore.id.toString())
    
    // è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    if (params) {
      Object.entries(params).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
          url.searchParams.set(key, value.toString())
        }
      })
    }
    
    return url.toString()
  }

  const fetchWithStore = async (endpoint: string, options: RequestInit = {}) => {
    const url = buildApiUrl(endpoint)
    
    return fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
    })
  }

  return {
    currentStoreId: currentStore.id,
    currentStoreName: currentStore.name,
    buildApiUrl,
    fetchWithStore
  }
}
```

### 4. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/layout/Header.tsx`

```tsx
import { StoreSelector } from '@/components/common/StoreSelector'

export function Header() {
  return (
    <header className="border-b bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60">
      <div className="container mx-auto px-4">
        <div className="flex h-16 items-center justify-between">
          {/* å·¦å´: ãƒ­ã‚´ç­‰ */}
          <div className="flex items-center gap-4">
            {/* æ—¢å­˜ã®ãƒ­ã‚´ã‚„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
          </div>
          
          {/* å³å´: ã‚¹ãƒˆã‚¢é¸æŠ */}
          <div className="flex items-center gap-4">
            <StoreSelector />
            {/* æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ */}
          </div>
        </div>
      </div>
    </header>
  )
}
```

## ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 1. Store Context Middleware

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Middleware/StoreContextMiddleware.cs`

```csharp
public class StoreContextMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<StoreContextMiddleware> _logger;

    public StoreContextMiddleware(RequestDelegate next, ILogger<StoreContextMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰storeIdã‚’å–å¾—
        if (context.Request.Query.TryGetValue("storeId", out var storeIdValue))
        {
            if (int.TryParse(storeIdValue, out var storeId))
            {
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚¹ãƒˆã‚¢IDã‚’ä¿å­˜
                context.Items["StoreId"] = storeId;
                _logger.LogDebug("ã‚¹ãƒˆã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š: StoreId = {StoreId}", storeId);
            }
        }
        else
        {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¹ãƒˆã‚¢1
            context.Items["StoreId"] = 1;
            _logger.LogDebug("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒˆã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š: StoreId = 1");
        }

        await _next(context);
    }
}
```

### 2. Store Context Service

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Services/StoreContextService.cs`

```csharp
public interface IStoreContextService
{
    int GetCurrentStoreId();
    string GetCurrentStoreName();
    bool IsTestStore();
}

public class StoreContextService : IStoreContextService
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly ILogger<StoreContextService> _logger;

    public StoreContextService(
        IHttpContextAccessor httpContextAccessor,
        ILogger<StoreContextService> logger)
    {
        _httpContextAccessor = httpContextAccessor;
        _logger = logger;
    }

    public int GetCurrentStoreId()
    {
        var httpContext = _httpContextAccessor.HttpContext;
        if (httpContext?.Items.TryGetValue("StoreId", out var storeIdObj) == true)
        {
            return (int)storeIdObj;
        }

        _logger.LogWarning("ã‚¹ãƒˆã‚¢IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
        return 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }

    public string GetCurrentStoreName()
    {
        return GetCurrentStoreId() switch
        {
            1 => "æœ¬ç•ªã‚¹ãƒˆã‚¢",
            2 => "ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢",
            _ => "ä¸æ˜ãªã‚¹ãƒˆã‚¢"
        };
    }

    public bool IsTestStore()
    {
        return GetCurrentStoreId() == 2;
    }
}
```

### 3. æ—¢å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®æ›´æ–°ä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Controllers/PurchaseController.cs`

```csharp
[HttpGet("count-analysis")]
public async Task<ActionResult<ApiResponse<PurchaseCountAnalysisResponse>>> GetPurchaseCountAnalysis(
    [FromQuery] PurchaseCountAnalysisRequest request)
{
    try
    {
        // ã‚¹ãƒˆã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è‡ªå‹•çš„ã«storeIdã‚’å–å¾—
        var storeId = _storeContextService.GetCurrentStoreId();
        request.StoreId = storeId;

        _logger.LogInformation("è³¼å…¥å›æ•°åˆ†æãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹. StoreId: {StoreId} ({StoreName})", 
            storeId, _storeContextService.GetCurrentStoreName());

        // æ—¢å­˜ã®å‡¦ç†...
        var result = await _purchaseCountAnalysisService.GetPurchaseCountAnalysisAsync(request);

        return Ok(new ApiResponse<PurchaseCountAnalysisResponse>
        {
            Success = true,
            Data = result,
            Message = $"è³¼å…¥å›æ•°åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å–å¾—ã—ã¾ã—ãŸã€‚({_storeContextService.GetCurrentStoreName()})"
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "è³¼å…¥å›æ•°åˆ†æãƒ‡ãƒ¼ã‚¿å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ. StoreId: {StoreId}", 
            _storeContextService.GetCurrentStoreId());
        return StatusCode(500, new ApiResponse<PurchaseCountAnalysisResponse>
        {
            Success = false,
            Data = null,
            Message = "è³¼å…¥å›æ•°åˆ†æãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
        });
    }
}
```

## ğŸ”— çµ±åˆãƒ»è¨­å®š

### 1. App.tsx ã¸ã® Provider è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/layout.tsx`

```tsx
import { StoreProvider } from '@/contexts/StoreContext'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <StoreProvider>
          {children}
        </StoreProvider>
      </body>
    </html>
  )
}
```

### 2. Program.cs ã¸ã® Middleware è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Program.cs`

```csharp
// ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²
builder.Services.AddScoped<IStoreContextService, StoreContextService>();
builder.Services.AddHttpContextAccessor();

var app = builder.Build();

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç™»éŒ²
app.UseMiddleware<StoreContextMiddleware>();

// æ—¢å­˜ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢...
app.UseRouting();
app.MapControllers();
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **åˆæœŸçŠ¶æ…‹ç¢ºèª**
   - ã‚¢ãƒ—ãƒªèµ·å‹•å¾Œã€ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¹ãƒˆã‚¢é¸æŠUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œæœ¬ç•ªã‚¹ãƒˆã‚¢ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹

2. **ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ**
   - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ã€Œãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢ã€ã‚’é¸æŠ
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - åˆ†æç”»é¢ã®ãƒ‡ãƒ¼ã‚¿ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹

3. **çŠ¶æ…‹ä¿æŒãƒ†ã‚¹ãƒˆ**
   - ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
   - ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹

4. **APIå‘¼ã³å‡ºã—ç¢ºèª**
   - Network ã‚¿ãƒ–ã§ API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
   - `storeId=2` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè‡ªå‹•è¿½åŠ ã•ã‚Œã¦ã„ã‚‹

### 2. åˆ†æç”»é¢åˆ¥ãƒ†ã‚¹ãƒˆ

| ç”»é¢ | æœ¬ç•ªã‚¹ãƒˆã‚¢ | ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢ |
|------|------------|--------------|
| å‰å¹´åŒæœˆæ¯”ã€å•†å“ã€‘ | å®Ÿãƒ‡ãƒ¼ã‚¿ã®å•†å“å£²ä¸Š | 2020-2025å¹´ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ |
| è³¼å…¥å›æ•°åˆ†æã€è³¼è²·ã€‘ | å®Ÿéš›ã®é¡§å®¢è³¼å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³ | è¨­è¨ˆã•ã‚ŒãŸ5éšå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³ |
| ä¼‘çœ é¡§å®¢åˆ†æã€é¡§å®¢ã€‘ | å®Ÿéš›ã®ä¼‘çœ é¡§å®¢ | å±±ç”°ç”±ç¾ç­‰ã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ |

## ğŸš€ å°†æ¥ã®Shopifyèªè¨¼é€£æº

### OAuth é€£æºæ™‚ã®å¤‰æ›´ç‚¹

```tsx
// å°†æ¥ã®å®Ÿè£…ä¾‹
export function StoreProvider({ children }: { children: ReactNode }) {
  const [currentStore, setCurrentStore] = useState<StoreInfo | null>(null)
  const { shopifyAuth } = useShopifyAuth() // å°†æ¥å®Ÿè£…

  useEffect(() => {
    if (shopifyAuth.isAuthenticated) {
      // Shopifyèªè¨¼æƒ…å ±ã‹ã‚‰ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’å–å¾—
      const storeInfo = {
        id: shopifyAuth.shop.id,
        name: shopifyAuth.shop.name,
        description: shopifyAuth.shop.domain,
        dataType: 'production' as const,
        isActive: true
      }
      setCurrentStore(storeInfo)
    } else {
      // é–‹ç™ºç’°å¢ƒã§ã¯æ‰‹å‹•é¸æŠã‚’ç¶™ç¶š
      // æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯...
    }
  }, [shopifyAuth])

  // èªè¨¼æ™‚ã¯æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆã‚’ç„¡åŠ¹åŒ–
  const switchStore = shopifyAuth.isAuthenticated 
    ? () => console.log('èªè¨¼æ™‚ã¯ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã›ã‚“')
    : manualSwitchStore

  // ...
}
```

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆYUKIã•ã‚“æ‹…å½“ï¼‰
- [ ] StoreContext Provider å®Ÿè£…
- [ ] StoreSelector Component å®Ÿè£…  
- [ ] useStoreAwareApi Hook å®Ÿè£…
- [ ] Header Component æ›´æ–°
- [ ] layout.tsx ã« Provider è¿½åŠ 
- [ ] æ—¢å­˜åˆ†æã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚¹ãƒˆã‚¢å¯¾å¿œAPIä½¿ç”¨

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆå¿…è¦æ™‚ï¼‰
- [ ] StoreContextMiddleware å®Ÿè£…
- [ ] StoreContextService å®Ÿè£…
- [ ] Program.cs è¨­å®šè¿½åŠ 
- [ ] æ—¢å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ãƒˆã‚¢å¯¾å¿œç¢ºèª

### ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆå‹•ä½œç¢ºèª
- [ ] çŠ¶æ…‹ä¿æŒç¢ºèª
- [ ] API ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª
- [ ] å„åˆ†æç”»é¢ã§ã®ãƒ‡ãƒ¼ã‚¿åˆ‡ã‚Šæ›¿ãˆç¢ºèª

---

**å®Ÿè£…æ‹…å½“**: YUKIã•ã‚“  
**æƒ³å®šå·¥æ•°**: 4-6æ™‚é–“  
**å„ªå…ˆåº¦**: ä¸­ï¼ˆé–‹ç™ºåŠ¹ç‡å‘ä¸Šã®ãŸã‚ï¼‰  
**å°†æ¥å¯¾å¿œ**: Shopify OAuth èªè¨¼ã¨ã®çµ±åˆ