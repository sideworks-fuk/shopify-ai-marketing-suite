# 課金システム フロー図解説明書

## 作成日：2025年8月12日
## 作成者：Kenji（プロジェクトマネージャー）

---

## 1. 課金システム全体像

```mermaid
graph TB
    subgraph "ユーザー側"
        A[ユーザー/店舗オーナー]
    end
    
    subgraph "ECRangerアプリ"
        B[フロントエンド<br/>React/TypeScript]
        C[バックエンドAPI<br/>ASP.NET Core]
        D[データベース<br/>Azure SQL]
    end
    
    subgraph "Shopify側"
        E[Shopify Admin API]
        F[Shopify Billing API]
        G[Shopify Webhook]
    end
    
    A <--> B
    B <--> C
    C <--> D
    C <--> E
    C <--> F
    G --> C
    
    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9
    style E fill:#95e08e
    style F fill:#95e08e
    style G fill:#95e08e
```

---

## 2. 初回課金フロー（新規ユーザー）

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant B as バックエンド
    participant S as Shopify API
    participant D as データベース
    
    Note over U,D: 🚀 アプリインストール直後
    
    U->>F: アプリを開く
    F->>B: GET /api/subscription/current
    B->>D: 課金状態確認
    D-->>B: 未課金
    B-->>F: 無料トライアル案内
    F->>U: トライアル開始画面表示
    
    Note over U,D: 💳 プラン選択
    
    U->>F: プラン選択（例：Professional $80）
    F->>B: POST /api/subscription/create
    Note right of B: プランID: 2<br/>価格: $80<br/>トライアル: 7日間
    
    B->>S: GraphQL: appSubscriptionCreate
    S-->>B: confirmationUrl返却
    B->>D: 課金情報を仮保存（status: pending）
    B-->>F: リダイレクトURL
    F->>U: Shopify課金承認画面へリダイレクト
    
    Note over U,D: ✅ Shopify承認
    
    U->>S: 課金を承認
    S->>B: Webhook: app_subscriptions/update
    B->>D: ステータス更新（status: active）
    B->>D: トライアル期限設定（+7日）
    
    Note over U,D: 🎉 利用開始
    
    U->>F: アプリに戻る
    F->>B: GET /api/subscription/current
    B->>D: 現在のプラン取得
    D-->>B: Professional/トライアル中
    B-->>F: プラン情報
    F->>U: 全機能解放表示
```

---

## 3. トライアル期限切れフロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant B as バックエンド
    participant S as Shopify API
    participant D as データベース
    participant H as HangFire（定期処理）
    
    Note over U,H: ⏰ トライアル期限3日前
    
    H->>D: トライアル期限チェック
    D-->>H: 3日後に期限切れユーザーリスト
    H->>U: リマインダーメール送信
    
    Note over U,H: ⚠️ トライアル期限当日
    
    U->>F: アプリを開く
    F->>B: GET /api/subscription/current
    B->>D: 課金状態確認
    D-->>B: トライアル期限切れ
    B-->>F: 課金必要通知
    F->>U: 課金促進画面表示
    
    alt ユーザーが課金承認
        U->>F: 課金を続ける
        F->>B: POST /api/subscription/activate
        B->>S: 課金有効化
        S-->>B: 成功
        B->>D: ステータス更新（trial→active）
        B-->>F: 成功
        F->>U: 利用継続可能
    else ユーザーが課金拒否
        U->>F: 後で決める
        F->>U: 機能制限モード
        Note right of U: 読み取り専用<br/>エクスポート不可
    end
```

---

## 4. プランアップグレードフロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant B as バックエンド
    participant S as Shopify API
    participant D as データベース
    
    Note over U,D: 📈 現在：Starter($50) → Professional($80)へ
    
    U->>F: アップグレードボタン
    F->>U: アップグレード確認画面
    U->>F: 確認
    
    F->>B: POST /api/subscription/upgrade
    Note right of B: 現在: Starter<br/>新規: Professional
    
    B->>S: 既存課金キャンセル
    S-->>B: キャンセル成功
    
    B->>S: 新規課金作成（日割り計算）
    Note right of S: 残日数分を<br/>日割りで計算
    S-->>B: confirmationUrl
    
    B->>D: アップグレード記録
    B-->>F: リダイレクトURL
    F->>U: Shopify承認画面へ
    
    U->>S: アップグレード承認
    S->>B: Webhook: app_subscriptions/update
    B->>D: プラン更新
    B->>D: 課金履歴記録
    
    U->>F: アプリに戻る
    F->>B: GET /api/subscription/current
    B-->>F: Professional プラン
    F->>U: 新機能解放通知
```

---

## 5. 課金キャンセルフロー

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant B as バックエンド
    participant S as Shopify API
    participant D as データベース
    
    Note over U,D: 🚫 課金キャンセル処理
    
    U->>F: 課金をキャンセル
    F->>U: キャンセル確認画面
    Note right of U: ・機能制限の説明<br/>・再開可能の案内<br/>・フィードバック
    
    U->>F: キャンセル理由入力
    F->>B: POST /api/subscription/cancel
    Note right of B: 理由: 高い<br/>使わない等
    
    B->>S: appSubscriptionCancel（プラン置換/キャンセルの実装方針に依存）
    S-->>B: キャンセル成功
    
    B->>D: ステータス更新（cancelled）
    B->>D: キャンセル理由保存
    B->>D: 期限設定（月末まで利用可）
    
    B-->>F: キャンセル完了
    F->>U: 期限まで利用可能通知
    
    Note over U,D: 📅 月末（期限切れ）
    
    B->>D: ステータス更新（expired）
    U->>F: アプリを開く
    F->>B: GET /api/subscription/current
    B-->>F: 無料プラン（機能制限）
    F->>U: 再開を促す画面
```

---

## 6. Webhook処理フロー

```mermaid
graph LR
    subgraph "Shopify"
        A[Shopifyイベント発生]
    end
    
    subgraph "Webhook種類"
        B[app_subscriptions/update]
        C[app_subscriptions/cancelled]
        D[app/uninstalled]
    end
    
    subgraph "バックエンド処理"
        E[署名検証]
        F[イベント処理]
        G[DB更新]
        H[通知送信]
    end
    
    subgraph "データベース"
        I[WebhookEvents<br/>ログ保存]
        J[StoreSubscriptions<br/>状態更新]
        K[BillingHistory<br/>履歴記録]
    end
    
    A --> B
    A --> C
    A --> D
    
    B --> E
    C --> E
    D --> E
    
    E -->|検証OK| F
    E -->|検証NG| I
    
    F --> G
    F --> H
    
    G --> I
    G --> J
    G --> K
    
    style A fill:#95e08e
    style E fill:#ffcccc
    style F fill:#f3e5f5
    style G fill:#e8f5e9
```

---

## 7. 定期処理（バッチ処理）フロー

```mermaid
graph TB
    subgraph "HangFire定期処理"
        A[毎日 0:00]
        B[毎時 :00]
        C[毎月 1日]
    end
    
    subgraph "日次処理"
        D[トライアル期限チェック]
        E[期限切れ通知送信]
        F[課金状態同期]
    end
    
    subgraph "時次処理"
        G[Webhook再処理]
        H[エラーリトライ]
    end
    
    subgraph "月次処理"
        I[請求書生成]
        J[利用統計作成]
        K[チャーン分析]
    end
    
    A --> D
    A --> E
    A --> F
    
    B --> G
    B --> H
    
    C --> I
    C --> J
    C --> K
    
    style A fill:#fff3e0
    style B fill:#e3f2fd
    style C fill:#fce4ec
```

---

## 8. エラー処理とフォールバック

```mermaid
stateDiagram-v2
    [*] --> 課金処理開始
    
    課金処理開始 --> Shopify_API呼び出し
    
    Shopify_API呼び出し --> 成功: 200 OK
    Shopify_API呼び出し --> 失敗: Error
    
    成功 --> DB更新
    DB更新 --> 完了通知
    完了通知 --> [*]
    
    失敗 --> リトライ判定
    
    リトライ判定 --> リトライ実行: 3回未満
    リトライ判定 --> エラー記録: 3回以上
    
    リトライ実行 --> 待機
    待機 --> Shopify_API呼び出し: 2秒後
    
    エラー記録 --> 管理者通知
    エラー記録 --> ユーザー通知
    管理者通知 --> 手動対応
    ユーザー通知 --> サポート案内
    
    手動対応 --> [*]
    サポート案内 --> [*]
```

---

## 9. 実装必須タスクマトリックス

```mermaid
graph LR
    subgraph "必須実装（Must Have）"
        A[プラン作成API]
        B[課金状態確認API]
        C[Webhook受信処理]
        D[トライアル管理]
    end
    
    subgraph "重要実装（Should Have）"
        E[アップグレード処理]
        F[キャンセル処理]
        G[期限通知メール]
        H[エラーリトライ]
    end
    
    subgraph "あると良い（Nice to Have）"
        I[利用統計]
        J[請求書生成]
        K[クーポン機能]
        L[年払い対応]
    end
    
    subgraph "将来実装（Future）"
        M[従量課金]
        N[パートナー割引]
        O[アフィリエイト]
        P[多通貨対応]
    end
    
    style A fill:#ff9999
    style B fill:#ff9999
    style C fill:#ff9999
    style D fill:#ff9999
    
    style E fill:#ffcc99
    style F fill:#ffcc99
    style G fill:#ffcc99
    style H fill:#ffcc99
    
    style I fill:#99ccff
    style J fill:#99ccff
    style K fill:#99ccff
    style L fill:#99ccff
```

---

## 10. データフロー概要

```mermaid
graph TB
    subgraph "入力"
        A[ユーザー操作]
        B[Shopify Webhook]
        C[定期バッチ]
    end
    
    subgraph "処理層"
        D[認証・認可]
        E[ビジネスロジック]
        F[データ検証]
    end
    
    subgraph "データ層"
        G[(SubscriptionPlans)]
        H[(StoreSubscriptions)]
        I[(BillingHistory)]
        J[(WebhookEvents)]
    end
    
    subgraph "出力"
        K[API Response]
        L[メール通知]
        M[ログ出力]
    end
    
    A --> D
    B --> D
    C --> E
    
    D --> E
    E --> F
    F --> G
    F --> H
    F --> I
    F --> J
    
    G --> K
    H --> K
    I --> K
    
    E --> L
    F --> M
    
    style D fill:#ffcccc
    style E fill:#ccffcc
    style F fill:#ccccff
```

---

## まとめ

### ✅ 実装必須フロー
1. **初回課金フロー** - 新規ユーザーの獲得
2. **Webhook処理** - Shopifyとの同期
3. **トライアル管理** - 期限管理と通知

### 🔧 技術的要件
- Shopify GraphQL API対応
- Webhook署名検証
- 冪等性の保証
- エラーリトライ機構

### 📊 ビジネス的要件
- 透明な料金表示
- スムーズな課金体験
- 適切な通知タイミング
- キャンセル後の再開促進

---

**本ドキュメントは実装ガイドとして活用してください**