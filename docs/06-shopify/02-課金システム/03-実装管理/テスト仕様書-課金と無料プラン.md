# テスト仕様書（課金機能・無料プラン機能制限）

作成日: 2025-08-24
作成者: ERIS（PM: Kenji）
対象: QA/開発

---

## 1. テスト目的
- 課金フローと無料プラン機能選択の品質を合否基準で担保する

## 2. テスト対象
- API: `/api/feature-selection/*`, 課金作成/状態確認API
- DB: `UserFeatureSelections`, `FeatureUsageLogs`, `FeatureLimits`, `FeatureSelectionChangeHistory`
- Webhook: `app_subscriptions/update`, `app_subscriptions/cancelled`, `app/uninstalled`
- フロント: `/billing/free-plan-setup` 他

## 3. 前提条件
- TestMode=true
- 初期データ投入済（FeatureLimits）
- 認証可/StoreId 取得可能

## 4. テスト観点
- 正常系: 作成/承認/選択/変更/参照
- 制約系: 30日制限/未選択アクセス403/入力検証
- 冪等/並列: Idempotencyトークン/重複送信
- 監査/ログ: before/after/usage 記録

## 5. テストケース一覧（抜粋）

| ID | タイトル | 前提 | 手順 | 期待結果 |
|----|----------|------|------|----------|
| TC-001 | 課金作成-承認-有効化 | TestMode=true | プラン選択→承認 | status=active, Webhook受信, DB更新 |
| TC-002 | 課金アップグレード | active | 旧→新へ変更 | 旧cancel→新pending→active, 履歴整合 |
| TC-003 | 課金キャンセル | active | キャンセル実行 | status=cancelled, 期限まで利用or即制限 |
| TC-011 | 初回機能選択 | なし | 3機能から選択 | `UserFeatureSelections` 登録, canChangeToday=false |
| TC-012 | 未選択機能アクセス | 選択済 | 別機能へアクセス | 403 feature_not_available, Upgrade誘導 |
| TC-013 | 30日未満の再変更 | lastChange<30d | POST /select | 409 change_not_allowed, nextChangeDate返却 |
| TC-014 | 30日経過後の変更 | lastChange>=30d | POST /select | 成功、履歴/ログ更新 |
| TC-021 | 不正FeatureID | - | POST /select invalid | 400 invalid_feature_id |
| TC-022 | 冪等性重複送信 | 同一Token | POST /select×2 | 429 concurrent_modification |
| TC-031 | Webhook署名NG | - | 署名不一致で送信 | 401 / 処理拒否ログ |

## 6. API合否基準
- ステータスコード/エラーコードが仕様通り（409/400/429/403）
- `/current` で `canChangeToday`/`nextChangeAvailableDate` を返却
- `/select` 成功時 `newSelection.feature/activatedAt` を返却

## 7. DB合否基準
- `UserFeatureSelections`:
  - StoreId+IsActive=1 が常に1件（論理一意）
  - `NextChangeAvailableDate` はUTC基準で30日後
- `FeatureUsageLogs`:
  - 変更・未許可アクセスを記録（EventType/ResponseStatus）
- 履歴: `FeatureSelectionChangeHistory` が変更ごとに1行

## 8. Webhook合否基準
- 受信→署名検証→記録→処理→結果更新 の一連が成功
- 冪等性: 同一WebhookIdは1回のみ処理

## 9. UI合否基準
- 無料プランウィジェットに残日数/変更可否が正しく表示
- 未選択機能の画面でUpgrade誘導が表示

## 10. トレーサビリティ（要件→ケース）
- 30日制限: TC-013/TC-014
- 未選択403: TC-012
- 冪等性: TC-022
- Webhook冪等: TC-031（+重複送信）

## 11. 実施/記録方法
- ケース単位で日時/担当/結果/証跡（スクショ・ログ）を保存
- 保存先: `docs/worklog/YYYY/MM/`（日次で集計）

---
必要に応じて、全ケース版（詳細手順・入力例付き）を追加します。


