# テスト手順書（課金機能・無料プラン機能制限）

作成日: 2025-08-24
作成者: ERIS（PM: Kenji）
対象: 開発/QA/PM

> 設計方針（前提）
> - プラン選択はインストール完了（OAuth/初期設定直後）に行う。
> - 無料プランは機能選択画面へ遷移し、選択結果でゲーティングを適用する。

---

## 1. 目的と範囲
- 目的: 課金（App Subscription, GraphQL）と無料プラン機能選択（分析3機能）の動作をE2Eで検証する
- 範囲:
  - 課金: 作成/承認/更新/キャンセル/トライアル/Webhook反映
  - 無料プラン: 機能選択/変更制限(30日)/ゲーティング/使用制限ログ

## 2. 前提条件
- 開発ストア/アプリ準備済み
- TestMode=true（0円課金）
- Webhook受信可能（ngrok も可）
- マイグレーション適用済み（`UserFeatureSelections` 他）

## 3. 準備手順
1) 環境変数設定（Development）
   - `Shopify:TestMode=true`
   - `Shopify:WebhookSecret` 設定
2) Webhook登録
   - `app_subscriptions/update`, `app_subscriptions/cancelled`, `app/uninstalled`
3) DB 初期化（必要時）
   - `FeatureLimits` 初期データ投入

## 4. 課金E2Eテスト（手順）
1) インストール→初期画面表示
2) プラン選択（例: Professional $80）
3) Shopify承認画面
   - TESTラベル/$0.00 表示確認
4) 承認後、アプリ戻り
   - DB: `StoreSubscriptions` 状態 active
   - Webhook受信記録
5) アップグレード（Enterprise）
   - 旧→新への更新、Webhook2種確認
6) キャンセル
   - 状態 cancelled、ゲーティング有効

## 5. 無料プラン（機能選択）E2Eテスト（手順）
1) `/billing/free-plan-setup` で3機能から1つ選択
   - DB: `UserFeatureSelections` に IsActive=1 で登録
2) 未選択機能へアクセス
   - 403/Upgrade誘導（ミドルウェア）
3) 30日未満で変更
   - 409 change_not_allowed + nextChangeDate
4) 30日後に変更
   - 変更成功、履歴/ログ記録

## 6. 検証と記録
- 画面: ステータス/残日数/誘導表示
- API: `/api/feature-selection/*` の応答とエラーコード
- DB: `UserFeatureSelections`, `FeatureUsageLogs`, `FeatureSelectionChangeHistory`
- ログ: Webhook/アプリログ

## 7. 期待結果の例
- 課金承認後: active + confirmationUrl 消費済
- 機能選択: canChangeToday=false, nextChangeAvailableDate=UTC基準30日後
- 未選択機能アクセス: 403 feature_not_available

## 8. 不具合時の一次対応
- 署名検証エラー: WebhookSecret/時刻/改行確認
- 409多発: 直近変更時刻/30日計算/UTC確認
- 429発生: 冪等トークン重複/単一フライト化確認

## 9. 結果報告テンプレート
```
日時: YYYY-MM-DD HH:mm
環境: Development (TestMode=true)
担当: 

シナリオ: 
結果: 成功/失敗（理由）
ログ: パス/検索語
改善点:
```

---
実施後、`docs/worklog/YYYY/MM/` に記録してください。


