# 課金0円テスト完全手順書
作成日: 2025-08-24
作成者: Kenji (PM)
対象: 福田さん、テスト実施者

## 🎯 目的
実際の請求を発生させずに、課金システムの全機能をテストする

## ⚙️ 事前準備

### 1. 環境設定
```json
// appsettings.Development.json
{
  "Shopify": {
    "TestMode": true,  // 👈 これが最重要！
    "ApiKey": "YOUR_API_KEY",
    "ApiSecret": "YOUR_API_SECRET",
    "WebhookSecret": "YOUR_WEBHOOK_SECRET"
  }
}
```

併せて、GraphQLのApp Subscription作成時に`test: true`を指定します。

```graphql
mutation AppSubscriptionCreate($input: AppSubscriptionCreateInput!) {
  appSubscriptionCreate(input: $input) {
    confirmationUrl
    appSubscription { id status test }
    userErrors { field message }
  }
}
```
例（変数）:
```json
{
  "input": {
    "name": "Professional Plan",
    "returnUrl": "https://<your-app>/billing/return",
    "trialDays": 14,
    "test": true,
    "lineItems": [
      { "plan": { "appRecurringPricingDetails": { "price": { "amount": 80, "currencyCode": "USD" } } } }
    ]
  }
}
```

### 2. ngrok設定（ローカルテスト用）
```bash
# ngrokを起動
ngrok http 7140

# 生成されたURLをメモ
# 例: https://abc123.ngrok.io
```

### 3. アプリ設定更新
Shopify Partner Dashboardで:
1. App URL: `https://abc123.ngrok.io`
2. Allowed redirection URL(s): 
   - `https://abc123.ngrok.io/api/subscription/callback`
   - `https://abc123.ngrok.io/settings/billing`

## 📝 テストシナリオ

### シナリオ1: 新規インストール → 課金開始

#### 手順
1. **アプリインストール**
   ```
   テストストア管理画面 → Apps → あなたのアプリ → Install
   ```

2. **OAuth認証**
   - 権限承認画面で「Install app」をクリック

3. **初期設定画面**
   - アプリが開いたら初期設定を完了

4. **課金プラン選択**
   - 設定 → 課金管理 へ移動
   - 3つのプランが表示されることを確認
   ```
   Starter: $50/月（テストモード: $0）
   Professional: $80/月（テストモード: $0）
   Enterprise: $100/月（テストモード: $0）
   ```

5. **プラン選択**
   - 「Professional」プランの「選択」ボタンをクリック

6. **Shopify承認画面**
   - リダイレクト先で金額確認
   - **「TEST」ラベルが表示されているか確認** ✅
   - 金額が**$0.00**になっているか確認 ✅
   - 「Approve」をクリック

7. **承認後の確認**
   - アプリに戻る
   - 課金状態が「Professional (Active)」になっているか確認
   - 機能制限が解除されているか確認

#### 確認ポイント
- [ ] Shopify承認画面で「TEST」表示
- [ ] 金額が$0.00
- [ ] 承認後、DBに課金情報が保存
- [ ] Webhookが受信される
- [ ] 機能が解放される

### シナリオ2: プランアップグレード

#### 手順
1. **現在のプラン確認**
   - Professional ($0) がアクティブ

2. **アップグレード操作**
   - Enterprise プランの「アップグレード」をクリック

3. **Shopify承認画面**
   - 新プラン: Enterprise ($0.00/月)
   - 「Approve」をクリック

4. **確認**
   - プランがEnterpriseに変更
   - 追加機能が解放

#### 確認ポイント
- [ ] 旧プランが自動キャンセル
- [ ] 新プランがアクティブ化
- [ ] Webhook受信（2回: cancel + update）

### シナリオ3: トライアル期間テスト

#### 設定変更
```csharp
// バックエンドコードで一時的に変更
trial_days = 7  // 7日間のトライアル
```

#### 手順
1. **アプリ再インストール**

2. **プラン選択**
   - トライアル期間が表示されることを確認
   - 「7日間の無料トライアル」

3. **承認**
   - $0.00（トライアル期間）と表示

4. **トライアル中の確認**
   - ダッシュボードに残り日数表示
   - 「トライアル期間: あと7日」

### シナリオ4: キャンセルテスト

#### 手順
1. **キャンセル操作**
   - 設定 → 課金管理
   - 「プランをキャンセル」をクリック

2. **確認ダイアログ**
   - 「本当にキャンセルしますか？」→「はい」

3. **キャンセル後の確認**
   - プランが「Free」に変更
   - 機能が制限される
   - Webhook受信確認

### シナリオ5: Webhook受信テスト

#### 手動Webhook送信
```bash
# PowerShellまたはBashで実行
curl -X POST https://localhost:7140/api/webhook/subscriptions-update \
  -H "Content-Type: application/json" \
  -H "X-Shopify-Hmac-Sha256: [HMAC署名]" \
  -H "X-Shopify-Topic: app_subscriptions/update" \
  -H "X-Shopify-Shop-Domain: test-store.myshopify.com" \
  -d '{
    "app_subscription": {
      "id": "12345",
      "status": "ACTIVE",
      "name": "Professional",
      "price": "0.00",
      "test": true
    }
  }'
```

#### ログ確認
```bash
# Application Insightsまたはローカルログで確認
tail -f logs/webhooks.log | grep "subscription"
```

## 🔍 デバッグ方法

### 1. ブラウザ開発者ツール
```javascript
// Consoleで実行
fetch('/api/subscription/status')
  .then(r => r.json())
  .then(console.log);
```

### 2. データベース確認
```sql
-- 課金状態確認
SELECT * FROM StoreSubscriptions 
WHERE ShopDomain = 'test-store.myshopify.com';

-- Webhook履歴確認
SELECT * FROM WebhookEvents 
ORDER BY CreatedAt DESC;
```

### 3. GraphQL Playground
```graphql
# Shopify GraphQL Appで実行
{
  currentAppInstallation {
    activeSubscriptions {
      id
      name
      status
      test
      currentPeriodEnd
    }
  }
}
```

## ⚠️ 注意事項

### やってはいけないこと
- ❌ 本番ストアでTestMode=trueのまま動作させる
- ❌ WebhookSecretを公開する
- ❌ テスト中に本番環境のDBを使用する

### よくある問題と解決法

#### 問題1: 承認画面で$0にならない
**解決:** `Shopify:TestMode`が`true`か確認

#### 問題2: Webhookが受信されない
**解決:** 
- ngrok URLが正しいか確認
- Webhook登録が正しいか確認
- HMAC署名検証をスキップしてテスト

#### 問題3: 機能が解放されない
**解決:**
- DBの課金状態を確認
- キャッシュをクリア
- ブラウザをリロード

## 📊 テスト結果記録テンプレート

```markdown
## テスト実施記録
日時: 2025-08-24 14:00
実施者: [名前]
環境: Development / TestMode=true

### テスト結果
| シナリオ | 結果 | 備考 |
|---------|------|------|
| 新規インストール | ✅ | 正常動作 |
| プランアップグレード | ✅ | |
| トライアル期間 | ✅ | 7日間表示確認 |
| キャンセル | ✅ | |
| Webhook受信 | ⚠️ | 遅延あり（5秒） |

### 発見した問題
1. [問題の詳細]
2. [問題の詳細]

### 改善提案
1. [提案内容]
```

## 🚀 本番移行チェックリスト

テスト完了後、本番移行前に確認:

- [ ] TestMode=false に変更
- [ ] 本番用WebhookSecret設定
- [ ] 本番URLに変更
- [ ] マイグレーション本番適用
- [ ] 価格設定最終確認（$50/$80/$100）
- [ ] トライアル期間最終確認（7日/14日）
- [ ] エラー監視設定
- [ ] バックアップ確認

---

## 💡 Tips

### 高速テストのコツ
1. **Postmanコレクション活用**
   - API直接呼び出しで時間短縮

2. **モックデータ使用**
   ```typescript
   if (process.env.NODE_ENV === 'development') {
     return mockSubscriptionData;
   }
   ```

3. **並列テスト**
   - 複数のテストストアで同時実行

### トラブル時の連絡先
- Slackチャンネル: #billing-support
- 緊急時: Kenji, Takashi, Yuki

---

このマニュアルに従えば、安全に課金システムの全機能をテストできます。
不明な点があれば、遠慮なくお問い合わせください。

最終更新: 2025-08-24