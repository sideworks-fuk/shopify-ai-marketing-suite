<!--
  この文書は正本に統合され、参照のみとして残されています。
  最新版（正本）は以下を参照してください。
-->

> 参照先（正本）: `docs/00-production-release/03-gdpr-compliance/`
> - 仕様: `GDPR_Webhook仕様.md`
> - 実装状況: `実装状況確認と対応方針.md`
> - 計画: `実装計画書.md`

# GDPR対応 実装計画書

> **作成日**: 2025年8月24日  
> **作成者**: Kenji（AIプロジェクトマネージャー）  
> **バージョン**: 1.0  
> **優先度**: 必須（Shopifyアプリ要件）

## 1. 概要

### 1.1 背景
ShopifyアプリはGDPR（General Data Protection Regulation）に準拠する必要があり、特に必須Webhookの実装が求められています。これらのWebhookは、顧客のプライバシー権利（データアクセス、削除、更新）を保証するための重要な機能です。

### 1.2 必須要件
Shopifyアプリとして公開するために、以下の3つのWebhookエンドポイントの実装が必須です：
- `customers/data_request` - 顧客データ取得要求
- `customers/redact` - 顧客データ削除要求
- `shop/redact` - ストアデータ削除要求

## 2. 技術仕様

### 2.1 Webhook エンドポイント詳細

#### 2.1.1 customers/data_request
**目的**: 顧客が自分のデータへのアクセスを要求した際の処理

```csharp
[HttpPost("webhooks/customers/data_request")]
public async Task<IActionResult> HandleCustomerDataRequest([FromBody] CustomerDataRequestPayload payload)
{
    // 1. リクエスト検証
    // 2. 顧客データの収集
    // 3. 48時間以内にデータ提供の準備
    // 4. ログ記録
}
```

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com",
  "customer": {
    "id": 191167,
    "email": "john@example.com",
    "phone": "+16135551111"
  },
  "orders_requested": [299938, 280263, 220458]
}
```

#### 2.1.2 customers/redact
**目的**: 顧客データの削除要求処理

```csharp
[HttpPost("webhooks/customers/redact")]
public async Task<IActionResult> HandleCustomerRedact([FromBody] CustomerRedactPayload payload)
{
    // 1. リクエスト検証
    // 2. 顧客の個人識別情報を削除
    // 3. 10日以内に削除完了
    // 4. 削除記録の保持
}
```

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com",
  "customer": {
    "id": 191167,
    "email": "john@example.com",
    "phone": "+16135551111"
  },
  "orders_to_redact": [299938, 280263, 220458]
}
```

#### 2.1.3 shop/redact
**目的**: ストアがアプリをアンインストールした48時間後のデータ削除

```csharp
[HttpPost("webhooks/shop/redact")]
public async Task<IActionResult> HandleShopRedact([FromBody] ShopRedactPayload payload)
{
    // 1. リクエスト検証
    // 2. ストア関連のすべてのデータを削除
    // 3. 90日以内に削除完了
    // 4. 削除証明の記録
}
```

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com"
}
```

### 2.2 データベース設計

#### GDPRRequestsテーブル
```sql
CREATE TABLE GDPRRequests (
    Id INT PRIMARY KEY IDENTITY(1,1),
    RequestType NVARCHAR(50) NOT NULL, -- 'data_request', 'customer_redact', 'shop_redact'
    ShopId INT NOT NULL,
    ShopDomain NVARCHAR(255) NOT NULL,
    CustomerId BIGINT NULL,
    CustomerEmail NVARCHAR(255) NULL,
    RequestPayload NVARCHAR(MAX) NOT NULL, -- JSON
    Status NVARCHAR(50) NOT NULL, -- 'received', 'processing', 'completed', 'failed'
    ProcessingStartedAt DATETIME2 NULL,
    CompletedAt DATETIME2 NULL,
    ErrorMessage NVARCHAR(MAX) NULL,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE(),
    FOREIGN KEY (ShopId) REFERENCES Stores(Id)
);

-- インデックス
CREATE INDEX IX_GDPRRequests_Status ON GDPRRequests(Status);
CREATE INDEX IX_GDPRRequests_ShopId ON GDPRRequests(ShopId);
CREATE INDEX IX_GDPRRequests_CreatedAt ON GDPRRequests(CreatedAt);
```

#### DataRetentionPoliciesテーブル
```sql
CREATE TABLE DataRetentionPolicies (
    Id INT PRIMARY KEY IDENTITY(1,1),
    DataType NVARCHAR(100) NOT NULL,
    RetentionDays INT NOT NULL,
    Description NVARCHAR(500) NULL,
    IsActive BIT DEFAULT 1,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);

-- 初期データ
INSERT INTO DataRetentionPolicies (DataType, RetentionDays, Description) VALUES
('customer_personal_data', 730, '顧客の個人データは2年間保持'),
('analytics_data', 365, '分析データは1年間保持'),
('log_data', 90, 'ログデータは90日間保持'),
('deleted_record_proof', 2555, '削除証明は7年間保持');
```

## 3. 実装タスク

### Phase 1: 基盤構築（0.5日）

#### 担当: Takashi
- [ ] データベーステーブル作成
  - [ ] GDPRRequests テーブル
  - [ ] DataRetentionPolicies テーブル
  - [ ] インデックス設定
- [ ] モデルクラス作成
  - [ ] GDPRRequest エンティティ
  - [ ] DataRetentionPolicy エンティティ
- [ ] DbContext 更新

### Phase 2: Webhook実装（1日）

#### 担当: Takashi
- [ ] Webhook検証ミドルウェア作成
  - [ ] HMAC署名検証
  - [ ] リクエストボディの保存
- [ ] GDPRWebhookController 作成
  - [ ] customers/data_request エンドポイント
  - [ ] customers/redact エンドポイント
  - [ ] shop/redact エンドポイント
- [ ] ペイロードモデル作成
  - [ ] CustomerDataRequestPayload
  - [ ] CustomerRedactPayload
  - [ ] ShopRedactPayload

### Phase 3: サービス層実装（1日）

#### 担当: Takashi
- [ ] IGDPRService インターフェース定義
- [ ] GDPRService 実装
  - [ ] ProcessDataRequest メソッド
  - [ ] ProcessCustomerRedact メソッド
  - [ ] ProcessShopRedact メソッド
- [ ] データ削除サービス
  - [ ] 顧客データ削除ロジック
  - [ ] ストアデータ削除ロジック
  - [ ] 削除証明の生成

### Phase 4: バックグラウンド処理（0.5日）

#### 担当: Takashi
- [ ] Hosted Service 実装
  - [ ] GDPRRequestProcessor
  - [ ] 定期的な処理状態チェック
  - [ ] タイムアウト処理
- [ ] ジョブスケジューラー設定
  - [ ] Hangfire 設定
  - [ ] ジョブキュー管理

### Phase 5: 監査とレポート（0.5日）

#### 担当: Yuki
- [ ] 管理画面UI作成
  - [ ] GDPR要求一覧画面
  - [ ] 処理状態表示
  - [ ] エラー詳細表示
- [ ] レポート機能
  - [ ] 処理完了証明書生成
  - [ ] CSV エクスポート

### Phase 6: テストと検証（0.5日）

#### 担当: 全員
- [ ] 単体テスト作成
  - [ ] Webhook検証テスト
  - [ ] データ削除テスト
  - [ ] エラーハンドリングテスト
- [ ] 統合テスト
  - [ ] Webhook受信フロー
  - [ ] データ削除フロー
  - [ ] レポート生成フロー
- [ ] Shopify開発ストアでの検証

## 4. セキュリティ考慮事項

### 4.1 Webhook検証
```csharp
public class ShopifyWebhookValidator
{
    private readonly string _webhookSecret;
    
    public bool ValidateWebhook(string requestBody, string hmacHeader)
    {
        var hash = ComputeHash(_webhookSecret, requestBody);
        return hash == hmacHeader;
    }
    
    private string ComputeHash(string secret, string message)
    {
        var encoding = new ASCIIEncoding();
        byte[] keyByte = encoding.GetBytes(secret);
        byte[] messageBytes = encoding.GetBytes(message);
        
        using (var hmacsha256 = new HMACSHA256(keyByte))
        {
            byte[] hashmessage = hmacsha256.ComputeHash(messageBytes);
            return Convert.ToBase64String(hashmessage);
        }
    }
}
```

### 4.2 データ暗号化
- 個人情報は暗号化して保存
- 削除時は完全に復元不可能な形で削除
- 削除証明は暗号化して長期保存

### 4.3 アクセス制御
- GDPR管理画面は管理者のみアクセス可能
- APIエンドポイントはShopifyからのみ受付
- Rate limiting の実装

## 5. コンプライアンス要件

### 5.1 処理期限
| 要求タイプ | 処理期限 | 備考 |
|---------|---------|------|
| customers/data_request | 48時間 | データ準備期限 |
| customers/redact | 10日 | 削除完了期限 |
| shop/redact | 90日 | 完全削除期限 |

### 5.2 記録保持
- すべてのGDPR要求を7年間記録
- 削除証明の保管
- 監査ログの維持

### 5.3 通知要件
- データ漏洩時の72時間以内の通知
- 処理完了の自動通知
- エラー発生時の管理者通知

## 6. エラーハンドリング

### 6.1 リトライ戦略
```csharp
public class GDPRRetryPolicy
{
    private readonly int _maxRetries = 3;
    private readonly int[] _retryDelays = { 1000, 5000, 15000 }; // ミリ秒
    
    public async Task<T> ExecuteWithRetry<T>(Func<Task<T>> operation)
    {
        for (int i = 0; i < _maxRetries; i++)
        {
            try
            {
                return await operation();
            }
            catch (Exception ex)
            {
                if (i == _maxRetries - 1) throw;
                await Task.Delay(_retryDelays[i]);
            }
        }
        throw new Exception("Max retries exceeded");
    }
}
```

### 6.2 エラー通知
- Slackへの自動通知
- メール通知
- Application Insights へのログ送信

## 7. 監視とメトリクス

### 7.1 監視項目
- Webhook受信成功率
- 処理時間
- エラー率
- 未処理要求数

### 7.2 アラート設定
- 処理遅延アラート
- エラー率上昇アラート
- 未処理要求蓄積アラート

## 8. ドキュメント

### 8.1 開発者向け
- API仕様書
- データフロー図
- エラーコード一覧

### 8.2 運用者向け
- 運用マニュアル
- トラブルシューティングガイド
- 監視ダッシュボード操作

## 9. 役割分担

### Takashi（バックエンド）
- Webhook実装
- データ削除ロジック
- バックグラウンド処理
- **工数**: 3日

### Yuki（フロントエンド）
- 管理画面UI
- レポート機能
- **工数**: 0.5日

### Kenji（PM）
- 要件整理
- Shopifyとの調整
- ドキュメント作成
- **工数**: 継続的

## 10. スケジュール

```
Day 1: 基盤構築とWebhook実装
Day 2: サービス層とバックグラウンド処理
Day 3: UI実装とテスト
Day 4: Shopify検証と最終調整
```

## 11. リスクと対策

### リスク1: Shopify仕様変更
**対策**: 
- 最新ドキュメントの確認
- バージョン管理
- 後方互換性の維持

### リスク2: データ削除の失敗
**対策**:
- トランザクション管理
- ロールバック機能
- 手動削除オプション

### リスク3: 処理期限超過
**対策**:
- 早期アラート
- 自動エスカレーション
- 並列処理の実装

## 12. 成功基準

- [ ] 3つの必須Webhookが正常動作
- [ ] Shopifyの検証テストに合格
- [ ] 処理期限内の完了率 100%
- [ ] エラー率 < 0.1%
- [ ] 監査ログの完全性

---

**最終更新**: 2025年8月24日 19:45  
**レビュー予定**: 2025年8月26日  
**実装開始**: 2025年8月27日