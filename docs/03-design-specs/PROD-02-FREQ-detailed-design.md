# PROD-02-FREQ - è³¼å…¥é »åº¦åˆ†æã€å•†å“ã€‘è©³ç´°è¨­è¨ˆæ›¸

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±
- **ç”»é¢ID**: PROD-02-FREQ
- **ç”»é¢å**: è³¼å…¥é »åº¦åˆ†æã€å•†å“ã€‘(Product Purchase Frequency Analysis)
- **ä½œæˆæ—¥**: 2025-07-24
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 2ï¼ˆæ©Ÿèƒ½æ‹¡å¼µå¯¾è±¡ï¼‰

## 1. ãƒ“ã‚¸ãƒã‚¹æ¦‚è¦

### 1.1 æ©Ÿèƒ½æ¦‚è¦
å•†å“åˆ¥ã®è³¼å…¥é »åº¦åˆ†å¸ƒã‚’åˆ†æã—ã€å•†å“ã®ãƒªãƒ”ãƒ¼ãƒˆæ€§ã‚„ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ç†è§£ã‚’æ”¯æ´ã™ã‚‹æ©Ÿèƒ½ã€‚å„å•†å“ãŒã©ã®ç¨‹åº¦ãƒªãƒ”ãƒ¼ãƒˆè³¼å…¥ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’å¯è¦–åŒ–ã—ã€å•†å“æˆ¦ç•¥ã®ç«‹æ¡ˆã«æ´»ç”¨ã™ã‚‹ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½
- å•†å“åˆ¥è³¼å…¥é »åº¦åˆ†å¸ƒã®å¯è¦–åŒ–ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ»ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºï¼‰
- è³¼å…¥é »åº¦åˆ¥ã®é¡§å®¢æ•°ãƒ»å£²ä¸Šã®åˆ†æ
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã®è¨ˆç®—ï¼ˆ1å›â†’2å›ã€2å›â†’3å›ç­‰ï¼‰
- å•†å“ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æ¯”è¼ƒåˆ†æ
- æœŸé–“åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ

### 1.3 ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤
- ãƒªãƒ”ãƒ¼ãƒˆæ€§ã®é«˜ã„å•†å“ã®ç‰¹å®š
- å•†å“ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ç†è§£
- åœ¨åº«æˆ¦ç•¥ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®æœ€é©åŒ–
- å•†å“é–‹ç™ºã«ãŠã‘ã‚‹ç¤ºå”†ã®ç²å¾—
- ã‚¯ãƒ­ã‚¹ã‚»ãƒ«ãƒ»ã‚¢ãƒƒãƒ—ã‚»ãƒ«æ©Ÿä¼šã®ç™ºè¦‹

### 1.4 åˆ†ææŒ‡æ¨™
- **è³¼å…¥é »åº¦**: å„å•†å“ã‚’ä½•å›è³¼å…¥ã—ãŸé¡§å®¢ãŒã©ã‚Œã ã‘ã„ã‚‹ã‹
- **é¡§å®¢åˆ†å¸ƒ**: é »åº¦åˆ¥ã®é¡§å®¢æ•°ã¨æ§‹æˆæ¯”
- **å£²ä¸Šè²¢çŒ®**: é »åº¦åˆ¥ã®å£²ä¸Šé‡‘é¡ã¨æ§‹æˆæ¯”
- **ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡**: nå›â†’(n+1)å›ã¸ã®ç§»è¡Œç‡
- **å¹³å‡è³¼å…¥é–“éš”**: ãƒªãƒ”ãƒ¼ãƒˆè³¼å…¥ã®å¹³å‡é–“éš”

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

```sql
-- å•†å“è³¼å…¥é »åº¦åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE ProductPurchaseFrequencyAnalysis (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    ProductId NVARCHAR(100) NOT NULL,
    ProductName NVARCHAR(500) NOT NULL,
    ProductHandle NVARCHAR(500),
    Category NVARCHAR(255),
    AnalysisPeriodStart DATE NOT NULL,
    AnalysisPeriodEnd DATE NOT NULL,
    TotalCustomers INT NOT NULL DEFAULT 0,        -- ç·è³¼å…¥é¡§å®¢æ•°
    MaxFrequency INT NOT NULL DEFAULT 0,          -- æœ€å¤§è³¼å…¥é »åº¦
    AveragePurchaseInterval DECIMAL(8,2),         -- å¹³å‡è³¼å…¥é–“éš”ï¼ˆæ—¥ï¼‰
    RepeatCustomerRate DECIMAL(5,2) DEFAULT 0,    -- ãƒªãƒ”ãƒ¼ãƒˆç‡ï¼ˆ%ï¼‰
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_ProductFreq_Shop_Period (ShopDomain, AnalysisPeriodStart, AnalysisPeriodEnd),
    INDEX IX_ProductFreq_Product (ShopDomain, ProductId),
    INDEX IX_ProductFreq_Category (ShopDomain, Category)
);

-- å•†å“è³¼å…¥é »åº¦è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE ProductPurchaseFrequencyDetails (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    ProductId NVARCHAR(100) NOT NULL,
    AnalysisPeriodStart DATE NOT NULL,
    AnalysisPeriodEnd DATE NOT NULL,
    PurchaseCount INT NOT NULL,                   -- è³¼å…¥å›æ•°ï¼ˆ1, 2, 3...ï¼‰
    CustomerCount INT NOT NULL DEFAULT 0,        -- è©²å½“é¡§å®¢æ•°
    CustomerPercentage DECIMAL(5,2) DEFAULT 0,   -- é¡§å®¢æ•°æ§‹æˆæ¯”ï¼ˆ%ï¼‰
    TotalAmount DECIMAL(18,2) DEFAULT 0,         -- ç·å£²ä¸Šé‡‘é¡
    AmountPercentage DECIMAL(5,2) DEFAULT 0,     -- å£²ä¸Šæ§‹æˆæ¯”ï¼ˆ%ï¼‰
    AverageOrderValue DECIMAL(18,2) DEFAULT 0,   -- å¹³å‡æ³¨æ–‡å˜ä¾¡
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_ProductFreqDetail_Product_Period (ShopDomain, ProductId, AnalysisPeriodStart),
    INDEX IX_ProductFreqDetail_Count (ShopDomain, PurchaseCount),
    UNIQUE(ShopDomain, ProductId, AnalysisPeriodStart, AnalysisPeriodEnd, PurchaseCount)
);

-- è³¼å…¥é »åº¦ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE PurchaseFrequencyConversion (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    ProductId NVARCHAR(100) NOT NULL,
    AnalysisPeriodStart DATE NOT NULL,
    AnalysisPeriodEnd DATE NOT NULL,
    FromFrequency INT NOT NULL,                   -- å¤‰æ›å‰é »åº¦ï¼ˆ1, 2, 3...ï¼‰
    ToFrequency INT NOT NULL,                     -- å¤‰æ›å¾Œé »åº¦ï¼ˆ2, 3, 4...ï¼‰
    EligibleCustomers INT NOT NULL DEFAULT 0,    -- å¯¾è±¡é¡§å®¢æ•°
    ConvertedCustomers INT NOT NULL DEFAULT 0,   -- å¤‰æ›é¡§å®¢æ•°
    ConversionRate DECIMAL(5,2) DEFAULT 0,       -- å¤‰æ›ç‡ï¼ˆ%ï¼‰
    AverageConversionDays DECIMAL(8,2),          -- å¹³å‡å¤‰æ›æ—¥æ•°
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_FreqConversion_Product (ShopDomain, ProductId, AnalysisPeriodStart),
    INDEX IX_FreqConversion_From_To (FromFrequency, ToFrequency),
    UNIQUE(ShopDomain, ProductId, AnalysisPeriodStart, AnalysisPeriodEnd, FromFrequency, ToFrequency)
);

-- å•†å“ã‚«ãƒ†ã‚´ãƒªé »åº¦åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CategoryPurchaseFrequencyAnalysis (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    Category NVARCHAR(255) NOT NULL,
    AnalysisPeriodStart DATE NOT NULL,
    AnalysisPeriodEnd DATE NOT NULL,
    TotalProducts INT NOT NULL DEFAULT 0,        -- å¯¾è±¡å•†å“æ•°
    TotalCustomers INT NOT NULL DEFAULT 0,       -- ç·è³¼å…¥é¡§å®¢æ•°
    AverageFrequency DECIMAL(5,2) DEFAULT 0,     -- å¹³å‡è³¼å…¥é »åº¦
    MedianFrequency INT DEFAULT 0,               -- ä¸­å¤®å€¤é »åº¦
    HighFrequencyProductsCount INT DEFAULT 0,    -- é«˜é »åº¦å•†å“æ•°ï¼ˆé »åº¦3ä»¥ä¸Šï¼‰
    RepeatRate DECIMAL(5,2) DEFAULT 0,           -- ã‚«ãƒ†ã‚´ãƒªãƒªãƒ”ãƒ¼ãƒˆç‡
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CategoryFreq_Shop_Period (ShopDomain, AnalysisPeriodStart, AnalysisPeriodEnd),
    INDEX IX_CategoryFreq_Category (ShopDomain, Category)
);

-- è³¼å…¥é »åº¦ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE ProductFrequencyTrend (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    ProductId NVARCHAR(100) NOT NULL,
    AnalysisMonth DATE NOT NULL,                  -- åˆ†ææœˆï¼ˆæœˆåˆæ—¥ï¼‰
    AverageFrequency DECIMAL(5,2) DEFAULT 0,     -- å¹³å‡è³¼å…¥é »åº¦
    RepeatCustomerRate DECIMAL(5,2) DEFAULT 0,   -- ãƒªãƒ”ãƒ¼ãƒˆç‡
    NewCustomers INT DEFAULT 0,                  -- æ–°è¦é¡§å®¢æ•°
    RepeatCustomers INT DEFAULT 0,               -- ãƒªãƒ”ãƒ¼ãƒˆé¡§å®¢æ•°
    TrendDirection NVARCHAR(20),                 -- Up/Down/Stable
    TrendStrength DECIMAL(5,2),                  -- ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_ProductTrend_Product_Month (ShopDomain, ProductId, AnalysisMonth),
    INDEX IX_ProductTrend_Month (ShopDomain, AnalysisMonth)
);
```

### 2.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
- å•†å“åˆ¥ãƒ»æœŸé–“åˆ¥æ¤œç´¢ã®æœ€é©åŒ–
- è³¼å…¥é »åº¦ã«ã‚ˆã‚‹é›†è¨ˆã‚¯ã‚¨ãƒªã®é«˜é€ŸåŒ–
- ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆ†æã®åŠ¹ç‡åŒ–
- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã®ãŸã‚ã®æ™‚ç³»åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

## 3. APIè¨­è¨ˆ

### 3.1 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å®šç¾©

```csharp
[ApiController]
[Route("api/analysis/product-purchase-frequency")]
public class ProductPurchaseFrequencyController : ControllerBase
{
    private readonly IProductPurchaseFrequencyService _frequencyService;
    private readonly ILogger<ProductPurchaseFrequencyController> _logger;

    [HttpGet]
    public async Task<IActionResult> GetProductPurchaseFrequency(
        [FromQuery] ProductPurchaseFrequencyRequest request)
    {
        // å•†å“è³¼å…¥é »åº¦åˆ†æã®å–å¾—
    }

    [HttpGet("category-comparison")]
    public async Task<IActionResult> GetCategoryComparison(
        [FromQuery] CategoryComparisonRequest request)
    {
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¯”è¼ƒåˆ†æ
    }

    [HttpGet("conversion-analysis")]
    public async Task<IActionResult> GetConversionAnalysis(
        [FromQuery] ConversionAnalysisRequest request)
    {
        // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ†æã®å–å¾—
    }

    [HttpGet("trend-analysis")]
    public async Task<IActionResult> GetTrendAnalysis(
        [FromQuery] TrendAnalysisRequest request)
    {
        // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã®å–å¾—
    }

    [HttpPost("calculate")]
    public async Task<IActionResult> CalculateFrequencyAnalysis(
        [FromBody] CalculateFrequencyRequest request)
    {
        // é »åº¦åˆ†æã®å†è¨ˆç®—
    }

    [HttpGet("export")]
    public async Task<IActionResult> ExportFrequencyAnalysis(
        [FromQuery] ProductPurchaseFrequencyRequest request)
    {
        // CSV/Excel ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    }
}
```

### 3.2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO

```csharp
// ãƒ¡ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆDTO
public class ProductPurchaseFrequencyRequest
{
    public int StartYear { get; set; }
    public int StartMonth { get; set; }
    public int EndYear { get; set; }
    public int EndMonth { get; set; }
    public string ProductFilter { get; set; } = "all";         // all|top10|category|custom
    public string CategoryId { get; set; }                     // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    public List<string> ProductIds { get; set; }               // ã‚«ã‚¹ã‚¿ãƒ å•†å“é¸æŠ
    public int MaxFrequency { get; set; } = 12;                // è¡¨ç¤ºæœ€å¤§é »åº¦
    public string DisplayMode { get; set; } = "count";         // count|percentage
    public string ViewType { get; set; } = "heatmap";          // heatmap|chart|table
    public bool IncludeConversion { get; set; } = true;        // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ†æã‚’å«ã‚€
    public bool IncludeTrend { get; set; } = false;            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’å«ã‚€
}

// ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO
public class ProductPurchaseFrequencyResponse
{
    public List<ProductFrequencyData> Products { get; set; }
    public FrequencyAnalysisSummary Summary { get; set; }
    public List<ConversionData> Conversions { get; set; }
    public List<CategoryComparisonData> CategoryComparison { get; set; }
    public FrequencyAnalysisMetadata Metadata { get; set; }
}

// å•†å“é »åº¦ãƒ‡ãƒ¼ã‚¿
public class ProductFrequencyData
{
    public string ProductId { get; set; }
    public string ProductName { get; set; }
    public string ProductHandle { get; set; }
    public string Category { get; set; }
    public int TotalCustomers { get; set; }
    public decimal RepeatCustomerRate { get; set; }            // ãƒªãƒ”ãƒ¼ãƒˆç‡ï¼ˆ%ï¼‰
    public decimal AveragePurchaseInterval { get; set; }       // å¹³å‡è³¼å…¥é–“éš”
    public List<FrequencyDistribution> Frequencies { get; set; }
}

// é »åº¦åˆ†å¸ƒãƒ‡ãƒ¼ã‚¿
public class FrequencyDistribution
{
    public int Count { get; set; }                             // è³¼å…¥å›æ•°
    public int Customers { get; set; }                         // é¡§å®¢æ•°
    public decimal Percentage { get; set; }                    // æ§‹æˆæ¯”ï¼ˆ%ï¼‰
    public decimal TotalAmount { get; set; }                   // ç·å£²ä¸Š
    public decimal AmountPercentage { get; set; }              // å£²ä¸Šæ§‹æˆæ¯”ï¼ˆ%ï¼‰
    public decimal AverageOrderValue { get; set; }             // å¹³å‡æ³¨æ–‡å˜ä¾¡
}

// ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
public class ConversionData
{
    public string ProductId { get; set; }
    public string ProductName { get; set; }
    public List<FrequencyConversionRate> ConversionRates { get; set; }
}

public class FrequencyConversionRate
{
    public int FromFrequency { get; set; }                     // å¤‰æ›å‰ï¼ˆ1, 2, 3...ï¼‰
    public int ToFrequency { get; set; }                       // å¤‰æ›å¾Œï¼ˆ2, 3, 4...ï¼‰
    public int EligibleCustomers { get; set; }                // å¯¾è±¡é¡§å®¢æ•°
    public int ConvertedCustomers { get; set; }               // å¤‰æ›é¡§å®¢æ•°
    public decimal ConversionRate { get; set; }               // å¤‰æ›ç‡ï¼ˆ%ï¼‰
    public decimal AverageConversionDays { get; set; }        // å¹³å‡å¤‰æ›æ—¥æ•°
}

// ã‚«ãƒ†ã‚´ãƒªæ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
public class CategoryComparisonData
{
    public string Category { get; set; }
    public int ProductCount { get; set; }
    public int TotalCustomers { get; set; }
    public decimal AverageFrequency { get; set; }
    public decimal MedianFrequency { get; set; }
    public decimal RepeatRate { get; set; }
    public int HighFrequencyProducts { get; set; }             // é »åº¦3ä»¥ä¸Šã®å•†å“æ•°
}

// åˆ†æã‚µãƒãƒªãƒ¼
public class FrequencyAnalysisSummary
{
    public int TotalProducts { get; set; }
    public int TotalCustomers { get; set; }
    public decimal OverallRepeatRate { get; set; }
    public decimal AverageFrequency { get; set; }
    public int HighFrequencyProducts { get; set; }             // é »åº¦3ä»¥ä¸Š
    public string TopCategory { get; set; }                   // æœ€é«˜ãƒªãƒ”ãƒ¼ãƒˆç‡ã‚«ãƒ†ã‚´ãƒª
    public decimal TopCategoryRepeatRate { get; set; }
    public List<string> Insights { get; set; }                // åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ
}

// åˆ†æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
public class FrequencyAnalysisMetadata
{
    public DateTime AnalysisDate { get; set; }
    public DateTime PeriodStart { get; set; }
    public DateTime PeriodEnd { get; set; }
    public int AnalysisPeriodMonths { get; set; }
    public string ProductFilter { get; set; }
    public int MaxFrequency { get; set; }
    public string DataQuality { get; set; }                   // Good|Warning|Poor
    public List<string> Warnings { get; set; }
}
```

### 3.3 ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```csharp
public interface IProductPurchaseFrequencyService
{
    Task<ProductPurchaseFrequencyResponse> GetProductPurchaseFrequencyAsync(
        string shopDomain,
        ProductPurchaseFrequencyRequest request);

    Task<List<CategoryComparisonData>> GetCategoryComparisonAsync(
        string shopDomain,
        CategoryComparisonRequest request);

    Task<List<ConversionData>> GetConversionAnalysisAsync(
        string shopDomain,
        ConversionAnalysisRequest request);

    Task<List<ProductFrequencyTrendData>> GetTrendAnalysisAsync(
        string shopDomain,
        TrendAnalysisRequest request);

    Task<Guid> StartFrequencyCalculationAsync(
        string shopDomain,
        CalculateFrequencyRequest request);

    Task<byte[]> ExportFrequencyAnalysisAsync(
        string shopDomain,
        ProductPurchaseFrequencyRequest request,
        ExportFormat format);
}
```

## 4. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

### 4.1 é »åº¦åˆ†æã‚µãƒ¼ãƒ“ã‚¹

```csharp
public class ProductPurchaseFrequencyService : IProductPurchaseFrequencyService
{
    private readonly ShopifyDbContext _context;
    private readonly ILogger<ProductPurchaseFrequencyService> _logger;
    private readonly IMemoryCache _cache;

    public async Task<ProductPurchaseFrequencyResponse> GetProductPurchaseFrequencyAsync(
        string shopDomain,
        ProductPurchaseFrequencyRequest request)
    {
        // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        var cacheKey = GenerateCacheKey(shopDomain, request);
        if (_cache.TryGetValue(cacheKey, out ProductPurchaseFrequencyResponse cachedResult))
        {
            return cachedResult;
        }

        // 2. åˆ†ææœŸé–“ã®æ±ºå®š
        var periodStart = new DateTime(request.StartYear, request.StartMonth, 1);
        var periodEnd = new DateTime(request.EndYear, request.EndMonth, 1).AddMonths(1).AddDays(-1);

        // 3. å¯¾è±¡å•†å“ã®å–å¾—
        var targetProducts = await GetTargetProductsAsync(shopDomain, request);

        // 4. å•†å“åˆ¥é »åº¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        var frequencyData = await GetProductFrequencyDataAsync(
            shopDomain, targetProducts, periodStart, periodEnd, request.MaxFrequency);

        // 5. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        List<ConversionData> conversions = null;
        if (request.IncludeConversion)
        {
            conversions = await GetConversionDataAsync(
                shopDomain, targetProducts, periodStart, periodEnd);
        }

        // 6. ã‚«ãƒ†ã‚´ãƒªæ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        var categoryComparison = await GetCategoryComparisonAsync(
            shopDomain, periodStart, periodEnd);

        // 7. ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
        var summary = CalculateFrequencyAnalysisSummary(frequencyData, categoryComparison);

        // 8. çµæœã®æ§‹ç¯‰
        var response = new ProductPurchaseFrequencyResponse
        {
            Products = frequencyData,
            Summary = summary,
            Conversions = conversions,
            CategoryComparison = categoryComparison,
            Metadata = BuildAnalysisMetadata(request, periodStart, periodEnd)
        };

        // 9. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        _cache.Set(cacheKey, response, TimeSpan.FromHours(2));

        return response;
    }

    private async Task<List<ProductFrequencyData>> GetProductFrequencyDataAsync(
        string shopDomain,
        List<string> productIds,
        DateTime periodStart,
        DateTime periodEnd,
        int maxFrequency)
    {
        var query = @"
            WITH CustomerPurchaseCounts AS (
                SELECT 
                    oi.ProductId,
                    o.CustomerId,
                    COUNT(DISTINCT o.Id) as PurchaseCount,
                    SUM(oi.Price * oi.Quantity) as TotalAmount
                FROM Orders o
                INNER JOIN OrderItems oi ON o.Id = oi.OrderId
                WHERE o.ShopDomain = @ShopDomain
                  AND o.CreatedAt BETWEEN @PeriodStart AND @PeriodEnd
                  AND oi.ProductId IN ({0})
                GROUP BY oi.ProductId, o.CustomerId
            ),
            ProductFrequencyDistribution AS (
                SELECT 
                    cpc.ProductId,
                    cpc.PurchaseCount,
                    COUNT(cpc.CustomerId) as CustomerCount,
                    SUM(cpc.TotalAmount) as TotalAmount
                FROM CustomerPurchaseCounts cpc
                WHERE cpc.PurchaseCount <= @MaxFrequency
                GROUP BY cpc.ProductId, cpc.PurchaseCount
            )
            SELECT 
                p.Id as ProductId,
                p.Title as ProductName,
                p.Handle as ProductHandle,
                p.ProductType as Category,
                pfd.PurchaseCount,
                pfd.CustomerCount,
                pfd.TotalAmount,
                total_customers.TotalCustomers
            FROM Products p
            INNER JOIN ProductFrequencyDistribution pfd ON p.Id = pfd.ProductId
            CROSS APPLY (
                SELECT COUNT(DISTINCT cpc.CustomerId) as TotalCustomers
                FROM CustomerPurchaseCounts cpc 
                WHERE cpc.ProductId = p.Id
            ) total_customers
            WHERE p.ShopDomain = @ShopDomain
            ORDER BY p.Title, pfd.PurchaseCount";

        var productIdParams = string.Join(",", productIds.Select((_, i) => $"@ProductId{i}"));
        var formattedQuery = string.Format(query, productIdParams);

        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@ShopDomain", shopDomain),
            new SqlParameter("@PeriodStart", periodStart),
            new SqlParameter("@PeriodEnd", periodEnd),
            new SqlParameter("@MaxFrequency", maxFrequency)
        };

        // å•†å“IDãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        for (int i = 0; i < productIds.Count; i++)
        {
            parameters.Add(new SqlParameter($"@ProductId{i}", productIds[i]));
        }

        var results = await _context.Database
            .SqlQueryRaw<ProductFrequencyRawData>(formattedQuery, parameters.ToArray())
            .ToListAsync();

        // çµæœã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ProductFrequencyDataã«å¤‰æ›
        return results
            .GroupBy(r => new { r.ProductId, r.ProductName, r.ProductHandle, r.Category, r.TotalCustomers })
            .Select(g => new ProductFrequencyData
            {
                ProductId = g.Key.ProductId,
                ProductName = g.Key.ProductName,
                ProductHandle = g.Key.ProductHandle,
                Category = g.Key.Category,
                TotalCustomers = g.Key.TotalCustomers,
                RepeatCustomerRate = CalculateRepeatRate(g.ToList()),
                AveragePurchaseInterval = CalculateAveragePurchaseInterval(g.Key.ProductId, periodStart, periodEnd),
                Frequencies = g.Select(r => new FrequencyDistribution
                {
                    Count = r.PurchaseCount,
                    Customers = r.CustomerCount,
                    Percentage = Math.Round((decimal)r.CustomerCount / g.Key.TotalCustomers * 100, 1),
                    TotalAmount = r.TotalAmount,
                    AmountPercentage = CalculateAmountPercentage(r.TotalAmount, g.Sum(x => x.TotalAmount)),
                    AverageOrderValue = Math.Round(r.TotalAmount / r.CustomerCount, 2)
                }).OrderBy(f => f.Count).ToList()
            })
            .ToList();
    }

    private decimal CalculateRepeatRate(List<ProductFrequencyRawData> frequencyData)
    {
        var totalCustomers = frequencyData.First().TotalCustomers;
        var repeatCustomers = frequencyData.Where(f => f.PurchaseCount > 1).Sum(f => f.CustomerCount);
        
        return totalCustomers > 0 ? Math.Round((decimal)repeatCustomers / totalCustomers * 100, 1) : 0;
    }

    private async Task<List<ConversionData>> GetConversionDataAsync(
        string shopDomain,
        List<string> productIds,
        DateTime periodStart,
        DateTime periodEnd)
    {
        var conversions = new List<ConversionData>();

        foreach (var productId in productIds)
        {
            var conversionRates = await CalculateConversionRatesAsync(
                shopDomain, productId, periodStart, periodEnd);

            if (conversionRates.Any())
            {
                var product = await _context.Products
                    .FirstOrDefaultAsync(p => p.ShopDomain == shopDomain && p.Id == productId);

                conversions.Add(new ConversionData
                {
                    ProductId = productId,
                    ProductName = product?.Title ?? "Unknown",
                    ConversionRates = conversionRates
                });
            }
        }

        return conversions;
    }

    private async Task<List<FrequencyConversionRate>> CalculateConversionRatesAsync(
        string shopDomain,
        string productId,
        DateTime periodStart,
        DateTime periodEnd)
    {
        // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡è¨ˆç®—ã®ãƒ­ã‚¸ãƒƒã‚¯
        // 1å›è³¼å…¥â†’2å›è³¼å…¥ã€2å›è³¼å…¥â†’3å›è³¼å…¥ã€ç­‰ã®å¤‰æ›ç‡ã‚’è¨ˆç®—
        var conversionRates = new List<FrequencyConversionRate>();

        for (int fromFreq = 1; fromFreq <= 5; fromFreq++)
        {
            var toFreq = fromFreq + 1;

            var conversionData = await CalculateSpecificConversionAsync(
                shopDomain, productId, fromFreq, toFreq, periodStart, periodEnd);

            if (conversionData.EligibleCustomers > 0)
            {
                conversionRates.Add(conversionData);
            }
        }

        return conversionRates;
    }
}
```

### 4.2 é »åº¦è¨ˆç®—ãƒãƒƒãƒã‚µãƒ¼ãƒ“ã‚¹

```csharp
public class FrequencyCalculationBatchService
{
    public async Task CalculateMonthlyFrequencyDataAsync(
        string shopDomain,
        DateTime targetMonth)
    {
        // 1. åˆ†ææœŸé–“ã®æ±ºå®šï¼ˆéå»12ãƒ¶æœˆï¼‰
        var analysisStart = targetMonth.AddMonths(-12);
        var analysisEnd = targetMonth.AddDays(-1);

        // 2. å¯¾è±¡å•†å“ã®å–å¾—
        var products = await GetActiveProductsAsync(shopDomain);

        // 3. å•†å“åˆ¥é »åº¦åˆ†æã®å®Ÿè¡Œ
        await Parallel.ForEachAsync(products, 
            new ParallelOptions { MaxDegreeOfParallelism = 4 },
            async (product, cancellationToken) =>
            {
                await CalculateProductFrequencyAsync(
                    shopDomain, product.Id, analysisStart, analysisEnd, targetMonth);
            });

        // 4. ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆã®å®Ÿè¡Œ
        await CalculateCategoryFrequencyAsync(shopDomain, targetMonth);

        // 5. ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã®è¨ˆç®—
        await CalculateConversionRatesAsync(shopDomain, targetMonth);
    }
}
```

## 5. Shopifyé€£æº

### 5.1 ãƒ‡ãƒ¼ã‚¿åŒæœŸæˆ¦ç•¥

```csharp
public class ShopifyFrequencyDataSync
{
    public async Task SyncProductFrequencyDataAsync(
        string shopDomain,
        DateTime startDate,
        DateTime endDate)
    {
        // 1. å•†å“ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        await SyncProductCatalogAsync(shopDomain);

        // 2. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        await SyncOrderDataAsync(shopDomain, startDate, endDate);

        // 3. é »åº¦åˆ†æã®äº‹å‰è¨ˆç®—
        await PreCalculateFrequencyDataAsync(shopDomain, startDate, endDate);
    }
}
```

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### 6.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- å•†å“åˆ¥é »åº¦ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ4æ™‚é–“ï¼‰
- ã‚«ãƒ†ã‚´ãƒªæ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ2æ™‚é–“ï¼‰
- ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ6æ™‚é–“ï¼‰

### 6.2 ã‚¯ã‚¨ãƒªæœ€é©åŒ–
- å•†å“ãƒ»æœŸé–“ãƒ»é »åº¦ã«ã‚ˆã‚‹è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- é›†è¨ˆã‚¯ã‚¨ãƒªã®äº‹å‰è¨ˆç®—
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã®æ¤œè¨

### 6.3 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- å¤§é‡å•†å“ãƒ‡ãƒ¼ã‚¿ã®ä¸¦åˆ—å‡¦ç†
- çµæœã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œ
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’è€ƒæ…®ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```csharp
public enum FrequencyAnalysisError
{
    InsufficientProductData,     // å•†å“ãƒ‡ãƒ¼ã‚¿ä¸è¶³
    InvalidFrequencyRange,       // ç„¡åŠ¹ãªé »åº¦ç¯„å›²
    CalculationTimeout,          // è¨ˆç®—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    CategoryNotFound            // ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚‰ãªã„
}
```

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- å•†å“ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã®åŒ¿ååŒ–

## 9. ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### Phase 3ã§ã®æ©Ÿèƒ½è¿½åŠ 
- å­£ç¯€æ€§ã‚’è€ƒæ…®ã—ãŸé »åº¦åˆ†æ
- å•†å“ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«äºˆæ¸¬
- ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸé »åº¦åˆ†æ
- ç«¶åˆå•†å“ã¨ã®æ¯”è¼ƒåˆ†æ

## âš ï¸ 10. è¨­è¨ˆä¸Šã®æ³¨æ„äº‹é …ãƒ»åˆ¶ç´„

### 10.1 è¨­è¨ˆéå‰°ã®è­¦å‘Š âš ï¸ **è¨­è¨ˆè¦‹ç›´ã—æ¨å¥¨**

#### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å•é¡Œ**
- **ãƒ†ãƒ¼ãƒ–ãƒ«éå¤š**: 5ã¤ã®å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¯éå‰°è¨­è¨ˆ
- **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é‡è¤‡**: OrderItemãƒ†ãƒ¼ãƒ–ãƒ«ã§ååˆ†å¯¾å¿œå¯èƒ½
- **æ­£è¦åŒ–ã®å•é¡Œ**: å•†å“ãƒ»é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ä¿å­˜

```sql
-- å•é¡Œ: ä¸è¦ã«è¤‡é›‘ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
-- ProductPurchaseFrequencyAnalysis
-- ProductPurchaseFrequencyDetails
-- PurchaseFrequencyConversion
-- CategoryPurchaseFrequencyAnalysis
-- ProductFrequencyTrend
-- â†’ æ—¢å­˜ã®Order/OrderItemã§è¨ˆç®—å¯èƒ½
```

#### **æ¨å¥¨ã•ã‚Œã‚‹ç°¡ç´ åŒ–ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
```csharp
// æ¨å¥¨: æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨ã«ã‚ˆã‚‹å‹•çš„è¨ˆç®—
public class SimplifiedProductFrequencyService
{
    // OrderItemãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç›´æ¥è¨ˆç®—
    public async Task<ProductFrequencyData> CalculateFrequencyAsync(string productId, DateRange period)
    {
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®é›†è¨ˆè¨ˆç®—
    }
}
```

### 10.2 ä»–æ©Ÿèƒ½ã¨ã®é‡è¤‡ ğŸ”„ **çµ±åˆæ¤œè¨å¿…è¦**

#### **é¡ä¼¼æ©Ÿèƒ½ã¨ã®é‡è¤‡**
- **PURCH-02-COUNT**: è³¼å…¥å›æ•°åˆ†æã¨90%ã®æ©Ÿèƒ½é‡è¤‡
- **PROD-03-BASKET**: å•†å“çµ„ã¿åˆã‚ã›åˆ†æã®åŸºç¤ãƒ‡ãƒ¼ã‚¿å…±é€š
- **PURCH-03-FTIER**: é¡§å®¢é »åº¦åˆ†æã¨ã®å¢ƒç•Œæ›–æ˜§

#### **çµ±åˆå¯èƒ½æ€§ã®æ¤œè¨**
```typescript
interface FunctionMergeOpportunity {
  merge_with_PURCH_02_COUNT: {
    overlap: '90%';
    suggestion: 'è³¼å…¥å›æ•°åˆ†æã«å•†å“åˆ¥ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ ';
    benefit: 'ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šæ¸›ã€å®Ÿè£…å·¥æ•°åŠæ¸›';
  };
}
```

### 10.3 APIè¨­è¨ˆã®ä¸æ•´åˆ

#### **å‘½åè¦å‰‡ã®å•é¡Œ**
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/analysis/product-purchase-frequency` ãŒä»–ç”»é¢ã¨ä¸çµ±ä¸€
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ **: ç‹¬è‡ªå½¢å¼ã§ãªãå…±é€šDTOãƒ‘ã‚¿ãƒ¼ãƒ³ä½¿ç”¨æ¨å¥¨

#### **æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**
```csharp
// ä¿®æ­£å‰: ç‹¬è‡ªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
[Route("api/analysis/product-purchase-frequency")]

// ä¿®æ­£å¾Œ: çµ±ä¸€ã•ã‚ŒãŸæ§‹é€ 
[Route("api/analytics/product-frequency")]  // å‘½åçµ±ä¸€
public class ProductAnalyticsController      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼çµ±åˆ
```

### 10.4 å®Ÿè£…å„ªå…ˆåº¦ã®èª¿æ•´

#### **å…ƒã®è¨ˆç”»**: Phase 2ï¼ˆæ©Ÿèƒ½æ‹¡å¼µå¯¾è±¡ï¼‰
#### **ä¿®æ­£æ¨å¥¨**: Phase 3 ã¾ãŸã¯ PURCH-02-COUNT ã¨ã®çµ±åˆ

**ç†ç”±**: 
1. æ©Ÿèƒ½é‡è¤‡ãŒå¤šãç‹¬ç«‹å®Ÿè£…ã®ä¾¡å€¤ãŒä½ã„
2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒéå‰°ã§ä¿å®ˆæ€§ã«å•é¡Œ
3. ä»–æ©Ÿèƒ½ã®åŸºç›¤ç¢ºç«‹å¾Œã®çµ±åˆå®Ÿè£…ãŒåŠ¹ç‡çš„

### 10.5 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®æ•´åˆæ€§ç¢ºèª

#### **UIè¦ä»¶ã¨ã®é½Ÿé½¬**
- **ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®è¡¨ç¤ºæ€§èƒ½å•é¡Œ
- **å•†å“é¸æŠUI**: ã‚«ã‚¹ã‚¿ãƒ å•†å“é¸æŠã®è¤‡é›‘æ€§
- **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ¡ãƒ¢ãƒªåˆ¶ç´„

#### **æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ**
1. **è¡¨ç¤ºå•†å“æ•°åˆ¶é™**: ä¸Šä½100å•†å“ã®ã¿è¡¨ç¤º
2. **ãƒšãƒ¼ã‚¸ãƒ³ã‚°å®Ÿè£…**: å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
3. **éåŒæœŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†

### 10.6 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶ç´„ã®æ˜ç¢ºåŒ–

#### **è¨ˆç®—é‡ã®å•é¡Œ**
- **å…¨å•†å“Ã—å…¨æœŸé–“**: 1000å•†å“Ã—24ãƒ¶æœˆã§24,000å›ã®è¨ˆç®—
- **é¡§å®¢åˆ¥é›†è¨ˆ**: 10,000é¡§å®¢ã§ã®å€‹åˆ¥å‡¦ç†
- **ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡è¨ˆç®—**: è¤‡é›‘ãªæ™‚ç³»åˆ—åˆ†æ

#### **å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹**
```csharp
// è­¦å‘Š: æ€§èƒ½å•é¡ŒãŒç™ºç”Ÿã—ã‚„ã™ã„å‡¦ç†
// 1å•†å“ã‚ãŸã‚Šå¹³å‡1000é¡§å®¢Ã—12é »åº¦ = 12,000ãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†
// ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¨ã‚¯ã‚¨ãƒªæ™‚é–“ã®æœ€é©åŒ–å¿…é ˆ
```

**çµè«–**: ã“ã®æ©Ÿèƒ½ã¯è¨­è¨ˆã‚’å¤§å¹…ã«ç°¡ç´ åŒ–ã—ã€ä»–æ©Ÿèƒ½ã¨ã®çµ±åˆã‚’æ¤œè¨ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨