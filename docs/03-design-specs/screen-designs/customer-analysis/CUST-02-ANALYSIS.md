# CUST-02-ANALYSIS - é¡§å®¢è³¼è²·åˆ†æã€é¡§å®¢ã€‘è©³ç´°è¨­è¨ˆæ›¸

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±
- **ç”»é¢ID**: CUST-02-ANALYSIS
- **ç”»é¢å**: é¡§å®¢è³¼è²·åˆ†æã€é¡§å®¢ã€‘(Customer Purchase Analysis)
- **ä½œæˆæ—¥**: 2025-07-24
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 3ï¼ˆå°†æ¥æ‹¡å¼µå¯¾è±¡ï¼‰

## 1. ãƒ“ã‚¸ãƒã‚¹æ¦‚è¦

### 1.1 æ©Ÿèƒ½æ¦‚è¦
å€‹åˆ¥é¡§å®¢ã®è³¼è²·è¡Œå‹•ã‚’æ·±ãåˆ†æã—ã€é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€LTVï¼ˆLife Time Valueï¼‰è¨ˆç®—ã€RFMåˆ†æã‚’é€šã˜ã¦ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®ç«‹æ¡ˆã‚’æ”¯æ´ã™ã‚‹æ©Ÿèƒ½ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½
- é¡§å®¢è©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º
- RFMã‚¹ã‚³ã‚¢ï¼ˆRecency, Frequency, Monetaryï¼‰ã®è¨ˆç®—ã¨å¯è¦–åŒ–
- é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆVIPã€ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ã€æ–°è¦ã€ä¼‘çœ ç­‰ï¼‰
- è³¼è²·å•†å“ã®å‚¾å‘åˆ†æ
- LTVäºˆæ¸¬ã¨ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯è©•ä¾¡
- ç•°å¸¸è³¼è²·è¡Œå‹•ã®æ¤œå‡º

### 1.3 ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤
- å€‹åˆ¥é¡§å®¢ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ã®å®Ÿæ–½
- é«˜ä¾¡å€¤é¡§å®¢ã®ç‰¹å®šã¨ç¶­æŒæˆ¦ç•¥ã®ç«‹æ¡ˆ
- ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯ã®æ—©æœŸç™ºè¦‹ã¨å¯¾ç­–
- ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå•†å“æ¨è–¦
- é¡§å®¢ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã®æœ€é©åŒ–

### 1.4 åˆ†ææŒ‡æ¨™
- **RFMã‚¹ã‚³ã‚¢**: Recencyï¼ˆæœ€æ–°æ€§ï¼‰ã€Frequencyï¼ˆé »åº¦ï¼‰ã€Monetaryï¼ˆé‡‘é¡ï¼‰
- **LTV**: é¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ã®äºˆæ¸¬å€¤
- **ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: è³¼è²·è¡Œå‹•ã«åŸºã¥ãé¡§å®¢åˆ†é¡
- **å•†å“è¦ªå’Œæ€§**: é¡§å®¢ã®å•†å“ã‚«ãƒ†ã‚´ãƒªå‚¾å‘
- **ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯**: é›¢è„±å¯èƒ½æ€§ã®äºˆæ¸¬

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

```sql
-- é¡§å®¢è³¼è²·åˆ†æãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CustomerPurchaseAnalysis (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    CustomerId NVARCHAR(100) NOT NULL,
    CustomerName NVARCHAR(500),
    Email NVARCHAR(255),
    PhoneNumber NVARCHAR(50),
    AnalysisDate DATE NOT NULL,
    CustomerStatus NVARCHAR(50) NOT NULL,              -- Active|Inactive|VIP|New|Dormant
    
    -- RFMåˆ†æé–¢é€£
    RecencyScore INT NOT NULL DEFAULT 0,               -- 1-5ã‚¹ã‚³ã‚¢
    FrequencyScore INT NOT NULL DEFAULT 0,             -- 1-5ã‚¹ã‚³ã‚¢
    MonetaryScore INT NOT NULL DEFAULT 0,              -- 1-5ã‚¹ã‚³ã‚¢
    RFMSegment NVARCHAR(50),                           -- Champions|Loyal Customers|ç­‰
    
    -- è³¼è²·å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿
    TotalOrders INT NOT NULL DEFAULT 0,
    TotalAmount DECIMAL(18,2) NOT NULL DEFAULT 0,
    AverageOrderValue DECIMAL(18,2) NOT NULL DEFAULT 0,
    FirstOrderDate DATETIME2,
    LastOrderDate DATETIME2,
    DaysSinceLastOrder INT,
    AverageDaysBetweenOrders DECIMAL(8,2),
    
    -- LTVé–¢é€£
    HistoricalLTV DECIMAL(18,2) NOT NULL DEFAULT 0,    -- å®Ÿç¸¾LTV
    PredictedLTV DECIMAL(18,2),                        -- äºˆæ¸¬LTV
    LTVRank INT,                                       -- LTVãƒ©ãƒ³ã‚­ãƒ³ã‚°
    
    -- ãƒªã‚¹ã‚¯è©•ä¾¡
    ChurnRiskScore DECIMAL(5,2) DEFAULT 0,             -- 0-100ã‚¹ã‚³ã‚¢
    ChurnRiskLevel NVARCHAR(20),                       -- Low|Medium|High|Critical
    
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CustomerAnalysis_Shop_Customer (ShopDomain, CustomerId),
    INDEX IX_CustomerAnalysis_Status (ShopDomain, CustomerStatus, AnalysisDate),
    INDEX IX_CustomerAnalysis_RFM (RFMSegment, AnalysisDate),
    INDEX IX_CustomerAnalysis_LTV (LTVRank, PredictedLTV DESC),
    INDEX IX_CustomerAnalysis_ChurnRisk (ChurnRiskLevel, ChurnRiskScore DESC)
);

-- é¡§å®¢å•†å“è¦ªå’Œæ€§ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CustomerProductAffinity (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    CustomerId NVARCHAR(100) NOT NULL,
    AnalysisDate DATE NOT NULL,
    ProductId NVARCHAR(100) NOT NULL,
    ProductName NVARCHAR(500),
    Category NVARCHAR(255),
    PurchaseCount INT NOT NULL DEFAULT 0,
    TotalAmount DECIMAL(18,2) NOT NULL DEFAULT 0,
    AffinityScore DECIMAL(5,2) DEFAULT 0,               -- 0-100è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢
    IsTopProduct BIT NOT NULL DEFAULT 0,               -- ãƒˆãƒƒãƒ—å•†å“ãƒ•ãƒ©ã‚°
    LastPurchaseDate DATETIME2,
    AverageDaysBetweenPurchases DECIMAL(8,2),
    RepurchaseProbability DECIMAL(5,2),                -- å†è³¼å…¥ç¢ºç‡ï¼ˆ%ï¼‰
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CustomerAffinity_Customer (ShopDomain, CustomerId, AnalysisDate),
    INDEX IX_CustomerAffinity_Product (ShopDomain, ProductId),
    INDEX IX_CustomerAffinity_Score (AffinityScore DESC, IsTopProduct),
    UNIQUE(ShopDomain, CustomerId, ProductId, AnalysisDate)
);

-- é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CustomerSegmentationHistory (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    CustomerId NVARCHAR(100) NOT NULL,
    AnalysisDate DATE NOT NULL,
    PreviousSegment NVARCHAR(50),
    CurrentSegment NVARCHAR(50) NOT NULL,
    SegmentChangeReason NVARCHAR(500),
    ChangeScore DECIMAL(5,2),                          -- å¤‰åŒ–ã®é‡è¦åº¦ã‚¹ã‚³ã‚¢
    ActionRequired BIT NOT NULL DEFAULT 0,             -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¦å¦
    RecommendedActions NVARCHAR(MAX),                  -- æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆJSONå½¢å¼ï¼‰
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CustomerSegHistory_Customer (ShopDomain, CustomerId, AnalysisDate DESC),
    INDEX IX_CustomerSegHistory_Segment (ShopDomain, CurrentSegment, AnalysisDate),
    INDEX IX_CustomerSegHistory_Change (ShopDomain, ActionRequired, ChangeScore DESC)
);

-- é¡§å®¢ç•°å¸¸è¡Œå‹•æ¤œå‡ºãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CustomerAnomalyDetection (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    CustomerId NVARCHAR(100) NOT NULL,
    DetectionDate DATE NOT NULL,
    AnomalyType NVARCHAR(100) NOT NULL,                -- PurchaseSpike|LongAbsence|UnusualCategory|ç­‰
    AnomalyScore DECIMAL(5,2) NOT NULL,                -- 0-100ç•°å¸¸åº¦ã‚¹ã‚³ã‚¢
    Description NVARCHAR(1000),
    ExpectedBehavior NVARCHAR(500),                    -- æœŸå¾…ã•ã‚Œã‚‹è¡Œå‹•
    ActualBehavior NVARCHAR(500),                      -- å®Ÿéš›ã®è¡Œå‹•
    Severity NVARCHAR(20) NOT NULL,                    -- Low|Medium|High|Critical
    IsInvestigated BIT NOT NULL DEFAULT 0,             -- èª¿æŸ»æ¸ˆã¿ãƒ•ãƒ©ã‚°
    InvestigationNotes NVARCHAR(MAX),
    ActionTaken NVARCHAR(500),
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CustomerAnomaly_Customer (ShopDomain, CustomerId, DetectionDate DESC),
    INDEX IX_CustomerAnomaly_Type (AnomalyType, Severity),
    INDEX IX_CustomerAnomaly_Score (AnomalyScore DESC, IsInvestigated)
);

-- é¡§å®¢KPIã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE CustomerKPISummary (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ShopDomain NVARCHAR(255) NOT NULL,
    AnalysisDate DATE NOT NULL,
    TotalCustomers INT NOT NULL DEFAULT 0,
    ActiveCustomers INT NOT NULL DEFAULT 0,            -- éå»90æ—¥ä»¥å†…è³¼å…¥
    VIPCustomers INT NOT NULL DEFAULT 0,               -- ä¸Šä½20%é¡§å®¢
    NewCustomers INT NOT NULL DEFAULT 0,               -- æ–°è¦é¡§å®¢ï¼ˆéå»30æ—¥ï¼‰
    DormantCustomers INT NOT NULL DEFAULT 0,           -- ä¼‘çœ é¡§å®¢ï¼ˆ180æ—¥ä»¥ä¸Šæœªè³¼å…¥ï¼‰
    
    -- LTVé–¢é€£
    AverageLTV DECIMAL(18,2) NOT NULL DEFAULT 0,
    MedianLTV DECIMAL(18,2) NOT NULL DEFAULT 0,
    TotalLTV DECIMAL(18,2) NOT NULL DEFAULT 0,
    
    -- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒ
    ChampionsCount INT NOT NULL DEFAULT 0,             -- RFMã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥é¡§å®¢æ•°
    LoyalCustomersCount INT NOT NULL DEFAULT 0,
    PotentialLoyalistsCount INT NOT NULL DEFAULT 0,
    NewCustomersCount INT NOT NULL DEFAULT 0,
    PromissingCount INT NOT NULL DEFAULT 0,
    NeedAttentionCount INT NOT NULL DEFAULT 0,
    AboutToSleepCount INT NOT NULL DEFAULT 0,
    AtRiskCount INT NOT NULL DEFAULT 0,
    CannotLoseThemCount INT NOT NULL DEFAULT 0,
    HibernatingCount INT NOT NULL DEFAULT 0,
    LostCount INT NOT NULL DEFAULT 0,
    
    -- ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯
    HighChurnRiskCustomers INT NOT NULL DEFAULT 0,
    AverageChurnRiskScore DECIMAL(5,2) DEFAULT 0,
    
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),
    INDEX IX_CustomerKPI_Shop_Date (ShopDomain, AnalysisDate),
    UNIQUE(ShopDomain, AnalysisDate)
);
```

### 2.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
- é¡§å®¢åˆ¥æ¤œç´¢ã®æœ€é©åŒ–
- RFMã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥ã®é›†è¨ˆã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
- LTVãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- ç•°å¸¸æ¤œå‡ºãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ãªå–å¾—

## 3. APIè¨­è¨ˆ

### 3.1 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å®šç¾©

```csharp
[ApiController]
[Route("api/analysis/customer-purchase")]
public class CustomerPurchaseAnalysisController : ControllerBase
{
    private readonly ICustomerPurchaseAnalysisService _analysisService;
    private readonly ILogger<CustomerPurchaseAnalysisController> _logger;

    [HttpGet]
    public async Task<IActionResult> GetCustomerPurchaseAnalysis(
        [FromQuery] CustomerPurchaseAnalysisRequest request)
    {
        // é¡§å®¢è³¼è²·åˆ†æã®å–å¾—
    }

    [HttpGet("{customerId}")]
    public async Task<IActionResult> GetCustomerDetail(
        string customerId,
        [FromQuery] CustomerDetailRequest request)
    {
        // å€‹åˆ¥é¡§å®¢è©³ç´°ã®å–å¾—
    }

    [HttpGet("kpi-summary")]
    public async Task<IActionResult> GetKPISummary(
        [FromQuery] CustomerKPIRequest request)
    {
        // é¡§å®¢KPIã‚µãƒãƒªãƒ¼ã®å–å¾—
    }

    [HttpGet("segment-analysis")]
    public async Task<IActionResult> GetSegmentAnalysis(
        [FromQuery] SegmentAnalysisRequest request)
    {
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æã®å–å¾—
    }

    [HttpGet("anomalies")]
    public async Task<IActionResult> GetCustomerAnomalies(
        [FromQuery] CustomerAnomalyRequest request)
    {
        // é¡§å®¢ç•°å¸¸è¡Œå‹•ã®å–å¾—
    }

    [HttpPost("calculate-rfm")]
    public async Task<IActionResult> CalculateRFMAnalysis(
        [FromBody] CalculateRFMRequest request)
    {
        // RFMåˆ†æã®å†è¨ˆç®—
    }

    [HttpGet("export")]
    public async Task<IActionResult> ExportCustomerAnalysis(
        [FromQuery] CustomerPurchaseAnalysisRequest request)
    {
        // CSV/Excel ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    }
}
```

### 3.2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO

```csharp
// ãƒ¡ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆDTO
public class CustomerPurchaseAnalysisRequest
{
    public int StartYear { get; set; }
    public int StartMonth { get; set; }
    public int EndYear { get; set; }
    public int EndMonth { get; set; }
    public string Segment { get; set; } = "å…¨é¡§å®¢";               // å…¨é¡§å®¢|VIP|ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼|æ–°è¦|ä¼‘çœ 
    public string LTVRange { get; set; } = "all";                // all|0-50000|50000-100000|100000+
    public string PurchaseCountRange { get; set; } = "all";      // all|1|2-5|6-10|11+
    public int? LastPurchaseDays { get; set; }                   // æœ€çµ‚è³¼å…¥ã‹ã‚‰ã®çµŒéæ—¥æ•°
    public string SortBy { get; set; } = "totalAmount";          // totalAmount|purchaseCount|lastOrderDate|ltvRank
    public string SortDirection { get; set; } = "desc";          // asc|desc
    public int Page { get; set; } = 1;
    public int PageSize { get; set; } = 50;
    public bool IncludeProductAffinity { get; set; } = true;     // å•†å“è¦ªå’Œæ€§ã‚’å«ã‚€
    public bool IncludeAnomalies { get; set; } = true;           // ç•°å¸¸è¡Œå‹•ã‚’å«ã‚€
}

// ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO
public class CustomerPurchaseAnalysisResponse
{
    public List<CustomerDetail> Customers { get; set; }
    public CustomerKPISummary KPISummary { get; set; }
    public List<SegmentDistribution> SegmentDistribution { get; set; }
    public List<CustomerAnomaly> Anomalies { get; set; }
    public CustomerAnalysisMetadata Metadata { get; set; }
    public PaginationInfo Pagination { get; set; }
}

// é¡§å®¢è©³ç´°ãƒ‡ãƒ¼ã‚¿
public class CustomerDetail
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public string PhoneNumber { get; set; }
    public string Status { get; set; }                           // Active|VIP|New|Dormant
    
    // è³¼è²·å®Ÿç¸¾
    public int TotalOrders { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal AverageOrderValue { get; set; }
    public DateTime? FirstOrderDate { get; set; }
    public DateTime? LastOrderDate { get; set; }
    public int DaysSinceLastOrder { get; set; }
    public decimal AverageDaysBetweenOrders { get; set; }
    
    // RFMåˆ†æ
    public RFMScore RFMScore { get; set; }
    public string RFMSegment { get; set; }
    
    // LTVé–¢é€£
    public decimal HistoricalLTV { get; set; }
    public decimal PredictedLTV { get; set; }
    public int LTVRank { get; set; }
    
    // ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯
    public decimal ChurnRiskScore { get; set; }
    public string ChurnRiskLevel { get; set; }
    
    // å•†å“è¦ªå’Œæ€§
    public List<ProductAffinityInfo> TopProducts { get; set; }
    public List<string> ProductCategories { get; set; }
    public int RepeatProducts { get; set; }                      // ãƒªãƒ”ãƒ¼ãƒˆå•†å“æ•°
    
    // ç•°å¸¸è¡Œå‹•
    public List<CustomerAnomaly> RecentAnomalies { get; set; }
}

// RFMã‚¹ã‚³ã‚¢
public class RFMScore
{
    public int Recency { get; set; }                             // 1-5ã‚¹ã‚³ã‚¢
    public int Frequency { get; set; }                           // 1-5ã‚¹ã‚³ã‚¢
    public int Monetary { get; set; }                            // 1-5ã‚¹ã‚³ã‚¢
    public string RecencyDescription { get; set; }               // "æœ€è¿‘è³¼å…¥"|"ã—ã°ã‚‰ãå‰"ç­‰
    public string FrequencyDescription { get; set; }
    public string MonetaryDescription { get; set; }
}

// å•†å“è¦ªå’Œæ€§æƒ…å ±
public class ProductAffinityInfo
{
    public string ProductId { get; set; }
    public string ProductName { get; set; }
    public string Category { get; set; }
    public int PurchaseCount { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal AffinityScore { get; set; }                   // 0-100è¦ªå’Œæ€§ã‚¹ã‚³ã‚¢
    public DateTime? LastPurchaseDate { get; set; }
    public decimal RepurchaseProbability { get; set; }           // å†è³¼å…¥ç¢ºç‡ï¼ˆ%ï¼‰
}

// é¡§å®¢ç•°å¸¸è¡Œå‹•
public class CustomerAnomaly
{
    public string CustomerId { get; set; }
    public DateTime DetectionDate { get; set; }
    public string AnomalyType { get; set; }
    public decimal AnomalyScore { get; set; }
    public string Description { get; set; }
    public string Severity { get; set; }
    public bool IsInvestigated { get; set; }
    public string ActionTaken { get; set; }
}

// ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒ
public class SegmentDistribution
{
    public string Segment { get; set; }
    public int CustomerCount { get; set; }
    public decimal Percentage { get; set; }
    public decimal AverageLTV { get; set; }
    public decimal AverageOrderValue { get; set; }
    public string Description { get; set; }
}

// KPIã‚µãƒãƒªãƒ¼
public class CustomerKPISummary
{
    public int TotalCustomers { get; set; }
    public int ActiveCustomers { get; set; }
    public int VIPCustomers { get; set; }
    public int NewCustomers { get; set; }
    public int DormantCustomers { get; set; }
    
    // LTVé–¢é€£
    public decimal AverageLTV { get; set; }
    public decimal MedianLTV { get; set; }
    public decimal TotalLTV { get; set; }
    
    // ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯
    public int HighChurnRiskCustomers { get; set; }
    public decimal AverageChurnRiskScore { get; set; }
    
    // æˆé•·æŒ‡æ¨™
    public decimal CustomerGrowthRate { get; set; }              // å‰æœˆæ¯”æˆé•·ç‡
    public decimal LTVGrowthRate { get; set; }                   // LTVæˆé•·ç‡
    public decimal ChurnRate { get; set; }                       // ãƒãƒ£ãƒ¼ãƒ³ç‡
}

// åˆ†æãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
public class CustomerAnalysisMetadata
{
    public DateTime AnalysisDate { get; set; }
    public DateTime PeriodStart { get; set; }
    public DateTime PeriodEnd { get; set; }
    public string SegmentFilter { get; set; }
    public string LTVRange { get; set; }
    public string DataQuality { get; set; }                     // Good|Warning|Poor
    public List<string> Warnings { get; set; }
    public DateTime LastRFMCalculation { get; set; }
}

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
public class PaginationInfo
{
    public int CurrentPage { get; set; }
    public int PageSize { get; set; }
    public int TotalCount { get; set; }
    public int TotalPages { get; set; }
    public bool HasPrevious { get; set; }
    public bool HasNext { get; set; }
}
```

### 3.3 ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```csharp
public interface ICustomerPurchaseAnalysisService
{
    Task<CustomerPurchaseAnalysisResponse> GetCustomerPurchaseAnalysisAsync(
        string shopDomain,
        CustomerPurchaseAnalysisRequest request);

    Task<CustomerDetail> GetCustomerDetailAsync(
        string shopDomain,
        string customerId,
        CustomerDetailRequest request);

    Task<CustomerKPISummary> GetKPISummaryAsync(
        string shopDomain,
        CustomerKPIRequest request);

    Task<List<SegmentDistribution>> GetSegmentAnalysisAsync(
        string shopDomain,
        SegmentAnalysisRequest request);

    Task<List<CustomerAnomaly>> GetCustomerAnomaliesAsync(
        string shopDomain,
        CustomerAnomalyRequest request);

    Task<Guid> StartRFMCalculationAsync(
        string shopDomain,
        CalculateRFMRequest request);

    Task<byte[]> ExportCustomerAnalysisAsync(
        string shopDomain,
        CustomerPurchaseAnalysisRequest request,
        ExportFormat format);
}
```

## 4. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

### 4.1 é¡§å®¢åˆ†æã‚µãƒ¼ãƒ“ã‚¹

```csharp
public class CustomerPurchaseAnalysisService : ICustomerPurchaseAnalysisService
{
    private readonly ShopifyDbContext _context;
    private readonly IRFMAnalysisService _rfmService;
    private readonly ILTVPredictionService _ltvService;
    private readonly IAnomalyDetectionService _anomalyService;
    private readonly ILogger<CustomerPurchaseAnalysisService> _logger;

    public async Task<CustomerPurchaseAnalysisResponse> GetCustomerPurchaseAnalysisAsync(
        string shopDomain,
        CustomerPurchaseAnalysisRequest request)
    {
        // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã®æ§‹ç¯‰
        var filterConditions = BuildFilterConditions(request);

        // 2. é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œï¼‰
        var customers = await GetCustomersWithPagingAsync(
            shopDomain, filterConditions, request);

        // 3. KPIã‚µãƒãƒªãƒ¼ã®å–å¾—
        var kpiSummary = await GetKPISummaryAsync(
            shopDomain, new CustomerKPIRequest 
            { 
                StartYear = request.StartYear,
                StartMonth = request.StartMonth,
                EndYear = request.EndYear,
                EndMonth = request.EndMonth
            });

        // 4. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒã®å–å¾—
        var segmentDistribution = await GetSegmentDistributionAsync(shopDomain);

        // 5. ç•°å¸¸è¡Œå‹•ã®å–å¾—
        List<CustomerAnomaly> anomalies = null;
        if (request.IncludeAnomalies)
        {
            anomalies = await GetRecentAnomaliesAsync(shopDomain, 30);
        }

        // 6. çµæœã®æ§‹ç¯‰
        return new CustomerPurchaseAnalysisResponse
        {
            Customers = customers.Items,
            KPISummary = kpiSummary,
            SegmentDistribution = segmentDistribution,
            Anomalies = anomalies,
            Metadata = BuildAnalysisMetadata(request),
            Pagination = customers.Pagination
        };
    }

    private async Task<(List<CustomerDetail> Items, PaginationInfo Pagination)> 
        GetCustomersWithPagingAsync(
            string shopDomain,
            FilterConditions filterConditions,
            CustomerPurchaseAnalysisRequest request)
    {
        var baseQuery = @"
            SELECT 
                cpa.CustomerId,
                cpa.CustomerName,
                cpa.Email,
                cpa.PhoneNumber,
                cpa.CustomerStatus,
                cpa.TotalOrders,
                cpa.TotalAmount,
                cpa.AverageOrderValue,
                cpa.FirstOrderDate,
                cpa.LastOrderDate,
                cpa.DaysSinceLastOrder,
                cpa.AverageDaysBetweenOrders,
                cpa.RecencyScore,
                cpa.FrequencyScore,
                cpa.MonetaryScore,
                cpa.RFMSegment,
                cpa.HistoricalLTV,
                cpa.PredictedLTV,
                cpa.LTVRank,
                cpa.ChurnRiskScore,
                cpa.ChurnRiskLevel
            FROM CustomerPurchaseAnalysis cpa
            WHERE cpa.ShopDomain = @ShopDomain
              AND cpa.AnalysisDate = (
                  SELECT MAX(AnalysisDate) 
                  FROM CustomerPurchaseAnalysis 
                  WHERE ShopDomain = @ShopDomain
              )
              {0}
            ORDER BY {1} {2}
            OFFSET @Offset ROWS
            FETCH NEXT @PageSize ROWS ONLY";

        // WHEREæ¡ä»¶ã¨ORDER BYå¥ã®æ§‹ç¯‰
        var whereClause = BuildWhereClause(filterConditions);
        var orderByClause = BuildOrderByClause(request.SortBy);
        var sortDirection = request.SortDirection.ToUpper();

        var query = string.Format(baseQuery, whereClause, orderByClause, sortDirection);
        
        var offset = (request.Page - 1) * request.PageSize;
        
        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@ShopDomain", shopDomain),
            new SqlParameter("@Offset", offset),
            new SqlParameter("@PageSize", request.PageSize)
        };

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¿½åŠ 
        AddFilterParameters(parameters, filterConditions);

        var results = await _context.Database
            .SqlQueryRaw<CustomerAnalysisRawData>(query, parameters.ToArray())
            .ToListAsync();

        // ç·ä»¶æ•°ã®å–å¾—
        var totalCount = await GetTotalCustomerCountAsync(shopDomain, filterConditions);

        // CustomerDetailã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰
        var customerDetails = new List<CustomerDetail>();
        
        foreach (var result in results)
        {
            var customerDetail = await BuildCustomerDetailAsync(shopDomain, result, request);
            customerDetails.Add(customerDetail);
        }

        var pagination = new PaginationInfo
        {
            CurrentPage = request.Page,
            PageSize = request.PageSize,
            TotalCount = totalCount,
            TotalPages = (int)Math.Ceiling((double)totalCount / request.PageSize),
            HasPrevious = request.Page > 1,
            HasNext = request.Page < Math.Ceiling((double)totalCount / request.PageSize)
        };

        return (customerDetails, pagination);
    }

    private async Task<CustomerDetail> BuildCustomerDetailAsync(
        string shopDomain,
        CustomerAnalysisRawData rawData,
        CustomerPurchaseAnalysisRequest request)
    {
        var customerDetail = new CustomerDetail
        {
            Id = rawData.CustomerId,
            Name = rawData.CustomerName,
            Email = rawData.Email,
            PhoneNumber = rawData.PhoneNumber,
            Status = rawData.CustomerStatus,
            TotalOrders = rawData.TotalOrders,
            TotalAmount = rawData.TotalAmount,
            AverageOrderValue = rawData.AverageOrderValue,
            FirstOrderDate = rawData.FirstOrderDate,
            LastOrderDate = rawData.LastOrderDate,
            DaysSinceLastOrder = rawData.DaysSinceLastOrder,
            AverageDaysBetweenOrders = rawData.AverageDaysBetweenOrders,
            HistoricalLTV = rawData.HistoricalLTV,
            PredictedLTV = rawData.PredictedLTV,
            LTVRank = rawData.LTVRank,
            ChurnRiskScore = rawData.ChurnRiskScore,
            ChurnRiskLevel = rawData.ChurnRiskLevel,
            RFMScore = new RFMScore
            {
                Recency = rawData.RecencyScore,
                Frequency = rawData.FrequencyScore,
                Monetary = rawData.MonetaryScore,
                RecencyDescription = GetRFMDescription("Recency", rawData.RecencyScore),
                FrequencyDescription = GetRFMDescription("Frequency", rawData.FrequencyScore),
                MonetaryDescription = GetRFMDescription("Monetary", rawData.MonetaryScore)
            },
            RFMSegment = rawData.RFMSegment
        };

        // å•†å“è¦ªå’Œæ€§ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        if (request.IncludeProductAffinity)
        {
            customerDetail.TopProducts = await GetCustomerTopProductsAsync(
                shopDomain, rawData.CustomerId);
            customerDetail.ProductCategories = await GetCustomerCategoriesAsync(
                shopDomain, rawData.CustomerId);
            customerDetail.RepeatProducts = await GetRepeatProductsCountAsync(
                shopDomain, rawData.CustomerId);
        }

        // ç•°å¸¸è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        if (request.IncludeAnomalies)
        {
            customerDetail.RecentAnomalies = await GetCustomerAnomaliesAsync(
                shopDomain, rawData.CustomerId, 30);
        }

        return customerDetail;
    }
}
```

### 4.2 RFMåˆ†æã‚µãƒ¼ãƒ“ã‚¹

```csharp
public class RFMAnalysisService : IRFMAnalysisService
{
    public async Task CalculateRFMScoresAsync(
        string shopDomain,
        DateTime analysisDate)
    {
        // 1. åˆ†æå¯¾è±¡æœŸé–“ã®æ±ºå®šï¼ˆéå»12ãƒ¶æœˆï¼‰
        var analysisStart = analysisDate.AddMonths(-12);

        // 2. é¡§å®¢ã®è³¼è²·ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        var customerPurchaseData = await GetCustomerPurchaseDataAsync(
            shopDomain, analysisStart, analysisDate);

        // 3. RFMã‚¹ã‚³ã‚¢ã®è¨ˆç®—
        var rfmScores = CalculateRFMScores(customerPurchaseData, analysisDate);

        // 4. RFMã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ±ºå®š
        var segmentedCustomers = AssignRFMSegments(rfmScores);

        // 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        await SaveRFMAnalysisAsync(shopDomain, analysisDate, segmentedCustomers);
    }

    private Dictionary<string, RFMCustomerData> CalculateRFMScores(
        List<CustomerPurchaseRawData> purchaseData,
        DateTime analysisDate)
    {
        var customerRFM = new Dictionary<string, RFMCustomerData>();

        foreach (var customer in purchaseData)
        {
            // Recencyã‚¹ã‚³ã‚¢ï¼ˆæœ€çµ‚è³¼å…¥ã‹ã‚‰ã®çµŒéæ—¥æ•°ï¼‰
            var daysSinceLastPurchase = (analysisDate - customer.LastOrderDate).Days;
            var recencyScore = CalculateRecencyScore(daysSinceLastPurchase);

            // Frequencyã‚¹ã‚³ã‚¢ï¼ˆè³¼å…¥é »åº¦ï¼‰
            var frequencyScore = CalculateFrequencyScore(customer.TotalOrders);

            // Monetaryã‚¹ã‚³ã‚¢ï¼ˆç·è³¼å…¥é‡‘é¡ï¼‰
            var monetaryScore = CalculateMonetaryScore(customer.TotalAmount);

            customerRFM[customer.CustomerId] = new RFMCustomerData
            {
                CustomerId = customer.CustomerId,
                RecencyScore = recencyScore,
                FrequencyScore = frequencyScore,
                MonetaryScore = monetaryScore,
                TotalOrders = customer.TotalOrders,
                TotalAmount = customer.TotalAmount,
                LastOrderDate = customer.LastOrderDate
            };
        }

        return customerRFM;
    }

    private int CalculateRecencyScore(int daysSinceLastPurchase)
    {
        // 5æ®µéšè©•ä¾¡ï¼ˆ5ãŒæœ€è‰¯ï¼‰
        return daysSinceLastPurchase switch
        {
            <= 30 => 5,      // 30æ—¥ä»¥å†…
            <= 60 => 4,      // 31-60æ—¥
            <= 90 => 3,      // 61-90æ—¥
            <= 180 => 2,     // 91-180æ—¥
            _ => 1           // 180æ—¥è¶…é
        };
    }

    private int CalculateFrequencyScore(int totalOrders)
    {
        return totalOrders switch
        {
            >= 10 => 5,      // 10å›ä»¥ä¸Š
            >= 6 => 4,       // 6-9å›
            >= 3 => 3,       // 3-5å›
            >= 2 => 2,       // 2å›
            _ => 1           // 1å›
        };
    }

    private int CalculateMonetaryScore(decimal totalAmount)
    {
        return totalAmount switch
        {
            >= 100000 => 5,  // 10ä¸‡å††ä»¥ä¸Š
            >= 50000 => 4,   // 5-10ä¸‡å††
            >= 20000 => 3,   // 2-5ä¸‡å††
            >= 10000 => 2,   // 1-2ä¸‡å††
            _ => 1           // 1ä¸‡å††æœªæº€
        };
    }

    private Dictionary<string, CustomerRFMResult> AssignRFMSegments(
        Dictionary<string, RFMCustomerData> rfmScores)
    {
        var segmentedCustomers = new Dictionary<string, CustomerRFMResult>();

        foreach (var rfm in rfmScores.Values)
        {
            var segment = DetermineRFMSegment(
                rfm.RecencyScore, rfm.FrequencyScore, rfm.MonetaryScore);

            segmentedCustomers[rfm.CustomerId] = new CustomerRFMResult
            {
                CustomerId = rfm.CustomerId,
                RecencyScore = rfm.RecencyScore,
                FrequencyScore = rfm.FrequencyScore,
                MonetaryScore = rfm.MonetaryScore,
                RFMSegment = segment,
                TotalOrders = rfm.TotalOrders,
                TotalAmount = rfm.TotalAmount,
                LastOrderDate = rfm.LastOrderDate
            };
        }

        return segmentedCustomers;
    }

    private string DetermineRFMSegment(int recency, int frequency, int monetary)
    {
        // RFMã‚¹ã‚³ã‚¢ã«åŸºã¥ãã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
        var rfmString = $"{recency}{frequency}{monetary}";
        
        return (recency, frequency, monetary) switch
        {
            // Champions: é«˜Rã€é«˜Fã€é«˜M
            (5, >= 4, >= 4) => "Champions",
            (4, >= 4, >= 4) => "Champions",
            
            // Loyal Customers: é«˜Rã€é«˜Fã€ä¸­M
            (>= 4, >= 4, >= 2) => "Loyal Customers",
            
            // Potential Loyalists: é«˜Rã€ä¸­Fã€ä¸­M
            (>= 4, >= 2, >= 2) => "Potential Loyalists",
            
            // New Customers: é«˜Rã€ä½Fã€ä½M
            (>= 4, <= 2, <= 2) => "New Customers",
            
            // Promising: ä¸­Rã€ä½Fã€ä½M
            (3, <= 2, <= 2) => "Promising",
            
            // Need Attention: ä¸­Rã€ä¸­Fã€ä¸­M
            (3, >= 2, >= 2) => "Need Attention",
            
            // About to Sleep: ä½Rã€ä¸­Fã€ä¸­M
            (<= 2, >= 2, >= 2) => "About to Sleep",
            
            // At Risk: ä½Rã€é«˜Fã€é«˜M
            (<= 2, >= 3, >= 3) => "At Risk",
            
            // Cannot Lose Them: ä½Rã€é«˜Fã€é«˜Mï¼ˆç‰¹ã«é‡è¦é¡§å®¢ï¼‰
            (1, >= 4, >= 4) => "Cannot Lose Them",
            
            // Hibernating: ä½Rã€ä½Fã€ä½M
            (<= 2, <= 2, <= 2) => "Hibernating",
            
            // Lost: æœ€ä½Rã€ä½Fã€ä½M
            (1, 1, <= 2) => "Lost",
            
            _ => "Others"
        };
    }
}
```

## 5. Shopifyé€£æº

### 5.1 é¡§å®¢ãƒ‡ãƒ¼ã‚¿åŒæœŸ

```csharp
public class ShopifyCustomerDataSync
{
    public async Task SyncCustomerAnalysisDataAsync(
        string shopDomain,
        DateTime analysisDate)
    {
        // 1. Shopifyã‹ã‚‰é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        var customers = await _shopifyService.GetCustomersAsync(shopDomain);

        // 2. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆéå»12ãƒ¶æœˆï¼‰
        var orders = await _shopifyService.GetOrdersAsync(
            shopDomain, analysisDate.AddMonths(-12), analysisDate);

        // 3. é¡§å®¢è³¼è²·åˆ†æãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        await UpdateCustomerPurchaseAnalysisAsync(customers, orders, analysisDate);

        // 4. RFMåˆ†æã®å®Ÿè¡Œ
        await _rfmService.CalculateRFMScoresAsync(shopDomain, analysisDate);

        // 5. LTVäºˆæ¸¬ã®å®Ÿè¡Œ
        await _ltvService.CalculateLTVPredictionsAsync(shopDomain, analysisDate);

        // 6. ç•°å¸¸æ¤œå‡ºã®å®Ÿè¡Œ
        await _anomalyService.DetectCustomerAnomaliesAsync(shopDomain, analysisDate);
    }
}
```

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### 6.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- é¡§å®¢åˆ†æçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ1æ™‚é–“ï¼‰
- RFMã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å¸ƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ6æ™‚é–“ï¼‰
- KPIã‚µãƒãƒªãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ30åˆ†ï¼‰

### 6.2 ã‚¯ã‚¨ãƒªæœ€é©åŒ–
- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹æ¤œç´¢æœ€é©åŒ–
- ãƒšãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†ã®åŠ¹ç‡åŒ–
- å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãŸã‚ã®ä¸¦åˆ—åŒ–

### 6.3 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£å‡¦ç†
- éåŒæœŸãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆç®—
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã‚’è€ƒæ…®ã—ãŸãƒ‡ãƒ¼ã‚¿å‡¦ç†

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```csharp
public enum CustomerAnalysisError
{
    InsufficientCustomerData,    // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä¸è¶³
    RFMCalculationFailed,        // RFMè¨ˆç®—ã‚¨ãƒ©ãƒ¼
    LTVPredictionFailed,         // LTVäºˆæ¸¬ã‚¨ãƒ©ãƒ¼
    AnomalyDetectionFailed      // ç•°å¸¸æ¤œå‡ºã‚¨ãƒ©ãƒ¼
}
```

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- é¡§å®¢å€‹äººæƒ…å ±ã®é©åˆ‡ãªç®¡ç†
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®åˆ¶å¾¡
- åˆ†æçµæœã®åŒ¿ååŒ–å‡¦ç†

## 9. ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### Phase 4ã§ã®æ©Ÿèƒ½è¿½åŠ 
- æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹LTVäºˆæ¸¬ç²¾åº¦å‘ä¸Š
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é¡§å®¢è¡Œå‹•åˆ†æ
- ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•åŒ–
- é¡§å®¢è¡Œå‹•äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ã®å°å…¥
- A/Bãƒ†ã‚¹ãƒˆçµæœã¨ã®çµ±åˆåˆ†æ

## âš ï¸ 10. è¨­è¨ˆä¸Šã®æ³¨æ„äº‹é …ãƒ»åˆ¶ç´„

### 10.1 ä»–æ©Ÿèƒ½ã¨ã®é‡è¤‡ãƒ»çŸ›ç›¾ ğŸ”„ **è¨­è¨ˆçµ±ä¸€å¿…è¦**

#### **é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©çŸ›ç›¾**
- **CUST-01-DORMANT**: ä¼‘çœ é¡§å®¢ = 90æ—¥é–“æœªè³¼å…¥
- **CUST-02-ANALYSIS**: About to Sleep = 180æ—¥é–“æœªè³¼å…¥
- **PURCH-03-FTIER**: Féšå±¤ã«ã‚ˆã‚‹åˆ†é¡ï¼ˆç•°ãªã‚‹åŸºæº–ï¼‰

```csharp
// çŸ›ç›¾: åŒã˜é¡§å®¢ãŒç•°ãªã‚‹ç”»é¢ã§ç•°ãªã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†é¡ã•ã‚Œã‚‹
// DORMANT: 90æ—¥ â†’ "ä¼‘çœ "
// ANALYSIS: 90æ—¥ â†’ "Need Attention"
// â†’ çµ±ä¸€ã•ã‚ŒãŸåŸºæº–ã®ç­–å®šãŒå¿…è¦
```

#### **RFMã‚¹ã‚³ã‚¢è¨ˆç®—ã®é‡è¤‡**
- **Frequencyè¨ˆç®—**: PURCH-03-FTIER ã¨é‡è¤‡
- **Monetaryè¨ˆç®—**: PROD-01-YOY ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡
- **Recencyè¨ˆç®—**: CUST-01-DORMANT ã®æœ€çµ‚è³¼å…¥æ—¥ã¨é‡è¤‡

### 10.2 å®Ÿè£…è¤‡é›‘åº¦ã®è­¦å‘Š ğŸ”¥ **é«˜é›£æ˜“åº¦**

#### **è¤‡é›‘ãªåˆ†æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **
- **RFMã‚¹ã‚³ã‚¢ç®—å‡º**: çµ±è¨ˆåˆ†å¸ƒã«åŸºã¥ã5æ®µéšè©•ä¾¡
- **LTVäºˆæ¸¬ãƒ¢ãƒ‡ãƒ«**: æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…
- **ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯åˆ†æ**: å¤šå¤‰é‡è§£æã«ã‚ˆã‚‹äºˆæ¸¬
- **ç•°å¸¸è¡Œå‹•æ¤œå‡º**: ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜ã«ã‚ˆã‚‹æ¤œå‡º

```csharp
// è­¦å‘Š: é«˜åº¦ãªçµ±è¨ˆãƒ»æ©Ÿæ¢°å­¦ç¿’çŸ¥è­˜ãŒå¿…è¦
// RFMã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: 125é€šã‚Š(5Ã—5Ã—5)ã®çµ„ã¿åˆã‚ã›ç®¡ç†
// LTVäºˆæ¸¬: æ™‚ç³»åˆ—åˆ†æãƒ»å›å¸°ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
// ç•°å¸¸æ¤œå‡º: å¤–ã‚Œå€¤æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®å®Ÿè£…
```

### 10.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®è¤‡é›‘æ€§

#### **å¤§é‡ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ**
- **5ã¤ã®å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«**: ç®¡ç†ãƒ»ä¿å®ˆã®è¤‡é›‘ã•
- **å±¥æ­´ç®¡ç†**: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¤‰æ›´å±¥æ­´ã®è¿½è·¡
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®è¤‡é›‘åŒ–

#### **æ¨å¥¨ã•ã‚Œã‚‹ç°¡ç´ åŒ–**
```sql
-- ææ¡ˆ: æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨ã«ã‚ˆã‚‹çµ±åˆ
-- CustomerPurchaseAnalysis â†’ Customer + Order ã®é›†è¨ˆãƒ“ãƒ¥ãƒ¼
-- CustomerProductAffinity â†’ OrderItem ã®é›†è¨ˆ
-- CustomerSegmentationHistory â†’ å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…±é€šåŒ–
```

### 10.4 APIè¨­è¨ˆã®èª²é¡Œ

#### **å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°**
- **å…¨é¡§å®¢è¡¨ç¤º**: 10,000é¡§å®¢ã§ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ€§èƒ½
- **æ¤œç´¢æ©Ÿèƒ½**: è¤‡æ•°æ¡ä»¶ã§ã®å‹•çš„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- **ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½**: LTVãƒ»ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯ã§ã®é«˜é€Ÿã‚½ãƒ¼ãƒˆ

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®åˆ¶ç´„**
```csharp
// è­¦å‘Š: å¿œç­”æ™‚é–“ã®åˆ¶ç´„
// å…¨é¡§å®¢ã®RFMè¨ˆç®—: 10,000é¡§å®¢ Ã— è¤‡é›‘ãªè¨ˆç®— = æ•°åç§’
// LTVäºˆæ¸¬: æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«é©ç”¨ã§æ›´ã«é…å»¶
// â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã¨ãƒãƒƒãƒå‡¦ç†ãŒå¿…é ˆ
```

### 10.5 å®Ÿè£…é †åºã®é‡è¦æ€§

#### **å‰ææ¡ä»¶ã®æ•´ç†**
1. **åŸºç›¤æ©Ÿèƒ½**: CUST-01-DORMANT ã®å®‰å®šç¨¼åƒ
2. **å…±é€šå®šç¾©**: é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åŸºæº–ã®çµ±ä¸€
3. **ãƒ‡ãƒ¼ã‚¿å“è³ª**: é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–ãƒ»ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°

#### **æ®µéšçš„å®Ÿè£…ã®æ¨å¥¨**
- **Phase 3A**: åŸºæœ¬RFMåˆ†æã®ã¿
- **Phase 3B**: é¡§å®¢è©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
- **Phase 3C**: LTVäºˆæ¸¬æ©Ÿèƒ½
- **Phase 3D**: ç•°å¸¸æ¤œå‡ºãƒ»äºˆæ¸¬åˆ†æ

### 10.6 ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã®æ˜ç¢ºåŒ–ãŒå¿…è¦

#### **æœªå®šç¾©ã®è¦ä»¶**
- **LTVäºˆæ¸¬æœŸé–“**: 6ãƒ¶æœˆï¼Ÿ1å¹´ï¼Ÿ3å¹´ï¼Ÿ
- **ãƒãƒ£ãƒ¼ãƒ³ãƒªã‚¹ã‚¯ã®é–¾å€¤**: ä½•%ã§ã€Œé«˜ãƒªã‚¹ã‚¯ã€ã¨ã™ã‚‹ã‹
- **ç•°å¸¸è¡Œå‹•ã®å®šç¾©**: ã©ã®ç¨‹åº¦ã®å¤‰åŒ–ã‚’ã€Œç•°å¸¸ã€ã¨ã™ã‚‹ã‹
- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ**: å…·ä½“çš„ãªæ–½ç­–ã®ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯

#### **å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æº**
- **CRMã¨ã®é€£æº**: é¡§å®¢æƒ…å ±ã®åŒæœŸæ–¹æ³•
- **ãƒ¡ãƒ¼ãƒ«é…ä¿¡**: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã®è‡ªå‹•åŒ–
- **A/Bãƒ†ã‚¹ãƒˆ**: åŠ¹æœæ¸¬å®šã¨ã®é€£æº

### 10.7 å„ªå…ˆåº¦ã®è¦‹ç›´ã—æ¨å¥¨

#### **å…ƒã®è¨ˆç”»**: Phase 3ï¼ˆå°†æ¥æ‹¡å¼µå¯¾è±¡ï¼‰
#### **ä¿®æ­£æ¨å¥¨**: Phase 4 ã¾ãŸã¯æ®µéšçš„å®Ÿè£…

**ç†ç”±**:
1. **æŠ€è¡“çš„è¤‡é›‘ã•**: æ©Ÿæ¢°å­¦ç¿’ãƒ»çµ±è¨ˆåˆ†æã®å°‚é–€çŸ¥è­˜å¿…è¦
2. **ä»–æ©Ÿèƒ½ã¨ã®ä¾å­˜**: åŸºç›¤æ©Ÿèƒ½ã®å®‰å®šç¨¼åƒå¾Œã®å®Ÿè£…ãŒé©åˆ‡
3. **ãƒ“ã‚¸ãƒã‚¹è¦ä»¶**: è©³ç´°ãªè¦ä»¶å®šç¾©ã¨ãƒ“ã‚¸ãƒã‚¹å´ã¨ã®èª¿æ•´ãŒå¿…è¦

**é‡è¦**: ã“ã®æ©Ÿèƒ½ã¯æœ€ã‚‚é«˜åº¦ãªåˆ†ææ©Ÿèƒ½ã®ãŸã‚ã€ä»–ã®åŸºç›¤æ©Ÿèƒ½ãŒå®Œå…¨ã«ç¨¼åƒã—ã¦ã‹ã‚‰ã®å®Ÿè£…ã‚’å¼·ãæ¨å¥¨