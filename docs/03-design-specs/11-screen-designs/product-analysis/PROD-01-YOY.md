# å‰å¹´åŒæœˆæ¯”ã€å•†å“ã€‘æ©Ÿèƒ½ - è©³ç´°è¨­è¨ˆæ›¸

## ğŸ†” ç”»é¢ID: PROD-01-YOY

ä½œæˆæ—¥: 2025å¹´6æœˆ10æ—¥  
æ›´æ–°æ—¥: 2025å¹´7æœˆ24æ—¥  
ç”»é¢ID: PROD-01-YOY  
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ç¾çŠ¶åˆ†æå®Œäº†ãƒ»è©³ç´°è¨­è¨ˆæ›´æ–°å®Œäº†ãƒ»å®Ÿè£…æº–å‚™å®Œäº†  

## ğŸ“‹ 1. æ©Ÿèƒ½æ¦‚è¦ã¨å®Ÿè£…å„ªå…ˆåº¦è©•ä¾¡

### 1.1 æ©Ÿèƒ½æ¦‚è¦
å•†å“åˆ¥ã®å£²ä¸Šã‚’å‰å¹´åŒæœˆã¨æ¯”è¼ƒã—ã€æˆé•·ç‡ãƒ»é‡‘é¡å·®ã‚’å¯è¦–åŒ–ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚å­£ç¯€æ€§ã®æŠŠæ¡ã¨å•†å“æˆ¦ç•¥ã®æœ€é©åŒ–ã«æ´»ç”¨ã•ã‚Œã¾ã™ã€‚

### 1.2 4æ©Ÿèƒ½ã®å®Ÿè£…å„ªå…ˆåº¦æ¯”è¼ƒ

| æ©Ÿèƒ½å | è¤‡é›‘åº¦ | ãƒ‡ãƒ¼ã‚¿å–å¾—é›£æ˜“åº¦ | UIè¤‡é›‘åº¦ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è² è· | æ¨å¥¨é †ä½ |
|--------|--------|------------------|----------|------------------|----------|
| **å‰å¹´åŒæœˆæ¯”ã€å•†å“ã€‘** | â­â­ | â­â­ | â­â­ | â­â­ | **1ä½** |
| ä¼‘çœ é¡§å®¢ã€é¡§å®¢ã€‘ | â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ | 2ä½ |
| çµ„ã¿åˆã‚ã›å•†å“ã€å•†å“ã€‘ | â­â­â­â­ | â­â­ | â­â­â­ | â­â­â­â­ | 3ä½ |
| Féšå±¤å‚¾å‘ã€è³¼è²·ã€‘ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | 4ä½ |

### 1.3 å‰å¹´åŒæœˆæ¯”æ©Ÿèƒ½ãŒæœ€é©ãªç†ç”±
1. **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒã‚·ãƒ³ãƒ—ãƒ«**: å•†å“Ã—æœˆÃ—å£²ä¸Šã®3æ¬¡å…ƒãƒ‡ãƒ¼ã‚¿ã®ã¿
2. **è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãŒæ˜ç¢º**: å˜ç´”ãªå‰å¹´æ¯”è¼ƒæ¼”ç®—
3. **Shopify APIã®æ¨™æº–ãƒ‡ãƒ¼ã‚¿**: è¿½åŠ ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãŒä¸è¦
4. **UIè¦ä»¶ãŒã‚·ãƒ³ãƒ—ãƒ«**: æ—¢å­˜å®Ÿè£…ã‚’æ´»ç”¨å¯èƒ½
5. **åŸºç›¤æŠ€è¡“ã®ç¢ºç«‹**: ä»–æ©Ÿèƒ½ã®åŸºç›¤ã¨ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ§‹ç¯‰

## ğŸ“Š 2. å®Ÿè£…çŠ¶æ³åˆ†æï¼ˆ2025å¹´7æœˆ24æ—¥æ›´æ–°ï¼‰

### 2.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…çŠ¶æ³
- âœ… **UIå®Œæˆåº¦**: 95%ï¼ˆæœˆåˆ¥è©³ç´°è¡¨ç¤ºã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€CSVå‡ºåŠ›ã€å¹´åº¦é¸æŠï¼‰
- âœ… **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `YearOverYearProductAnalysisImproved` å®Œå…¨å®Ÿè£…æ¸ˆã¿
- ğŸŸ¡ **ãƒ‡ãƒ¼ã‚¿é€£æº**: 0%ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ä¸­ãƒ»APIçµ±åˆå¾…ã¡ï¼‰
- ğŸŸ¡ **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: 30%ï¼ˆåŸºæœ¬çš„ãªå‡¦ç†ã®ã¿ï¼‰
- âœ… **æ—¢å­˜æ©Ÿèƒ½**: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚½ãƒ¼ãƒˆã€æœŸé–“é¸æŠã€CSVå‡ºåŠ›å®Œå‚™

### 2.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…çŠ¶æ³
- âŒ **YoYå°‚ç”¨API**: æœªå®Ÿè£…ï¼ˆç·Šæ€¥å¯¾å¿œå¿…è¦ï¼‰
- âŒ **ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå‡¦ç†**: æœªå®Ÿè£…
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤**: æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒã§å®Ÿè£…å¯èƒ½ï¼ˆOrder/OrderItemæ´»ç”¨ï¼‰
- âŒ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«æœªå®Ÿè£…

### 2.3 **ãƒ‡ãƒ¼ã‚¿å¯ç”¨æ€§åˆ†æï¼ˆé‡è¦ï¼‰**
#### âœ… åˆ©ç”¨å¯èƒ½ãƒ‡ãƒ¼ã‚¿
- **Order**: æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ï¼ˆYear/Monthè¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä»˜ãï¼‰
- **OrderItem**: å•†å“æ˜ç´°ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã§å±¥æ­´ä¿è­·ï¼‰
- **Store**: ãƒãƒ«ãƒã‚¹ãƒˆã‚¢å¯¾å¿œæ¸ˆã¿
- **Customer**: é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆ†æç”¨ï¼‰

#### âŒ ä¸è¶³ãƒ‡ãƒ¼ã‚¿
- **æœˆæ¬¡é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ã¯æ€§èƒ½å•é¡Œã‚ã‚Š
- **å‰å¹´åŒæœˆæ¯”ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®é«˜é€ŸåŒ–å¿…é ˆ
- **ShopifyåŒæœŸæ©Ÿèƒ½**: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿å–å¾—æœªå®Ÿè£…

### 2.4 **æŠ€è¡“çš„åˆ¶ç´„ãƒ»èª²é¡Œ**
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: OrderItemå…¨ä»¶è¨ˆç®—ã¯1000å•†å“Ã—24ãƒ¶æœˆã§é…å»¶
- **ãƒ‡ãƒ¼ã‚¿ä¸è¶³**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒé™å®šçš„ï¼ˆå®Ÿè£…æ¤œè¨¼å›°é›£ï¼‰
- **Shopifyçµ±åˆ**: å¤–éƒ¨APIé€£æºã‚¤ãƒ³ãƒ•ãƒ©æœªæ•´å‚™

### 2.5 **ç¢ºèªæ¸ˆã¿æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js 15.1.0 + React 18.2.0 + TypeScriptï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: .NET 8 C# ASP.NET Coreï¼ˆç¨¼åƒä¸­ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQL Serverï¼ˆAzure SQL Databaseï¼‰
- **èªè¨¼**: æœªå®Ÿè£…ï¼ˆè¦æ¤œè¨ï¼‰
- **å¤–éƒ¨API**: Shopify GraphQL Admin APIï¼ˆæœªå®Ÿè£…ï¼‰
- **ã‚¤ãƒ³ãƒ•ãƒ©**: Azure App Service + Static Web Appsï¼ˆç¨¼åƒä¸­ï¼‰

## ğŸ—ï¸ 3. ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

### 3.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
```
[Next.js Frontend] â†” [.NET Web API] â†” [PostgreSQL] â†” [Shopify API]
```

### 3.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
```
1. ãƒãƒƒãƒå‡¦ç†ï¼ˆæ—¥æ¬¡ï¼‰: Shopify API â†’ ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ â†’ PostgreSQLä¿å­˜
2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º: Frontend â†’ .NET API â†’ PostgreSQL â†’ Frontend
3. æœŸé–“æŒ‡å®šåˆ†æ: Frontend â†’ .NET API â†’ å‹•çš„é›†è¨ˆ â†’ Frontend
```

## ğŸ’¾ 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆå®Ÿè£…ç¾å®Ÿã«åŸºã¥ãæ›´æ–°ï¼‰

### 4.1 **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨æˆ¦ç•¥ï¼ˆæ¨å¥¨ãƒ»çŸ­æœŸå®Ÿè£…ï¼‰**

#### **Phase 1: æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒæœ€å¤§æ´»ç”¨**
```csharp
// æ—¢å­˜ã®OrderItemãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ´»ç”¨ã—ãŸYoYè¨ˆç®—
public class YearOverYearCalculationQuery
{
    // å‰å¹´åŒæœˆæ¯”è¨ˆç®—ã®åŸºæœ¬ã‚¯ã‚¨ãƒª
    public async Task<List<YearOverYearProductData>> CalculateYearOverYearAsync(int year, int? month = null)
    {
        var currentYearData = await _context.OrderItems
            .Where(oi => oi.Order.CreatedAt.Year == year && 
                        (month == null || oi.Order.CreatedAt.Month == month.Value))
            .GroupBy(oi => new { oi.ProductTitle, oi.ProductType })
            .Select(g => new 
            {
                ProductTitle = g.Key.ProductTitle,
                ProductType = g.Key.ProductType,
                Year = year,
                TotalSales = g.Sum(oi => oi.TotalPrice),
                TotalQuantity = g.Sum(oi => oi.Quantity),
                OrderCount = g.Count()
            }).ToListAsync();

        var previousYearData = await _context.OrderItems
            .Where(oi => oi.Order.CreatedAt.Year == year - 1 && 
                        (month == null || oi.Order.CreatedAt.Month == month.Value))
            .GroupBy(oi => new { oi.ProductTitle, oi.ProductType })
            .Select(g => new 
            {
                ProductTitle = g.Key.ProductTitle,
                ProductType = g.Key.ProductType,
                Year = year - 1,
                TotalSales = g.Sum(oi => oi.TotalPrice),
                TotalQuantity = g.Sum(oi => oi.Quantity),
                OrderCount = g.Count()
            }).ToListAsync();

        // å‰å¹´æ¯”è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        return CalculateGrowthRates(currentYearData, previousYearData);
    }
}
```

### 4.2 **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆPhase 2ï¼‰**

```sql
-- æœˆæ¬¡å•†å“é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜OrderItemãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆï¼‰
CREATE TABLE [dbo].[MonthlyProductSummary](
    [Id] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [StoreId] [int] NOT NULL,
    [ProductTitle] [nvarchar](255) NOT NULL,
    [ProductType] [nvarchar](100) NULL,
    [ProductVendor] [nvarchar](100) NULL,
    [Year] [int] NOT NULL,
    [Month] [int] NOT NULL CHECK ([Month] >= 1 AND [Month] <= 12),
    [TotalSales] [decimal](18, 2) NOT NULL DEFAULT 0,
    [TotalQuantity] [int] NOT NULL DEFAULT 0,
    [OrderCount] [int] NOT NULL DEFAULT 0,
    [AverageOrderValue] [decimal](18, 2) NOT NULL DEFAULT 0,
    [CreatedAt] [datetime2](7) NOT NULL DEFAULT GETDATE(),
    [UpdatedAt] [datetime2](7) NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT [UQ_MonthlyProductSummary] UNIQUE ([StoreId], [ProductTitle], [Year], [Month]),
    INDEX [IX_MonthlyProductSummary_YearMonth] ([StoreId], [Year], [Month]),
    INDEX [IX_MonthlyProductSummary_Product] ([StoreId], [ProductTitle])
);

-- å‰å¹´åŒæœˆæ¯”è¨ˆç®—çµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE [dbo].[YearOverYearCache](
    [Id] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [StoreId] [int] NOT NULL,
    [ProductTitle] [nvarchar](255) NOT NULL,
    [ProductType] [nvarchar](100) NULL,
    [CurrentYear] [int] NOT NULL,
    [CurrentMonth] [int] NULL, -- NULLã®å ´åˆã¯å¹´é–“é›†è¨ˆ
    [CurrentSales] [decimal](18, 2) NOT NULL DEFAULT 0,
    [PreviousSales] [decimal](18, 2) NOT NULL DEFAULT 0,
    [GrowthRate] [decimal](8, 2) NOT NULL DEFAULT 0, -- ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
    [GrowthAmount] [decimal](18, 2) NOT NULL DEFAULT 0,
    [CurrentQuantity] [int] NOT NULL DEFAULT 0,
    [PreviousQuantity] [int] NOT NULL DEFAULT 0,
    [QuantityGrowthRate] [decimal](8, 2) NOT NULL DEFAULT 0,
    [LastCalculated] [datetime2](7) NOT NULL DEFAULT GETDATE(),
    
    CONSTRAINT [UQ_YearOverYearCache] UNIQUE ([StoreId], [ProductTitle], [CurrentYear], [CurrentMonth]),
    INDEX [IX_YearOverYearCache_Calculation] ([StoreId], [CurrentYear], [CurrentMonth])
);

-- ãƒ‡ãƒ¼ã‚¿æ›´æ–°å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé›†è¨ˆå‡¦ç†ç®¡ç†ç”¨ï¼‰
CREATE TABLE [dbo].[DataAggregationLog](
    [Id] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [StoreId] [int] NOT NULL,
    [AggregationType] [nvarchar](50) NOT NULL, -- 'monthly', 'yearly', 'yoy_cache'
    [TargetYear] [int] NOT NULL,
    [TargetMonth] [int] NULL,
    [RecordsProcessed] [int] NOT NULL DEFAULT 0,
    [ProcessingStarted] [datetime2](7) NOT NULL,
    [ProcessingCompleted] [datetime2](7) NULL,
    [Success] [bit] NOT NULL DEFAULT 0,
    [ErrorMessage] [nvarchar](max) NULL,
    
    INDEX [IX_DataAggregationLog_Target] ([StoreId], [AggregationType], [TargetYear], [TargetMonth])
);

-- ãƒãƒƒãƒå‡¦ç†å®šæœŸå®Ÿè¡Œãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé›†è¨ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ï¼‰
CREATE TABLE [dbo].[AggregationSchedule](
    [Id] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [StoreId] [int] NOT NULL,
    [AggregationType] [nvarchar](50) NOT NULL,
    [ScheduleExpression] [nvarchar](100) NOT NULL, -- 'daily', 'monthly', 'on-demand'
    [LastRun] [datetime2](7) NULL,
    [NextRun] [datetime2](7) NULL,
    [IsActive] [bit] NOT NULL DEFAULT 1,
    [CreatedAt] [datetime2](7) NOT NULL DEFAULT GETDATE(),
    
    INDEX [IX_AggregationSchedule_NextRun] ([IsActive], [NextRun])
);

### 4.3 **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

```sql
-- æ—¢å­˜OrderItemãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆæ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
INSERT INTO [dbo].[MonthlyProductSummary] (
    [StoreId], [ProductTitle], [ProductType], [ProductVendor],
    [Year], [Month], [TotalSales], [TotalQuantity], [OrderCount], [AverageOrderValue]
)
SELECT 
    o.StoreId,
    oi.ProductTitle,
    oi.ProductType,
    oi.ProductVendor,
    YEAR(o.CreatedAt) as Year,
    MONTH(o.CreatedAt) as Month,
    SUM(oi.TotalPrice) as TotalSales,
    SUM(oi.Quantity) as TotalQuantity,
    COUNT(*) as OrderCount,
    AVG(oi.TotalPrice) as AverageOrderValue
FROM [dbo].[OrderItems] oi
INNER JOIN [dbo].[Orders] o ON oi.OrderId = o.Id
GROUP BY o.StoreId, oi.ProductTitle, oi.ProductType, oi.ProductVendor, YEAR(o.CreatedAt), MONTH(o.CreatedAt)
ORDER BY Year DESC, Month DESC;

-- å‰å¹´åŒæœˆæ¯”ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆæœŸè¨ˆç®—
WITH CurrentYearData AS (
    SELECT StoreId, ProductTitle, ProductType, Year, Month, TotalSales, TotalQuantity
    FROM MonthlyProductSummary
    WHERE Year = YEAR(GETDATE())
),
PreviousYearData AS (
    SELECT StoreId, ProductTitle, ProductType, Year, Month, TotalSales, TotalQuantity
    FROM MonthlyProductSummary
    WHERE Year = YEAR(GETDATE()) - 1
)
INSERT INTO YearOverYearCache (
    StoreId, ProductTitle, ProductType, CurrentYear, CurrentMonth,
    CurrentSales, PreviousSales, GrowthRate, GrowthAmount,
    CurrentQuantity, PreviousQuantity, QuantityGrowthRate
)
SELECT 
    c.StoreId, c.ProductTitle, c.ProductType, c.Year, c.Month,
    c.TotalSales, ISNULL(p.TotalSales, 0),
    CASE WHEN ISNULL(p.TotalSales, 0) = 0 THEN 0
         ELSE ((c.TotalSales - ISNULL(p.TotalSales, 0)) / ISNULL(p.TotalSales, 1)) * 100 END,
    c.TotalSales - ISNULL(p.TotalSales, 0),
    c.TotalQuantity, ISNULL(p.TotalQuantity, 0),
    CASE WHEN ISNULL(p.TotalQuantity, 0) = 0 THEN 0
         ELSE ((c.TotalQuantity - ISNULL(p.TotalQuantity, 0)) * 100.0 / ISNULL(p.TotalQuantity, 1)) END
FROM CurrentYearData c
LEFT JOIN PreviousYearData p ON c.StoreId = p.StoreId 
    AND c.ProductTitle = p.ProductTitle 
    AND c.Month = p.Month;
```
```

## ğŸ”§ 5. .NET Web APIè¨­è¨ˆï¼ˆå®Ÿè£…æº–å‚™å®Œäº†ç‰ˆï¼‰

### 5.1 **æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±åˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**

#### **çµ±åˆå…ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: `ShopifyTestApi`
```
ShopifyTestApi/ï¼ˆæ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‹¡å¼µï¼‰
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ CustomerController.csï¼ˆæ—¢å­˜ï¼‰
â”‚   â””â”€â”€ AnalyticsController.csï¼ˆæ–°è¦è¿½åŠ ï¼‰
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ DormantCustomerService.csï¼ˆæ—¢å­˜ï¼‰
â”‚   â”œâ”€â”€ IYearOverYearService.csï¼ˆæ–°è¦ï¼‰
â”‚   â””â”€â”€ YearOverYearService.csï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ CustomerModels.csï¼ˆæ—¢å­˜ï¼‰
â”‚   â””â”€â”€ AnalyticsModels.csï¼ˆæ–°è¦è¿½åŠ ï¼‰
â””â”€â”€ Data/
    â””â”€â”€ ShopifyDbContext.csï¼ˆæ—¢å­˜ãƒ»æ‹¡å¼µï¼‰
```

### 5.2 **å®Ÿè£…å„ªå…ˆåº¦åˆ¥APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ**

#### **Phase 1: æœ€ä½é™ã®MVPï¼ˆ1é€±é–“ã§å®Ÿè£…å¯èƒ½ï¼‰**
```csharp
// Controllers/AnalyticsController.cs
[Route("api/analytics")]
[ApiController]
public class AnalyticsController : ControllerBase
{
    private readonly IYearOverYearService _yearOverYearService;
    private readonly ILogger<AnalyticsController> _logger;

    // åŸºæœ¬ã®å‰å¹´åŒæœˆæ¯”å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ï¼‰
    [HttpGet("year-over-year")]
    public async Task<ActionResult<YearOverYearResponse>> GetYearOverYear(
        [FromQuery] YearOverYearRequest request)
    {
        try 
        {
            var result = await _yearOverYearService.GetYearOverYearAnalysisAsync(request);
            return Ok(new ApiResponse<YearOverYearResponse> { Data = result, Success = true });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å‰å¹´åŒæœˆæ¯”ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼");
            return StatusCode(500, new ApiResponse<YearOverYearResponse> 
            { 
                Success = false, 
                ErrorMessage = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" 
            });
        }
    }

    // é›†è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆæ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ï¼‰
    [HttpPost("year-over-year/refresh")]
    public async Task<ActionResult> RefreshYearOverYearData(
        [FromBody] RefreshYearOverYearRequest request)
    {
        await _yearOverYearService.RefreshAggregationDataAsync(request.StoreId, request.Year);
        return Ok(new { message = "ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ", timestamp = DateTime.UtcNow });
    }
}
```

#### **Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç‰ˆï¼ˆè¿½åŠ 2é€±é–“ï¼‰**
```csharp
// é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨ç‰ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
[HttpGet("year-over-year/optimized")]
public async Task<ActionResult<YearOverYearResponse>> GetYearOverYearOptimized(
    [FromQuery] YearOverYearRequest request)
{
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã®é«˜é€Ÿå–å¾—
    var result = await _yearOverYearService.GetYearOverYearFromCacheAsync(request);
    return Ok(new ApiResponse<YearOverYearResponse> { Data = result, Success = true });
}

// ãƒãƒƒãƒå‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
[HttpGet("aggregation/status")]
public async Task<ActionResult<AggregationStatusResponse>> GetAggregationStatus(
    [FromQuery] int storeId)
{
    var status = await _yearOverYearService.GetAggregationStatusAsync(storeId);
    return Ok(status);
}

// æœˆæ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿å¼·åˆ¶æ›´æ–°
[HttpPost("aggregation/monthly")]
public async Task<ActionResult> TriggerMonthlyAggregation(
    [FromBody] MonthlyAggregationRequest request)
{
    await _yearOverYearService.TriggerMonthlyAggregationAsync(request);
    return Accepted(new { message = "æœˆæ¬¡é›†è¨ˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ" });
}
```

### 5.3 **å®Ÿè£…æº–å‚™å®Œäº†DTOã‚¯ãƒ©ã‚¹è¨­è¨ˆ**

```csharp
```csharp
// Models/AnalyticsModels.cs
namespace ShopifyTestApi.Models
{
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆDTO
    public class YearOverYearRequest
    {
        public int StoreId { get; set; } = 1; // ãƒãƒ«ãƒã‚¹ãƒˆã‚¢å¯¾å¿œ
        public int Year { get; set; } = DateTime.Now.Year;
        public int? StartMonth { get; set; } = 1;
        public int? EndMonth { get; set; } = 12;
        public List<string>? ProductTypes { get; set; }
        public List<string>? ProductVendors { get; set; }
        public string? SearchTerm { get; set; }
        public string? SortBy { get; set; } = "growth_rate";
        public bool SortDescending { get; set; } = true;
        public string? GrowthFilter { get; set; } = "all"; // all, positive, negative, high_growth
        public decimal? MinGrowthRate { get; set; }
        public decimal? MaxGrowthRate { get; set; }
        public int PageNumber { get; set; } = 1;
        public int PageSize { get; set; } = 50;
        public bool UseCache { get; set; } = true; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ãƒ•ãƒ©ã‚°
    }

    // ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO
    public class YearOverYearResponse
    {
        public List<YearOverYearProductData> Products { get; set; } = new();
        public YearOverYearSummary Summary { get; set; } = new();
        public YearOverYearMetadata Metadata { get; set; } = new();
    }

    // å•†å“åˆ¥å‰å¹´åŒæœˆæ¯”ãƒ‡ãƒ¼ã‚¿
    public class YearOverYearProductData
    {
        public string ProductTitle { get; set; } = string.Empty;
        public string? ProductType { get; set; }
        public string? ProductVendor { get; set; }
        public string? ProductHandle { get; set; }
        
        // å¹´é–“é›†è¨ˆãƒ‡ãƒ¼ã‚¿
        public decimal CurrentYearSales { get; set; }
        public decimal PreviousYearSales { get; set; }
        public decimal GrowthRate { get; set; }
        public decimal GrowthAmount { get; set; }
        public int CurrentYearQuantity { get; set; }
        public int PreviousYearQuantity { get; set; }
        public decimal QuantityGrowthRate { get; set; }
        
        // æœˆåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿
        public List<MonthlyComparisonData> MonthlyData { get; set; } = new();
        
        // åˆ†ææŒ‡æ¨™
        public string GrowthCategory { get; set; } = string.Empty; // "high_growth", "stable", "declining"
        public int TrendScore { get; set; } // 1-5ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢
    }

    // æœˆåˆ¥æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
    public class MonthlyComparisonData
    {
        public int Month { get; set; }
        public string MonthName { get; set; } = string.Empty;
        public decimal CurrentSales { get; set; }
        public decimal PreviousSales { get; set; }
        public decimal GrowthRate { get; set; }
        public decimal GrowthAmount { get; set; }
        public int CurrentQuantity { get; set; }
        public int PreviousQuantity { get; set; }
        public decimal QuantityGrowthRate { get; set; }
        public int CurrentOrderCount { get; set; }
        public int PreviousOrderCount { get; set; }
    }

    // ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
    public class YearOverYearSummary
    {
        public int TotalProducts { get; set; }
        public int ProductsWithGrowth { get; set; }
        public int ProductsWithDecline { get; set; }
        public decimal AverageGrowthRate { get; set; }
        public decimal TotalCurrentYearSales { get; set; }
        public decimal TotalPreviousYearSales { get; set; }
        public decimal OverallGrowthRate { get; set; }
        public decimal OverallGrowthAmount { get; set; }
        public List<CategoryGrowth> CategoryBreakdown { get; set; } = new();
    }

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥æˆé•·ç‡
    public class CategoryGrowth
    {
        public string CategoryName { get; set; } = string.Empty;
        public int ProductCount { get; set; }
        public decimal TotalSales { get; set; }
        public decimal GrowthRate { get; set; }
    }

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    public class YearOverYearMetadata
    {
        public DateTime GeneratedAt { get; set; } = DateTime.UtcNow;
        public string DataSource { get; set; } = "realtime"; // "realtime" or "cache"
        public DateTime? LastCacheUpdate { get; set; }
        public TimeSpan CalculationTime { get; set; }
        public int TotalRecordsProcessed { get; set; }
        public string Currency { get; set; } = "JPY";
        public PaginationInfo Pagination { get; set; } = new();
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
    public class PaginationInfo
    {
        public int CurrentPage { get; set; }
        public int PageSize { get; set; }
        public int TotalRecords { get; set; }
        public int TotalPages { get; set; }
        public bool HasNextPage { get; set; }
        public bool HasPreviousPage { get; set; }
    }

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢é€£
    public class RefreshYearOverYearRequest
    {
        public int StoreId { get; set; } = 1;
        public int? Year { get; set; }
        public bool ForceRefresh { get; set; } = false;
    }

    public class MonthlyAggregationRequest
    {
        public int StoreId { get; set; } = 1;
        public int Year { get; set; }
        public int? Month { get; set; } // æŒ‡å®šã—ãªã„å ´åˆã¯å…¨æœˆ
    }

    public class AggregationStatusResponse
    {
        public int StoreId { get; set; }
        public DateTime? LastMonthlyAggregation { get; set; }
        public DateTime? LastYearOverYearCalculation { get; set; }
        public bool IsProcessing { get; set; }
        public string? CurrentOperation { get; set; }
        public int ProcessingProgress { get; set; } // 0-100
    }
}
```
```

## ğŸ”„ 6. ãƒãƒƒãƒå‡¦ç†è¨­è¨ˆ

### 6.1 ãƒ‡ãƒ¼ã‚¿é›†è¨ˆæˆ¦ç•¥

```csharp
// Background/DataAggregationService.cs
public class DataAggregationService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger<DataAggregationService> _logger;

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                using var scope = _serviceProvider.CreateScope();
                var shopifyService = scope.ServiceProvider.GetRequiredService<IShopifyService>();
                var analyticsService = scope.ServiceProvider.GetRequiredService<IAnalyticsService>();

                // æ¯æ—¥åˆå‰2æ™‚ã«å‰æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
                var now = DateTime.Now;
                var targetDate = now.Date.AddDays(-1);

                // 1. Shopifyã‹ã‚‰æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                var orders = await shopifyService.GetOrdersAsync(targetDate, targetDate.AddDays(1));

                // 2. å•†å“åˆ¥é›†è¨ˆã‚’å®Ÿè¡Œ
                await analyticsService.AggregateProductSalesAsync(orders, targetDate);

                // 3. æœˆæ¬¡é›†è¨ˆã‚’æ›´æ–°
                if (targetDate.Day == DateTime.DaysInMonth(targetDate.Year, targetDate.Month))
                {
                    await analyticsService.UpdateMonthlyAggregationAsync(targetDate);
                }

                // 4. å‰å¹´åŒæœˆæ¯”ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                await analyticsService.UpdateYearOverYearCacheAsync(targetDate);

                _logger.LogInformation($"ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå®Œäº†: {targetDate:yyyy-MM-dd}");

                // 24æ™‚é–“å¾…æ©Ÿ
                await Task.Delay(TimeSpan.FromHours(24), stoppingToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "ãƒ‡ãƒ¼ã‚¿é›†è¨ˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                await Task.Delay(TimeSpan.FromMinutes(30), stoppingToken);
            }
        }
    }
}
```

### 6.2 Shopify APIé€£æº

```csharp
// Services/ShopifyService.cs
public class ShopifyService : IShopifyService
{
    private readonly HttpClient _httpClient;
    private readonly IConfiguration _configuration;

    public async Task<List<ShopifyOrder>> GetOrdersAsync(DateTime startDate, DateTime endDate)
    {
        var query = $@"
        {{
          orders(
            first: 250
            query: ""created_at:>={startDate:yyyy-MM-dd} AND created_at:<{endDate:yyyy-MM-dd}""
            sortKey: CREATED_AT
          ) {{
            edges {{
              node {{
                id
                createdAt
                totalPriceSet {{
                  shopMoney {{
                    amount
                    currencyCode
                  }}
                }}
                lineItems(first: 100) {{
                  edges {{
                    node {{
                      id
                      product {{
                        id
                        title
                        productType
                        vendor
                      }}
                      quantity
                      originalTotalSet {{
                        shopMoney {{
                          amount
                        }}
                      }}
                    }}
                  }}
                }}
              }}
            }}
            pageInfo {{
              hasNextPage
              endCursor
            }}
          }}
        }}";

        var response = await ExecuteGraphQLQuery(query);
        return ParseOrdersResponse(response);
    }

    private async Task<string> ExecuteGraphQLQuery(string query)
    {
        var shopifyUrl = _configuration["Shopify:AdminApiUrl"];
        var accessToken = _configuration["Shopify:AccessToken"];

        var request = new HttpRequestMessage(HttpMethod.Post, shopifyUrl)
        {
            Headers = { { "X-Shopify-Access-Token", accessToken } },
            Content = new StringContent(
                JsonSerializer.Serialize(new { query }),
                Encoding.UTF8,
                "application/json"
            )
        };

        var response = await _httpClient.SendAsync(request);
        response.EnsureSuccessStatusCode();
        
        return await response.Content.ReadAsStringAsync();
    }
}
```

## ğŸš€ 7. ä¿®æ­£å®Ÿè£…è¨ˆç”»ï¼ˆç¾å®Ÿçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰

### 7.1 **Phase 1: Quick Win MVPï¼ˆ1é€±é–“ï¼‰** ğŸ¯
- [ ] **AnalyticsControllerå®Ÿè£…** - æ—¢å­˜ShopifyTestApiãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
- [ ] **YearOverYearServiceå®Ÿè£…** - æ—¢å­˜OrderItem/Orderãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨
- [ ] **AnalyticsModels.csè¿½åŠ ** - DTOã‚¯ãƒ©ã‚¹ç¾¤å®Ÿè£…
- [ ] **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯** - CTEä½¿ç”¨ã®æœ€é©åŒ–ã‚¯ã‚¨ãƒª
- [ ] **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰APIçµ±åˆ** - ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰APIåˆ‡ã‚Šæ›¿ãˆ
- [ ] **åŸºæœ¬ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** - æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ 
- [ ] **ãƒ­ã‚°æ©Ÿèƒ½** - æ—¢å­˜LoggingHelperæ´»ç”¨
- [ ] **Azureæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤** - æ—¢å­˜CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ´»ç”¨

### 7.2 **Phase 2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ2é€±é–“ï¼‰** ğŸš€
- [ ] **æœˆæ¬¡é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ** - MonthlyProductSummaryå®Ÿè£…
- [ ] **å‰å¹´åŒæœˆæ¯”ã‚­ãƒ£ãƒƒã‚·ãƒ¥** - YearOverYearCacheå®Ÿè£…
- [ ] **ãƒãƒƒãƒå‡¦ç†ã‚µãƒ¼ãƒ“ã‚¹** - BackgroundServiceå®Ÿè£…
- [ ] **é›†è¨ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼** - æ—¥æ¬¡/æœˆæ¬¡è‡ªå‹•å®Ÿè¡Œ
- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–** - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“è¿½è·¡
- [ ] **ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯** - æ•´åˆæ€§æ¤œè¨¼æ©Ÿèƒ½
- [ ] **é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°** - ã‚«ãƒ†ã‚´ãƒªãƒ»æœŸé–“ãƒ»æˆé•·ç‡ãƒ•ã‚£ãƒ«ã‚¿

### 7.3 **Phase 3: æœ¬æ ¼æ©Ÿèƒ½æ‹¡å¼µï¼ˆ2é€±é–“ï¼‰** âš¡
- [ ] **Shopify APIçµ±åˆ** - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åŒæœŸ
- [ ] **ãƒãƒ«ãƒã‚¹ãƒˆã‚¢ç®¡ç†** - ã‚¹ãƒˆã‚¢åˆ‡ã‚Šæ›¿ãˆUIå®Ÿè£…
- [ ] **é«˜åº¦åˆ†ææ©Ÿèƒ½** - ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ»äºˆæ¸¬æ©Ÿèƒ½
- [ ] **èªè¨¼çµ±åˆ** - Clerkèªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
- [ ] **ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ** - éšœå®³æ¤œçŸ¥ãƒ»é€šçŸ¥æ©Ÿèƒ½
- [ ] **APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** - Swaggeræ‹¡å¼µãƒ»ä½¿ç”¨ä¾‹è¿½åŠ 

### 7.4 **Phase 4: æœ¬ç•ªå“è³ªç¢ºä¿ï¼ˆ1é€±é–“ï¼‰** âœ…
- [ ] **è‡ªå‹•ãƒ†ã‚¹ãƒˆ** - å˜ä½“ãƒ»çµ±åˆãƒ»E2Eãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] **è² è·ãƒ†ã‚¹ãƒˆ** - 1000å•†å“Ã—2å¹´ãƒ‡ãƒ¼ã‚¿ã§ã®æ€§èƒ½æ¤œè¨¼
- [ ] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»** - è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ãƒ»å¯¾ç­–
- [ ] **é‹ç”¨æ‰‹é †æ›¸** - éšœå®³å¯¾å¿œãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ‰‹é †
- [ ] **ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ** - å®Ÿéš›ã®ãƒ“ã‚¸ãƒã‚¹ã‚·ãƒŠãƒªã‚ªæ¤œè¨¼
- [ ] **æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹** - Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

## ğŸ“‹ 8. æŠ€è¡“çš„è€ƒæ…®äº‹é …ãƒ»å®Ÿè£…ä¸Šã®åˆ¶ç´„

### 8.1 **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª²é¡Œã¨å¯¾ç­–**

#### ğŸš¨ **Critical Issue: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†**
```csharp
// å•é¡Œï¼šOrderItemå…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ã«ã‚ˆã‚‹æ€§èƒ½åŠ£åŒ–
// 1000å•†å“ Ã— 24ãƒ¶æœˆ Ã— å¹³å‡100æ³¨æ–‡ = 240ä¸‡ãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†

// è§£æ±ºç­–1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
CREATE INDEX IX_OrderItems_Performance ON OrderItems 
(ProductTitle, ProductType, OrderId) 
INCLUDE (TotalPrice, Quantity, CreatedAt);

// è§£æ±ºç­–2: ã‚¯ã‚¨ãƒªæœ€é©åŒ–
public async Task<List<YearOverYearProductData>> GetYearOverYearOptimizedAsync(int year)
{
    // CTEã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªé›†è¨ˆ
    var sql = @"
        WITH MonthlyProductData AS (
            SELECT 
                oi.ProductTitle,
                oi.ProductType,
                YEAR(o.CreatedAt) as Year,
                MONTH(o.CreatedAt) as Month,
                SUM(oi.TotalPrice) as TotalSales,
                SUM(oi.Quantity) as TotalQuantity,
                COUNT(*) as OrderCount
            FROM OrderItems oi
            INNER JOIN Orders o ON oi.OrderId = o.Id
            WHERE o.CreatedAt >= DATEADD(year, -2, GETDATE())
            GROUP BY oi.ProductTitle, oi.ProductType, YEAR(o.CreatedAt), MONTH(o.CreatedAt)
        )
        SELECT * FROM MonthlyProductData 
        WHERE Year IN (@currentYear, @previousYear)
        ORDER BY ProductTitle, Year, Month";
}
```

### 8.2 **ãƒ‡ãƒ¼ã‚¿åˆ¶ç´„ãƒ»æ—¢çŸ¥ã®å•é¡Œ**

#### âŒ **ä¸è¶³ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ»æ©Ÿèƒ½**
- **Shopifyå•†å“ID**: ç¾åœ¨ã®OrderItemã«Shopifyå•†å“IDãªã—
- **å•†å“ç”»åƒ**: UIè¡¨ç¤ºç”¨ã®ç”»åƒURLãªã—
- **ã‚«ãƒ†ã‚´ãƒªéšå±¤**: ãƒ•ãƒ©ãƒƒãƒˆãªProductTypeã®ã¿ï¼ˆéšå±¤åŒ–ãªã—ï¼‰
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«**: åœ¨åº«æƒ…å ±ã®åŒæœŸæ©Ÿèƒ½ãªã—
- **ä¾¡æ ¼å±¥æ­´**: ä¾¡æ ¼å¤‰å‹•ã®å±¥æ­´è¿½è·¡ãªã—

#### âš ï¸ **ãƒ‡ãƒ¼ã‚¿å“è³ªã®æ‡¸å¿µ**
- **å•†å“åçµ±ä¸€**: OrderItem.ProductTitleã®è¡¨è¨˜ã‚†ã‚Œ
- **ãƒ‡ãƒ¼ã‚¿æ¬ æ**: å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨é …ç›®NULL
- **é€šè²¨çµ±ä¸€**: è¤‡æ•°é€šè²¨æ··åœ¨ã®å¯èƒ½æ€§
- **ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³**: æ—¥æœ¬æ™‚é–“ã¨UTCã®æ··åœ¨

### 8.3 **å®Ÿè£…åˆ¶ç´„**

#### ğŸ”’ **ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„**
```csharp
// åˆ¶ç´„1: èªè¨¼æ©Ÿèƒ½æœªå®Ÿè£…
// ç¾çŠ¶ï¼šå…¨APIãŒãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹
// å¯¾ç­–ï¼šPhase 2ã§Clerkèªè¨¼çµ±åˆäºˆå®š

// åˆ¶ç´„2: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆã®è¤‡é›‘æ€§
// StoreIdå¿…é ˆã ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®åˆ‡ã‚Šæ›¿ãˆUIãªã—

// åˆ¶ç´„3: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
// ç›®æ¨™ï¼š2ç§’ä»¥å†…ã€ç¾å®Ÿï¼šå¤§é‡ãƒ‡ãƒ¼ã‚¿ã§5-10ç§’ã®å¯èƒ½æ€§
```

#### ğŸ¯ **å®Ÿè£…å„ªå…ˆåº¦ï¼ˆä¿®æ­£ç‰ˆï¼‰**
```typescript
interface ImplementationPriority {
  phase_1_mvp: {
    duration: '1 week';
    goal: 'Working YoY API with basic functionality';
    scope: [
      'AnalyticsController with basic endpoints',
      'YearOverYearService with real-time calculation',
      'Frontend API integration (replace mock data)',
      'Basic error handling and logging'
    ];
    success_criteria: 'Frontend displays real YoY data from API';
  };
  
  phase_2_optimization: {
    duration: '2 weeks';
    goal: 'Performance optimization and caching';
    scope: [
      'Monthly aggregation tables implementation',
      'YoY cache table and batch processing',
      'Background service for data aggregation',
      'Advanced filtering and search'
    ];
    success_criteria: 'Sub-2 second response time for 1000+ products';
  };
  
  phase_3_enhancement: {
    duration: '2 weeks';
    goal: 'Enterprise features and Shopify integration';
    scope: [
      'Shopify API integration for real-time data sync',
      'Advanced analytics and insights',
      'Multi-store management UI',
      'Automated testing and monitoring'
    ];
    success_criteria: 'Production-ready with external data sync';
  };
}
```

## ğŸ¯ 9. å—ã‘å…¥ã‚Œæ¡ä»¶

### 9.1 æ©Ÿèƒ½è¦ä»¶
- [ ] 2å¹´é–“ã®æœˆåˆ¥å£²ä¸Šæ¯”è¼ƒãŒæ­£ç¢ºã«è¡¨ç¤ºã§ãã‚‹
- [ ] æˆé•·ç‡è¨ˆç®—ãŒæ­£ç¢ºã§ã‚ã‚‹ï¼ˆå°æ•°ç‚¹ç¬¬1ä½ã¾ã§ï¼‰
- [ ] å•†å“æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] CSV/Excelå‡ºåŠ›ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] 1000å•†å“ä»¥ä¸Šã§ã‚‚2ç§’ä»¥å†…ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

### 9.2 éæ©Ÿèƒ½è¦ä»¶
- [ ] 99.9%ä»¥ä¸Šã®ç¨¼åƒç‡ã‚’ç¶­æŒã™ã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®é…å»¶ã¯24æ™‚é–“ä»¥å†…
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒãªã„
- [ ] åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§å¯¾å¿œ

### 9.3 é‹ç”¨è¦ä»¶
- [ ] ãƒãƒƒãƒå‡¦ç†ã®å¤±æ•—ã‚’è‡ªå‹•æ¤œçŸ¥ãƒ»é€šçŸ¥
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å®šæœŸãƒã‚§ãƒƒã‚¯
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] éšœå®³æ™‚ã®è‡ªå‹•å¾©æ—§æ©Ÿèƒ½

## ğŸ“ˆ 10. æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

### 10.1 æŠ€è¡“KPI
- **API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: å¹³å‡1.5ç§’ä»¥å†…
- **ãƒ‡ãƒ¼ã‚¿ç²¾åº¦**: 99.9%ä»¥ä¸Š
- **ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡**: 99.9%ä»¥ä¸Š
- **ãƒãƒƒãƒå‡¦ç†æˆåŠŸç‡**: 99.5%ä»¥ä¸Š

### 10.2 ãƒ“ã‚¸ãƒã‚¹KPI
- **æ©Ÿèƒ½åˆ©ç”¨ç‡**: æœˆæ¬¡80%ä»¥ä¸Š
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦**: 4.5/5.0ä»¥ä¸Š
- **åˆ†æç²¾åº¦**: äºˆæ¸¬ã¨å®Ÿç¸¾ã®å·®ç•°10%ä»¥å†…
- **æ„æ€æ±ºå®šåŠ¹ç‡**: åˆ†ææ™‚é–“50%çŸ­ç¸®

## ğŸ’¡ 11. çµè«–ã¨æ¨å¥¨äº‹é …ï¼ˆå®Ÿè£…æº–å‚™å®Œäº†ç‰ˆï¼‰

### 11.1 **å®Ÿè£…å¯èƒ½æ€§è©•ä¾¡**

#### âœ… **é«˜ã„å®Ÿè£…å¯èƒ½æ€§**
1. **æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©æ´»ç”¨**: ShopifyTestApiãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»Azureç’°å¢ƒå®Œå‚™
2. **ãƒ‡ãƒ¼ã‚¿åŸºç›¤ç¢ºç«‹**: Order/OrderItemãƒ†ãƒ¼ãƒ–ãƒ«ã§å¿…è¦ãƒ‡ãƒ¼ã‚¿æƒã£ã¦ã„ã‚‹
3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Œæˆ**: UIã¯95%å®Œæˆã€APIçµ±åˆã®ã¿å¿…è¦
4. **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯çµ±ä¸€**: .NET 8 + SQL Server + Azure ã®å®‰å®šæ§‹æˆ

#### âš ï¸ **æ³¨æ„ã™ã¹ãåˆ¶ç´„**
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: åˆæœŸç‰ˆã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ã®ãŸã‚è‹¥å¹²é…å»¶
2. **ãƒ‡ãƒ¼ã‚¿é‡**: ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§å®Œå…¨æ¤œè¨¼å›°é›£
3. **Shopifyçµ±åˆ**: Phase 1ã§ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€å¤–éƒ¨é€£æºã¯å¾Œå›ã—

### 11.2 **æ¨å¥¨å®Ÿè£…æˆ¦ç•¥**

#### ğŸ¯ **Quick Winå„ªå…ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
```typescript
interface RecommendedStrategy {
  week_1: {
    goal: 'Working YoY feature with real data';
    deliverable: 'Frontend displays real API data instead of mocks';
    effort: '20-30 hours';
    risk: 'Low';
  };
  
  week_2_3: {
    goal: 'Performance optimization for production';
    deliverable: 'Sub-2 second response time, cache system';
    effort: '40-50 hours';
    risk: 'Medium';
  };
  
  week_4_5: {
    goal: 'Enterprise-grade features';
    deliverable: 'Shopify sync, multi-store, advanced analytics';
    effort: '50-60 hours';
    risk: 'Medium-High';
  };
}
```

### 11.3 **å³åº§ã«é–‹å§‹ã§ãã‚‹ç†ç”±**
1. **è¨­è¨ˆå®Œäº†**: æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®Ÿè£…ä»•æ§˜ç¢ºå®š
2. **ç’°å¢ƒæº–å‚™æ¸ˆã¿**: é–‹ç™ºãƒ»æœ¬ç•ªç’°å¢ƒå®Œå‚™
3. **ã‚³ãƒ¼ãƒ‰åŸºç›¤**: æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²å¯èƒ½
4. **é«˜ROI**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Œæˆæ¸ˆã¿ã®ãŸã‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ã§å³åº§ã«ä¾¡å€¤æä¾›

### 11.4 **æˆåŠŸç¢ºç‡å‘ä¸Šã®ãƒã‚¤ãƒ³ãƒˆ**
- **æ®µéšçš„ãƒªãƒªãƒ¼ã‚¹**: Phase 1ã§åŸºæœ¬æ©Ÿèƒ½ã€ä»¥é™ã§æ®µéšçš„æ©Ÿèƒ½è¿½åŠ 
- **æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²**: DormantCustomerServiceæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®å†åˆ©ç”¨
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–**: åˆæœŸã‹ã‚‰è¨ˆæ¸¬ãƒ»æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ç¢ºç«‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: æ—©æœŸãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã®æ¤œè¨¼

**ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€1é€±é–“ã§ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã€4é€±é–“ã§æœ¬æ ¼ç¨¼åƒå¯èƒ½ãªå‰å¹´åŒæœˆæ¯”åˆ†ææ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æŠ€è¡“åŸºç›¤ã‚’ç¢ºç«‹ã§ãã¾ã™ã€‚**

## ğŸ“Š 12. ãƒ‡ãƒ¼ã‚¿ã‚®ãƒ£ãƒƒãƒ—åˆ†æãƒ»å®Ÿç¾å¯èƒ½æ€§è©•ä¾¡

### 12.1 **ç¾åœ¨æŒã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ vs è¨­è¨ˆæ›¸è¦æ±‚ãƒ‡ãƒ¼ã‚¿**

| ãƒ‡ãƒ¼ã‚¿é …ç›® | è¨­è¨ˆæ›¸è¦æ±‚ | ç¾åœ¨ã®çŠ¶æ³ | å®Ÿç¾å¯èƒ½æ€§ | å¯¾å¿œæ–¹é‡ |
|------------|------------|------------|------------|----------|
| **å•†å“å£²ä¸Šå±¥æ­´** | æœˆæ¬¡é›†è¨ˆæ¸ˆã¿ | OrderItemç”Ÿãƒ‡ãƒ¼ã‚¿ | âœ… é«˜ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆâ†’å¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«åŒ– |
| **å•†å“åŸºæœ¬æƒ…å ±** | Masterç®¡ç† | OrderItemã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ | âœ… é«˜ | ç¾åœ¨ã®æ–¹å¼ã§ååˆ† |
| **å‰å¹´åŒæœˆæ¯”è¨ˆç®—** | äº‹å‰è¨ˆç®—æ¸ˆã¿ | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯æœªå®Ÿè£… | âœ… é«˜ | Phase 1ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®— |
| **ã‚«ãƒ†ã‚´ãƒªéšå±¤** | éšå±¤æ§‹é€  | ãƒ•ãƒ©ãƒƒãƒˆ(ProductType) | ğŸŸ¡ ä¸­ | æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ä»£æ›¿ |
| **Shopifyå•†å“ID** | é€£æºç”¨ | æœªä¿å­˜ | âŒ ä½ | Phase 3ã§APIçµ±åˆæ™‚ã«è¿½åŠ  |
| **å•†å“ç”»åƒURL** | UIè¡¨ç¤ºç”¨ | æœªä¿å­˜ | âŒ ä½ | Phase 3ã§APIçµ±åˆæ™‚ã«è¿½åŠ  |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«** | åœ¨åº«åˆ†æ | æœªå¯¾å¿œ | âŒ ä½ | å°†æ¥æ©Ÿèƒ½ã¨ã—ã¦å…ˆé€ã‚Š |
| **ä¾¡æ ¼å¤‰å‹•å±¥æ­´** | ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ | æ³¨æ–‡æ™‚ä¾¡æ ¼ã®ã¿ | ğŸŸ¡ ä¸­ | OrderItem.Priceã§éƒ¨åˆ†å¯¾å¿œ |

### 12.2 **è¨ˆç®—ã§ããªã„ãƒ‡ãƒ¼ã‚¿ãƒ»æ©Ÿèƒ½åˆ¶é™**

#### âŒ **Phase 1ã§å®Ÿç¾å›°é›£ãªæ©Ÿèƒ½**
```typescript
interface UnfeasibleFeatures {
  real_time_inventory_impact: {
    reason: 'åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãªã—';
    alternative: 'å£²ä¸Šæ•°é‡ã®ã¿ã§ä»£æ›¿åˆ†æ';
  };
  
  shopify_product_sync: {
    reason: 'Shopify APIçµ±åˆæœªå®Ÿè£…';
    alternative: 'OrderItemã®å•†å“æƒ…å ±ã§åˆ†æ';
  };
  
  advanced_categorization: {
    reason: 'ã‚«ãƒ†ã‚´ãƒªéšå±¤ãƒ‡ãƒ¼ã‚¿ãªã—';
    alternative: 'ProductType/Vendorã§ã®åˆ†é¡';
  };
  
  competitive_analysis: {
    reason: 'å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãªã—';
    alternative: 'å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ã®åˆ†æ';
  };
}
```

#### ğŸŸ¡ **åˆ¶é™ä»˜ãã§å®Ÿç¾å¯èƒ½ãªæ©Ÿèƒ½**
```typescript
interface LimitedFeatures {
  product_performance_ranking: {
    limitation: 'å£²ä¸Šãƒ»æ•°é‡ãƒ™ãƒ¼ã‚¹ã®ã¿';
    missing: 'åˆ©ç›Šç‡ãƒ»ãƒãƒ¼ã‚¸ãƒ³åˆ†æ';
    workaround: 'TotalPrice/Quantityã§å¹³å‡å˜ä¾¡åˆ†æ';
  };
  
  seasonal_trend_analysis: {
    limitation: 'éå»ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã«ä¾å­˜';
    missing: 'å¤–éƒ¨è¦å› ï¼ˆå¤©å€™ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã¨ã®ç›¸é–¢';
    workaround: 'ç´”ç²‹ãªæ™‚ç³»åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ';
  };
  
  customer_segment_impact: {
    limitation: 'CustomeråŸºæœ¬æƒ…å ±ã®ã¿';
    missing: 'è©³ç´°ãªé¡§å®¢è¡Œå‹•ãƒ‡ãƒ¼ã‚¿';
    workaround: 'TotalSpent/TotalOrdersã§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ';
  };
}
```

### 12.3 **ç”»é¢è¨­è¨ˆå¤‰æ›´ã®å¿…è¦æ€§è©•ä¾¡**

#### âœ… **å¤‰æ›´ä¸è¦ãªç”»é¢è¦ç´ **
- å¹´åº¦é¸æŠï¼ˆ2022-2024ï¼‰
- æœˆåˆ¥è¡¨ç¤ºãƒ»ã‚°ãƒ©ãƒ•
- æˆé•·ç‡è¨ˆç®—ãƒ»è¡¨ç¤º
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå•†å“ã‚¿ã‚¤ãƒ—ãƒ»ãƒ™ãƒ³ãƒ€ãƒ¼ï¼‰
- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
- CSVå‡ºåŠ›

#### ğŸ”„ **èª¿æ•´ãŒå¿…è¦ãªç”»é¢è¦ç´ **
```typescript
interface UIAdjustments {
  product_images: {
    current: 'å•†å“ç”»åƒè¡¨ç¤ºäºˆå®š';
    reality: 'ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—';
    solution: 'ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã¾ãŸã¯ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º';
  };
  
  shopify_product_link: {
    current: 'Shopifyç®¡ç†ç”»é¢ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³';
    reality: 'Shopifyå•†å“IDæœªä¿å­˜';
    solution: 'ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³éè¡¨ç¤ºã€å°†æ¥æ©Ÿèƒ½ã¨ã—ã¦äºˆç´„';
  };
  
  inventory_status: {
    current: 'åœ¨åº«çŠ¶æ³è¡¨ç¤º';
    reality: 'åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãªã—';
    solution: 'ã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€è¡¨ç¤ºã¾ãŸã¯é …ç›®å‰Šé™¤';
  };
  
  advanced_filters: {
    current: 'è©³ç´°ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿';
    reality: 'ãƒ•ãƒ©ãƒƒãƒˆãªProductTypeã®ã¿';
    solution: 'æ—¢å­˜ProductType/Vendorãƒ•ã‚£ãƒ«ã‚¿ã§å¯¾å¿œ';
  };
}
```

### 12.4 **å®Ÿç¾å¯èƒ½æ€§ã«åŸºã¥ãæœ€çµ‚æ¨å¥¨äº‹é …**

#### ğŸ¯ **Phase 1: å®Ÿè£…ç¢ºå®Ÿãªæ©Ÿèƒ½**
- å‰å¹´åŒæœˆæ¯”è¨ˆç®—ï¼ˆå£²ä¸Šãƒ»æ•°é‡ãƒ»æˆé•·ç‡ï¼‰
- æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
- å•†å“åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- åŸºæœ¬ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆProductType/Vendorï¼‰
- CSVå‡ºåŠ›

#### ğŸ”„ **Phase 2: æœ€é©åŒ–ãƒ»æ‹¡å¼µæ©Ÿèƒ½**
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼ˆé›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- è©³ç´°åˆ†ææŒ‡æ¨™

#### ğŸš€ **Phase 3: ç†æƒ³çš„ãªæ©Ÿèƒ½**
- Shopify APIçµ±åˆ
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å•†å“æƒ…å ±
- åœ¨åº«é€£å‹•åˆ†æ

**çµè«–**: ç¾åœ¨ã®æŠ€è¡“åŸºç›¤ãƒ»ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã§ã€è¨­è¨ˆæ›¸ã®80%ã®æ©Ÿèƒ½ã¯å®Ÿç¾å¯èƒ½ã€‚æ®‹ã‚Š20%ã¯å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µã¨ã—ã¦æ®µéšçš„å®Ÿè£…ã‚’æ¨å¥¨ã€‚Phase 1ã§ã‚‚ååˆ†ãªä¾¡å€¤æä¾›ãŒå¯èƒ½ã€‚

## âš ï¸ 3. Shopify ã‚¢ãƒ—ãƒªåˆ†é¡ã¨é…å¸ƒåˆ¶ç´„ï¼ˆé‡è¦æ›´æ–°ï¼‰

### 3.1 ç¾åœ¨ã®Shopifyã‚¢ãƒ—ãƒªåˆ†é¡ï¼ˆ2025å¹´ç¢ºèªæ¸ˆã¿ï¼‰

#### **æ­£ç¢ºãªã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—åˆ†é¡**
| ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ— | ä½œæˆå ´æ‰€ | é…å¸ƒç¯„å›² | å¯©æŸ» | read_all_orders | æ¨å¥¨åº¦ |
|-------------|----------|----------|------|-----------------|--------|
| **Public Apps** | Partner Dashboard | è¤‡æ•°ã‚¹ãƒˆã‚¢ï¼ˆç„¡åˆ¶é™ï¼‰ | å¿…è¦ | ç”³è«‹ãƒ»å¯©æŸ»å¿…è¦ | â­ |
| **Custom Apps** | Partner Dashboard | å˜ä¸€ã‚¹ãƒˆã‚¢ï¼ˆPlusçµ„ç¹”å†…ã¯è¤‡æ•°å¯ï¼‰ | ä¸è¦ | è‡ªå‹•ä»˜ä¸ | â­â­â­ |
| **Admin Custom Apps** | Shopify Admin | å˜ä¸€ã‚¹ãƒˆã‚¢ | ä¸è¦ | è‡ªå‹•ä»˜ä¸ | â­â­ |

#### **é‡è¦ãªäº‹å®Ÿç¢ºèª**
```typescript
// é‡è¦ï¼šPrivate Appsã¯2022å¹´1æœˆã«å»ƒæ­¢æ¸ˆã¿
interface ShopifyAppTypeHistory {
  private_apps: {
    status: 'DEPRECATED';
    deprecated_date: '2022-01-01';
    migration_date: '2023-01-20';
    migrated_to: 'Custom Apps';
  };
  
  current_types: ['Public Apps', 'Custom Apps', 'Admin Custom Apps'];
  // ã€ŒPrivate Appã€ã¨å‘¼ã°ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯å®Ÿéš›ã«ã¯ã€ŒCustom Appsã€
}
```

### 3.2 ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒªé…å¸ƒã®æŠ€è¡“çš„åˆ¶ç´„

#### **é‡å¤§ãªåˆ¶ç´„äº‹é …**
```typescript
interface CustomAppLimitations {
  app_creation: {
    method: 'Manual only (Partner Dashboard)';
    automation_api: 'NOT AVAILABLE';
    per_customer_creation: 'Required manually';
  };
  
  installation_link: {
    generation: 'OAuth 2.0 dynamic generation possible';
    prerequisite: 'Existing app (API Key/Secret) required';
    format: 'https://{shop}.myshopify.com/admin/oauth/authorize?client_id={api_key}&scope={scopes}&redirect_uri={redirect_uri}&state={nonce}';
  };
  
  multi_customer_distribution: {
    single_custom_app: 'Single store only';
    multiple_customers: 'Requires separate Custom App per customer';
    plus_organization: 'Multiple stores within same Plus org allowed';
  };
}
```

#### **å®Ÿè£…å¯èƒ½ãªè‡ªå‹•åŒ–ç¯„å›²**
```typescript
// å¯èƒ½ãªè‡ªå‹•åŒ–
interface PossibleAutomation {
  oauth_link_generation: 'Fully automatable';
  installation_process: 'Merchant interaction required';
  app_configuration: 'Automatable via API after installation';
}

// ä¸å¯èƒ½ãªè‡ªå‹•åŒ–
interface ImpossibleAutomation {
  custom_app_creation: 'Manual Partner Dashboard operation required';
  bulk_app_distribution: 'No API for Custom App creation';
  silent_installation: 'Merchant consent required by Shopify policy';
}
```

### 3.3 è¤‡æ•°é¡§å®¢é…å¸ƒã®å®Ÿè£…æˆ¦ç•¥

#### **æˆ¦ç•¥A: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ Custom Appï¼ˆæ¨å¥¨ï¼‰**
```csharp
// åŒä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãƒ»è¤‡æ•°Custom Appç®¡ç†
public class MultiTenantCustomAppManager
{
    public class CustomAppConfig
    {
        public string CustomerId { get; set; }
        public string ShopDomain { get; set; }
        public string ApiKey { get; set; }        // é¡§å®¢åˆ¥Custom App
        public string ApiSecret { get; set; }    // é¡§å®¢åˆ¥Custom App
        public string AccessToken { get; set; }  // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œå–å¾—
    }
    
    // é¡§å®¢åˆ¥è¨­å®šç®¡ç†
    public Dictionary<string, CustomAppConfig> CustomerConfigs { get; set; }
    
    // å‹•çš„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒªãƒ³ã‚¯ç”Ÿæˆ
    public string GenerateInstallationLink(string customerId, string shopDomain)
    {
        var config = CustomerConfigs[customerId];
        var scopes = "read_orders,read_products,read_customers";
        var redirectUri = $"https://our-backend.com/oauth/callback/{customerId}";
        var nonce = GenerateSecureNonce();
        
        return $"https://{shopDomain}.myshopify.com/admin/oauth/authorize" +
               $"?client_id={config.ApiKey}" +
               $"&scope={scopes}" +
               $"&redirect_uri={redirectUri}" +
               $"&state={nonce}";
    }
}
```

#### **æˆ¦ç•¥B: Plusçµ„ç¹”æ´»ç”¨ï¼ˆå¤§ä¼æ¥­é¡§å®¢å‘ã‘ï¼‰**
```typescript
interface PlusOrganizationStrategy {
  target_customers: 'Enterprise customers with Shopify Plus';
  distribution_scope: 'Multiple stores within same Plus organization';
  setup_process: 'Contact Shopify support for multi-store enablement';
  advantages: ['Single Custom App for multiple stores', 'Simplified management'];
  limitations: ['Plus customers only', 'Shopify approval required'];
}
```

### 3.4 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒªãƒ³ã‚¯è‡ªå‹•ç”Ÿæˆå®Ÿè£…

#### **OAuth 2.0ãƒ•ãƒ­ãƒ¼è‡ªå‹•åŒ–**
```csharp
public class ShopifyOAuthService
{
    public async Task<string> HandleOAuthCallback(string customerId, string code, string shop)
    {
        var config = GetCustomerConfig(customerId);
        
        // Step 1: Exchange authorization code for access token
        var tokenRequest = new
        {
            client_id = config.ApiKey,
            client_secret = config.ApiSecret,
            code = code
        };
        
        var response = await HttpClient.PostAsync(
            $"https://{shop}.myshopify.com/admin/oauth/access_token",
            JsonContent.Create(tokenRequest)
        );
        
        var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();
        
        // Step 2: Store access token for customer
        await StoreAccessToken(customerId, shop, tokenResponse.AccessToken);
        
        return tokenResponse.AccessToken;
    }
    
    public async Task<bool> ValidateInstallation(string customerId, string shop)
    {
        var config = GetCustomerConfig(customerId);
        // Shopify API call to verify app installation
        return await VerifyAppInstalled(config.AccessToken, shop);
    }
}
```

### 3.5 å®Ÿè£…è¨ˆç”»ã¸ã®å½±éŸ¿

#### **ä¿®æ­£ã•ã‚ŒãŸå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
```typescript
interface RevisedImplementationPlan {
  phase_0: {
    title: 'Customer Onboarding Setup';
    duration: '1 week';
    tasks: [
      'Partner Dashboard: Manual Custom App creation per customer',
      'OAuth configuration and callback endpoint setup',
      'Customer-specific configuration database design'
    ];
  };
  
  phase_1: {
    title: 'Automated Installation System';
    duration: '2 weeks';
    tasks: [
      'OAuth link generation API implementation',
      'Installation callback handling',
      'Customer configuration management system'
    ];
  };
  
  scaling_strategy: {
    initial: 'Manual Custom App creation (acceptable for early customers)';
    growth: 'Standardized process with customer self-service portal';
    enterprise: 'Plus organization multi-store approach';
  };
}
```

ã“ã®åˆ¶ç´„ã‚’è¸ã¾ãˆã‚‹ã¨ã€**çœŸã®è‡ªå‹•åŒ–ã¯æŠ€è¡“çš„ã«ä¸å¯èƒ½**ã§ã™ãŒã€OAuthéƒ¨åˆ†ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šé‹ç”¨è² è·ã¯å¤§å¹…ã«è»½æ¸›ã§ãã¾ã™ã€‚ 