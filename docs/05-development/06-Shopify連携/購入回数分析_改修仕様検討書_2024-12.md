# 購入回数分析機能 改修仕様検討書

**作成日**: 2025年12月3日  
**作成者**: 開発チーム  
**ステータス**: 仕様確認待ち

---

## 1. エグゼクティブサマリー

購入回数分析機能において、顧客セグメント（新規・既存・復帰）のフィルタリング機能が期待通りに動作していません。
本書では現状の問題点を整理し、修正方針を提案すると共に、仕様確定のために必要な決定事項をまとめています。

## 2. 現状の問題点

### 2.1 セグメントフィルタリングが機能していない

#### 【問題の内容】
- 「新規顧客」「既存顧客」「復帰顧客」を選択しても、表示される結果がすべて同じ
- 期間を変更してもセグメント判定に反映されない

#### 【原因】
現在の実装では以下の問題があります：

| セグメント | 現在の実装 | 問題点 |
|----------|-----------|--------|
| **新規顧客** | 過去365日以内に初回購入した顧客 | 選択した分析期間が反映されない（常に365日固定） |
| **既存顧客** | 過去365日以内に購入した全顧客 | 新規顧客も含まれてしまう |
| **復帰顧客** | 2年以上前と1年以内の両方に購入がある顧客 | 定義が不明確で実用的でない |

### 2.2 期間選択が正しく動作しない

#### 【ユーザーの期待】
> 「新規で90日間で新規の人が何回購入したか？」  
> 「新規で180日間で新規の人が何回購入したか？」  
> を比較したい

#### 【現在の動作】
- 期間を「3ヶ月」「6ヶ月」「12ヶ月」から選択可能
- しかし、セグメント判定は常に「過去365日」で固定
- 選択した期間がセグメント判定に使用されていない

### 2.3 30日（1ヶ月）オプションがない

- 現在の選択肢：3ヶ月、6ヶ月、12ヶ月、24ヶ月
- **要望**：30日（1ヶ月）の選択肢を追加

## 3. 技術的な問題箇所

### 3.1 バックエンド実装の問題

**ファイル**: `backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountDataService.cs`

```csharp
// 問題のコード（62-69行目）
public async Task<(string segmentName, List<int> customerIds)> GetSegmentCustomerIdsAsync(
    int storeId, string segment)
{
    var endDate = DateTime.UtcNow.Date;
    var startDate = endDate.AddDays(-365); // ← 常に365日固定！
    
    // 以下、セグメント判定ロジック...
}
```

**問題点**：
- メソッドが期間パラメータを受け取らない
- セグメント判定が常に365日固定

### 3.2 セグメント判定ロジックの問題

```csharp
case "existing":
default:
    // 既存顧客の判定
    customerIds = await _context.Orders
        .Where(o => o.StoreId == storeId && o.CreatedAt >= startDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
    // ↑ これでは新規顧客も含まれてしまう
```

## 4. 修正方針（提案）

### 4.1 セグメント定義の明確化

以下の定義を提案します：

#### 【新規顧客（New Customer）】
- **定義**: 指定期間内に初めて購入した顧客
- **集計対象**: その期間内のすべての購入
- **例**: 
  - 3ヶ月を指定 → 過去3ヶ月以内に初回購入した顧客の、3ヶ月間の全購入を集計
  - 12ヶ月を指定 → 過去12ヶ月以内に初回購入した顧客の、12ヶ月間の全購入を集計

#### 【既存顧客（Existing Customer）】
- **定義**: 指定期間より前に既に購入履歴があり、指定期間内にも購入した顧客
- **集計対象**: 指定期間内の購入のみ
- **例**: 
  - 3ヶ月を指定 → 3ヶ月より前に購入歴があり、過去3ヶ月にも購入した顧客

#### 【復帰顧客（Returning Customer）】
- **定義**: 一定期間（休眠期間）購入がなかった後、指定期間内に再購入した顧客
- **休眠期間**: 設定可能にする（デフォルト：6ヶ月）
- **例**: 
  - 6ヶ月以上購入がなく、過去3ヶ月以内に再購入した顧客

### 4.2 技術的な修正内容

#### 1. API/メソッドの修正
```csharp
// 修正案
public async Task<(string segmentName, List<int> customerIds)> GetSegmentCustomerIdsAsync(
    int storeId, 
    string segment,
    DateTime startDate,  // 追加：期間の開始日
    DateTime endDate)    // 追加：期間の終了日
```

#### 2. セグメント判定ロジックの修正
```csharp
case "new":
    // 新規顧客：指定期間内に初回購入
    customerIds = await _context.Orders
        .Where(o => o.StoreId == storeId)
        .GroupBy(o => o.CustomerId)
        .Where(g => g.Min(o => o.CreatedAt) >= startDate 
                 && g.Min(o => o.CreatedAt) <= endDate)
        .Select(g => g.Key)
        .ToListAsync();
    break;

case "existing":
    // 既存顧客：指定期間前に購入歴あり、かつ期間内にも購入
    var periodCustomers = await _context.Orders
        .Where(o => o.StoreId == storeId 
                 && o.CreatedAt >= startDate 
                 && o.CreatedAt <= endDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
        
    var previousCustomers = await _context.Orders
        .Where(o => o.StoreId == storeId 
                 && o.CreatedAt < startDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
        
    customerIds = periodCustomers.Intersect(previousCustomers).ToList();
    break;

case "returning":
    // 復帰顧客：休眠期間後に再購入
    var dormantPeriodDays = 180; // 6ヶ月（設定可能にする）
    var dormantStartDate = startDate.AddDays(-dormantPeriodDays);
    
    // 指定期間内に購入
    var recentCustomers = await _context.Orders
        .Where(o => o.StoreId == storeId 
                 && o.CreatedAt >= startDate 
                 && o.CreatedAt <= endDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
    
    // 休眠期間前に購入歴あり
    var oldCustomers = await _context.Orders
        .Where(o => o.StoreId == storeId 
                 && o.CreatedAt < dormantStartDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
    
    // 休眠期間中に購入なし
    var activeInDormant = await _context.Orders
        .Where(o => o.StoreId == storeId 
                 && o.CreatedAt >= dormantStartDate 
                 && o.CreatedAt < startDate)
        .Select(o => o.CustomerId)
        .Distinct()
        .ToListAsync();
    
    // 休眠期間前に購入、休眠期間中は購入なし、指定期間に再購入
    customerIds = recentCustomers
        .Intersect(oldCustomers)
        .Except(activeInDormant)
        .ToList();
    break;
```

#### 3. フロントエンドの修正
```tsx
// PurchaseCountConditionPanel.tsx
<SelectContent>
  <SelectItem value="1month">過去1ヶ月</SelectItem>  {/* 追加 */}
  <SelectItem value="3months">過去3ヶ月</SelectItem>
  <SelectItem value="6months">過去6ヶ月</SelectItem>
  <SelectItem value="12months">過去12ヶ月</SelectItem>
  <SelectItem value="24months">過去24ヶ月</SelectItem>
</SelectContent>
```

## 5. 仕様確認が必要な事項

### 5.1 セグメント定義について

**質問1**: 新規顧客の定義
- [ ] A. 指定期間内に初めて購入した顧客（提案）
- [ ] B. ストア全体で初めて購入した顧客のうち、指定期間内に購入がある顧客
- [ ] C. その他（具体的に：＿＿＿＿＿＿＿＿＿）

**質問2**: 既存顧客の定義
- [ ] A. 指定期間より前に購入歴があり、指定期間内にも購入した顧客（提案）
- [ ] B. 指定期間内に2回以上購入した顧客
- [ ] C. その他（具体的に：＿＿＿＿＿＿＿＿＿）

**質問3**: 復帰顧客の定義
- [ ] A. 6ヶ月以上購入がなく、指定期間内に再購入した顧客（提案）
- [ ] B. 1年以上購入がなく、指定期間内に再購入した顧客
- [ ] C. 休眠期間を可変にする（デフォルト：＿＿＿ヶ月）
- [ ] D. その他（具体的に：＿＿＿＿＿＿＿＿＿）

### 5.2 集計対象について

**質問4**: 新規顧客の購入回数集計
- [ ] A. 指定期間内の全購入を集計（提案）
- [ ] B. 初回購入のみを集計
- [ ] C. その他（具体的に：＿＿＿＿＿＿＿＿＿）

**質問5**: 「全顧客」選択時の動作
- [ ] A. セグメント分けせず、指定期間内に購入したすべての顧客を集計
- [ ] B. 新規・既存・復帰を合算して表示
- [ ] C. その他（具体的に：＿＿＿＿＿＿＿＿＿）

### 5.3 期間選択について

**質問6**: 追加する期間オプション
- [x] 30日（1ヶ月）を追加
- [ ] 7日（1週間）も追加
- [ ] 90日（3ヶ月）を「3ヶ月」とは別に追加
- [ ] カスタム期間（日付範囲を自由に選択）

### 5.4 その他の考慮事項

**質問7**: 過去データの扱い
- [ ] A. ストアの全履歴から判定（データがある限り遡る）
- [ ] B. 過去3年分のデータから判定
- [ ] C. その他（具体的に：＿＿＿＿＿＿＿＿＿）

**質問8**: パフォーマンスについて
- 大量データ（10万件以上の注文）がある場合の処理時間についてどの程度まで許容できますか？
  - [ ] 5秒以内
  - [ ] 10秒以内
  - [ ] 30秒以内
  - [ ] バックグラウンド処理でも可

## 6. 実装スケジュール（案）

仕様確定後の想定スケジュール：

| フェーズ | 作業内容 | 所要時間 |
|---------|---------|----------|
| Phase 1 | バックエンドAPIの修正 | 2日 |
| Phase 2 | フロントエンドの修正 | 1日 |
| Phase 3 | テスト実施 | 1日 |
| Phase 4 | 本番環境デプロイ | 0.5日 |
| **合計** | | **4.5日** |

## 7. 影響範囲

### 7.1 影響を受けるファイル

**バックエンド**：
- `/backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountDataService.cs`
- `/backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountAnalysisService.cs`
- `/backend/ShopifyAnalyticsApi/Controllers/PurchaseController.cs`
- `/backend/ShopifyAnalyticsApi/Models/PurchaseCountModels.cs`

**フロントエンド**：
- `/frontend/src/components/purchase/PurchaseCountConditionPanel.tsx`
- `/frontend/src/components/dashboards/PurchaseCountAnalysis.tsx`

### 7.2 データベースへの影響
- 既存のテーブル構造に変更なし
- クエリのパフォーマンス改善の可能性あり

### 7.3 他機能への影響
- 休眠顧客分析機能：影響なし
- 売上分析機能：影響なし
- レポート機能：セグメント定義変更により数値が変わる可能性あり

## 8. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 大量データでのパフォーマンス低下 | 高 | インデックス最適化、キャッシュ導入 |
| 既存データとの不整合 | 中 | 移行期間中は新旧両方の集計を提供 |
| ユーザーの混乱 | 低 | 変更内容の事前通知、ヘルプドキュメント作成 |

## 9. テスト計画

### 9.1 単体テスト
- [ ] セグメント判定ロジックのテスト
- [ ] 期間計算のテスト
- [ ] エッジケースのテスト

### 9.2 統合テスト
- [ ] API経由でのセグメント別集計
- [ ] フロントエンドからの動作確認
- [ ] パフォーマンステスト

### 9.3 受入テスト
- [ ] 実際のデータでの動作確認
- [ ] ユーザーシナリオテスト

## 10. 次のステップ

1. **本書の内容確認と仕様決定**（〜12月5日）
   - 質問事項への回答
   - 仕様の最終確定

2. **詳細設計書の作成**（12月6日）
   - 確定仕様に基づく詳細設計

3. **実装開始**（12月9日〜）
   - 承認後、実装を開始

---

## 付録A: 現在のコード例

### 現在の問題のあるコード
```csharp
// PurchaseCountDataService.cs（62-115行目）
public async Task<(string segmentName, List<int> customerIds)> GetSegmentCustomerIdsAsync(
    int storeId, string segment)
{
    var endDate = DateTime.UtcNow.Date;
    var startDate = endDate.AddDays(-365); // 常に365日固定
    
    switch (segment.ToLower())
    {
        case "new":
            // 初回購入が分析期間内
            customerIds = await _context.Orders
                .Where(o => o.StoreId == storeId)
                .GroupBy(o => o.CustomerId)
                .Where(g => g.Min(o => o.CreatedAt) >= startDate)
                .Select(g => g.Key)
                .ToListAsync();
            break;
            
        case "existing":
            // 分析期間内に購入した全顧客（新規も含まれる）
            customerIds = await _context.Orders
                .Where(o => o.StoreId == storeId && o.CreatedAt >= startDate)
                .Select(o => o.CustomerId)
                .Distinct()
                .ToListAsync();
            break;
            
        // ... 省略
    }
}
```

## 付録B: 参考資料

- [購買回数分析ガイド](/docs/05-development/06-Shopify連携/購買回数分析ガイド.md)
- [PURCH-02-COUNT 詳細設計書](/docs/04-design-specs/11-screen-designs/purchase-analysis/PURCH-02-COUNT.md)
- [顧客セグメント分析仕様](/docs/04-design-specs/11-screen-designs/customer-analysis/CUST-02-ANALYSIS.md)

---

**改訂履歴**
- 2025-12-03: 初版作成
