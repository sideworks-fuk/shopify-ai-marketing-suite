# 環境変数設定ガイド

**最終更新**: 2025-10-27  
**対象**: 認証モード制御機能実装後の環境変数設定

## 📋 概要

このドキュメントは、Shopify AI Marketing Suiteアプリケーションで必要な環境変数の設定方法を説明します。

## 🚀 クイックスタート

### 開発環境セットアップ

**フロントエンド (.env.local)**:
```bash
NEXT_PUBLIC_API_URL=https://localhost:7088
NEXT_PUBLIC_SHOPIFY_API_KEY=2d7e0e1f5da14eb9d299aa746738e44b
NEXT_PUBLIC_USE_HTTPS=true
```

**バックエンド (環境変数またはappsettings.Development.json)**:
```bash
Authentication__Mode=AllAllowed
Authentication__JwtSecret=<generate-with-openssl-rand-base64-32>
```

**セットアップコマンド**:
```bash
# バックエンド
cd backend/ShopifyAnalyticsApi
dotnet dev-certs https --trust
dotnet run

# フロントエンド
cd frontend
npm install
npm run dev
```

## 🎯 フロントエンド環境変数

### 必須環境変数

#### 1. API接続設定

```bash
# バックエンドAPI URL（必須）
NEXT_PUBLIC_API_URL=https://localhost:7088  # 開発環境
# NEXT_PUBLIC_API_URL=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net  # ステージング
# NEXT_PUBLIC_API_URL=https://your-production-api.azurewebsites.net  # 本番環境（必須設定）
```

**重要**: 本番環境では必ず設定すること。設定されていない場合、ビルドエラーが発生します。

#### 2. Shopify設定

```bash
# Shopify API Key（公開情報）
NEXT_PUBLIC_SHOPIFY_API_KEY=your-shopify-api-key

# Shopify App URL（埋め込みアプリとして動作する場合）
NEXT_PUBLIC_SHOPIFY_APP_URL=https://your-ngrok-url.ngrok-free.app  # 開発環境
# NEXT_PUBLIC_SHOPIFY_APP_URL=https://brave-sea-038f17a00.1.azurestaticapps.net  # ステージング/本番
```

### オプション環境変数

#### 3. 開発環境設定

```bash
# 環境名の明示的な指定
NEXT_PUBLIC_ENVIRONMENT=development  # development/staging/production

# HTTPS使用設定（ローカル開発用）
NEXT_PUBLIC_USE_HTTPS=true

# 開発者モードパスワード（/dev-bookmarksアクセス用）
# 注意: これは公開情報です（NEXT_PUBLIC_プレフィックス）
NEXT_PUBLIC_DEV_PASSWORD=dev2026

# 機能制限を無効化（開発環境用）
NEXT_PUBLIC_DISABLE_FEATURE_GATES=true
```

#### 4. その他の設定

```bash
# アプリケーション名
NEXT_PUBLIC_APP_NAME=EC Ranger

# アプリケーションバージョン
NEXT_PUBLIC_SHOPIFY_APP_VERSION=1.0.0
```

## 🔧 バックエンド環境変数

### 必須環境変数（本番環境）

#### 1. データベース接続

```bash
# SQL Server接続文字列
ConnectionStrings__DefaultConnection="Server=tcp:your-server.database.windows.net,1433;Initial Catalog=your-db;User ID=your-user;Password=your-password;Encrypt=True;"
```

#### 2. Redis接続（セッション管理用）

```bash
# Redis接続文字列
ConnectionStrings__Redis="your-redis-connection-string"
```

**重要**: 本番環境ではRedisが必須です。設定されていない場合、起動時に例外が発生します。

**開発環境**: Redis未設定の場合、メモリキャッシュにフォールバックします。ただし、デモモード機能を使用する場合はRedisの設定を推奨します。

```bash
# オプション: ローカルRedis（デモモード使用時は推奨）
ConnectionStrings__Redis=localhost:6379
```

#### 3. Shopify認証情報

```bash
# Shopify OAuth Service用
Shopify__ApiKey=your-shopify-api-key
Shopify__ApiSecret=your-shopify-api-secret
```

#### 4. 認証設定（新規追加 - 2025-10-26）

```bash
# 認証モード（OAuthRequired/DemoAllowed/AllAllowed）
Authentication__Mode=OAuthRequired  # 本番環境では必須

# JWT Secret（機密情報 - 256-bit = 32バイト）
Authentication__JwtSecret=your-256-bit-secret-key

# 認証システム用Shopify API Key/Secret（通常は上記と同じ値）
Authentication__ShopifyApiKey=your-shopify-api-key
Authentication__ShopifyApiSecret=your-shopify-api-secret
```

**JWT Secret生成方法**:
```bash
# macOS/Linux
openssl rand -base64 32

# Windows PowerShell
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

生成された文字列を`Authentication__JwtSecret`に設定してください。

#### 5. ForwardedHeaders設定（新規追加 - 2025-10-27）

```bash
# 信頼するプロキシIPアドレスのリスト（オプション）
ForwardedHeaders__KnownProxies__0=10.0.0.1
ForwardedHeaders__KnownProxies__1=10.0.0.2
```

**ForwardedHeaders設定の詳細**:

**Azure App Serviceの場合**:
- X-Forwarded-*ヘッダーが自動的に追加されます
- `KnownProxies`の設定は不要です
- デフォルトで全プロキシを信頼します

**独自リバースプロキシの場合**:
- 信頼するプロキシのIPアドレスを明示的に設定してください
- 設定しない場合、X-Forwarded-Forスプーフィング攻撃のリスクがあります

**セキュリティ**: 本番環境で独自プロキシを使用する場合は必須設定です。

### オプション環境変数

#### 6. ログ設定

```bash
# Serilogログレベル
Serilog__MinimumLevel__Default=Information
```

#### 7. Redis詳細設定

```bash
Redis__InstanceName=ShopifyAnalyticsApi
Redis__DefaultDatabase=0
Redis__ConnectTimeout=5000
Redis__SyncTimeout=5000
Redis__AbortOnConnectFail=false
Redis__ConnectRetry=3
Redis__RetryTimeout=2000
```

#### 8. セッション設定

```bash
# セッションストレージタイプ（Database/Redis）
Session__StorageType=Redis  # 本番環境ではRedis推奨

# セッションクリーンアップ間隔（分）
Session__CleanupIntervalMinutes=60
```

#### 9. CORS設定

```bash
# 許可するオリジンのリスト（本番環境/ステージング環境）
Cors__AllowedOrigins__0=https://brave-sea-038f17a00.1.azurestaticapps.net
Cors__AllowedOrigins__1=https://your-custom-domain.com
```

**注意**: 
- 開発環境では全オリジンを許可（AllowAnyOrigin）
- 本番環境では設定されたオリジンのみ許可
- 未設定の場合、デフォルトのAzure Static Web Apps URLにフォールバック

#### 10. デモモード設定（DemoAllowedモードで必須）

```bash
# デモパスワード（bcryptハッシュ - 機密情報）
Demo__PasswordHash=<your-bcrypt-hash>

# セッション設定
Demo__SessionTimeoutHours=8
Demo__MaxSessionsPerUser=5

# レート制限設定
Demo__RateLimitPerIp=10
Demo__LockoutThreshold=5
Demo__LockoutDurationMinutes=30
```

**⚠️ 重要なセキュリティ注意事項**:
1. **デフォルトのPasswordHashは使用しないでください**
   - `appsettings.json`にサンプルハッシュが設定されています
   - このハッシュは一般的なbcryptサンプル（おそらく"password"）です
   - **ステージング環境では必ず環境変数で上書きしてください**
   - デフォルトのままだと、誰でもログインできてしまいます

2. **デモモードの制限**:
   - デモモードは読み取り専用です（書き込み操作は制限されます）
   - セッションタイムアウト後は再ログインが必要です
   - IPアドレスごとにレート制限が適用されます

3. **デモモード運用に必要なコンポーネント**:
   - ✅ DemoAuthService実装済み
   - ❌ デモログインエンドポイント（`POST /api/demo/login`）未実装
   - ❌ デモログインページ（`/demo/login`）未実装

## 🌍 環境別設定例

### 開発環境（Development）

**フロントエンド** (`.env.local`):
```bash
NEXT_PUBLIC_ENVIRONMENT=development
NEXT_PUBLIC_API_URL=https://localhost:7088
NEXT_PUBLIC_USE_HTTPS=true
NEXT_PUBLIC_SHOPIFY_API_KEY=2d7e0e1f5da14eb9d299aa746738e44b
NEXT_PUBLIC_SHOPIFY_APP_URL=https://your-ngrok-url.ngrok-free.app
NEXT_PUBLIC_DEV_PASSWORD=dev2026
NEXT_PUBLIC_DISABLE_FEATURE_GATES=true
```

**バックエンド** (`appsettings.Development.json` または環境変数):
```json
{
  "Authentication": {
    "Mode": "AllAllowed",
    "JwtSecret": "<generate-with-openssl-rand-base64-32>"
  },
  "Session": {
    "StorageType": "Database"
  }
}
```

**開発環境HTTPS設定**:
```bash
# バックエンド: 開発証明書の信頼
dotnet dev-certs https --trust

# フロントエンド: HTTPS使用を有効化
NEXT_PUBLIC_USE_HTTPS=true
NEXT_PUBLIC_API_URL=https://localhost:7088
```

**注意**:
- フロントエンドとバックエンドの両方をHTTPSにするか、両方をHTTPにしてください
- Mixed Content（HTTPとHTTPSの混在）はブラウザでブロックされます

### ステージング環境（Staging）

**フロントエンド**:
```bash
NEXT_PUBLIC_ENVIRONMENT=staging
NEXT_PUBLIC_API_URL=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net
NEXT_PUBLIC_SHOPIFY_API_KEY=your-shopify-api-key
NEXT_PUBLIC_SHOPIFY_APP_URL=https://brave-sea-038f17a00.1.azurestaticapps.net
```

**バックエンド** (Azure App Service環境変数):
```bash
# 認証設定
Authentication__Mode=DemoAllowed
Authentication__JwtSecret=<your-jwt-secret>
Authentication__ShopifyApiKey=<your-api-key>
Authentication__ShopifyApiSecret=<your-api-secret>

# データベース・キャッシュ
ConnectionStrings__DefaultConnection=<SQL接続文字列>
ConnectionStrings__Redis=<Redis接続文字列>

# Shopify設定
Shopify__ApiKey=<your-api-key>
Shopify__ApiSecret=<your-api-secret>

# デモモード設定（DemoAllowedモードで必須）
Demo__PasswordHash=<your-bcrypt-hash-NOT-DEFAULT>
Demo__SessionTimeoutHours=8
Demo__MaxSessionsPerUser=5
Demo__RateLimitPerIp=10
Demo__LockoutThreshold=5
Demo__LockoutDurationMinutes=30

# CORS設定
Cors__AllowedOrigins__0=https://brave-sea-038f17a00.1.azurestaticapps.net
```

### 本番環境（Production）

**フロントエンド**:
```bash
NEXT_PUBLIC_ENVIRONMENT=production
NEXT_PUBLIC_API_URL=https://your-production-api.azurewebsites.net  # 必須
NEXT_PUBLIC_SHOPIFY_API_KEY=your-production-api-key
NEXT_PUBLIC_SHOPIFY_APP_URL=https://your-production-app.azurestaticapps.net
```

**バックエンド** (Azure App Service環境変数):
```bash
# 認証設定（必須）
Authentication__Mode=OAuthRequired
Authentication__JwtSecret=<your-production-jwt-secret-256-bit>
Authentication__ShopifyApiKey=<your-production-api-key>
Authentication__ShopifyApiSecret=<your-production-api-secret>

# データベース接続（必須）
ConnectionStrings__DefaultConnection=<本番SQL接続文字列>

# Redis接続（必須）
ConnectionStrings__Redis=<本番Redis接続文字列>

# Shopify認証情報（必須）
Shopify__ApiKey=<your-production-api-key>
Shopify__ApiSecret=<your-production-api-secret>

# CORS設定（必須）
Cors__AllowedOrigins__0=https://your-production-app.azurestaticapps.net

# ForwardedHeaders設定（オプション、Azure App Serviceの場合は不要）
# ForwardedHeaders__KnownProxies__0=10.0.0.1
```

## 📊 環境変数一覧表

| 変数名 | 必須 | シークレット | 開発 | ステージング | 本番 | 説明 |
|--------|------|------------|------|------------|------|------|
| **フロントエンド** |
| `NEXT_PUBLIC_API_URL` | ✅ | ❌ | ✅ | ✅ | ✅ | バックエンドAPI URL |
| `NEXT_PUBLIC_SHOPIFY_API_KEY` | ✅ | ❌ | ✅ | ✅ | ✅ | Shopify API Key（公開情報） |
| `NEXT_PUBLIC_SHOPIFY_APP_URL` | ✅ | ❌ | ✅ | ✅ | ✅ | アプリURL |
| `NEXT_PUBLIC_ENVIRONMENT` | ❌ | ❌ | ✅ | ✅ | ✅ | 環境名 |
| `NEXT_PUBLIC_USE_HTTPS` | ❌ | ❌ | ✅ | ❌ | ❌ | HTTPS使用 |
| **バックエンド - 認証** |
| `Authentication__Mode` | ✅ | ❌ | AllAllowed | DemoAllowed | OAuthRequired | 認証モード |
| `Authentication__JwtSecret` | ✅ | ✅ | ✅ | ✅ | ✅ | JWT署名キー（256-bit） |
| `Authentication__ShopifyApiKey` | ✅ | ❌ | ✅ | ✅ | ✅ | 認証用Shopify API Key |
| `Authentication__ShopifyApiSecret` | ✅ | ✅ | ✅ | ✅ | ✅ | 認証用Shopify API Secret |
| **バックエンド - データベース・キャッシュ** |
| `ConnectionStrings__DefaultConnection` | ✅ | ✅ | ✅ | ✅ | ✅ | SQL Server接続文字列 |
| `ConnectionStrings__Redis` | ⚠️ | ❌ | オプション | ✅ | ✅ | Redis接続文字列 |
| **バックエンド - Shopify** |
| `Shopify__ApiKey` | ✅ | ❌ | ✅ | ✅ | ✅ | Shopify OAuth用API Key |
| `Shopify__ApiSecret` | ✅ | ✅ | ✅ | ✅ | ✅ | Shopify OAuth用API Secret |
| **バックエンド - デモモード** |
| `Demo__PasswordHash` | ⚠️ | ✅ | - | ✅ | - | デモパスワード（bcrypt） |
| `Demo__SessionTimeoutHours` | ❌ | ❌ | - | ✅ | - | セッションタイムアウト |
| `Demo__RateLimitPerIp` | ❌ | ❌ | - | ✅ | - | IPごとのレート制限 |
| **バックエンド - CORS** |
| `Cors__AllowedOrigins__0` | ⚠️ | ❌ | - | ✅ | ✅ | 許可するオリジン |
| **バックエンド - セキュリティ** |
| `ForwardedHeaders__KnownProxies__0` | ❌ | ❌ | - | ⚠️ | ⚠️ | 信頼するプロキシIP |

**凡例**:
- ✅ 必須
- ⚠️ 条件付き必須（環境・モードによる）
- ❌ オプション

## 🚨 重要な注意事項

### 1. 本番環境での必須設定

以下の設定は本番環境で**必須**です。設定されていない場合、起動時に例外が発生します：

- ✅ `Authentication__Mode=OAuthRequired`
- ✅ `Authentication__JwtSecret`
- ✅ `ConnectionStrings__DefaultConnection`
- ✅ `ConnectionStrings__Redis`
- ✅ `Shopify__ApiKey` / `Shopify__ApiSecret`
- ✅ `Authentication__ShopifyApiKey` / `Authentication__ShopifyApiSecret`
- ✅ `NEXT_PUBLIC_API_URL`（フロントエンド）
- ✅ `Cors__AllowedOrigins__0`（本番環境）

### 2. セキュリティベストプラクティス

1. **シークレット情報の管理**:
   - API Secret、JWT Secretは絶対にコミットしない
   - Azure Key Vaultの使用を推奨
   - 環境変数は Azure App Service の「構成」セクションで設定

2. **NEXT_PUBLIC_ プレフィックス**:
   - クライアントサイドで使用する変数のみに付ける
   - シークレット情報には絶対に付けない

3. **ForwardedHeaders設定**:
   - Azure App Service以外のリバースプロキシを使用する場合は設定を推奨
   - 空配列のままだと全てのプロキシを信頼する（開発環境/Azure App Serviceのデフォルト）

### 3. 認証モード制御の動作

| 環境 | 認証モード | 動作 | 必要な設定 |
|------|-----------|------|-----------|
| **開発環境** | `AllAllowed` | すべての認証方法が利用可能、デバッグ機能有効 | JWT Secret |
| **ステージング** | `DemoAllowed` | OAuth認証とデモモードが利用可能 | JWT Secret + Demo設定 |
| **本番環境** | `OAuthRequired` | OAuth認証のみ、デモモードは無効 | Shopify OAuth設定のみ |

### 4. App Bridge統合（新規追加 - 2025-10-26）

- Shopify埋め込みアプリとして動作する場合、App Bridgeが自動的に初期化されます
- セッショントークンは自動的に取得され、API呼び出しに使用されます
- デモモードでは localStorage から demoToken を取得します

## 🔍 設定の確認方法

### フロントエンド

開発環境で以下のURLにアクセスして設定を確認：
```
http://localhost:3000/dev/oauth-config-test
http://localhost:3000/dev/backend-health-check
```

### バックエンド

開発環境で以下のURLにアクセスして設定を確認：
```
https://localhost:7088/env-info  # 開発環境のみ
https://localhost:7088/health    # すべての環境
```

**`/env-info`エンドポイントの確認項目**:
- `environment`: 環境名（Development/Staging/Production）
- `isDevelopment`: 開発環境かどうか
- `applicationName`: アプリケーション名
- `contentRootPath`: コンテンツルートパス
- `webRootPath`: Webルートパス

**`/health`エンドポイントの確認項目**:
- `Healthy`: すべてのヘルスチェックが成功
- `Unhealthy`: いずれかのヘルスチェックが失敗（詳細を確認）

**注意**: `/env-info`エンドポイントは開発環境専用です。本番環境では実装されていません。

## 📝 トラブルシューティング

### 問題: `NEXT_PUBLIC_API_URL is not set in production environment`

**原因**: 本番環境でAPIURLが設定されていません。

**解決策**: Azure Static Web Appsの環境変数に`NEXT_PUBLIC_API_URL`を設定してください。

### 問題: `CRITICAL: Redis connection string is required in production environment`

**原因**: 本番環境でRedis接続文字列が設定されていません。

**解決策**: Azure App Serviceの環境変数に`ConnectionStrings__Redis`を設定してください。

### 問題: `SECURITY: Production environment must use OAuthRequired mode`

**原因**: 本番環境で認証モードが`OAuthRequired`以外に設定されています。

**解決策**: Azure App Serviceの環境変数で`Authentication__Mode=OAuthRequired`を設定してください。

### 問題: CORS エラー（プリフライトリクエスト失敗）

**原因**: フロントエンドのオリジンがバックエンドのCORS設定で許可されていません。

**解決策**: 
- 開発環境: 自動的に全オリジンを許可（設定不要）
- 本番環境: `Cors__AllowedOrigins__0`にフロントエンドのURLを設定

### 問題: Mixed Content エラー（HTTPSとHTTPの混在）

**原因**: フロントエンドがHTTPSでバックエンドがHTTP、またはその逆。

**解決策**: 
- 開発環境: 両方をHTTPSに統一（`dotnet dev-certs https --trust` + `NEXT_PUBLIC_USE_HTTPS=true`）
- または両方をHTTPに統一

### 問題: デモモードでログインできない

**原因**: 
1. デモログインエンドポイント（`POST /api/demo/login`）が未実装
2. デモログインページ（`/demo/login`）が未実装
3. `Demo__PasswordHash`が設定されていない、またはパスワードが間違っている

**解決策**: 
1. デモログインエンドポイントとページを実装
2. `Demo__PasswordHash`を正しいbcryptハッシュに設定
3. デモパスワードを確認

### 問題: JWT Secret関連のエラー

**原因**: JWT Secretが設定されていない、または形式が不正。

**解決策**: 
```bash
# 正しいJWT Secretを生成
openssl rand -base64 32

# 環境変数に設定
Authentication__JwtSecret=<generated-secret>
```

## 🔗 関連ドキュメント

- 実装計画書: `docs/03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-実装計画.md`
- テスト計画書: `docs/03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-テスト計画.md`
- 作業ログ: `docs/worklog/2025/10/2025-10-26-production-ready-fixes.md`

## 📊 環境変数チェックリスト

### 開発環境

- [ ] `NEXT_PUBLIC_API_URL` 設定済み
- [ ] `NEXT_PUBLIC_SHOPIFY_API_KEY` 設定済み
- [ ] `NEXT_PUBLIC_USE_HTTPS=true` 設定済み
- [ ] HTTPS証明書を信頼済み（`dotnet dev-certs https --trust`）

### ステージング環境

**フロントエンド**:
- [ ] `NEXT_PUBLIC_API_URL` 設定済み（Azure API URL）
- [ ] `NEXT_PUBLIC_SHOPIFY_APP_URL` 設定済み（Azure Static Web Apps URL）
- [ ] `NEXT_PUBLIC_SHOPIFY_API_KEY` 設定済み

**バックエンド**:
- [ ] `Authentication__Mode=DemoAllowed` 設定済み
- [ ] `Authentication__JwtSecret` 設定済み（256-bit）
- [ ] `ConnectionStrings__DefaultConnection` 設定済み
- [ ] `ConnectionStrings__Redis` 設定済み
- [ ] `Shopify__ApiKey` / `Shopify__ApiSecret` 設定済み
- [ ] `Authentication__ShopifyApiKey` / `Authentication__ShopifyApiSecret` 設定済み
- [ ] `Demo__PasswordHash` 設定済み（デフォルトから変更）
- [ ] `Cors__AllowedOrigins__0` 設定済み

### 本番環境

**フロントエンド**:
- [ ] `NEXT_PUBLIC_API_URL` 設定済み（必須）
- [ ] `NEXT_PUBLIC_SHOPIFY_APP_URL` 設定済み（必須）
- [ ] `NEXT_PUBLIC_SHOPIFY_API_KEY` 設定済み（必須）

**バックエンド**:
- [ ] `Authentication__Mode=OAuthRequired` 設定済み（必須）
- [ ] `Authentication__JwtSecret` 設定済み（必須、256-bit）
- [ ] `Authentication__ShopifyApiKey` / `Authentication__ShopifyApiSecret` 設定済み（必須）
- [ ] `ConnectionStrings__DefaultConnection` 設定済み（必須）
- [ ] `ConnectionStrings__Redis` 設定済み（必須）
- [ ] `Shopify__ApiKey` / `Shopify__ApiSecret` 設定済み（必須）
- [ ] `Cors__AllowedOrigins__0` 設定済み（必須）
- [ ] すべてのシークレットをAzure Key Vaultで管理（推奨）
- [ ] ForwardedHeaders設定確認（独自プロキシ使用時）

---

**注意**: このガイドは認証モード制御機能（2025-10-26実装）に基づいています。以前の設定とは異なる部分があるため、既存環境を更新する際は注意してください。

