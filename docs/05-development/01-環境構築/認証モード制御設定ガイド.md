# 認証モード制御設定ガイド

## 概要

このドキュメントでは、Shopify AI Marketing Suiteの認証モード制御機能の設定方法を説明します。

---

## 📋 認証モード一覧

### 1. OAuthRequired（本番環境推奨）
**説明**: Shopify OAuth認証のみを許可します。デモモードは使用できません。

**特徴**:
- 最もセキュアなモード
- Shopifyストア経由のアクセスのみ許可
- 本番環境では**必須**

**設定例**:
```json
{
  "Authentication": {
    "Mode": "OAuthRequired"
  }
}
```

### 2. DemoAllowed（ステージング環境推奨）
**説明**: Shopify OAuth認証とデモモードの両方を許可します。

**特徴**:
- OAuth認証とデモモードの両方をサポート
- クライアントへのデモ・プレゼンテーション用
- 本番環境では**禁止**

**設定例**:
```json
{
  "Authentication": {
    "Mode": "DemoAllowed"
  }
}
```

### 3. AllAllowed（開発環境専用）
**説明**: すべての認証方式を許可します（認証不要）。

**特徴**:
- 認証なしでアクセス可能
- 開発・テスト専用
- 本番環境では**絶対禁止**

**設定例**:
```json
{
  "Authentication": {
    "Mode": "AllAllowed"
  }
}
```

---

## ⚙️ 環境別設定ファイル

### 1. appsettings.json（ベース設定）
**場所**: `backend/ShopifyAnalyticsApi/appsettings.json`

**用途**: すべての環境のベース設定。プレースホルダーを使用します。

```json
{
  "Authentication": {
    "Mode": "#{AUTHENTICATION_MODE}#",
    "Secret": "#{JWT_SECRET}#",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  }
}
```

### 2. appsettings.LocalDevelopment.json（ローカル開発環境）
**場所**: `backend/ShopifyAnalyticsApi/appsettings.LocalDevelopment.json`

**用途**: ローカル開発環境の設定。

**推奨設定**:
```json
{
  "Authentication": {
    "Mode": "AllAllowed",
    "Secret": "development-secret-key-replace-in-production",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  },
  "Session": {
    "TimeoutMinutes": 60
  },
  "Demo": {
    "Enabled": true,
    "Password": "dev2026",
    "TokenExpiryMinutes": 60
  },
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  },
  "ForwardedHeaders": {
    "KnownProxies": []
  }
}
```

### 3. appsettings.Production.json（本番環境）
**場所**: `backend/ShopifyAnalyticsApi/appsettings.Production.json`

**用途**: Azure App Service本番環境の設定。

**推奨設定**:
```json
{
  "Authentication": {
    "Mode": "OAuthRequired",
    "Secret": "production-secret-key-change-this",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  },
  "Session": {
    "TimeoutMinutes": 60
  },
  "Demo": {
    "Enabled": false,
    "Password": "",
    "TokenExpiryMinutes": 60
  },
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  },
  "ForwardedHeaders": {
    "KnownProxies": []
  }
}
```

---

## 🔒 セキュリティチェック

### 本番環境での自動チェック

`AuthModeMiddleware`は本番環境で以下のチェックを実行します：

```csharp
// 本番環境でOAuthRequired以外のモードが設定されている場合、アプリは起動失敗します
if (environment == "Production" && authMode != "OAuthRequired")
{
    // アプリは起動できません
    throw new InvalidOperationException("Production must use OAuthRequired mode");
}
```

### 設定値の検証

許可される値:
- ✅ `OAuthRequired`
- ✅ `DemoAllowed`
- ✅ `AllAllowed`

不正な値:
- ❌ `oauth_required`（小文字）
- ❌ `demo-allowed`（ハイフン）
- ❌ `ALLOWED`（大文字のみ）
- ❌ その他の値

不正な値が設定された場合、**"Unknown authentication mode"**エラーが発生します。

---

## 🛠️ 設定方法

### 方法1: 環境変数を使用（推奨）

#### ローカル開発
```powershell
$env:Authentication__Mode="AllAllowed"
dotnet run
```

#### Azure App Service
Azure Portal または Azure CLI で環境変数を設定：
```
Authentication:Mode=OAuthRequired
```

### 方法2: appsettings.{環境}.json を使用

1. `appsettings.{環境名}.json`を編集
2. `Authentication:Mode`を設定
3. アプリを再起動

---

## 📝 必要なセクション

### Authentication セクション（必須）

```json
{
  "Authentication": {
    "Mode": "OAuthRequired|DemoAllowed|AllAllowed",
    "Secret": "your-secret-key",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  }
}
```

### Session セクション（推奨）

```json
{
  "Session": {
    "TimeoutMinutes": 60
  }
}
```

### Demo セクション（DemoAllowedモードで必須）

```json
{
  "Demo": {
    "Enabled": true,
    "Password": "dev2026",
    "TokenExpiryMinutes": 60
  }
}
```

### Redis セクション（本番環境で推奨）

```json
{
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  }
}
```

### ForwardedHeaders セクション（リバースプロキシ環境で必要）

```json
{
  "ForwardedHeaders": {
    "KnownProxies": ["10.0.0.1", "10.0.0.2"]
  }
}
```

---

## 🐛 トラブルシューティング

### エラー: "Unknown authentication mode"

**原因**: `Authentication:Mode`が無効な値に設定されています。

**解決方法**:
1. 設定ファイルを確認
2. 値が以下のいずれかであることを確認：
   - `OAuthRequired`
   - `DemoAllowed`
   - `AllAllowed`

### エラー: "Production environment must use OAuthRequired mode"

**原因**: 本番環境でOAuthRequired以外のモードが設定されています。

**解決方法**:
1. 本番環境の設定を`OAuthRequired`に変更
2. アプリを再起動

### エラー: "Unable to resolve service for type 'IDistributedCache'"

**原因**: `IDistributedCache`の実装が登録されていません。

**解決方法**:
1. `Program.cs`で`AddDistributedMemoryCache()`または`AddStackExchangeRedisCache()`を確認
2. 設定ファイルに`Redis`セクションが存在することを確認

---

## 📚 関連ドキュメント

- [認証モード制御機能 設計書](../../03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-設計書.md)
- [認証モード制御機能 実装計画](../../03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-実装計画.md)
- [認証モード制御機能 要件定義](../../03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-要件定義.md)
- [環境変数設定ガイド](./環境変数設定ガイド.md)

---

## 🔄 更新履歴

- 2025-10-27: 初版作成（セキュリティチェック、環境別設定例を追加）
- 2025-10-27: appsettings.LocalDevelopment.jsonの設定例を追加
- 2025-10-27: IDistributedCache関連のトラブルシューティングを追加

