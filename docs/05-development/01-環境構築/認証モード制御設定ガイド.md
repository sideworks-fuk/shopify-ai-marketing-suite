# èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡è¨­å®šã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Shopify AI Marketing Suiteã®èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ã®è¨­å®šæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ“‹ èªè¨¼ãƒ¢ãƒ¼ãƒ‰ä¸€è¦§

### 1. OAuthRequiredï¼ˆæœ¬ç•ªç’°å¢ƒæ¨å¥¨ï¼‰
**èª¬æ˜**: Shopify OAuthèªè¨¼ã®ã¿ã‚’è¨±å¯ã—ã¾ã™ã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚

**ç‰¹å¾´**:
- æœ€ã‚‚ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¢ãƒ¼ãƒ‰
- Shopifyã‚¹ãƒˆã‚¢çµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯
- æœ¬ç•ªç’°å¢ƒã§ã¯**å¿…é ˆ**

**è¨­å®šä¾‹**:
```json
{
  "Authentication": {
    "Mode": "OAuthRequired"
  }
}
```

### 2. DemoAllowedï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒæ¨å¥¨ï¼‰
**èª¬æ˜**: Shopify OAuthèªè¨¼ã¨ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

**ç‰¹å¾´**:
- OAuthèªè¨¼ã¨ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®ãƒ‡ãƒ¢ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
- æœ¬ç•ªç’°å¢ƒã§ã¯**ç¦æ­¢**

**è¨­å®šä¾‹**:
```json
{
  "Authentication": {
    "Mode": "DemoAllowed"
  }
}
```

### 3. AllAllowedï¼ˆé–‹ç™ºç’°å¢ƒå°‚ç”¨ï¼‰
**èª¬æ˜**: ã™ã¹ã¦ã®èªè¨¼æ–¹å¼ã‚’è¨±å¯ã—ã¾ã™ï¼ˆèªè¨¼ä¸è¦ï¼‰ã€‚

**ç‰¹å¾´**:
- èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆå°‚ç”¨
- æœ¬ç•ªç’°å¢ƒã§ã¯**çµ¶å¯¾ç¦æ­¢**

**è¨­å®šä¾‹**:
```json
{
  "Authentication": {
    "Mode": "AllAllowed"
  }
}
```

---

## âš™ï¸ ç’°å¢ƒåˆ¥è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

### 1. appsettings.jsonï¼ˆãƒ™ãƒ¼ã‚¹è¨­å®šï¼‰
**å ´æ‰€**: `backend/ShopifyAnalyticsApi/appsettings.json`

**ç”¨é€”**: ã™ã¹ã¦ã®ç’°å¢ƒã®ãƒ™ãƒ¼ã‚¹è¨­å®šã€‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```json
{
  "Authentication": {
    "Mode": "#{AUTHENTICATION_MODE}#",
    "Secret": "#{JWT_SECRET}#",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  }
}
```

### 2. appsettings.LocalDevelopment.jsonï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼‰
**å ´æ‰€**: `backend/ShopifyAnalyticsApi/appsettings.LocalDevelopment.json`

**ç”¨é€”**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®è¨­å®šã€‚

**æ¨å¥¨è¨­å®š**:
```json
{
  "Authentication": {
    "Mode": "AllAllowed",
    "Secret": "development-secret-key-replace-in-production",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  },
  "Session": {
    "TimeoutMinutes": 60
  },
  "Demo": {
    "Enabled": true,
    "Password": "dev2026",
    "TokenExpiryMinutes": 60
  },
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  },
  "ForwardedHeaders": {
    "KnownProxies": []
  }
}
```

### 3. appsettings.Production.jsonï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
**å ´æ‰€**: `backend/ShopifyAnalyticsApi/appsettings.Production.json`

**ç”¨é€”**: Azure App Serviceæœ¬ç•ªç’°å¢ƒã®è¨­å®šã€‚

**æ¨å¥¨è¨­å®š**:
```json
{
  "Authentication": {
    "Mode": "OAuthRequired",
    "Secret": "production-secret-key-change-this",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  },
  "Session": {
    "TimeoutMinutes": 60
  },
  "Demo": {
    "Enabled": false,
    "Password": "",
    "TokenExpiryMinutes": 60
  },
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  },
  "ForwardedHeaders": {
    "KnownProxies": []
  }
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

### æœ¬ç•ªç’°å¢ƒã§ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯

`AuthModeMiddleware`ã¯æœ¬ç•ªç’°å¢ƒã§ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```csharp
// æœ¬ç•ªç’°å¢ƒã§OAuthRequiredä»¥å¤–ã®ãƒ¢ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¢ãƒ—ãƒªã¯èµ·å‹•å¤±æ•—ã—ã¾ã™
if (environment == "Production" && authMode != "OAuthRequired")
{
    // ã‚¢ãƒ—ãƒªã¯èµ·å‹•ã§ãã¾ã›ã‚“
    throw new InvalidOperationException("Production must use OAuthRequired mode");
}
```

### è¨­å®šå€¤ã®æ¤œè¨¼

è¨±å¯ã•ã‚Œã‚‹å€¤:
- âœ… `OAuthRequired`
- âœ… `DemoAllowed`
- âœ… `AllAllowed`

ä¸æ­£ãªå€¤:
- âŒ `oauth_required`ï¼ˆå°æ–‡å­—ï¼‰
- âŒ `demo-allowed`ï¼ˆãƒã‚¤ãƒ•ãƒ³ï¼‰
- âŒ `ALLOWED`ï¼ˆå¤§æ–‡å­—ã®ã¿ï¼‰
- âŒ ãã®ä»–ã®å€¤

ä¸æ­£ãªå€¤ãŒè¨­å®šã•ã‚ŒãŸå ´åˆã€**"Unknown authentication mode"**ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

---

## ğŸ› ï¸ è¨­å®šæ–¹æ³•

### æ–¹æ³•1: ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
```powershell
$env:Authentication__Mode="AllAllowed"
dotnet run
```

#### Azure App Service
Azure Portal ã¾ãŸã¯ Azure CLI ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼š
```
Authentication:Mode=OAuthRequired
```

### æ–¹æ³•2: appsettings.{ç’°å¢ƒ}.json ã‚’ä½¿ç”¨

1. `appsettings.{ç’°å¢ƒå}.json`ã‚’ç·¨é›†
2. `Authentication:Mode`ã‚’è¨­å®š
3. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•

---

## ğŸ“ å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³

### Authentication ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¿…é ˆï¼‰

```json
{
  "Authentication": {
    "Mode": "OAuthRequired|DemoAllowed|AllAllowed",
    "Secret": "your-secret-key",
    "Issuer": "ec-ranger",
    "Audience": "shopify-stores"
  }
}
```

### Session ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¨å¥¨ï¼‰

```json
{
  "Session": {
    "TimeoutMinutes": 60
  }
}
```

### Demo ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆDemoAllowedãƒ¢ãƒ¼ãƒ‰ã§å¿…é ˆï¼‰

```json
{
  "Demo": {
    "Enabled": true,
    "Password": "dev2026",
    "TokenExpiryMinutes": 60
  }
}
```

### Redis ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ç•ªç’°å¢ƒã§æ¨å¥¨ï¼‰

```json
{
  "Redis": {
    "InstanceName": "ShopifyAnalyticsApi"
  }
}
```

### ForwardedHeaders ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§å¿…è¦ï¼‰

```json
{
  "ForwardedHeaders": {
    "KnownProxies": ["10.0.0.1", "10.0.0.2"]
  }
}
```

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "Unknown authentication mode"

**åŸå› **: `Authentication:Mode`ãŒç„¡åŠ¹ãªå€¤ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

**è§£æ±ºæ–¹æ³•**:
1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
2. å€¤ãŒä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   - `OAuthRequired`
   - `DemoAllowed`
   - `AllAllowed`

### ã‚¨ãƒ©ãƒ¼: "Production environment must use OAuthRequired mode"

**åŸå› **: æœ¬ç•ªç’°å¢ƒã§OAuthRequiredä»¥å¤–ã®ãƒ¢ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

**è§£æ±ºæ–¹æ³•**:
1. æœ¬ç•ªç’°å¢ƒã®è¨­å®šã‚’`OAuthRequired`ã«å¤‰æ›´
2. ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•

### ã‚¨ãƒ©ãƒ¼: "Unable to resolve service for type 'IDistributedCache'"

**åŸå› **: `IDistributedCache`ã®å®Ÿè£…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

**è§£æ±ºæ–¹æ³•**:
1. `Program.cs`ã§`AddDistributedMemoryCache()`ã¾ãŸã¯`AddStackExchangeRedisCache()`ã‚’ç¢ºèª
2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«`Redis`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ è¨­è¨ˆæ›¸](../../03-feature-development/ã‚¢ãƒ—ãƒªèªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½/Shopify-èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡-è¨­è¨ˆæ›¸.md)
- [èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»](../../03-feature-development/ã‚¢ãƒ—ãƒªèªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½/Shopify-èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡-å®Ÿè£…è¨ˆç”».md)
- [èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½ è¦ä»¶å®šç¾©](../../03-feature-development/ã‚¢ãƒ—ãƒªèªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½/Shopify-èªè¨¼ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡-è¦ä»¶å®šç¾©.md)
- [ç’°å¢ƒå¤‰æ•°è¨­å®šã‚¬ã‚¤ãƒ‰](./ç’°å¢ƒå¤‰æ•°è¨­å®šã‚¬ã‚¤ãƒ‰.md)

---

## ğŸ”„ æ›´æ–°å±¥æ­´

- 2025-10-27: åˆç‰ˆä½œæˆï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã€ç’°å¢ƒåˆ¥è¨­å®šä¾‹ã‚’è¿½åŠ ï¼‰
- 2025-10-27: appsettings.LocalDevelopment.jsonã®è¨­å®šä¾‹ã‚’è¿½åŠ 
- 2025-10-27: IDistributedCacheé–¢é€£ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ 

