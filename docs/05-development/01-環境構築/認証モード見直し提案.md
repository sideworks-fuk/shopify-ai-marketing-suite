# 認証モード見直し提案

## 現状分析

### 現在の認証モード

1. **OAuthRequired**: OAuth認証のみ許可（本番環境推奨）
2. **DemoAllowed**: OAuth認証、デモモード、開発者認証（開発環境のみ）を許可（開発・ステージング環境推奨）
3. ~~**AllAllowed**: すべての認証方式を許可（開発環境専用）~~ ⚠️ **2025-12-26に削除済み**（セキュリティ上の理由によりデフォルトStoreId = 1の使用が禁止されたため）

### 開発者認証の使用状況

#### バックエンド

**エンドポイント**:
- `/api/developer/login` - 開発者ログイン（開発環境のみ）
- `/api/developer/logout` - 開発者ログアウト
- `/api/developer/validate` - 開発者トークン検証

**使用箇所**:
- `ShopifyAuthController` のテスト用エンドポイント（8箇所）
  - `[RequireDeveloperAuth]` 属性が付いている
- `DebugController` - デバッグエンドポイント
- `HangFireJobController` - Hangfireジョブ管理

**特徴**:
- 開発環境（Development）でのみ利用可能
- パスワード認証（bcrypt）
- レート制限とロックアウト機能
- `can_access_dev_tools` クレームを付与

#### フロントエンド

**使用箇所**:
- `/dev-bookmarks` ページ - 開発者ツールページ
- `DevPasswordPrompt` コンポーネント - パスワード入力画面

**特徴**:
- 開発環境でのみ表示
- サーバー側で認証（`/api/developer/login`）
- トークンを `localStorage` に保存

---

## 問題点

### 1. AllAllowed モードの必要性

**現状**:
- `AllAllowed` モードは、認証なしでアクセス可能にする
- 匿名ユーザーとして `Context.User` を設定
- デフォルトの `StoreId = 1` を設定

**問題**:
- 開発環境では、開発者認証（`/api/developer/login`）があれば十分
- `AllAllowed` モードは、認証を完全にスキップするため、セキュリティ上の懸念がある
- 開発者認証があれば、必要なエンドポイントにアクセス可能

### 2. 認証モードの重複

**現状**:
- `AllAllowed`: 認証なしでアクセス可能
- `DemoAllowed`: OAuth認証 or デモモード
- 開発者認証: 開発環境でのみ利用可能

**問題**:
- `AllAllowed` と開発者認証の役割が重複している
- 開発環境では、開発者認証があれば `AllAllowed` は不要

---

## 提案

### 認証モードの簡素化

#### 提案1: AllAllowed モードの削除

**理由**:
1. 開発環境では、開発者認証（`/api/developer/login`）があれば十分
2. `AllAllowed` モードは、認証を完全にスキップするため、セキュリティ上の懸念がある
3. 開発者認証があれば、必要なエンドポイントにアクセス可能

**必要な認証モード**:
1. **OAuthRequired**: OAuth認証必須（本番環境）
2. **DemoAllowed**: OAuth認証 or デモモード（ステージング環境）

**開発環境での動作**:
- `DemoAllowed` モードを使用
- 開発者認証（`/api/developer/login`）で開発ツールにアクセス
- デモモードで通常の機能にアクセス

#### 提案2: 開発者認証の拡張

**現状**:
- 開発者認証は、開発環境でのみ利用可能
- `RequireDeveloperAuth` 属性が付いているエンドポイントのみアクセス可能

**提案**:
- 開発環境では、開発者認証で通常のAPIにもアクセス可能にする
- `DemoAllowed` モードで、開発者認証を許可する

---

## 実装方針

### ステップ1: AllAllowed モードの削除

1. `AuthModeMiddleware.cs` から `AllAllowed` ケースを削除
2. `appsettings.{環境}.json` から `AllAllowed` を削除
3. `Program.cs` から `AllAllowed` 関連のチェックを削除
4. ドキュメントを更新

### ステップ2: 開発環境での認証フロー

**開発環境（Development）**:
- `DemoAllowed` モードを使用
- 開発者認証（`/api/developer/login`）で開発ツールにアクセス
- デモモードで通常の機能にアクセス
- OAuth認証も利用可能

**ステージング環境（Staging）**:
- `DemoAllowed` モードを使用
- OAuth認証 or デモモードでアクセス

**本番環境（Production）**:
- `OAuthRequired` モードを使用
- OAuth認証のみ許可

### ステップ3: 開発者認証の拡張（オプション）

**提案**:
- `DemoAllowed` モードで、開発者認証を許可する
- 開発者認証で通常のAPIにもアクセス可能にする

**実装**:
```csharp
case "DemoAllowed":
    if (!isOAuthValid && !isDemoValid)
    {
        // 開発環境では開発者認証も許可
        if (_env.EnvironmentName == "Development" && isDeveloperValid)
        {
            // 開発者認証を許可
            break;
        }
        
        // 認証エラー
        context.Response.StatusCode = 401;
        await context.Response.WriteAsJsonAsync(new
        {
            error = "Unauthorized",
            message = "OAuth, demo, or developer authentication required"
        });
        return;
    }
    break;
```

---

## 影響範囲

### 削除が必要なコード

1. **AuthModeMiddleware.cs**:
   - `case "AllAllowed":` の削除
   - 匿名ユーザーの自動設定ロジックの削除

2. **appsettings.{環境}.json**:
   - `"Mode": "AllAllowed"` を `"Mode": "DemoAllowed"` に変更

3. **Program.cs**:
   - `AllAllowed` 関連のチェックを削除

4. **ドキュメント**:
   - `AllAllowedモード仕様書.md` の削除または非推奨化
   - 認証モード制御設定ガイドの更新

### 影響を受ける機能

1. **開発環境での動作**:
   - 現在: `AllAllowed` モードで認証なしでアクセス可能
   - 変更後: `DemoAllowed` モード + 開発者認証 or デモモードでアクセス

2. **StoreContext の設定**:
   - 現在: `AllAllowed` モードでデフォルトの `StoreId = 1` を設定
   - 変更後: 開発者認証 or デモモードで適切な `StoreId` を設定

---

## メリット

### 1. セキュリティの向上

- 認証なしでのアクセスを防止
- 開発環境でも認証が必要になる
- 開発者認証で適切なアクセス制御が可能

### 2. コードの簡素化

- 認証モードが2つに削減（OAuthRequired, DemoAllowed）
- `AllAllowed` 関連のコードを削除
- メンテナンス性の向上

### 3. 一貫性の向上

- すべての環境で認証が必要
- 開発環境でも認証フローをテスト可能
- 本番環境との差が小さくなる

---

## デメリット

### 1. 開発効率への影響

- 開発環境でも認証が必要になる
- 開発者認証 or デモモードの設定が必要

### 2. 移行作業

- 既存の設定ファイルの更新
- ドキュメントの更新
- テストの実施

---

## 推奨事項

### 即座に実施すべきこと

1. ✅ **AllAllowed モードの削除を検討**
   - 開発環境では、開発者認証があれば十分
   - `DemoAllowed` モードで代替可能

2. ✅ **認証モードの簡素化**
   - `OAuthRequired`: 本番環境
   - `DemoAllowed`: ステージング・開発環境

3. ✅ **開発者認証の拡張**
   - `DemoAllowed` モードで、開発者認証を許可
   - 開発環境での開発効率を維持

### 検討が必要なこと

1. **StoreContext の設定**
   - 開発者認証 or デモモードで適切な `StoreId` を設定する方法
   - デフォルトの `StoreId` の扱い

2. **移行計画**
   - 既存の開発環境への影響
   - 段階的な移行方法

---

## 次のステップ

1. **現状の確認**
   - 開発環境での `AllAllowed` モードの使用状況を確認
   - 開発者認証の使用状況を確認

2. **影響範囲の確認**
   - 削除による影響を受ける機能の特定
   - テストケースの作成

3. **実装計画の作成**
   - 段階的な移行計画
   - ロールバック計画

4. **実装**
   - `AllAllowed` モードの削除
   - 開発者認証の拡張
   - テストの実施

---

**作成日**: 2025-12-26
**作成者**: AI Assistant
**ステータス**: 提案段階
