# 環境設定統一化ガイド

**作成日**: 2025年8月1日  
**更新日**: 2025年8月1日  
**作成者**: Kenji  
**目的**: ハードコーディングされたURLを排除し、全ての環境設定を一元管理する

## 🎯 目標

1. **ハードコーディングの排除**: `localhost:5000`などのハードコーディングを完全に排除
2. **設定の一元管理**: 環境ごとの設定を明確に管理
3. **ドキュメント化**: 何をどこに設定するかを明確化
4. **フロントエンド・バックエンド統一**: 両方で一貫した設定管理

## 📋 現状の問題点

### フロントエンド
- `localhost:3000`がハードコーディングされている箇所が存在
- 環境変数の使用が統一されていない
- 環境検出ロジックが複雑

### バックエンド
- `localhost:7088`がデフォルト値として使用されている
- 環境ごとの設定ファイルが分散している
- 設定の優先順位が不明確

## 🔧 実装方針

### 1. フロントエンド環境設定

#### 環境変数ファイル構成
```
frontend/
├── .env.development     # 開発環境
├── .env.staging        # ステージング環境
├── .env.production     # 本番環境
└── .env.example        # 設定例（Git管理対象）
```

#### 必要な環境変数
```env
# API接続設定
NEXT_PUBLIC_API_URL=https://api.example.com
NEXT_PUBLIC_BACKEND_URL=https://backend.example.com

# フロントエンドURL
NEXT_PUBLIC_FRONTEND_URL=https://app.example.com

# 環境識別
NEXT_PUBLIC_ENVIRONMENT=development

# Shopify設定
NEXT_PUBLIC_SHOPIFY_API_KEY=your-api-key
```

### 2. バックエンド環境設定

#### 設定ファイル構成
```
backend/ShopifyAnalyticsApi/
├── appsettings.json            # 共通設定
├── appsettings.Development.json # 開発環境
├── appsettings.Staging.json    # ステージング環境
├── appsettings.Production.json # 本番環境
└── appsettings.Example.json    # 設定例（Git管理対象）
```

#### 必要な設定項目
```json
{
  "Frontend": {
    "BaseUrl": "https://app.example.com"
  },
  "Api": {
    "BaseUrl": "https://api.example.com",
    "Port": 7088
  },
  "Shopify": {
    "ApiKey": "your-api-key",
    "ApiSecret": "your-api-secret",
    "WebhookSecret": "your-webhook-secret",
    "EncryptionKey": "your-encryption-key"
  },
  "ConnectionStrings": {
    "DefaultConnection": "your-connection-string"
  }
}
```

### 3. 環境変数の優先順位

#### フロントエンド
1. 環境変数（process.env）
2. .env.{environment}ファイル
3. .envファイル
4. デフォルト値

#### バックエンド
1. 環境変数
2. appsettings.{Environment}.json
3. appsettings.json
4. デフォルト値

## 🔧 環境別設定手順

### ローカル開発環境の設定

#### 1. フロントエンド設定手順

**Step 1: .env.localファイルの作成**
```bash
cd frontend
cp env.example .env.local
```

**Step 2: .env.localの編集**
```env
# バックエンドAPI URL（ローカル開発用）
NEXT_PUBLIC_BACKEND_URL=https://localhost:7088
NEXT_PUBLIC_API_URL=https://localhost:7088

# 環境
NEXT_PUBLIC_ENVIRONMENT=development

# Shopify設定（開発用）
# ※ NEXT_PUBLIC_SHOPIFY_API_KEYは、Shopifyパートナーダッシュボードで
#    アプリ作成時に発行されるClient ID（アプリ共通）です
NEXT_PUBLIC_SHOPIFY_API_KEY=your_dev_api_key
SHOPIFY_API_SECRET=your_dev_api_secret
SHOPIFY_WEBHOOK_SECRET=your_dev_webhook_secret

# フロントエンドURL
NEXT_PUBLIC_FRONTEND_URL=http://localhost:3000

# 開発時のみ（自己署名証明書対応）
NODE_TLS_REJECT_UNAUTHORIZED=0
```

**Step 3: 起動確認**
```bash
npm run dev
# http://localhost:3000 でアクセス可能
```

#### 2. バックエンド設定手順

**Step 1: appsettings.Development.jsonの確認**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=ShopifyTestDB;Trusted_Connection=True;"
  },
  "Shopify": {
    "ApiKey": "your_dev_api_key",
    "ApiSecret": "your_dev_api_secret",
    "WebhookSecret": "your_dev_webhook_secret"
  },
  "Frontend": {
    "BaseUrl": "http://localhost:3000"
  }
}
```

**Step 2: 起動確認**
```bash
cd backend/ShopifyAnalyticsApi
dotnet run
# https://localhost:7088 でAPI利用可能
```

### Azure Static Web Apps（本番環境）の設定

#### 1. Azure Portal での設定手順

**Step 1: Static Web Appリソースへ移動**
1. Azure Portal にログイン
2. リソースグループから該当のStatic Web Appを選択
3. 左メニューから「設定」→「構成」を選択

**Step 2: アプリケーション設定の追加**
以下の環境変数を追加：

| 名前 | 値 | 説明 |
|------|-----|------|
| `NEXT_PUBLIC_API_URL` | `https://shopifytestapi20250720173320.azurewebsites.net` | バックエンドAPI URL |
| `NEXT_PUBLIC_ENVIRONMENT` | `production` | 環境識別子 |
| `NEXT_PUBLIC_SHOPIFY_API_KEY` | `pk_live_xxxxx` | ShopifyパートナーダッシュボードのClient ID |
| `NEXT_PUBLIC_FRONTEND_URL` | `https://your-app.azurestaticapps.net` | フロントエンドURL |

**Step 3: 保存と確認**
1. 「保存」をクリック
2. 自動的にアプリケーションが再起動
3. 数分待って反映を確認

#### 2. Azure CLI での設定手順

**Step 1: Azure CLIにログイン**
```bash
az login
```

**Step 2: 環境変数の設定**
```bash
# Static Web Appの環境変数設定
az staticwebapp appsettings set \
  --name your-static-web-app-name \
  --resource-group your-resource-group \
  --setting-names \
    "NEXT_PUBLIC_API_URL=https://shopifytestapi20250720173320.azurewebsites.net" \
    "NEXT_PUBLIC_ENVIRONMENT=production" \
    "NEXT_PUBLIC_SHOPIFY_API_KEY=pk_live_xxxxx" \
    "NEXT_PUBLIC_FRONTEND_URL=https://your-app.azurestaticapps.net"
```

**Step 3: 設定の確認**
```bash
# 設定した環境変数の確認
az staticwebapp appsettings list \
  --name your-static-web-app-name \
  --resource-group your-resource-group
```

#### 3. GitHub Actions での自動設定

**.github/workflows/azure-static-web-apps.yml**
```yaml
- name: Build And Deploy
  uses: Azure/static-web-apps-deploy@v1
  with:
    azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
    repo_token: ${{ secrets.GITHUB_TOKEN }}
    action: "upload"
    app_location: "/frontend"
    api_location: ""
    output_location: "out"
  env:
    # ビルド時の環境変数
    NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
    NEXT_PUBLIC_ENVIRONMENT: production
```

### Shopify API Key/Secretの取得方法

#### NEXT_PUBLIC_SHOPIFY_API_KEY（Client ID）の取得

1. [Shopifyパートナーダッシュボード](https://partners.shopify.com)にログイン
2. 「アプリ」→「すべてのアプリ」から該当アプリを選択
3. 「アプリ設定」→「クライアントの認証情報」
4. **Client ID**をコピー（これがNEXT_PUBLIC_SHOPIFY_API_KEY）

**重要**: これはアプリ提供者が1つだけ持つID。各ストアのアクセストークンとは異なります。

#### SHOPIFY_API_SECRET（Client Secret）の取得

1. 上記と同じ「クライアントの認証情報」画面
2. **Client secret**をコピー（これがSHOPIFY_API_SECRET）
3. **注意**: サーバーサイドのみで使用。フロントエンドには絶対に含めない

#### SHOPIFY_WEBHOOK_SECRETの生成と管理

**重要**: Shopify Partner DashboardではWebhook Secretは提供されません。アプリ側で生成・管理する必要があります。

##### 1. セキュアなWebhook Secret生成方法

**C# (.NET)での生成例**:
```csharp
using System.Security.Cryptography;

public static string GenerateWebhookSecret()
{
    // 32バイト（256ビット）のランダムな値を生成
    var randomBytes = new byte[32];
    using (var rng = RandomNumberGenerator.Create())
    {
        rng.GetBytes(randomBytes);
    }
    
    // Base64エンコードして返す
    return Convert.ToBase64String(randomBytes);
}

// 使用例
var webhookSecret = GenerateWebhookSecret();
// 例: "kJH8s9d7f6g5h4j3k2l1qwertyuiopasdfghjklzxc="
```

**Node.js/JavaScriptでの生成例**:
```javascript
const crypto = require('crypto');

function generateWebhookSecret() {
    // 32バイトのランダムな値を生成
    return crypto.randomBytes(32).toString('base64');
}

// 使用例
const webhookSecret = generateWebhookSecret();
```

##### 2. 環境別のSecret管理

```env
# 開発環境（.env.local）
SHOPIFY_WEBHOOK_SECRET=dev_kJH8s9d7f6g5h4j3k2l1qwertyuiopasdfghjklzxc=

# ステージング環境
SHOPIFY_WEBHOOK_SECRET=stg_mN9p8o7i6u5y4t3r2e1wqazxscdvfbgnhmjklpoiu=

# 本番環境（Azure App Service設定）
SHOPIFY_WEBHOOK_SECRET=prd_zX9c8v7b6n5m4lkjhgfdsaqwertyuiopmnbvcxza=
```

##### 3. Webhook検証の実装

**C# (.NET)での検証実装**:
```csharp
public class WebhookValidator
{
    private readonly string _webhookSecret;
    
    public WebhookValidator(IConfiguration configuration)
    {
        _webhookSecret = configuration["Shopify:WebhookSecret"];
    }
    
    public bool ValidateWebhook(string rawBody, string shopifyHmacHeader)
    {
        // HMAC-SHA256でハッシュを計算
        using (var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(_webhookSecret)))
        {
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(rawBody));
            var calculatedHmac = Convert.ToBase64String(hash);
            
            // タイミング攻撃を防ぐため、セキュアな比較を実行
            return CryptographicOperations.FixedTimeEquals(
                Encoding.UTF8.GetBytes(calculatedHmac),
                Encoding.UTF8.GetBytes(shopifyHmacHeader)
            );
        }
    }
}
```

##### 4. 初回設定手順

**Step 1: Secret生成**
```bash
# PowerShell
[System.Convert]::ToBase64String((1..32 | ForEach {Get-Random -Maximum 256}))

# Linux/Mac
openssl rand -base64 32
```

**Step 2: 環境変数設定**
```json
// appsettings.Development.json
{
  "Shopify": {
    "WebhookSecret": "生成したSecret値"
  }
}
```

**Step 3: Azure設定（本番環境）**
```bash
az webapp config appsettings set \
  --name your-app-name \
  --resource-group your-rg \
  --settings "Shopify__WebhookSecret=生成したSecret値"
```

##### 5. セキュリティベストプラクティス

1. **Secret生成要件**:
   - 最低32バイト（256ビット）以上
   - 暗号学的に安全な乱数生成器を使用
   - 環境ごとに異なるSecretを使用

2. **Secret管理**:
   - ソースコードにハードコードしない
   - Azure Key Vaultでの管理を推奨
   - 定期的な更新（3-6ヶ月ごと）

3. **実装上の注意**:
   - HMAC検証は必ずサーバーサイドで実行
   - タイミング攻撃対策（固定時間比較）
   - ログにSecretを出力しない

**使用用途**:
- Shopifyからのリクエストの正当性検証
- GDPR Webhookの検証
- アプリアンインストール通知の検証

### 環境変数のセキュリティベストプラクティス

#### 1. 秘密情報の管理
- **開発環境**: `.env.local` ファイル（gitignore対象）
- **本番環境**: Azure Key Vault または Azure設定
- **CI/CD**: GitHub Secrets

#### 2. 環境変数の命名規則
- **公開可能**: `NEXT_PUBLIC_` プレフィックス
- **サーバーサイドのみ**: プレフィックスなし
- **例**:
  - `NEXT_PUBLIC_API_URL` ✅ （クライアントで使用可）
  - `DATABASE_PASSWORD` ✅ （サーバーのみ）
  - `API_SECRET` ✅ （サーバーのみ）

#### 3. gitignoreの設定
```gitignore
# 環境変数ファイル
.env.local
.env.development.local
.env.production.local
.env.test.local

# 秘密情報
*.key
*.pem
*.cert
```

### トラブルシューティング

#### よくある問題と解決方法

**1. 環境変数が反映されない**
- フロントエンド: `npm run dev` を再起動
- Azure: 設定保存後、5-10分待つ
- キャッシュクリア: ブラウザのキャッシュをクリア

**2. NEXT_PUBLIC_プレフィックスの問題**
- ビルド時に環境変数が必要
- 実行時の変更は反映されない
- 解決: ビルドし直す

**3. Azure設定が見つからない**
- リソース名を確認
- リソースグループを確認
- 権限を確認（Contributor以上）

**4. ローカルでHTTPSエラー**
```env
# .env.localに追加
NODE_TLS_REJECT_UNAUTHORIZED=0
```

## 📝 実装タスク

### Phase 1: 調査と計画（8/1）
- [x] ハードコーディング箇所の特定
- [ ] 影響範囲の分析
- [ ] 実装計画の詳細化

### Phase 2: バックエンド実装（8/2）
- [ ] 設定管理クラスの実装
- [ ] ハードコーディング箇所の修正
- [ ] 環境別設定ファイルの整備
- [ ] テスト実装

### Phase 3: フロントエンド実装（8/2-8/3）
- [ ] 環境設定モジュールの改善
- [ ] ハードコーディング箇所の修正
- [ ] 環境変数ファイルの整備
- [ ] テスト実装

### Phase 4: ドキュメント化（8/3）
- [ ] 設定ガイドの作成
- [ ] 環境別設定手順書
- [ ] トラブルシューティングガイド

## 🚀 実装優先順位

### 緊急度：高
1. OAuth認証関連の設定（8月8日申請に直接影響）
2. API接続URL（現在の統合テストに必要）
3. フロントエンドURL（リダイレクト処理）

### 緊急度：中
1. データベース接続文字列
2. ログ設定
3. キャッシュ設定

### 緊急度：低
1. 開発ツール関連設定
2. デバッグ設定
3. その他の最適化設定

## 🔍 チェックリスト

### 設定移行前の確認
- [ ] 現在の設定値をバックアップ
- [ ] 環境ごとの差異を文書化
- [ ] 依存関係の確認

### 設定移行後の確認
- [ ] 全環境での動作確認
- [ ] ハードコーディングが残っていないか確認
- [ ] 設定値の正常読み込み確認
- [ ] エラーハンドリングの確認

## 📚 参考資料

- [Next.js環境変数ドキュメント](https://nextjs.org/docs/basic-features/environment-variables)
- [ASP.NET Core設定ドキュメント](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)
- 既存の環境設定ファイル（`environments.ts`、`appsettings.json`）

---

このガイドに基づいて、環境設定の統一化を進めていきます。