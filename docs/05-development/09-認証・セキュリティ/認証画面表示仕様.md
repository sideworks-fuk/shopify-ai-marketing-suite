# 認証画面の表示仕様

## 概要

`AuthenticationRequired.tsx` コンポーネントは、未認証ユーザーに対して表示される認証画面です。
環境やURLパラメータに応じて、表示内容が動的に変化します。

## 実装ファイル

- **メインファイル**: `frontend/src/components/errors/AuthenticationRequired.tsx`
- **呼び出し元**: `frontend/src/components/auth/AuthGuard.tsx`

## 環境変数による制御

### 使用される環境変数

| 環境変数 | 用途 | 設定場所 | 評価タイミング |
|---------|------|---------|--------------|
| `NODE_ENV` | ビルドモード判定 | Next.js自動設定 | ビルド時 |
| `NEXT_PUBLIC_ENVIRONMENT` | デプロイ環境判定 | GitHub Actions / Azure | ビルド時 |

### 環境判定ロジック

```typescript
// 1. タイトル表示の判定（85-88行目）
const title = process.env.NODE_ENV === 'production' 
  ? 'Shopify認証が必要です'  // 本番ビルド
  : '認証が必要です'          // 開発ビルド

// 2. 本番環境かどうかの判定（74-79行目）
const isProductionEnvironment = 
  process.env.NEXT_PUBLIC_ENVIRONMENT === 'production' ||
  (typeof window !== 'undefined' && 
   !window.location.hostname.includes('development') &&
   !window.location.hostname.includes('staging') &&
   !window.location.hostname.includes('localhost'))
```

## 表示パターン一覧

### パターン1: 本番環境 + shopパラメータなし（91-114行目）

**表示条件:**
```typescript
process.env.NODE_ENV === 'production' && !hasShopParam
```

**表示内容:**
- タイトル: 「Shopify認証が必要です」
- メッセージ: 「このアプリはShopify管理画面から起動してください。」
- 起動方法の説明（3ステップ）
- ボタン: 「Shopify管理画面を開く」（admin.shopify.comへのリンク）
- デモリンク: **表示なし**

**用途:** Shopifyアプリとして正しくインストールされていない場合のガイダンス

---

### パターン2: 本番環境 + shopパラメータあり（115-128行目）

**表示条件:**
```typescript
process.env.NODE_ENV === 'production' && hasShopParam
```

**表示内容:**
- タイトル: 「Shopify認証が必要です」
- メッセージ: 「セッションが無効または期限切れです。Shopify認証を実行してください。」
- ボタン: 「Shopifyで認証する」（OAuth認証開始）
- デモリンク: **表示なし**（本来）

**用途:** 本番環境での通常のShopify OAuth認証

---

### パターン3: 検証環境（131-146行目）

**表示条件:**
```typescript
process.env.NODE_ENV !== 'production'
```

**表示内容:**
- タイトル: 「認証が必要です」
- メッセージ: 「このアプリにアクセスするには認証が必要です。」
- ボタン: 「Shopifyで認証する」（OAuth認証開始）
- 補足: 「💡 Shopify OAuth認証フローをテストできます。」
- デモリンク: **表示あり**（148-171行目）

**用途:** 開発・ステージング環境でのOAuth認証テスト

---

### デモ・プレゼンテーション用セクション（148-171行目）

**表示条件（本来の仕様）:**
```typescript
!isProductionEnvironment
```

**表示条件（現在の一時対応）:**
```typescript
true  // 🔧 デバッグ用に常に表示
```

**表示内容:**
- タイトル: 「🎯 デモ・プレゼンテーション用」
- 説明: 「Shopify認証なしでデータを確認できます。」
- ボタン: 「デモサイトを開く」（`/dev-bookmarks` へのリンク）
- 注意: 「※ パスワード認証でアクセスできます」

**用途:** デモ・プレゼンテーション時にShopify認証なしでアプリを確認

---

## 制御ポイント整理

### 1. タイトルの切り替え

**制御箇所:** 84-88行目

```typescript
<h1 className="text-2xl font-bold mb-2">
  {process.env.NODE_ENV === 'production' 
    ? 'Shopify認証が必要です'  // 本番ビルド
    : '認証が必要です'}         // 開発ビルド
</h1>
```

**判定基準:**
- `NODE_ENV === 'production'` → 「Shopify認証が必要です」
- `NODE_ENV !== 'production'` → 「認証が必要です」

---

### 2. メッセージの切り替え

**制御箇所:** 117-121行目

```typescript
<p className="text-gray-600 mb-6">
  {process.env.NODE_ENV === 'production'
    ? (message ?? 'セッションが無効または期限切れです。Shopify認証を実行してください。')
    : (message ?? 'このアプリにアクセスするには認証が必要です。')}
</p>
```

**判定基準:**
- `NODE_ENV === 'production'` → Shopify特化メッセージ
- `NODE_ENV !== 'production'` → 汎用メッセージ

---

### 3. 表示パターンの分岐

**制御箇所:** 90-115行目（パターン1）、115-173行目（パターン2/3）

```typescript
{process.env.NODE_ENV === 'production' && !hasShopParam ? (
  // パターン1: Shopify管理画面へ誘導
) : (
  // パターン2/3: OAuth認証ボタン + デモリンク
)}
```

**判定基準:**
- `NODE_ENV === 'production' && !hasShopParam` → パターン1
- それ以外 → パターン2/3

---

### 4. Shopify認証ボタンの表示

**制御箇所:** 123-146行目

```typescript
{/* 本番環境: Shopify認証のみ */}
{process.env.NODE_ENV === 'production' && (
  <Button onClick={onShopifyAuth} disabled={isInitializing} className="w-full">
    Shopifyで認証する
  </Button>
)}

{/* 検証環境: Shopify認証ボタン + 説明 */}
{process.env.NODE_ENV !== 'production' && (
  <div className="space-y-3">
    <Button onClick={onShopifyAuth} disabled={isInitializing} className="w-full" variant="default">
      Shopifyで認証する
    </Button>
    <p className="text-xs text-gray-500 mt-2">
      💡 Shopify OAuth認証フローをテストできます。
    </p>
  </div>
)}
```

**判定基準:**
- `NODE_ENV === 'production'` → シンプルなボタンのみ
- `NODE_ENV !== 'production'` → ボタン + 説明文

---

### 5. デモリンクの表示

**制御箇所:** 148-171行目

**本来の仕様:**
```typescript
{!isProductionEnvironment && (
  // デモ・プレゼンテーション用セクション
)}
```

**現在の一時対応:**
```typescript
{/* 🔧 一時的に常に表示（デバッグ用） */}
{true && (
  // デモ・プレゼンテーション用セクション
)}
```

**判定基準（本来）:**
- `!isProductionEnvironment` → 表示
- `isProductionEnvironment` → 非表示

**判定基準（現在）:**
- 常に表示（デバッグ用）

---

## 環境別の表示まとめ

| 環境 | NODE_ENV | NEXT_PUBLIC_ENVIRONMENT | タイトル | OAuth認証 | デモリンク（本来） | デモリンク（現在） |
|------|----------|------------------------|---------|-----------|------------------|------------------|
| ローカル開発 | development | development | 認証が必要です | ✅ + 説明 | ✅ 表示 | ✅ 表示 |
| Development | production | development | Shopify認証が必要です | ✅ のみ | ✅ 表示 | ✅ 表示 |
| Staging | production | staging | Shopify認証が必要です | ✅ のみ | ✅ 表示 | ✅ 表示 |
| Production | production | production | Shopify認証が必要です | ✅ のみ | ❌ 非表示 | ✅ 表示（要修正） |

---

## 問題点と対応

### 現在の問題

1. **ステージング環境でデモリンクが表示されない**
   - 原因: `NEXT_PUBLIC_ENVIRONMENT` が正しく設定されていない可能性
   - 一時対応: `{true &&` で常に表示

2. **環境判定ロジックの複雑さ**
   - `NODE_ENV` と `NEXT_PUBLIC_ENVIRONMENT` の2つの変数を使用
   - ビルド時とランタイムの判定が混在

### 推奨される修正

#### オプション1: 環境変数を統一

```typescript
// NEXT_PUBLIC_ENVIRONMENT のみで判定
const isProduction = process.env.NEXT_PUBLIC_ENVIRONMENT === 'production'
const isDevelopment = process.env.NEXT_PUBLIC_ENVIRONMENT === 'development'
const isStaging = process.env.NEXT_PUBLIC_ENVIRONMENT === 'staging'

// タイトル
const title = isProduction ? 'Shopify認証が必要です' : '認証が必要です'

// デモリンク
{(isDevelopment || isStaging) && (
  // デモ・プレゼンテーション用セクション
)}
```

#### オプション2: ランタイム判定を優先

```typescript
// ホスト名で判定（ランタイム）
const hostname = typeof window !== 'undefined' ? window.location.hostname : ''
const isLocalhost = hostname.includes('localhost')
const isDevelopmentEnv = hostname.includes('development')
const isStagingEnv = hostname.includes('staging')
const isNonProduction = isLocalhost || isDevelopmentEnv || isStagingEnv

// デモリンク
{isNonProduction && (
  // デモ・プレゼンテーション用セクション
)}
```

---

## 関連ファイル

- **認証画面**: `frontend/src/components/errors/AuthenticationRequired.tsx`
- **認証ガード**: `frontend/src/components/auth/AuthGuard.tsx`
- **認証プロバイダー**: `frontend/src/components/providers/AuthProvider.tsx`
- **デモモードページ**: `frontend/src/app/dev-bookmarks/page.tsx`
- **環境設定**: `.github/workflows/develop_frontend.yml`
- **ドキュメント**: 
  - [認証モード一覧](./認証モード一覧.md)
  - [環境変数チェックリスト](./環境変数チェックリスト.md)
  - [Shopify アプリ認証・認可設計](../../06-shopify/06-技術ガイド/Shopify のアプリ認証・認可設計.md)

---

## 更新履歴

- 2025-10-24: 初版作成（認証画面の仕様整理）
- 2025-10-25: ファイル名を日本語に変更、09-認証・セキュリティフォルダに移動

