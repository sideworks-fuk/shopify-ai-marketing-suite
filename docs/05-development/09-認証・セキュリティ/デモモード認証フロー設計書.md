# デモモード認証フロー設計書

## 更新履歴
- 2026-01-23: 修正実装完了（demoTokenのsessionStorageバックアップ、フォールバック処理追加）
- 2026-01-23: 初版作成（認証切れ問題の調査・修正中）

---

## 1. 概要

### 1.1 目的
デモモード認証フローの設計と実装状況を文書化し、現在発生している「認証切れ（ストア不明）」問題の原因を特定し、解決策を検討する。

### 1.2 対象範囲
- デモログイン処理（`/demo/login`）
- AuthProvider の認証状態管理
- ApiClient の認証ヘッダー設定
- ページ遷移時の認証状態維持

---

## 2. 現在の設計

### 2.1 認証フロー概要

```
[デモログイン]
    ↓
[バックエンド認証] (/api/demo/login)
    ↓
[JWTトークン取得 + storeId抽出]
    ↓
[localStorage/sessionStorageに保存]
    ↓
[/setup/initial にリダイレクト]
    ↓
[AuthProvider 初期化]
    ↓
[ApiClient 初期化]
    ↓
[API呼び出し（X-Store-Id ヘッダー付き）]
```

### 2.2 データ保存方法

#### 2.2.1 デモログイン時（`demo/login/page.tsx`）

**保存先:**
- `localStorage`:
  - `demoToken`: JWTトークン
  - `authMode`: `'demo'`
  - `readOnly`: `'true'`
  - `currentStoreId`: ストアID（文字列）
- `sessionStorage`:
  - `currentStoreId`: ストアID（文字列）
  - `authMode`: `'demo'`

**保存タイミング:**
- ログイン成功時（`/api/demo/login` レスポンス受信後）
- JWTトークンから `store_id` を抽出して保存

#### 2.2.2 認証状態の取得方法

**優先順位:**
1. `AuthProvider` の state (`currentStoreId`)
2. `localStorage.getItem('currentStoreId')`
3. `sessionStorage.getItem('currentStoreId')`

**実装箇所:**
- `AuthProvider.getCurrentStoreIdFn()`: 常に `localStorage/sessionStorage` から直接取得（クロージャ問題回避）
- `ApiClient.getAuthHeaders()`: `getCurrentStoreId()` → `localStorage` → `sessionStorage` の順で取得

### 2.3 AuthProvider の役割

#### 2.3.1 主要な状態管理

```typescript
interface AuthContextType {
  isAuthenticated: boolean
  isInitializing: boolean
  isApiClientReady: boolean
  currentStoreId: number | null
  authError: string | null
  authMode: 'shopify' | 'demo' | 'developer' | null
  resolveStoreId: () => Promise<number | null>
  // ...
}
```

#### 2.3.2 初期化フロー

1. **APIクライアント初期化** (`useEffect`)
   - `demoToken` を検出 → `authMode = 'demo'` に設定
   - `ApiClient` を初期化（`getDemoToken`, `getCurrentStoreId` オプション付き）

2. **認証状態の初期化** (`useEffect`)
   - `demoToken` を確認 → `isAuthenticated = true`
   - `localStorage` から `currentStoreId` を復元

3. **ページ遷移時の処理** (`useEffect` with `pathname`)
   - デモモード/開発者モードの場合、`localStorage/sessionStorage` から `currentStoreId` を再取得
   - `AuthProvider` の state を更新

#### 2.3.3 resolveStoreId() の実装

```typescript
const resolveStoreId = async (): Promise<number | null> => {
  // 1. getCurrentStoreIdFn() で取得を試みる
  let storeId = getCurrentStoreIdFn();
  if (storeId !== null && storeId > 0) {
    return storeId;
  }
  
  // 2. デモモード/開発者モードの場合
  if (effectiveAuthMode === 'demo' || effectiveAuthMode === 'developer') {
    // getCurrentStoreIdFn() で取得できなかった場合、localStorage から直接再取得
    if (storeId === null) {
      const savedStoreId = localStorage.getItem('currentStoreId');
      if (savedStoreId) {
        const parsedStoreId = parseInt(savedStoreId, 10);
        if (!isNaN(parsedStoreId) && parsedStoreId > 0) {
          setCurrentStoreId(parsedStoreId);
          return parsedStoreId;
        }
      }
      // sessionStorage からも試みる
      // ...
    }
    return storeId; // null または取得できた値
  }
  
  // 3. Shopify OAuth 認証の場合、APIから取得
  // ...
}
```

### 2.4 ApiClient の役割

#### 2.4.1 認証ヘッダーの設定順序

```typescript
private async getAuthHeaders(): Promise<HeadersInit> {
  let currentStoreId: string | null = null;
  
  // 1. AuthProvider から取得
  if (this.options.getCurrentStoreId) {
    currentStoreId = this.options.getCurrentStoreId()?.toString() || null;
  }
  
  // 2. localStorage から取得
  if (!currentStoreId) {
    currentStoreId = localStorage.getItem('currentStoreId');
  }
  
  // 3. sessionStorage から取得
  if (!currentStoreId) {
    currentStoreId = sessionStorage.getItem('currentStoreId');
    // localStorage にも保存（次回以降のため）
  }
  
  // 4. X-Store-Id ヘッダーを設定
  if (currentStoreId) {
    headers['X-Store-Id'] = currentStoreId;
  }
  
  // 5. Authorization ヘッダーを設定（デモトークン優先）
  if (this.options.getDemoToken) {
    const token = this.options.getDemoToken();
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      return headers;
    }
  }
  
  // ...
}
```

---

## 3. 現在の問題点

### 3.1 問題の症状

1. **ログイン直後（`/setup/initial`）**: ✅ 正常動作
   - `storeId: 46` が正常に取得される
   - `X-Store-Id` ヘッダーが正しく設定される
   - API呼び出しが成功する

2. **ページ遷移後（`/sales/year-over-year` など）**: ❌ エラー発生
   - `localStorage` から `currentStoreId` が取得できない（`null`）
   - `sessionStorage` からも取得できない（`null`）
   - `X-Store-Id` ヘッダーが設定されない
   - `401 Unauthorized` エラーが発生
   - 認証エラーが発生し、認証情報がクリアされる

### 3.2 問題の原因（仮説）

#### 3.2.1 認証エラーによる認証情報のクリア

**現在の実装:**
```typescript
// AuthProvider.tsx (認証エラー処理)
if (effectiveAuthMode === 'demo' || effectiveAuthMode === 'developer') {
  // トークンのみクリア（currentStoreIdとauthModeは保持）
  localStorage.removeItem('demoToken')
  localStorage.removeItem('demo_token')
  localStorage.removeItem('developerToken')
  // currentStoreId と authMode は保持されるはず
}
```

**問題点:**
- 認証エラーが発生すると、トークンがクリアされる
- トークンがクリアされると、次回のAPI呼び出しで再度認証エラーが発生
- 無限ループの可能性

#### 3.2.2 ページ遷移時の localStorage クリア

**可能性:**
- サードパーティストレージの制限（Shopify iframe 内の場合）
- ブラウザの設定による自動クリア
- 別のコードによる意図しないクリア

**確認が必要:**
- ページ遷移時に `localStorage` がクリアされているか
- クリアしているコードがないか

#### 3.2.3 タイミングの問題

**可能性:**
- `AuthProvider` の初期化が完了する前に API呼び出しが実行される
- `getCurrentStoreIdFn()` が呼ばれる時点で、まだ `localStorage` に値が保存されていない

---

## 4. 実装されている対策

### 4.1 対策1: sessionStorage への保存

**実装箇所:** `demo/login/page.tsx`
```typescript
// localStorage と sessionStorage の両方に保存
localStorage.setItem('currentStoreId', storeId.toString())
sessionStorage.setItem('currentStoreId', storeId.toString())
```

**効果:**
- `localStorage` がクリアされても、`sessionStorage` から取得可能

### 4.2 対策2: 認証エラー時の currentStoreId 保持

**実装箇所:** `AuthProvider.tsx`
```typescript
if (effectiveAuthMode === 'demo' || effectiveAuthMode === 'developer') {
  // トークンのみクリア（currentStoreIdとauthModeは保持）
  localStorage.removeItem('demoToken')
  // currentStoreId と authMode は保持
}
```

**効果:**
- 認証エラーが発生しても、`currentStoreId` は保持される

### 4.3 対策3: resolveStoreId() での再取得

**実装箇所:** `AuthProvider.tsx`
```typescript
if (effectiveAuthMode === 'demo' || effectiveAuthMode === 'developer') {
  // getCurrentStoreIdFn() で取得できなかった場合、localStorage から直接再取得
  if (storeId === null) {
    const savedStoreId = localStorage.getItem('currentStoreId');
    // ...
  }
}
```

**効果:**
- `getCurrentStoreIdFn()` で取得できなかった場合でも、直接 `localStorage` から取得を試みる

### 4.4 対策4: ページ遷移時の再取得

**実装箇所:** `AuthProvider.tsx`
```typescript
useEffect(() => {
  // ページ遷移時に currentStoreId を再取得
  if (isDeveloperMode || isDemoMode || developerToken || demoToken) {
    let savedStoreId = localStorage.getItem('currentStoreId');
    if (!savedStoreId) {
      savedStoreId = sessionStorage.getItem('currentStoreId');
    }
    // AuthProvider の state を更新
  }
}, [pathname, authMode, currentStoreId])
```

**効果:**
- ページ遷移時に `localStorage/sessionStorage` から `currentStoreId` を再取得し、`AuthProvider` の state を更新

---

## 5. 残っている課題

### 5.1 課題1: 認証エラーの無限ループ

**問題:**
- 認証エラーが発生 → トークンがクリアされる
- トークンがクリアされると、次回のAPI呼び出しで再度認証エラーが発生
- 無限ループになる可能性

**検討が必要:**
- 認証エラーが発生した場合、トークンをクリアせずに再取得を試みる
- または、認証エラーが発生した場合、ユーザーに再ログインを促す

### 5.2 課題2: localStorage のクリア原因の特定

**問題:**
- ページ遷移時に `localStorage` から `currentStoreId` が取得できない
- クリアしているコードが特定できていない

**検討が必要:**
- ページ遷移時に `localStorage` がクリアされているか確認
- クリアしているコードがないか調査
- サードパーティストレージの制限の有無を確認

### 5.3 課題3: タイミングの問題

**問題:**
- `AuthProvider` の初期化が完了する前に API呼び出しが実行される可能性
- `getCurrentStoreIdFn()` が呼ばれる時点で、まだ `localStorage` に値が保存されていない可能性

**検討が必要:**
- API呼び出し前に `isApiClientReady` と `isAuthenticated` を確認
- `resolveStoreId()` を呼び出してから API呼び出しを実行

---

## 6. 次のステップ

### 6.1 調査項目

1. **ページ遷移時の localStorage 状態確認**
   - ページ遷移前後で `localStorage` の内容をログ出力
   - クリアしているコードがないか調査

2. **認証エラーの発生タイミング確認**
   - 認証エラーが発生する直前のログを確認
   - `X-Store-Id` ヘッダーが設定されているか確認

3. **タイミングの問題の確認**
   - `AuthProvider` の初期化完了を待ってから API呼び出しを実行しているか確認

### 6.2 修正案

1. **認証エラー時の処理改善**
   - デモモードの場合、認証エラーが発生してもトークンをクリアしない
   - または、認証エラーが発生した場合、自動的に再ログインを試みる

2. **localStorage の永続化**
   - `localStorage` がクリアされないように、定期的に `sessionStorage` から復元
   - または、`IndexedDB` を使用して永続化

3. **API呼び出し前の確認強化**
   - `resolveStoreId()` を呼び出してから API呼び出しを実行
   - `storeId` が取得できない場合、エラーを表示して再ログインを促す

---

## 7. 参考資料

### 7.1 関連ファイル

- `frontend/src/app/demo/login/page.tsx`: デモログインページ
- `frontend/src/components/providers/AuthProvider.tsx`: 認証プロバイダー
- `frontend/src/lib/api-client.ts`: APIクライアント

### 7.2 関連ドキュメント

- `docs/05-development/09-認証・セキュリティ/`: 認証関連ドキュメント

---

## 8. ログ分析

### 8.1 正常なログ（ログイン直後）

```
✅ [DemoLogin] 認証情報を保存しました {storeId: 46, hasLocalStorage: true, hasSessionStorage: true}
✅ [AuthProvider.getCurrentStoreIdFn] localStorage から取得成功 {storeId: 46}
🔧 [ApiClient.getAuthHeaders] X-Store-Id ヘッダーを設定（AuthProvider から） {storeId: '46'}
✅ 同期統計を取得: {customers: 25, orders: 326, products: 10}
```

### 8.2 エラー時のログ（ページ遷移後）

```
🔍 [AuthProvider.getCurrentStoreIdFn] localStorage から取得 {savedStoreId: null}
🔍 [AuthProvider.getCurrentStoreIdFn] sessionStorage から取得を試みる {sessionStoreId: null}
⚠️ [AuthProvider.getCurrentStoreIdFn] currentStoreId が見つかりませんでした
⚠️ [ApiClient.getAuthHeaders] AuthProvider から currentStoreId を取得できませんでした
❌ [APIClient.request] API Error: 401 Unauthorized
🔴 [AuthProvider] グローバル認証エラー発火: 認証情報をクリアします
```

---

## 9. 実施した修正（2026-01-23）

### 9.1 修正内容

#### 9.1.1 `demo/login/page.tsx` の修正

**目的**: `demoToken` の保存処理にデバッグログとエラーハンドリングを追加

**変更点**:
- `demoToken` を `localStorage` と `sessionStorage` の両方に保存
- 保存結果を確認し、失敗した場合はエラーを表示
- 詳細なデバッグログを追加

#### 9.1.2 `AuthProvider.tsx` の修正（APIクライアント初期化）

**目的**: `savedAuthMode === 'demo'` だが `demoToken` がない場合のフォールバック処理を追加

**変更点**:
- `sessionStorage` から `demoToken` を取得を試みる
- 取得できた場合は `localStorage` にも復元
- 取得できない場合はエラーメッセージを表示し、再ログインを促す

#### 9.1.3 `AuthProvider.tsx` の修正（グローバル認証エラーハンドラ）

**目的**: デモモード時に認証エラーが発生しても無限ループに陥らないようにする

**変更点**:
- デモモード/開発者モードの場合、トークンをクリアしない
- `sessionStorage` から `demoToken` を復元を試みる
- `isAuthenticated` を `false` にしない（早期リターン）
- OAuth認証の場合のみ、認証情報をクリア

#### 9.1.4 `api-client.ts` の修正

**目的**: `getDemoToken` で取得できない場合のフォールバック処理を追加

**変更点**:
- `getDemoToken()` が `null` を返した場合、`sessionStorage` から取得を試みる
- 取得できた場合は `localStorage` にも復元

### 9.2 修正後のフロー

```
[デモログイン]
    ↓
[バックエンド認証] (/api/demo/login)
    ↓
[JWTトークン取得 + storeId抽出]
    ↓
[localStorage + sessionStorage に保存] ← 両方に保存
    ↓
[/setup/initial にリダイレクト]
    ↓
[AuthProvider 初期化]
    ├── demoToken あり → デモモードで初期化
    └── demoToken なし、authMode='demo' → sessionStorageから復元を試みる
    ↓
[ApiClient 初期化]
    ├── getDemoToken() で取得 → Authorization ヘッダー設定
    └── getDemoToken() で取得できない → sessionStorageから復元を試みる
    ↓
[API呼び出し（X-Store-Id + Authorization ヘッダー付き）]
    ↓
[認証エラー発生時]
    ├── デモモード → トークン保持、sessionStorageから復元を試みる
    └── OAuthモード → 認証情報クリア
```

---

## 10. まとめ

修正後の設計では、デモモード認証フローは以下のように実装されています：

1. **デモログイン時**: `localStorage` と `sessionStorage` の両方に `demoToken` と `currentStoreId` を保存
2. **認証状態の取得**: `AuthProvider` state → `localStorage` → `sessionStorage` の順で取得
3. **フォールバック処理**: `localStorage` から取得できない場合、`sessionStorage` から復元を試みる
4. **認証エラー時**: デモモードの場合、トークンをクリアせず、`sessionStorage` から復元を試みる

この修正により、`localStorage` がクリアされた場合でも `sessionStorage` から認証情報を復元でき、無限ループを防止できます。
