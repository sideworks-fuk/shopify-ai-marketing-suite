# 環境変数チェックリスト

## 概要

このドキュメントでは、各環境で設定すべき環境変数と、その確認方法をまとめています。

## 環境変数一覧

### フロントエンド（Next.js）

| 変数名 | 必須 | 用途 | 設定場所 | 評価タイミング |
|--------|------|------|---------|--------------|
| `NODE_ENV` | ✅ | ビルドモード | Next.js自動設定 | ビルド時 |
| `NEXT_PUBLIC_ENVIRONMENT` | ✅ | デプロイ環境 | GitHub Actions / Azure | ビルド時 |
| `NEXT_PUBLIC_API_URL` | ✅ | バックエンドURL | GitHub Actions / Azure | ビルド時 |
| `NEXT_PUBLIC_SHOPIFY_API_KEY` | ✅ | Shopify APIキー | GitHub Actions / Azure | ビルド時 |
| `NEXT_PUBLIC_DEV_PASSWORD` | ⚠️ | デモモードパスワード | GitHub Actions / Azure | ビルド時 |
| `NEXT_PUBLIC_DISABLE_FEATURE_GATES` | ❌ | 機能ゲート無効化 | GitHub Actions / Azure | ビルド時 |

### バックエンド（.NET）

| 変数名 | 必須 | 用途 | 設定場所 |
|--------|------|------|---------|
| `ASPNETCORE_ENVIRONMENT` | ✅ | 実行環境 | Azure App Service |
| `ConnectionStrings__DefaultConnection` | ✅ | DB接続文字列 | Azure App Service |
| `Shopify__ApiKey` | ✅ | Shopify APIキー | Azure App Service |
| `Shopify__ApiSecret` | ✅ | Shopify APIシークレット | Azure App Service |
| `Jwt__SecretKey` | ✅ | JWT署名キー | Azure App Service |

---

## 環境別の設定値

### Development環境

#### フロントエンド
```bash
NODE_ENV=production  # Next.jsビルド時は常にproduction
NEXT_PUBLIC_ENVIRONMENT=development
NEXT_PUBLIC_API_URL=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net
NEXT_PUBLIC_SHOPIFY_API_KEY=<Shopify開発アプリのAPIキー>
NEXT_PUBLIC_DEV_PASSWORD=dev2025
```

#### バックエンド
```bash
ASPNETCORE_ENVIRONMENT=Development
ConnectionStrings__DefaultConnection=<開発DB接続文字列>
Shopify__ApiKey=<Shopify開発アプリのAPIキー>
Shopify__ApiSecret=<Shopify開発アプリのシークレット>
Jwt__SecretKey=<開発用JWT署名キー>
```

---

### Staging環境

#### フロントエンド
```bash
NODE_ENV=production  # Next.jsビルド時は常にproduction
NEXT_PUBLIC_ENVIRONMENT=staging
NEXT_PUBLIC_API_URL=https://shopifytestapi20250720173320-aed5bhc0cferg2hm.japanwest-01.azurewebsites.net
NEXT_PUBLIC_SHOPIFY_API_KEY=<Shopify開発アプリのAPIキー>
NEXT_PUBLIC_DEV_PASSWORD=dev2025
```

#### バックエンド
```bash
ASPNETCORE_ENVIRONMENT=Staging
ConnectionStrings__DefaultConnection=<ステージングDB接続文字列>
Shopify__ApiKey=<Shopify開発アプリのAPIキー>
Shopify__ApiSecret=<Shopify開発アプリのシークレット>
Jwt__SecretKey=<ステージング用JWT署名キー>
```

---

### Production環境

#### フロントエンド
```bash
NODE_ENV=production
NEXT_PUBLIC_ENVIRONMENT=production
NEXT_PUBLIC_API_URL=<本番バックエンドURL>
NEXT_PUBLIC_SHOPIFY_API_KEY=<Shopify本番アプリのAPIキー>
NEXT_PUBLIC_DEV_PASSWORD=<本番用パスワード（設定しない推奨）>
```

#### バックエンド
```bash
ASPNETCORE_ENVIRONMENT=Production
ConnectionStrings__DefaultConnection=<本番DB接続文字列>
Shopify__ApiKey=<Shopify本番アプリのAPIキー>
Shopify__ApiSecret=<Shopify本番アプリのシークレット>
Jwt__SecretKey=<本番用JWT署名キー>
```

---

## 環境変数の設定方法

### GitHub Actions（ビルド時）

**ファイル:** `.github/workflows/develop_frontend.yml`

```yaml
- name: 🚀 Deploy to Azure Static Web Apps
  uses: Azure/static-web-apps-deploy@v1
  env:
    NEXT_PUBLIC_ENVIRONMENT: ${{ steps.env.outputs.next_public_environment }}
    NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
    NEXT_PUBLIC_SHOPIFY_API_KEY: ${{ vars.NEXT_PUBLIC_SHOPIFY_API_KEY }}
    NEXT_PUBLIC_DEV_PASSWORD: ${{ secrets.NEXT_PUBLIC_DEV_PASSWORD }}
```

**設定場所:**
- GitHub Repository > Settings > Secrets and variables > Actions
  - **Secrets**: 機密情報（パスワード、APIシークレットなど）
  - **Variables**: 非機密情報（URL、APIキーなど）

---

### Azure Static Web Apps（ランタイム）

**注意:** Azure Static Web Appsでは、`NEXT_PUBLIC_*` 環境変数は**ビルド時**にのみ有効です。
ランタイムでの環境変数の変更は反映されません。

**設定場所:**
- Azure Portal > Static Web Apps > Configuration > Environment variables

**重要:** 
- ビルド時の環境変数を変更した場合は、**再ビルド・再デプロイが必要**です。
- GitHub Actionsで設定した環境変数が優先されます。

---

### Azure App Service（バックエンド）

**設定場所:**
- Azure Portal > App Service > Configuration > Application settings

**設定方法:**
1. Azure Portalにログイン
2. App Serviceを選択
3. 左メニュー「Configuration」をクリック
4. 「Application settings」タブで環境変数を追加・編集
5. 「Save」をクリック
6. アプリが自動的に再起動されます

---

## 環境変数の確認方法

### フロントエンド（ブラウザ）

#### 開発者ツールで確認

```javascript
// ブラウザのコンソールで実行
console.log('NODE_ENV:', process.env.NODE_ENV)
console.log('NEXT_PUBLIC_ENVIRONMENT:', process.env.NEXT_PUBLIC_ENVIRONMENT)
console.log('NEXT_PUBLIC_API_URL:', process.env.NEXT_PUBLIC_API_URL)
```

**注意:** `NEXT_PUBLIC_` プレフィックスがない環境変数は、ブラウザでは `undefined` になります。

#### デバッグページで確認

- URL: `/debug-env`
- 全ての `NEXT_PUBLIC_*` 環境変数を表示

---

### バックエンド（.NET）

#### ログで確認

```csharp
_logger.LogInformation("Environment: {Environment}", 
    Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT"));
```

#### Application Insightsで確認

- Azure Portal > Application Insights > Logs
- クエリ: `traces | where message contains "Environment"`

---

## トラブルシューティング

### 問題1: ステージング環境でデモリンクが表示されない

**原因:**
- `NEXT_PUBLIC_ENVIRONMENT` が `staging` に設定されていない
- ビルド時に環境変数が正しく渡されていない

**確認方法:**
1. ブラウザのコンソールで環境変数を確認
   ```javascript
   console.log('NEXT_PUBLIC_ENVIRONMENT:', process.env.NEXT_PUBLIC_ENVIRONMENT)
   ```

2. GitHub Actionsのログを確認
   - Workflow run > Deploy to Azure Static Web Apps > Environment variables

**解決方法:**
1. GitHub Actionsの環境変数設定を確認
2. 再ビルド・再デプロイを実行
3. ブラウザのキャッシュをクリア

---

### 問題2: 環境変数が `undefined` になる

**原因:**
- `NEXT_PUBLIC_` プレフィックスがない
- ビルド時に環境変数が設定されていない
- ランタイムで環境変数を変更しようとしている

**解決方法:**
1. 環境変数名に `NEXT_PUBLIC_` プレフィックスを追加
2. GitHub Actionsで環境変数を設定
3. 再ビルド・再デプロイを実行

---

### 問題3: 本番環境で開発用の値が使われている

**原因:**
- 環境別の設定が正しく分離されていない
- GitHub ActionsのSecretsが環境別に設定されていない

**解決方法:**
1. GitHub Repository > Settings > Environments で環境を作成
2. 環境ごとにSecretsとVariablesを設定
3. Workflowで `environment: ${{ github.event.inputs.environment }}` を指定

---

## チェックリスト

### デプロイ前の確認

- [ ] GitHub ActionsのSecretsとVariablesが設定されている
- [ ] 環境別の設定が正しく分離されている
- [ ] `.github/workflows/develop_frontend.yml` で環境変数が正しく渡されている
- [ ] Azure Static Web Appsの設定が正しい

### デプロイ後の確認

- [ ] ブラウザのコンソールで環境変数を確認
- [ ] デバッグページ（`/debug-env`）で環境変数を確認
- [ ] 認証画面で正しいタイトル・メッセージが表示される
- [ ] デモリンクが正しく表示される（または非表示になる）

---

## 関連ドキュメント

### 認証関連
- [認証画面の表示仕様](./認証画面表示仕様.md)
- [認証モード一覧](./認証モード一覧.md)
- [Shopify アプリ認証・認可設計](../../06-shopify/06-技術ガイド/Shopify のアプリ認証・認可設計.md)

### インフラ関連
- [Azure Static Web Apps環境変数設定](../04-Azure_DevOps/デプロイメント/azure-static-web-apps-environment-variables.md)

---

## 更新履歴

- 2025-10-24: 初版作成（環境変数チェックリスト）
- 2025-10-25: ファイル名を日本語に変更、09-認証・セキュリティフォルダに移動

