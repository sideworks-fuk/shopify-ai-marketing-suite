# デプロイスロット - 環境変数の動作とスロット設定

## 📋 概要

Azure App Serviceのデプロイスロットにおける環境変数（アプリケーション設定）の動作について説明します。

## ✅ 基本理解

**各スロットは独立した環境変数（アプリケーション設定）を持ちます。**

- ✅ ステージングスロットと本番スロットで異なる環境変数を設定可能
- ✅ スワップ後も、各スロットの環境変数は維持される
- ⚠️ **ただし、デフォルトでは環境変数はスワップ時に交換されます**

---

## 🔄 環境変数の2つのタイプ

### 1. 一般設定（General Settings）- スワップ時に交換される

**デフォルトの動作**:
- スワップ時に、ステージングスロットと本番スロットの環境変数が**交換**されます
- スワップ前: ステージングスロットの環境変数A → 本番スロットの環境変数B
- スワップ後: ステージングスロットの環境変数B → 本番スロットの環境変数A

**例**:
```
スワップ前:
  staging: Admin__BasicAuth__Password = "StagingPassword123"
  production: Admin__BasicAuth__Password = "ProductionPassword456"

スワップ後:
  staging: Admin__BasicAuth__Password = "ProductionPassword456"  ← 交換された
  production: Admin__BasicAuth__Password = "StagingPassword123"  ← 交換された
```

### 2. スロット設定（Slot Settings）- スワップ時に交換されない

**スロット固有の設定**:
- スワップ時に、環境変数が**交換されません**
- 各スロットに固定された設定として扱われます
- スワップ前後で、各スロットの環境変数は**同じまま**です

**例**:
```
スワップ前:
  staging: Admin__BasicAuth__Password = "StagingPassword123" (スロット設定)
  production: Admin__BasicAuth__Password = "ProductionPassword456" (スロット設定)

スワップ後:
  staging: Admin__BasicAuth__Password = "StagingPassword123"  ← 変わらない
  production: Admin__BasicAuth__Password = "ProductionPassword456"  ← 変わらない
```

---

## 🔧 スロット設定の有効化方法

### Azure Portalで設定

1. **App Serviceを開く**
   - Azure Portal → App Service → デプロイスロット → `staging`（または`production`）

2. **設定 → 構成 → アプリケーション設定**を開く

3. **環境変数を選択**
   - スロット固有にしたい環境変数の行をクリック

4. **「スロット設定」を有効化**
   - 環境変数の行で、「スロット設定」列のチェックボックスをオンにする
   - または、環境変数の詳細画面で「スロット設定」をオンにする

5. **保存**
   - 「保存」をクリック

### Azure CLIで設定

```powershell
# スロット設定としてマーク
az webapp config appsettings set `
  --resource-group ec-ranger-prod `
  --name ec-ranger-backend-prod-ghf3bbarghcwh4gn `
  --slot staging `
  --settings Admin__BasicAuth__Password="StagingPassword123" `
  --slot-settings Admin__BasicAuth__Password
```

---

## 📊 スワップ時の動作比較

### パターン1: 一般設定（デフォルト）- スワップ時に交換される

**スワップ前**:
```
staging スロット:
  Admin__BasicAuth__Password = "StagingPassword123"
  Database__ConnectionString = "StagingDB"

production スロット:
  Admin__BasicAuth__Password = "ProductionPassword456"
  Database__ConnectionString = "ProductionDB"
```

**スワップ後**:
```
staging スロット:
  Admin__BasicAuth__Password = "ProductionPassword456"  ← 交換された
  Database__ConnectionString = "ProductionDB"  ← 交換された

production スロット:
  Admin__BasicAuth__Password = "StagingPassword123"  ← 交換された
  Database__ConnectionString = "StagingDB"  ← 交換された
```

### パターン2: スロット設定 - スワップ時に交換されない

**スワップ前**:
```
staging スロット:
  Admin__BasicAuth__Password = "StagingPassword123" (スロット設定)
  Database__ConnectionString = "StagingDB" (一般設定)

production スロット:
  Admin__BasicAuth__Password = "ProductionPassword456" (スロット設定)
  Database__ConnectionString = "ProductionDB" (一般設定)
```

**スワップ後**:
```
staging スロット:
  Admin__BasicAuth__Password = "StagingPassword123"  ← 変わらない（スロット設定）
  Database__ConnectionString = "ProductionDB"  ← 交換された（一般設定）

production スロット:
  Admin__BasicAuth__Password = "ProductionPassword456"  ← 変わらない（スロット設定）
  Database__ConnectionString = "StagingDB"  ← 交換された（一般設定）
```

---

## 🎯 推奨される設定方法

### 管理者ダッシュボードのBasic認証パスワードの場合

**推奨**: **スロット設定として設定**

理由:
- ステージング環境と本番環境で異なるパスワードを使用したい場合がある
- スワップ後も、各スロットで正しいパスワードが使用される

**設定手順**:

1. **ステージングスロットで設定**
   ```
   名前: Admin__BasicAuth__Password
   値: StagingPassword123
   スロット設定: ✅ オン
   ```

2. **本番スロットで設定**
   ```
   名前: Admin__BasicAuth__Password
   値: ProductionPassword456
   スロット設定: ✅ オン
   ```

3. **スワップ後も、各スロットで正しいパスワードが使用される**

### データベース接続文字列の場合

**推奨**: **一般設定（デフォルト）**

理由:
- ステージング環境と本番環境で同じデータベースを使用する場合がある
- スワップ時に、データベース接続も一緒に交換される

**設定手順**:

1. **ステージングスロットで設定**
   ```
   名前: DefaultConnection
   値: Server=staging-db...
   スロット設定: ❌ オフ（デフォルト）
   ```

2. **本番スロットで設定**
   ```
   名前: DefaultConnection
   値: Server=production-db...
   スロット設定: ❌ オフ（デフォルト）
   ```

3. **スワップ時に、データベース接続も交換される**

---

## ⚠️ 注意事項

### 1. スワップ設定の確認

スワップ実行時に、以下の設定を確認できます：

- ✅ **アプリケーション設定をスワップ** - 一般設定が交換される
- ✅ **接続文字列をスワップ** - 接続文字列が交換される
- ✅ **スロット設定をスワップ** - スロット設定が交換される（通常はオフ）

**重要**: 「スロット設定をスワップ」がオンの場合、スロット設定も交換されます。

### 2. スロット設定の確認方法

Azure Portalで確認:
1. App Service → デプロイスロット → `staging`
2. 「設定」→ 「構成」→ 「アプリケーション設定」
3. 「スロット設定」列で、チェックが入っている環境変数がスロット設定

### 3. デフォルトの動作

**デフォルトでは、すべての環境変数は一般設定（スワップ時に交換される）です。**

スロット固有にしたい場合は、明示的に「スロット設定」としてマークする必要があります。

---

## 🔍 トラブルシューティング

### 問題1: スワップ後、環境変数が期待と異なる

**原因**: スロット設定としてマークされていない可能性

**解決方法**:
1. 環境変数が「スロット設定」としてマークされているか確認
2. スワップ設定で「スロット設定をスワップ」がオフになっているか確認

### 問題2: スワップ後、環境変数が交換されない

**原因**: スロット設定としてマークされている可能性

**解決方法**:
1. 環境変数の「スロット設定」チェックをオフにする
2. または、スワップ設定で「スロット設定をスワップ」をオンにする

---

## 📚 関連ドキュメント

- [デプロイスロット-手動スワップ手順書](./デプロイスロット-手動スワップ手順書.md)
- [デプロイスロット作成-手順書](./デプロイスロット作成-手順書.md)
- [管理者ダッシュボード-Basic認証パスワード確認と修正方法](../08-デバッグ・トラブル/04-troubleshooting/管理者ダッシュボード-Basic認証パスワード確認と修正方法.md)

---

## 🎯 まとめ

### ユーザーの理解について

**質問**: 「ステージングスロットと本番の環境変数が違う場合はスワップしてもそれぞれの環境変数が適用される理解であっていますか？」

**回答**: **部分的に正しいです。**

- ✅ 各スロットは独立した環境変数を持つ
- ⚠️ **デフォルトでは、スワップ時に環境変数は交換される**
- ✅ **スロット設定としてマークした場合、スワップ時に交換されない**

### 推奨される設定

**管理者ダッシュボードのBasic認証パスワード**:
- スロット設定としてマークすることを推奨
- これにより、スワップ後も各スロットで正しいパスワードが使用される
