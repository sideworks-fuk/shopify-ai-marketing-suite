# デプロイスロット - 手動スワップ手順書

## 📋 概要

GitHub Actionsでステージングスロットにデプロイした後、Azure Portalで手動スワップを実行する手順を説明します。

**パターンB（半自動デプロイ）**では、この手順が必須です。

---

## ✅ 前提条件

- [x] GitHub Actionsでステージングスロットへのデプロイが完了している
- [x] ステージングスロットのヘルスチェックが成功している
- [x] Azure Portalにアクセス可能
- [x] App Serviceのデプロイスロットページにアクセス可能

---

## 🔄 手動スワップの手順

### ステップ1: Azure PortalでApp Serviceを開く

1. **Azure Portalにログイン**
   - https://portal.azure.com にアクセス
   - 必要に応じてログイン

2. **リソースグループを開く**
   - 左メニュー → 「リソースグループ」
   - リソースグループ: `ec-ranger-prod` をクリック

3. **App Serviceを開く**
   - App Service: `ec-ranger-backend-prod-ghf3bbarghcwh4gn` をクリック

---

### ステップ2: デプロイスロットページを開く

1. **左メニューから「デプロイ」を選択**
   - App Serviceの詳細ページで、左メニューをスクロール
   - 「デプロイ」セクション → 「デプロイ スロット」をクリック

2. **デプロイスロット一覧を確認**
   - 以下のスロットが表示されることを確認:
     ```
     production（本番スロット）
     staging（ステージングスロット）
     ```
   - 両方のスロットが「実行中」であることを確認

---

### ステップ3: ステージングスロットの動作確認（推奨）

**重要**: スワップ前に、ステージングスロットが正常に動作していることを確認してください。

1. **ステージングスロットのURLを確認**
   - `staging`スロットをクリック
   - 「概要」→ 「URL」を確認
   - 例: `https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net`

2. **ヘルスチェックエンドポイントにアクセス**
   - ブラウザで以下のURLにアクセス:
     ```
     https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net/api/health
     ```
   - 正常な応答（`200 OK`）が返ることを確認

3. **必要に応じて、他のエンドポイントもテスト**
   - Swagger UI: `https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net/swagger`
   - その他のAPIエンドポイント

---

### ステップ4: スロットスワップを実行

1. **デプロイスロットページに戻る**
   - 左メニュー → 「デプロイ」→ 「デプロイ スロット」
   - または、ブラウザの「戻る」ボタンで戻る

2. **「スワップ」ボタンをクリック**
   - **ページ上部のアクションボタンの行**にある「**Swap**」ボタンをクリック
     - 「保存」「破棄」「追加」「**Swap**」「Logs」「更新」などのボタンが並んでいる行
     - 「Swap」ボタンは英語表記で表示されます
   - または、`staging`スロットの行にある「スワップ」アイコンをクリック（もし表示されている場合）

3. **スワップ設定を確認**
   - スワップ設定画面が表示されます
   - 以下の情報を確認:
     ```
     ソース スロット: staging
     ターゲット スロット: production
     ```
   - **重要**: `staging` → `production` の方向であることを確認

4. **スワップ設定を確認（詳細）**
   - 「スワップ設定」セクションで、以下を確認:
     - ✅ アプリケーション設定をスワップ
     - ✅ 接続文字列をスワップ
     - ✅ スロット設定をスワップ
   - 通常はすべてチェックが入っている状態で問題ありません

5. **「スワップ」ボタンをクリック**
   - 画面下部の「スワップ」ボタンをクリック
   - 確認ダイアログが表示される場合は、「OK」をクリック

6. **スワップ処理の完了を待つ**
   - スワップ処理が開始されます
   - 処理中は「スワップ中...」と表示されます
   - **通常、数秒〜1分程度**で完了します
   - 完了すると「スワップが完了しました」と表示されます

---

### ステップ5: スワップ後の確認

1. **本番環境の動作確認**
   - カスタムドメインでアクセス:
     ```
     https://ec-ranger-api.access-net.co.jp/api/health
     ```
   - 正常な応答（`200 OK`）が返ることを確認
   - **重要**: URLは変わらず、新バージョンが表示されることを確認

2. **デプロイスロットの状態を確認**
   - デプロイスロットページで、スロットの状態を確認
   - `production`スロットに新バージョンが反映されていることを確認
   - `staging`スロットに旧バージョンが反映されていることを確認

3. **アプリケーションの動作確認**
   - 本番環境の主要機能をテスト
   - エラーが発生していないことを確認
   - ログを確認して、異常がないことを確認

---

## 🎯 スワップの動作イメージ

### スワップ前

```
production スロット（本番環境）
  - コード: v1.0.0（旧バージョン）
  - URL: https://ec-ranger-api.access-net.co.jp ✅

staging スロット（ステージング環境）
  - コード: v1.1.0（新バージョン）
  - URL: https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net
```

### スワップ後

```
production スロット（本番環境）
  - コード: v1.1.0（新バージョン）✅
  - URL: https://ec-ranger-api.access-net.co.jp ✅（変わらない）

staging スロット（ステージング環境）
  - コード: v1.0.0（旧バージョン）
  - URL: https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net
```

**重要**: カスタムドメイン（`https://ec-ranger-api.access-net.co.jp`）は常に`production`スロットを指すため、URLは変わりません。

---

## 🚨 ロールバック手順

問題が発生した場合、再度スワップを実行することでロールバックできます。

### ロールバックの手順

1. **デプロイスロットページを開く**
   - Azure Portal → App Service → 「デプロイ」→ 「デプロイ スロット」

2. **再度スワップを実行**
   - 「スワップ」ボタンをクリック
   - スワップ設定を確認:
     ```
     ソース スロット: staging（現在は旧バージョン）
     ターゲット スロット: production（現在は新バージョン）
     ```
   - 「スワップ」ボタンをクリック

3. **ロールバック完了の確認**
   - 本番環境が旧バージョンに戻ったことを確認
   - アプリケーションが正常に動作することを確認

---

## ⚠️ 注意事項

### スワップ前の確認事項

- [ ] ステージングスロットのヘルスチェックが成功している
- [ ] ステージングスロットで主要機能をテスト済み
- [ ] データベースマイグレーションが必要な場合は実行済み
- [ ] 環境変数の設定が正しいことを確認済み
- [ ] 本番環境への影響を最小限に抑える準備ができている

### スワップ時の注意事項

- ⚠️ **スワップ中は短時間のダウンタイムが発生する可能性があります**（通常は数秒）
- ⚠️ **スワップは即座に反映されます**（元に戻すには再度スワップが必要）
- ⚠️ **スワップ後、接続中のセッションが切断される可能性があります**

### スワップ後の確認事項

- [ ] 本番環境が正常に動作している
- [ ] エラーログに異常がない
- [ ] 主要機能が正常に動作している
- [ ] パフォーマンスに問題がない

---

## 🔍 トラブルシューティング

### 問題1: スワップボタンが表示されない

**原因**: デプロイスロットが作成されていない、または権限が不足している可能性

**解決方法**:
1. デプロイスロット一覧で`staging`スロットが存在することを確認
2. App Serviceの「アクセス制御（IAM）」で、適切な権限があることを確認
3. ブラウザをリフレッシュして再試行

---

### 問題2: スワップが失敗する

**原因**: ステージングスロットが正常に動作していない可能性

**解決方法**:
1. ステージングスロットのURLに直接アクセスして動作確認
2. ステージングスロットのログを確認
3. ステージングスロットのヘルスチェックを実行
4. 問題が解決するまでスワップを実行しない

---

### 問題3: スワップ後、本番環境が正常に動作しない

**原因**: 新バージョンに問題がある可能性

**解決方法**:
1. **即座にロールバック**（再度スワップを実行）
2. ステージングスロットで問題を再現して調査
3. 問題を修正してから再デプロイ

---

### 問題4: カスタムドメインでアクセスできない

**原因**: DNS設定やSSL証明書の問題の可能性

**解決方法**:
1. カスタムドメインの設定を確認（Azure Portal → App Service → 「カスタム ドメイン」）
2. SSL証明書の有効期限を確認
3. DNS設定を確認（CNAMEレコードが正しく設定されているか）
4. カスタムドメインが`production`スロットにバインドされていることを確認

**重要**: カスタムドメインは常に`production`スロットを指すため、スワップ後もURLは変わりません。

---

## 📊 スワップ実行チェックリスト

### スワップ前

- [ ] GitHub Actionsでステージングスロットへのデプロイが完了
- [ ] ステージングスロットのヘルスチェックが成功
- [ ] ステージングスロットで主要機能をテスト済み
- [ ] データベースマイグレーションが必要な場合は実行済み
- [ ] 本番環境への影響を最小限に抑える準備ができている

### スワップ実行

- [ ] Azure PortalでApp Serviceを開く
- [ ] デプロイスロットページを開く
- [ ] スワップ設定を確認（`staging` → `production`）
- [ ] 「スワップ」ボタンをクリック
- [ ] スワップ処理の完了を待つ

### スワップ後

- [ ] 本番環境のヘルスチェックが成功
- [ ] カスタムドメインで正常にアクセスできる
- [ ] アプリケーションが正常に動作している
- [ ] エラーログに異常がない
- [ ] 主要機能が正常に動作している

---

## 📚 関連ドキュメント

- [デプロイスロット作成-手順書](./デプロイスロット作成-手順書.md)
- [デプロイスロット-カスタムドメインとスロットスワップ](./デプロイスロット-カスタムドメインとスロットスワップ.md)
- [Standard-S1-アップグレード手順](./Standard-S1-アップグレード手順.md)
- [デプロイスロット-コスト比較と推奨プラン](./デプロイスロット-コスト比較と推奨プラン.md)

---

## 🎯 クイックリファレンス

### スワップ手順（簡易版）

1. Azure Portal → リソースグループ `ec-ranger-prod` → App Service `ec-ranger-backend-prod-ghf3bbarghcwh4gn`
2. 左メニュー → 「デプロイ」→ 「デプロイ スロット」
3. 「スワップ」ボタンをクリック
4. スワップ設定を確認（`staging` → `production`）
5. 「スワップ」ボタンをクリック
6. 完了を待つ
7. 本番環境の動作確認

### 重要なURL

- **本番環境（カスタムドメイン）**: `https://ec-ranger-api.access-net.co.jp`
- **ステージングスロット**: `https://ec-ranger-backend-prod-staging-g2hpcmengbg2hvc7.japanwest-01.azurewebsites.net`
- **ヘルスチェックエンドポイント**: `/api/health`

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
