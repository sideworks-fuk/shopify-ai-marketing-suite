# デプロイスロット - カスタムドメインとスロットスワップの仕組み

## 📋 概要

デプロイスロットを使用する際のカスタムドメインの動作について説明します。**スロットスワップを実行しても、カスタムドメインのURLは変わりません**。

---

## 🔍 カスタムドメインとスロットの関係

### 重要なポイント

**カスタムドメインは常に「production」スロットにバインドされています。**

- ✅ スロットスワップ後も、カスタムドメインは常に「production」スロットを指し続けます
- ✅ URLが変わることはありません
- ✅ ユーザーは常に同じURL（`https://ec-ranger-api.access-net.co.jp`）でアクセスできます

---

## 🔄 スロットスワップの仕組み

### スロットスワップ前

```
カスタムドメイン: ec-ranger-api.access-net.co.jp
    ↓
production スロット（本番環境）
  - コード: v1.0.0
  - 設定: 本番設定

staging スロット（ステージング環境）
  - コード: v1.1.0（新バージョン）
  - 設定: 本番設定（複製）
```

**アクセス**:
- `https://ec-ranger-api.access-net.co.jp` → production スロット（v1.0.0）
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net` → staging スロット（v1.1.0）

---

### スロットスワップ後

```
カスタムドメイン: ec-ranger-api.access-net.co.jp
    ↓
production スロット（元のstagingの内容）
  - コード: v1.1.0（新バージョン）
  - 設定: 本番設定

staging スロット（元のproductionの内容）
  - コード: v1.0.0（旧バージョン）
  - 設定: 本番設定（複製）
```

**アクセス**:
- `https://ec-ranger-api.access-net.co.jp` → production スロット（v1.1.0）✅ **URLは変わらない**
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net` → staging スロット（v1.0.0）

---

## ✅ カスタムドメインの動作確認

### 1. カスタムドメインのバインド確認

1. **Azure PortalでApp Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

2. **カスタムドメインの設定を確認**
   - 左メニュー → 「設定」→ 「カスタム ドメイン」
   - カスタムドメイン一覧を確認:
     ```
     ec-ranger-api.access-net.co.jp
     ```
   - **スロット**: 「production」と表示されているはずです

3. **ステージングスロットのカスタムドメインを確認**
   - デプロイスロット一覧で`staging`をクリック
   - 左メニュー → 「設定」→ 「カスタム ドメイン」
   - **カスタムドメインは設定されていない**はずです（これが正常です）

---

### 2. スロットスワップ後の動作確認

1. **スロットスワップを実行**
   - GitHub Actionsでデプロイを実行
   - または、Azure Portalで手動スワップ

2. **カスタムドメインの確認**
   - カスタムドメイン設定は変わらない
   - 依然として「production」スロットにバインドされている

3. **URLアクセスの確認**
   - `https://ec-ranger-api.access-net.co.jp`にアクセス
   - 新バージョン（v1.1.0）が表示されることを確認
   - **URLは変わらない**

---

## 🎯 デプロイフローの詳細

### ステップ1: ステージングスロットにデプロイ

```
staging スロットに新バージョンをデプロイ
  ↓
カスタムドメインは production スロットを指し続ける
  ↓
ユーザーは依然として旧バージョン（v1.0.0）にアクセス
```

**アクセス**:
- `https://ec-ranger-api.access-net.co.jp` → production スロット（v1.0.0）✅
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net` → staging スロット（v1.1.0）✅

---

### ステップ2: ステージングでテスト

```
staging スロットのURLで新バージョンをテスト
  ↓
問題がなければ次のステップへ
  ↓
問題があれば、デプロイを修正して再デプロイ
```

**アクセス**:
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/api/health` → staging スロット（v1.1.0）✅

---

### ステップ3: スロットスワップ

```
production スロット ↔ staging スロット をスワップ
  ↓
カスタムドメインは依然として production スロットを指す
  ↓
production スロットの内容が新バージョン（v1.1.0）になる
```

**アクセス**:
- `https://ec-ranger-api.access-net.co.jp` → production スロット（v1.1.0）✅ **URLは変わらない**
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net` → staging スロット（v1.0.0）✅

---

## 🔐 カスタムドメインの設定方法

### 本番スロット（production）へのカスタムドメイン設定

1. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

2. **カスタムドメインを追加**
   - 左メニュー → 「設定」→ 「カスタム ドメイン」
   - 「+ カスタム ドメインの追加」をクリック
   - ドメイン名を入力: `ec-ranger-api.access-net.co.jp`
   - 「検証」をクリック
   - 「追加」をクリック

3. **SSL証明書をバインド**
   - カスタムドメイン一覧で`ec-ranger-api.access-net.co.jp`を選択
   - 「SSL バインディング」タブをクリック
   - 「App Service Managed Certificate」を選択（無料）
   - 「追加」をクリック

---

### ステージングスロットへのカスタムドメイン設定（通常は不要）

**注意**: ステージングスロットにカスタムドメインを設定する必要はありません。

**理由**:
- ステージングスロットはテスト用
- Azure提供のURL（`*.azurewebsites.net`）で十分
- カスタムドメインは本番スロット（production）のみに設定

**もしステージングスロットにもカスタムドメインを設定したい場合**:
- 別のサブドメインを使用（例: `ec-ranger-api-staging.access-net.co.jp`）
- ただし、通常は不要です

---

## 🚨 よくある質問

### Q1: スロットスワップ後、カスタムドメインのURLが変わることはありますか？

**A**: いいえ、変わりません。カスタムドメインは常に「production」スロットにバインドされているため、スロットスワップ後も同じURL（`https://ec-ranger-api.access-net.co.jp`）でアクセスできます。

---

### Q2: ステージングスロットにもカスタムドメインを設定する必要がありますか？

**A**: いいえ、必要ありません。ステージングスロットはテスト用であり、Azure提供のURL（`*.azurewebsites.net`）で十分です。カスタムドメインは本番スロット（production）のみに設定します。

---

### Q3: スロットスワップ後、DNS設定を変更する必要がありますか？

**A**: いいえ、必要ありません。カスタムドメインは常に「production」スロットを指すため、DNS設定を変更する必要はありません。

---

### Q4: ロールバックする場合、カスタムドメインはどうなりますか？

**A**: 再度スロットスワップを実行するだけです。カスタムドメインは常に「production」スロットを指すため、スロットスワップを実行すると、元のバージョンに戻ります。

**例**:
```
1. 新バージョン（v1.1.0）をデプロイしてスワップ
2. 問題が発生
3. 再度スロットスワップを実行（ロールバック）
4. カスタムドメインは元のバージョン（v1.0.0）を指す
```

---

## 📊 スロットスワップの動作フロー図

```
┌─────────────────────────────────────────────────────────┐
│ スロットスワップ前                                      │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  カスタムドメイン: ec-ranger-api.access-net.co.jp       │
│           ↓                                              │
│  production スロット（v1.0.0）                          │
│                                                           │
│  staging スロット（v1.1.0）                              │
│                                                           │
└─────────────────────────────────────────────────────────┘
                        ↓
                  スロットスワップ
                        ↓
┌─────────────────────────────────────────────────────────┐
│ スロットスワップ後                                      │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  カスタムドメイン: ec-ranger-api.access-net.co.jp       │
│           ↓                                              │
│  production スロット（v1.1.0）← 元のstagingの内容       │
│                                                           │
│  staging スロット（v1.0.0）← 元のproductionの内容       │
│                                                           │
└─────────────────────────────────────────────────────────┘

✅ カスタムドメインは依然として production スロットを指す
✅ URLは変わらない
✅ ユーザーは新バージョン（v1.1.0）にアクセスできる
```

---

## ✅ 確認事項

- [ ] カスタムドメインが「production」スロットにバインドされている
- [ ] ステージングスロットにはカスタムドメインが設定されていない（正常）
- [ ] スロットスワップ後も、カスタムドメインのURLが変わらないことを確認
- [ ] スロットスワップ後、新バージョンがカスタムドメインでアクセスできることを確認

---

## 📚 関連ドキュメント

- [デプロイスロット作成-手順書](./デプロイスロット作成-手順書.md)
- [Standard-S1-アップグレード手順](./Standard-S1-アップグレード手順.md)
- [デプロイスロット-コスト比較と推奨プラン](./デプロイスロット-コスト比較と推奨プラン.md)
- [デプロイスロットを使用した本番デプロイ方法](../08-デバッグ・トラブル/01-problem-analysis/2026-01/2026-01-19-デプロイスロットを使用した本番デプロイ方法.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
