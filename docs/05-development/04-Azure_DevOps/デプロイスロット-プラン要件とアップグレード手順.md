# デプロイスロット - プラン要件とアップグレード手順

## 📋 問題

Azure Portalで「デプロイ スロット」にアクセスすると、以下のメッセージが表示されます：

```
Upgrade to a standard or premium plan to add slots.
```

これは、現在のApp Serviceプランがデプロイスロットをサポートしていないことを示しています。

---

## 🔍 デプロイスロットのプラン要件

### サポートされているプラン

デプロイスロットは以下のプランでのみ利用可能です：

| プラン | デプロイスロット数 | 備考 |
|--------|-------------------|------|
| **Free** | ❌ 利用不可 | - |
| **Shared** | ❌ 利用不可 | - |
| **Basic** | ❌ 利用不可 | - |
| **Standard** | ✅ 5スロット | 推奨 |
| **Premium** | ✅ 20スロット | - |
| **Isolated** | ✅ 20スロット | - |

### 現在のプラン確認方法

1. **Azure Portal**でApp Serviceを開く
2. **設定 → App Service プラン**を選択
3. **価格レベル（Pricing tier）**を確認

---

## ✅ 解決方法

### 方法1: App ServiceプランをStandard以上にアップグレード（推奨）

**メリット**:
- デプロイスロットが利用可能（ゼロダウンタイムデプロイ）
- より高いパフォーマンス
- 自動スケーリング機能
- カスタムドメインのSSL証明書（無料）

**デメリット**:
- コストが増加（Basic: 約$13/月 → Standard: 約$73/月）

---

### 方法2: 直接デプロイを使用（現状維持）

**メリット**:
- コストを抑えられる
- 既存のプランで継続可能

**デメリット**:
- デプロイ時にダウンタイムが発生する可能性
- App Serviceを停止してからデプロイする必要がある場合がある

---

## 🔧 アップグレード手順

### ステップ1: App Serviceプランを確認

1. **Azure Portal**にログイン
   - https://portal.azure.com

2. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`（または該当するリソースグループ）
   - App Service名: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

3. **設定 → App Service プラン**を選択

4. **現在のプラン名を確認**
   - 例: `ec-ranger-backend-prod-plan` など

---

### ステップ2: App Serviceプランを開く

1. **App Service プラン名をクリック**
   - App Serviceの「設定 → App Service プラン」から直接リンクをクリック

2. **または、リソースグループから直接開く**
   - リソースグループ → App Service プラン名を選択

---

### ステップ3: 価格レベルを変更

1. **左メニューから「スケールアップ (App Service プラン)」を選択**

2. **価格レベルを選択**
   - **推奨**: `S1 Standard`（最小構成）
   - または、必要に応じて `S2 Standard`、`S3 Standard` を選択

3. **「適用」をクリック**

4. **確認ダイアログで「はい」をクリック**

---

### ステップ4: デプロイスロットを作成

1. **App Serviceに戻る**
   - ブラウザの戻るボタン、またはリソースグループからApp Serviceを開く

2. **デプロイ → デプロイ スロット**を選択

3. **「+ 追加」をクリック**

4. **スロット情報を入力**
   ```
   名前: staging
   構成ソース: 現在の本番スロットから複製
   ```

5. **「追加」をクリック**

6. **スロットが作成されるまで待機**（数分）

---

### ステップ5: GitHub Secretsの設定

デプロイスロットを使用するには、以下のGitHub Secretsが必要です：

1. **Azure PortalでPublish Profileを取得**

   **ステージングスロット用**:
   - App Service → **デプロイ → デプロイ スロット** → `staging`スロットを選択
   - **デプロイ センター → ローカル Git / FTP** → **プロファイルのダウンロード**
   - ダウンロードした`.PublishSettings`ファイルの内容をコピー

2. **GitHub Secretsに追加**
   - リポジトリ → **Settings → Secrets and variables → Actions**
   - **New repository secret**をクリック
   - 以下を追加：
     ```
     名前: AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING
     値: [ダウンロードしたPublish Profileの内容]
     ```

3. **Azure認証情報の設定**（既に設定済みの場合はスキップ）
   ```
   名前: AZURE_CREDENTIALS
   値: [サービスプリンシパルのJSON形式の認証情報]
   ```

---

## 💰 コスト比較

### Basicプラン（現在）
- **月額**: 約$62.05（約9,300円）
- **デプロイスロット**: ❌ 利用不可
- **インスタンス**: 1-3インスタンス（固定）
- **リモート記憶域**: 10 GB

### Standardプラン（S1）- 推奨
- **月額**: 約$77.38（約11,600円）
- **追加コスト**: 約$15.33/月（約2,300円/月）
- **デプロイスロット**: ✅ 5スロット利用可能
- **インスタンス**: 1-10インスタンス（自動スケーリング可能）
- **リモート記憶域**: 50 GB（Basicの5倍）
- **その他の機能**:
  - カスタムドメインのSSL証明書（無料）
  - 自動バックアップ
  - ステージング環境

**詳細なコスト比較**: [デプロイスロット-コスト比較と推奨プラン](./デプロイスロット-コスト比較と推奨プラン.md)を参照

---

## ⚠️ 注意事項

### 1. アップグレードの影響

- **ダウンタイム**: プランの変更中に短時間のダウンタイムが発生する可能性があります
- **推奨時間**: メンテナンス時間帯（深夜など）に実施することを推奨

---

### 2. ダウングレードの制限

- **Standard → Basic**: 可能ですが、デプロイスロットが削除されます
- **データ損失**: デプロイスロット内のデータは失われます

---

### 3. コスト管理

- **使用量の監視**: Azure Portalで使用量を定期的に確認
- **予算アラート**: コスト管理で予算アラートを設定

---

## 🔄 代替案: 直接デプロイの使用

デプロイスロットが使えない場合、GitHub Actionsワークフローで直接デプロイオプションを使用できます：

**ワークフロー実行時**:
- `デプロイスロットを使用` → `NO - 直接デプロイ（非推奨）`を選択

**注意**:
- デプロイ時にApp Serviceを停止する必要がある場合があります
- ダウンタイムが発生する可能性があります

---

## 📝 次のステップ

1. **コストを確認**: Standardプランのコストが許容範囲内か確認
2. **アップグレード実行**: メンテナンス時間帯にアップグレード
3. **デプロイスロット作成**: アップグレード後、`staging`スロットを作成
4. **GitHub Secrets設定**: Publish Profileを設定
5. **テストデプロイ**: デプロイスロットを使用したデプロイをテスト

---

## 📚 関連ドキュメント

- [デプロイスロットを使用した本番デプロイ方法](./2026-01-19-デプロイスロットを使用した本番デプロイ方法.md)
- [Azure App Service プランの価格](https://azure.microsoft.com/ja-jp/pricing/details/app-service/windows/)
- [デプロイスロットのドキュメント](https://docs.microsoft.com/ja-jp/azure/app-service/deploy-staging-slots)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
