# Standard S1 アップグレード手順

## 📋 概要

Basic B1からStandard S1にアップグレードすることで、デプロイスロットが利用可能になり、バックエンドのデプロイ作業が大幅に改善されます。

---

## ✅ アップグレード後の改善点

### 1. デプロイスロットの利用

**現在（Basic B1）**:
- ❌ デプロイスロット利用不可
- ⚠️ 直接デプロイ時にファイルロック問題が発生
- ⚠️ `app_offline.htm`を使用する必要がある
- ⚠️ デプロイ中に短時間のダウンタイムが発生する可能性

**アップグレード後（Standard S1）**:
- ✅ デプロイスロット利用可能（最大5スロット）
- ✅ ゼロダウンタイムデプロイ
- ✅ ファイルロック問題の完全解決
- ✅ `app_offline.htm`不要
- ✅ ステージング環境で事前テスト可能

---

### 2. デプロイフローの改善

**現在のデプロイフロー（Basic B1）**:
```
1. app_offline.htmを作成・デプロイ（アプリ停止）
2. 15秒待機（ファイルロック解除）
3. アプリケーションをデプロイ
4. app_offline.htmを削除（手動または自動）
```

**アップグレード後のデプロイフロー（Standard S1）**:
```
1. ステージングスロットにデプロイ（本番は稼働中）
2. ステージングでヘルスチェック
3. 問題なければスロットスワップ（ゼロダウンタイム）
4. 完了
```

---

### 3. その他の改善点

- ✅ **リモート記憶域**: 10GB → 50GB（5倍）
- ✅ **スケール可能インスタンス**: 3 → 10
- ✅ **自動バックアップ**: 利用可能
- ✅ **カスタムドメインSSL証明書**: 無料

---

## 🔧 アップグレード手順

### ステップ1: App Serviceプランを確認

1. **Azure Portalを開く**
   - https://portal.azure.com

2. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

3. **App Serviceプランを確認**
   - 左メニュー → 「設定」→ 「App Service プラン」
   - 現在のプラン名を確認（例: `ec-ranger-backend-prod-plan`）

---

### ステップ2: プランをアップグレード

1. **App Serviceプランを開く**
   - App Serviceの「設定 → App Service プラン」から直接リンクをクリック
   - または、リソースグループからApp Serviceプランを直接開く

2. **スケールアップを選択**
   - 左メニュー → 「スケールアップ (App Service プラン)」

3. **Standard S1を選択**
   - 「実稼働」セクション → 「Standard S1」を選択
   - または「レガシ」セクション → 「Standard S1」を選択
   - プランの詳細を確認:
     - **月額コスト**: 約$77.38（約11,600円）
     - **デプロイスロット**: 5スロット利用可能
     - **リモート記憶域**: 50 GB
     - **スケール**: 最大10インスタンス

4. **適用をクリック**
   - 確認ダイアログで「はい」をクリック
   - アップグレードには**数分**かかります
   - ⚠️ **短時間のダウンタイムが発生する可能性があります**

---

### ステップ3: アップグレードの確認

1. **App Serviceプランの状態を確認**
   - 「概要」ページでプラン名が「Standard S1」になっていることを確認

2. **App Serviceが正常に動作していることを確認**
   - App Serviceの「概要」→ 「URL」をクリック
   - アプリケーションが正常に表示されることを確認
   - または、`https://ec-ranger-api.access-net.co.jp/api/health`にアクセスして確認

---

### ステップ4: デプロイスロットを作成

1. **App Serviceに戻る**
   - ブラウザの戻るボタン、またはリソースグループからApp Serviceを開く

2. **デプロイスロットを作成**
   - 左メニュー → 「デプロイ」→ 「デプロイ スロット」
   - 「+ 追加」をクリック

3. **スロット情報を入力**
   ```
   名前: staging
   構成ソース: 現在の本番スロットから複製
   ```
   - **構成ソース**: 「現在の本番スロットから複製」を選択
     - これにより、環境変数やアプリ設定がコピーされます

4. **追加をクリック**
   - スロットが作成されるまで待機（数分）
   - 作成完了後、スロット一覧に`staging`が表示されます

---

### ステップ5: ステージングスロットの確認

1. **ステージングスロットのURLを確認**
   - デプロイスロット一覧で`staging`をクリック
   - 「概要」→ 「URL」を確認
   - 例: `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`

2. **ステージングスロットが正常に動作していることを確認**
   - ステージングスロットのURLにアクセス
   - または、`https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/api/health`にアクセス

3. **カスタムドメインの確認**
   - ⚠️ **重要**: カスタムドメイン（`https://ec-ranger-api.access-net.co.jp`）は常に「production」スロットにバインドされています
   - ステージングスロットにはカスタムドメインは設定されていません（これが正常です）
   - スロットスワップ後も、カスタムドメインのURLは変わりません
   - 詳細は[デプロイスロット-カスタムドメインとスロットスワップ](./デプロイスロット-カスタムドメインとスロットスワップ.md)を参照してください

---

### ステップ6: GitHub Secretsの設定

#### 6-1. ステージングスロット用のPublish Profileを取得

1. **ステージングスロットを開く**
   - デプロイスロット一覧で`staging`をクリック

2. **発行プロファイルをダウンロード**
   - 「概要」→ 「発行プロファイルのダウンロード」
   - `.PublishSettings`ファイルがダウンロードされます

3. **ファイルの内容をコピー**
   - テキストエディタで`.PublishSettings`ファイルを開く
   - ファイル全体の内容をコピー

---

#### 6-2. GitHub Secretsに追加

1. **GitHubリポジトリを開く**
   - https://github.com/[ユーザー名]/shopify-ai-marketing-suite

2. **Settings → Secrets and variables → Actions**
   - リポジトリの「Settings」タブをクリック
   - 左メニュー → 「Secrets and variables」→ 「Actions」

3. **新しいシークレットを追加**
   - 「New repository secret」をクリック
   - 以下の情報を入力:
     ```
     名前: AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING
     値: [ダウンロードしたPublish Profileの内容を貼り付け]
     ```
   - 「Add secret」をクリック

---

#### 6-3. Azure認証情報の確認（既に設定済みの場合はスキップ）

1. **AZURE_CREDENTIALSの確認**
   - GitHub Secretsに`AZURE_CREDENTIALS`が存在することを確認
   - 存在しない場合は、以下の手順で設定:
     - [AZURE_CREDENTIALS-設定確認とトラブルシューティング](./AZURE_CREDENTIALS-設定確認とトラブルシューティング.md)を参照

---

### ステップ7: デプロイワークフローの確認

1. **GitHub Actionsワークフローの確認**
   - `.github/workflows/production_backend.yml`が既にデプロイスロット対応になっていることを確認
   - デプロイスロット使用時のフロー:
     ```
     1. ステージングスロットにデプロイ
     2. ステージングでヘルスチェック
     3. 問題なければスロットスワップ
     ```

2. **デプロイテスト**
   - GitHub Actionsで手動デプロイを実行
   - 入力パラメータ:
     ```
     use_deployment_slot: YES - デプロイスロットを使用（推奨）
     ```
   - デプロイが正常に完了することを確認

---

## 🎯 アップグレード後のデプロイ方法

### デプロイスロットを使用（推奨）

**GitHub Actionsでの手動デプロイ**:
1. 「Actions」タブ → 「Production Backend Deployment」を選択
2. 「Run workflow」をクリック
3. 入力パラメータ:
   ```
   use_deployment_slot: YES - デプロイスロットを使用（推奨）
   deploy_message: [デプロイメッセージ]
   ```
4. 「Run workflow」をクリック

**デプロイフロー**:
- ✅ ステージングスロットにデプロイ（本番は稼働中）
- ✅ ステージングでヘルスチェック
- ✅ 問題なければスロットスワップ（ゼロダウンタイム）
- ✅ 完了

---

### 直接デプロイ（緊急時のみ）

**GitHub Actionsでの手動デプロイ**:
1. 「Actions」タブ → 「Production Backend Deployment」を選択
2. 「Run workflow」をクリック
3. 入力パラメータ:
   ```
   use_deployment_slot: NO - 直接デプロイ（停止が必要）
   deploy_message: [デプロイメッセージ]
   ```
4. 「Run workflow」をクリック

**注意**: 直接デプロイは、デプロイスロットが利用可能でも使用できますが、推奨されません。

---

## ✅ アップグレード完了チェックリスト

- [ ] App Serviceプランが「Standard S1」になっている
- [ ] App Serviceが正常に動作している
- [ ] デプロイスロット`staging`が作成されている
- [ ] ステージングスロットが正常に動作している
- [ ] GitHub Secretsに`AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`が設定されている
- [ ] GitHub Secretsに`AZURE_CREDENTIALS`が設定されている（既に設定済みの場合は確認のみ）
- [ ] GitHub Actionsでデプロイスロットを使用したデプロイが正常に完了する

---

## 🚨 注意事項

### 1. アップグレード中のダウンタイム

- **短時間のダウンタイムが発生する可能性があります**
- **推奨時間**: メンテナンス時間帯（深夜など）に実施することを推奨
- **所要時間**: 通常、数分以内に完了します

---

### 2. コストの増加

- **追加コスト**: 約$15.33/月（約2,300円/月）
- **年間追加コスト**: 約$183.96/年（約27,600円/年）
- **コスト最適化**: リザーブドインスタンス（1年コミット）で約20%割引可能

---

### 3. ダウングレードの制限

- **Standard → Basic**: 可能ですが、デプロイスロットが削除されます
- **データ損失**: デプロイスロット内のデータは失われます
- **推奨**: ダウングレードする前に、デプロイスロット内のデータをバックアップ

---

## 📚 関連ドキュメント

- [デプロイスロット-コスト比較と推奨プラン](./デプロイスロット-コスト比較と推奨プラン.md)
- [デプロイスロット-プラン要件とアップグレード手順](./デプロイスロット-プラン要件とアップグレード手順.md)
- [デプロイスロットを使用した本番デプロイ方法](../08-デバッグ・トラブル/01-problem-analysis/2026-01/2026-01-19-デプロイスロットを使用した本番デプロイ方法.md)
- [AZURE_CREDENTIALS-設定確認とトラブルシューティング](./AZURE_CREDENTIALS-設定確認とトラブルシューティング.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
