# デプロイスロット作成手順書

## 📋 概要

Standard S1にアップグレード完了後、デプロイスロット`staging`を作成し、GitHub Actionsで使用できるように設定します。

---

## ✅ 前提条件

- [x] App Serviceプランが「Standard S1」にアップグレード済み
- [x] App Serviceが正常に動作している
- [x] デプロイスロットページにアクセス可能

---

## 🔧 ステップ1: デプロイスロット`staging`を作成

### 1-1. デプロイスロットページを開く

1. **Azure PortalでApp Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

2. **デプロイスロットページに移動**
   - 左メニュー → 「デプロイ」→ 「デプロイ スロット」
   - 現在は「No slots have been added.」と表示されているはずです

---

### 1-2. スロットを作成

1. **「追加」ボタンをクリック**
   - ページ上部の「追加」ボタンをクリック
   - または、中央の「Add slot」ボタンをクリック

2. **スロット情報を入力**
   ```
   名前: staging
   構成ソース: 現在の本番スロットから複製
   ```
   - **名前**: `staging`（小文字推奨）
   - **構成ソース**: 「現在の本番スロットから複製」を選択
     - これにより、環境変数やアプリ設定がコピーされます
     - 本番環境と同じ設定で開始できます

3. **「追加」をクリック**
   - スロットが作成されるまで待機（**数分**かかります）
   - 作成中は「デプロイ中...」と表示されます

---

### 1-3. スロット作成の確認

1. **スロット一覧を確認**
   - 作成完了後、デプロイスロット一覧に`staging`が表示されます
   - ステータスが「実行中」になっていることを確認

2. **ステージングスロットのURLを確認**
   - `staging`をクリックして、ステージングスロットの詳細ページを開く
   - 「概要」→ 「URL」を確認
   - 例: `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`

3. **ステージングスロットが正常に動作していることを確認**
   - ステージングスロットのURLにアクセス
   - または、`https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/api/health`にアクセス
   - 正常に応答することを確認

---

## 🔐 ステップ2: GitHub Secretsの設定

### 2-1. ステージングスロット用のPublish Profileを取得

1. **ステージングスロットを開く**
   - デプロイスロット一覧で`staging`をクリック
   - または、App Serviceの「デプロイ」→ 「デプロイ スロット」→ `staging`をクリック

2. **発行プロファイルをダウンロード**
   - 「概要」→ 「発行プロファイルのダウンロード」をクリック
   - `.PublishSettings`ファイルがダウンロードされます
   - ファイル名の例: `ec-ranger-backend-prod-staging.PublishSettings`

3. **ファイルの内容をコピー**
   - テキストエディタ（メモ帳、VS Codeなど）で`.PublishSettings`ファイルを開く
   - ファイル全体の内容をコピー（Ctrl+A → Ctrl+C）
   - **重要**: ファイル全体をコピーしてください（XML形式の内容です）

---

### 2-2. GitHub Secretsに追加

1. **GitHubリポジトリを開く**
   - https://github.com/[ユーザー名]/shopify-ai-marketing-suite
   - または、リポジトリのURLを直接開く

2. **Settings → Secrets and variables → Actions**
   - リポジトリの「Settings」タブをクリック
   - 左メニュー → 「Secrets and variables」→ 「Actions」

3. **新しいシークレットを追加**
   - 「New repository secret」ボタンをクリック

4. **シークレット情報を入力**
   ```
   Name: AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING
   Secret: [ダウンロードしたPublish Profileの内容を貼り付け]
   ```
   - **Name**: `AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`
   - **Secret**: 先ほどコピーした`.PublishSettings`ファイルの内容を貼り付け（Ctrl+V）

5. **「Add secret」をクリック**
   - シークレットが追加されます
   - 一覧に`AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`が表示されることを確認

---

### 2-3. Azure認証情報の確認

1. **AZURE_CREDENTIALSの確認**
   - GitHub Secrets一覧で`AZURE_CREDENTIALS`が存在することを確認
   - 存在しない場合は、以下の手順で設定:
     - [AZURE_CREDENTIALS-設定確認とトラブルシューティング](./AZURE_CREDENTIALS-設定確認とトラブルシューティング.md)を参照

---

## ✅ ステップ3: デプロイワークフローの確認

### 3-1. GitHub Actionsワークフローの確認

1. **ワークフローファイルを確認**
   - `.github/workflows/production_backend.yml`が既にデプロイスロット対応になっていることを確認
   - デプロイスロット使用時のフロー:
     ```
     1. ステージングスロットにデプロイ
     2. ステージングでヘルスチェック
     3. 問題なければスロットスワップ
     ```

2. **ワークフローの設定を確認**
   - デフォルトで「デプロイスロットを使用（推奨）」が選択されていることを確認
   - 入力パラメータ:
     ```
     use_deployment_slot: YES - デプロイスロットを使用（推奨）
     ```

---

### 3-2. デプロイテスト

1. **GitHub Actionsで手動デプロイを実行**
   - GitHubリポジトリの「Actions」タブをクリック
   - 左メニュー → 「Production Backend Deploy」を選択
   - 「Run workflow」ボタンをクリック

2. **入力パラメータを設定**
   ```
   deploy_message: デプロイスロットテスト
   confirm_production: YES - 本番環境にデプロイします
   use_deployment_slot: YES - デプロイスロットを使用（推奨）
   ```

3. **「Run workflow」をクリック**
   - デプロイが開始されます
   - 各ステップのログを確認:
     - ✅ ステージングスロットにデプロイ
     - ✅ ステージングでヘルスチェック
     - ✅ スロットスワップ
     - ✅ デプロイ完了

4. **デプロイ結果の確認**
   - デプロイが正常に完了することを確認
   - 本番環境のURLにアクセスして、アプリケーションが正常に動作することを確認
   - 例: `https://ec-ranger-api.access-net.co.jp/api/health`

---

## ✅ 完了チェックリスト

- [ ] デプロイスロット`staging`が作成されている
- [ ] ステージングスロットが正常に動作している
- [ ] GitHub Secretsに`AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`が設定されている
- [ ] GitHub Secretsに`AZURE_CREDENTIALS`が設定されている（既に設定済みの場合は確認のみ）
- [ ] GitHub Actionsでデプロイスロットを使用したデプロイが正常に完了する
- [ ] 本番環境が正常に動作している

---

## 🎯 デプロイ方法の使い分け

### 通常のデプロイ（推奨）

**デプロイスロットを使用**:
- ✅ ゼロダウンタイムデプロイ
- ✅ ファイルロック問題の完全解決
- ✅ ステージング環境で事前テスト可能
- ✅ ロールバックが容易
- ✅ **カスタムドメインのURLは変わらない**（常にproductionスロットを指す）

**設定**:
```
use_deployment_slot: YES - デプロイスロットを使用（推奨）
```

**重要**: スロットスワップ後も、カスタムドメイン（`https://ec-ranger-api.access-net.co.jp`）は常に「production」スロットを指し続けるため、URLが変わることはありません。詳細は[デプロイスロット-カスタムドメインとスロットスワップ](./デプロイスロット-カスタムドメインとスロットスワップ.md)を参照してください。

---

### 緊急時のデプロイ（非推奨）

**直接デプロイ**:
- ⚠️ 短時間のダウンタイムが発生する可能性
- ⚠️ ファイルロック問題が発生する可能性
- ⚠️ `app_offline.htm`を使用する必要がある

**設定**:
```
use_deployment_slot: NO - 直接デプロイ（停止が必要）
```

**注意**: デプロイスロットが利用可能でも、直接デプロイは使用できますが、推奨されません。

---

## 🚨 トラブルシューティング

### 問題1: デプロイスロットが作成できない

**原因**: App ServiceプランがStandard以上でない可能性

**解決方法**:
1. App Serviceプランを確認
2. Standard S1以上にアップグレード
3. 参考: [デプロイスロット-プラン要件とアップグレード手順](./デプロイスロット-プラン要件とアップグレード手順.md)

---

### 問題2: GitHub Secretsの設定が反映されない

**原因**: シークレット名が間違っている可能性

**解決方法**:
1. GitHub Secretsの名前を確認: `AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`
2. 大文字・小文字を正確に一致させる
3. ワークフローファイルの参照名と一致していることを確認

---

### 問題3: デプロイが失敗する

**原因**: Publish Profileの内容が正しくない可能性

**解決方法**:
1. Publish Profileを再ダウンロード
2. ファイル全体をコピーして、GitHub Secretsに再設定
3. デプロイを再実行

---

### 問題4: スロットスワップが失敗する

**原因**: ステージングスロットが正常に動作していない可能性

**解決方法**:
1. ステージングスロットのURLに直接アクセスして動作確認
2. ステージングスロットのログを確認
3. ヘルスチェックが成功していることを確認

---

## 📚 関連ドキュメント

- [Standard-S1-アップグレード手順](./Standard-S1-アップグレード手順.md)
- [デプロイスロット-コスト比較と推奨プラン](./デプロイスロット-コスト比較と推奨プラン.md)
- [デプロイスロット-プラン要件とアップグレード手順](./デプロイスロット-プラン要件とアップグレード手順.md)
- [デプロイスロットを使用した本番デプロイ方法](../08-デバッグ・トラブル/01-problem-analysis/2026-01/2026-01-19-デプロイスロットを使用した本番デプロイ方法.md)
- [AZURE_CREDENTIALS-設定確認とトラブルシューティング](./AZURE_CREDENTIALS-設定確認とトラブルシューティング.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
