# 404エラー - アクセス権表示の違い調査

## 作成日
2025-12-28

## 目的
NG環境とOK環境で表示されるアクセス権に違いがある原因を調査する。

---

## 問題の概要

### 観察された違い

**NG環境（ECレンジャー(local)）のインストール画面:**
- 注文の表示: **"すべての注文詳細"** (All order details)

**OK環境（EC Ranger-xn-fbkq6e5da0fpb）のインストール画面:**
- 注文の表示: **"過去60日間のすべての注文詳細"** (All order details from the past 60 days)

### 違いの意味

- **"すべての注文詳細"**: `read_all_orders`スコープが設定されていることを示す
- **"過去60日間のすべての注文詳細"**: `read_orders`スコープが設定されていることを示す

---

## 調査結果

### 1. Shopify Partner Dashboardでのスコープ設定

#### NG環境（ECレンジャー(local)）
- **設定されているスコープ**: 
  - `read_all_orders`（Optional scopes）
  - `read_customers`
  - `read_orders`
  - `read_products`
- **表示されるアクセス権**: "すべての注文詳細" ✅

#### OK環境（EC Ranger-xn-fbkq6e5da0fpb）
- **設定されているスコープ**: 
  - `read_customers`
  - `read_orders`
  - `read_products`
- **表示されるアクセス権**: "過去60日間のすべての注文詳細" ✅

**違い**: NG環境には`read_all_orders`スコープが含まれているが、OK環境には含まれていない

---

### 2. appsettings.jsonでのスコープ設定

#### NG環境（Development）
```json
{
  "Shopify": {
    "Scopes": "read_orders,read_products,read_customers"
  }
}
```

#### OK環境（Production）
```json
{
  "Shopify": {
    "Scopes": "read_orders,read_products,read_customers"
  }
}
```

**違い**: **同じスコープ設定** ✅

---

### 3. ShopifyAppsテーブルのScopesカラム

#### NG環境
- **更新後の値**: `read_all_orders,read_customers,read_orders,read_products`
- **更新前の値**: `read_orders,read_products,read_customers`

#### OK環境
- **値**: `read_orders,read_products,read_customers`

**違い**: NG環境には`read_all_orders`が含まれているが、OK環境には含まれていない

**注意**: ShopifyAppsテーブルのScopesカラムは、コードレベルでは使用されていない（`appsettings.json`の`Shopify:Scopes`を使用）

---

### 4. OAuthフローでのスコープ使用

**コード実装**（`ShopifyAuthController.cs`）:
```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs (188行目)
var scopes = GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
_logger.LogInformation("OAuth scopes: {Scopes}", scopes);

var authUrl = $"https://{shop}/admin/oauth/authorize" +
    $"?client_id={finalApiKey}" +
    $"&scope={scopes}" +
    $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
    $"&state={state}";
```

**確認結果**:
- ✅ OAuthフローでは`GetShopifySetting("Scopes")`を使用
- ✅ `appsettings.json`の`Shopify:Scopes`設定から取得
- ❌ ShopifyAppsテーブルの`Scopes`カラムは**使用されていない**
- ❌ Shopify Partner Dashboardで設定したスコープは**直接使用されていない**

---

## 根本原因の特定

### 問題の原因

**Shopify Partner Dashboardで設定したスコープと、OAuthフローでリクエストされるスコープが一致していない**

**詳細**:
1. **Shopify Partner Dashboard（NG環境）**: `read_all_orders`を含むスコープが設定されている
2. **appsettings.json（NG環境）**: `read_orders,read_products,read_customers`のみが設定されている
3. **OAuthフロー**: `appsettings.json`の設定を使用するため、`read_all_orders`がリクエストされない
4. **Shopifyの表示**: Shopify Partner Dashboardで設定したスコープに基づいて表示されるため、`read_all_orders`が含まれているように見える

**しかし、実際のOAuthフローでは`read_all_orders`がリクエストされていないため、承認されたスコープは`read_orders`のみになる可能性がある**

---

## 影響範囲

### 1. インストール画面の表示

- **Shopify Partner Dashboardで設定したスコープ**: インストール画面に表示される
- **実際にリクエストされるスコープ**: `appsettings.json`の設定に基づく

**結果**: インストール画面に表示されるアクセス権と、実際にリクエストされるスコープが一致しない可能性がある

### 2. 実際のアクセス権

- **OAuthフローでリクエストされるスコープ**: `read_orders,read_products,read_customers`
- **承認されるスコープ**: `read_orders`のみ（`read_all_orders`はリクエストされていない）

**結果**: 実際に取得できるアクセス権は、インストール画面に表示されるものより制限される可能性がある

---

## 解決策

### オプション1: appsettings.jsonを更新（推奨）

**NG環境の`appsettings.Development.json`を更新**:
```json
{
  "Shopify": {
    "Scopes": "read_all_orders,read_customers,read_orders,read_products"
  }
}
```

**メリット**:
- OAuthフローで`read_all_orders`がリクエストされる
- インストール画面の表示と実際のアクセス権が一致する
- すべての注文データにアクセスできる

**デメリット**:
- より広範なアクセス権を要求することになる
- ストアオーナーがより多くの権限を承認する必要がある

### オプション2: Shopify Partner Dashboardのスコープを更新

**NG環境のShopify Partner Dashboardから`read_all_orders`を削除**:
- Optional scopesから`read_all_orders`を削除
- `read_customers,read_orders,read_products`のみに設定

**メリット**:
- インストール画面の表示と実際のアクセス権が一致する
- より制限されたアクセス権を要求する

**デメリット**:
- すべての注文データにアクセスできない（過去60日間のみ）

### オプション3: 現状維持

**現状のまま維持**:
- Shopify Partner Dashboard: `read_all_orders`を含む
- `appsettings.json`: `read_orders`のみ

**メリット**:
- 変更不要

**デメリット**:
- インストール画面の表示と実際のアクセス権が一致しない
- 混乱を招く可能性がある

---

## 推奨対応

### 推奨: オプション1（appsettings.jsonを更新）

**理由**:
1. **一貫性**: インストール画面の表示と実際のアクセス権が一致する
2. **機能性**: すべての注文データにアクセスできる
3. **明確性**: ストアオーナーが承認する権限と実際の権限が一致する

**実施手順**:
1. NG環境の`appsettings.Development.json`を更新
2. バックエンドを再デプロイ
3. 動作確認（OAuthフローで`read_all_orders`がリクエストされることを確認）

---

## 確認事項

### 1. 現在の設定の確認

- [ ] Shopify Partner Dashboard（NG環境）で設定されているスコープを確認
- [ ] `appsettings.Development.json`で設定されているスコープを確認
- [ ] 実際のOAuthフローでリクエストされるスコープを確認（ログから）

### 2. 動作確認

- [ ] OAuthフローで`read_all_orders`がリクエストされることを確認
- [ ] インストール画面の表示が正しいことを確認
- [ ] 実際に取得できるアクセス権が期待通りであることを確認

---

## 参考資料

- [ShopifyAppsテーブルScopes影響調査](./404エラー-ShopifyAppsテーブルScopes影響調査.md)
- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)
- [Shopify API スコープドキュメント](https://shopify.dev/docs/api/usage/access-scopes)

---

## 更新履歴

- 2025-12-28: 初版作成（アクセス権表示の違い調査）
