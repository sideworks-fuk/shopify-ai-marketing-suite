# 404エラー - アクセス権表示の違い 調査進捗

## 作成日
2025-12-28

## 目的
検証環境と本番環境で、設定は同じなのに「すべての注文詳細」の表示が異なる原因を調査する進捗を記録する。

---

## 調査状況サマリー

### ✅ 完了した調査項目

1. **Shopify Partner DashboardのOptional scopesの確認**
   - **結果**: 両環境とも未設定
   - **結論**: Optional scopesの設定の違いは原因ではない

2. **環境変数の確認**
   - **結果**: 両環境とも環境変数では設定していない
   - **結論**: 環境変数による上書きは原因ではない

### 🔍 調査中の項目

1. **OAuthフローのログ確認**（最優先）
   - 検証環境と本番環境で、実際にOAuth URLに含まれるスコープを比較
   - `OAuth scopes: {Scopes}`のログを確認
   - 実際にリクエストされるスコープが一致しているか確認

2. **承認状態の確認**
   - API Access Requestの承認状態を確認
   - 検証環境と本番環境で、承認日時や承認状態が異なるか確認

3. **アプリの組織による表示ロジックの違い**
   - FUK管理アプリとアクセスネット管理アプリで、Shopify側の表示ロジックが異なる可能性
   - Shopifyのドキュメントやサポートに確認が必要な可能性

---

## 確認済みの情報

### 共通点（設定は同じ）

- ✅ Shopify管理メニューではどちらも「すべての注文範囲を読み込む」申請済み
- ✅ ShopifyAppsテーブルはどちらも`read_all_orders,read_customers,read_orders,read_products`
- ✅ appsettingsはどちらも`"Scopes": "read_orders,read_products,read_customers"`
- ✅ Shopify Partner DashboardのOptional scopesはどちらも未設定
- ✅ 環境変数（`SHOPIFY_SCOPES`）はどちらも設定していない

### 違い（表示が異なる）

- **検証環境**: "すべての注文詳細"が表示される ✅
- **本番環境**: "すべての注文詳細"が表示されない ❌

### 組織の違い

- **検証環境**: FUK管理アプリ → FUKのストアインストール
- **本番環境**: アクセスネット管理アプリ → FUKのストアインストール

---

## 次の調査ステップ

### ステップ2: OAuthフローのログ確認（最優先）

**目的**: 実際にOAuth URLに含まれるスコープを確認し、検証環境と本番環境で異なるか確認する

**確認方法**:
1. 検証環境のバックエンドログを確認
   - OAuth URL生成時のログを確認
   - `OAuth scopes: {Scopes}`のログを確認
   - 実際にリクエストされるスコープを記録

2. 本番環境のバックエンドログを確認
   - OAuth URL生成時のログを確認
   - `OAuth scopes: {Scopes}`のログを確認
   - 実際にリクエストされるスコープを記録

3. 比較
   - 両環境でリクエストされるスコープが一致しているか確認
   - 不一致があれば記録

**期待される結果**:
- 検証環境: `read_all_orders`が含まれている可能性
- 本番環境: `read_all_orders`が含まれていない可能性

**確認ポイント**:
- [ ] 検証環境のOAuth URLに`read_all_orders`が含まれているか
- [ ] 本番環境のOAuth URLに`read_all_orders`が含まれているか
- [ ] 両環境でリクエストされるスコープが一致しているか

---

### ステップ3: 環境変数の確認 ✅ 完了

**目的**: Azure App Serviceの環境変数が`appsettings.json`を上書きしているか確認する

**確認方法**:
1. 検証環境のAzure App Serviceの環境変数を確認
   - [x] `SHOPIFY_SCOPES`が設定されているか確認 → **設定していない**
   - [x] 設定値に`read_all_orders`が含まれているか確認 → **該当なし**

2. 本番環境のAzure App Serviceの環境変数を確認
   - [x] `SHOPIFY_SCOPES`が設定されているか確認 → **設定していない**
   - [x] 設定値に`read_all_orders`が含まれているか確認 → **該当なし**

3. 比較
   - [x] 両環境で環境変数が一致しているか確認 → **一致している（どちらも未設定）**

**確認結果**:
- ✅ 検証環境の環境変数: **設定していない**
- ✅ 本番環境の環境変数: **設定していない**
- ✅ 両環境で環境変数は一致している

**結論**: 環境変数による上書きは原因ではない

---

### ステップ4: 承認状態の確認

**目的**: API Access Requestの承認状態が異なるか確認する

**確認方法**:
1. 検証環境のAPI Access Requestの承認状態を確認
   - 「すべての注文範囲を読み込む」の承認状態を確認
   - 承認日時を確認

2. 本番環境のAPI Access Requestの承認状態を確認
   - 「すべての注文範囲を読み込む」の承認状態を確認
   - 承認日時を確認

3. 比較
   - 両環境で承認状態が一致しているか確認
   - 不一致があれば記録

**確認ポイント**:
- [ ] 検証環境で「すべての注文範囲を読み込む」が承認されているか
- [ ] 本番環境で「すべての注文範囲を読み込む」が承認されているか
- [ ] 両環境で承認状態が一致しているか

---

## 考えられる原因（更新）

### ❌ 原因1: Optional scopesの設定の違い → 該当なし

**確認結果**: 両環境とも未設定

### ❌ 原因2: 環境変数による上書き → 該当なし

**確認結果**: 
- ✅ 検証環境の環境変数: **設定していない**
- ✅ 本番環境の環境変数: **設定していない**
- ✅ 両環境で環境変数は一致している

**結論**: 環境変数による上書きは原因ではない

### 🔍 原因3: Shopify側の承認状態の違い（調査中）

**仮説**: 
- アプリの組織が異なるため、Shopify側での承認状態が異なる
- FUK管理アプリとアクセスネット管理アプリで、承認プロセスが異なる

**確認方法**: API Access Requestの承認状態を確認

### 🔍 原因4: OAuthフローでのスコープリクエストの違い（調査中）

**仮説**: 
- 検証環境のOAuth URLに`read_all_orders`が含まれている
- 本番環境のOAuth URLに`read_all_orders`が含まれていない

**確認方法**: OAuthフローのログを確認

### 🔍 原因5: アプリの組織による表示ロジックの違い（調査中）

**仮説**: 
- アプリの組織が異なるため、Shopify側の表示ロジックが異なる
- FUK管理アプリとアクセスネット管理アプリで、表示条件が異なる

**確認方法**: Shopifyのドキュメントやサポートに確認

---

## 参考資料

- [アクセス権表示の違い詳細調査](./404エラー-アクセス権表示の違い詳細調査.md)
- [アクセス権表示の違い調査](./404エラー-アクセス権表示の違い調査.md)
- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)

---

## 更新履歴

- 2025-12-28: 初版作成（調査進捗の記録）
- 2025-12-28: Optional scopesの確認結果を反映
- 2025-12-28: 環境変数の確認結果を反映（両環境とも設定していないことを確認）
