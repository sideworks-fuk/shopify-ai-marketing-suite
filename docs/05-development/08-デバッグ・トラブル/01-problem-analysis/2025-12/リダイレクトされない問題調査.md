# リダイレクトされない問題調査

## 最終更新: 2025-12-XX

## 問題の概要

カスタムアプリのインストール後、Shopify管理画面からアプリを開いた際に、`/` ページから `/install` ページにリダイレクトされない問題が発生している。

## 特定された原因

### 🔴 原因1: `authMode`が`null`の場合、`isAuthenticated`が明示的に設定されない

**問題のコード** (`AuthProvider.tsx` 121-146行目):

```typescript
if (authMode === 'shopify' && isEmbedded) {
  // Shopify埋め込みアプリの場合
  // ...
} else if (authMode === 'demo') {
  // デモモードの場合
  // ...
}
// ⚠️ authModeがnullの場合、この条件分岐に入らない
// その結果、setIsAuthenticated(false)が実行されない
```

**影響**:
- カスタムアプリのインストール直後、`authMode`が`null`になる可能性がある
- `isAuthenticated`が初期値の`false`のままになるが、明示的に設定されていない
- 状態の更新がReactに正しく伝わらない可能性がある

### 🔴 原因2: `apiClient`が初期化される前に`initializeAuth`が実行されない

**問題のコード** (`AuthProvider.tsx` 157-160行目):

```typescript
if (apiClient) {
  initializeAuth()
}
```

**影響**:
- `apiClient`が`null`の場合、`initializeAuth`が実行されない
- `isInitializing`が`true`のままになる
- `/`ページのリダイレクトロジックが実行されない

### 🔴 原因3: `authMode`の設定タイミングの問題

**問題のコード** (`AuthProvider.tsx` 58-105行目):

```typescript
useEffect(() => {
  let client: ApiClient;
  
  if (isEmbedded) {
    // Shopify埋め込みアプリの場合
    client = new ApiClient(...)
    setAuthMode('shopify')
  } else {
    // スタンドアロンアプリの場合
    const oauthAuthenticated = localStorage.getItem('oauth_authenticated')
    const demoToken = localStorage.getItem('demoToken')
    
    if (oauthAuthenticated === 'true') {
      client = new ApiClient()
      setAuthMode('shopify')
    } else if (demoToken) {
      client = new ApiClient(...)
      setAuthMode('demo')
    } else {
      client = new ApiClient()
      setAuthMode(null) // ⚠️ nullになる
    }
  }
  
  setApiClient(client)
}, [getToken, isEmbedded])
```

**影響**:
- カスタムアプリのインストール直後、`oauth_authenticated`が`'true'`でない場合、`authMode`が`null`になる
- `isEmbedded`が`true`でも、`apiKey`が設定されていない場合、`authMode`が`null`になる可能性がある

## 想定される原因（その他）

**症状**: `isInitializing`が`true`のままになっている

**確認方法**:
1. ブラウザの開発者ツールでコンソールを開く
2. 以下のログを確認:
   - `🚀 認証の初期化を開始...`
   - `✅ APIクライアントの初期化が完了しました`
   - `⏳ 認証状態の初期化中...`（`page.tsx`から）

**原因の可能性**:
- `apiClient`が初期化されていない
- `authMode`が`null`のままになっている
- `isEmbedded`の判定が正しく動作していない

### 2. 認証状態の判定ロジックの問題

**症状**: `isAuthenticated`が`false`のままになっているが、リダイレクトされない

**確認方法**:
1. ブラウザの開発者ツールでコンソールを開く
2. 以下のログを確認:
   - `🔍 認証状態をチェック:`（`page.tsx`から）
   - `⚠️ 未認証: インストールページにリダイレクト:`（`page.tsx`から）

**原因の可能性**:
- `isInitializing`が`true`のままになっているため、リダイレクト処理が実行されない
- `useEffect`の依存配列に問題がある
- `router.replace`が正しく動作していない

### 3. App Bridgeの初期化タイミングの問題

**症状**: `isEmbedded`が正しく判定されていない

**確認方法**:
1. ブラウザの開発者ツールでコンソールを開く
2. 以下のログを確認:
   - `✅ Shopify App Bridge initialized`（`app-bridge-provider.tsx`から）
   - `🔗 Shopify埋め込みアプリモードでAPIクライアントを初期化`（`AuthProvider.tsx`から）

**原因の可能性**:
- App Bridgeの初期化が完了する前に認証状態の判定が実行されている
- `isEmbedded`の判定ロジックに問題がある

## 調査手順

### ステップ1: ブラウザのコンソールログを確認

1. カスタムアプリのインストールリンクからインストール
2. Shopify管理画面からアプリを開く
3. ブラウザの開発者ツール（F12）でコンソールタブを開く
4. 以下のログを確認:

```
🚀 認証の初期化を開始...
✅ APIクライアントの初期化が完了しました
🔍 認証状態をチェック: { isAuthenticated: false, shop: "...", host: "...", embedded: "..." }
⚠️ 未認証: インストールページにリダイレクト: /install?shop=...&host=...&embedded=...
```

### ステップ2: 認証状態の確認

ブラウザのコンソールで以下のコマンドを実行:

```javascript
// localStorageの確認
console.log('oauth_authenticated:', localStorage.getItem('oauth_authenticated'))
console.log('currentStoreId:', localStorage.getItem('currentStoreId'))
console.log('demoToken:', localStorage.getItem('demoToken'))

// URLパラメータの確認
const urlParams = new URLSearchParams(window.location.search)
console.log('shop:', urlParams.get('shop'))
console.log('host:', urlParams.get('host'))
console.log('embedded:', urlParams.get('embedded'))
```

### ステップ3: ネットワークタブの確認

1. ブラウザの開発者ツールでネットワークタブを開く
2. アプリを開いた際のリクエストを確認
3. 以下のリクエストが発生しているか確認:
   - `/` へのリクエスト
   - `/install` へのリダイレクト

### ステップ4: React DevToolsでの確認

1. React DevToolsをインストール（Chrome拡張機能）
2. コンポーネントツリーで`HomePage`を選択
3. 以下のprops/stateを確認:
   - `isAuthenticated`: `false`であることを確認
   - `isInitializing`: `false`であることを確認
   - `searchParams`: `shop`, `host`, `embedded`が含まれていることを確認

## 修正方法

### ✅ 修正案1: `authMode`が`null`の場合でも`isAuthenticated`を明示的に設定（推奨）

`AuthProvider.tsx`の`initializeAuth`関数を修正:

```typescript
// アプリ起動時の自動認証
useEffect(() => {
  const initializeAuth = async () => {
    console.log('🚀 認証の初期化を開始...')
    try {
      setIsInitializing(true)
      setAuthError(null)
      migrateLocalStorageVariables()
      
      const savedStoreId = localStorage.getItem('currentStoreId')
      const storeId = savedStoreId ? parseInt(savedStoreId, 10) : 1
      console.log('🏪 Store ID:', storeId)
      setCurrentStoreId(storeId)
      
      if (authMode === 'shopify' && isEmbedded) {
        // Shopify埋め込みアプリの場合、App Bridgeからトークンを取得
        try {
          const token = await getToken()
          if (token) {
            console.log('✅ Shopifyセッショントークンを取得しました')
            setIsAuthenticated(true)
          } else {
            console.log('⚠️ Shopifyセッショントークンが取得できませんでした')
            setIsAuthenticated(false)
          }
        } catch (error) {
          console.error('❌ Shopifyトークン取得エラー:', error)
          setIsAuthenticated(false)
        }
      } else if (authMode === 'demo') {
        // デモモードの場合、ローカルストレージからデモトークンを確認
        const demoToken = localStorage.getItem('demoToken')
        if (demoToken) {
          console.log('✅ デモトークンが見つかりました')
          setIsAuthenticated(true)
        } else {
          console.log('⚠️ デモトークンが見つかりませんでした')
          setIsAuthenticated(false)
        }
      } else {
        // ⚠️ 修正: authModeがnullの場合でも、明示的にisAuthenticatedをfalseに設定
        console.log('⚠️ 認証モードが設定されていません。未認証として扱います。')
        setIsAuthenticated(false)
      }
    } catch (error: any) {
      console.error('❌ 認証の初期化に失敗:', error)
      setAuthError(error.message || '認証に失敗しました')
      setIsAuthenticated(false)
      console.log('⚠️ 認証なしでアプリケーションを継続します')
    } finally {
      setIsInitializing(false)
    }
  }
  
  // ⚠️ 修正: apiClientがnullの場合でも、初期化を実行する
  // ただし、apiClientが初期化されるまで待つ
  if (apiClient) {
    initializeAuth()
  } else {
    // apiClientが初期化されていない場合、初期化を待つ
    console.log('⏳ APIクライアントの初期化を待機中...')
    // apiClientが初期化されたら、このuseEffectが再実行される
  }
}, [apiClient, authMode, isEmbedded, getToken])
```

### ✅ 修正案2: `apiClient`が初期化されていない場合のフォールバック処理

`AuthProvider.tsx`の`initializeAuth`関数で、`authMode`が`null`の場合でも初期化を完了させる:

```typescript
// アプリ起動時の自動認証
useEffect(() => {
  const initializeAuth = async () => {
    console.log('🚀 認証の初期化を開始...')
    try {
      setIsInitializing(true)
      setAuthError(null)
      migrateLocalStorageVariables()
      
      const savedStoreId = localStorage.getItem('currentStoreId')
      const storeId = savedStoreId ? parseInt(savedStoreId, 10) : 1
      console.log('🏪 Store ID:', storeId)
      setCurrentStoreId(storeId)
      
      if (authMode === 'shopify' && isEmbedded) {
        // Shopify埋め込みアプリの場合、App Bridgeからトークンを取得
        try {
          const token = await getToken()
          if (token) {
            console.log('✅ Shopifyセッショントークンを取得しました')
            setIsAuthenticated(true)
          } else {
            console.log('⚠️ Shopifyセッショントークンが取得できませんでした')
            setIsAuthenticated(false)
          }
        } catch (error) {
          console.error('❌ Shopifyトークン取得エラー:', error)
          setIsAuthenticated(false)
        }
      } else if (authMode === 'demo') {
        // デモモードの場合、ローカルストレージからデモトークンを確認
        const demoToken = localStorage.getItem('demoToken')
        if (demoToken) {
          console.log('✅ デモトークンが見つかりました')
          setIsAuthenticated(true)
        } else {
          console.log('⚠️ デモトークンが見つかりませんでした')
          setIsAuthenticated(false)
        }
      } else {
        // authModeがnullの場合（カスタムアプリのインストール直後など）
        // 未認証として扱い、初期化を完了させる
        console.log('⚠️ 認証モードが設定されていません。未認証として扱います。')
        setIsAuthenticated(false)
      }
    } catch (error: any) {
      console.error('❌ 認証の初期化に失敗:', error)
      setAuthError(error.message || '認証に失敗しました')
      setIsAuthenticated(false)
      console.log('⚠️ 認証なしでアプリケーションを継続します')
    } finally {
      setIsInitializing(false)
    }
  }
  
  if (apiClient) {
    initializeAuth()
  }
}, [apiClient, authMode, isEmbedded, getToken])
```

### 修正案2: `/` ページのリダイレクトロジックを強化

`page.tsx`のリダイレクトロジックで、タイムアウトを追加:

```typescript
useEffect(() => {
  // 初期化中は何もしない（認証状態の判定を待つ）
  if (isInitializing) {
    console.log('⏳ 認証状態の初期化中...');
    return;
  }

  // 初期化完了後、少し待機してからリダイレクト（認証状態の変動を防ぐ）
  const timeoutId = setTimeout(() => {
    const shop = searchParams?.get('shop')
    const host = searchParams?.get('host')
    const embedded = searchParams?.get('embedded')

    console.log('🔍 認証状態をチェック:', { isAuthenticated, shop, host, embedded });

    if (isAuthenticated) {
      // 認証済みの場合、ダッシュボードにリダイレクト
      const params = new URLSearchParams()
      if (shop) params.set('shop', shop)
      if (host) params.set('host', host)
      if (embedded) params.set('embedded', embedded)
      
      const queryString = params.toString()
      const redirectUrl = `/customers/dormant${queryString ? `?${queryString}` : ''}`
      console.log('✅ 認証済み: ダッシュボードにリダイレクト:', redirectUrl)
      router.replace(redirectUrl)
    } else {
      // 未認証の場合、インストールページにリダイレクト
      const params = new URLSearchParams()
      if (shop) params.set('shop', shop)
      if (host) params.set('host', host)
      if (embedded) params.set('embedded', embedded)
      
      const queryString = params.toString()
      const redirectUrl = `/install${queryString ? `?${queryString}` : ''}`
      console.log('⚠️ 未認証: インストールページにリダイレクト:', redirectUrl)
      
      // リダイレクトを確実に実行するため、window.locationを使用
      if (redirectUrl !== window.location.pathname + window.location.search) {
        router.replace(redirectUrl)
      }
    }
  }, 100); // 100ms待機してからリダイレクト

  return () => clearTimeout(timeoutId);
}, [isAuthenticated, isInitializing, router, searchParams])
```

### 修正案3: タイムアウト処理を追加

`isInitializing`が長時間`true`のままの場合、タイムアウトを設定:

```typescript
useEffect(() => {
  // タイムアウト処理: 5秒経過しても初期化が完了しない場合、強制的に初期化を完了させる
  const timeoutId = setTimeout(() => {
    if (isInitializing) {
      console.warn('⚠️ 認証状態の初期化がタイムアウトしました。強制的に初期化を完了します。')
      // 強制的に初期化を完了させる処理は、AuthProvider側で実装する必要がある
    }
  }, 5000);

  return () => clearTimeout(timeoutId);
}, [isInitializing])
```

## 確認事項チェックリスト

- [ ] ブラウザのコンソールログを確認
- [ ] `isInitializing`が`false`になっているか確認
- [ ] `isAuthenticated`が`false`になっているか確認
- [ ] URLパラメータ（`shop`, `host`, `embedded`）が含まれているか確認
- [ ] `router.replace`が実行されているか確認
- [ ] ネットワークタブでリダイレクトが発生しているか確認
- [ ] React DevToolsでコンポーネントの状態を確認

## 次のステップ

1. 上記の調査手順を実行
2. 問題の原因を特定
3. 適切な修正方法を選択
4. 修正を実装
5. 動作確認

