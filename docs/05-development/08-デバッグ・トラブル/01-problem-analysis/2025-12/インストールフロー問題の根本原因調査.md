# インストールフロー問題の根本原因調査

## 作成日
2025-12-25

## 問題の概要

### 現象
1. アプリインストール時に「認証状態を確認中...」で画面が止まり、先に進まない
2. コンソールログで401エラーが繰り返し発生
3. ストアがデータベースに保存されていない（`Stores`テーブルにレコードがない）

### エラーログ
```
Error fetching subscription data: Error: API Error: 401 {"error":"Unauthorized","message":"OAuth authentication required"}
Error fetching selected feature: Error: API Error: 401 {"error": "Unauthorized", "message":"OAuth authentication required"}
GET /api/store 401 (Unauthorized)
```

## フロー全体の整理

### 1. インストールフロー（期待される動作）

```
[ユーザー] 
  ↓
[フロントエンド /install ページ]
  ↓ handleInstall()
  ↓
[バックエンド /api/shopify/install]
  ↓ HTTP 302 Redirect
  ↓
[Shopify OAuth認証画面]
  ↓ ユーザーが承認
  ↓
[Shopify] → [フロントエンド /api/shopify/callback] (Next.js API Route)
  ↓ バックエンドに転送
  ↓
[バックエンド /api/shopify/callback]
  ↓ ストア情報を保存
  ↓ セッションCookieを設定
  ↓ HTTP 302 Redirect
  ↓
[フロントエンド /auth/success]
  ↓ markAuthenticated()
  ↓ localStorage.setItem('oauth_authenticated', 'true')
  ↓ router.replace('/setup/initial')
  ↓
[フロントエンド /setup/initial]
  ↓ 初期同期開始
  ↓
[フロントエンド /customers/dormant] (ダッシュボード)
```

### 2. ルートページ（`/`）の動作

```typescript
// frontend/src/app/page.tsx
useEffect(() => {
  // 1. 初期化中またはAPIクライアントが準備完了していない場合は待機
  if (isInitializing || !isApiClientReady) {
    setStatusMessage('認証状態を確認中...')
    return
  }

  // 2. 認証済みの場合、ストアの存在を確認
  if (isAuthenticated) {
    const response = await fetch(`${config.apiBaseUrl}/api/store`, {
      credentials: 'include',
    })
    // ...
  } else {
    // 3. 未認証の場合、インストールページにリダイレクト
    router.replace('/install')
  }
}, [isAuthenticated, isInitializing, isApiClientReady])
```

### 3. AuthProviderの認証状態チェック

```typescript
// frontend/src/components/providers/AuthProvider.tsx
useEffect(() => {
  const initializeAuth = async () => {
    if (authMode === 'shopify' && isEmbedded) {
      // Shopify埋め込みアプリの場合、App Bridgeからトークンを取得
      const token = await getToken()
      if (token) {
        setIsAuthenticated(true)
      } else {
        setIsAuthenticated(false)
      }
    } else if (authMode === 'shopify' && !isEmbedded) {
      // スタンドアロンアプリの場合、oauth_authenticatedフラグを確認
      const oauthAuthenticated = localStorage.getItem('oauth_authenticated')
      if (oauthAuthenticated === 'true') {
        setIsAuthenticated(true)
      } else {
        setIsAuthenticated(false)
      }
    }
  }
  initializeAuth()
}, [])
```

### 4. SubscriptionProviderのAPI呼び出し

```typescript
// frontend/src/contexts/SubscriptionContext.tsx
useEffect(() => {
  // インストールページではAPIを呼び出さない
  const isInstallPage = pathname === '/install';
  if (isInstallPage) {
    setLoading(false);
    return;
  }
  
  // ApiClientが初期化されるまで待機
  if (!isApiClientReady) {
    return;
  }
  
  // API呼び出し
  fetchSubscriptionData();
  fetchSelectedFeature();
}, [isApiClientReady, fetchSubscriptionData, fetchSelectedFeature, pathname])
```

## 問題の根本原因分析

### 問題1: ルートページ（`/`）で401エラーが発生

**原因**:
- `SubscriptionProvider`が`/`ページでAPIを呼び出している
- しかし、`/`ページは`/install`ではないため、`isInstallPage`チェックが`false`になる
- その結果、認証前（OAuth完了前）にAPIを呼び出して401エラーが発生

**証拠**:
- コンソールログで`/api/subscription/status`と`/api/feature-selection/current`へのリクエストが401を返している
- これらのリクエストは`SubscriptionProvider`から発行されている

### 問題2: 「認証状態を確認中...」で止まる

**原因**:
- `AuthProvider`の`isInitializing`が`true`のまま、または`isApiClientReady`が`false`のままになっている可能性
- または、`isAuthenticated`が`false`のまま、`/install`へのリダイレクトが実行されていない

**考えられる原因**:
1. `AuthProvider`の初期化が完了していない
2. `isApiClientReady`が`false`のまま
3. `useEffect`の依存配列の問題で、状態更新が反映されていない

### 問題3: ストアがデータベースに保存されていない

**原因**:
- OAuthコールバックが正しく処理されていない
- または、OAuthコールバックが到達していない

**確認すべきポイント**:
1. バックエンドのログで`/api/shopify/callback`へのリクエストが記録されているか
2. `SaveOrUpdateStore`メソッドが実行されているか
3. エラーが発生していないか

## 調査すべきポイント

### 1. フロントエンドのログ確認

**確認項目**:
- `AuthProvider`の初期化ログ
- `isInitializing`、`isApiClientReady`、`isAuthenticated`の値
- `SubscriptionProvider`のAPI呼び出しタイミング

**期待されるログ**:
```
🚀 認証の初期化を開始...
✅ Shopifyセッショントークンを取得しました
✅ ApiClientが準備完了、サブスクリプションデータを取得します
```

### 2. バックエンドのログ確認

**確認項目**:
- `/api/shopify/install`へのリクエスト
- `/api/shopify/callback`へのリクエスト
- `SaveOrUpdateStore`の実行
- エラーログ

**期待されるログ**:
```
===== OAuth Install 開始 ===== Shop: xxx.myshopify.com
OAuthコールバック受信. Shop: xxx.myshopify.com
OAuth認証完了. Shop: xxx.myshopify.com, StoreId: X
```

### 3. ネットワークタブの確認

**確認項目**:
- `/api/shopify/install`へのリクエスト
- Shopify OAuth認証画面へのリダイレクト
- `/api/shopify/callback`へのリクエスト（フロントエンド経由）
- `/api/store`、`/api/subscription/status`へのリクエストとそのステータスコード

## 修正内容

### 修正1: SubscriptionProviderの条件を修正 ✅ 適用済み

**問題**: `/`ページでもAPIを呼び出してしまう

**修正**:
```typescript
// frontend/src/contexts/SubscriptionContext.tsx
// インストールページまたはルートページではAPIを呼び出さない（認証が必要なAPIを呼び出すと401エラーが発生するため）
// ルートページ（/）は認証状態を確認中で、認証が完了していない可能性があるため
const isInstallPage = pathname === '/install';
const isRootPage = pathname === '/';

useEffect(() => {
  if (isInstallPage || isRootPage) {
    console.log('⏸️ インストールページまたはルートページのため、サブスクリプションデータの取得をスキップします', { pathname, isInstallPage, isRootPage });
    setLoading(false);
    return;
  }
  
  // ...
}, [isApiClientReady, fetchSubscriptionData, fetchSelectedFeature, isInstallPage, isRootPage, pathname])
```

**修正日**: 2025-12-25

### 修正案2: AuthProviderの初期化完了を確実にする

**問題**: `isInitializing`が`true`のままになっている可能性

**修正**:
- `isInitializing`を`false`に設定するタイミングを確認
- エラーハンドリングを追加

### 修正案3: ルートページのリダイレクトロジックを改善

**問題**: 認証状態のチェックが完了しない

**修正**:
- タイムアウトを追加（既に実装済み）
- エラーハンドリングを改善

## 次のステップ

1. **フロントエンドのログを詳細に確認**
   - `AuthProvider`の初期化ログ
   - `SubscriptionProvider`のAPI呼び出しタイミング
   - `isInitializing`、`isApiClientReady`、`isAuthenticated`の値

2. **バックエンドのログを確認**
   - `/api/shopify/install`へのリクエスト
   - `/api/shopify/callback`へのリクエスト
   - `SaveOrUpdateStore`の実行

3. **ネットワークタブでリクエストフローを確認**
   - OAuth認証フローが正しく実行されているか
   - コールバックが到達しているか

4. **修正案を適用**
   - 最も可能性の高い修正案から順に適用
   - 各修正後に動作確認

## 参考資料

- [Shopify OAuth認証フロー](https://shopify.dev/docs/apps/build/authentication-authorization/access-tokens/authorization-code-grant)
- [Shopify埋め込みアプリの認証](https://shopify.dev/docs/apps/build/authentication-authorization/access-tokens/authorization-code-grant#embedded-apps)
- フロントエンド実装: `frontend/src/app/page.tsx`
- バックエンド実装: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`
