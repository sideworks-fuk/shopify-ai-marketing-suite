# 404エラー - 処理中画面で止まる問題 確認事項

## 作成日
2025-12-28

## 目的
「処理中...」画面で止まる問題の原因を特定するための確認事項を整理する。

---

## ✅ 確認済み事項

### OAuth認証の成功
- ✅ Storesテーブルにレコードが登録されている
- ✅ OAuthコールバックが正常に完了している

### 画面の状態
- ✅ 「処理中...」画面が表示されている
- ✅ 「ストア情報を更新しています...」というメッセージが表示されている

### コンソールログ
- ✅ 多数のAPIリクエストが成功している（status 200）
- ✅ `Session token retrieved successfully`が表示されている

---

## 🔍 確認すべき事項

### 1. `/auth/success`ページのコンソールログを確認（最優先）

**目的**: 処理がどこで止まっているか確認

**確認方法**:
1. ブラウザのコンソールで`/auth/success`ページのログを確認
2. 以下のログが出力されているか確認：

**期待されるログの順序**:
1. `🔐 認証コールバック受信:`
2. `✅ ストア一覧の更新に成功` または `⚠️ ストア一覧の更新に失敗しましたが、続行します:`
3. `📋 クエリパラメータからStoreIdを取得:` または `🔍 shopドメインからStoreIdを検索:`
4. `✅ 認証状態を設定しました:`
5. `🆕 OAuth認証完了: データ同期設定画面にリダイレクト`
6. `🔄 リダイレクト先:`

**確認ポイント**:
- [ ] どのログまで出力されているか
- [ ] エラーログがないか
- [ ] タイムアウトエラーがないか
- [ ] `storeId`が取得できているか

---

### 2. `storeId`の取得を確認

**目的**: `storeId`が正しく取得できているか確認

**確認方法**:
1. コンソールログで`storeId`の取得ログを確認
2. クエリパラメータに`storeId`が含まれているか確認
3. URLを確認: `/auth/success?shop=...&storeId=...&success=true&host=...`

**期待されるログ**:
```
📋 クエリパラメータからStoreIdを取得: {storeId}
```

または

```
🔍 shopドメインからStoreIdを検索: { shop, storeId }
```

**確認ポイント**:
- [ ] `storeId`が取得できているか
- [ ] `storeId`が正しい値か（数値）
- [ ] `storeId`が`null`や`undefined`でないか

---

### 3. リダイレクト処理を確認

**目的**: リダイレクト処理が正常に実行されているか確認

**確認方法**:
1. コンソールログでリダイレクトのログを確認
2. `router.replace()`が実行されているか確認
3. エラーログがないか確認

**期待されるログ**:
```
🆕 OAuth認証完了: データ同期設定画面にリダイレクト
🔄 リダイレクト先: /setup/initial?shop=...&host=...&embedded=...
```

**確認ポイント**:
- [ ] リダイレクトのログが出力されているか
- [ ] `router.replace()`が実行されているか
- [ ] エラーログがないか
- [ ] リダイレクト先のURLが正しいか

---

### 4. `refreshStores()`の完了を確認

**目的**: `refreshStores()`が正常に完了しているか確認

**確認方法**:
1. コンソールログで`refreshStores()`のログを確認
2. タイムアウトエラーのログを確認
3. `✅ ストア一覧の更新に成功`のログを確認

**期待されるログ**:
```
✅ ストア一覧の更新に成功
```

または

```
⚠️ ストア一覧の更新に失敗しましたが、続行します: ...
```

**確認ポイント**:
- [ ] `refreshStores()`が完了しているか
- [ ] タイムアウトエラーがないか
- [ ] エラーログがないか

---

### 5. `setCurrentStore()`と`markAuthenticated()`の実行を確認

**目的**: 認証状態の設定が正常に実行されているか確認

**確認方法**:
1. コンソールログで`✅ 認証状態を設定しました:`のログを確認
2. エラーログがないか確認

**期待されるログ**:
```
✅ 認証状態を設定しました: { storeId, shop, host }
```

**確認ポイント**:
- [ ] `setCurrentStore()`が実行されているか
- [ ] `markAuthenticated()`が実行されているか
- [ ] エラーログがないか

---

## 🚨 考えられる原因

### 原因1: `refreshStores()`がタイムアウトしている

**症状**: 
- `refreshStores()`が5秒以内に完了しない
- タイムアウトエラーが発生しているが、処理が続行されていない

**確認方法**:
- コンソールログでタイムアウトエラーのログを確認
- `⚠️ ストア一覧の更新に失敗しましたが、続行します:`のログを確認

**解決策**:
- タイムアウト時間を調整
- タイムアウト後の処理を改善

---

### 原因2: `storeId`が取得できていない

**症状**: 
- `storeId`が取得できず、エラーが発生している
- `setCurrentStore()`や`markAuthenticated()`が実行されていない

**確認方法**:
- コンソールログで`storeId`の取得ログを確認
- クエリパラメータに`storeId`が含まれているか確認

**解決策**:
- バックエンドの`BuildRedirectUrlAsync`で`storeId`を確実に含める
- フォールバック処理を改善

---

### 原因3: リダイレクトが発生していない

**症状**: 
- リダイレクトのタイムアウト（1秒）が実行されていない
- `router.replace()`が失敗している

**確認方法**:
- コンソールログでリダイレクトのログを確認
- `router.replace()`のエラーログを確認

**解決策**:
- リダイレクト処理を改善
- エラーハンドリングを追加

---

## 📋 確認チェックリスト

### コンソールログの確認
- [ ] `🔐 認証コールバック受信:`のログがあるか
- [ ] `✅ ストア一覧の更新に成功`のログがあるか
- [ ] `📋 クエリパラメータからStoreIdを取得:`のログがあるか
- [ ] `✅ 認証状態を設定しました:`のログがあるか
- [ ] `🆕 OAuth認証完了: データ同期設定画面にリダイレクト`のログがあるか
- [ ] `🔄 リダイレクト先:`のログがあるか
- [ ] エラーログがないか

### storeIdの確認
- [ ] `storeId`が取得できているか
- [ ] `storeId`が正しい値か（数値）
- [ ] `storeId`が`null`や`undefined`でないか
- [ ] クエリパラメータに`storeId`が含まれているか

### リダイレクト処理の確認
- [ ] リダイレクトのログが出力されているか
- [ ] `router.replace()`が実行されているか
- [ ] エラーログがないか
- [ ] リダイレクト先のURLが正しいか

---

## 参考資料

- [処理中画面で止まる問題調査](./404エラー-処理中画面で止まる問題調査.md)
- [ExitIframeログ分析結果](./404エラー-ExitIframeログ分析結果.md)
- [OAuthコールバック未実行-ログ分析結果](./404エラー-OAuthコールバック未実行-ログ分析結果.md)

---

## 更新履歴

- 2025-12-28: 初版作成（確認事項の整理）
