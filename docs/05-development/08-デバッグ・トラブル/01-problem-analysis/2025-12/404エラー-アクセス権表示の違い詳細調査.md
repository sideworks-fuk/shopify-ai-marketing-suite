# 404エラー - アクセス権表示の違い詳細調査

## 作成日
2025-12-28

## 目的
検証環境と本番環境で、設定は同じなのに「すべての注文詳細」の表示が異なる原因を調査する。

---

## 問題の概要

### 観察された違い

**検証環境（ECレンジャー(local)）:**
- **表示**: "すべての注文詳細" ✅ 表示される
- **アプリ組織**: FUK
- **インストール先**: FUK管理アプリにFUKのストアインストール

**本番環境（EC Ranger-xn-fbkq6e5da0fpb）:**
- **表示**: "すべての注文詳細" ❌ 表示されない
- **アプリ組織**: アクセスネット
- **インストール先**: アクセスネット管理アプリにFUKのストアインストール

### 共通点

- ✅ Shopify管理メニューではどちらも「すべての注文範囲を読み込む」申請済み
- ✅ ShopifyAppsテーブルはどちらも`read_all_orders,read_customers,read_orders,read_products`
- ✅ appsettingsはどちらも`"Scopes": "read_orders,read_products,read_customers"`

---

## 調査項目

### 1. Shopify Partner Dashboardでの設定確認

#### 検証環境（ECレンジャー(local)）
- **アプリ組織**: FUK
- **Settings > Access > Scopes**: `read_customers,read_orders,read_products`
- **Settings > Access > Optional scopes**: **未設定** ✅ 確認済み
- **API Access Request > すべての注文範囲を読み込む**: 申請済み ✅
- **表示**: "すべての注文詳細" ✅ 表示される

#### 本番環境（EC Ranger-xn-fbkq6e5da0fpb）
- **アプリ組織**: アクセスネット
- **Settings > Access > Scopes**: `read_customers,read_orders,read_products`
- **Settings > Access > Optional scopes**: **未設定** ✅ 確認済み
- **API Access Request > すべての注文範囲を読み込む**: 申請済み ✅
- **表示**: "すべての注文詳細" ❌ 表示されない

**確認結果**:
- ✅ 検証環境のOptional scopes: **未設定**
- ✅ 本番環境のOptional scopes: **未設定**
- ✅ 両環境でOptional scopesの設定は一致している
- ⚠️ **しかし、表示は異なる** → 別の原因がある可能性

---

### 2. OAuthフローでの実際のリクエスト確認

#### コード実装
```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs (188行目)
var scopes = GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
_logger.LogInformation("OAuth scopes: {Scopes}", scopes);

var authUrl = $"https://{shop}/admin/oauth/authorize" +
    $"?client_id={finalApiKey}" +
    $"&scope={scopes}" +
    $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
    $"&state={state}";
```

**確認ポイント**:
- [ ] 検証環境のOAuth URLに`read_all_orders`が含まれているか（ログから確認）
- [ ] 本番環境のOAuth URLに`read_all_orders`が含まれているか（ログから確認）
- [ ] 両環境でリクエストされるスコープが一致しているか

**注意**: `appsettings.json`の設定が同じでも、環境変数で上書きされている可能性がある

---

### 3. 環境変数の確認

#### 検証環境（Development）
- **Azure App Service環境変数**: `SHOPIFY_SCOPES`が設定されているか確認
- **GitHub Actions環境変数**: 設定されているか確認

#### 本番環境（Production）
- **Azure App Service環境変数**: `SHOPIFY_SCOPES`が設定されているか確認
- **GitHub Actions環境変数**: 設定されているか確認

**確認ポイント**:
- [ ] 検証環境の環境変数に`read_all_orders`が含まれているか
- [ ] 本番環境の環境変数に`read_all_orders`が含まれているか
- [ ] 環境変数が`appsettings.json`を上書きしているか

---

### 4. Shopify側の承認状態の確認

#### 考えられる原因

**アプリの組織が異なることによる影響**:
- **検証環境**: FUK管理アプリ → FUKのストアインストール
- **本番環境**: アクセスネット管理アプリ → FUKのストアインストール

**可能性**:
1. **Shopify側の承認プロセス**: アプリの組織が異なるため、Shopify側での承認状態が異なる可能性
2. **スコープの表示ロジック**: Shopifyがアプリの組織や申請状態に基づいて表示を制御している可能性
3. **キャッシュ**: Shopify側のキャッシュが異なる可能性

**確認ポイント**:
- [ ] 検証環境のアプリで「すべての注文範囲を読み込む」が承認されているか
- [ ] 本番環境のアプリで「すべての注文範囲を読み込む」が承認されているか
- [ ] 両環境で承認状態が一致しているか

---

### 5. インストール画面の表示ロジック

#### Shopifyの表示ロジック（推測）

Shopifyのインストール画面では、以下の情報に基づいて表示される可能性がある：

1. **Shopify Partner Dashboardで設定したスコープ**:
   - Settings > Access > Scopes
   - Settings > Access > Optional scopes
   - API Access Requestでの申請状態

2. **OAuthフローでリクエストされるスコープ**:
   - OAuth URLの`scope`パラメータ
   - 実際にリクエストされるスコープ

3. **アプリの承認状態**:
   - 「すべての注文範囲を読み込む」の承認状態
   - アプリの組織や申請履歴

**考えられる不一致の原因**:
- **検証環境**: Optional scopesに`read_all_orders`が設定されている + 申請済み → 表示される
- **本番環境**: Optional scopesに`read_all_orders`が設定されていない、または承認状態が異なる → 表示されない

---

## 調査手順

### ステップ1: Shopify Partner Dashboardの設定確認

1. **検証環境（ECレンジャー(local)）の確認**:
   - [ ] Settings > Access > Scopesを確認
   - [ ] Settings > Access > Optional scopesを確認
   - [ ] `read_all_orders`が含まれているか確認

2. **本番環境（EC Ranger-xn-fbkq6e5da0fpb）の確認**:
   - [ ] Settings > Access > Scopesを確認
   - [ ] Settings > Access > Optional scopesを確認
   - [ ] `read_all_orders`が含まれているか確認

3. **比較**:
   - [ ] 両環境で設定が一致しているか確認
   - [ ] 不一致があれば記録

---

### ステップ2: OAuthフローのログ確認

1. **検証環境のログ確認**:
   - [ ] OAuth URL生成時のログを確認
   - [ ] `OAuth scopes: {Scopes}`のログを確認
   - [ ] 実際にリクエストされるスコープを確認

2. **本番環境のログ確認**:
   - [ ] OAuth URL生成時のログを確認
   - [ ] `OAuth scopes: {Scopes}`のログを確認
   - [ ] 実際にリクエストされるスコープを確認

3. **比較**:
   - [ ] 両環境でリクエストされるスコープが一致しているか確認
   - [ ] 不一致があれば記録

---

### ステップ3: 環境変数の確認

1. **検証環境の環境変数確認**:
   - [ ] Azure App Serviceの環境変数を確認
   - [ ] `SHOPIFY_SCOPES`が設定されているか確認
   - [ ] 設定値に`read_all_orders`が含まれているか確認

2. **本番環境の環境変数確認**:
   - [ ] Azure App Serviceの環境変数を確認
   - [ ] `SHOPIFY_SCOPES`が設定されているか確認
   - [ ] 設定値に`read_all_orders`が含まれているか確認

3. **比較**:
   - [ ] 両環境で環境変数が一致しているか確認
   - [ ] 不一致があれば記録

---

### ステップ4: Shopify側の承認状態確認

1. **検証環境の承認状態確認**:
   - [ ] API Access Request > すべての注文範囲を読み込むの承認状態を確認
   - [ ] 承認日時を確認

2. **本番環境の承認状態確認**:
   - [ ] API Access Request > すべての注文範囲を読み込むの承認状態を確認
   - [ ] 承認日時を確認

3. **比較**:
   - [ ] 両環境で承認状態が一致しているか確認
   - [ ] 不一致があれば記録

---

## 考えられる原因

### 原因1: Optional scopesの設定の違い ❌ 該当なし

**確認結果**: 
- ✅ 検証環境のOptional scopes: **未設定**
- ✅ 本番環境のOptional scopes: **未設定**
- ✅ 両環境で設定は一致している

**結論**: Optional scopesの設定の違いは原因ではない

---

### 原因2: 環境変数による上書き

**仮説**: 
- 検証環境の環境変数に`read_all_orders`が含まれている
- 本番環境の環境変数に`read_all_orders`が含まれていない

**確認方法**: Azure App Serviceの環境変数を確認

**解決策**: 本番環境の環境変数に`read_all_orders`を追加、または`appsettings.json`を更新

---

### 原因3: Shopify側の承認状態の違い

**仮説**: 
- 検証環境で「すべての注文範囲を読み込む」が承認されている
- 本番環境で「すべての注文範囲を読み込む」が承認されていない、または承認プロセスが異なる

**確認方法**: API Access Requestの承認状態を確認

**解決策**: 本番環境で「すべての注文範囲を読み込む」を再申請または承認

---

### 原因4: アプリの組織による表示ロジックの違い

**仮説**: 
- アプリの組織が異なるため、Shopify側の表示ロジックが異なる
- FUK管理アプリとアクセスネット管理アプリで、表示条件が異なる

**確認方法**: Shopifyのドキュメントやサポートに確認

**解決策**: Shopifyサポートに問い合わせ

---

## 推奨調査順序

1. ✅ **完了**: Shopify Partner DashboardのOptional scopesの設定を確認 → **両環境とも未設定**
2. **最優先**: OAuthフローのログを確認（実際にリクエストされるスコープ）
   - 検証環境と本番環境で、実際にOAuth URLに含まれるスコープを比較
   - `OAuth scopes: {Scopes}`のログを確認
3. **次に優先**: 環境変数の確認
   - Azure App Serviceの環境変数（`SHOPIFY_SCOPES`）を確認
   - 検証環境と本番環境で環境変数が異なるか確認
4. **承認状態の確認**: API Access Requestの承認状態を確認
   - 検証環境と本番環境で、承認日時や承認状態が異なるか確認
5. **アプリの組織による表示ロジックの違い**: 
   - FUK管理アプリとアクセスネット管理アプリで、Shopify側の表示ロジックが異なる可能性

---

## 参考資料

- [アクセス権表示の違い調査](./404エラー-アクセス権表示の違い調査.md)
- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)
- [ShopifyAppsテーブルScopes影響調査](./404エラー-ShopifyAppsテーブルScopes影響調査.md)
- [Shopify API スコープドキュメント](https://shopify.dev/docs/api/usage/access-scopes)

---

## 更新履歴

- 2025-12-28: 初版作成（アクセス権表示の違い詳細調査）
- 2025-12-28: Optional scopesの確認結果を反映（両環境とも未設定であることを確認）
