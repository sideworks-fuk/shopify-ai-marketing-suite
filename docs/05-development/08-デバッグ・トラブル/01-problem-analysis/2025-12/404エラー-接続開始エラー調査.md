# 404エラー - 接続開始エラー調査

## 作成日
2025-12-28

## 目的
「接続を開始」ボタンをクリックした後、エラーが発生し、Storesテーブルのレコードが作成されない原因を調査する。

---

## 問題の概要

### エラーメッセージ

**フロントエンド**:
- "エラーが発生しました"
- "リダイレクト先が指定されていません。"

**コンソールログ**:
- ExitIframeページURL: `/auth/exit-iframe?redirectUri=...`
- インストール処理が開始されている
- 埋め込みアプリモード: ExitIframeページにリダイレクト

**バックエンド**:
- Storesテーブルのレコードが作成されていない

---

## 調査結果

### 1. ExitIframeページの実装確認

**ファイル**: `frontend/src/app/auth/exit-iframe/page.tsx`

**実装**:
```typescript
const redirectUri = searchParams?.get('redirectUri');

useEffect(() => {
  if (!redirectUri) {
    console.error('❌ [ExitIframe] redirectUriパラメータがありません');
    setError('リダイレクト先が指定されていません。');
    return;
  }
  // ...
}, [app, redirectUri]);
```

**問題の可能性**:
- `searchParams`から`redirectUri`が取得できていない
- `Redirect.toApp()`でリダイレクトする際に、クエリパラメータが失われている可能性

---

### 2. インストールページからのリダイレクト処理

**ファイル**: `frontend/src/app/install/page.tsx` (375行目)

**実装**:
```typescript
const exitIframeUrl = `/auth/exit-iframe?redirectUri=${encodeURIComponent(installUrl)}`;
console.log('🔄 ExitIframeページURL:', exitIframeUrl);
app.dispatch(Redirect.toApp({ path: exitIframeUrl }));
```

**問題の可能性**:
- `Redirect.toApp({ path: exitIframeUrl })`でリダイレクトする際に、クエリパラメータが失われている可能性
- App Bridgeの`Redirect.toApp()`は、パス部分のみを処理し、クエリパラメータを無視する可能性

---

### 3. OAuthコールバック処理の確認

**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`

**処理フロー**:
1. `Callback()`メソッドでOAuthコールバックを受信
2. アクセストークンを取得
3. `ProcessOAuthSuccessAsync()`を呼び出してストア情報を保存
4. `BuildRedirectUrlAsync()`でリダイレクトURLを構築
5. `Redirect()`でリダイレクト

**Storesテーブルへのレコード作成**:
- `ProcessOAuthSuccessAsync()` → `SaveOrUpdateStore()`で実行
- OAuthコールバックが正常に完了していない場合、レコードは作成されない

---

## 考えられる原因

### 原因1: Redirect.toApp()でクエリパラメータが失われる

**仮説**: 
- `Redirect.toApp({ path: exitIframeUrl })`でリダイレクトする際に、クエリパラメータ（`redirectUri`）が失われている
- App Bridgeの`Redirect.toApp()`は、パス部分のみを処理し、クエリパラメータを無視する可能性

**確認方法**: 
- ExitIframeページで`searchParams`をログ出力して確認
- `redirectUri`が取得できているか確認

**解決策**: 
- `Redirect.toApp()`の代わりに、直接`window.location.href`でリダイレクトする
- または、`Redirect.toApp()`のパラメータにクエリパラメータを含める方法を確認

---

### 原因2: OAuthコールバックが正常に完了していない

**仮説**: 
- OAuthコールバックが正常に呼ばれていない
- または、OAuthコールバック処理中にエラーが発生している

**確認方法**: 
- バックエンドのログを確認
- OAuthコールバックが呼ばれているか確認
- `ProcessOAuthSuccessAsync()`が正常に実行されているか確認

**解決策**: 
- バックエンドのログを確認してエラーを特定
- エラーに応じて修正

---

### 原因3: ExitIframeページへのリダイレクト処理の問題

**仮説**: 
- ExitIframeページにリダイレクトする際に、URLが正しく構築されていない
- または、リダイレクト処理が正常に実行されていない

**確認方法**: 
- コンソールログでExitIframeページURLを確認
- 実際にリダイレクトされているか確認

**解決策**: 
- ExitIframeページへのリダイレクト処理を修正

---

## 調査手順

### ステップ1: ExitIframeページでのredirectUri取得確認

**目的**: `redirectUri`パラメータが正しく取得できているか確認

**確認方法**:
1. ExitIframeページにデバッグログを追加
2. `searchParams`の内容をログ出力
3. `redirectUri`が取得できているか確認

**確認ポイント**:
- [ ] `searchParams`が`null`でないか
- [ ] `redirectUri`が取得できているか
- [ ] `redirectUri`の値が正しいか

---

### ステップ2: インストールページからのリダイレクト処理確認

**目的**: `Redirect.toApp()`でリダイレクトする際に、クエリパラメータが失われていないか確認

**確認方法**:
1. インストールページのログを確認
2. `exitIframeUrl`の値を確認
3. `Redirect.toApp()`実行後のURLを確認

**確認ポイント**:
- [ ] `exitIframeUrl`が正しく構築されているか
- [ ] `Redirect.toApp()`実行後、クエリパラメータが保持されているか

---

### ステップ3: OAuthコールバック処理の確認

**目的**: OAuthコールバックが正常に完了しているか確認

**確認方法**:
1. バックエンドのログを確認
2. OAuthコールバックが呼ばれているか確認
3. `ProcessOAuthSuccessAsync()`が正常に実行されているか確認
4. Storesテーブルにレコードが作成されているか確認

**確認ポイント**:
- [ ] OAuthコールバックが呼ばれているか
- [ ] `ProcessOAuthSuccessAsync()`が正常に実行されているか
- [ ] Storesテーブルにレコードが作成されているか

---

## 推奨対応

### 対応1: ExitIframeページのデバッグログ追加

**目的**: `redirectUri`が取得できているか確認

**実施内容**:
```typescript
useEffect(() => {
  console.log('🔍 [ExitIframe] searchParams:', searchParams);
  console.log('🔍 [ExitIframe] redirectUri:', redirectUri);
  console.log('🔍 [ExitIframe] redirectUri type:', typeof redirectUri);
  // ...
}, [app, redirectUri, searchParams]);
```

---

### 対応2: Redirect.toApp()の使用方法の確認

**目的**: クエリパラメータが失われないようにする

**実施内容**:
- Shopify公式ドキュメントで`Redirect.toApp()`の使用方法を確認
- クエリパラメータを含める方法を確認
- 必要に応じて実装を修正

---

### 対応3: バックエンドログの確認

**目的**: OAuthコールバックが正常に完了しているか確認

**実施内容**:
- バックエンドのログを確認
- OAuthコールバックが呼ばれているか確認
- エラーが発生していないか確認

---

## 参考資料

- [動作確認結果](./404エラー-動作確認結果.md)
- [修正作業ログ](./404エラー-修正作業ログ.md)
- [Shopify App Bridge Redirect Documentation](https://shopify.dev/docs/api/app-bridge-library/actions/navigation/redirect)

---

## 更新履歴

- 2025-12-28: 初版作成（接続開始エラー調査）
