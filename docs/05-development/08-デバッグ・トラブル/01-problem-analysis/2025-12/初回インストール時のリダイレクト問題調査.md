# 初回インストール時のリダイレクト問題調査

## 問題の概要

初回インストール時（インストールしていない状況）で、インストールボタンを押した後にリダイレクトが正しく動作しない問題を調査中。

## 期待される動作フロー

1. **ユーザーがインストールボタンを押す**
   - `/install` ページで「接続を開始」ボタンをクリック
   - `/api/shopify/install?shop=...&apiKey=...` にリクエスト

2. **バックエンドがOAuth認証を開始**
   - `ShopifyAuthController.Install` が実行される
   - ShopifyのOAuth認証ページにリダイレクト
   - URL: `https://{shop}/admin/oauth/authorize?client_id=...&scope=...&redirect_uri=...&state=...`

3. **ユーザーが認証を承認**
   - Shopifyの認証ページで「インストール」ボタンをクリック
   - Shopifyが `/api/shopify/callback?code=...&shop=...&state=...` にリダイレクト

4. **バックエンドがOAuthコールバックを処理**
   - `ShopifyAuthController.Callback` が実行される
   - ストア情報をデータベースに保存
   - セッションCookieを設定
   - `/auth/success?shop=...&storeId=...&success=true` にリダイレクト

5. **フロントエンドの `/auth/success` ページで認証状態を設定**
   - `markAuthenticated(storeId)` を呼び出し
   - `localStorage` に `oauth_authenticated` と `currentStoreId` を設定
   - 初期設定状態を確認（`/api/setup/status` を呼び出し）

6. **適切なページにリダイレクト**
   - 初回インストール時（`InitialSetupCompleted = false` または 404）: `/setup/initial` にリダイレクト
   - 既に初期設定が完了している場合: `/customers/dormant` にリダイレクト

## 確認すべきポイント

### 1. インストールボタンを押した後の動作

**ブラウザの開発者ツール（F12）で確認**:

**コンソールタブ**:
- `🚀 Shopify接続開始:` ログが表示されるか
- エラーメッセージが表示されていないか

**ネットワークタブ**:
- `/api/shopify/install` へのリクエストが送信されているか
- ステータスコードは何か（200, 302, 404, 500など）
- リダイレクト先URLは何か

### 2. OAuth認証ページへの遷移

**確認事項**:
- ShopifyのOAuth認証ページが表示されるか
- URLが `https://{shop}/admin/oauth/authorize?client_id=...` になっているか
- 「インストール」ボタンが表示されるか

### 3. OAuth認証後のコールバック処理

**ブラウザの開発者ツール（F12）で確認**:

**ネットワークタブ**:
- `/api/shopify/callback` へのリクエストが送信されているか
- ステータスコードは何か（200, 302, 404, 500など）
- リダイレクト先URLは何か（`/auth/success` になっているか）

**バックエンドログ**（可能であれば）:
- `OAuth認証完了. Shop: {Shop}, StoreId: {StoreId}` ログが表示されるか
- `OAuth認証完了後のリダイレクト: {RedirectUrl}` ログが表示されるか
- エラーログが表示されていないか

### 4. `/auth/success` ページでの処理

**ブラウザの開発者ツール（F12）で確認**:

**コンソールタブ**:
- `🔐 認証コールバック受信:` ログが表示されるか
- `✅ 認証状態を設定しました:` ログが表示されるか
- `🆕 初回インストール:` ログが表示されるか
- エラーメッセージが表示されていないか

**Applicationタブ（Local Storage）**:
- `oauth_authenticated`: `true` になっているか
- `currentStoreId`: 数値が設定されているか
- `shopDomain`: ストアドメインが設定されているか

**ネットワークタブ**:
- `/api/setup/status` へのリクエストが送信されているか
- ステータスコードは何か（200, 404, 401など）
- レスポンス内容は何か

### 5. 最終的なリダイレクト先

**確認事項**:
- `/setup/initial` にリダイレクトされるか
- または `/customers/dormant` にリダイレクトされるか
- リダイレクトが発生しない場合、どのページに留まっているか

## トラブルシューティング

### 問題1: インストールボタンを押しても何も起こらない

**確認事項**:
- ブラウザのコンソールにエラーが表示されていないか
- ネットワークタブで `/api/shopify/install` へのリクエストが送信されているか
- `/install` ページの `handleInstall` 関数が正しく実行されているか

**対処法**:
- `/install` ページのコンソールログを確認
- ネットワークタブでリクエストの詳細を確認
- バックエンドのログを確認（可能であれば）

### 問題2: OAuth認証ページに遷移しない

**確認事項**:
- `/api/shopify/install` のレスポンスが302リダイレクトになっているか
- リダイレクト先URLが正しいか
- Shopify Partners Dashboardの設定（App URL、Redirect URLs）が正しいか

**対処法**:
- バックエンドの `ShopifyAuthController.Install` メソッドのログを確認
- Shopify Partners Dashboardの設定を確認
- `ShopifyApps` テーブルの `AppUrl` と `RedirectUri` を確認

### 問題3: `/auth/success` ページに到達しない

**確認事項**:
- `/api/shopify/callback` のレスポンスが302リダイレクトになっているか
- リダイレクト先URLが `/auth/success` になっているか
- バックエンドでエラーが発生していないか

**対処法**:
- バックエンドの `ShopifyAuthController.Callback` メソッドのログを確認
- `GetShopifyAppUrlAsync` メソッドが正しいAppURLを返しているか確認
- `ShopifyApps` テーブルの `AppUrl` を確認

### 問題4: `/auth/success` ページで認証状態が設定されない

**確認事項**:
- `markAuthenticated` が呼び出されているか
- `localStorage` に `oauth_authenticated` と `currentStoreId` が設定されているか
- `AuthProvider` の `authMode` が正しく設定されているか

**対処法**:
- `/auth/success` ページのコンソールログを確認
- `AuthProvider.tsx` の `initializeAuth` 関数のログを確認
- `localStorage` の内容を確認

### 問題5: `/setup/initial` にリダイレクトされない

**確認事項**:
- `/api/setup/status` のレスポンスが404または `initialSetupCompleted: false` になっているか
- エラーハンドリングが正しく動作しているか

**対処法**:
- `/auth/success` ページのコンソールログを確認
- `/api/setup/status` のレスポンスを確認
- エラーハンドリングのロジックを確認

## 関連ファイル

- `frontend/src/app/install/page.tsx` - インストールページ
- `frontend/src/app/auth/success/page.tsx` - OAuth認証成功ページ
- `frontend/src/components/providers/AuthProvider.tsx` - 認証プロバイダー
- `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs` - OAuth認証コントローラー
- `backend/ShopifyAnalyticsApi/Controllers/SetupController.cs` - 初期設定コントローラー

## 次のステップ

1. インストールボタンを押した後、上記の確認ポイントを順番に確認
2. 問題が発生している箇所を特定
3. 該当するファイルのログを確認
4. 必要に応じて修正を実施

