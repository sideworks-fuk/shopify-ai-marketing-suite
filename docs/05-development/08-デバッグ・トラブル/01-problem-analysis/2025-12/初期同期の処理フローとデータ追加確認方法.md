# 初期同期の処理フローとデータ追加確認方法

## 初期同期の処理フロー

### 実行順序

初期同期（`/api/sync/initial`）が実行されると、以下の順序でデータが同期されます：

1. **顧客データ同期** (`ShopifyCustomerSyncJob.SyncCustomers`)
   - Shopify APIから顧客データを取得
   - `Customers`テーブルに追加または更新
   - `CurrentTask = "顧客データ取得中"` → `"顧客データ同期完了"`

2. **商品データ同期** (`ShopifyProductSyncJob.SyncProducts`)
   - Shopify APIから商品データを取得
   - `Products`テーブルに追加または更新
   - `CurrentTask = "商品データ取得中"` → `"商品データ同期完了"`

3. **注文データ同期** (`ShopifyOrderSyncJob.SyncOrders`)
   - Shopify APIから注文データを取得
   - `Orders`テーブルに追加または更新
   - `OrderItems`テーブルにも関連データが追加される
   - `CurrentTask = "注文データ取得中"` → `"全データ同期完了"`

### データ追加の仕組み

**Customersテーブル**:
- `SaveOrUpdateCustomersBatch` メソッドで、バッチ単位でデータを保存
- 既存の顧客（`ShopifyCustomerId`が一致）は更新
- 新規の顧客は追加（`_context.Customers.Add(customer)`）

**Productsテーブル**:
- 同様に、既存の商品は更新、新規の商品は追加

**Ordersテーブル**:
- 同様に、既存の注文は更新、新規の注文は追加
- `OrderItems`テーブルにも関連データが追加される

## 進捗確認方法

### 1. SyncStatusesテーブルで確認

**確認クエリ**:
```sql
-- 実行中の同期ステータスを確認
SELECT 
    Id,
    StoreId,
    SyncType,
    Status,
    StartDate,
    EndDate,
    CurrentTask,
    ProcessedRecords,
    TotalRecords,
    ErrorMessage,
    CreatedAt,
    UpdatedAt
FROM SyncStatuses
WHERE Status = 'running'
ORDER BY CreatedAt DESC;
```

**確認項目**:
- `Status`: `running` の場合、同期が実行中
- `CurrentTask`: 現在処理中のタスク（例：`顧客データ取得中`、`商品データ取得中`、`注文データ取得中`）
- `ProcessedRecords`: 処理済みレコード数
- `TotalRecords`: 総レコード数（完了時に設定される）

### 2. 各テーブルのレコード数を確認

**確認クエリ**:
```sql
-- StoreId=5の場合の例
DECLARE @StoreId INT = 5;

-- 顧客数
SELECT COUNT(*) AS CustomerCount
FROM Customers
WHERE StoreId = @StoreId;

-- 商品数
SELECT COUNT(*) AS ProductCount
FROM Products
WHERE StoreId = @StoreId;

-- 注文数
SELECT COUNT(*) AS OrderCount
FROM Orders
WHERE StoreId = @StoreId;

-- 注文明細数
SELECT COUNT(*) AS OrderItemCount
FROM OrderItems oi
INNER JOIN Orders o ON oi.OrderId = o.Id
WHERE o.StoreId = @StoreId;
```

### 3. リアルタイムでレコード追加を確認

**確認クエリ**（定期的に実行）:
```sql
-- 最新の顧客レコードを確認
SELECT TOP 10
    Id,
    ShopifyCustomerId,
    Email,
    FirstName,
    LastName,
    CreatedAt,
    UpdatedAt
FROM Customers
WHERE StoreId = 5
ORDER BY CreatedAt DESC;

-- 最新の商品レコードを確認
SELECT TOP 10
    Id,
    ShopifyProductId,
    Title,
    CreatedAt,
    UpdatedAt
FROM Products
WHERE StoreId = 5
ORDER BY CreatedAt DESC;

-- 最新の注文レコードを確認
SELECT TOP 10
    Id,
    ShopifyOrderId,
    Email,
    TotalPrice,
    CreatedAt,
    UpdatedAt
FROM Orders
WHERE StoreId = 5
ORDER BY CreatedAt DESC;
```

## 期待される動作

### 正常な場合

1. **SyncStatusesテーブル**:
   - `Status = "running"` のレコードが作成される
   - `CurrentTask` が順次更新される（`顧客データ取得中` → `商品データ取得中` → `注文データ取得中` → `全データ同期完了`）
   - `ProcessedRecords` が増加する

2. **Customersテーブル**:
   - 顧客データ同期中にレコードが追加される
   - `StoreId` が一致するレコードが増加する

3. **Productsテーブル**:
   - 商品データ同期中にレコードが追加される
   - `StoreId` が一致するレコードが増加する

4. **Ordersテーブル**:
   - 注文データ同期中にレコードが追加される
   - `StoreId` が一致するレコードが増加する
   - `OrderItems`テーブルにも関連データが追加される

### 完了時

- `SyncStatuses.Status = "completed"`
- `SyncStatuses.EndDate` が設定される
- `SyncStatuses.ProcessedRecords` と `SyncStatuses.TotalRecords` が一致する

## トラブルシューティング

### レコードが追加されない場合

1. **エラーログを確認**:
   - バックエンドアプリケーションのログでエラーを確認
   - `SyncStatuses.ErrorMessage` を確認

2. **Shopify API接続を確認**:
   - Shopify APIの認証情報が正しいか
   - APIレート制限に達していないか

3. **データ範囲を確認**:
   - `InitialSyncOptions` の `StartDate` と `EndDate` が適切か
   - 指定した期間にデータが存在するか

## 関連ファイル

- `backend/ShopifyAnalyticsApi/Services/ShopifyDataSyncService.cs` - 初期同期サービス
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyCustomerSyncJob.cs` - 顧客同期ジョブ
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyProductSyncJob.cs` - 商品同期ジョブ
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyOrderSyncJob.cs` - 注文同期ジョブ

## 更新履歴

- 2025-12-25: 初版作成（福田 + AI Assistant）
