# バックエンド起動エラー調査

## 問題

バックエンドがエラーで起動しない。データ同期のリリースの影響の可能性がある。

## 確認手順

### ステップ1: バックエンドのログを確認

**Azure App Serviceの場合**:
1. Azure PortalでApp Serviceを開く
2. 「監視」→「ログストリーム」を開く
3. エラーメッセージを確認

**ローカル開発環境の場合**:
1. ターミナルでバックエンドを起動
2. エラーメッセージを確認

### ステップ2: よくある起動エラーの原因

#### 1. 依存関係の注入エラー

**症状**:
```
System.InvalidOperationException: Unable to resolve service for type 'X' while attempting to activate 'Y'.
```

**原因**:
- サービスが `Program.cs` に登録されていない
- 依存関係の循環参照
- スコープの不一致

**確認ポイント**:
- `Program.cs` のサービス登録（189-196行目）を確認
- データ同期関連のサービスが正しく登録されているか確認

#### 2. データベース接続エラー

**症状**:
```
System.InvalidOperationException: An exception has been raised that is likely due to a transient failure.
```

**原因**:
- 接続文字列が間違っている
- データベースが起動していない
- ファイアウォール設定の問題

**確認ポイント**:
- `appsettings.json` の `ConnectionStrings:DefaultConnection` を確認
- Azure SQL Databaseの接続設定を確認

#### 3. HangFireの設定エラー

**症状**:
```
Hangfire.SqlServer.SqlServerStorageException: ...
```

**原因**:
- HangFireのデータベース接続エラー
- マイグレーションが実行されていない

**確認ポイント**:
- HangFireのデータベーステーブルが作成されているか確認
- 接続文字列が正しいか確認

#### 4. 必須設定の不足

**症状**:
```
System.InvalidOperationException: SECURITY: Production environment must use OAuthRequired mode...
```

**原因**:
- 本番環境で必須設定が不足している
- 環境変数が設定されていない

**確認ポイント**:
- `appsettings.json` または環境変数の設定を確認
- 本番環境の必須設定を確認

### ステップ3: データ同期関連のサービス登録を確認

`Program.cs` の以下のサービス登録を確認：

```csharp
// Register Sync Management Services (同期管理サービス)
builder.Services.AddScoped<ShopifyAnalyticsApi.Services.Sync.ICheckpointManager, ShopifyAnalyticsApi.Services.Sync.CheckpointManager>();
builder.Services.AddScoped<ShopifyAnalyticsApi.Services.Sync.ISyncRangeManager, ShopifyAnalyticsApi.Services.Sync.SyncRangeManager>();
builder.Services.AddScoped<ShopifyAnalyticsApi.Services.Sync.ISyncProgressTracker, ShopifyAnalyticsApi.Services.Sync.SyncProgressTracker>();

// Register Shopify Sync Jobs (Shopify同期ジョブ)
builder.Services.AddScoped<ShopifyAnalyticsApi.Jobs.ShopifyProductSyncJob>();
builder.Services.AddScoped<ShopifyAnalyticsApi.Jobs.ShopifyCustomerSyncJob>();
builder.Services.AddScoped<ShopifyAnalyticsApi.Jobs.ShopifyOrderSyncJob>();
```

**確認ポイント**:
- 各サービスのコンストラクタの依存関係が正しく登録されているか
- `ShopifyApiService` が登録されているか（182行目）
- `ShopifyDataSyncService` が登録されているか（183行目）

### ステップ4: 依存関係の確認

各ジョブクラスのコンストラクタを確認：

1. **ShopifyProductSyncJob**
2. **ShopifyCustomerSyncJob**
3. **ShopifyOrderSyncJob**

これらのクラスが依存しているサービスが `Program.cs` に登録されているか確認。

### ステップ5: ビルドエラーの確認

**確認方法**:
```powershell
cd backend/ShopifyAnalyticsApi
dotnet build
```

**確認ポイント**:
- コンパイルエラーがないか
- 参照エラーがないか
- NuGetパッケージが正しくインストールされているか

## トラブルシューティング

### 問題1: 依存関係の注入エラー

**対処法**:
1. エラーメッセージから不足しているサービスを特定
2. `Program.cs` にサービス登録を追加
3. 依存関係の循環参照がないか確認

### 問題2: データベース接続エラー

**対処法**:
1. 接続文字列を確認
2. Azure SQL Databaseのファイアウォール設定を確認
3. データベースが起動しているか確認

### 問題3: HangFireの設定エラー

**対処法**:
1. HangFireのデータベーステーブルを作成
2. 接続文字列を確認
3. マイグレーションを実行

### 問題4: 必須設定の不足

**対処法**:
1. `appsettings.json` または環境変数を確認
2. 本番環境の必須設定を追加
3. 設定値が正しいか確認

## 次のステップ

1. バックエンドのログを確認してエラーメッセージを特定
2. エラーメッセージに基づいて上記のトラブルシューティングを実施
3. 問題が解決しない場合は、エラーメッセージの詳細を共有

