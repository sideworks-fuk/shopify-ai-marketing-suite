# インストールフロー問題の詳細デバッグ手順

## 現在の状況

- `localStorage.getItem('oauth_debug_info')` → `null`
- `sessionStorage.getItem('shopify_host')` → `null`
- インストールボタンクリック後、「処理中」から進まない
- OAuth認証画面が表示されない

## デバッグ手順

### ステップ1: インストールボタンクリック前の状態確認

ブラウザのコンソール（F12 → Consoleタブ）で以下を実行：

```javascript
// 現在の状態を確認
console.log('=== インストール前の状態確認 ===');
console.log('現在のURL:', window.location.href);
console.log('現在のパス:', window.location.pathname);
console.log('shopDomain:', document.querySelector('input[type="text"]')?.value);
console.log('localStorage oauth_debug_info:', localStorage.getItem('oauth_debug_info'));
console.log('sessionStorage shopify_host:', sessionStorage.getItem('shopify_host'));
console.log('================================');
```

### ステップ2: インストールボタンクリック後のログ確認

「接続を開始」ボタンをクリック後、以下のログが表示されるか確認：

**期待されるログ（順番に表示されるはず）**:
1. `🚀 Shopify接続開始: [shop-domain]`
2. `🔍 OAuth URL取得開始: [api-url]`
3. `✅ OAuth URL取得成功: [auth-url]...`
4. `🔍 ===== OAuth開始デバッグ情報 =====`
5. `💾 デバッグ情報をlocalStorageに保存しました`
6. `🔄 ===== リダイレクト実行開始 =====`
7. `✅ window.location.replace()実行完了`

**確認ポイント**:
- どのログまで表示されているか
- エラーログ（`❌`で始まるログ）が表示されているか
- ログが途中で止まっているか

### ステップ3: ネットワークタブの確認

1. ブラウザの開発者ツールを開く（F12）
2. Networkタブを開く
3. 「接続を開始」ボタンをクリック
4. 以下のリクエストを探す：

**`/api/shopify/install-url`**
- リクエストURLを確認
- ステータスコード（200 OKか、それ以外か）
- レスポンスボディ（`authUrl`が含まれているか）
- エラーレスポンスが返されているか

**確認ポイント**:
- リクエストが送信されているか
- リクエストが成功しているか（200 OK）
- レスポンスに`authUrl`が含まれているか
- タイムアウトしていないか（10秒以上かかっているか）

### ステップ4: エラーメッセージの確認

コンソールタブで以下を確認：

1. **エラーログ（赤色）**:
   - `❌ 接続エラー:`
   - `❌ OAuth URL取得失敗:`
   - `❌ リダイレクト実行中にエラーが発生:`

2. **警告ログ（黄色）**:
   - `⚠️`で始まるログ

3. **エラーメッセージの内容**:
   - エラーメッセージの全文をコピー

### ステップ5: ページの状態確認

コンソールで以下を実行：

```javascript
// ページの状態を確認
console.log('=== ページの状態確認 ===');
console.log('loading状態:', document.querySelector('button[type="button"]')?.getAttribute('aria-busy'));
console.log('エラーメッセージ:', document.querySelector('[role="alert"]')?.textContent);
console.log('プログレスバー:', document.querySelector('progress')?.value);
console.log('========================');
```

### ステップ6: バックエンドログの確認

Azure App ServiceのログストリームまたはApplication Insightsで以下を確認：

**期待されるログ**:
```
[INFO] 🔍 ===== OAuth URL取得リクエスト受信 ===== 
[INFO] 📍 Shop: [shop-domain]
[INFO] 🔑 ApiKey: [api-key]
[INFO] ✅ OAuth URL生成成功. Shop: [shop], AuthUrl: [auth-url]
```

**確認ポイント**:
- リクエストがバックエンドに到達しているか
- OAuth URL生成が成功しているか
- エラーログが出力されているか

## 問題の切り分け

### パターン1: インストールボタンがクリックされていない

**症状**: コンソールに`🚀 Shopify接続開始`のログが表示されない

**原因**: 
- ボタンのクリックイベントが発火していない
- ボタンが無効化されている

**確認方法**:
```javascript
// ボタンの状態を確認
const button = document.querySelector('button[type="button"]');
console.log('ボタンの状態:', {
  disabled: button?.disabled,
  text: button?.textContent,
  loading: button?.getAttribute('aria-busy')
});
```

### パターン2: OAuth URL取得が失敗している

**症状**: `🔍 OAuth URL取得開始`のログは表示されるが、`✅ OAuth URL取得成功`が表示されない

**原因**:
- バックエンドAPIがエラーを返している
- ネットワークエラー
- タイムアウト

**確認方法**:
- ネットワークタブで`/api/shopify/install-url`のステータスコードを確認
- バックエンドログでエラーを確認

### パターン3: リダイレクトが実行されていない

**症状**: `✅ OAuth URL取得成功`のログは表示されるが、`🔄 リダイレクト実行開始`が表示されない、またはリダイレクトが実行されない

**原因**:
- `performRedirect`関数が呼び出されていない
- リダイレクト処理でエラーが発生している
- ブラウザのセキュリティポリシーでブロックされている

**確認方法**:
- コンソールログで`🔄 リダイレクト実行開始`が表示されているか
- エラーログが表示されているか
- リダイレクト後のURLが変わっているか

### パターン4: 処理が途中で止まっている

**症状**: 特定のログまで表示されるが、その後のログが表示されない

**原因**:
- 非同期処理が完了していない
- エラーが発生しているがキャッチされていない
- タイムアウト処理が動作していない

**確認方法**:
- どのログまで表示されているか確認
- ネットワークタブでリクエストの状態を確認
- バックエンドログで処理が完了しているか確認

## 次のアクション

上記のデバッグ手順を実行し、以下を共有してください：

1. **コンソールログ**（特に`🚀`、`🔍`、`✅`、`❌`で始まるログ）
2. **ネットワークタブ**（`/api/shopify/install-url`のリクエスト/レスポンス）
3. **エラーメッセージ**（あれば）
4. **どのログまで表示されているか**（処理がどこで止まっているか）

これらの情報を基に、問題の根本原因を特定します。
