# 404エラー - 確認すべきバックエンドログ一覧

## 作成日
2025-12-28

## 目的
OAuthコールバック処理の流れを追跡するために、バックエンドログで確認すべきログメッセージを一覧化する。

---

## 確認すべきログ（優先順位順）

### 1. OAuthコールバックの実行確認（最優先）

**検索キーワード**: `OAuth callback received`

**期待されるログ**:
```
[INF] OAuth callback received. Shop: {Shop}, State: {State}
```

**確認ポイント**:
- [ ] OAuthコールバックが実行されているか
- [ ] `shop`パラメータが正しく取得できているか
- [ ] `state`パラメータが正しく取得できているか

**見つからない場合**:
- OAuthコールバックが実行されていない可能性がある
- リダイレクトURLが正しく設定されていない可能性がある

---

### 2. `BuildRedirectUrlAsync`の実行確認

**検索キーワード**: `BuildRedirectUrlAsync`

**期待されるログ**:
```
[INF] BuildRedirectUrlAsync: hostParam={HostParam}, decodedHost={DecodedHost}
[INF] BuildRedirectUrlAsync: apiKey={ApiKey}, appUrl={AppUrl}
```

**確認ポイント**:
- [ ] `BuildRedirectUrlAsync`が呼ばれているか
- [ ] `hostParam`が正しく取得できているか
- [ ] `decodedHost`が正しく取得できているか（`null`の場合はデコード失敗）

**見つからない場合**:
- `BuildRedirectUrlAsync`が呼ばれていない可能性がある
- エラーが発生して処理が中断されている可能性がある

---

### 3. リダイレクトURLの生成確認

**検索キーワード**: `Built embedded app URL` または `Using fallback URL`

**期待されるログ（埋め込みアプリの場合）**:
```
[INF] Built embedded app URL (direct to /auth/success): {RedirectUrl}
```

**期待されるログ（フォールバック処理の場合）**:
```
[WRN] BuildRedirectUrlAsync: Failed to decode host parameter. appUrl={AppUrl}
[WRN] Using fallback URL due to host parameter decode failure: {RedirectUrl}
```

**確認ポイント**:
- [ ] リダイレクトURLが生成されているか
- [ ] リダイレクトURLに`storeId`が含まれているか
- [ ] リダイレクトURLに`success=true`が含まれているか
- [ ] フォールバック処理が実行されているか

**見つからない場合**:
- `BuildRedirectUrlAsync`が呼ばれていない可能性がある
- エラーが発生して処理が中断されている可能性がある

---

### 4. `ProcessOAuthSuccessAsync`の実行確認

**検索キーワード**: `ProcessOAuthSuccessAsync` または `OAuth認証成功後の共通処理`

**期待されるログ**:
- ストア保存のログ
- Webhook登録のログ
- トライアル付与のログ

**確認ポイント**:
- [ ] `ProcessOAuthSuccessAsync`が実行されているか
- [ ] `storeId`が正しく生成されているか（ログでは`StoreId: 19`が確認済み）

---

### 5. `DecodeHost`のエラー確認

**検索キーワード**: `hostパラメータのデコードに失敗` または `hostパラメータをデコード`

**期待されるログ（成功時）**:
```
[INF] hostパラメータをデコード: {EncodedHost} -> {DecodedHost}
```

**期待されるログ（失敗時）**:
```
[WRN] hostパラメータのデコードに失敗: {EncodedHost}
System.FormatException: The input is not a valid Base-64 string...
```

**確認ポイント**:
- [ ] `DecodeHost`が実行されているか
- [ ] デコードが成功しているか
- [ ] エラーメッセージの詳細（現在はBase64エンコードエラーが発生）

---

### 6. `EncryptToken`のエラー確認

**検索キーワード**: `Error occurred during token encryption`

**期待されるログ**:
```
[ERR] Error occurred during token encryption. Using Base64 encoding
System.FormatException: The input is not a valid Base-64 string...
```

**確認ポイント**:
- [ ] `EncryptToken`が実行されているか
- [ ] エラーメッセージの詳細
- [ ] Base64エンコードエラーの原因

---

### 7. リダイレクト処理の確認

**検索キーワード**: `Redirect` または `return Redirect`

**確認ポイント**:
- [ ] リダイレクトが実行されているか
- [ ] リダイレクト先のURLが正しいか

---

## 現在の状況

### 確認済みのログ
- ✅ `hostパラメータのデコードに失敗` - デコードエラーが発生
- ✅ `Level 3 (OAuth) authentication successful. UserId: null, StoreId: 19` - 認証は成功

### 見つからないログ
- ❌ `OAuth callback received` - 確認が必要
- ❌ `BuildRedirectUrlAsync` - 確認が必要
- ❌ `Built embedded app URL` - 確認が必要
- ❌ `Using fallback URL due to host parameter decode failure` - 確認が必要

---

## 推測される問題

### 問題1: `host`パラメータのデコード失敗

**原因**:
- `host`パラメータが正しくBase64エンコードされていない
- URLエンコードの問題

**影響**:
- `BuildRedirectUrlAsync`の埋め込みアプリの分岐に入らない
- フォールバック処理が実行されるが、ログが出力されていない可能性

### 問題2: `BuildRedirectUrlAsync`が呼ばれていない

**原因**:
- `ProcessOAuthSuccessAsync`でエラーが発生している
- エラーハンドリングで処理が中断されている

**影響**:
- リダイレクトURLが生成されない
- フロントエンドに正しいリダイレクトURLが渡されない

---

## 次のステップ

### 1. バックエンドログの確認

以下のログを検索して、存在するか確認してください：

1. `OAuth callback received`
2. `BuildRedirectUrlAsync`
3. `Built embedded app URL`
4. `Using fallback URL due to host parameter decode failure`
5. `ProcessOAuthSuccessAsync`

### 2. `host`パラメータのデコード問題の調査

**確認事項**:
- `host`パラメータの実際の値
- Base64エンコードが正しく行われているか
- URLエンコードの問題がないか

### 3. `DecodeHost`メソッドの改善

**改善案**:
- Base64デコードの前に、URLデコードを実行する
- エラーハンドリングを改善する
- より詳細なログを出力する

---

## 参考資料

- [hostパラメータデコード失敗-調査](./404エラー-hostパラメータデコード失敗-調査.md)
- [ExitIframeログ分析結果](./404エラー-ExitIframeログ分析結果.md)
- [OAuthコールバック未実行-ログ分析結果](./404エラー-OAuthコールバック未実行-ログ分析結果.md)

---

## 更新履歴

- 2025-12-28: 初版作成（確認すべきバックエンドログ一覧）
