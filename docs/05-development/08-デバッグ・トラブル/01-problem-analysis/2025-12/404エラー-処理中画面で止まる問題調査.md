# 404エラー - 処理中画面で止まる問題調査

## 作成日
2025-12-28

## 目的
OAuth認証成功後、「処理中...」画面で止まり、次の画面に進まない原因を調査する。

---

## 問題の概要

### 症状
1. ✅ OAuth認証は成功している
2. ✅ Storesテーブルにレコードが登録されている
3. ✅ 「処理中...」画面が表示されている
4. ❌ その後、次の画面に進まない

### コンソールログの状況
- 多数のAPIリクエストが成功している（status 200）
- `Session token retrieved successfully`が表示されている
- `fetch完了`、`レスポンス受信完了`が表示されている

---

## 処理フローの確認

### `/auth/success`ページの処理フロー

1. **認証コールバック受信**
   - `shop`、`host`、`embedded`パラメータを取得
   - sessionStorageから`shop`、`host`を復元

2. **ストア情報を更新**
   - `refreshStores()`を呼び出し（タイムアウト5秒）
   - `storeId`を取得（クエリパラメータまたはAPIから検索）

3. **認証状態を設定**
   - `setCurrentStore(finalStoreId)`を呼び出し
   - `markAuthenticated(finalStoreId)`を呼び出し

4. **リダイレクト**
   - 1秒後に`/setup/initial`にリダイレクト

---

## 考えられる原因

### 原因1: `refreshStores()`がタイムアウトしている

**症状**: 
- `refreshStores()`が5秒以内に完了しない
- タイムアウトエラーが発生しているが、処理が続行されていない

**確認方法**:
1. コンソールログで`refreshStores()`のログを確認
2. タイムアウトエラーのログを確認
3. `refreshStores()`の完了ログを確認

**期待されるログ**:
```
✅ ストア一覧の更新に成功
```

または

```
⚠️ ストア一覧の更新に失敗しましたが、続行します: ...
```

---

### 原因2: `setCurrentStore()`が失敗している

**症状**: 
- `setCurrentStore()`が正常に実行されていない
- StoreContextの状態が更新されていない

**確認方法**:
1. コンソールログで`setCurrentStore()`のログを確認
2. StoreContextの状態を確認
3. エラーログがないか確認

---

### 原因3: `markAuthenticated()`が失敗している

**症状**: 
- `markAuthenticated()`が正常に実行されていない
- AuthProviderの状態が更新されていない

**確認方法**:
1. コンソールログで`markAuthenticated()`のログを確認
2. AuthProviderの状態を確認
3. エラーログがないか確認

---

### 原因4: リダイレクトが発生していない

**症状**: 
- リダイレクトのタイムアウト（1秒）が実行されていない
- `router.replace()`が失敗している

**確認方法**:
1. コンソールログでリダイレクトのログを確認
2. `🆕 OAuth認証完了: データ同期設定画面にリダイレクト`のログを確認
3. `🔄 リダイレクト先:`のログを確認

**期待されるログ**:
```
🆕 OAuth認証完了: データ同期設定画面にリダイレクト
🔄 リダイレクト先: /setup/initial?shop=...&host=...&embedded=...
```

---

### 原因5: `storeId`が取得できていない

**症状**: 
- `storeId`が取得できず、エラーが発生している
- `setCurrentStore()`や`markAuthenticated()`が実行されていない

**確認方法**:
1. コンソールログで`storeId`の取得ログを確認
2. クエリパラメータに`storeId`が含まれているか確認
3. APIから`storeId`を検索できているか確認

**期待されるログ**:
```
📋 クエリパラメータからStoreIdを取得: {storeId}
```

または

```
🔍 shopドメインからStoreIdを検索: { shop, storeId }
```

---

## 調査手順

### ステップ1: コンソールログを確認（最優先）

**目的**: `/auth/success`ページの処理がどこで止まっているか確認

**確認方法**:
1. ブラウザのコンソールで`/auth/success`ページのログを確認
2. 以下のログが出力されているか確認：
   - `🔐 認証コールバック受信:`
   - `✅ ストア一覧の更新に成功`
   - `✅ 認証状態を設定しました:`
   - `🆕 OAuth認証完了: データ同期設定画面にリダイレクト`
   - `🔄 リダイレクト先:`

**確認ポイント**:
- [ ] どのログまで出力されているか
- [ ] エラーログがないか
- [ ] タイムアウトエラーがないか

---

### ステップ2: `storeId`の取得を確認

**目的**: `storeId`が正しく取得できているか確認

**確認方法**:
1. コンソールログで`storeId`の取得ログを確認
2. クエリパラメータに`storeId`が含まれているか確認
3. APIから`storeId`を検索できているか確認

**確認ポイント**:
- [ ] `storeId`が取得できているか
- [ ] `storeId`が正しい値か
- [ ] `storeId`が`null`や`undefined`でないか

---

### ステップ3: リダイレクト処理を確認

**目的**: リダイレクト処理が正常に実行されているか確認

**確認方法**:
1. コンソールログでリダイレクトのログを確認
2. `router.replace()`が実行されているか確認
3. エラーログがないか確認

**確認ポイント**:
- [ ] リダイレクトのログが出力されているか
- [ ] `router.replace()`が実行されているか
- [ ] エラーログがないか

---

## 推奨対応

### 対応1: デバッグログを追加

**目的**: 処理がどこで止まっているか特定する

**実施内容**:
`/auth/success`ページに詳細なデバッグログを追加：
```typescript
console.log('🔍 [AuthSuccess] refreshStores開始');
// ...
console.log('🔍 [AuthSuccess] setCurrentStore開始:', finalStoreId);
// ...
console.log('🔍 [AuthSuccess] markAuthenticated開始:', finalStoreId);
// ...
console.log('🔍 [AuthSuccess] リダイレクトタイムアウト設定');
```

---

### 対応2: タイムアウト処理を改善

**目的**: `refreshStores()`のタイムアウト処理を改善

**実施内容**:
- タイムアウト時間を調整
- タイムアウト時のエラーハンドリングを改善
- タイムアウト後も処理を続行するように修正

---

### 対応3: エラーハンドリングを改善

**目的**: エラーが発生した場合でも処理を続行する

**実施内容**:
- 各処理でエラーが発生した場合でも、可能な限り処理を続行
- エラーログを詳細に出力
- ユーザーに適切なエラーメッセージを表示

---

## 確認チェックリスト

### コンソールログの確認
- [ ] `🔐 認証コールバック受信:`のログがあるか
- [ ] `✅ ストア一覧の更新に成功`のログがあるか
- [ ] `✅ 認証状態を設定しました:`のログがあるか
- [ ] `🆕 OAuth認証完了: データ同期設定画面にリダイレクト`のログがあるか
- [ ] `🔄 リダイレクト先:`のログがあるか
- [ ] エラーログがないか

### storeIdの確認
- [ ] `storeId`が取得できているか
- [ ] `storeId`が正しい値か
- [ ] `storeId`が`null`や`undefined`でないか

### リダイレクト処理の確認
- [ ] リダイレクトのログが出力されているか
- [ ] `router.replace()`が実行されているか
- [ ] エラーログがないか

---

## 参考資料

- [ExitIframeログ分析結果](./404エラー-ExitIframeログ分析結果.md)
- [OAuthコールバック未実行-ログ分析結果](./404エラー-OAuthコールバック未実行-ログ分析結果.md)
- [接続開始エラー調査](./404エラー-接続開始エラー調査.md)

---

## 更新履歴

- 2025-12-28: 初版作成（処理中画面で止まる問題調査）
