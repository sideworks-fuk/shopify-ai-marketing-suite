# インストールリンク無効エラー調査

## 最終更新: 2025-12-23

## エラー内容

Shopify管理画面でアプリのインストールを試みた際に以下のエラーが表示される：

```
このアプリのインストールリンクは無効です
ECレンジャー (local)をインストールするためのリンクは使用できません。
詳細については、アプリ開発者にお問い合わせください。
```

## 原因

**Shopify Partners Dashboardで設定されている「App URL」が、Shopify側で検証に失敗している。**

Shopifyは、インストールリンクの検証時にApp URLにアクセスして、アプリが正しく応答するか確認します。以下の問題が考えられます：

### 現在の状況

- **ngrok URL**: `https://fe155b402044.ngrok-free.app`
- **カスタムアプリのAPI Key**: `2d7e0e1f5da14eb9d299aa746738e44b`
- **バックエンドのリダイレクトURI生成**: `GetRedirectUri()`メソッドが`{frontendUrl}/api/shopify/callback`を返す
- **Shopify Partners Dashboardの設定**:
  - App URL: `https://fe155b402044.ngrok-free.app/` (末尾にスラッシュあり)
  - Redirect URLs: `https://fe155b402044.ngrok-free.app/api/shopify/callback`

### 問題点

1. **App URLの末尾スラッシュ**
   - Shopify Partners Dashboardで`https://fe155b402044.ngrok-free.app/`（末尾にスラッシュ）が設定されている
   - ShopifyはApp URLに直接アクセスして検証するため、末尾のスラッシュの有無が重要
   - **推奨**: 末尾のスラッシュを削除して`https://fe155b402044.ngrok-free.app`に設定

2. **App URLのアクセス可能性**
   - ShopifyがApp URLにアクセスした際、フロントエンドが正しく応答しているか確認が必要
   - ngrokが起動しているか確認
   - フロントエンドが`https://fe155b402044.ngrok-free.app`で正しく動作しているか確認

3. **バックエンドの環境変数設定**
   - ✅ `Frontend:BaseUrl`: `https://fe155b402044.ngrok-free.app`（正しく設定済み）
   - ✅ `Shopify:Frontend:BaseUrl`: `https://fe155b402044.ngrok-free.app`（正しく設定済み）

## 解決方法

### ステップ1: ngrokとフロントエンドの動作確認

1. **ngrokが起動しているか確認**
   ```powershell
   # ngrokが起動しているか確認
   # 別ターミナルで以下を実行
   ngrok http 3000
   ```
   - ngrok URLが`https://fe155b402044.ngrok-free.app`であることを確認
   - ⚠️ **重要**: ngrokを再起動するとURLが変わる可能性があります

2. **フロントエンドが起動しているか確認**
   ```powershell
   # フロントエンドが起動しているか確認
   # ブラウザで以下にアクセス
   https://fe155b402044.ngrok-free.app
   ```
   - フロントエンドが正しく表示されることを確認
   - **200 OK**が返されることを確認（開発者ツールのNetworkタブで確認）

3. **フロントエンドのインストールページがアクセス可能か確認**
   ```powershell
   # ブラウザで以下にアクセス
   https://fe155b402044.ngrok-free.app/install
   ```
   - インストールページが正しく表示されることを確認

4. **ShopifyがApp URLにアクセスできるか確認**
   ```powershell
   # curlでApp URLにアクセスして応答を確認
   curl -I https://fe155b402044.ngrok-free.app
   ```
   - **200 OK**が返されることを確認
   - リダイレクト（301, 302）が発生していないことを確認

### ステップ2: Shopify Partners Dashboardの設定確認・更新

1. [Shopify Partners Dashboard](https://partners.shopify.com) にログイン
2. **カスタムアプリ「ECレンジャー (local)」**を選択
3. **App setup** → **App URL** を以下に設定：
   ```
   https://fe155b402044.ngrok-free.app
   ```
   ⚠️ **重要**: 
   - **末尾のスラッシュ（`/`）を削除する**
   - 現在は`https://fe155b402044.ngrok-free.app/`となっているが、`https://fe155b402044.ngrok-free.app`に変更

4. **Allowed redirection URL(s)** に以下が登録されているか確認：
   ```
   https://fe155b402044.ngrok-free.app/api/shopify/callback
   ```
   ⚠️ **重要**: 
   - 末尾にスラッシュ（`/`）を付けない
   - 既存のURLも残しておく（複数登録可能）

### ステップ3: バックエンドの環境変数設定（確認のみ）

バックエンドの`appsettings.Development.json`または環境変数で以下を設定：

#### appsettings.Development.json

```json
{
  "Frontend": {
    "BaseUrl": "https://fe155b402044.ngrok-free.app"
  },
  "Shopify": {
    "Frontend": {
      "BaseUrl": "https://fe155b402044.ngrok-free.app"
    }
  }
}
```

#### 環境変数（PowerShell）

```powershell
$env:SHOPIFY_FRONTEND_BASEURL = "https://fe155b402044.ngrok-free.app"
```

または、Visual Studioのデバッグ設定で環境変数を追加：
- 名前: `SHOPIFY_FRONTEND_BASEURL`
- 値: `https://fe155b402044.ngrok-free.app`

**確認**: `appsettings.Development.json`で以下が正しく設定されていることを確認：

```json
{
  "Frontend": {
    "BaseUrl": "https://fe155b402044.ngrok-free.app"
  },
  "Shopify": {
    "Frontend": {
      "BaseUrl": "https://fe155b402044.ngrok-free.app"
    }
  }
}
```

✅ **既に正しく設定されています**（末尾にスラッシュなし）

### ステップ4: バックエンドの再起動（必要に応じて）

環境変数を変更した場合は、バックエンドを再起動：

```powershell
# バックエンドを停止（Ctrl+C）
# 再度起動
cd backend/ShopifyAnalyticsApi
dotnet run --urls "https://localhost:7088"
```

### ステップ5: バックエンドのOAuth URL生成を確認

1. **バックエンドのテストエンドポイントでOAuth URLを確認**
   ```
   GET https://localhost:7088/api/shopify/test-oauth-url?shop=your-store.myshopify.com
   ```

2. **レスポンスで以下を確認**:
   - `oauthUrl`: 生成されるOAuth URL
   - `redirectUri`: リダイレクトURI
   - `redirectUri`がShopify Partners Dashboardの「Allowed redirection URLs」に登録されているか確認

3. **生成されるOAuth URLの形式**:
   ```
   https://your-store.myshopify.com/admin/oauth/authorize?client_id=2d7e0e1f5da14eb9d299aa746738e44b&scope=read_orders,read_products,read_customers&redirect_uri=https://fe155b402044.ngrok-free.app/api/shopify/callback&state=xxxxx
   ```

4. **確認ポイント**:
   - ✅ `client_id`: カスタムアプリのAPI Key（`2d7e0e1f5da14eb9d299aa746738e44b`）
   - ✅ `scope`: スコープが設定されているか
   - ✅ `redirect_uri`: ngrok URLのコールバックURLが設定されているか
   - ✅ `state`: stateパラメータが生成されているか

### ステップ6: 動作確認

1. ブラウザで以下にアクセス：
   ```
   https://fe155b402044.ngrok-free.app/install?shop=your-store.myshopify.com
   ```

2. バックエンドのログで以下を確認：
   ```
   リダイレクトURI生成: FrontendUrl=https://fe155b402044.ngrok-free.app, RedirectUri=https://fe155b402044.ngrok-free.app/api/shopify/callback
   OAuth認証開始. Shop: your-store.myshopify.com, State: xxxxx, ApiKey: 2d7e0e1f5da14eb9d299aa746738e44b
   ```

3. ブラウザがShopifyのOAuth認証ページ（`/admin/oauth/authorize`）にリダイレクトされることを確認

4. `/app/grant`エンドポイントではなく、`/admin/oauth/authorize`エンドポイントにリダイレクトされることを確認

## 重要な確認事項

### App URLの末尾スラッシュについて

Shopify Partners Dashboardで設定するApp URLは、**末尾にスラッシュを付けない**ことを推奨します。

- ❌ **誤**: `https://fe155b402044.ngrok-free.app/`
- ✅ **正**: `https://fe155b402044.ngrok-free.app`

ShopifyはApp URLに直接アクセスして検証するため、末尾のスラッシュの有無によって動作が異なる場合があります。

### ShopifyのApp URL検証プロセス

Shopifyは、インストールリンクの検証時に以下の手順を実行します：

1. App URLにHTTPリクエストを送信
2. アプリが正しく応答するか確認（200 OKなど）
3. 応答が正しくない場合、「インストールリンクが無効」エラーを表示

そのため、以下を確認する必要があります：
- ngrokが起動している
- フロントエンドが`https://fe155b402044.ngrok-free.app`で正しく動作している
- フロントエンドのルート（`/`）が正しく応答している

## `/app/grant`エンドポイントについて

`/app/grant`はShopifyのOAuth認証フローの一部で、権限付与のためのエンドポイントです。このURLが表示される場合、以下の可能性があります：

1. **ShopifyがApp URLにアクセスして検証した後、OAuth認証を開始しようとしている**
2. **App URLが正しく応答していない可能性**
3. **Shopify Partners Dashboardの設定がまだ反映されていない（キャッシュの問題）**

### `/app/grant`のパラメータについて

提供されたURL:
```
store/xn-fbkq6e5da0fpb/app/grant?access_change_uuid=11b1b364-2d56-4f85-be9e-e332a62fda7b&client_id=2d7e0e1f5da14eb9d299aa746738e44b
```

**確認ポイント**:
- ✅ `client_id`: `2d7e0e1f5da14eb9d299aa746738e44b`（カスタムアプリのAPI Key、正しい）
- ✅ `access_change_uuid`: UUID形式（正常）

**問題の可能性**:
- `/app/grant`エンドポイントは、Shopifyが内部で使用するエンドポイントです
- 通常、このエンドポイントに直接アクセスすることはありません
- このURLが表示される場合、ShopifyがApp URLを検証した後、OAuth認証フローを開始しようとしている可能性があります

**重要な確認事項**:
1. バックエンドの`Install`メソッドが正しく呼び出されているか
2. 生成されるOAuth URLに必要なパラメータ（`scope`, `redirect_uri`, `state`）が含まれているか
3. `redirect_uri`がShopify Partners Dashboardの「Allowed redirection URLs」に登録されているか

### 確認手順

1. **ブラウザで直接App URLにアクセス**
   ```
   https://fe155b402044.ngrok-free.app
   ```
   - フロントエンドが正しく表示されるか確認
   - エラーページが表示されていないか確認

2. **curlでApp URLの応答を確認**
   ```powershell
   curl -I https://fe155b402044.ngrok-free.app
   ```
   - **200 OK**が返されることを確認
   - リダイレクト（301, 302）が発生していないことを確認

3. **ngrokのログを確認**
   - ngrokのターミナルで、Shopifyからのリクエストが来ているか確認
   - エラーが発生していないか確認

4. **Shopify Partners Dashboardの設定を再確認**
   - App URLが`https://fe155b402044.ngrok-free.app`（末尾スラッシュなし）になっているか確認
   - 設定を保存してから数分待つ（キャッシュがクリアされるまで）

## デバッグ方法

### 1. バックエンドのログ確認

`GetRedirectUri()`メソッドが返すリダイレクトURIを確認：

```csharp
_logger.LogInformation("リダイレクトURI生成: FrontendUrl={FrontendUrl}, RedirectUri={RedirectUri}", 
    frontendUrl, $"{frontendUrl}/api/shopify/callback");
```

### 2. 生成されるOAuth URLの確認

`Install`メソッドで生成されるOAuth URLを確認：

```csharp
var authUrl = $"https://{shop}/admin/oauth/authorize" +
    $"?client_id={finalApiKey}" +
    $"&scope={scopes}" +
    $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
    $"&state={state}";
```

ログに出力される`authUrl`の`redirect_uri`パラメータが、Shopify Partners Dashboardの「Allowed redirection URLs」に登録されているか確認。

### 3. テストエンドポイントの使用

バックエンドのテストエンドポイントを使用して設定を確認：

```
GET https://localhost:7088/api/shopify/test-settings
```

レスポンスで以下を確認：
- `FrontendUrl`: ngrok URLが設定されているか
- `RedirectUri`: 正しいコールバックURLが生成されているか

### 4. フロントエンドの応答確認（重要）

ShopifyがApp URLにアクセスした際の応答を確認：

```powershell
# curlでApp URLにアクセス
curl -v https://fe155b402044.ngrok-free.app
```

**確認ポイント**:
- **HTTPステータスコード**: `200 OK`が返されること
- **リダイレクト**: 301/302リダイレクトが発生していないこと
- **Content-Type**: `text/html`が返されること
- **エラーメッセージ**: エラーページが表示されていないこと

### 5. ngrokのログ確認

ngrokのターミナルで以下を確認：
- Shopifyからのリクエストが来ているか
- リクエストのHTTPステータスコード
- エラーメッセージがないか

### 6. Shopify Partners Dashboardの設定再確認

1. **App URLの設定を再確認**
   - `https://fe155b402044.ngrok-free.app`（末尾スラッシュなし）になっているか
   - 設定を保存してから**数分待つ**（キャッシュがクリアされるまで）

2. **設定の反映を待つ**
   - Shopify Partners Dashboardの設定変更は、反映までに数分かかる場合があります
   - 設定を変更した直後にテストすると、古い設定が使われる可能性があります

## 注意事項

### ngrok URLの変更時

ngrokを再起動するとURLが変わる可能性があります（無料版の場合）。その場合は：

1. 新しいngrok URLを取得
2. Shopify Partners Dashboardの設定を更新
3. バックエンドの環境変数を更新
4. バックエンドを再起動

### 固定ドメインの使用

ngrok URLが頻繁に変わる場合は、ngrok有料プランで固定ドメインを使用することを検討してください。

## 関連ドキュメント

- [インストール時のAPI Key判定方法](../../../../03-feature-development/マルチアプリ対応/インストール時のAPI Key判定方法.md)
- [ShopifyAppsテーブル設計書](../../../../03-feature-development/マルチアプリ対応/ShopifyAppsテーブル設計書.md)
- [アプリインストールガイド](../../../../03-feature-development/OAuth認証機能/アプリインストールガイド.md)

