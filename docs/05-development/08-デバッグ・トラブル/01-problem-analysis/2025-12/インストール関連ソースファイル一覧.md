# インストール関連ソースファイル一覧

## 作成日
2025-12-25

## 概要
Shopifyアプリのインストールフローに関連するすべてのソースファイルを整理したドキュメントです。

---

## 📁 フロントエンド（Next.js）

### 1. インストールページ関連

#### メインインストールページ
- **`frontend/src/app/install/page.tsx`**
  - インストールページのメインコンポーネント
  - ショップドメイン入力フォーム
  - OAuth認証フローの開始処理
  - App Bridgeを使用したiframe脱出処理

- **`frontend/src/app/install/page-tailwind.tsx`**
  - Tailwind CSS版のインストールページ（代替実装）

- **`frontend/src/app/install/layout.tsx`**
  - インストールページのレイアウト設定

### 2. 認証成功・エラーページ

- **`frontend/src/app/auth/success/page.tsx`**
  - OAuth認証成功後のリダイレクト先
  - 認証状態の設定（`markAuthenticated`）
  - ダッシュボードまたは初期設定画面へのリダイレクト

- **`frontend/src/app/auth/error/page.tsx`**
  - OAuth認証エラー時の表示ページ

### 3. ルートページ・リダイレクト

- **`frontend/src/app/page.tsx`**
  - ルートページ（`/`）
  - 認証状態に基づいて適切なページにリダイレクト
  - 認証済み → `/customers/dormant`
  - 未認証 → `/install`

### 4. 初期設定ページ

- **`frontend/src/app/setup/initial/page.tsx`**
  - インストール後の初期設定画面
  - データ同期設定
  - 初期同期の開始

- **`frontend/src/app/setup/syncing/page.tsx`**
  - データ同期中の表示ページ

### 5. API Routes（Next.js API Routes）

- **`frontend/src/app/api/shopify/callback/route.ts`**
  - Shopify OAuthコールバックのプロキシ
  - フロントエンドからバックエンドへのリクエスト転送
  - リダイレクト処理

- **`frontend/src/app/api/shopify/callback/route.ts.backup`**
  - バックアップファイル

- **`frontend/src/app/api/shopify/callback/debug/route.ts`**
  - デバッグ用エンドポイント

### 6. 認証プロバイダー・コンテキスト

- **`frontend/src/components/providers/AuthProvider.tsx`**
  - 認証状態の管理
  - App Bridgeセッショントークンの取得
  - OAuth認証フラグの確認
  - `isAuthenticated`、`isInitializing`、`isApiClientReady`の管理

- **`frontend/src/contexts/SubscriptionContext.tsx`**
  - サブスクリプション情報の管理
  - インストールページ・ルートページでのAPI呼び出し制御

### 7. 認証ガード・エラーコンポーネント

- **`frontend/src/components/auth/AuthGuard.tsx`**
  - 認証が必要なページのガード
  - 未認証時のリダイレクト処理

- **`frontend/src/components/errors/AuthenticationRequired.tsx`**
  - 認証が必要な場合のエラー表示
  - OAuth認証開始ボタン

### 8. Shopify App Bridge関連

- **`frontend/src/lib/shopify/app-bridge-provider.tsx`**
  - App Bridgeの初期化
  - セッショントークンの取得
  - 埋め込みアプリ判定

### 9. ミドルウェア

- **`frontend/src/middleware.ts`**
  - Next.jsミドルウェア
  - リクエストの前処理
  - 認証チェック（必要に応じて）

### 10. その他

- **`frontend/src/app/(authenticated)/layout.tsx`**
  - 認証済みユーザー向けのレイアウト

- **`frontend/src/components/layout/ConditionalLayout.tsx`**
  - 条件付きレイアウト表示

---

## 🔧 バックエンド（ASP.NET Core）

### 1. OAuth認証コントローラー

- **`backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`**
  - **主要メソッド**:
    - `Install()` - インストール開始（OAuth URL生成・リダイレクト）
    - `Callback()` - OAuthコールバック処理（GET）
    - `ProcessCallback()` - OAuthコールバック処理（POST）
    - `GetInstallUrl()` - OAuth URL取得（JSON返却）
    - `BuildOAuthUrlAsync()` - OAuth URL生成
    - `ExchangeCodeForAccessTokenWithRetry()` - アクセストークン取得
    - `SaveOrUpdateStore()` - ストア情報の保存・更新
    - `RegisterWebhooks()` - Webhook登録
    - `GetRedirectUri()` - リダイレクトURI生成

### 2. 認証サービス

- **`backend/ShopifyAnalyticsApi/Services/AuthenticationService.cs`**
  - 認証処理の実装
  - セッショントークンの検証
  - デモトークンの検証

- **`backend/ShopifyAnalyticsApi/Services/IAuthenticationService.cs`**
  - 認証サービスのインターフェース

- **`backend/ShopifyAnalyticsApi/Services/ShopifyOAuthService.cs`**
  - Shopify OAuth処理の実装
  - HMAC検証
  - 認証URL生成

### 3. 認証ミドルウェア

- **`backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs`**
  - 認証モードの判定
  - OAuth認証の要求

- **`backend/ShopifyAnalyticsApi/Middleware/StoreContextMiddleware.cs`**
  - ストアコンテキストの設定

- **`backend/ShopifyAnalyticsApi/Middleware/HmacValidationMiddleware.cs`**
  - HMAC検証ミドルウェア

### 4. 認証コントローラー（その他）

- **`backend/ShopifyAnalyticsApi/Controllers/AuthController.cs`**
  - その他の認証関連エンドポイント

- **`backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthVerificationHelper.cs`**
  - OAuth認証の検証ヘルパー

- **`backend/ShopifyAnalyticsApi/Controllers/ShopifyHmacTestController.cs`**
  - HMAC検証のテスト用コントローラー

### 5. フィルター

- **`backend/ShopifyAnalyticsApi/Filters/DemoReadOnlyFilter.cs`**
  - デモモード用の読み取り専用フィルター

### 6. ヘルパー

- **`backend/ShopifyAnalyticsApi/Services/ShopifyHmacVerificationHelper.cs`**
  - HMAC検証ヘルパー

### 7. プログラム設定

- **`backend/ShopifyAnalyticsApi/Program.cs`**
  - アプリケーションの初期化
  - ミドルウェアの登録
  - サービスの登録

---

## 📚 ドキュメント

### 設計・要件定義

- **`docs/03-feature-development/インストールフロー改善機能/Shopify-インストールフロー改善-要件定義.md`**
- **`docs/03-feature-development/インストールフロー改善機能/Shopify-インストールフロー改善-設計書.md`**
- **`docs/03-feature-development/インストールフロー改善機能/Shopify-インストールフロー改善-実装計画.md`**
- **`docs/03-feature-development/インストールフロー改善機能/Shopify-インストールフロー改善-テスト計画.md`**

### 認証・セキュリティ

- **`docs/05-development/09-認証・セキュリティ/Shopify-アプリ認証・認可設計.md`**
- **`docs/05-development/09-認証・セキュリティ/Shopify-shopパラメータ仕様.md`**

### 問題分析・トラブルシューティング

- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストール時の404エラーとFeatureLimitsテーブルカラム不足問題.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストールフロー問題の根本原因調査.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストールフロー問題の詳細デバッグ手順.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストールフロー問題のデバッグ手順.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストールページからのインストール失敗調査.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストールボタン押下後の動作確認手順.md`**
- **`docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/OAuth認証画面でread_customersスコープが表示されない問題.md`**

---

## 🔄 インストールフローの主要な処理フロー

### フロントエンド側

1. **`/install` ページ** (`frontend/src/app/install/page.tsx`)
   - ユーザーがショップドメインを入力
   - `handleInstall()` が実行される
   - バックエンドの `/api/shopify/install` にリダイレクト

2. **バックエンド `/api/shopify/install`** (`backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`)
   - OAuth URLを生成
   - Shopify OAuth認証画面にリダイレクト（HTTP 302）

3. **Shopify OAuth認証画面**
   - ユーザーが権限を承認

4. **フロントエンド `/api/shopify/callback`** (`frontend/src/app/api/shopify/callback/route.ts`)
   - Shopifyからのコールバックを受信
   - バックエンドの `/api/shopify/callback` に転送

5. **バックエンド `/api/shopify/callback`** (`backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`)
   - アクセストークンを取得
   - ストア情報を保存（`SaveOrUpdateStore`）
   - Webhookを登録
   - セッションCookieを設定
   - フロントエンドの `/auth/success` にリダイレクト

6. **`/auth/success` ページ** (`frontend/src/app/auth/success/page.tsx`)
   - 認証状態を設定（`markAuthenticated`）
   - `localStorage.setItem('oauth_authenticated', 'true')`
   - `/setup/initial` または `/customers/dormant` にリダイレクト

7. **`/setup/initial` ページ** (`frontend/src/app/setup/initial/page.tsx`)
   - 初期設定画面
   - データ同期設定
   - 初期同期の開始

### 認証状態の管理

- **`AuthProvider`** (`frontend/src/components/providers/AuthProvider.tsx`)
  - `isAuthenticated`: 認証状態
  - `isInitializing`: 初期化中フラグ
  - `isApiClientReady`: APIクライアント準備完了フラグ
  - App Bridgeセッショントークンの取得
  - OAuth認証フラグの確認

- **`SubscriptionProvider`** (`frontend/src/contexts/SubscriptionContext.tsx`)
  - インストールページ・ルートページではAPIを呼び出さない
  - 認証が必要なAPIを呼び出すと401エラーが発生するため

---

## 📝 重要な注意点

### 1. リダイレクトURIの設定

- **フロントエンドURL**: `https://{frontend-domain}/api/shopify/callback`
- **バックエンドURL**: `https://{backend-domain}/api/shopify/callback`
- 現在の実装では、`ShopifyApps`テーブルの`AppUrl`が設定されている場合はフロントエンドURLを使用
- 設定されていない場合はバックエンドURLを使用（フォールバック）

### 2. 認証状態の確認タイミング

- ルートページ（`/`）では、`AuthProvider`の初期化が完了するまで待機
- `isInitializing`が`false`、`isApiClientReady`が`true`になるまで待機
- その後、`isAuthenticated`に基づいてリダイレクト

### 3. API呼び出しの制御

- `SubscriptionProvider`は、インストールページ（`/install`）とルートページ（`/`）ではAPIを呼び出さない
- 認証が必要なAPIを呼び出すと401エラーが発生するため

### 4. 埋め込みアプリ対応

- App Bridgeを使用してiframeから脱出
- `embedded=1`の場合は、`embedded=0`に変更してリダイレクト
- これにより、OAuth認証フローが正常に動作する

---

## 🔍 デバッグ時の確認ポイント

### フロントエンド

1. **コンソールログ**
   - `AuthProvider`の初期化ログ
   - `isInitializing`、`isApiClientReady`、`isAuthenticated`の値
   - `SubscriptionProvider`のAPI呼び出しタイミング

2. **ネットワークタブ**
   - `/api/shopify/install`へのリクエスト
   - Shopify OAuth認証画面へのリダイレクト
   - `/api/shopify/callback`へのリクエスト
   - `/api/store`、`/api/subscription/status`へのリクエストとそのステータスコード

3. **localStorage**
   - `oauth_authenticated`: OAuth認証フラグ
   - `currentStoreId`: 現在のストアID
   - `oauth_debug_info`: デバッグ情報

### バックエンド

1. **ログ**
   - `/api/shopify/install`へのリクエスト
   - `/api/shopify/callback`へのリクエスト
   - `SaveOrUpdateStore`の実行
   - エラーログ

2. **データベース**
   - `Stores`テーブルにレコードが作成されているか
   - `ShopifyApps`テーブルの設定
   - `AccessToken`が正しく保存されているか

---

## 📌 関連ファイルの依存関係

```
frontend/src/app/page.tsx
  ↓
frontend/src/components/providers/AuthProvider.tsx
  ↓
frontend/src/lib/shopify/app-bridge-provider.tsx
  ↓
frontend/src/app/install/page.tsx
  ↓
backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs
  ↓
backend/ShopifyAnalyticsApi/Services/ShopifyOAuthService.cs
  ↓
frontend/src/app/api/shopify/callback/route.ts
  ↓
backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs (Callback)
  ↓
frontend/src/app/auth/success/page.tsx
  ↓
frontend/src/app/setup/initial/page.tsx
```

---

## 🔄 更新履歴

- 2025-12-25: 初版作成
