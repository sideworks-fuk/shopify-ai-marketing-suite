# インストールフロー問題のデバッグ手順

## 問題の概要

以下の3点が未解決：
1. ダッシュボードが一瞬表示される問題
2. 「処理中」から進まない問題
3. OAuth認証画面へのリダイレクトが正常に動作していない

**重要**: Storesテーブルにレコードは登録されている（OAuth認証自体は完了している可能性が高い）

## 調査に必要な情報

### 1. ブラウザのコンソールログ

以下のログを確認してください：

```javascript
// インストールボタンクリック後
🚀 Shopify接続開始: [shop-domain]
🔍 OAuth URL取得開始: [api-url]
✅ OAuth URL取得成功: [auth-url]
🔄 リダイレクト実行開始: { authUrl, isEmbedded, isInIframe }
✅ window.location.replace()に設定: [auth-url]
```

**確認ポイント**:
- OAuth URL取得が成功しているか
- リダイレクト処理が実行されているか
- エラーメッセージが表示されているか

### 2. ネットワークタブ

以下のリクエストを確認してください：

**`/api/shopify/install-url`**
- リクエストURL
- ステータスコード（200 OKか）
- レスポンスボディ（`authUrl`が含まれているか）

**確認ポイント**:
- リクエストが成功しているか
- レスポンスに`authUrl`が含まれているか
- エラーレスポンスが返されているか

### 3. バックエンドログ

以下のログを確認してください：

```
[INFO] OAuth URL取得開始. Shop: [shop], ApiKey: [api-key]
[INFO] OAuth認証スコープ: [scopes]
[INFO] 生成されたOAuth URL: [auth-url]
[INFO] OAuth認証コールバック受信. Shop: [shop]
[INFO] アクセストークン取得成功. Shop: [shop]
```

**確認ポイント**:
- OAuth URL生成が成功しているか
- コールバック処理が実行されているか
- エラーログが出力されているか

### 4. 現在のURL

ブラウザのアドレスバーを確認してください：

- `/install` - インストールページ
- `/auth/success` - 認証成功ページ
- `/setup/initial` - データ同期設定ページ
- `/customers/dormant` - ダッシュボード（一瞬表示される可能性）

### 5. localStorage/sessionStorageの内容

ブラウザの開発者ツールで以下を確認：

```javascript
// Consoleで実行
localStorage.getItem('oauth_debug_info')
localStorage.getItem('oauth_debug_timestamp')
sessionStorage.getItem('shopify_host')
sessionStorage.getItem('shopify_shop')
```

### 6. Storesテーブルのレコード内容

データベースで以下を確認：

```sql
SELECT 
    Id,
    Domain,
    IsActive,
    AccessToken, -- NULLでないことを確認
    CreatedAt,
    UpdatedAt,
    Settings -- JSON形式でスコープ情報が含まれているか確認
FROM Stores
WHERE Domain LIKE '%[shop-domain]%'
ORDER BY CreatedAt DESC
```

**確認ポイント**:
- `IsActive`が`true`か
- `AccessToken`が設定されているか
- `Settings`にスコープ情報が含まれているか

## デバッグ手順

### ステップ1: インストールボタンクリック前の状態確認

1. ブラウザの開発者ツールを開く（F12）
2. Consoleタブを開く
3. Networkタブを開く
4. 現在のURLを確認
5. localStorage/sessionStorageの内容を確認

### ステップ2: インストールボタンクリック後のログ確認

1. 「接続を開始」ボタンをクリック
2. Consoleタブで以下のログを確認：
   - `🚀 Shopify接続開始`
   - `🔍 OAuth URL取得開始`
   - `✅ OAuth URL取得成功`
   - `🔄 リダイレクト実行開始`
   - エラーメッセージ（`❌`で始まるログ）

### ステップ3: ネットワークリクエストの確認

1. Networkタブで`/api/shopify/install-url`を探す
2. リクエストの詳細を確認：
   - ステータスコード
   - レスポンスボディ（`authUrl`が含まれているか）
   - エラーレスポンスが返されているか

### ステップ4: リダイレクトの確認

1. Consoleタブで`🔄 リダイレクト実行開始`のログを確認
2. リダイレクト先のURLを確認
3. 実際にリダイレクトが実行されているか確認（URLが変わるか）

### ステップ5: バックエンドログの確認

1. Azure App ServiceのログストリームまたはApplication Insightsを確認
2. 以下のログを探す：
   - `OAuth URL取得開始`
   - `OAuth認証スコープ`
   - `生成されたOAuth URL`
   - `OAuth認証コールバック受信`
   - エラーログ

### ステップ6: データベースの確認

1. Storesテーブルにレコードが登録されているか確認
2. レコードの内容を確認（特に`IsActive`、`AccessToken`、`Settings`）

## 想定される問題と対処法

### 問題1: OAuth URL取得に失敗している

**症状**: Consoleに`❌ 接続エラー`が表示される

**確認事項**:
- Networkタブで`/api/shopify/install-url`のステータスコードを確認
- バックエンドログでエラーを確認

**対処法**:
- エラーメッセージを確認して原因を特定
- APIエンドポイントが正しく動作しているか確認

### 問題2: リダイレクトが実行されていない

**症状**: Consoleに`🔄 リダイレクト実行開始`は表示されるが、URLが変わらない

**確認事項**:
- `window.location.replace()`が実行されているか
- ブラウザのセキュリティポリシーでブロックされていないか
- 埋め込みアプリ内で`window.top.location.replace()`が実行されているか

**対処法**:
- フォールバック処理（1秒後の強制リダイレクト）が動作しているか確認
- ブラウザのコンソールでエラーを確認

### 問題3: OAuth認証画面が表示されない

**症状**: リダイレクトは実行されるが、OAuth認証画面が表示されず、直接コールバックに戻る

**確認事項**:
- OAuth URLが正しく生成されているか
- Shopifyのカスタムアプリの設定を確認
- バックエンドログでOAuth URLの内容を確認

**対処法**:
- OAuth URLを直接ブラウザで開いてみる
- Shopify Partners Dashboardの設定を確認

### 問題4: 認証成功後のリダイレクトが正常に動作していない

**症状**: Storesテーブルにレコードは登録されているが、画面が「処理中」のまま

**確認事項**:
- `/auth/success`ページのログを確認
- `hasProcessedRef`フラグが正しく動作しているか
- リダイレクト処理が実行されているか

**対処法**:
- `/auth/success`ページの`useEffect`が複数回実行されていないか確認
- リダイレクト先のURLが正しいか確認

## デバッグ用コードの追加

必要に応じて、以下のデバッグコードを追加してください：

### フロントエンド（install/page.tsx）

```typescript
// リダイレクト処理の前後でログを追加
console.log('🔄 リダイレクト前の状態:', {
  currentUrl: window.location.href,
  isEmbedded,
  isInIframe,
  authUrl,
  canAccessTopWindow: window.top !== null
});

// リダイレクト実行後
console.log('🔄 リダイレクト実行後:', {
  executed: true,
  method: isEmbedded || isInIframe ? 'window.top.location.replace' : 'window.location.replace'
});
```

### バックエンド（ShopifyAuthController.cs）

```csharp
// OAuth URL生成時に詳細ログを追加
_logger.LogInformation("OAuth URL生成詳細: Shop={Shop}, ApiKey={ApiKey}, Scopes={Scopes}, RedirectUri={RedirectUri}, AuthUrl={AuthUrl}",
    shop, apiKey, string.Join(",", scopes), redirectUri, authUrl);
```

## 次のステップ

1. 上記の情報を収集
2. 問題の原因を特定
3. 必要に応じて追加のデバッグコードを実装
4. 修正を実施
