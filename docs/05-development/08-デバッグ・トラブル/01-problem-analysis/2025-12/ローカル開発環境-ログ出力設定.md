# ローカル開発環境 ログ出力設定

## 問題
ローカル開発環境で`logs`フォルダが作成されない。

## 原因

### 1. `web.config`の`stdoutLogFile`設定の制限
`web.config`の`stdoutLogFile`設定は、**IISまたはIIS Expressでホストされている場合のみ**有効です。

以下の方法でアプリケーションを実行している場合、`web.config`は使用されません：
- `dotnet run`
- `dotnet watch`
- Visual Studio Codeのデバッグ実行

### 2. 現在の設定
- `web.config`: `stdoutLogFile=".\logs\stdout"`が設定されている
- `appsettings.LocalDevelopment.json`: Serilogのファイル出力が設定されていない

## 解決策

### 方法1: Serilogのファイル出力を追加（推奨）

`appsettings.LocalDevelopment.json`にSerilogのファイル出力を追加：

```json
"Serilog": {
  "Using": [ "Serilog.Sinks.Console", "Serilog.Sinks.File" ],
  "MinimumLevel": {
    "Default": "Information",
    "Override": {
      "Microsoft": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning",
      "System": "Warning"
    }
  },
  "WriteTo": [
    {
      "Name": "Console",
      "Args": {
        "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
      }
    },
    {
      "Name": "File",
      "Args": {
        "path": "logs/app-.log",
        "rollingInterval": "Day",
        "retainedFileCountLimit": 7,
        "outputTemplate": "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}",
        "fileSizeLimitBytes": 10485760,
        "rollOnFileSizeLimit": true
      }
    }
  ],
  "Enrich": [ "FromLogContext", "WithMachineName", "WithThreadId" ]
}
```

**注意**: `Serilog.Sinks.File`パッケージは既にインストール済みです（`ShopifyAnalyticsApi.csproj`に含まれています）。

### 方法2: IIS Expressを使用

Visual StudioでIIS Expressを使用してアプリケーションを実行すると、`web.config`の設定が有効になります。

1. Visual Studioでプロジェクトを開く
2. プロジェクトのプロパティ → 「デバッグ」タブ
3. 「起動」を「IIS Express」に設定
4. アプリケーションを実行

### 方法3: `logs`フォルダを手動で作成

アプリケーション起動時に`logs`フォルダが存在しない場合は、自動的に作成されるように`Program.cs`に追加：

```csharp
// Program.csの先頭に追加
var logsDirectory = Path.Combine(Directory.GetCurrentDirectory(), "logs");
if (!Directory.Exists(logsDirectory))
{
    Directory.CreateDirectory(logsDirectory);
}
```

ただし、Serilogのファイル出力を使用する場合は、この処理は不要です（Serilogが自動的にディレクトリを作成します）。

## 確認手順

### 1. Serilogのファイル出力を追加した場合
1. アプリケーションを起動
2. `logs`フォルダが作成されることを確認
3. `logs/app-YYYYMMDD.log`ファイルが作成されることを確認

### 2. IIS Expressを使用した場合
1. Visual StudioでIIS Expressを使用してアプリケーションを実行
2. `logs`フォルダが作成されることを確認
3. `logs/stdout-*.log`ファイルが作成されることを確認

## 推奨設定

ローカル開発環境では、**方法1（Serilogのファイル出力）**を推奨します：
- `dotnet run`や`dotnet watch`でも動作する
- ログのローテーション機能が利用できる
- 日付別のログファイルが作成される
- 設定が柔軟

## 関連ファイル
- `backend/ShopifyAnalyticsApi/web.config`
- `backend/ShopifyAnalyticsApi/appsettings.LocalDevelopment.json`
- `backend/ShopifyAnalyticsApi/Program.cs`
- `backend/ShopifyAnalyticsApi/ShopifyAnalyticsApi.csproj`
