# 404エラー - ログ分析結果と問題特定

## 作成日
2025-12-28

## 目的
バックエンドログの分析結果をまとめ、問題を特定する。

---

## ログ分析結果

### ✅ 正常に実行されている処理

1. **OAuthコールバックの実行**
   ```
   [12:22:30 INF] OAuth callback received. Shop: xn-fbkq6e5da0fpb.myshopify.com, State: Uw5NhUor9hBM9UbgZykVNPqFYvoRsHqw
   ```

2. **HMAC検証の成功**
   ```
   [12:22:30 INF] HMAC検証成功（ShopifySharpライブラリ）
   ```

3. **BuildRedirectUrlAsyncの実行**
   ```
   [12:22:32 INF] BuildRedirectUrlAsync: hostParam=YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg, decodedHost=null
   ```

4. **フォールバック処理の実行**
   ```
   [12:22:32 WRN] BuildRedirectUrlAsync: Failed to decode host parameter. appUrl=https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net
   [12:22:32 WRN] Using fallback URL due to host parameter decode failure: https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success?shop=xn-fbkq6e5da0fpb.myshopify.com&storeId=19&success=true&host=YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg
   ```

### ❌ 問題が発生している処理

1. **hostパラメータのデコード失敗**
   ```
   [12:22:32 WRN] hostパラメータのデコードに失敗: YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg
   System.FormatException: The input is not a valid Base-64 string...
   ```

2. **EncryptTokenのエラー**
   ```
   [12:22:31 ERR] Error occurred during token encryption. Using Base64 encoding
   System.FormatException: The input is not a valid Base-64 string...
   ```

---

## 問題の特定

### 問題1: hostパラメータのデコード失敗

**状況**:
- `host`パラメータ: `YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg`
- Base64デコードに失敗している
- フォールバック処理が実行されている

**影響**:
- `decodedHost=null`のため、埋め込みアプリの分岐に入らない
- フォールバック処理が実行されるが、リダイレクトURLは正しく生成されている

**重要**: フォールバック処理でも`storeId=19`がリダイレクトURLに含まれているため、この問題は致命的ではありません。

---

### 問題2: フロントエンドでstoreIdが取得できない

**状況**:
- バックエンドのリダイレクトURLには`storeId=19`が含まれている
- フロントエンドで「ストアIDの取得に失敗しました」エラーが表示される

**推測される原因**:
1. フロントエンドの`AuthSuccessPage`で`storeId`を正しく取得できていない
2. `searchParams?.get('storeId')`が`null`を返している
3. URLパラメータが正しく渡されていない

---

## リダイレクトURLの確認

### 生成されたリダイレクトURL
```
https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success?shop=xn-fbkq6e5da0fpb.myshopify.com&storeId=19&success=true&host=YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg
```

### URLパラメータの確認
- ✅ `shop=xn-fbkq6e5da0fpb.myshopify.com`
- ✅ `storeId=19`
- ✅ `success=true`
- ✅ `host=YWRtaW4uc2hvcGlmeS5jb20vc3RvcmUveG4tZmJrcTZlNWRhMGZwYg`

**結論**: リダイレクトURLは正しく生成されています。

---

## 次のステップ

### 1. フロントエンドの`AuthSuccessPage`の確認

**確認事項**:
- `searchParams?.get('storeId')`が正しく取得できているか
- URLパラメータが正しく渡されているか
- `useEffect`の依存配列が正しく設定されているか

**確認方法**:
- ブラウザの開発者ツールでURLを確認
- コンソールログで`storeId`の値を確認

### 2. hostパラメータのデコード問題の調査

**確認事項**:
- `host`パラメータが正しくBase64エンコードされているか
- URLエンコードの問題がないか
- Shopifyから渡される`host`パラメータの形式

**調査方法**:
- Shopify公式ドキュメントで`host`パラメータの形式を確認
- Base64デコードの実装を確認

---

## 推測される根本原因

### フロントエンドの問題

フロントエンドの`AuthSuccessPage`で`storeId`を正しく取得できていない可能性が高いです。

**確認すべき点**:
1. `searchParams?.get('storeId')`が`null`を返している
2. `useEffect`の依存配列が空（`[]`）のため、URLパラメータの変更を検知できていない
3. リダイレクトURLに`storeId`が含まれているが、フロントエンドで取得できていない

---

## 参考資料

- [ProcessOAuthSuccessAsync実行確認](./404エラー-ProcessOAuthSuccessAsync実行確認.md)
- [確認すべきバックエンドログ一覧](./404エラー-確認すべきバックエンドログ一覧.md)
- [hostパラメータデコード失敗-調査](./404エラー-hostパラメータデコード失敗-調査.md)

---

## 更新履歴

- 2025-12-28: 初版作成（ログ分析結果と問題特定）
