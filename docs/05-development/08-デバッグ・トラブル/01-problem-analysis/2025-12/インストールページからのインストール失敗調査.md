# インストールページからのインストール失敗調査

## 最終更新: 2025-12-23

## エラー内容

フロントエンドの`/install`ページにアクセスして「インストール」ボタンをクリックすると、以下のエラーが表示される：

```
このアプリのインストールリンクは無効です
ECレンジャー (local)をインストールするためのリンクは使用できません。
詳細については、アプリ開発者にお問い合わせください。
```

## 原因の可能性

### 1. バックエンドのURL設定が正しくない

フロントエンドの`/install`ページは、バックエンドの`/api/shopify/install`エンドポイントを呼び出します。バックエンドのURLが正しく設定されていない場合、リクエストが失敗します。

**確認項目**:
- `NEXT_PUBLIC_API_URL`環境変数が正しく設定されているか
- バックエンドが起動しているか
- バックエンドのURLが正しいか

### 2. Shopify Partners DashboardのApp URL設定

Shopifyは、OAuth認証URLにアクセスする前に、App URLを検証します。App URLが正しく設定されていない場合、「インストールリンクが無効」エラーが表示されます。

**確認項目**:
- App URL: `https://fe155b402044.ngrok-free.app`（末尾スラッシュなし）
- Redirect URLs: `https://fe155b402044.ngrok-free.app/api/shopify/callback`
- 設定が保存されてから数分待っているか（キャッシュがクリアされるまで）

### 3. ngrokが起動していない、またはURLが変わった

ngrokが起動していない、またはURLが変わった場合、App URLにアクセスできず、エラーが発生します。

**確認項目**:
- ngrokが起動しているか
- ngrok URLが`https://fe155b402044.ngrok-free.app`であるか
- フロントエンドが`https://fe155b402044.ngrok-free.app`で正しく動作しているか

### 4. バックエンドの`Install`メソッドが正しく呼ばれていない

フロントエンドからバックエンドへのリクエストが失敗している可能性があります。

**確認項目**:
- ブラウザの開発者ツール（Networkタブ）でリクエストを確認
- バックエンドのログで`Install`メソッドが呼ばれているか確認
- CORSエラーが発生していないか確認

## デバッグ手順

### ステップ1: フロントエンドの環境変数を確認

1. **`.env.local`ファイルを確認**:
   ```env
   NEXT_PUBLIC_API_URL=https://localhost:7088
   NEXT_PUBLIC_SHOPIFY_API_KEY=2d7e0e1f5da14eb9d299aa746738e44b
   ```

2. **ブラウザのコンソールで確認**:
   - フロントエンドの`/install`ページを開く
   - 開発者ツール（F12）を開く
   - Consoleタブで以下を確認：
     ```
     🚀 Shopifyインストール開始: {shop}
     📍 リダイレクト先: {installUrl}
     🌍 現在の環境: {environment}
     🔄 コールバックURL: {callbackUrl}
     🔑 API Key: 設定済み/未設定
     ```

### ステップ2: バックエンドの起動確認

1. **バックエンドが起動しているか確認**:
   ```powershell
   # バックエンドが起動しているか確認
   # ターミナルで以下を実行
   curl https://localhost:7088/api/shopify/test-config
   ```

2. **バックエンドのログを確認**:
   - `Install`メソッドが呼ばれているか確認
   - エラーメッセージがないか確認

### ステップ3: ネットワークリクエストの確認

1. **ブラウザの開発者ツール（Networkタブ）を開く**

2. **「インストール」ボタンをクリック**

3. **リクエストを確認**:
   - `GET /api/shopify/install?shop=...&apiKey=...` が送信されているか
   - レスポンスのステータスコード（200 OK、302 Redirectなど）
   - エラーメッセージがないか

### ステップ4: Shopify Partners Dashboardの設定確認

1. **App URLの確認**:
   - `https://fe155b402044.ngrok-free.app`（末尾スラッシュなし）
   - 設定を保存してから数分待つ

2. **Redirect URLsの確認**:
   - `https://fe155b402044.ngrok-free.app/api/shopify/callback`
   - 末尾にスラッシュがないことを確認

### ステップ5: ngrokとフロントエンドの動作確認

1. **ngrokが起動しているか確認**:
   ```powershell
   # ngrokが起動しているか確認
   # 別ターミナルで以下を実行
   ngrok http 3000
   ```

2. **フロントエンドが正しく動作しているか確認**:
   ```powershell
   # ブラウザで以下にアクセス
   https://fe155b402044.ngrok-free.app
   ```
   - フロントエンドが正しく表示されることを確認
   - **200 OK**が返されることを確認（開発者ツールのNetworkタブで確認）

3. **curlでApp URLの応答を確認**:
   ```powershell
   curl -I https://fe155b402044.ngrok-free.app
   ```
   - **200 OK**が返されることを確認
   - リダイレクト（301, 302）が発生していないことを確認

### ステップ6: バックエンドのログ確認

バックエンドのログで以下を確認：

1. **`Install`メソッドが呼ばれているか**:
   ```
   OAuth認証開始. Shop: {shop}, State: {state}, ApiKey: {apiKey}
   ```

2. **リダイレクトURIが正しく生成されているか**:
   ```
   リダイレクトURI生成: FrontendUrl={frontendUrl}, RedirectUri={redirectUri}
   ```

3. **エラーメッセージがないか**:
   - `API Keyが見つかりません`
   - `API Secret not found for the provided API Key`
   - その他のエラーメッセージ

## よくある問題と解決方法

### 問題1: バックエンドのURLが正しく設定されていない

**症状**: フロントエンドからバックエンドへのリクエストが失敗する

**解決方法**:
1. `.env.local`ファイルで`NEXT_PUBLIC_API_URL`を確認
2. バックエンドが起動しているか確認
3. バックエンドのURLが正しいか確認（`https://localhost:7088`）

### 問題2: CORSエラーが発生している

**症状**: ブラウザのコンソールにCORSエラーが表示される

**解決方法**:
1. バックエンドの`appsettings.Development.json`でCORS設定を確認
2. `Cors:AllowedOrigins`にngrok URLが含まれているか確認

### 問題3: Shopify Partners Dashboardの設定が反映されていない

**症状**: App URLを変更したが、エラーが続く

**解決方法**:
1. Shopify Partners Dashboardで設定を保存
2. **数分待つ**（キャッシュがクリアされるまで）
3. 再度インストールを試す

### 問題4: ngrok URLが変わった

**症状**: 以前は動作していたが、突然エラーが発生する

**解決方法**:
1. ngrokのターミナルで現在のURLを確認
2. Shopify Partners Dashboardの設定を更新
3. バックエンドの環境変数を更新
4. バックエンドを再起動

## 確認チェックリスト

- [ ] フロントエンドの`.env.local`で`NEXT_PUBLIC_API_URL`が設定されている
- [ ] バックエンドが起動している（`https://localhost:7088`）
- [ ] ngrokが起動している（`https://fe155b402044.ngrok-free.app`）
- [ ] フロントエンドが`https://fe155b402044.ngrok-free.app`で正しく動作している
- [ ] Shopify Partners DashboardのApp URLが`https://fe155b402044.ngrok-free.app`（末尾スラッシュなし）
- [ ] Shopify Partners DashboardのRedirect URLsに`https://fe155b402044.ngrok-free.app/api/shopify/callback`が登録されている
- [ ] バックエンドの`appsettings.Development.json`で`Frontend:BaseUrl`が`https://fe155b402044.ngrok-free.app`に設定されている
- [ ] ブラウザの開発者ツール（Networkタブ）で`/api/shopify/install`リクエストが送信されている
- [ ] バックエンドのログで`Install`メソッドが呼ばれている
- [ ] バックエンドのログでエラーメッセージがない

## 関連ドキュメント

- [インストールリンク無効エラー調査](./インストールリンク無効エラー調査.md)
- [カスタム配布設定ガイド](../../../../03-feature-development/マルチアプリ対応/カスタム配布設定ガイド.md)
- [インストール時のAPI Key判定方法](../../../../03-feature-development/マルチアプリ対応/インストール時のAPI Key判定方法.md)



