# 404エラー - スコープ取得方法コード確認

## 作成日
2025-12-28

## 目的
ShopifyAppsテーブルとappsettingsのどちらが実際に使用されているか、コードレベルで確認する。

---

## 調査結果サマリー

### ✅ 結論

1. **OAuthフローで使用されるスコープ**: `appsettings.json`または環境変数から取得
2. **ShopifyAppsテーブルのScopesカラム**: **使用されていない**
3. **Shopify Partner Dashboardの設定**: OAuthフローには直接影響しない（インストール画面の表示には影響する可能性）

---

## コードレベルの確認

### 1. OAuthフローでのスコープ取得

**実装箇所**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs` (188行目)

```csharp
// Shopify OAuth URLを構築
var scopes = GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
_logger.LogInformation("OAuth scopes: {Scopes}", scopes);

var authUrl = $"https://{shop}/admin/oauth/authorize" +
    $"?client_id={finalApiKey}" +
    $"&scope={scopes}" +
    $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
    $"&state={state}";
```

**確認結果**:
- ✅ `GetShopifySetting("Scopes")`を使用
- ❌ ShopifyAppsテーブルのScopesカラムは**使用されていない**

---

### 2. GetShopifySettingメソッドの実装

**実装箇所**: `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs` (1600行目)

```csharp
/// <summary>
/// Shopify設定を取得する（環境変数優先）
/// </summary>
private string GetShopifySetting(string key, string defaultValue = "")
{
    var envKey = $"SHOPIFY_{key.Replace(":", "_").ToUpper()}";
    return Environment.GetEnvironmentVariable(envKey) ?? 
           _configuration[$"Shopify:{key}"] ?? 
           defaultValue;
}
```

**優先順位**:
1. **環境変数**: `SHOPIFY_SCOPES`（`SHOPIFY_{key}`形式）
2. **appsettings.json**: `Shopify:Scopes`（`Shopify:{key}`形式）
3. **デフォルト値**: `"read_orders,read_products,read_customers"`

**確認結果**:
- ✅ 環境変数が最優先
- ✅ appsettings.jsonが次に優先
- ❌ ShopifyAppsテーブルは**参照されていない**

---

### 3. ShopifyAppsテーブルのScopesカラムの使用確認

**grep検索結果**:
```bash
grep -r "shopifyApp\.Scopes\|a\.Scopes\|ShopifyApps.*Scopes" backend/
# → 結果: なし
```

**確認結果**:
- ❌ ShopifyAppsテーブルのScopesカラムを直接参照している箇所は**存在しない**
- ❌ OAuthフローでShopifyAppsテーブルのScopesカラムは**使用されていない**

---

### 4. 他の使用箇所での確認

**`ProcessCallbackAsync()`メソッド**（1072行目）:
```csharp
if (string.IsNullOrWhiteSpace(tokenResponse.Scope))
{
    var requestedScopes = GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
    _logger.LogWarning("Shopify応答にscopeが含まれていません. リクエストしたスコープを使用します. Shop: {Shop}, RequestedScopes: {Scopes}", 
        shop, requestedScopes);
    tokenResponse.Scope = requestedScopes;
}
```

**確認結果**:
- ✅ トークン処理でも`GetShopifySetting("Scopes")`を使用
- ❌ ShopifyAppsテーブルのScopesカラムは**使用されていない**

---

## Shopify Partner Dashboardの設定の影響

### インストール画面の表示

**Shopify Partner Dashboardで設定したスコープ**:
- Settings > Access > Scopes
- Settings > Access > Optional scopes
- API Access Requestでの申請状態

**影響範囲**:
- ✅ **インストール画面の表示**: Shopify Partner Dashboardで設定したスコープに基づいて表示される
- ❌ **OAuthフロー**: OAuth URLの`scope`パラメータに含まれるスコープが実際にリクエストされる

**結論**:
- インストール画面に表示されるアクセス権と、実際にリクエストされるスコープが一致しない可能性がある
- 実際にリクエストされるスコープは、`appsettings.json`または環境変数で設定された値

---

## 現在の設定状況

### 検証環境（Development）

**appsettings.Development.json**:
```json
{
  "Shopify": {
    "Scopes": "read_orders,read_products,read_customers"
  }
}
```

**環境変数**: ✅ **設定していない**（確認済み）

**ShopifyAppsテーブル**: `read_all_orders,read_customers,read_orders,read_products`（使用されていない）

**Shopify Partner Dashboard**: Optional scopes未設定

**実際に使用されるスコープ**: `appsettings.json`から取得 → `"read_orders,read_products,read_customers"`

**表示**: "すべての注文詳細" ✅ 表示される

---

### 本番環境（Production）

**appsettings.Production.json**:
```json
{
  "Shopify": {
    "Scopes": "read_orders,read_products,read_customers"
  }
}
```

**環境変数**: ✅ **設定していない**（確認済み）

**ShopifyAppsテーブル**: `read_all_orders,read_customers,read_orders,read_products`（使用されていない）

**Shopify Partner Dashboard**: Optional scopes未設定

**実際に使用されるスコープ**: `appsettings.json`から取得 → `"read_orders,read_products,read_customers"`

**表示**: "すべての注文詳細" ❌ 表示されない

---

## 問題の原因（推測）

### 検証環境で「すべての注文詳細」が表示される理由

**確認済み**:
- ✅ 環境変数: 設定していない
- ✅ appsettings.json: `read_orders,read_products,read_customers`
- ✅ 実際に使用されるスコープ: `read_orders,read_products,read_customers`（`read_all_orders`は含まれない）

**推測される原因**:
- **Shopify側の表示ロジック**: アプリの組織（FUK）や申請状態に基づいて、Shopify側が表示を決定
- OAuth URLの`scope`パラメータ（`read_orders,read_products,read_customers`）とは無関係に表示される
- 「すべての注文範囲を読み込む」の申請状態が、表示に影響している可能性

---

### 本番環境で「すべての注文詳細」が表示されない理由

**確認済み**:
- ✅ 環境変数: 設定していない
- ✅ appsettings.json: `read_orders,read_products,read_customers`
- ✅ 実際に使用されるスコープ: `read_orders,read_products,read_customers`（`read_all_orders`は含まれない）

**推測される原因**:
- **Shopify側の表示ロジック**: アプリの組織（アクセスネット）や申請状態に基づいて、Shopify側が表示を決定
- OAuth URLの`scope`パラメータ（`read_orders,read_products,read_customers`）とは無関係に表示される
- 「すべての注文範囲を読み込む」の申請状態が、表示に影響している可能性
- アプリの組織が異なるため、Shopify側の表示ロジックが異なる可能性

---

## 確認すべき項目

### 1. 環境変数の確認 ✅ 完了

**検証環境**:
- [x] Azure App Serviceの環境変数に`SHOPIFY_SCOPES`が設定されているか → **設定していない**
- [x] 設定値に`read_all_orders`が含まれているか → **該当なし**

**本番環境**:
- [x] Azure App Serviceの環境変数に`SHOPIFY_SCOPES`が設定されているか → **設定していない**
- [x] 設定値に`read_all_orders`が含まれているか → **該当なし**

**結論**: 環境変数による上書きは原因ではない

---

### 2. OAuthフローのログ確認（最優先）

**検証環境**:
- [ ] OAuth URL生成時のログを確認
- [ ] `OAuth scopes: {Scopes}`のログを確認
- [ ] 実際にリクエストされるスコープを記録

**本番環境**:
- [ ] OAuth URL生成時のログを確認
- [ ] `OAuth scopes: {Scopes}`のログを確認
- [ ] 実際にリクエストされるスコープを記録

**確認方法**:
- Application Insightsのログを確認
- または、バックエンドのログファイルを確認

---

## 結論

### 使用されている設定

1. **OAuthフローで使用されるスコープ**: 
   - 環境変数（`SHOPIFY_SCOPES`）または`appsettings.json`（`Shopify:Scopes`）
   - **ShopifyAppsテーブルのScopesカラムは使用されていない**

2. **Shopify Partner Dashboardの設定**:
   - インストール画面の表示に影響する可能性がある
   - OAuthフローには直接影響しない（OAuth URLの`scope`パラメータが優先）

### 推奨対応

1. **環境変数の確認**: 検証環境と本番環境で環境変数が異なるか確認
2. **OAuthフローのログ確認**: 実際にリクエストされるスコープを確認
3. **設定の統一**: 必要に応じて、環境変数または`appsettings.json`を更新

---

## 参考資料

- [アクセス権表示の違い詳細調査](./404エラー-アクセス権表示の違い詳細調査.md)
- [アクセス権表示の違い-調査進捗](./404エラー-アクセス権表示の違い-調査進捗.md)
- [ShopifyAppsテーブルScopes影響調査](./404エラー-ShopifyAppsテーブルScopes影響調査.md)

---

## 更新履歴

- 2025-12-28: 初版作成（スコープ取得方法のコード確認）
- 2025-12-28: 環境変数の確認結果を反映（両環境とも設定していないことを確認）
