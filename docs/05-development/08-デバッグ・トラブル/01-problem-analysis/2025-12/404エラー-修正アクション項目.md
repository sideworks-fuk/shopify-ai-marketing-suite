# 404エラー - 修正アクション項目

## 作成日
2025-12-27

## 概要
OK環境とNG環境の比較結果に基づき、NG環境で修正が必要な項目をまとめました。

---

## 最優先の修正項目

### 1. 環境変数名の確認・統一

**対象**: GitHub Actionsの環境変数設定

**現在の設定**:
- OK環境（production_frontend.yml）: 
  - `secrets.SHOPIFY_API_KEY_PRODUCTION_2`または`vars.SHOPIFY_API_KEY_PRODUCTION_2` = `706a7579...`（後半はマスク）
  - ワークフロー内で`NEXT_PUBLIC_SHOPIFY_API_KEY`にマッピング ✅
- NG環境（develop_frontend.yml）: 
  - `vars.NEXT_PUBLIC_SHOPIFY_API_KEY` = `2d7e0e1f...`（後半はマスク）
  - 直接`NEXT_PUBLIC_SHOPIFY_API_KEY`として使用 ✅

**問題点**:
- フロントエンドのコードは`NEXT_PUBLIC_SHOPIFY_API_KEY`を参照している ✅
- OK環境では`SHOPIFY_API_KEY_PRODUCTION_2`という環境変数名を使用しているが、ワークフロー内で`NEXT_PUBLIC_SHOPIFY_API_KEY`にマッピングしている ✅
- NG環境では`NEXT_PUBLIC_SHOPIFY_API_KEY`という環境変数名を直接使用している ✅
- **環境変数名が異なるが、最終的には`NEXT_PUBLIC_SHOPIFY_API_KEY`に設定されているため、問題ない可能性が高い**

**確認方法**:
- **NG環境（development/staging/production）**: GitHub Environment Variablesに`vars.NEXT_PUBLIC_SHOPIFY_API_KEY`が設定されているか確認
- **OK環境（ec-ranger-prod）**: GitHub Environment Variablesに`secrets.SHOPIFY_API_KEY_PRODUCTION_2`または`vars.SHOPIFY_API_KEY_PRODUCTION_2`が設定されているか確認
- 各環境で正しい値（Client ID）が設定されているか確認
- Azure Static Web Appsの環境変数は使用されない（ビルド時にGitHub Actionsの環境変数が注入される）

**詳細**: [404エラー-GitHub-Actions環境変数比較.md](./404エラー-GitHub-Actions環境変数比較.md) を参照

**修正方法（必要に応じて）**:
- **最優先**: GitHub Environment Variablesの設定を確認
  - NG環境: `vars.NEXT_PUBLIC_SHOPIFY_API_KEY`が設定されているか
  - OK環境: `secrets.SHOPIFY_API_KEY_PRODUCTION_2`または`vars.SHOPIFY_API_KEY_PRODUCTION_2`が設定されているか
- **オプション**: ワークフローを統一（NG環境をOK環境と同じ方式に変更）
  - `develop_frontend.yml`を`production_frontend.yml`と同じ方式に変更
  - トップレベルの`env`で環境変数を定義し、`secrets`を優先して`vars`をフォールバック
- **注意**: Azure Static Web Appsの環境変数は設定不要（GitHub Actions側が有効）

---

### 2. Use legacy install flowの設定を変更

**対象**: NG環境のShopifyアプリ設定（Dev Dashboard）

**現在の設定**:
- `Use legacy install flow: true`

**変更後の設定**:
- `Use legacy install flow: false`（OK環境と同じ）

**理由**: 
- これが最も重要な違いです
- レガシーインストールフローと新しいインストールフローでは、OAuthフローの動作が異なります
- OK環境は`false`で正常に動作しているため、NG環境も同じ設定にする必要があります

**手順**:
1. Shopify Partner Dashboardにログイン
2. NG環境のアプリ（`ECレンジャー(local)`）を選択
3. Dev Dashboardを開く
4. Settings > Access セクションで`Use legacy install flow`を`false`に変更
5. 保存

---

### 3. ShopifyAppsテーブルのRedirectUriを更新

**対象**: NG環境のデータベース（ShopifyAppsテーブル）

**現在の設定**:
- `RedirectUri: (空)`（確認済み）

**更新後の設定**:
- `RedirectUri: https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`（OK環境と同じ形式）

**コードレベルでの影響調査結果**:
- ✅ **現在使用されていない**: `GetRedirectUri()`メソッドは常にバックエンドURLを返すため、`ShopifyApps`テーブルの`RedirectUri`を参照していません
- ✅ **更新してもコードの動作には影響しない**: OAuthフローには影響しません
- ✅ **データの整合性を保つために設定しておくことを推奨**: 将来の拡張性を考慮

**詳細**: [404エラー-ShopifyAppsテーブル影響調査.md](./404エラー-ShopifyAppsテーブル影響調査.md) を参照

**SQL例**:
```sql
UPDATE ShopifyApps
SET RedirectUri = 'https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback'
WHERE ApiKey = '2d7e0e1f...';  -- 後半はマスク
```

**注意**: 
- ShopifyAppsテーブルのRedirectUriは現在の実装では使用されていませんが、データの整合性を保つために設定しておくことを推奨します
- 実際のOAuthフローでは、Shopify Partner DashboardのRedirect URLs設定が使用されます

---

### 4. ShopifyAppsテーブルのAppTypeを更新

**対象**: NG環境のデータベース（ShopifyAppsテーブル）

**現在の設定**:
- `AppType: Public`（テーブル上の値）

**更新後の設定**:
- `AppType: Custom`（OK環境と同じ）

**コードレベルでの影響調査結果**:
- ⚠️ **デバッグエンドポイントでのみ使用**: `DebugShopifyApps()`エンドポイントで返される情報に含まれる
- ✅ **更新してもOAuthフローや認証処理には影響しない**: コードの動作には影響しません
- ✅ **データの整合性を保つために設定しておくことを推奨**: Shopify Partner Dashboardの表示と一致させる

**詳細**: [404エラー-ShopifyAppsテーブル影響調査.md](./404エラー-ShopifyAppsテーブル影響調査.md) を参照

**理由**: 
- Shopify Partner Dashboardでは両方とも「カスタムアプリ」と表示されているため、データベースの値も一致させる必要があります
- データの整合性を保つため

**SQL例**:
```sql
UPDATE ShopifyApps
SET AppType = 'Custom'
WHERE ApiKey = '2d7e0e1f...';  -- 後半はマスク
```

---

## 優先度: 高の修正項目

### 5. Redirect URLsに`/auth/success`を追加、1つ目のURLを修正

**対象**: NG環境のShopifyアプリ設定（Dev Dashboard）

**現在の設定**:
- Redirect URLs:
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net`（ルートURL、パスなし）
  - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`

**修正後の設定**:
- Redirect URLs:
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`（OK環境と同じパス）
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success`（追加）
  - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`（既存）

**理由**: 
- OK環境のRedirect URLsには`/auth/success`が含まれています
- NG環境には含まれていないため、OAuthフロー完了後のリダイレクト先が設定されていない可能性があります
- OK環境の1つ目は`/api/shopify/callback`、NG環境の1つ目はルートURL（パスなし）のため、統一する必要があります

**手順**:
1. Shopify Partner Dashboardにログイン
2. NG環境のアプリ（`ECレンジャー(local)`）を選択
3. Dev Dashboardを開く
4. Settings > Access セクションでRedirect URLsを以下に修正:
   - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`（1つ目を修正）
   - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success`（追加）
   - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`（既存）
5. 保存

---

## 修正後の確認項目

### 1. アプリ設定の確認
- [ ] `Use legacy install flow`が`false`になっている
- [ ] Redirect URLsに`/auth/success`が含まれている
- [ ] Redirect URLsが3つ設定されている（OK環境と同じ）

### 2. データベースの確認
- [ ] ShopifyAppsテーブルのRedirectUriが設定されている
- [ ] ShopifyAppsテーブルのAppTypeが`Custom`になっている

### 3. 動作確認
- [ ] インストールリンクからアプリにアクセスできる
- [ ] OAuthフローが正常に完了する
- [ ] 404エラーが発生しない
- [ ] 認証が正常に完了する

---

## 修正順序の推奨

1. **まず**: 環境変数名の確認・統一（フロントエンドが参照する環境変数名を確認）
2. **次に**: Use legacy install flowを`false`に変更（最も重要）
3. **次に**: ShopifyAppsテーブルのRedirectUriを更新
4. **次に**: ShopifyAppsテーブルのAppTypeを更新
5. **最後に**: Redirect URLsに`/auth/success`を追加

---

## 参考資料

- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)
- [追加確認項目](./404エラー-追加確認項目.md)
- [ShopifyAppsテーブル影響調査](./404エラー-ShopifyAppsテーブル影響調査.md)

---

## 更新履歴

- 2025-12-27: 初版作成（修正アクション項目のまとめ）
