# インストールボタン押下後の動作確認手順

## 問題

デプロイ後、インストールボタンを押しても：
- `/install` にリダイレクトされない
- Storesテーブルにも登録されない

## 確認手順

### ステップ1: ブラウザの開発者ツールを開く

1. ブラウザで `/install` ページを開く
2. **F12** キーを押して開発者ツールを開く
3. **コンソールタブ** と **ネットワークタブ** を開く

### ステップ2: インストールボタンを押す

1. ストアドメインを入力（例: `roomandout`）
2. 「接続を開始」ボタンをクリック

### ステップ3: コンソールログを確認

以下のログが表示されるか確認：

**期待されるログ**:
```
🚀 Shopify接続開始: roomandout.myshopify.com
🔍 ===== OAuth開始デバッグ情報 =====
🔑 API Key (完全): 23f81e22074df1b71fb0a5a495778f49
🔑 API Key (プレビュー): 23f81e22...
🌐 現在のオリジン: https://white-island-08e0a6300.2.azurestaticapps.net
📍 リダイレクト先: https://[バックエンドURL]/api/shopify/install?shop=roomandout.myshopify.com&...
🔄 コールバックURL: https://white-island-08e0a6300.2.azurestaticapps.net/api/shopify/callback
🌍 現在の環境: [環境名]
🖼️ 埋め込みモード: false
🔍 ================================
💾 デバッグ情報をlocalStorageに保存しました
🌐 通常モードでリダイレクト
```

**確認ポイント**:
- `🚀 Shopify接続開始:` ログが表示されているか
- `🔑 API Key (完全):` が正しく表示されているか（`23f81e22074df1b71fb0a5a495778f49`）
- `📍 リダイレクト先:` のURLが正しいか
- エラーメッセージが表示されていないか

### ステップ4: ネットワークタブを確認

**確認ポイント**:
1. **リダイレクトが発生しているか**
   - `/api/shopify/install` へのリクエストが送信されているか
   - ステータスコードは何か（200, 302, 404, 500など）
   - リダイレクト先URLは何か

2. **リダイレクトが発生していない場合**
   - `handleInstall` 関数が実行されているか
   - `window.location.href` が正しく設定されているか
   - JavaScriptエラーが発生していないか

### ステップ5: localStorageを確認

ブラウザのコンソールで以下を実行：

```javascript
// デバッグ情報を確認
const debugInfo = localStorage.getItem('oauth_debug_info');
console.log('デバッグ情報:', JSON.parse(debugInfo));

// タイムスタンプを確認
const timestamp = localStorage.getItem('oauth_debug_timestamp');
console.log('タイムスタンプ:', timestamp);
```

**確認ポイント**:
- `apiKey` が正しく設定されているか
- `installUrl` が正しく生成されているか
- `callbackUrl` が正しいか

### ステップ6: バックエンドのログを確認（可能であれば）

**確認ポイント**:
- `/api/shopify/install` エンドポイントが呼び出されているか
- エラーログが表示されていないか
- OAuth認証URLが正しく生成されているか

## トラブルシューティング

### 問題1: コンソールログが表示されない

**原因**:
- `handleInstall` 関数が実行されていない
- ボタンの `onClick` イベントが正しく設定されていない

**対処法**:
- `/install` ページの `handleInstall` 関数が正しく定義されているか確認
- ボタンの `onClick={handleInstall}` が設定されているか確認

### 問題2: API Keyが表示されない（`未設定` と表示される）

**原因**:
- 環境変数 `NEXT_PUBLIC_SHOPIFY_API_KEY` が設定されていない
- ビルド時に環境変数が正しく読み込まれていない

**対処法**:
- Azure Static Web Appsの環境変数を確認
- GitHub Actionsの環境変数を確認
- ビルドログで環境変数が正しく読み込まれているか確認

### 問題3: リダイレクトが発生しない

**原因**:
- `window.location.href` が正しく設定されていない
- JavaScriptエラーが発生している
- ブラウザのポップアップブロッカーが動作している

**対処法**:
- コンソールでエラーメッセージを確認
- `installUrl` の値を確認
- ブラウザのポップアップブロッカーを無効化

### 問題4: `/api/shopify/install` が404を返す

**原因**:
- バックエンドのURLが間違っている
- バックエンドが起動していない
- ルーティングが正しく設定されていない

**対処法**:
- `config.apiBaseUrl` の値を確認
- バックエンドのURLが正しいか確認
- バックエンドのログを確認

### 問題5: `/api/shopify/install` が500を返す

**原因**:
- バックエンドでエラーが発生している
- 必須パラメータが不足している
- データベース接続エラー

**対処法**:
- バックエンドのログを確認
- エラーメッセージの内容を確認
- 必須パラメータ（`shop`, `apiKey`）が正しく送信されているか確認

## 次のステップ

上記の確認手順を実行し、以下を共有してください：

1. **コンソールログの内容**（特にエラーメッセージ）
2. **ネットワークタブの内容**（`/api/shopify/install` へのリクエストの詳細）
3. **localStorageのデバッグ情報**
4. **バックエンドのログ**（可能であれば）

これらの情報があれば、問題の原因を特定できます。

