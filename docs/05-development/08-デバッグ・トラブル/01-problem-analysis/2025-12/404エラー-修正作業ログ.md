# 404エラー - 修正作業ログ

## 作成日
2025-12-27

## 目的
OK環境とNG環境の差異を修正し、動作確認を行う作業ログ。

---

## 修正順序（推奨）

1. **環境変数名の確認・統一**（フロントエンドが参照する環境変数名を確認）
2. **Use legacy install flowを`false`に変更**（最も重要）
3. **ShopifyAppsテーブルのRedirectUriを更新**
4. **ShopifyAppsテーブルのAppTypeを更新**
5. **Redirect URLsに`/auth/success`を追加**

---

## 作業ログ

### 作業開始
- **開始日時**: 2025-12-27
- **担当**: 福田＋AI Assistant

---

## 修正項目1: 環境変数名の確認・統一

### 確認項目
- [ ] NG環境（development/staging/production）のGitHub Environment Variablesに`vars.NEXT_PUBLIC_SHOPIFY_API_KEY`が設定されているか
- [ ] 値が`2d7e0e1f...`（NG環境のClient ID）であることを確認
- [ ] OK環境（ec-ranger-prod）のGitHub Environment Variablesに`secrets.SHOPIFY_API_KEY_PRODUCTION_2`または`vars.SHOPIFY_API_KEY_PRODUCTION_2`が設定されているか
- [ ] 値が`706a7579...`（OK環境のClient ID）であることを確認

### 作業内容
- [ ] GitHub Environment Variablesの設定を確認
- [ ] 必要に応じて設定を追加・修正

### 結果
- **実施日時**: [記録する]
- **結果**: [成功/失敗]
- **備考**: [記録する]

---

## 修正項目2: Use legacy install flowを`false`に変更

### 対象
- NG環境のShopifyアプリ設定（Dev Dashboard）

### 作業内容
1. [x] Shopify Partner Dashboardにログイン
2. [x] NG環境のアプリ（`ECレンジャー(local)`）を選択
3. [x] Dev Dashboardを開く
4. [x] Settings > Access セクションで`Use legacy install flow`を`false`に変更
5. [x] 保存

### 結果
- **実施日時**: 2025-12-27
- **変更前**: `true`
- **変更後**: `false`
- **結果**: ✅ **成功**
- **備考**: 
  - Use legacy install flowを`false`に変更したことで、404エラーにならずインストールボタンが表示されたことを確認
  - これが最も重要な修正項目であり、問題の根本原因であった可能性が高い

---

## 修正項目3: ShopifyAppsテーブルのRedirectUriを更新

### 対象
- NG環境のデータベース（ShopifyAppsテーブル）

### 作業内容
- [ ] データベースに接続
- [ ] 以下のSQLを実行:
```sql
UPDATE ShopifyApps
SET RedirectUri = 'https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback'
WHERE ApiKey = '2d7e0e1f...';  -- 後半はマスク
```
- [ ] 更新結果を確認

### 結果
- **実施日時**: [記録する]
- **変更前**: `(空)`
- **変更後**: `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`
- **結果**: [成功/失敗]
- **備考**: [記録する]
- **注意**: コードレベルではRedirectUriは使用されていないため、データの整合性のためだけの修正

---

## 修正項目4: ShopifyAppsテーブルのAppTypeを更新

### 対象
- NG環境のデータベース（ShopifyAppsテーブル）

### 作業内容
- [x] データベースに接続
- [x] 以下のSQLを実行:
```sql
UPDATE ShopifyApps
SET AppType = 'Custom'
WHERE ApiKey = '2d7e0e1f...';  -- 後半はマスク
```
- [x] 更新結果を確認

### 結果
- **実施日時**: 2025-12-28
- **変更前**: `Public`
- **変更後**: `Custom`
- **結果**: ✅ **成功**
- **備考**: ShopifyAppsテーブルのAppTypeを`Custom`に更新完了

---

## 修正項目5: Redirect URLsに`/auth/success`を追加、1つ目のURLを修正

### 対象
- NG環境のShopifyアプリ設定（Dev Dashboard）

### 作業内容
1. [x] Shopify Partner Dashboardにログイン
2. [x] NG環境のアプリ（`ECレンジャー(local)`）を選択
3. [x] Dev Dashboardを開く
4. [x] Settings > Access セクションでRedirect URLsを以下に修正:
   - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`（1つ目を修正）
   - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success`（追加）
   - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`（既存）
5. [x] 保存

### 結果
- **実施日時**: 2025-12-28
- **変更前**: 
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net`（ルートURL、パスなし）
  - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`
- **変更後**: 
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/api/shopify/callback`
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/auth/success`
  - `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/callback`
- **結果**: ✅ **成功**
- **備考**: Redirect URLsを3つに設定し、`/auth/success`を追加。OK環境と同じ構成になった

---

## 修正項目6: ShopifyAppsテーブルのScopesを更新

### 対象
- NG環境のデータベース（ShopifyAppsテーブル）

### 作業内容
- [x] データベースに接続
- [x] 以下のSQLを実行:
```sql
UPDATE ShopifyApps
SET Scopes = 'read_all_orders,read_customers,read_orders,read_products'
WHERE ApiKey = '2d7e0e1f...';  -- 後半はマスク
```
- [x] 更新結果を確認

### 結果
- **実施日時**: 2025-12-28
- **変更前**: `read_orders,read_products,read_customers`
- **変更後**: `read_all_orders,read_customers,read_orders,read_products`
- **結果**: ✅ **成功**
- **備考**: ShopifyAppsテーブルのScopesを更新完了。Shopify Partner Dashboardで設定したScopesと一致した
- **注意**: 
  - コードレベルではScopesは使用されていない（`appsettings.json`の`Shopify:Scopes`を使用）
  - データの整合性を保つための修正
  - 将来的にマルチアプリ対応で使用する可能性がある
- **参考**: [ShopifyAppsテーブルScopes影響調査](./404エラー-ShopifyAppsテーブルScopes影響調査.md)

---

## 動作確認

### 確認項目
- [ ] インストールリンクからアプリにアクセスできる
- [ ] OAuthフローが正常に完了する
- [ ] 404エラーが発生しない
- [ ] 認証が正常に完了する
- [ ] Shopify Adminメニューにアプリが表示される

### 確認結果
- **実施日時**: [記録する]
- **結果**: [成功/失敗]
- **備考**: [記録する]

---

## 参考資料

- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)
- [修正アクション項目](./404エラー-修正アクション項目.md)
- [追加確認項目](./404エラー-追加確認項目.md)
- [GitHub Actions環境変数比較](./404エラー-GitHub-Actions環境変数比較.md)
- [ShopifyAppsテーブル影響調査](./404エラー-ShopifyAppsテーブル影響調査.md)
- [ShopifyAppsテーブルScopes影響調査](./404エラー-ShopifyAppsテーブルScopes影響調査.md)

---

## 更新履歴

- 2025-12-27: 初版作成（修正作業ログのテンプレート）
