# 404エラー - ネットワークタブ分析結果

## 作成日
2025-12-28

## 目的
ネットワークタブの情報を分析し、OAuthコールバックが呼ばれない原因を特定する。

---

## 📊 ネットワークタブの分析結果

### 確認できたリクエスト

1. **フロントエンド `/install`ページへのリクエスト**
   - URL: `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net/install?shop=xn-fbkq6e5da0fpb.myshopify.com&host=...&embedded=1&hmac=...&timestamp=...`
   - ステータス: `200 OK`
   - 複数回リクエストされている

2. **JavaScriptファイルの読み込み**
   - `page-391928e33d846934.js`
   - `layout-60bfcfd7c4acac95.js`

3. **エラーまたはキャンセルされたリクエスト**
   - URL: `install?shop=xn-fbkq6e5da0fpb.myshopify.com&apiKey=2d7e0e1f5da14eb9d299aa746738e44b`
   - ステータス: `200 OK`（ただし、リクエストがキャンセルされた可能性）
   - 赤いXマークでエラーまたはキャンセルを示している

---

## 🚨 重要な発見

### 問題1: バックエンド `/api/shopify/install`へのリクエストが見当たらない

**症状**: 
- ネットワークタブにバックエンドの`/api/shopify/install`へのリクエストが表示されていない
- フロントエンドの`/install`ページへのリクエストのみが表示されている

**考えられる原因**:
1. **ExitIframeページからバックエンドへのリダイレクトが発生していない**
   - ExitIframeページで`window.location.href`に設定したURLへのリダイレクトが失敗している
   - ブラウザがリダイレクトをブロックしている
   - CORSエラーが発生している

2. **リダイレクト先のURLが間違っている**
   - ExitIframeページで設定したURLが正しくない
   - バックエンドのURLが間違っている

3. **リダイレクトが発生しているが、ネットワークタブに表示されていない**
   - リダイレクトが発生しているが、別のタブやウィンドウで開かれている
   - リダイレクトがiframe内で発生しているため、ネットワークタブに表示されていない

---

### 問題2: エラーまたはキャンセルされたリクエスト

**症状**: 
- `install?shop=...&apiKey=...`へのリクエストがエラーまたはキャンセルされている
- ステータスコードは`200 OK`だが、リクエストが完了していない

**考えられる原因**:
1. **リクエストがキャンセルされた**
   - ページ遷移によりリクエストがキャンセルされた
   - タイムアウトによりリクエストがキャンセルされた

2. **リクエストが失敗した**
   - ネットワークエラーが発生した
   - サーバーエラーが発生した

---

## 🔍 次の確認事項

### 1. ExitIframeページからのリダイレクトを確認（最優先）

**目的**: ExitIframeページからバックエンドへのリダイレクトが発生しているか確認

**確認方法**:
1. ブラウザのコンソールでExitIframeページのログを確認
2. `window.location.href`に設定されたURLを確認
3. リダイレクトが発生しているか確認

**期待されるログ**:
```
[ExitIframe] 外部URLを検出: 直接リダイレクトを実行
[ExitIframe] window.location.hrefに設定: https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/install?shop=...&apiKey=...
[ExitIframe] 外部URLへのリダイレクトを実行しました
```

**確認ポイント**:
- [ ] ExitIframeページのログが出力されているか
- [ ] `window.location.href`に正しいURLが設定されているか
- [ ] リダイレクトが発生しているか
- [ ] エラーが発生していないか

---

### 2. バックエンド `/api/shopify/install`へのリクエストを確認

**目的**: バックエンドへのリクエストが発生しているか確認

**確認方法**:
1. ネットワークタブで`shopifyapp-backend-develop`を含むリクエストを探す
2. バックエンドログで`/api/shopify/install`へのリクエストを確認
3. リクエストが発生していない場合は、ExitIframeページからのリダイレクトを確認

**期待されるリクエスト**:
```
GET https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/shopify/install?shop=xn-fbkq6e5da0fpb.myshopify.com&apiKey=2d7e0e1f5da14eb9d299aa746738e44b
```

**確認ポイント**:
- [ ] バックエンドへのリクエストが発生しているか
- [ ] リクエストのステータスコードが`302`か
- [ ] レスポンスヘッダーの`Location`が正しいか
- [ ] バックエンドログにリクエストが記録されているか

---

### 3. コンソールログを確認

**目的**: ExitIframeページの処理が正常に完了しているか確認

**確認方法**:
1. ブラウザのコンソールでExitIframeページのログを確認
2. エラーメッセージがないか確認
3. リダイレクト処理が正常に実行されているか確認

**確認ポイント**:
- [ ] ExitIframeページのログが出力されているか
- [ ] エラーメッセージがないか
- [ ] リダイレクト処理が正常に実行されているか

---

## 🚨 考えられる原因と解決策

### 原因1: ExitIframeページからのリダイレクトが失敗している（最優先）

**症状**: 
- ExitIframeページで`window.location.href`に設定したURLへのリダイレクトが失敗している

**考えられる問題**:
- ブラウザがリダイレクトをブロックしている
- CORSエラーが発生している
- URLが正しくない

**解決策**:
1. ExitIframeページのログを確認
2. `window.location.href`に設定されたURLを確認
3. ブラウザのコンソールでエラーを確認
4. 必要に応じて、ExitIframeページのリダイレクト処理を修正

---

### 原因2: リダイレクト先のURLが間違っている

**症状**: 
- ExitIframeページで設定したURLが正しくない

**解決策**:
1. ExitIframeページで設定されたURLを確認
2. バックエンドのURLが正しいか確認
3. URLの構築処理を確認

---

### 原因3: リダイレクトがiframe内で発生している

**症状**: 
- リダイレクトが発生しているが、ネットワークタブに表示されていない

**解決策**:
1. ブラウザの開発者ツールでiframeの内容を確認
2. リダイレクトがiframe内で発生しているか確認
3. 必要に応じて、iframeから脱出する処理を確認

---

## 📋 確認チェックリスト

### ExitIframeページの確認
- [ ] ExitIframeページのログが出力されているか
- [ ] `window.location.href`に正しいURLが設定されているか
- [ ] リダイレクトが発生しているか
- [ ] エラーが発生していないか

### バックエンドの確認
- [ ] バックエンドへのリクエストが発生しているか
- [ ] リクエストのステータスコードが`302`か
- [ ] レスポンスヘッダーの`Location`が正しいか
- [ ] バックエンドログにリクエストが記録されているか

### コンソールログの確認
- [ ] ExitIframeページのログが出力されているか
- [ ] エラーメッセージがないか
- [ ] リダイレクト処理が正常に実行されているか

---

## 参考資料

- [OAuthコールバック未実行-ログ分析結果](./404エラー-OAuthコールバック未実行-ログ分析結果.md)
- [OAuthコールバック未実行調査](./404エラー-OAuthコールバック未実行調査.md)
- [接続開始エラー調査](./404エラー-接続開始エラー調査.md)
- [ExitIframe二重呼び出し問題](./404エラー-ExitIframe二重呼び出し問題.md)

---

## 更新履歴

- 2025-12-28: 初版作成（ネットワークタブ分析結果）
