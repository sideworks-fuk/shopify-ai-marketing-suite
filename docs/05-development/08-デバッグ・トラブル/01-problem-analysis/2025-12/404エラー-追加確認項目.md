# 404エラー - 追加確認項目

## 作成日
2025-12-27

## 目的
修正に入る前に、今後の設定のためにも必要な項目を洗い出し、比較ドキュメントに追加する。

---

## バックエンド（appsettings.json）の確認項目

### 1. 使用しているappsettingsファイル
- **OK環境**: `appsettings.Production.json`
- **NG環境**: `appsettings.Development.json`
- **確認**: 各環境で正しいappsettingsファイルが使用されているか
- **違い**: 異なるappsettingsファイルを使用している

### 2. Authentication設定

#### Authentication.Mode
- **OK環境（Production）**: `OAuthRequired`
- **NG環境（Development）**: `DemoAllowed`
- **確認**: 各環境のappsettings.jsonで確認済み
- **違い**: **認証モードが異なる** ⚠️⚠️⚠️
- **影響**: OK環境はOAuth認証が必須、NG環境はデモモードも許可

#### Authentication.Secret
- **OK環境（Production）**: `"Will be overridden by environment variable"`
- **NG環境（Development）**: `"development-secret-key-replace-in-production"`
- **確認**: OK環境の実際の値（環境変数またはAzure App Serviceの設定）を確認
- **違い**: OK環境は環境変数で上書き、NG環境は固定値

#### Authentication.JwtKey
- **OK環境（Production）**: `"Will be overridden by environment variable"`
- **NG環境（Development）**: [設定なし]
- **確認**: OK環境の実際の値（環境変数またはAzure App Serviceの設定）を確認
- **違い**: OK環境は環境変数で上書き、NG環境は設定なし

#### Authentication.SessionSecret
- **OK環境（Production）**: `"Will be overridden by environment variable"`
- **NG環境（Development）**: [設定なし]
- **確認**: OK環境の実際の値（環境変数またはAzure App Serviceの設定）を確認
- **違い**: OK環境は環境変数で上書き、NG環境は設定なし

### 3. Shopify設定

#### Shopify.ApiKey
- **OK環境（Production）**: `""`（空、環境変数で設定される想定）
- **NG環境（Development）**: `""`（空、環境変数で設定される想定）
- **確認**: 
  - OK環境の実際の値（環境変数またはAzure App Serviceの設定）
  - NG環境の実際の値（環境変数またはAzure App Serviceの設定）
- **違い**: **両方とも空** ✅（環境変数で設定される想定）

#### Shopify.ApiSecret
- **OK環境（Production）**: `""`（空、環境変数で設定される想定）
- **NG環境（Development）**: `""`（空、環境変数で設定される想定）
- **確認**: 
  - OK環境の実際の値（環境変数またはAzure App Serviceの設定）
  - NG環境の実際の値（環境変数またはAzure App Serviceの設定）
- **違い**: **両方とも空** ✅（環境変数で設定される想定）

#### Shopify.EncryptionKey
- **OK環境（Production）**: `""`（空）
- **NG環境（Development）**: `"your-32-byte-base64-encryption-key-for-development"`（開発用の固定値）
- **確認**: 各環境で正しく設定されているか
- **違い**: OK環境は空、NG環境は開発用の固定値

### 4. ConnectionStrings設定

#### ConnectionStrings.DefaultConnection
- **OK環境（Production）**: `""`（空、環境変数で設定される想定）
- **NG環境（Development）**: `Server=tcp:shopify-test-server.database.windows.net,1433;Initial Catalog=shopify-test-db;...`（開発用データベース）
- **確認**: 
  - OK環境の実際の値（環境変数またはAzure App Serviceの設定）
  - NG環境の実際の値（環境変数またはAzure App Serviceの設定）
- **違い**: OK環境は環境変数で上書き、NG環境は開発用データベース

### 5. CORS設定

#### Cors.AllowedOrigins
- **OK環境（Production）**: 
  - `https://white-island-08e0a6300.2.azurestaticapps.net`
  - `https://white-island-08e0a6300.1.azurestaticapps.net`
  - `https://black-flower-004e1de00.2.azurestaticapps.net`
  - `https://black-flower-004e1de00.1.azurestaticapps.net`
- **NG環境（Development）**: 
  - `https://localhost:3000`
  - `http://localhost:3000`
  - `https://fbcf2c79cfbf.ngrok-free.app`
  - `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net`
  - `https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net`
  - `https://brave-sea-038f17a00.1.azurestaticapps.net`
- **確認**: 各環境で正しいフロントエンドURLが含まれているか
- **違い**: 異なるフロントエンドURLが設定されている

### 6. その他の設定

#### Jwt.Key
- **OK環境（Production）**: `"Will be overridden by environment variable"`
- **NG環境（Development）**: `"your-256-bit-secret-key-for-development-only-replace-in-production"`（開発用の固定値）
- **確認**: OK環境の実際の値（環境変数またはAzure App Serviceの設定）を確認
- **違い**: OK環境は環境変数で上書き、NG環境は開発用の固定値

#### ApplicationInsights.ConnectionString
- **OK環境（Production）**: `""`（空）
- **NG環境（Development）**: `""`（空）
- **確認**: 各環境で設定されているか
- **違い**: **両方とも空** ✅

---

## Azure App Service環境変数（バックエンド）の確認項目

### 1. 必須環境変数

#### ASPNETCORE_ENVIRONMENT
- **OK環境**: `Production`
- **NG環境**: `Development`
- **確認**: 各環境で正しく設定されているか
- **違い**: 異なる環境名

#### ConnectionStrings:DefaultConnection
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいデータベース接続文字列が設定されているか

#### Shopify:ApiKey
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいAPI Keyが設定されているか

#### Shopify:ApiSecret
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいAPI Secretが設定されているか

#### Authentication:Secret
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しい認証シークレットが設定されているか

#### Authentication:JwtKey
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいJWTキーが設定されているか

#### Authentication:SessionSecret
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいセッションシークレットが設定されているか

---

## GitHub Actionsワークフローの確認項目

### 1. フロントエンドデプロイワークフロー

#### 環境変数の設定
- **OK環境**: 
  - `NEXT_PUBLIC_API_URL`
  - `SHOPIFY_API_KEY_PRODUCTION_2`（環境変数名が異なる）
- **NG環境**: 
  - `NEXT_PUBLIC_API_URL`
  - `NEXT_PUBLIC_SHOPIFY_API_KEY`
- **確認**: 
  - OK環境で`NEXT_PUBLIC_SHOPIFY_API_KEY`が設定されているか
  - または、ワークフローで`SHOPIFY_API_KEY_PRODUCTION_2`を`NEXT_PUBLIC_SHOPIFY_API_KEY`にマッピングしているか

#### ビルド時の環境変数注入
- **確認**: Next.jsのビルド時に`NEXT_PUBLIC_*`環境変数が正しく注入されているか
- **注意**: `NEXT_PUBLIC_*`環境変数はビルド時に静的に埋め込まれるため、実行時にAzure Static Web Appsで設定されていなくても動作する

### 2. バックエンドデプロイワークフロー

#### 環境変数の設定
- **確認**: 各環境で必要な環境変数が設定されているか
- **確認項目**:
  - `ASPNETCORE_ENVIRONMENT`
  - `ConnectionStrings:DefaultConnection`
  - `Shopify:ApiKey`
  - `Shopify:ApiSecret`
  - `Authentication:Secret`
  - `Authentication:JwtKey`
  - `Authentication:SessionSecret`

---

## データベース設定の確認項目

### 1. 接続文字列
- **OK環境**: [要確認]
- **NG環境**: [要確認]
- **確認**: 各環境で正しいデータベース接続文字列が設定されているか

### 2. ShopifyAppsテーブル
- **確認**: 各環境で正しいレコードが登録されているか
- **確認項目**:
  - `ApiKey`
  - `ApiSecret`
  - `AppUrl`
  - `RedirectUri`
  - `AppType`
  - `IsActive`

---

## その他の確認項目

### 1. Azure Static Web Apps環境変数
- **OK環境**: 環境変数は設定されていない
- **NG環境**: 環境変数は設定されている
- **注意**: 実際にはGitHub Actions側が有効な想定（ビルド時に環境変数が注入される）
- **影響**: Azure Static Web Appsの環境変数はランタイム用であり、Next.jsの`NEXT_PUBLIC_*`環境変数はビルド時に注入されるため、Azure Static Web Appsの環境変数は使用されない可能性

### 2. フロントエンドURL
- **OK環境**: `https://black-flower-004e1de00.2.azurestaticapps.net`
- **NG環境**: `https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net`
- **確認**: 各環境で正しいURLが設定されているか

### 3. バックエンドURL
- **OK環境**: `ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`
- **NG環境**: `shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net`
- **確認**: 各環境で正しいURLが設定されているか

---

## 参考資料

- [OK環境とNG環境の比較](./404エラー-OK環境とNG環境の比較.md)
- [修正アクション項目](./404エラー-修正アクション項目.md)

---

## 更新履歴

- 2025-12-27: 初版作成（追加確認項目のまとめ）
