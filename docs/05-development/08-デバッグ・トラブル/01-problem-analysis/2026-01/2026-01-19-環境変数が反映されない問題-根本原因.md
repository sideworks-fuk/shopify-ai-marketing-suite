# 環境変数が反映されない問題: 根本原因と修正

## 📋 問題概要

**発生日時**: 2026年1月19日  
**環境**: 本番環境（Production）  
**症状**: GitHub Environment Variablesで`NEXT_PUBLIC_API_URL`を`https://ec-ranger-api.access-net.co.jp`に更新したが、フロントエンドが古いURL（`https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`）を使用し続けている

---

## 🔍 根本原因

### 問題点

**GitHub Actionsワークフローファイル（`.github/workflows/production_frontend.yml`）で、`NEXT_PUBLIC_API_URL`が古いURLに直接ハードコードされていた**

### 詳細

1. **GitHub Environment Variablesの設定**
   - `NEXT_PUBLIC_API_URL` = `https://ec-ranger-api.access-net.co.jp` ✅ 正しく設定済み

2. **ワークフローファイルの問題**
   - `production_frontend.yml`の96行目、119行目、142行目で、`NEXT_PUBLIC_API_URL`が直接古いURLにハードコードされていた
   - GitHub Environment Variablesの値が上書きされてしまっていた

**問題のコード（修正前）**:
```yaml
env:
  NEXT_PUBLIC_API_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net'  # ❌ ハードコード
```

**正しいコード（修正後）**:
```yaml
env:
  NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # ✅ GitHub Environment Variablesから取得
```

---

## ✅ 修正内容

### 修正ファイル

`.github/workflows/production_frontend.yml`

### 修正箇所

1. **Production1のデプロイステップ（96行目）**
2. **Production2のデプロイステップ（119行目）**
3. **Production3のデプロイステップ（142行目）**
4. **デプロイサマリー（220行目）**

### 修正内容

**修正前**:
```yaml
NEXT_PUBLIC_API_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net'
```

**修正後**:
```yaml
NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # GitHub Environment Variablesから取得
```

---

## 📊 比較: develop_frontend.yml vs production_frontend.yml

### develop_frontend.yml（正しい実装）

```yaml
env:
  NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # ✅ 環境変数から取得
```

### production_frontend.yml（修正前・問題あり）

```yaml
env:
  NEXT_PUBLIC_API_URL: 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net'  # ❌ ハードコード
```

### production_frontend.yml（修正後）

```yaml
env:
  NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # ✅ 環境変数から取得
```

---

## 🚀 修正後の動作確認

### 1. GitHub Environment Variablesの確認

**確認場所**: GitHub → Settings → Environments → `ec-ranger-prod` → Variables

**確認項目**:
- `NEXT_PUBLIC_API_URL` = `https://ec-ranger-api.access-net.co.jp` ✅

### 2. ワークフローファイルの確認

**確認場所**: `.github/workflows/production_frontend.yml`

**確認項目**:
- `NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}` ✅
- ハードコードされたURLがないことを確認 ✅

### 3. フロントエンドの再デプロイ

1. **GitHub Actionsでフロントエンドを再デプロイ**
   - Actions → Production Frontend Deploy → Run workflow
   - `target_environment`: `Production1`（または`Both`、`All`）
   - `confirm_production`: `YES - 本番環境にデプロイします`

2. **ビルドログの確認**
   - ビルドログで`NEXT_PUBLIC_API_URL`が正しい値（`https://ec-ranger-api.access-net.co.jp`）になっているか確認

3. **デプロイ後の動作確認**
   - ブラウザのキャッシュをクリア（Ctrl+Shift+R）
   - `https://ec-ranger.access-net.co.jp`にアクセス
   - ブラウザのコンソール（F12）で以下を確認：
     ```javascript
     console.log(process.env.NEXT_PUBLIC_API_URL)
     // 期待値: "https://ec-ranger-api.access-net.co.jp"
     ```

---

## 📝 教訓・ベストプラクティス

### 1. 環境変数の管理原則

**❌ 悪い例**: ワークフローファイルに値を直接記述
```yaml
NEXT_PUBLIC_API_URL: 'https://example.com'  # ❌ ハードコード
```

**✅ 良い例**: GitHub Environment Variablesから取得
```yaml
NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}  # ✅ 環境変数から取得
```

### 2. 環境変数の優先順位

1. **GitHub Environment Variables**（推奨）
   - 環境ごとに異なる値を設定可能
   - セキュリティ情報も管理可能
   - 変更時にワークフローファイルの修正が不要

2. **ワークフローファイル内の直接指定**（非推奨）
   - 環境ごとに異なる値を設定する場合、ワークフローファイルが複雑になる
   - 変更時にワークフローファイルの修正が必要
   - バージョン管理に含まれるため、機密情報の管理に注意が必要

### 3. 環境変数の命名規則

- **`vars.*`**: 非機密情報（GitHub Environment Variables）
- **`secrets.*`**: 機密情報（GitHub Secrets）

### 4. デプロイ前の確認チェックリスト

- [ ] GitHub Environment Variablesが正しく設定されている
- [ ] ワークフローファイルで環境変数が正しく参照されている
- [ ] ハードコードされた値がないか確認
- [ ] ビルドログで環境変数が正しく読み込まれているか確認

---

## 🔧 トラブルシューティング

### 環境変数が反映されない場合

1. **GitHub Environment Variablesの確認**
   - 正しい環境（`ec-ranger-prod`）に設定されているか確認
   - 変数名が正確か確認（大文字小文字を区別）

2. **ワークフローファイルの確認**
   - `${{ vars.NEXT_PUBLIC_API_URL }}`の記述が正しいか確認
   - ハードコードされた値がないか確認

3. **ビルドログの確認**
   - GitHub Actionsのビルドログで環境変数が正しく読み込まれているか確認
   - エラーメッセージがないか確認

4. **キャッシュのクリア**
   - ブラウザのキャッシュをクリア
   - Next.jsのビルドキャッシュをクリア（必要に応じて）

---

## 📚 参考情報

### 関連ドキュメント

- [GitHub Actions Environment Variables](https://docs.github.com/en/actions/learn-github-actions/variables)
- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- [Azure Static Web Apps Deployment](https://learn.microsoft.com/en-us/azure/static-web-apps/github-actions-workflow)

### 関連ファイル

- `.github/workflows/production_frontend.yml`（修正済み）
- `.github/workflows/develop_frontend.yml`（参考: 正しい実装例）

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
