# 本番環境URLベースデモモード対応 - 改修可否判断

**作成日**: 2026-01-20  
**対象**: 本番環境でのURLベースデモモード対応の要望

---

## 📋 要望内容

**要望**: 本番環境でもサイトURLによってデモモードでログインできるようにしたい

**背景**: 
- 現在、本番環境ではOAuth認証のみが許可されている
- デモモードは開発環境・ステージング環境でのみ利用可能
- 本番環境でもデモモードを利用したいという要望が上がっている

---

## 🔍 現状の実装確認

### 1. バックエンドの認証制御

#### 現在の設定
- **本番環境**: `appsettings.Production.json`
  ```json
  {
    "Authentication": {
      "Mode": "OAuthRequired"  // OAuth認証のみ許可
    },
    "Demo": {
      "Enabled": true,  // デモ機能自体は有効
      "Password": "dev2025",
      ...
    }
  }
  ```

#### 認証ミドルウェアの制御
- **ファイル**: `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs`
- **制御ロジック**:
  ```csharp
  // 本番環境での安全弁（セキュリティチェック）
  if (environment == "Production" && authMode != "OAuthRequired")
  {
      _logger.LogCritical(
          "SECURITY: Invalid authentication mode for production environment. " +
          "Environment: {Environment}, Mode: {Mode}",
          environment, authMode);
      
      context.Response.StatusCode = 500;
      await context.Response.WriteAsJsonAsync(new
      {
          error = "Configuration Error",
          message = "Production environment must use OAuthRequired mode"
      });
      return;
  }
  ```

**重要な制約**:
- 本番環境では`Authentication:Mode`が`OAuthRequired`以外の場合、アプリが起動できない
- デモモードのエンドポイント（`/api/demo/login`）は存在するが、`OAuthRequired`モードでは使用不可

### 2. フロントエンドの制御

#### 現在の実装
- **ファイル**: `frontend/src/app/page.tsx`
- **制御ロジック**:
  ```typescript
  const authConfig = getAuthModeConfig()
  const isDevelopment = authConfig.environment === 'development'
  const allowsDemo = authConfig.authMode === 'all_allowed' || authConfig.authMode === 'demo_allowed'
  
  if (isDevelopment && allowsDemo && !shop) {
    // 開発環境でデモモードが許可されている場合、認証選択画面へ
    router.replace('/auth/select')
  } else {
    // それ以外の場合はインストールページへ
    router.replace('/install')
  }
  ```

**制約**:
- 本番環境（`isDevelopment = false`）では、デモモードへのリダイレクトが許可されていない
- `/auth/select`ページは存在するが、本番環境では表示されない

---

## ✅ 改修可能性の判断

### 結論: **技術的には可能だが、セキュリティリスクがある**

### 改修可能な理由

1. **デモモード機能は既に実装済み**
   - バックエンド: `/api/demo/login`エンドポイントが存在
   - フロントエンド: `/auth/select`ページと`/demo/login`ページが存在
   - デモモードは`read_only: true`で動作（データ変更不可）

2. **URLベースの制御は実装可能**
   - URLパラメータ（例：`?demo=true`）でデモモードを有効化
   - 特定のパス（例：`/demo/*`）でデモモードを有効化
   - 環境変数で特定のURLパターンを許可

### 改修の課題

1. **バックエンドの制約**
   - 本番環境では`Authentication:Mode`が`OAuthRequired`以外の場合、アプリが起動できない
   - デモモードを使用するには、`Authentication:Mode`を`DemoAllowed`に変更する必要がある
   - **解決策**: URLパターンやホスト名ベースでデモモードを許可する条件分岐を追加

2. **セキュリティリスク**
   - 本番環境でデモモードを許可すると、認証なしでアクセス可能になる
   - デモモードは`read_only: true`だが、データ閲覧は可能
   - **対策**: デモモードへのアクセスを制限（IP制限、パスワード保護、レート制限など）

3. **運用上の懸念**
   - デモモードのパスワード管理
   - デモモードのセッション管理
   - デモモードのログ監視

---

## 🛠️ 実装方法の提案

### 方法1: URLパラメータベース（推奨）

**概要**: 特定のURLパラメータ（例：`?demo=true`）でデモモードを有効化

**実装内容**:

#### フロントエンド
```typescript
// frontend/src/app/page.tsx
const searchParams = useSearchParams()
const demoParam = searchParams?.get('demo')

// デモモードパラメータがある場合、デモモードを許可
if (demoParam === 'true' && !shop) {
  router.replace('/auth/select')
}
```

#### バックエンド
```csharp
// backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs
// URLパラメータでデモモードを許可する条件を追加
var demoParam = context.Request.Query["demo"].FirstOrDefault();
if (demoParam == "true" && authMode == "OAuthRequired")
{
    // デモモードを一時的に許可（本番環境でも）
    // ただし、セキュリティチェックを追加
    // - IP制限
    // - レート制限
    // - パスワード保護
}
```

**メリット**:
- 実装が簡単
- URLパラメータで制御可能
- 既存のデモモード機能を活用

**デメリット**:
- URLパラメータが漏洩するリスク
- セキュリティ対策が必要

### 方法2: サブドメイン/パスベース

**概要**: 特定のサブドメイン（例：`demo.ec-ranger.access-net.co.jp`）やパス（例：`/demo/*`）でデモモードを有効化

**実装内容**:

#### フロントエンド
```typescript
// frontend/src/app/page.tsx
const hostname = typeof window !== 'undefined' ? window.location.hostname : ''
const isDemoSubdomain = hostname.startsWith('demo.')

if (isDemoSubdomain && !shop) {
  router.replace('/auth/select')
}
```

#### バックエンド
```csharp
// backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs
var hostname = context.Request.Host.Host;
if (hostname.StartsWith("demo.") && authMode == "OAuthRequired")
{
    // デモモードを一時的に許可
}
```

**メリット**:
- サブドメインで明確に分離
- セキュリティ設定を分離可能

**デメリット**:
- DNS設定が必要
- 実装が複雑

### 方法3: 環境変数ベース（最も安全）

**概要**: 環境変数で特定のURLパターンを許可

**実装内容**:

#### 環境変数設定
```bash
# Azure App Service 環境変数
NEXT_PUBLIC_DEMO_URL_PATTERN=/demo/*
NEXT_PUBLIC_DEMO_ENABLED=true
```

#### フロントエンド
```typescript
// frontend/src/app/page.tsx
const demoPattern = process.env.NEXT_PUBLIC_DEMO_URL_PATTERN
const demoEnabled = process.env.NEXT_PUBLIC_DEMO_ENABLED === 'true'

if (demoEnabled && pathname.match(demoPattern) && !shop) {
  router.replace('/auth/select')
}
```

#### バックエンド
```csharp
// backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs
var demoPattern = _config["Demo:UrlPattern"];
var demoEnabled = _config.GetValue<bool>("Demo:Enabled");

if (demoEnabled && path.StartsWith(demoPattern) && authMode == "OAuthRequired")
{
    // デモモードを一時的に許可
}
```

**メリット**:
- 環境変数で制御可能
- セキュリティ設定を分離
- 本番環境でも安全に制御可能

**デメリット**:
- 環境変数の管理が必要
- 実装が複雑

---

## 🔒 セキュリティ対策

### 必須対策

1. **IP制限**
   - デモモードへのアクセスを特定のIPアドレスに制限
   - Azure App ServiceのIP制限機能を使用

2. **レート制限**
   - デモモードのログイン試行回数を制限
   - 既存の`RateLimitPerIp`設定を活用

3. **パスワード保護**
   - デモモードのパスワードを強力にする
   - 定期的にパスワードを変更

4. **セッション管理**
   - デモモードのセッションタイムアウトを短く設定
   - セッションの有効期限を監視

5. **ログ監視**
   - デモモードへのアクセスをログに記録
   - 異常なアクセスパターンを検出

### 推奨対策

1. **2要素認証（2FA）**
   - デモモードへのアクセスに2FAを追加

2. **アクセス制限時間**
   - デモモードへのアクセスを特定の時間帯に制限

3. **監査ログ**
   - デモモードでの操作を監査ログに記録

---

## 📊 実装コスト見積もり

### 方法1: URLパラメータベース
- **工数**: 2-3日
- **難易度**: 低
- **セキュリティリスク**: 中

### 方法2: サブドメイン/パスベース
- **工数**: 3-5日
- **難易度**: 中
- **セキュリティリスク**: 低

### 方法3: 環境変数ベース
- **工数**: 4-6日
- **難易度**: 高
- **セキュリティリスク**: 低

---

## 🎯 推奨実装方針

### 推奨: 方法3（環境変数ベース）+ セキュリティ対策

**理由**:
1. **セキュリティ**: 環境変数で制御可能で、最も安全
2. **柔軟性**: URLパターンを環境変数で変更可能
3. **運用性**: 本番環境でも安全に制御可能

**実装ステップ**:
1. 環境変数でデモモードのURLパターンを設定
2. フロントエンドでURLパターンをチェック
3. バックエンドでURLパターンをチェック
4. セキュリティ対策を実装（IP制限、レート制限など）
5. ログ監視を実装

---

## ⚠️ 注意事項

1. **セキュリティリスクの理解**
   - 本番環境でデモモードを許可することは、セキュリティリスクがある
   - 必ずセキュリティ対策を実装すること

2. **運用上の考慮**
   - デモモードのパスワード管理
   - デモモードのセッション管理
   - デモモードのログ監視

3. **既存機能への影響**
   - 既存のOAuth認証フローへの影響を確認
   - 既存のデモモード機能への影響を確認

---

## 📝 次のステップ

1. **要望の詳細確認**
   - デモモードを利用する具体的な用途
   - デモモードへのアクセス制限要件
   - セキュリティ要件

2. **実装方針の決定**
   - 実装方法の選択（方法1/2/3）
   - セキュリティ対策の内容
   - 実装スケジュール

3. **実装開始**
   - 環境変数の設定
   - フロントエンドの実装
   - バックエンドの実装
   - セキュリティ対策の実装
   - テストの実施

---

## 📚 参考資料

- [認証モード制御設定ガイド](../../01-環境構築/認証モード制御設定ガイド.md)
- [Shopify 認証モード制御 実装計画書](../../../03-feature-development/アプリ認証モード制御機能/Shopify-認証モード制御-実装計画.md)
- [認証モード一覧](../../09-認証・セキュリティ/認証モード一覧.md)
