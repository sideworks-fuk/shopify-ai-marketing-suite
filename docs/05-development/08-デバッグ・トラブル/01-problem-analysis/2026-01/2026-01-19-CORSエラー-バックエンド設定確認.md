# CORSエラー: バックエンド設定確認ガイド

## 📋 問題状況

**発生日時**: 2026年1月19日  
**環境**: 本番環境（Production）  
**症状**: フロントエンドからバックエンドへのAPIリクエストでCORSエラーが発生

### エラーメッセージ

```
Access to fetch at 'https://ec-ranger-api.access-net.co.jp/api/store' 
from origin 'https://ec-ranger.access-net.co.jp' 
has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

### 確認済み事項

- ✅ フロントエンドは正しく新しいカスタムドメイン（`https://ec-ranger-api.access-net.co.jp`）を使用している
- ✅ `appsettings.Production.json`に`https://ec-ranger.access-net.co.jp`が含まれている
- ✅ バックエンドはリリース済み

---

## 🔍 考えられる原因

### 1. Azure App Serviceの環境変数でCORS設定が上書きされている（最も可能性が高い）

**問題**: Azure Portalの環境変数で`Cors__AllowedOrigins__0`などが設定されていると、`appsettings.Production.json`の設定が上書きされる可能性があります。

**確認方法**:
1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. `Cors__AllowedOrigins__0`、`Cors__AllowedOrigins__1`などの環境変数を確認
3. これらの環境変数が設定されている場合、`appsettings.Production.json`の設定は無視されます

**解決方法**:
- 環境変数に`https://ec-ranger.access-net.co.jp`を追加する
- または、環境変数を削除して`appsettings.Production.json`の設定を使用する

---

### 2. バックエンドの再デプロイが反映されていない

**問題**: `appsettings.Production.json`の変更がバックエンドに反映されていない可能性があります。

**確認方法**:
1. Azure Portal → App Service → デプロイ → デプロイセンター
2. 最新のデプロイ日時を確認
3. `appsettings.Production.json`の変更日時と比較

**解決方法**:
- バックエンドを再デプロイする
- または、App Serviceを再起動する

---

### 3. 環境変数の形式が正しくない

**問題**: Azure App Serviceでは、配列形式の設定は特殊な形式で設定する必要があります。

**正しい形式**:
```
Cors__AllowedOrigins__0=https://ec-ranger.access-net.co.jp
Cors__AllowedOrigins__1=https://brave-sea-038f17a00.1.azurestaticapps.net
Cors__AllowedOrigins__2=https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net
...
```

**間違った形式**:
```
Cors__AllowedOrigins=https://ec-ranger.access-net.co.jp,https://brave-sea-038f17a00.1.azurestaticapps.net
```

---

## ✅ 確認手順

### ステップ1: Azure Portalで環境変数を確認

1. **Azure Portalにログイン**
   ```
   https://portal.azure.com
   ```

2. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod`

3. **設定 → 構成 → アプリケーション設定を開く**

4. **CORS関連の環境変数を確認**
   - `Cors__AllowedOrigins__0`
   - `Cors__AllowedOrigins__1`
   - `Cors__AllowedOrigins__2`
   - など

5. **確認事項**:
   - 環境変数が設定されているか？
   - `https://ec-ranger.access-net.co.jp`が含まれているか？

---

### ステップ2: 環境変数の設定方法

#### オプションA: 環境変数に追加（推奨）

**Azure Portalで以下を追加**:

```
Cors__AllowedOrigins__0=https://ec-ranger.access-net.co.jp
Cors__AllowedOrigins__1=https://brave-sea-038f17a00.1.azurestaticapps.net
Cors__AllowedOrigins__2=https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net
Cors__AllowedOrigins__3=https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net
Cors__AllowedOrigins__4=https://white-island-08e0a6300.2.azurestaticapps.net
Cors__AllowedOrigins__5=https://white-island-08e0a6300.1.azurestaticapps.net
Cors__AllowedOrigins__6=https://black-flower-004e1de00.2.azurestaticapps.net
Cors__AllowedOrigins__7=https://black-flower-004e1de00.1.azurestaticapps.net
```

**手順**:
1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. 「+ 新規アプリケーション設定」をクリック
3. 上記の環境変数を1つずつ追加
4. 「保存」をクリック
5. App Serviceを再起動

#### オプションB: 環境変数を削除してappsettings.Production.jsonを使用

**注意**: 既存の環境変数を削除すると、`appsettings.Production.json`の設定が使用されます。

**手順**:
1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. `Cors__AllowedOrigins__*`で始まる環境変数を全て削除
3. 「保存」をクリック
4. App Serviceを再起動

---

### ステップ3: App Serviceの再起動

環境変数を変更した後は、**必ずApp Serviceを再起動**してください。

**手順**:
1. Azure Portal → App Service → 概要
2. 「再起動」をクリック
3. 再起動完了を待つ（1〜2分）

---

### ステップ4: 動作確認

1. **ブラウザのキャッシュをクリア**
   - Ctrl+Shift+R（ハードリロード）

2. **フロントエンドにアクセス**
   ```
   https://ec-ranger.access-net.co.jp
   ```

3. **ブラウザのコンソール（F12）で確認**
   - CORSエラーが解消されているか確認
   - APIリクエストが成功しているか確認

---

## 🔧 トラブルシューティング

### 環境変数が反映されない場合

1. **App Serviceを再起動**
   - 環境変数の変更は再起動が必要です

2. **環境変数の形式を確認**
   - `Cors__AllowedOrigins__0`（アンダースコア2つ、数字は0から開始）
   - 大文字小文字を区別します

3. **ログを確認**
   - Azure Portal → App Service → 監視 → ログストリーム
   - 起動時のログでCORS設定が正しく読み込まれているか確認

### CORSエラーが続く場合

1. **バックエンドのログを確認**
   - Azure Portal → App Service → 監視 → ログストリーム
   - CORS関連のエラーログがないか確認

2. **ブラウザのネットワークタブで確認**
   - F12 → Networkタブ
   - リクエストのレスポンスヘッダーを確認
   - `Access-Control-Allow-Origin`ヘッダーが含まれているか確認

3. **バックエンドのコードを確認**
   - `Program.cs`のCORS設定が正しいか確認
   - `app.UseCors("AllowAll")`が正しく呼び出されているか確認

---

## 📝 チェックリスト

### バックエンド設定確認

- [ ] Azure Portalで環境変数を確認した
- [ ] `Cors__AllowedOrigins__*`環境変数が設定されているか確認した
- [ ] `https://ec-ranger.access-net.co.jp`が含まれているか確認した
- [ ] 環境変数を追加/修正した
- [ ] App Serviceを再起動した
- [ ] ログストリームで起動ログを確認した

### 動作確認

- [ ] ブラウザのキャッシュをクリアした
- [ ] フロントエンドにアクセスした
- [ ] ブラウザのコンソールでCORSエラーがないか確認した
- [ ] APIリクエストが成功しているか確認した

---

## 📚 参考情報

### 関連ドキュメント

- [Azure App Service環境変数の設定方法](https://learn.microsoft.com/ja-jp/azure/app-service/configure-common)
- [ASP.NET Core CORS設定](https://learn.microsoft.com/ja-jp/aspnet/core/security/cors)
- [CORSエラー対応ガイド](./2026-01-19-CORSエラー-カスタムドメイン対応.md)

### 関連ファイル

- `backend/ShopifyAnalyticsApi/appsettings.Production.json`
- `backend/ShopifyAnalyticsApi/Program.cs`

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
