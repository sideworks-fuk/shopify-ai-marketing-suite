# 注文日時フィールド - Shopify公式確認結果

**作成日**: 2026-01-20  
**目的**: `createdAt`と`processedAt`の使い分けについて、Shopify公式ドキュメントを確認

---

## 📋 Shopify公式での定義

### `createdAt`（注文作成日時）

- **定義**: 注文がShopify上に作成された日時
- **タイミング**: チェックアウトが完了し、注文レコードが生成された時刻
- **用途**: 注文の発生時点を記録

**参考**: [Shopify GraphQL API - Order.createdAt](https://shopify.dev/docs/api/admin-graphql/latest/objects/Order)

### `processedAt`（注文処理日時）

- **定義**: 注文が「処理された」日時
- **タイミング**: **支払いトランザクション（transaction）が完了した日時**
- **注意**: フルフィルメント（出荷）とは直接関係がない
- **用途**: 売上レポート、財務処理、決済確定時点

**参考**: 
- [Shopify GraphQL API - Order.processedAt](https://shopify.dev/docs/api/admin-graphql/latest/objects/Order)
- [Shopify Community - About Order.processedAt](https://community.shopify.com/c/shopify-apis-and-sdks/about-order-processedat-in-graphql-api/td-p/1326604)

---

## 🔍 重要な違い

### タイミングの違い

| ケース | `createdAt` | `processedAt` |
|--------|-------------|---------------|
| **通常のクレジットカード決済** | チェックアウト完了時 | ほぼ同時（数秒～数分差） |
| **銀行振込・後払い** | チェックアウト完了時 | 入金確定時（数日後になる可能性） |
| **手動決済・与信許可後のキャプチャ** | チェックアウト完了時 | 決済処理完了時（遅延する可能性） |

### 公式ドキュメントの記載

> "Processed" in this context means when the **transaction component of the order was completed**. It is **not related to fulfillment**.

**出典**: [Shopify Community - About Order.processedAt](https://community.shopify.com/c/shopify-apis-and-sdks/about-order-processedat-in-graphql-api/td-p/1326604)

---

## 💡 どちらを使うべきか：ケース別推奨

### `processedAt`を使うべきケース

| 用途 | 理由 |
|------|------|
| **売上レポート・財務レポート** | 支払いが確定した時点を基準とするため |
| **収益計上・会計処理** | 実際に支払いが完了した時点が必要 |
| **決済済み注文のみを対象とする分析** | 未入金・保留注文を除外できる |
| **注文フローと処理時間のモニタリング** | 注文作成から支払い完了までの時間を計測 |

### `createdAt`を使うべきケース

| 用途 | 理由 |
|------|------|
| **注文発生のログ・通知システム** | 注文が入った瞬間に反応するため |
| **在庫ロジック・配送準備** | 注文が作成された時点で処理を開始 |
| **注文の発生時点を記録** | チェックアウト完了時点を正確に記録 |

---

## 🎯 今回のケースでの判断

### 現在の実装状況

- **休眠顧客の判定（最終注文日）**: `createdAt`を使用
- **期間集計/一覧の対象日**: `createdAt`を使用
- **過去データ投入**: Postmanで`processedAt`を任意の過去日時に設定

### 推奨判断

#### オプション1: `processedAt`を使用する（推奨）

**理由**:
1. **分析レポートの標準**: Shopify公式でも`processedAt`が分析レポートで使用される
2. **財務的な正確性**: 支払いが確定した時点を基準とするため、売上レポートに適している
3. **過去データとの整合性**: Postmanで`processedAt`を設定しているため、それに合わせる

**適用範囲**:
- 休眠顧客の判定（最終注文日）→ `processedAt`を優先
- 期間集計/一覧の対象日 → `processedAt`を優先
- 売上レポート → `processedAt`を使用

#### オプション2: 両方を取得し、用途に応じて使い分け

**理由**:
1. **柔軟性**: 用途に応じて最適な日時を選択可能
2. **詳細な分析**: 注文作成から支払い完了までの時間差を分析可能

**実装方針**:
- `ShopifyCreatedAt`: `createdAt`の値
- `ShopifyProcessedAt`: `processedAt`の値（新規追加）
- 分析処理: `ShopifyProcessedAt ?? ShopifyCreatedAt ?? CreatedAt`の優先順位で使用

---

## 📊 Shopify公式の推奨

### GraphQL APIでの使用

Shopify GraphQL APIの`orders`クエリでは、**`processedAt`がデフォルトのソートキー**として使用されることが多い。

**参考**: [Shopify GraphQL API - orders query](https://shopify.dev/docs/api/admin-graphql/unstable/queries/orders)

### 分析レポートでの使用

Shopify公式の分析レポートでは、**`processedAt`を基準**として使用されることが推奨されています。

---

## 🔧 実装推奨事項

### 推奨: `processedAt`を取得・保存し、分析で優先使用

**実装内容**:
1. Shopify Admin GraphQL APIから`processedAt`を取得
2. `Order`エンティティに`ShopifyProcessedAt`フィールドを追加
3. 分析処理で`ShopifyProcessedAt ?? ShopifyCreatedAt ?? CreatedAt`を使用

**メリット**:
- 売上レポートの正確性向上
- 過去データ投入時の期待通りの表示
- Shopify公式の推奨に準拠

---

## 📚 参考リンク

- [Shopify GraphQL API - Order Object](https://shopify.dev/docs/api/admin-graphql/latest/objects/Order)
- [Shopify Community - About Order.processedAt](https://community.shopify.com/c/shopify-apis-and-sdks/about-order-processedat-in-graphql-api/td-p/1326604)
- [Shopify Community - Payment Completion Date](https://community.shopify.dev/t/how-to-get-the-payment-completion-date-from-graphql-orders-api/3204)

---

## ✅ 結論

**今回のケースでは、`processedAt`を使用することを推奨します。**

**理由**:
1. Shopify公式でも分析レポートで`processedAt`が使用される
2. 支払いが確定した時点を基準とするため、財務的な正確性が高い
3. 過去データ投入時に`processedAt`を設定しているため、それに合わせる必要がある

**実装方針**:
- Shopify Admin GraphQL APIから`processedAt`を取得
- `Order`エンティティに`ShopifyProcessedAt`フィールドを追加
- 分析処理で`ShopifyProcessedAt`を優先的に使用
