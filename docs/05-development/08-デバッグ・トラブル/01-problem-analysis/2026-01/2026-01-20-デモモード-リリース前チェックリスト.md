# デモモード ストアドメイン指定機能 - リリース前チェックリスト

**作成日**: 2026-01-20  
**目的**: デモモード実装のリリース前に確認すべき環境変数と設定項目

---

## ✅ 実装完了内容

### バックエンド
- ✅ `DemoLoginRequest`に`ShopDomain`を追加（必須）
- ✅ `DemoAuthService`でストアドメイン必須化とDataType制限を実装
- ✅ `appsettings.json`に`Demo:AllowedDataTypes`を追加
- ✅ `appsettings.Production.json`に`Demo:AllowedDataTypes`を追加

### フロントエンド
- ✅ デモログインページにストアドメイン入力フィールドを追加（必須）
- ✅ アクション列を非表示化（休眠顧客画面）

---

## 🔧 環境変数設定

### バックエンド（Azure App Service）

#### 必須設定（既存）

以下の設定は既に存在するため、追加不要です：

```bash
# 認証設定
Authentication__Mode=DemoAllowed  # ステージング環境
# または
Authentication__Mode=OAuthRequired  # 本番環境（デモモードは無効）

# デモモード基本設定（既存）
Demo__Enabled=true
Demo__Password=dev2025
Demo__PasswordHash=$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
Demo__SessionTimeoutHours=8
Demo__MaxSessionsPerUser=5
Demo__RateLimitPerIp=10
Demo__LockoutThreshold=5
Demo__LockoutDurationMinutes=30
```

#### 🆕 新規追加が必要な設定

**重要**: `Demo:AllowedDataTypes`は`appsettings.json`に追加済みですが、Azure App Serviceの環境変数で上書きする場合は以下の形式で設定してください。

```bash
# デモモードでアクセス可能なDataType（デフォルト: "demo"のみ）
Demo__AllowedDataTypes__0=demo
```

**設定方法**:
1. Azure Portal → App Service → 構成 → アプリケーション設定
2. 新しいアプリケーション設定を追加
3. 名前: `Demo__AllowedDataTypes__0`
4. 値: `demo`

**注意事項**:
- 複数のDataTypeを許可する場合: `Demo__AllowedDataTypes__0=demo`, `Demo__AllowedDataTypes__1=production`（非推奨）
- デフォルトでは`appsettings.json`の設定（`["demo"]`）が使用されます
- 環境変数で設定しない場合、`appsettings.json`の設定が有効になります

### フロントエンド（Azure Static Web Apps）

**追加不要**: フロントエンド側の環境変数は追加不要です。

既存の環境変数で動作します：
- `NEXT_PUBLIC_ENVIRONMENT`（既存）
- `NEXT_PUBLIC_AUTH_MODE`（既存）
- `NEXT_PUBLIC_API_URL`（既存）

---

## 📋 リリース前チェックリスト

### バックエンド

- [ ] `appsettings.json`に`Demo:AllowedDataTypes: ["demo"]`が追加されている
- [ ] `appsettings.Production.json`に`Demo:AllowedDataTypes: ["demo"]`が追加されている
- [ ] Azure App Serviceの環境変数で`Demo__AllowedDataTypes__0=demo`を設定（オプション、`appsettings.json`の設定で十分な場合は不要）
- [ ] デモモード用のストアが`DataType='demo'`で作成されている
- [ ] バックエンドのビルドが成功する
- [ ] デプロイ後、デモログインが正常に動作することを確認

### フロントエンド

- [ ] デモログインページにストアドメイン入力フィールドが表示される
- [ ] ストアドメイン未入力時にエラーメッセージが表示される
- [ ] ストアドメイン入力後にログインが成功する
- [ ] 休眠顧客画面でアクション列が非表示になっている
- [ ] フロントエンドのビルドが成功する
- [ ] デプロイ後、デモログインが正常に動作することを確認

### データベース

- [ ] デモモード用のストアが`DataType='demo'`で作成されている
- [ ] デモモード用のストアが`IsActive=true`になっている
- [ ] デモモード用のストアの`Domain`が正しく設定されている

---

## 🚨 重要な注意事項

### 1. DataType制限について

- **デフォルト設定**: `Demo:AllowedDataTypes: ["demo"]` - `DataType='demo'`のストアのみ許可
- **本番環境での使用**: 本番環境では`Authentication:Mode=OAuthRequired`のため、デモモードは無効です
- **セキュリティ**: `DataType='production'`のストアを許可する設定は非推奨です

### 2. 破壊的変更について

- **ストアドメイン必須化**: 既存のデモログインフローでは、ストアドメインが必須になりました
- **自動選択の削除**: 最初のアクティブなストアを自動選択する機能を削除しました
- **影響範囲**: デモモードを使用している場合は、ストアドメインを入力する必要があります

### 3. デプロイ時の注意

- **バックエンド**: `appsettings.json`の変更がデプロイに含まれていることを確認
- **フロントエンド**: ビルド時にエラーが発生しないことを確認
- **データベース**: デモモード用のストアが`DataType='demo'`で作成されていることを確認

---

## 📝 デプロイ手順

### 1. バックエンドデプロイ

```powershell
# ビルド確認
dotnet build

# デプロイ（GitHub Actions経由または手動）
# Azure App Serviceの環境変数設定（オプション）
# Demo__AllowedDataTypes__0=demo
```

### 2. フロントエンドデプロイ

```powershell
# ビルド確認
npm run build

# デプロイ（GitHub Actions経由または手動）
```

### 3. 動作確認

1. デモログインページにアクセス: `/demo/login`
2. ストアドメイン入力フィールドが表示されることを確認
3. ストアドメイン未入力時にエラーが表示されることを確認
4. 正しいストアドメインとパスワードでログインが成功することを確認
5. 休眠顧客画面でアクション列が非表示になっていることを確認

---

## 🔗 関連ドキュメント

- 実装計画: `docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2026-01/2026-01-20-デモモード-ストアドメイン指定機能-実装計画.md`
- 環境変数設定ガイド: `docs/05-development/01-環境構築/環境変数設定ガイド.md`
