# デプロイスロットを使用した本番デプロイ方法

## 📋 問題概要

**発生日時**: 2026年1月19日  
**環境**: 本番環境（Production）  
**症状**: App Serviceを停止してからデプロイすると反映されるが、本番運用中は停止できない

### 根本原因

実行中のプロセスがDLLファイルをロックしているため、Web Deployでファイルが更新されない。

**解決策**: **デプロイスロット（Deployment Slot）を使用**

---

## 🎯 デプロイスロットとは

デプロイスロットは、App Serviceの別のインスタンスで、本番環境と同じ設定で動作します。

**メリット**:
- ✅ **ダウンタイムなし**: 本番環境を停止せずにデプロイ可能
- ✅ **ロールバック容易**: 問題があれば即座に元に戻せる
- ✅ **事前テスト**: ステージングスロットでテストしてから本番に反映
- ✅ **ファイルロック回避**: 実行中のプロセスがファイルをロックしていても問題なし

---

## 🔧 デプロイスロットの設定

### ステップ1: Azure Portalでデプロイスロットを作成

1. **Azure Portalを開く**
   ```
   https://portal.azure.com
   ```

2. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service: `ec-ranger-backend-prod`

3. **デプロイスロットを作成**
   - 左メニュー → 「デプロイ」→ 「デプロイ スロット」
   - 「+ 追加」をクリック
   - **名前**: `staging`
   - **構成ソース**: 「現在のスロットから複製」（本番環境の設定をコピー）
   - 「追加」をクリック

4. **確認**
   - デプロイスロット一覧に`staging`が表示されることを確認
   - ステータスが「実行中」であることを確認

---

### ステップ2: デプロイスロット用のpublish-profileを取得

1. **ステージングスロットを選択**
   - デプロイスロット一覧で`staging`をクリック

2. **発行プロファイルをダウンロード**
   - 概要 → 「発行プロファイルのダウンロード」
   - `.PublishSettings`ファイルをダウンロード

3. **GitHub Secretsに追加**
   - GitHub → Settings → Secrets and variables → Actions
   - 新しいシークレットを追加:
     - **名前**: `AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`
     - **値**: ダウンロードした`.PublishSettings`ファイルの内容をコピー＆ペースト

---

### ステップ3: Azure CLI認証用のシークレットを設定

スワップ操作にはAzure CLIが必要です。サービスプリンシパルを作成してGitHub Secretsに設定します。

#### 方法1: Azure Portalでサービスプリンシパルを作成（推奨）

1. **Azure Portalを開く**
   ```
   https://portal.azure.com
   ```

2. **Azure Active Directoryを開く**
   - Azure Portal → Azure Active Directory
   - 「アプリの登録」→ 「+ 新規登録」

3. **アプリケーションを登録**
   - **名前**: `github-actions-deploy`（任意）
   - **サポートされているアカウントの種類**: 「この組織ディレクトリのみに含まれるアカウント」
   - 「登録」をクリック

4. **クライアントシークレットを作成**
   - 「証明書とシークレット」→ 「+ 新しいクライアント シークレット」
   - **説明**: `GitHub Actions Deploy`
   - **有効期限**: 24か月（推奨）
   - 「追加」をクリック
   - **値**をコピー（後で参照できないため）

5. **アプリケーション（クライアント）IDをコピー**
   - 「概要」→ 「アプリケーション (クライアント) ID」をコピー

6. **リソースグループへのアクセス権を付与**
   ```powershell
   # サービスプリンシパルにリソースグループへのアクセス権を付与
   az role assignment create \
     --assignee <アプリケーションID> \
     --role "Contributor" \
     --scope /subscriptions/<サブスクリプションID>/resourceGroups/ec-ranger-prod
   ```

7. **GitHub Secretsに追加**
   - GitHub → Settings → Secrets and variables → Actions
   - 新しいシークレットを追加:
     - **名前**: `AZURE_CREDENTIALS`
     - **値**: 以下のJSON形式で設定
     ```json
     {
       "clientId": "<アプリケーションID>",
       "clientSecret": "<クライアントシークレット>",
       "subscriptionId": "<サブスクリプションID>",
       "tenantId": "<テナントID>"
     }
     ```

#### 方法2: Azure CLIでサービスプリンシパルを作成

```powershell
# サービスプリンシパルを作成
az ad sp create-for-rbac \
  --name "github-actions-deploy" \
  --role contributor \
  --scopes /subscriptions/<サブスクリプションID>/resourceGroups/ec-ranger-prod \
  --sdk-auth

# 出力されたJSONをGitHub SecretsのAZURE_CREDENTIALSに設定
```

---

## 🚀 デプロイフロー

### 現在のフロー（問題あり）

```
1. 本番環境に直接デプロイ
   ↓
2. ファイルロックエラー（実行中のプロセスがDLLをロック）
   ↓
3. デプロイが反映されない
```

### 新しいフロー（デプロイスロット使用）

```
1. ステージングスロットにデプロイ
   ↓
2. ステージングスロットでテスト（オプション）
   ↓
3. スワップ（本番 ↔ ステージング）
   ↓
4. 本番環境が最新版になる（ダウンタイムなし）
```

---

## 📝 GitHub Actionsワークフローの修正

### 修正内容

1. **ステージングスロットにデプロイ**
2. **スワップを実行**（本番 ↔ ステージング）

### ワークフローファイルの変更点

```yaml
# ステージングスロットにデプロイ
- name: 🚀 Deploy to Staging Slot
  uses: azure/webapps-deploy@v3
  with:
    app-name: ${{ env.APP_NAME }}
    slot-name: 'staging'  # ステージングスロットにデプロイ
    publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING }}
    package: backend/ShopifyAnalyticsApi/published

# スワップ（本番 ↔ ステージング）
- name: 🔄 Swap slots (Production ↔ Staging)
  uses: azure/CLI@v2
  with:
    azclilogin: true
    inlineScript: |
      az webapp deployment slot swap \
        --resource-group ec-ranger-prod \
        --name ${{ env.APP_NAME }} \
        --slot staging \
        --target-slot production
```

---

## ✅ デプロイ手順

### 前提条件

デプロイスロットを使用するには、以下の設定が必要です：

1. ✅ **デプロイスロットが作成されている**（ステップ1）
2. ✅ **`AZURE_WEBAPP_PUBLISH_PROFILE_PRODUCTION_STAGING`が設定されている**（ステップ2）
3. ✅ **`AZURE_CREDENTIALS`が設定されている**（ステップ3）

**確認方法**:
- GitHub → Settings → Secrets and variables → Actions
- 上記のシークレットが存在することを確認

---

### 自動デプロイ（推奨）

1. **GitHub Actionsでデプロイを実行**
   - Actions → 「Production Backend Deploy」
   - 「Run workflow」をクリック
   - **「YES - 本番環境にデプロイします」**を選択
   - **「YES - デプロイスロットを使用（推奨）」**を選択（デフォルト）
   - 「Run workflow」をクリック

2. **デプロイの確認**
   - ステージングスロットにデプロイされる
   - ステージングスロットでヘルスチェックが実行される
   - スワップが実行される（本番 ↔ ステージング）
   - 本番環境が最新版になる（ダウンタイムなし）

3. **デプロイログの確認**
   - 「🚀 Deploy to Staging Slot」ステップが成功しているか確認
   - 「🔄 Swap slots」ステップが成功しているか確認
   - エラーメッセージがないか確認

---

### 直接デプロイ（非推奨・緊急時のみ）

**注意**: この方法はApp Serviceを停止する必要があり、ダウンタイムが発生します。

1. **GitHub Actionsでデプロイを実行**
   - Actions → 「Production Backend Deploy」
   - 「Run workflow」をクリック
   - **「YES - 本番環境にデプロイします」**を選択
   - **「NO - 直接デプロイ（停止が必要）」**を選択
   - 「Run workflow」をクリック

2. **手動でApp Serviceを停止**
   - Azure Portal → App Service → 概要 → 「停止」
   - デプロイが完了するまで待機

3. **デプロイの確認**
   - デプロイが完了したら、App Serviceを「開始」
   - ファイルが更新されているか確認

### 手動デプロイ（緊急時）

1. **ステージングスロットにデプロイ**
   ```powershell
   # ビルド・発行
   cd backend/ShopifyAnalyticsApi
   dotnet publish -c Release -o ./published
   
   # ステージングスロットにデプロイ（Azure CLI使用）
   az webapp deployment source config-zip \
     --resource-group ec-ranger-prod \
     --name ec-ranger-backend-prod \
     --slot staging \
     --src ./published.zip
   ```

2. **スワップを実行**
   ```powershell
   az webapp deployment slot swap \
     --resource-group ec-ranger-prod \
     --name ec-ranger-backend-prod \
     --slot staging \
     --target-slot production
   ```

---

## 🔄 ロールバック手順

### 問題が発生した場合

1. **即座にロールバック**
   ```powershell
   # 再度スワップ（元に戻す）
   az webapp deployment slot swap \
     --resource-group ec-ranger-prod \
     --name ec-ranger-backend-prod \
     --slot staging \
     --target-slot production
   ```

2. **Azure Portalから**
   - App Service → デプロイ → デプロイ スロット
   - 「スワップ」をクリック
   - 本番 ↔ ステージングを選択
   - 「スワップ」をクリック

---

## 📊 デプロイスロットの確認方法

### Azure Portalで確認

1. **デプロイスロット一覧**
   - App Service → デプロイ → デプロイ スロット
   - 本番スロットとステージングスロットが表示される

2. **デプロイ履歴**
   - 各スロットのデプロイ履歴を確認可能
   - 最新のデプロイ日時を確認

3. **URL確認**
   - 本番: `https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/`
   - ステージング: `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/`

---

## ⚠️ 注意事項

### 1. デプロイスロットのコスト

- **追加コスト**: デプロイスロットは追加のApp Serviceインスタンスとして課金される
- **推奨**: 本番環境のみデプロイスロットを使用（開発環境は不要）

### 2. データベース接続

- デプロイスロットは本番環境と同じデータベースに接続する
- ステージングスロットでテストする際は、本番データベースに影響しないよう注意

### 3. 環境変数の同期

- デプロイスロット作成時に「構成ソース」で「現在のスロットから複製」を選択すると、環境変数もコピーされる
- スワップ時に環境変数もスワップされる（設定可能）

---

## 🔍 トラブルシューティング

### デプロイスロットが作成できない

**原因**: App Serviceプランが「Free」または「Shared」プラン

**解決策**: 
- App Serviceプランを「Basic」以上にアップグレード
- デプロイスロットは「Standard」プラン以上で推奨

### スワップが失敗する

**原因**: 
- デプロイスロットが停止している
- リソースが不足している

**解決策**:
1. デプロイスロットが「実行中」であることを確認
2. App Serviceプランのリソースを確認
3. 再試行

### デプロイが反映されない

**原因**: 
- スワップが実行されていない
- 間違ったスロットにデプロイされている

**解決策**:
1. デプロイスロット一覧で、どのスロットにデプロイされているか確認
2. スワップが実行されているか確認
3. 本番スロットのデプロイ履歴を確認

---

## 📚 参考情報

### 関連ドキュメント

- [Azure App Service デプロイスロット](https://learn.microsoft.com/ja-jp/azure/app-service/deploy-staging-slots)
- [デプロイスロットのスワップ](https://learn.microsoft.com/ja-jp/azure/app-service/deploy-staging-slots#swap-deployment-slots)

### 関連ファイル

- `.github/workflows/production_backend.yml`
- `docs/05-development/08-デバッグ・トラブル/01-problem-analysis/2026-01/2026-01-19-GitHub-Actionsデプロイが反映されない問題.md`

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
