# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸ä¸€è‡´ã®åŸå› ã¨ä¿®æ­£æ¡ˆ

## ğŸ” å•é¡Œã®ç‰¹å®š

### æŒ‡æ‘˜å†…å®¹
- **æœ€çµ‚åŒæœŸ**: JSTã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
- **åŒæœŸå±¥æ­´**: UTCã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§

---

## ğŸ“Š èª¿æŸ»çµæœ

### 1. æœ€çµ‚åŒæœŸæ™‚åˆ»ã®å–å¾—å…ƒ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/database/stats`  
**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Controllers/DatabaseController.cs:368`

```csharp
lastUpdated = DateTime.UtcNow  // âŒ ç¾åœ¨æ™‚åˆ»ï¼ˆUTCï¼‰ã‚’è¿”ã—ã¦ã„ã‚‹
```

**å•é¡Œç‚¹**:
- `Stores.LastSyncDate`ï¼ˆå®Ÿéš›ã®æœ€çµ‚åŒæœŸæ™‚åˆ»ï¼‰ã‚’è¿”ã—ã¦ã„ãªã„
- `DateTime.UtcNow`ï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰ã‚’è¿”ã—ã¦ã„ã‚‹
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§`toLocaleString('ja-JP')`ã§JSTã«å¤‰æ›ã—ã¦ã„ã‚‹

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤º** (`frontend/src/app/setup/initial/page.tsx:538`):
```typescript
new Date(syncStats.lastSyncTime).toLocaleString('ja-JP', {
  month: 'numeric',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
})
```

---

### 2. åŒæœŸå±¥æ­´ã®å–å¾—å…ƒ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/sync/history`  
**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Controllers/SyncController.cs:374-375`

```csharp
startedAt = s.StartDate.ToString("o"),  // ISO 8601å½¢å¼ï¼ˆUTCï¼‰
completedAt = s.EndDate.HasValue ? s.EndDate.Value.ToString("o") : null,
```

**ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: `ToString("o")` = ISO 8601å½¢å¼ï¼ˆä¾‹: `2026-01-22T18:03:47.7052383Z`ï¼‰

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤º** (`frontend/src/app/setup/initial/page.tsx:776`):
```typescript
new Date(history.startTime).toLocaleString('ja-JP')
```

---

## ğŸ¯ å•é¡Œã®åŸå› 

### å•é¡Œ1: æœ€çµ‚åŒæœŸæ™‚åˆ»ãŒç¾åœ¨æ™‚åˆ»ã«ãªã£ã¦ã„ã‚‹

| é …ç›® | ç¾åœ¨ã®å®Ÿè£… | æ­£ã—ã„å®Ÿè£… |
|------|----------|----------|
| **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹** | `DateTime.UtcNow`ï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰ | `Stores.LastSyncDate`ï¼ˆå®Ÿéš›ã®æœ€çµ‚åŒæœŸæ™‚åˆ»ï¼‰ |
| **è¡¨ç¤º** | JSTã«å¤‰æ›ã—ã¦è¡¨ç¤º | JSTã«å¤‰æ›ã—ã¦è¡¨ç¤º |

**çµæœ**: æœ€çµ‚åŒæœŸæ™‚åˆ»ãŒå¸¸ã«ã€Œç¾åœ¨æ™‚åˆ»ã€ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹

---

### å•é¡Œ2: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ã®ä¸€è²«æ€§

| é …ç›® | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ |
|------|------------|--------------|
| **æœ€çµ‚åŒæœŸ** | UTCï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰ | JSTã«å¤‰æ› âœ… |
| **åŒæœŸå±¥æ­´** | UTCï¼ˆISO 8601ï¼‰ | JSTã«å¤‰æ› âœ… |

**çµè«–**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®å¤‰æ›ã¯ä¸€è²«ã—ã¦ã„ã‚‹ãŒã€**æœ€çµ‚åŒæœŸæ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒé–“é•ã£ã¦ã„ã‚‹**

---

## ğŸ”§ ä¿®æ­£æ¡ˆ

### ä¿®æ­£1: `/api/database/stats`ã§`Stores.LastSyncDate`ã‚’è¿”ã™

**ä¿®æ­£ç®‡æ‰€**: `backend/ShopifyAnalyticsApi/Controllers/DatabaseController.cs:368`

```csharp
// ä¿®æ­£å‰
lastUpdated = DateTime.UtcNow

// ä¿®æ­£å¾Œ
lastUpdated = store.LastSyncDate?.ToString("o") ?? null
```

**å®Œå…¨ãªä¿®æ­£ã‚³ãƒ¼ãƒ‰**:

```csharp
var store = await _context.Stores.FindAsync(storeId);
if (store == null)
{
    return NotFound(new { error = "Store not found" });
}

return Ok(new
{
    success = true,
    data = new
    {
        customers = customerCount,
        orders = orderCount,
        products = productCount,
        orderItems = orderItemCount,
        totalRevenue,
        averageOrderValue,
        lastUpdated = store.LastSyncDate?.ToString("o") ?? null  // ğŸ†• ä¿®æ­£
    },
    timestamp = DateTime.UtcNow
});
```

---

### ä¿®æ­£2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®nullãƒã‚§ãƒƒã‚¯è¿½åŠ 

**ä¿®æ­£ç®‡æ‰€**: `frontend/src/app/setup/initial/page.tsx:538`

```typescript
// ä¿®æ­£å‰
{syncStats.lastSyncTime ? new Date(syncStats.lastSyncTime).toLocaleString('ja-JP', {
  month: 'numeric',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
}).replace(/\//g, '/') : 'æœªåŒæœŸ'}

// ä¿®æ­£å¾Œï¼ˆnullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼‰
{syncStats.lastSyncTime && syncStats.lastSyncTime !== 'null' 
  ? new Date(syncStats.lastSyncTime).toLocaleString('ja-JP', {
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).replace(/\//g, '/') 
  : 'æœªåŒæœŸ'}
```

---

## ğŸ“ ä¿®æ­£å¾Œã®æœŸå¾…çµæœ

### ä¿®æ­£å‰

| é …ç›® | è¡¨ç¤ºå€¤ | å®Ÿéš›ã®å€¤ |
|------|--------|---------|
| **æœ€çµ‚åŒæœŸ** | ç¾åœ¨æ™‚åˆ»ï¼ˆJSTï¼‰ | `DateTime.UtcNow` âŒ |
| **åŒæœŸå±¥æ­´** | `2026-01-22 18:03:47`ï¼ˆJSTï¼‰ | `2026-01-22T18:03:47Z`ï¼ˆUTCï¼‰â†’ JSTå¤‰æ› âœ… |

### ä¿®æ­£å¾Œ

| é …ç›® | è¡¨ç¤ºå€¤ | å®Ÿéš›ã®å€¤ |
|------|--------|---------|
| **æœ€çµ‚åŒæœŸ** | `2026-01-22 18:20:01`ï¼ˆJSTï¼‰ | `Stores.LastSyncDate`ï¼ˆUTCï¼‰â†’ JSTå¤‰æ› âœ… |
| **åŒæœŸå±¥æ­´** | `2026-01-22 18:03:47`ï¼ˆJSTï¼‰ | `SyncStatuses.StartDate`ï¼ˆUTCï¼‰â†’ JSTå¤‰æ› âœ… |

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- æœ€çµ‚åŒæœŸæ™‚åˆ»ã¨åŒæœŸå±¥æ­´ã®æœ€æ–°æ™‚åˆ»ãŒä¸€è‡´ã™ã‚‹ï¼ˆã¾ãŸã¯è¿‘ã„å€¤ã«ãªã‚‹ï¼‰
- ä¸¡æ–¹ã¨ã‚‚JSTã§è¡¨ç¤ºã•ã‚Œã‚‹

---

## ğŸ” ç¢ºèªç”¨SQL

ä¿®æ­£å¾Œã€ä»¥ä¸‹ã®SQLã§æ•´åˆæ€§ã‚’ç¢ºèª:

```sql
-- æœ€çµ‚åŒæœŸæ™‚åˆ»ã¨åŒæœŸå±¥æ­´ã®æœ€æ–°æ™‚åˆ»ã‚’æ¯”è¼ƒ
SELECT 
    s.Id AS StoreId,
    s.Name AS StoreName,
    s.LastSyncDate AS Stores_LastSyncDate,
    MAX(ss.EndDate) AS SyncStatuses_LatestEndDate,
    -- æ™‚åˆ»å·®ï¼ˆç§’ï¼‰
    CASE 
        WHEN s.LastSyncDate IS NOT NULL AND MAX(ss.EndDate) IS NOT NULL 
        THEN ABS(DATEDIFF(SECOND, s.LastSyncDate, MAX(ss.EndDate)))
        ELSE NULL
    END AS TimeDifferenceSeconds,
    -- JSTå¤‰æ›å¾Œã®è¡¨ç¤ºï¼ˆå‚è€ƒï¼‰
    FORMAT(s.LastSyncDate AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time', 'yyyy-MM-dd HH:mm:ss') AS LastSyncDate_JST,
    FORMAT(MAX(ss.EndDate) AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time', 'yyyy-MM-dd HH:mm:ss') AS LatestEndDate_JST
FROM Stores s
LEFT JOIN SyncStatuses ss ON s.Id = ss.StoreId
WHERE s.Id = 19
GROUP BY s.Id, s.Name, s.LastSyncDate;
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `backend/ShopifyAnalyticsApi/Controllers/DatabaseController.cs` (368è¡Œç›®)
- `frontend/src/app/setup/initial/page.tsx` (538è¡Œç›®, 167è¡Œç›®)
- `backend/ShopifyAnalyticsApi/Controllers/SyncController.cs` (374-375è¡Œç›®)

---

## ğŸ“ æ›´æ–°å±¥æ­´

- 2026-01-23: åˆç‰ˆä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸ä¸€è‡´ã®åŸå› ã¨ä¿®æ­£æ¡ˆï¼‰
