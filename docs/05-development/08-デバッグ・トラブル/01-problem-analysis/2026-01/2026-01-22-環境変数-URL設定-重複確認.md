# 環境変数 URL設定 重複確認

**作成日**: 2026-01-22  
**目的**: `NEXT_PUBLIC_FRONTEND_URL`, `NEXT_PUBLIC_SHOPIFY_APP_URL`, `NEXT_PUBLIC_SHOPIFY_APP_STORE_URL` の使用状況と重複の確認

---

## 📋 各環境変数の使用状況

### 1. `NEXT_PUBLIC_FRONTEND_URL`

#### 使用箇所

**① `frontend/src/lib/config/validation.ts` (175-194行目)**
```typescript
export function getFrontendUrl(): string {
  const url = process.env.NEXT_PUBLIC_FRONTEND_URL || 
              process.env.FRONTEND_URL;
  
  if (!url) {
    throw new Error(
      'Frontend URL is not configured. ' +
      'Please set NEXT_PUBLIC_FRONTEND_URL or FRONTEND_URL environment variable.'
    );
  }
  // ...
}
```
- **用途**: フロントエンドURLの取得（必須チェックあり）
- **使用箇所**: `validateEnvironmentConfig()` 関数内（25行目）

**② `frontend/src/app/api/shopify/callback/route.ts` (70-71行目)**
```typescript
const appUrl = process.env.NEXT_PUBLIC_SHOPIFY_APP_URL || 
               process.env.NEXT_PUBLIC_FRONTEND_URL;
```
- **用途**: OAuthコールバック後のリダイレクトURL生成
- **優先順位**: **2位**（`NEXT_PUBLIC_SHOPIFY_APP_URL` のフォールバック）

**③ `frontend/src/app/dev-bookmarks/page.tsx` (745行目)**
```typescript
<div><span className="font-medium">開発環境:</span> {process.env.NEXT_PUBLIC_FRONTEND_URL || 'http://localhost:3000'}</div>
```
- **用途**: 開発者ツール画面での表示用

**④ `frontend/src/app/dev/oauth-config-test/page.tsx` (359行目)**
```typescript
"BaseUrl": "${process.env.NEXT_PUBLIC_FRONTEND_URL || 'http://localhost:3000'}"
```
- **用途**: OAuth設定テスト画面での表示用

---

### 2. `NEXT_PUBLIC_SHOPIFY_APP_URL`

#### 使用箇所

**① `frontend/src/app/api/shopify/callback/route.ts` (70行目)**
```typescript
const appUrl = process.env.NEXT_PUBLIC_SHOPIFY_APP_URL || 
               process.env.NEXT_PUBLIC_FRONTEND_URL;
```
- **用途**: OAuthコールバック後のリダイレクトURL生成
- **優先順位**: **1位**（最優先）

**② `frontend/env.sample` (55行目)**
```env
# Shopify App URL（埋め込みアプリとして動作する場合）
# 開発環境: ngrokなどのトンネリングサービスのURL
# 本番環境: Azure Static Web AppsのURL
NEXT_PUBLIC_SHOPIFY_APP_URL=https://your-ngrok-url.ngrok-free.app
```
- **用途**: 環境変数サンプルファイルでの説明

---

### 3. `NEXT_PUBLIC_SHOPIFY_APP_STORE_URL`

#### 使用箇所

**① `frontend/src/constants/shopify.ts` (10-11行目)**
```typescript
export const SHOPIFY_APP_STORE_URL = 
  process.env.NEXT_PUBLIC_SHOPIFY_APP_STORE_URL || '';
```
- **用途**: Shopify App Store URL（公開アプリの場合）
- **使用箇所**: 定数としてエクスポート（実際の使用箇所は未確認）

**② `frontend/env.sample` (59行目)**
```env
# Shopify App Store URL（公開アプリの場合）
# 本番環境: 実際のApp Store URLを設定
# NEXT_PUBLIC_SHOPIFY_APP_STORE_URL=https://apps.shopify.com/ec-ranger
```
- **用途**: 環境変数サンプルファイルでの説明

---

## 🔍 重複の分析

### `NEXT_PUBLIC_FRONTEND_URL` vs `NEXT_PUBLIC_SHOPIFY_APP_URL`

**重複状況**: ⚠️ **部分的に重複**

**理由**:
1. **同じ用途**: どちらもフロントエンドのURLを表す
2. **優先順位**: `NEXT_PUBLIC_SHOPIFY_APP_URL` が優先され、`NEXT_PUBLIC_FRONTEND_URL` はフォールバック
3. **実質的に同じ値**: Shopify埋め込みアプリとして動作する場合、両者は同じURLを指すことが多い

**違い**:
- `NEXT_PUBLIC_SHOPIFY_APP_URL`: Shopify埋め込みアプリ専用のURL（ngrok URLなど）
- `NEXT_PUBLIC_FRONTEND_URL`: 一般的なフロントエンドURL（より汎用的）

**推奨**:
- **統合可能**: `NEXT_PUBLIC_SHOPIFY_APP_URL` に統一し、`NEXT_PUBLIC_FRONTEND_URL` を削除することを検討
- **ただし**: `validation.ts` の `getFrontendUrl()` 関数が `NEXT_PUBLIC_FRONTEND_URL` を必須チェックしているため、削除する場合は修正が必要

---

### `NEXT_PUBLIC_SHOPIFY_APP_STORE_URL`

**重複状況**: ✅ **重複なし**

**理由**:
- **異なる用途**: Shopify App Store URL（`https://apps.shopify.com/ec-ranger` など）
- **フロントエンドURLとは別物**: アプリのストアページのURL

**結論**: この環境変数は保持すべき

---

## 🎯 推奨される対応

### オプション1: `NEXT_PUBLIC_FRONTEND_URL` を削除（推奨）

**理由**:
- `NEXT_PUBLIC_SHOPIFY_APP_URL` が優先的に使用されている
- 実質的に同じURLを指すことが多い
- 環境変数の数を減らせる

**必要な修正**:
1. `frontend/src/lib/config/validation.ts` の `getFrontendUrl()` 関数を修正
   - `NEXT_PUBLIC_SHOPIFY_APP_URL` を優先的に使用
   - `NEXT_PUBLIC_FRONTEND_URL` をフォールバックとして使用（後方互換性のため）
2. `frontend/src/app/dev-bookmarks/page.tsx` を修正
   - `NEXT_PUBLIC_SHOPIFY_APP_URL` を使用
3. `frontend/src/app/dev/oauth-config-test/page.tsx` を修正
   - `NEXT_PUBLIC_SHOPIFY_APP_URL` を使用
4. `.env.local` から `NEXT_PUBLIC_FRONTEND_URL` を削除

### オプション2: 現状維持（後方互換性を重視）

**理由**:
- 既存の設定を壊さない
- `NEXT_PUBLIC_FRONTEND_URL` が他の場所で使用されている可能性

**対応**:
- 現状のまま維持
- ドキュメントで `NEXT_PUBLIC_SHOPIFY_APP_URL` を推奨として明記

---

## ✅ 結論

### 重複している環境変数
- ✅ `NEXT_PUBLIC_FRONTEND_URL` と `NEXT_PUBLIC_SHOPIFY_APP_URL` は重複

### 重複していない環境変数
- ✅ `NEXT_PUBLIC_SHOPIFY_APP_STORE_URL` は別用途（App Store URL）

### 推奨アクション
1. **短期**: `NEXT_PUBLIC_SHOPIFY_APP_URL` を優先的に使用し、`NEXT_PUBLIC_FRONTEND_URL` はフォールバックとして維持
2. **長期**: `NEXT_PUBLIC_FRONTEND_URL` を削除し、`NEXT_PUBLIC_SHOPIFY_APP_URL` に統一

---

## 🔗 関連ファイル

- `frontend/src/lib/config/validation.ts` - 環境変数検証
- `frontend/src/app/api/shopify/callback/route.ts` - OAuthコールバック処理
- `frontend/src/constants/shopify.ts` - Shopify定数
- `frontend/src/app/dev-bookmarks/page.tsx` - 開発者ツール画面
- `frontend/src/app/dev/oauth-config-test/page.tsx` - OAuth設定テスト画面
- `frontend/env.sample` - 環境変数サンプルファイル
