# デモモード ストアドメイン指定機能 実装計画

**作成日**: 2026-01-20  
**最終更新**: 2026-01-20  
**目的**: 本番環境にインストール済みのお客様のデータを、許可を得た上で閲覧モードで確認する機能

---

## 🔒 セキュリティ強化の要約

### 主な変更点

1. **ストアドメイン必須化**
   - 従来: 最初のアクティブなストアを自動選択（セキュリティリスク）
   - 変更後: ストアドメイン入力を必須化（明示的なストア指定）

2. **DataType制限の追加**
   - 従来: `DataType`に関係なく、`IsActive = true`なら選択可能
   - 変更後: `Demo:AllowedDataTypes`設定で許可する`DataType`のみ許可（デフォルト: `"demo"`のみ）

3. **セキュリティ向上**
   - 意図しないストアへのアクセスを防止
   - 本番環境のストアへのアクセスを制限
   - ログ記録の強化

---

## 📋 現状の確認

### 1. デモログイン時のストア選択ロジック

**実装箇所**: `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs` (180-195行目)

```csharp
// データベースから最初のアクティブなストアを取得
var firstActiveStore = await _dbContext.Stores
    .Where(s => s.IsActive)
    .OrderBy(s => s.Id)
    .Select(s => new { s.Id, s.Domain, s.TenantId })
    .FirstOrDefaultAsync();
```

**動作**:
- `IsActive = true`のストアを`Id`の昇順で取得
- 最初のストア（最小の`Id`）を自動選択
- StoreId 16が選ばれているのは、これが最初のアクティブなストアだから

**重要なポイント**:
- `DataType`は関係ない（`production`でも`demo`でも、`IsActive = true`なら選択される）
- セッションに`store_id`クレームが含まれ、APIリクエスト時に使用される

### 2. セッション管理

**実装箇所**: `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs` (349-383行目)

```csharp
private string GenerateDemoToken(DemoSession session, int storeId, string? shopDomain, string? tenantId)
{
    // ...
    new Claim("store_id", storeId.ToString()), // データベースから取得した実際のストアID
    new Claim("shop_domain", shopDomain ?? "demo-shop.myshopify.com")
    // ...
}
```

**動作**:
- デモトークンに`store_id`と`shop_domain`クレームが含まれる
- フロントエンドの`localStorage`に保存され、APIリクエスト時に使用される

### 3. 現在の問題

**問題**: 
- デモログイン時にストアを選択できない
- 常に最初のアクティブなストア（StoreId 16）が選ばれる
- 特定のストアのデータを閲覧したい場合、そのストアが最初のアクティブなストアでないと閲覧できない
- **セキュリティリスク**: 最初のアクティブなストアを自動選択するのは危険（意図しないストアへのアクセス）

---

## 🎯 実装目標

### 要望内容

**目的**: 本番環境にインストール済みのお客様のデータを、許可を得た上で閲覧モードで確認したい

**要件**:
1. **パスワードとストアドメインを入力してログイン（ストアドメインは必須）**
2. ストアドメインからStoreIdを取得
3. そのストアで閲覧モード（読み取り専用）でデータ参照
4. **DataTypeによる制限（デモモードでアクセス可能なストアを制限）**

### 実装方針

1. **フロントエンド**: デモログインページにストアドメイン入力フィールドを追加（必須）
2. **バックエンド**: ストアドメインからStoreIdを取得する機能を追加
3. **認証サービス**: ストアドメインを必須にし、DataTypeによる制限を追加
4. **セキュリティ**: DataType='demo'のストアのみ許可、または設定可能にする

---

## 🛠️ 実装内容

### 1. バックエンド実装

#### 1.1. `DemoLoginRequest`の拡張

**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs`

```csharp
/// <summary>
/// デモログインリクエスト
/// </summary>
public class DemoLoginRequest
{
    public string Password { get; set; } = string.Empty;
    public string ShopDomain { get; set; } = string.Empty; // 🆕 ストアドメイン（必須）
}
```

**変更点**:
- `ShopDomain`を`string?`から`string`に変更（必須化）
- 空文字列チェックを追加

#### 1.2. `IDemoAuthService`インターフェースの拡張

**ファイル**: `backend/ShopifyAnalyticsApi/Services/IDemoAuthService.cs`

```csharp
public interface IDemoAuthService
{
    Task<DemoAuthResult> AuthenticateAsync(string password, string? ipAddress, string? userAgent);
    // 🆕 ストアドメイン指定版を追加
    Task<DemoAuthResult> AuthenticateAsync(string password, string? shopDomain, string? ipAddress, string? userAgent);
    // ... 既存のメソッド
}
```

#### 1.3. `DemoAuthService`の実装変更

**ファイル**: `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs`

**変更内容**:

```csharp
/// <summary>
/// デモ認証を実行（ストアドメイン必須、DataType制限対応）
/// </summary>
public async Task<DemoAuthResult> AuthenticateAsync(string password, string shopDomain, string? ipAddress, string? userAgent)
{
    // ... 既存のパスワード検証ロジック ...

    // 🔒 セキュリティ: ストアドメインは必須
    if (string.IsNullOrWhiteSpace(shopDomain))
    {
        _logger.LogWarning("Shop domain is required for demo authentication");
        return new DemoAuthResult
        {
            Success = false,
            Error = "ストアドメインは必須です"
        };
    }

    // ドメインの正規化（https://, http://, 末尾の/を削除）
    var normalizedDomain = shopDomain.Trim()
        .Replace("https://", "")
        .Replace("http://", "")
        .Split('/')[0]
        .ToLower();

    // 🔒 セキュリティ: DataTypeによる制限を確認
    // appsettings.jsonで許可するDataTypeを設定可能にする
    var allowedDataTypes = _config.GetSection("Demo:AllowedDataTypes")
        .Get<string[]>() ?? new[] { "demo" }; // デフォルトは"demo"のみ許可

    // ストアを取得（IsActive = true、DataType制限、ドメイン/名前一致）
    var targetStore = await _dbContext.Stores
        .Where(s => s.IsActive && 
                   allowedDataTypes.Contains(s.DataType) && // 🔒 DataType制限
                   (s.Domain != null && s.Domain.ToLower() == normalizedDomain ||
                    s.Name.ToLower() == normalizedDomain))
        .FirstOrDefaultAsync();

    if (targetStore == null)
    {
        _logger.LogWarning(
            "Store not found or not allowed for demo mode. Domain: {ShopDomain}, AllowedDataTypes: {AllowedDataTypes}", 
            shopDomain, string.Join(", ", allowedDataTypes));
        return new DemoAuthResult
        {
            Success = false,
            Error = $"ストアが見つかりません、またはデモモードでアクセスできません: {shopDomain}"
        };
    }

    _logger.LogInformation(
        "Store found for demo authentication. Domain: {ShopDomain}, StoreId: {StoreId}, DataType: {DataType}", 
        shopDomain, targetStore.Id, targetStore.DataType);

    // トークン生成（選択されたストアを使用）
    var token = GenerateDemoToken(session, targetStore.Id, targetStore.Domain, targetStore.TenantId);

    // ... 既存の成功処理 ...
}
```

**重要な変更点**:
1. **ストアドメイン必須化**: `shopDomain`を必須パラメータに変更
2. **DataType制限**: `Demo:AllowedDataTypes`設定で許可するDataTypeを制限
3. **デフォルト制限**: デフォルトでは`DataType='demo'`のストアのみ許可
4. **セキュリティ向上**: 最初のアクティブなストアを自動選択するロジックを削除

#### 1.4. `DemoAuthController`の変更

**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs`

```csharp
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] DemoLoginRequest request)
{
    // ... 既存の検証ロジック ...

    // 🔒 セキュリティ: ストアドメイン必須チェック
    if (string.IsNullOrWhiteSpace(request.ShopDomain))
    {
        return BadRequest(new
        {
            error = "Bad Request",
            message = "ストアドメインは必須です"
        });
    }

    // 🆕 ストアドメイン必須版の認証を呼び出し
    var result = await _demoAuthService.AuthenticateAsync(
        request.Password,
        request.ShopDomain, // 🔒 必須パラメータ
        ipAddress,
        userAgent);

    // ... 既存の処理 ...
}
```

#### 1.5. 設定ファイルの追加（DataType制限）

**ファイル**: `backend/ShopifyAnalyticsApi/appsettings.json` / `appsettings.Production.json`

```json
{
  "Demo": {
    "Enabled": true,
    "Password": "dev2025",
    "TokenExpiryMinutes": 60,
    "PasswordHash": "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy",
    "SessionTimeoutHours": 8,
    "MaxSessionsPerUser": 5,
    "RateLimitPerIp": 10,
    "LockoutThreshold": 5,
    "LockoutDurationMinutes": 30,
    "AllowedDataTypes": ["demo"] // 🔒 デモモードでアクセス可能なDataType（デフォルト: "demo"のみ）
  }
}
```

**設定の説明**:
- `AllowedDataTypes`: デモモードでアクセス可能なストアの`DataType`配列
- デフォルト: `["demo"]` - `DataType='demo'`のストアのみ許可
- 本番環境で特定のストアにアクセスしたい場合: `["demo", "production"]`（非推奨、セキュリティリスクあり）
- 推奨: `["demo"]`のみ許可し、デモモード用のストアを`DataType='demo'`で作成する

### 2. フロントエンド実装

#### 2.1. デモログインページの変更

**ファイル**: `frontend/src/app/demo/login/page.tsx`

**変更内容**:

```typescript
export default function DemoLoginPage() {
  const [password, setPassword] = useState('')
  const [shopDomain, setShopDomain] = useState('') // 🆕 ストアドメイン入力
  const [showPassword, setShowPassword] = useState(false)
  const [error, setError] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    setIsLoading(true)

    try {
      const apiBaseUrl = getApiBaseUrl()
      const response = await fetch(`${apiBaseUrl}/api/demo/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          password,
          shopDomain: shopDomain.trim() // 🔒 ストアドメインは必須
        }),
      })

      // ... 既存の処理 ...
    } catch (err) {
      // ... 既存のエラーハンドリング ...
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <Card className="max-w-md w-full">
        <CardHeader className="text-center">
          {/* ... 既存のヘッダー ... */}
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            {/* 🔒 ストアドメイン入力フィールド（必須） */}
            <div>
              <label className="block text-sm font-medium mb-1 text-gray-700">
                ストアドメイン <span className="text-red-500">*</span>
              </label>
              <Input
                type="text"
                placeholder="例: example.myshopify.com または xn-fbkq6e5da0fpb"
                value={shopDomain}
                onChange={(e) => setShopDomain(e.target.value)}
                disabled={isLoading}
                className="w-full"
                required // 🔒 必須入力
              />
              <p className="text-xs text-gray-500 mt-1">
                デモモードでアクセスするストアのドメインを入力してください
              </p>
            </div>

            {/* 既存のパスワード入力フィールド */}
            <div className="relative">
              {/* ... 既存のパスワード入力 ... */}
            </div>
            
            {/* ... 既存のエラー表示とボタン ... */}
          </form>

          {/* ... 既存の説明と戻るリンク ... */}
        </CardContent>
      </Card>
    </div>
  )
}
```

---

## 🔒 セキュリティ考慮事項

### 1. ストアドメイン検証

- **必須チェック**: ストアドメインは必須（空文字列は許可しない）
- **入力検証**: ドメイン形式の検証（正規表現）
- **存在確認**: データベースに存在するストアのみ許可
- **アクティブ確認**: `IsActive = true`のストアのみ許可
- **DataType制限**: `Demo:AllowedDataTypes`設定で許可する`DataType`のみ許可（デフォルト: `"demo"`のみ）

### 2. ログ記録

- ストアドメイン指定でのログイン試行をログに記録
- ストアが見つからない場合の警告ログ（DataType制限違反も含む）
- 認証成功時のストアID、ドメイン、DataTypeをログに記録
- DataType制限違反の試行を警告ログに記録

### 3. エラーメッセージ

- ストアが見つからない場合、具体的なエラーメッセージを返す
- DataType制限違反の場合も「ストアが見つかりません」と返す（セキュリティ上の理由）
- ただし、セキュリティ上の理由で、存在しないストアや許可されていないDataTypeの情報は漏らさない
- ログには詳細を記録（管理者が確認可能）

---

## 📊 実装スケジュール

### Phase 1: バックエンド実装（1-2日）

1. `DemoLoginRequest`の拡張
2. `IDemoAuthService`インターフェースの拡張
3. `DemoAuthService`の実装変更
4. `DemoAuthController`の変更
5. 単体テストの作成

### Phase 2: フロントエンド実装（1日）

1. デモログインページの変更
2. UI/UXの調整
3. エラーハンドリングの実装

### Phase 3: 統合テスト（0.5日）

1. ストアドメイン指定でのログインテスト（DataType='demo'）
2. ストアドメイン指定でのログインテスト（DataType='production'、許可設定あり）
3. ストアドメイン未指定でのエラーテスト
4. 存在しないストアドメインでのエラーテスト
5. 非アクティブなストアドメインでのエラーテスト
6. DataType制限違反でのエラーテスト

---

## ✅ テストケース

### 1. 正常系

- **ケース1**: ストアドメインを指定してログイン成功（DataType='demo'）
  - 入力: パスワード + 有効なストアドメイン（DataType='demo'）
  - 期待: 指定したストアでログイン成功

- **ケース2**: ストアドメインを指定してログイン成功（DataType='production'、許可設定あり）
  - 入力: パスワード + 有効なストアドメイン（DataType='production'）
  - 設定: `Demo:AllowedDataTypes: ["demo", "production"]`
  - 期待: 指定したストアでログイン成功（非推奨設定）

### 2. 異常系

- **ケース3**: ストアドメイン未指定
  - 入力: パスワードのみ（ストアドメイン未入力）
  - 期待: エラーメッセージ「ストアドメインは必須です」

- **ケース4**: 存在しないストアドメイン
  - 入力: パスワード + 存在しないストアドメイン
  - 期待: エラーメッセージ「ストアが見つかりません、またはデモモードでアクセスできません」

- **ケース5**: 非アクティブなストアドメイン
  - 入力: パスワード + `IsActive = false`のストアドメイン
  - 期待: エラーメッセージ「ストアが見つかりません、またはデモモードでアクセスできません」

- **ケース6**: DataType制限違反（DataType='production'、デフォルト設定）
  - 入力: パスワード + `DataType='production'`のストアドメイン
  - 設定: `Demo:AllowedDataTypes: ["demo"]`（デフォルト）
  - 期待: エラーメッセージ「ストアが見つかりません、またはデモモードでアクセスできません」

- **ケース7**: 不正なパスワード
  - 入力: 不正なパスワード + 有効なストアドメイン
  - 期待: エラーメッセージ「パスワードが正しくありません」

---

## 📝 注意事項

### 1. 後方互換性

- **⚠️ 破壊的変更**: ストアドメインが必須になったため、既存のAPIクライアントへの影響あり
- 既存のデモログインフローを更新する必要がある
- フロントエンドのデモログインページを更新する必要がある

### 1.1. 移行対応

- 既存のデモログインフローを使用している場合は、ストアドメイン入力の追加が必要
- 一時的な後方互換性は提供しない（セキュリティリスクのため）

### 2. DataType制限について

- **デフォルト**: `DataType='demo'`のストアのみアクセス可能
- **設定変更**: `appsettings.json`の`Demo:AllowedDataTypes`で制御可能
- **推奨**: `["demo"]`のみ許可し、デモモード用のストアを`DataType='demo'`で作成する
- **非推奨**: `DataType='production'`のストアを許可する設定は、セキュリティリスクがあるため非推奨

### 2.1. デモモード用ストアの作成

本番環境でデモモードでアクセスしたいストアがある場合：

1. **推奨方法**: 新しいストアレコードを作成し、`DataType='demo'`に設定
2. **注意**: `DataType`はストアデータの種類を示すため、既存の本番ストアの`DataType`を変更するのは推奨しない
3. **代替案**: `Demo:AllowedDataTypes: ["demo", "production"]`に設定（非推奨、セキュリティリスクあり）

### 3. セキュリティ

- デモモードは常に`read_only: true`で動作
- データの変更・削除は不可
- ストアドメインの入力は任意（オプション）

---

## 🎯 次のステップ

1. **実装開始**: Phase 1（バックエンド実装）から開始
2. **テスト**: 各Phase完了後にテストを実施
3. **デプロイ**: 本番環境へのデプロイ前に十分なテストを実施

---

## 📚 参考資料

- [デモモード認証サービス実装](../../../../backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs)
- [デモ認証コントローラー](../../../../backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs)
- [デモログインページ](../../../../frontend/src/app/demo/login/page.tsx)
