# HMAC検証失敗 - 原因と対応

## 📋 問題概要

**発生日時**: 2026年1月19日 06:25:31  
**環境**: 本番環境（Production）  
**症状**: インストール時のOAuthコールバックでHMAC検証が失敗する

### エラーログ

```
[06:25:31 ERR] HMAC検証失敗（ShopifySharpライブラリ）
[06:25:31 ERR] HMAC検証失敗. Shop: acs-goods-3.myshopify.com, IsDevelopment: False
```

### OAuth URL生成（成功）

```
RedirectUri: https://ec-ranger.access-net.co.jp/api/shopify/callback
State: 8mMAGfU890M7N0l6IaQaF0kbOpP9QUWQ
ApiKey: b95377afd35e5c8f4b28d286d3ff3491
```

---

## 🔍 考えられる原因

### 1. Shopifyアプリ設定のリダイレクトURI不一致（最も可能性が高い）

**症状**:
- OAuth URLの生成は成功
- Shopify OAuth認証画面で承認も成功
- コールバック時のHMAC検証が失敗

**原因**:
- Shopify Partners管理画面で登録されているリダイレクトURIと実際のURIが一致していない
- カスタムドメイン（`https://ec-ranger.access-net.co.jp`）が登録されていない

**確認方法**:
1. Shopify Partners管理画面を開く
   ```
   https://partners.shopify.com
   ```

2. Apps → EC Ranger → App setup → URLs
   - **Allowed redirection URL(s)** を確認
   - `https://ec-ranger.access-net.co.jp/api/shopify/callback` が登録されているか確認

3. 登録されていない場合、追加する

---

### 2. API Secretの不一致（確認済み: 問題あり）

**症状**:
- HMAC検証が失敗する
- ログに「HMAC検証失敗」と表示される

**原因**:
- `stateData.apiSecret`（ShopifyAppsテーブルから取得）が間違っている
- Shopify Partners管理画面のClient secretと一致していない

**確認結果**:
- **ID 7の`ApiSecret`が設定されていない**
  - 現在の値: `[GitHub Secrets: SHOPIFY_API_SECRET_PRODUCTION ????]`
  - 実際のClient secretが設定されていない

**修正方法**:
1. **Shopify Partners管理画面でClient secretを確認**
   - Apps → EC Ranger → App setup → Client credentials
   - Client secretをコピー

2. **データベースを更新**
   - 詳細は [ShopifyAppsテーブル ID 7 修正手順](./2026-01-19-ShopifyAppsテーブル-ID7-修正手順.md) を参照
   - SQLスクリプト: `docs/05-development/03-データベース/運用/2026-01-19-fix-shopifyapps-id7.sql`

3. **比較**
   - Shopify Partners管理画面のClient secret
   - データベースの`ApiSecret`
   - 一致しているか確認

---

### 3. クエリパラメータのエンコーディング問題

**症状**:
- HMAC検証が失敗する
- ShopifySharpライブラリを使用しているが失敗

**原因**:
- URLエンコーディングの問題
- クエリパラメータの順序の問題

**確認方法**:
- 開発環境で詳細ログを有効にして確認
- `ShopifyOAuthService.cs`の`VerifyHmac`メソッドでデバッグログを確認

---

## ✅ 対応手順

### ステップ1: Shopifyアプリ設定のリダイレクトURIを確認・追加

1. **Shopify Partners管理画面を開く**
   ```
   https://partners.shopify.com
   ```

2. **Apps → EC Ranger → App setup → URLs**

3. **Allowed redirection URL(s) を確認**
   - 以下のURLが登録されているか確認:
     ```
     https://ec-ranger.access-net.co.jp/api/shopify/callback
     ```

4. **登録されていない場合、追加**
   - 「+ Add URL」をクリック
   - `https://ec-ranger.access-net.co.jp/api/shopify/callback` を追加
   - 「Save」をクリック

5. **確認**
   - 追加したURLが一覧に表示されているか確認

---

### ステップ2: API SecretとRedirectUriを確認・更新（重要）

**問題確認済み**: ID 7の`ApiSecret`が設定されておらず、`RedirectUri`も間違っています。

1. **Shopify Partners管理画面でClient secretを確認**
   - Apps → EC Ranger → App setup → Client credentials
   - Client secretをコピー（「表示」をクリック）

2. **SQLスクリプトを実行**
   - `docs/05-development/03-データベース/運用/2026-01-19-fix-shopifyapps-id7.sql`
   - **重要**: スクリプト内の `'実際のClient secretをここに設定'` を実際のClient secretに置き換える

3. **更新内容**:
   - `ApiSecret`: 実際のClient secretに更新
   - `RedirectUri`: `https://ec-ranger.access-net.co.jp/auth/callback` → `https://ec-ranger.access-net.co.jp/api/shopify/callback`

4. **確認**
   - 更新後のApiSecretが正しいか確認
   - 更新後のRedirectUriが正しいか確認

**詳細**: [ShopifyAppsテーブル ID 7 修正手順](./2026-01-19-ShopifyAppsテーブル-ID7-修正手順.md) を参照

---

### ステップ3: インストールを再試行

1. **ブラウザのキャッシュをクリア**
   - 開発者ツール → Application → Clear storage

2. **`/install` ページにアクセス**
   - ストアドメインを入力
   - 「接続を開始」ボタンをクリック

3. **OAuth認証を完了**
   - Shopify OAuth認証画面で承認

4. **結果を確認**
   - HMAC検証が成功するか確認
   - インストールが完了するか確認

---

## 🔧 トラブルシューティング

### リダイレクトURIが登録されているのに失敗する場合

1. **リダイレクトURIの形式を確認**
   - 末尾にスラッシュ（`/`）がないか確認
   - 大文字小文字が一致しているか確認
   - URLエンコーディングが正しいか確認

2. **複数のリダイレクトURIを確認**
   - 古いURL（例: `https://brave-sea-038f17a00.1.azurestaticapps.net/api/shopify/callback`）が残っていないか確認
   - 不要なURLは削除

---

### API Secretが一致しているのに失敗する場合

1. **マルチアプリ対応の確認**
   - `stateData.apiSecret`が正しく取得されているか確認
   - `ShopifyApps`テーブルの`ApiSecret`が正しいか確認

2. **開発環境で詳細ログを確認**
   - `ShopifyOAuthService.cs`の`VerifyHmac`メソッドでデバッグログを有効化
   - 手動計算したHMACと受信HMACを比較

---

## 📝 確認チェックリスト

### Shopifyアプリ設定

- [ ] Allowed redirection URL(s) に `https://ec-ranger.access-net.co.jp/api/shopify/callback` が登録されている
- [ ] 古いURL（Azure Static Web AppsのURL）が削除されている
- [ ] Client credentials（API Key/Secret）が正しい

### データベース設定

- [ ] `ShopifyApps`テーブルの`ApiSecret`がShopify Partners管理画面のClient secretと一致している
- [ ] `ShopifyApps`テーブルの`AppUrl`が `https://ec-ranger.access-net.co.jp` になっている
- [ ] `IsActive = 1` のレコードが存在する

### バックエンド設定

- [ ] `appsettings.Production.json`の`Shopify:ApiSecret`が設定されている（マルチアプリ対応の場合は不要）
- [ ] カスタムドメインが正しく設定されている

---

## 📚 関連ドキュメント

- [インストール時認証エラー調査](./2026-01-19-インストール時認証エラー調査.md)
- [HMAC検証エラー調査](../2025-08/hmac-verification-issue/問題分析.md)
- [Shopifyアプリ認証・認可設計](../../../09-認証・セキュリティ/Shopify-アプリ認証・認可設計.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
