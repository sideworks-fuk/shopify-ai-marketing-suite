# データ同期pending状態の原因と対処法

## 📋 概要

データ同期が`pending`状態のまま進まない問題の原因と対処法をまとめます。

---

## 🔍 問題の症状

- 同期履歴で`pending`状態のまま更新されない
- `running`や`completed`/`failed`に遷移しない
- 長時間（数時間以上）`pending`のまま

---

## 🎯 原因分析

### 1. HangFireジョブが実行されない

**最も一般的な原因**

#### 原因
- HangFireサーバーが停止している
- HangFireのジョブキューが詰まっている
- HangFireのデータベース接続エラー
- App Serviceの再起動後、HangFireが初期化されていない

#### 確認方法
```sql
-- HangFireデータベースのジョブ状態を確認
SELECT 
    j.Id,
    j.StateName,
    j.CreatedAt,
    j.ExpireAt,
    j.InvocationData
FROM HangFire.Job j
WHERE j.CreatedAt > DATEADD(day, -1, GETUTCDATE())
ORDER BY j.CreatedAt DESC;
```

**Azure Portalでの確認**:
1. App Service → 高度なツール (Kudu) → デバッグコンソール → CMD
2. `https://{app-name}.scm.azurewebsites.net/hangfire` にアクセス
3. HangFireダッシュボードでジョブの状態を確認

#### 対処法
1. **App Serviceを再起動**
   ```powershell
   az webapp restart \
     --resource-group ec-ranger-prod \
     --name ec-ranger-backend-prod
   ```

2. **HangFireダッシュボードでジョブを確認**
   - 失敗したジョブがある場合は、エラーメッセージを確認
   - 必要に応じてジョブを再実行

3. **HangFireの接続設定を確認**
   - `appsettings.json`の`Hangfire:ConnectionString`が正しいか確認

---

### 2. SyncStatusが見つからない

#### 原因
- `StartInitialSync`が呼び出される前に`SyncStatus`が削除された
- データベースのトランザクション分離レベルによる問題
- 並行実行による競合状態

#### 確認方法
```sql
-- pending状態のSyncStatusを確認
SELECT 
    Id,
    StoreId,
    SyncType,
    Status,
    StartDate,
    CreatedAt,
    UpdatedAt
FROM SyncStatuses
WHERE Status = 'pending'
ORDER BY CreatedAt DESC;
```

#### 対処法
- `SyncStatus`が存在することを確認
- 存在しない場合は、新しい同期を開始

---

### 3. 例外が発生してエラーハンドリングが実行されない

#### 原因
- `StartInitialSync`内で例外が発生し、catchブロックが実行されない
- データベース接続エラー
- タイムアウトエラー

#### 確認方法
**Application Insightsでログを確認**:
```
traces
| where message contains "StartInitialSync"
| where severityLevel >= 3  // Error以上
| order by timestamp desc
```

**ログファイルで確認**:
- `🟡 [ShopifyDataSyncService] ❌ エラー発生` のログを検索

#### 対処法
1. **ログを確認してエラー原因を特定**
2. **エラーに応じた対処**:
   - データベース接続エラー → 接続文字列を確認
   - タイムアウトエラー → タイムアウト設定を延長
   - Shopify APIエラー → APIキー/アクセストークンを確認

---

### 4. ジョブがキューに登録されていない

#### 原因
- `_backgroundJobClient.Enqueue()`が失敗している
- HangFireの初期化が完了していない

#### 確認方法
```csharp
// SyncController.cs のログを確認
// "🔵 [SyncController] HangFireジョブ登録完了: JobId={JobId}" のログがあるか確認
```

#### 対処法
- HangFireの初期化を確認
- `Program.cs`で`AddHangfire`が正しく設定されているか確認

---

## 🔧 対処手順

### ステップ1: 状態確認

```sql
-- pending状態の同期を確認
SELECT 
    Id,
    StoreId,
    SyncType,
    Status,
    StartDate,
    CreatedAt,
    UpdatedAt,
    ErrorMessage
FROM SyncStatuses
WHERE Status = 'pending'
  AND StartDate > DATEADD(day, -1, GETUTCDATE())
ORDER BY CreatedAt DESC;
```

### ステップ2: HangFireジョブの確認

1. **HangFireダッシュボードにアクセス**
   ```
   https://{app-name}.scm.azurewebsites.net/hangfire
   ```

2. **ジョブの状態を確認**
   - `Enqueued`: 実行待ち
   - `Processing`: 実行中
   - `Succeeded`: 成功
   - `Failed`: 失敗

3. **失敗したジョブがある場合**
   - エラーメッセージを確認
   - 必要に応じて再実行

### ステップ3: 手動で状態を更新（緊急時のみ）

**⚠️ 注意**: この方法は最後の手段として使用してください。

```sql
-- pending状態をfailedに更新（24時間以上経過している場合）
UPDATE SyncStatuses
SET 
    Status = 'failed',
    EndDate = GETUTCDATE(),
    ErrorMessage = 'タイムアウト: HangFireジョブが実行されませんでした',
    UpdatedAt = GETUTCDATE()
WHERE Status = 'pending'
  AND StartDate < DATEADD(hour, -24, GETUTCDATE());
```

### ステップ4: 新しい同期を開始

状態をクリアした後、新しい同期を開始:

```http
POST /api/sync/initial
Content-Type: application/json

{
  "syncPeriod": "all"
}
```

---

## 🛡️ 予防策

### 1. HangFireの監視

**Application Insightsでアラートを設定**:
```kusto
traces
| where message contains "StartInitialSync"
| where severityLevel >= 3
| summarize count() by bin(timestamp, 1h)
```

### 2. タイムアウト処理の追加

`StartInitialSync`にタイムアウト処理を追加（将来の改善案）:

```csharp
// タイムアウト処理の例（将来の改善案）
var cts = new CancellationTokenSource(TimeSpan.FromHours(2));
try
{
    await RunInitialSyncWithJobs(store, syncStatus, syncOptions, cts.Token);
}
catch (OperationCanceledException)
{
    syncStatus.Status = "failed";
    syncStatus.ErrorMessage = "タイムアウト: 2時間以内に完了しませんでした";
}
```

### 3. 定期的なクリーンアップジョブ

古いpending状態を自動的にクリーンアップ:

```csharp
// Program.cs に追加（将来の改善案）
RecurringJob.AddOrUpdate(
    "cleanup-pending-syncs",
    () => CleanupPendingSyncs(),
    Cron.Daily);
```

---

## 📊 トラブルシューティングフローチャート

```
pending状態の同期
    ↓
HangFireダッシュボードで確認
    ↓
ジョブが存在する？
    ├─ YES → ジョブの状態を確認
    │         ├─ Failed → エラーログを確認 → 対処
    │         ├─ Processing → 実行中（待機）
    │         └─ Enqueued → 実行待ち（待機）
    │
    └─ NO → HangFireサーバーが停止している可能性
            → App Serviceを再起動
            → 新しい同期を開始
```

---

## 🔗 関連ドキュメント

- [HangFire設定ガイド](../../04-Azure_DevOps/HangFire設定ガイド.md)
- [データ同期設計仕様](../../03-データベース/設計・モデリング/データ同期設計仕様.md)
- [Application Insightsログ確認方法](../../04-Azure_DevOps/Application-Insights-ログ確認方法.md)

---

## 📝 更新履歴

- 2026-01-23: 初版作成
