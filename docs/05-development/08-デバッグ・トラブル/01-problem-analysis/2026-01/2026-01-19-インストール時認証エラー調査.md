# インストール時認証エラー調査

## 📋 問題概要

**発生日時**: 2026年1月19日  
**環境**: 本番環境（Production）  
**症状**: インストール時に認証エラーが発生する

### 確認事項

1. **エラーメッセージの確認**
   - ブラウザのコンソールログ
   - ネットワークタブのエラーレスポンス
   - バックエンドのログ（Application Insights）

2. **エラーが発生するタイミング**
   - `/install` ページで「接続を開始」ボタンをクリックした時
   - Shopify OAuth認証画面で承認した後
   - コールバック処理中

---

## 🔍 考えられる原因

### 1. HMAC検証失敗（最も可能性が高い）

**症状**:
- コールバック処理で `401 Unauthorized` エラー
- エラーメッセージ: `"HMAC validation failed"`

**原因**:
- API Secretが間違っている
- クエリパラメータの順序が間違っている
- URLエンコーディングの問題

**確認方法**:
1. Application Insightsでログを確認
   ```kusto
   traces
   | where timestamp > ago(1h)
   | where message contains "HMAC検証失敗"
   | order by timestamp desc
   | take 50
   ```

2. バックエンドログで確認
   - `HMAC検証失敗` というログメッセージを検索

**解決策**:
- Shopify Partners管理画面でAPI Secretを確認
- `appsettings.Production.json`の`Shopify:ApiSecret`を確認
- マルチアプリ対応の場合、`ShopifyApps`テーブルの`ApiSecret`を確認

---

### 2. State検証失敗（CSRF対策）

**症状**:
- コールバック処理で `400 Bad Request` エラー
- エラーメッセージ: `"Invalid state parameter"`

**原因**:
- Stateがキャッシュから削除されている（有効期限切れ）
- Stateが一致しない（複数のインストール試行）

**確認方法**:
1. Application Insightsでログを確認
   ```kusto
   traces
   | where timestamp > ago(1h)
   | where message contains "無効なstate" or message contains "Invalid state"
   | order by timestamp desc
   | take 50
   ```

2. バックエンドログで確認
   - `無効なstate` というログメッセージを検索

**解決策**:
- Stateの有効期限を確認（デフォルト: 10分）
- インストール処理を再試行（新しいStateが生成される）

---

### 3. アクセストークン取得失敗

**症状**:
- コールバック処理で `500 Internal Server Error` エラー
- エラーメッセージ: `"Failed to obtain access token"`

**原因**:
- Shopify APIへのリクエストが失敗
- API Key/Secretが間違っている
- ネットワークエラー

**確認方法**:
1. Application Insightsでログを確認
   ```kusto
   traces
   | where timestamp > ago(1h)
   | where message contains "Failed to obtain access token"
   | order by timestamp desc
   | take 50
   ```

2. バックエンドログで確認
   - `Failed to obtain access token` というログメッセージを検索

**解決策**:
- Shopify Partners管理画面でAPI Key/Secretを確認
- ネットワーク接続を確認
- Shopify APIのステータスを確認

---

### 4. リダイレクトURI不一致

**症状**:
- Shopify OAuth認証画面でエラー
- エラーメッセージ: `"redirect_uri_mismatch"`

**原因**:
- Shopifyアプリ設定のリダイレクトURIと実際のURIが一致しない
- カスタムドメインを使用している場合、設定が更新されていない

**確認方法**:
1. Shopify Partners管理画面で確認
   - Apps → EC Ranger → App setup → URLs
   - Allowed redirection URL(s)を確認

2. バックエンドのOAuth URL生成ロジックを確認
   - `ShopifyAuthController.cs`の`BuildOAuthUrlAsync`メソッド

**解決策**:
- Shopifyアプリ設定のリダイレクトURIを更新
- カスタムドメインを使用している場合、`appsettings.Production.json`の`Shopify:RedirectUri`を確認

---

### 5. セッションCookie設定失敗

**症状**:
- コールバック処理は成功するが、認証状態が保持されない
- `/auth/success` ページにリダイレクトされない

**原因**:
- Cookieの設定が失敗している
- CORS設定の問題
- セキュアCookieの設定が間違っている

**確認方法**:
1. ブラウザの開発者ツールでCookieを確認
   - Application → Cookies
   - `shopify_session` または `auth_session` が設定されているか確認

2. ネットワークタブでレスポンスヘッダーを確認
   - `Set-Cookie` ヘッダーが存在するか確認

**解決策**:
- CORS設定を確認（`appsettings.Production.json`の`Cors:AllowedOrigins`）
- Cookieの設定を確認（`SameSite`、`Secure`属性）

---

## ✅ 調査手順

### ステップ1: エラーログの確認

1. **Application Insightsでログを確認**
   - Azure Portal → Application Insights → ログ
   - 以下のクエリを実行:

   ```kusto
   // インストール関連のエラーを確認
   traces
   | where timestamp > ago(1h)
   | where message contains "install" 
      or message contains "OAuth"
      or message contains "HMAC"
      or message contains "認証"
   | where severityLevel >= 2  // Warning以上
   | order by timestamp desc
   | take 100
   ```

2. **バックエンドログを確認**
   - Azure Portal → App Service → ログ ストリーム
   - リアルタイムでログを確認

3. **フロントエンドのコンソールログを確認**
   - ブラウザの開発者ツール → Console
   - エラーメッセージを確認

---

### ステップ2: ネットワークリクエストの確認

1. **ブラウザの開発者ツール → Networkタブ**
   - `/api/shopify/install` のリクエストを確認
   - `/api/shopify/callback` のリクエストを確認
   - エラーレスポンス（401, 400, 500）を確認

2. **リクエスト/レスポンスの詳細を確認**
   - リクエストヘッダー
   - レスポンスボディ
   - ステータスコード

---

### ステップ3: 設定の確認

1. **Shopifyアプリ設定の確認**
   - Shopify Partners管理画面
   - Apps → EC Ranger → App setup
   - Client credentials（API Key/Secret）を確認
   - Allowed redirection URL(s)を確認

2. **バックエンド設定の確認**
   - `appsettings.Production.json`の`Shopify`セクション
   - `ShopifyApps`テーブルの設定（マルチアプリ対応）

3. **フロントエンド設定の確認**
   - 環境変数（`NEXT_PUBLIC_API_URL`、`NEXT_PUBLIC_SHOPIFY_API_KEY`）
   - カスタムドメインの設定

---

### ステップ4: インストールフローの確認

1. **インストールフローの各ステップを確認**
   ```
   /install ページ
     ↓
   /api/shopify/install (フロントエンドAPI Route)
     ↓
   /api/shopify/install (バックエンド)
     ↓
   Shopify OAuth認証画面
     ↓
   /api/shopify/callback (バックエンド)
     ↓
   /auth/success ページ
   ```

2. **各ステップでエラーが発生しているか確認**
   - どのステップでエラーが発生しているか特定
   - エラーメッセージを記録

---

## 🔧 トラブルシューティング

### HMAC検証エラーの場合

1. **API Secretを確認**
   ```powershell
   # Azure Portal → App Service → 構成 → アプリケーション設定
   # Shopify__ApiSecret を確認
   ```

2. **Shopify Partners管理画面で確認**
   - Apps → EC Ranger → App setup → Client credentials
   - Client secretを確認

3. **マルチアプリ対応の場合**
   ```sql
   -- ShopifyAppsテーブルでApiSecretを確認
   SELECT Id, Name, ApiKey, ApiSecret, IsActive
   FROM ShopifyApps
   WHERE IsActive = 1
   ```

---

### State検証エラーの場合

1. **Stateの有効期限を確認**
   - デフォルト: 10分
   - インストール処理を10分以内に完了する

2. **インストール処理を再試行**
   - `/install` ページに戻る
   - 「接続を開始」ボタンを再度クリック
   - 新しいStateが生成される

---

### アクセストークン取得エラーの場合

1. **Shopify APIのステータスを確認**
   - https://status.shopify.com/

2. **ネットワーク接続を確認**
   - バックエンドからShopify APIにアクセスできるか確認

3. **API Key/Secretを再確認**
   - Shopify Partners管理画面で確認
   - バックエンド設定で確認

---

## 📝 ログ確認クエリ（Application Insights）

### ステップ1: まずはすべてのログを確認（ログが送信されているか確認）

```kusto
// すべてのログを確認（ログが送信されているか確認）
traces
| where timestamp > ago(24h)
| order by timestamp desc
| take 100
| project timestamp, severityLevel, message, customDimensions.SourceContext
```

**確認ポイント**:
- ログが存在するか確認
- 最新のログのタイムスタンプを確認
- ログが正しく送信されているか確認

---

### ステップ2: インストール関連のログを確認（時間範囲を広げる）

```kusto
// インストール関連のログを確認（24時間以内）
traces
| where timestamp > ago(24h)
| where message contains "install" 
   or message contains "OAuth"
   or message contains "HMAC"
   or message contains "認証"
   or message contains "callback"
| order by timestamp desc
| take 200
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions
```

**確認ポイント**:
- インストール関連のログが存在するか確認
- エラーレベル（severityLevel）を確認
- メッセージの内容を確認

---

### ステップ3: エラーレベルのログのみ確認

```kusto
// エラーレベルのログのみ確認（24時間以内）
traces
| where timestamp > ago(24h)
| where severityLevel >= 3  // Error以上
| order by timestamp desc
| take 100
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions
```

**確認ポイント**:
- エラーレベルのログが存在するか確認
- エラーメッセージの内容を確認

---

### ステップ4: インストール関連のエラーを確認（詳細版）

```kusto
// インストール関連のエラーを確認（7日以内、より広い範囲）
traces
| where timestamp > ago(7d)
| where (message contains "install" 
   or message contains "OAuth"
   or message contains "HMAC"
   or message contains "認証"
   or message contains "callback")
   and severityLevel >= 2  // Warning以上
| order by timestamp desc
| take 200
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions.SourceContext, customDimensions
```

### HMAC検証失敗を確認

```kusto
// HMAC検証失敗を確認（24時間以内）
traces
| where timestamp > ago(24h)
| where message contains "HMAC検証失敗" or message contains "HMAC validation failed"
| order by timestamp desc
| take 50
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions
```

**注意**: ログが見つからない場合、時間範囲を広げてください（例: `ago(7d)`）

### State検証失敗を確認

```kusto
// State検証失敗を確認（24時間以内）
traces
| where timestamp > ago(24h)
| where message contains "無効なstate" or message contains "Invalid state"
| order by timestamp desc
| take 50
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions
```

**注意**: ログが見つからない場合、時間範囲を広げてください（例: `ago(7d)`）

### アクセストークン取得失敗を確認

```kusto
// アクセストークン取得失敗を確認（24時間以内）
traces
| where timestamp > ago(24h)
| where message contains "Failed to obtain access token" or message contains "アクセストークン取得失敗"
| order by timestamp desc
| take 50
| project timestamp, severityLevel, message, customDimensions.Shop, customDimensions
```

**注意**: ログが見つからない場合、時間範囲を広げてください（例: `ago(7d)`）

---

## ⚠️ ログが見つからない場合の対処法

### 1. 時間範囲を広げる

**原因**: 最近1時間以内にインストール試行がない可能性

**対処法**:
- 時間範囲を `ago(24h)` または `ago(7d)` に変更
- インストール試行のタイミングを確認

---

### 2. Application Insightsへのログ送信を確認

**原因**: ログがApplication Insightsに送信されていない可能性

**確認方法**:
1. **Azure Portal → App Service → 監視 → Application Insights**
   - Application Insightsが有効になっているか確認
   - 接続文字列が設定されているか確認

2. **Azure Portal → App Service → 構成 → アプリケーション設定**
   - `APPINSIGHTS_INSTRUMENTATIONKEY` または `APPLICATIONINSIGHTS_CONNECTION_STRING` が設定されているか確認

3. **バックエンドのログストリームを確認**
   - Azure Portal → App Service → 監視 → ログ ストリーム
   - リアルタイムでログが出力されているか確認

---

### 3. ログレベルを確認

**原因**: ログレベルが低く、エラーログが出力されていない可能性

**確認方法**:
1. **`appsettings.Production.json`のログ設定を確認**
   ```json
   {
     "Logging": {
       "LogLevel": {
         "Default": "Information",
         "Microsoft": "Warning",
         "System": "Warning"
       }
     }
   }
   ```

2. **Serilogの設定を確認**
   - 最小ログレベルが適切に設定されているか確認

---

### 4. 別の方法でログを確認

**Application Insightsでログが見つからない場合**:

1. **Azure Portal → App Service → 監視 → ログ ストリーム**
   - リアルタイムでログを確認

2. **Azure Portal → App Service → 開発ツール → 高度なツール (Kudu)**
   - `D:\home\LogFiles\Application\` でログファイルを確認

3. **Azure Portal → App Service → 監視 → メトリック**
   - リクエスト数、エラー率を確認

---

## 📚 関連ドキュメント

- [インストールフロー設計書](../../../../03-feature-development/インストールフロー改善機能/インストール機能設計書.md)
- [HMAC検証エラー調査](../2025-08/hmac-verification-issue/問題分析.md)
- [インストールフロー問題の根本原因調査](../2025-12/インストールフロー問題の根本原因調査.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
