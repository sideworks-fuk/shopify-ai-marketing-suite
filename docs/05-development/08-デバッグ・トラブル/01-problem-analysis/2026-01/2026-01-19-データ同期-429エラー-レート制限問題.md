# データ同期 - 429エラー（レート制限）問題

## 📋 問題概要

**発生日時**: 2026年1月19日 07:35:07  
**環境**: 本番環境（Production）  
**症状**: データ同期ステータスのポーリングで429エラー（Too Many Requests）が大量に発生

### エラーログ

```
GET https://ec-ranger-api.access-net.co.jp/api/sync/status/12 429 (Too Many Requests)
⚠️ レート制限エラー（429）: リトライしません。しばらく待ってから再試行してください。
```

### 問題の詳細

- **ポーリング間隔**: 5秒ごと
- **エラー発生**: `/api/sync/status/12`へのリクエストが429エラー
- **影響**: 同期ステータスの取得が失敗し、進捗が表示されない
- **追加の問題**: `X-Store-Id`ヘッダーが設定されていない警告も発生

---

## 🔍 原因

### 1. ポーリング間隔が短すぎる

**現在の実装**:
- ポーリング間隔: **5秒**
- 同期ステータスを5秒ごとに取得

**問題**:
- レート制限に引っかかりやすい
- 429エラーが発生すると、ポーリングが継続され、さらにエラーが増える

---

### 2. 429エラー時の処理が不十分

**現在の実装**:
- 429エラーが発生しても、ポーリングを継続
- エラーメッセージを表示するが、ポーリングは停止しない

**問題**:
- 429エラーが連続して発生
- レート制限が解除されるまで待機しない

---

### 3. X-Store-Idヘッダーの警告

**現在の実装**:
- OAuthモードでは、バックエンドがJWTトークンから`store_id`を取得できる
- しかし、フロントエンドで`X-Store-Id`ヘッダーを設定しようとしている

**問題**:
- `currentStoreId`が取得できない場合、警告が表示される
- OAuthモードでは不要な警告

---

## ✅ 解決方法

### 方法1: ポーリング間隔を延長（推奨）

**変更内容**:
- ポーリング間隔を5秒から**10-15秒**に延長
- レート制限を回避

**実装**:
```typescript
// 10秒ごとにポーリング（5秒から延長）
const interval = setInterval(() => {
  // ...
}, 10000) // 5000 → 10000
```

---

### 方法2: 429エラー時の指数バックオフ

**変更内容**:
- 429エラーが発生した場合、ポーリングを一時停止
- 指数バックオフで再開（10秒 → 20秒 → 40秒）

**実装**:
```typescript
const [pollingInterval, setPollingInterval] = useState(10000) // 初期値10秒
const [isRateLimited, setIsRateLimited] = useState(false)

// 429エラーが発生した場合
if (response.status === 429) {
  setIsRateLimited(true)
  setPollingInterval(prev => Math.min(prev * 2, 60000)) // 最大60秒
  // ポーリングを一時停止
}
```

---

### 方法3: X-Store-Idヘッダーの警告を抑制

**変更内容**:
- OAuthモードでは、`X-Store-Id`ヘッダーがなくても警告を出さない
- バックエンドがJWTトークンから取得できるため

**実装**:
```typescript
// OAuthモードでは警告を出さない
if (authMode === 'shopify') {
  // 警告を出さない
} else {
  console.warn('X-Store-Idヘッダーが設定されていません')
}
```

---

## 🔧 実装

### ステップ1: ポーリング間隔を延長

`frontend/src/app/setup/syncing/page.tsx`を修正:

```typescript
// 5秒ごとにポーリング → 10秒ごとにポーリング
const interval = setInterval(() => {
  // ...
}, 10000) // 5000 → 10000
```

---

### ステップ2: 429エラー時の処理を改善

`frontend/src/app/setup/syncing/page.tsx`を修正:

```typescript
const [pollingInterval, setPollingInterval] = useState(10000)
const [isRateLimited, setIsRateLimited] = useState(false)

const fetchSyncStatus = useCallback(async () => {
  try {
    // ...
  } catch (error: any) {
    if (error.message?.includes('429') || error.message?.includes('Too Many Requests')) {
      console.warn('⚠️ レート制限エラー（429）: ポーリング間隔を延長します')
      setIsRateLimited(true)
      setPollingInterval(prev => Math.min(prev * 2, 60000)) // 最大60秒
      setConsecutiveErrors(prev => prev + 1)
      return // エラーを表示せず、ポーリング間隔を延長
    }
    // その他のエラー処理
  }
}, [])

// ポーリング間隔を動的に変更
const interval = setInterval(() => {
  // ...
}, pollingInterval)
```

---

### ステップ3: X-Store-Idヘッダーの警告を抑制

`frontend/src/lib/api-client.ts`を修正:

```typescript
// OAuthモードでは警告を出さない
if (authMode !== 'shopify' && !currentStoreId) {
  console.warn('⚠️ [APIClient.request] X-Store-Idヘッダーが設定されていません')
}
```

---

## 📝 確認手順

### ステップ1: ポーリング間隔を確認

1. **ブラウザの開発者ツール → Networkタブ**
   - `/api/sync/status/12`へのリクエスト間隔を確認
   - 10秒以上になっているか確認

2. **コンソールログを確認**
   - 429エラーが発生していないか確認
   - ポーリング間隔が延長されているか確認

---

### ステップ2: 429エラー時の動作を確認

1. **429エラーが発生した場合**
   - ポーリングが一時停止されるか確認
   - ポーリング間隔が延長されるか確認
   - エラーメッセージが表示されるか確認

2. **レート制限が解除された場合**
   - ポーリングが再開されるか確認
   - ポーリング間隔が元に戻るか確認

---

### ステップ3: X-Store-Idヘッダーの警告を確認

1. **OAuthモードの場合**
   - `X-Store-Id`ヘッダーがなくても警告が出ないか確認
   - APIリクエストが成功するか確認

2. **開発者モード/デモモードの場合**
   - `X-Store-Id`ヘッダーが設定されているか確認
   - 警告が表示されるか確認

---

## ⚠️ 注意事項

### 1. ポーリング間隔のバランス

- **短すぎる**: レート制限に引っかかる
- **長すぎる**: 進捗表示が遅れる
- **推奨**: 10-15秒

---

### 2. 429エラー時のユーザー体験

- **エラーメッセージ**: ユーザーに分かりやすく表示
- **再試行**: 自動的に再試行するか、手動で再試行できるようにする
- **進捗表示**: 429エラーが発生しても、最後に取得した進捗を表示

---

### 3. レート制限の回避

- **ポーリング間隔**: 適切な間隔に設定
- **指数バックオフ**: 429エラー時に間隔を延長
- **リクエスト数の削減**: 不要なリクエストを避ける

---

## 📚 関連ドキュメント

- [データ同期失敗-Protected-Customer-Dataエラー](./2026-01-19-データ同期失敗-Protected-Customer-Dataエラー.md)
- [初期同期の処理フローとデータ追加確認方法](../2025-12/初期同期の処理フローとデータ追加確認方法.md)

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
