# ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³å¾Œ401ã‚¨ãƒ©ãƒ¼ èª¿æŸ»çµæœ

**ä½œæˆæ—¥**: 2026-01-20  
**å•é¡Œ**: Shopifyã‚¢ãƒ—ãƒªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã¯é–‹ã‘ã‚‹ãŒã€`/demo/login`ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

---

## ğŸ” å•é¡Œã®ç¾è±¡

### ç™ºç”ŸçŠ¶æ³

1. `/demo/login`ã§ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
2. ãƒšãƒ¼ã‚¸é·ç§»å¾Œã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå¤šæ•°ç™ºç”Ÿï¼š
   - `Failed to load resource: the server responded with a status of 401 (Unauthorized)`
   - `èªè¨¼ã‚¨ãƒ©ãƒ¼: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«`
   - `OAuth authentication required`

---

## ğŸ” åŸå› åˆ†æ

### åŸå› 1: `oauth_authenticated`ãƒ•ãƒ©ã‚°ãŒæ®‹ã£ã¦ã„ã‚‹

**å•é¡Œç‚¹**: ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«`oauth_authenticated`ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ãªã„

**å½±éŸ¿**:
- `ApiClient.getAuthHeaders()`ã®115è¡Œç›®ã§`oauthAuthenticated === 'true'`ã®å ´åˆã€æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã—ã¦ã„ã‚‹
- ãã®ãŸã‚ã€ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ã®è¨­å®šå‡¦ç†ï¼ˆ133è¡Œç›®ä»¥é™ï¼‰ã«åˆ°é”ã—ãªã„
- `Authorization`ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œãšã€401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**è©²å½“ã‚³ãƒ¼ãƒ‰**: `frontend/src/lib/api-client.ts` 115-119è¡Œç›®

```typescript
if (oauthAuthenticated && !this.options.getShopifyToken) {
  // OAuthèªè¨¼æˆåŠŸå¾Œã€åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ãªã„å ´åˆ: Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨
  console.log('ğŸ” OAuthèªè¨¼æ¸ˆã¿: Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨ï¼ˆAuthorizationãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä¸è¦ï¼‰');
  return headers; // X-Store-Id ã¯æ—¢ã«è¨­å®šæ¸ˆã¿
}

// ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³/é–‹ç™ºè€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
if (this.options.getDemoToken) {
  // âš ï¸ ã“ã®å‡¦ç†ã«åˆ°é”ã—ãªã„ï¼ˆæ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã®ãŸã‚ï¼‰
  const token = this.options.getDemoToken();
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
    return headers;
  }
}
```

### åŸå› 2: `AuthProvider`ã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯

**å•é¡Œç‚¹**: `oauthAuthenticated === 'true'`ã®ãƒã‚§ãƒƒã‚¯ãŒ`demoToken`ã®ãƒã‚§ãƒƒã‚¯ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹

**å½±éŸ¿**:
- ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã£ã¦ã‚‚ã€`oauth_authenticated === 'true'`ã®å ´åˆã€OAuthãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ–ã•ã‚Œã‚‹
- ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒä½œæˆã•ã‚Œãªã„

**è©²å½“ã‚³ãƒ¼ãƒ‰**: `frontend/src/components/providers/AuthProvider.tsx` 224-232è¡Œç›®

```typescript
} else if (oauthAuthenticated === 'true') {
  // OAuthèªè¨¼æˆåŠŸå¾Œ: Cookieãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚’ä½¿ç”¨ï¼ˆAuthorizationãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä¸è¦ï¼‰
  console.log('ğŸ”— [AuthProvider] OAuthèªè¨¼æ¸ˆã¿: Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨');
  client = new ApiClient(undefined, {
    getCurrentStoreId: getCurrentStoreIdFn
  }); // getShopifyTokenãªã— = Cookieãƒ™ãƒ¼ã‚¹èªè¨¼
  setAuthMode('shopify')
  console.log('âœ… [AuthProvider] OAuthèªè¨¼æ¸ˆã¿APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–å®Œäº†')
} else if (demoToken) {
  // âš ï¸ ã“ã®å‡¦ç†ã«åˆ°é”ã—ãªã„ï¼ˆä¸Šè¨˜ã®æ¡ä»¶ã§å…ˆã«å‡¦ç†ã•ã‚Œã‚‹ï¼‰
  // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰
  console.log('ğŸ”— [AuthProvider] ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–');
  ...
}
```

---

## âœ… è§£æ±ºç­–

### è§£æ±ºç­–1: ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«`oauth_authenticated`ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/app/demo/login/page.tsx`

**å¤‰æ›´å†…å®¹**:
- ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«`oauth_authenticated`ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤

```typescript
// ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
if (typeof window !== 'undefined') {
  localStorage.setItem('demoToken', data.token)
  localStorage.setItem('authMode', 'demo')
  localStorage.setItem('readOnly', 'true')
  localStorage.setItem('currentStoreId', storeId.toString())
  // ğŸ”§ oauth_authenticatedãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã¨OAuthãƒ¢ãƒ¼ãƒ‰ã®ç«¶åˆã‚’é˜²ãï¼‰
  localStorage.removeItem('oauth_authenticated')
}
```

### è§£æ±ºç­–2: `AuthProvider`ã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/providers/AuthProvider.tsx`

**å¤‰æ›´å†…å®¹**:
- ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€`oauth_authenticated`ãƒã‚§ãƒƒã‚¯ã‚ˆã‚Šå…ˆã«ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ–

```typescript
// ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆçš„ã«ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ–
if (demoToken) {
  // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰
  console.log('ğŸ”— [AuthProvider] ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–');
  client = new ApiClient(undefined, {
    getDemoToken: () => demoToken,
    getCurrentStoreId: getCurrentStoreIdFn
  });
  setAuthMode('demo')
  console.log('âœ… [AuthProvider] ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–å®Œäº†')
} else if (oauthAuthenticated === 'true') {
  // OAuthèªè¨¼æˆåŠŸå¾Œ: Cookieãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚’ä½¿ç”¨
  ...
}
```

### è§£æ±ºç­–3: `ApiClient.getAuthHeaders()`ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/lib/api-client.ts`

**å¤‰æ›´å†…å®¹**:
- ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€`oauthAuthenticated`ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—

```typescript
// ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯é–‹ç™ºè€…ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆ
if (this.options.getDemoToken) {
  const token = this.options.getDemoToken();
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
    console.log('ğŸ”§ [ApiClient.getAuthHeaders] é–‹ç™ºè€…/ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰: Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š', { 
      hasXStoreId: !!headers['X-Store-Id'],
      storeId: headers['X-Store-Id'] || 'æœªè¨­å®š'
    });
    return headers;
  }
}

// OAuthèªè¨¼æˆåŠŸå¾Œï¼ˆåŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ãªã„å ´åˆï¼‰ã¯ã€Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨
if (oauthAuthenticated && !this.options.getShopifyToken) {
  // OAuthèªè¨¼æˆåŠŸå¾Œã€åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ãªã„å ´åˆ: Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨
  console.log('ğŸ” OAuthèªè¨¼æ¸ˆã¿: Cookieãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’ä½¿ç”¨ï¼ˆAuthorizationãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä¸è¦ï¼‰');
  return headers; // X-Store-Id ã¯æ—¢ã«è¨­å®šæ¸ˆã¿
}
```

---

## ğŸ“‹ æ¨å¥¨ä¿®æ­£é †åº

1. **è§£æ±ºç­–1**: ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«`oauth_authenticated`ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€ã‚‚ç°¡å˜ï¼‰
2. **è§£æ±ºç­–2**: `AuthProvider`ã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ï¼ˆãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³å„ªå…ˆï¼‰
3. **è§£æ±ºç­–3**: `ApiClient.getAuthHeaders()`ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ï¼ˆãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³å„ªå…ˆï¼‰

**æ¨å¥¨**: è§£æ±ºç­–1ã¨è§£æ±ºç­–2ã®ä¸¡æ–¹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `frontend/src/app/demo/login/page.tsx` - ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
- `frontend/src/components/providers/AuthProvider.tsx` - èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
- `frontend/src/lib/api-client.ts` - APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs` - èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
