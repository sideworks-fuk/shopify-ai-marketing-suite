# CORSエラー: カスタムドメイン対応

## 📋 問題概要

**発生日時**: 2026年1月19日  
**環境**: 本番環境（Production）  
**エラー**: CORS policy error - `Access-Control-Allow-Origin` header is not present

### エラーメッセージ

```
Access to fetch at 'https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/api/store' 
from origin 'https://ec-ranger.access-net.co.jp' 
has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

---

## 🔍 原因分析

### 1. CORS設定の問題

**問題点**:
- バックエンドのCORS設定（`appsettings.Production.json`）に、フロントエンドのカスタムドメイン（`https://ec-ranger.access-net.co.jp`）が含まれていない
- 現在のCORS設定には古いStatic Web AppsのURLのみが含まれている

**現在の設定**:
```json
"Cors": {
  "AllowedOrigins": [
    "https://white-island-08e0a6300.2.azurestaticapps.net",
    "https://white-island-08e0a6300.1.azurestaticapps.net",
    "https://black-flower-004e1de00.2.azurestaticapps.net",
    "https://black-flower-004e1de00.1.azurestaticapps.net"
  ]
}
```

### 2. フロントエンド環境変数の問題

**問題点**:
- `NEXT_PUBLIC_API_URL`を`https://ec-ranger-api.access-net.co.jp`に更新したが、フロントエンドがまだ古いURL（`ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`）にアクセスしている
- Next.jsでは環境変数はビルド時に埋め込まれるため、環境変数を更新しただけでは反映されない
- **再デプロイが必要**

---

## ✅ 対応内容

### 1. バックエンドCORS設定の更新

**ファイル**: `backend/ShopifyAnalyticsApi/appsettings.Production.json`

**変更内容**:
```json
"Cors": {
  "AllowedOrigins": [
    "https://ec-ranger.access-net.co.jp",  // ← 追加
    "https://brave-sea-038f17a00.1.azurestaticapps.net",  // ← 追加（並行運用）
    "https://brave-sea-038f17a00-development.eastasia.1.azurestaticapps.net",  // ← 追加
    "https://brave-sea-038f17a00-staging.eastasia.1.azurestaticapps.net",  // ← 追加
    "https://white-island-08e0a6300.2.azurestaticapps.net",
    "https://white-island-08e0a6300.1.azurestaticapps.net",
    "https://black-flower-004e1de00.2.azurestaticapps.net",
    "https://black-flower-004e1de00.1.azurestaticapps.net"
  ]
}
```

**理由**:
- フロントエンドのカスタムドメイン（`ec-ranger.access-net.co.jp`）を許可
- 既存のStatic Web AppsのURLも残す（並行運用・フォールバック用）

---

### 2. フロントエンド環境変数の確認と再デプロイ

**確認事項**:
1. GitHub Environment Variablesで`NEXT_PUBLIC_API_URL`が正しく設定されているか確認
   - 値: `https://ec-ranger-api.access-net.co.jp`
2. フロントエンドを再デプロイ（環境変数はビルド時に埋め込まれるため）

**再デプロイ手順**:
1. GitHub Actionsでフロントエンドを再デプロイ
2. デプロイ完了後、ブラウザのキャッシュをクリア
3. 動作確認

---

### 3. Azure App Serviceの環境変数確認（オプション）

**確認事項**:
- Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
- `Cors:AllowedOrigins`が環境変数で上書きされていないか確認
- 上書きされている場合は、`https://ec-ranger.access-net.co.jp`を追加

---

## 🚀 デプロイ手順

### バックエンド

1. **CORS設定の更新をコミット**
   ```powershell
   git add backend/ShopifyAnalyticsApi/appsettings.Production.json
   git commit -m "CORS設定にフロントエンドカスタムドメインを追加"
   git push origin develop
   ```

2. **バックエンドをデプロイ**
   - GitHub Actionsでバックエンドをデプロイ
   - または、Azure Portalから手動デプロイ

3. **動作確認**
   - バックエンドが起動していることを確認
   - CORS設定が反映されていることを確認

### フロントエンド

1. **環境変数の確認**
   - GitHub → Settings → Environments → production
   - `NEXT_PUBLIC_API_URL`が`https://ec-ranger-api.access-net.co.jp`に設定されていることを確認

2. **フロントエンドを再デプロイ**
   - GitHub Actionsでフロントエンドを再デプロイ
   - 環境変数はビルド時に埋め込まれるため、再デプロイが必須

3. **動作確認**
   - ブラウザのキャッシュをクリア
   - `https://ec-ranger.access-net.co.jp`にアクセス
   - CORSエラーが解消されていることを確認

---

## 📊 確認項目チェックリスト

### バックエンド

- [ ] `appsettings.Production.json`のCORS設定に`https://ec-ranger.access-net.co.jp`が追加されている
- [ ] バックエンドが再デプロイされている
- [ ] バックエンドが正常に起動している
- [ ] CORS設定が正しく反映されている（ログで確認）

### フロントエンド

- [ ] GitHub Environment Variablesで`NEXT_PUBLIC_API_URL`が`https://ec-ranger-api.access-net.co.jp`に設定されている
- [ ] フロントエンドが再デプロイされている
- [ ] ブラウザのキャッシュをクリアしている
- [ ] フロントエンドからバックエンドへのAPIリクエストが成功している

---

## 🔧 トラブルシューティング

### CORSエラーが解消されない場合

1. **ブラウザのキャッシュを完全にクリア**
   - 開発者ツール（F12）→ Networkタブ → "Disable cache"にチェック
   - ハードリロード（Ctrl+Shift+R）

2. **バックエンドのログを確認**
   - Azure Portal → App Service → ログストリーム
   - CORS関連のエラーログがないか確認

3. **CORS設定の確認**
   - `appsettings.Production.json`の設定が正しいか確認
   - Azure App Serviceの環境変数で上書きされていないか確認

4. **フロントエンドの環境変数確認**
   - ブラウザのコンソールで`process.env.NEXT_PUBLIC_API_URL`を確認
   - 正しいURLが表示されているか確認

### 環境変数が反映されない場合

1. **Next.jsの環境変数の特性を確認**
   - `NEXT_PUBLIC_*`で始まる環境変数はビルド時に埋め込まれる
   - 環境変数を変更した場合は、**必ず再デプロイが必要**

2. **ビルドログを確認**
   - GitHub Actionsのビルドログで環境変数が正しく読み込まれているか確認

---

## 📝 参考情報

### CORS設定の仕組み

- バックエンドの`Program.cs`でCORS設定を読み込む
- `appsettings.Production.json`の`Cors:AllowedOrigins`から許可するオリジンを読み込む
- フロントエンドのオリジン（`https://ec-ranger.access-net.co.jp`）が許可リストに含まれている必要がある

### Next.js環境変数の特性

- `NEXT_PUBLIC_*`で始まる環境変数はクライアントサイドでも使用可能
- 環境変数は**ビルド時に埋め込まれる**ため、実行時に変更できない
- 環境変数を変更した場合は、**必ず再ビルド・再デプロイが必要**

---

**最終更新**: 2026年1月19日  
**作成者**: 福田
