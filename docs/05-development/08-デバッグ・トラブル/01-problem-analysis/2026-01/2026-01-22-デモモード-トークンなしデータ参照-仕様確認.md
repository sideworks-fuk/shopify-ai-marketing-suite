# デモモード トークンなしデータ参照 仕様確認

**作成日**: 2026-01-22  
**問題**: デモモードでトークンが必要になっているが、以前はトークンなしでデータ参照できていた

---

## 🔍 現状の確認

### 現在の実装

#### 1. デモログイン方式（トークンベース）
- **フロントエンド**: `/demo/login` でストアドメインとパスワードを入力
- **バックエンド**: `/api/demo/login` でJWTトークンを発行
- **認証**: `Authorization: Bearer {token}` ヘッダーで認証
- **ストア選択**: ログイン時にストアドメインからStoreIdを取得

#### 2. トークンなし方式（X-Demo-Modeヘッダー）
- **実装箇所**: `backend/ShopifyAnalyticsApi/Middleware/DemoModeMiddleware.cs`
- **動作**: `X-Demo-Mode: true` ヘッダーがあれば、トークンなしでデモモードとして動作
- **制限**: **開発環境のみ**で動作（`environment.IsDevelopment()`）
- **ストア選択**: 最初のアクティブなストアを自動選択
- **問題**: フロントエンドからこのヘッダーを送信していない

---

## 📋 以前の仕様（推測）

### トークンなしでデータ参照
- **方法**: `X-Demo-Mode: true` ヘッダーを送信
- **ストア選択**: 最初のアクティブなストアを自動選択
- **認証**: トークン不要
- **制限**: 読み取り専用（`read_only: true`）

### 現在の問題
1. **トークンが必要**: デモログイン時にトークンを取得する必要がある
2. **ストア参照できない**: トークンが設定してあるストアでも参照できない
3. **開発環境のみ**: `X-Demo-Mode`ヘッダー方式は開発環境のみで動作

---

## 🎯 解決策の検討

### オプション1: トークンなし方式を復活（推奨）

**方法**: `X-Demo-Mode: true` ヘッダーを送信して、トークンなしでデータ参照

**実装内容**:
1. **フロントエンド**: `ApiClient` でデモモード時に `X-Demo-Mode: true` ヘッダーを送信
2. **バックエンド**: `DemoModeMiddleware` を本番環境でも動作するように修正（または別のミドルウェアを作成）
3. **ストア選択**: ストアドメインを指定できるようにする（ヘッダーまたはクエリパラメータ）

**メリット**:
- 以前の仕様に戻せる
- トークン管理が不要
- シンプルな実装

**デメリット**:
- セキュリティリスク（ヘッダーだけで認証をスキップ）
- ストア選択の方法を検討する必要がある

### オプション2: トークンベース方式を改善（現在の実装）

**方法**: デモログインでトークンを取得し、そのトークンでデータ参照

**問題点**:
1. **ストア参照できない**: トークンに含まれる `store_id` が正しく設定されていない可能性
2. **認証状態の復元**: ページ遷移後に認証状態が正しく復元されていない可能性

**確認事項**:
- デモトークンに `store_id` が含まれているか
- `StoreContextMiddleware` が `store_id` を正しく取得しているか
- APIリクエスト時に `Authorization` ヘッダーが送信されているか

---

## 🔧 推奨される対応

### 1. トークンベース方式の改善（優先）

**問題**: トークンが設定してあるストアでも参照できない

**確認ポイント**:
1. デモトークンに `store_id` が含まれているか
2. `StoreContextMiddleware` が `store_id` を正しく取得しているか
3. APIリクエスト時に `Authorization` ヘッダーが送信されているか

**修正内容**:
- デモトークンの `store_id` クレームを確認
- `StoreContextMiddleware` の動作を確認
- フロントエンドの `ApiClient` がデモトークンを正しく送信しているか確認

### 2. トークンなし方式の検討（オプション）

**条件**: トークンベース方式で解決できない場合

**実装内容**:
- `X-Demo-Mode: true` ヘッダーを送信
- ストアドメインを指定できるようにする（`X-Store-Domain` ヘッダーまたはクエリパラメータ）
- 本番環境でも動作するように修正（セキュリティを考慮）

---

## ✅ 確認項目

### トークンベース方式
- [ ] デモトークンに `store_id` が含まれているか
- [ ] `StoreContextMiddleware` が `store_id` を正しく取得しているか
- [ ] APIリクエスト時に `Authorization` ヘッダーが送信されているか
- [ ] バックエンドでデモトークンが正しく検証されているか

### トークンなし方式
- [ ] `X-Demo-Mode: true` ヘッダーを送信しているか
- [ ] `DemoModeMiddleware` が動作しているか（開発環境のみ）
- [ ] ストア選択の方法（自動選択 or 指定）

---

## 🔗 関連ファイル

- `backend/ShopifyAnalyticsApi/Middleware/DemoModeMiddleware.cs` - トークンなしデモモード
- `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs` - トークンベース認証
- `backend/ShopifyAnalyticsApi/Middleware/StoreContextMiddleware.cs` - ストアコンテキスト設定
- `frontend/src/lib/api-client.ts` - APIクライアント
- `frontend/src/components/providers/AuthProvider.tsx` - 認証プロバイダー
