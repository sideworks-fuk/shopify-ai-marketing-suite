# デモモードログイン 仕様確認と問題点

**作成日**: 2026-01-22  
**問題**: デモモードログイン後の動作確認

---

## 🔍 確認された問題

### 問題1: プレースホルダーに固定のストアドメインが表示されている

**現象**:
- ストアドメイン入力フィールドに `example.myshopify.com` が実際に入力されている
- プレースホルダーではなく、実際の値として表示されている

**原因**:
- ブラウザの自動入力機能（autocomplete）が働いている可能性
- または、何らかの方法で初期値が設定されている

**対応**:
- `autocomplete="off"` を追加してブラウザの自動入力を無効化
- または、`autocomplete="new-password"` を使用（パスワードフィールドと同様の効果）

### 問題2: ログインできてもデータ参照モードで動いていない

**現象**:
- デモモードでログイン成功後、401エラーが発生
- コンソールログに `[AuthProvider] 認証情報が見つかりません` が表示される
- `GET /api/store 401 (Unauthorized)` エラーが発生

**原因の可能性**:
1. **ページ遷移後の認証状態の復元**: ログイン後にページ遷移した際、AuthProviderがデモトークンを正しく読み込めていない
2. **APIリクエスト時のトークン送信**: デモトークンがAPIリクエストに含まれていない
3. **readOnlyモードの動作**: バックエンドでreadOnlyモードが正しく検証されていない

---

## 📋 デモモードログインの仕様

### フロントエンド

#### ログイン処理
1. ストアドメインとパスワードを入力
2. `/api/demo/login` にPOSTリクエスト
3. レスポンスからJWTトークンを取得
4. localStorageに以下を保存:
   - `demoToken`: JWTトークン
   - `authMode`: `'demo'`
   - `readOnly`: `'true'`
   - `currentStoreId`: ストアID
5. `oauth_authenticated` フラグを削除（デモモードとOAuthモードの競合を防ぐ）
6. ダッシュボード（`/`）へリダイレクト

#### 認証状態の維持
- `AuthProvider` が `localStorage.getItem('demoToken')` を確認
- デモトークンがある場合、`ApiClient` に `getDemoToken` オプションを設定
- APIリクエスト時に `Authorization: Bearer {demoToken}` ヘッダーを送信

### バックエンド

#### 認証ミドルウェア（AuthModeMiddleware）
1. `Authorization` ヘッダーからトークンを取得
2. デモトークンの検証（`ValidateDemoTokenAsync`）
3. 検証成功時:
   - `context.Items["IsDemoMode"] = true` を設定
   - クレームに `read_only: true` を追加
   - `store_id`, `tenant_id`, `shop_domain` をクレームに追加

#### デモモードの制限
- **読み取り専用**: データの変更・削除は不可
- **セッションタイムアウト**: 8時間で自動ログアウト
- **DataType制限**: `DataType='demo'` のストアのみアクセス可能（デフォルト）

---

## 🔧 修正が必要な箇所

### 1. プレースホルダーの問題修正

**ファイル**: `frontend/src/app/demo/login/page.tsx`

```typescript
<Input
  type="text"
  placeholder="例: example.myshopify.com または xn-fbkq6e5da0fpb"
  value={shopDomain}
  onChange={(e) => setShopDomain(e.target.value)}
  disabled={isLoading}
  className="w-full"
  required
  autoFocus
  autoComplete="off" // 🔧 ブラウザの自動入力を無効化
/>
```

### 2. ログイン後の認証状態確認

**確認ポイント**:
- `AuthProvider` がデモトークンを正しく読み込んでいるか
- `ApiClient` がデモトークンを正しく送信しているか
- バックエンドがデモトークンを正しく検証しているか

**デバッグ方法**:
- ブラウザのコンソールで `localStorage.getItem('demoToken')` を確認
- ネットワークタブで `Authorization` ヘッダーが送信されているか確認
- バックエンドのログでデモトークンの検証結果を確認

---

## ✅ 確認項目

### ログイン前
- [ ] ストアドメイン入力フィールドが空である
- [ ] プレースホルダーが正しく表示されている

### ログイン後
- [ ] `localStorage` に `demoToken`, `authMode`, `readOnly`, `currentStoreId` が保存されている
- [ ] `oauth_authenticated` フラグが削除されている
- [ ] ダッシュボードにリダイレクトされる

### ページ遷移後
- [ ] `AuthProvider` がデモトークンを正しく読み込んでいる
- [ ] `ApiClient` がデモトークンを正しく送信している
- [ ] APIリクエストが成功している（401エラーが発生しない）
- [ ] データが正しく表示されている

### データ参照モード
- [ ] データの閲覧が可能である
- [ ] データの変更・削除ができない（読み取り専用）
- [ ] 適切なエラーメッセージが表示される（変更・削除を試みた場合）

---

## 🔗 関連ファイル

- `frontend/src/app/demo/login/page.tsx` - デモログインページ
- `frontend/src/components/providers/AuthProvider.tsx` - 認証プロバイダー
- `frontend/src/lib/api-client.ts` - APIクライアント
- `backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs` - デモ認証コントローラー
- `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs` - 認証ミドルウェア
- `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs` - デモ認証サービス
