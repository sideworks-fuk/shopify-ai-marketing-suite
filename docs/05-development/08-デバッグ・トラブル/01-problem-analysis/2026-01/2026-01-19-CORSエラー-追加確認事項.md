# CORSエラー: 追加確認事項

## 📋 現在の状況

- ✅ `appsettings.Production.json`に`https://ec-ranger.access-net.co.jp`が含まれている
- ✅ Azure PortalにCORS関連の環境変数は設定されていない
- ✅ CORSミドルウェアは正しく設定されている（`Program.cs`の536行目）
- ❌ しかし、CORSエラーが発生している

---

## 🔍 追加で確認すべき事項

### 1. バックエンドの再起動

**問題**: `appsettings.Production.json`の変更は、App Serviceを再起動しないと反映されない可能性があります。

**確認方法**:
1. Azure Portal → App Service → 概要
2. 「再起動」をクリック
3. 再起動完了を待つ（1〜2分）

**手順**:
```
Azure Portal → ec-ranger-backend-prod → 概要 → 再起動
```

---

### 2. デプロイの確認

**問題**: `appsettings.Production.json`が正しくデプロイされていない可能性があります。

**確認方法**:
1. Azure Portal → App Service → デプロイ → デプロイセンター
2. 最新のデプロイ日時を確認
3. `appsettings.Production.json`の変更日時と比較

**手順**:
```
Azure Portal → ec-ranger-backend-prod → デプロイ → デプロイセンター
```

---

### 3. ログストリームでCORS設定の確認

**問題**: CORS設定が正しく読み込まれているか確認する必要があります。

**確認方法**:
1. Azure Portal → App Service → 監視 → ログストリーム
2. アプリケーション起動時のログを確認
3. CORS関連のログがないか確認

**期待されるログ**:
- CORS設定が読み込まれたことを示すログ
- エラーログがないか確認

**手順**:
```
Azure Portal → ec-ranger-backend-prod → 監視 → ログストリーム
```

---

### 4. appsettings.Production.jsonのデプロイ確認

**問題**: Azure App Serviceでは、`appsettings.Production.json`はデプロイ時に含まれる必要があります。

**確認方法**:
1. Kudu（高度なツール）でファイルを確認
2. `D:\home\site\wwwroot\appsettings.Production.json`の内容を確認
3. `https://ec-ranger.access-net.co.jp`が含まれているか確認

**手順**:
1. Azure Portal → App Service → 開発ツール → 高度なツール → 移動
2. Debug console → CMD
3. 以下のコマンドを実行：
   ```cmd
   cd D:\home\site\wwwroot
   type appsettings.Production.json | findstr "ec-ranger.access-net.co.jp"
   ```

**期待される結果**:
```
"https://ec-ranger.access-net.co.jp",
```

---

### 5. 環境変数ASPNETCORE_ENVIRONMENTの確認

**問題**: `ASPNETCORE_ENVIRONMENT`が`Production`に設定されていない場合、`appsettings.Production.json`が読み込まれない可能性があります。

**確認方法**:
1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. `ASPNETCORE_ENVIRONMENT`の値を確認
3. 値が`Production`であることを確認

**期待される値**:
```
ASPNETCORE_ENVIRONMENT=Production
```

---

### 6. ブラウザのキャッシュクリア

**問題**: ブラウザが古いCORSレスポンスをキャッシュしている可能性があります。

**確認方法**:
1. ブラウザのキャッシュを完全にクリア
2. 開発者ツール（F12）→ Networkタブ → "Disable cache"にチェック
3. ハードリロード（Ctrl+Shift+R）

---

## ✅ 推奨される確認手順（優先順位順）

### ステップ1: App Serviceの再起動（最も重要）

1. Azure Portal → App Service → 概要 → 再起動
2. 再起動完了を待つ（1〜2分）
3. 動作確認

### ステップ2: ログストリームで起動ログを確認

1. Azure Portal → App Service → 監視 → ログストリーム
2. アプリケーション起動時のログを確認
3. エラーログがないか確認

### ステップ3: Kuduでappsettings.Production.jsonを確認

1. Azure Portal → App Service → 開発ツール → 高度なツール → 移動
2. Debug console → CMD
3. `D:\home\site\wwwroot\appsettings.Production.json`の内容を確認

### ステップ4: ASPNETCORE_ENVIRONMENTの確認

1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. `ASPNETCORE_ENVIRONMENT`が`Production`であることを確認

### ステップ5: ブラウザのキャッシュクリア

1. 開発者ツール（F12）→ Networkタブ → "Disable cache"にチェック
2. ハードリロード（Ctrl+Shift+R）

---

## 🔧 トラブルシューティング

### appsettings.Production.jsonがデプロイされていない場合

**解決方法**:
1. バックエンドを再デプロイ
2. デプロイ時に`appsettings.Production.json`が含まれているか確認

### ASPNETCORE_ENVIRONMENTがProductionでない場合

**解決方法**:
1. Azure Portal → App Service → 設定 → 構成 → アプリケーション設定
2. `ASPNETCORE_ENVIRONMENT`を`Production`に設定
3. App Serviceを再起動

### CORS設定が読み込まれていない場合

**解決方法**:
1. ログストリームでエラーログを確認
2. `Program.cs`のCORS設定を確認
3. 必要に応じて、Azure Portalの環境変数で直接設定

---

## 📝 チェックリスト

### 確認項目

- [ ] App Serviceを再起動した
- [ ] ログストリームで起動ログを確認した
- [ ] Kuduで`appsettings.Production.json`の内容を確認した
- [ ] `ASPNETCORE_ENVIRONMENT`が`Production`であることを確認した
- [ ] ブラウザのキャッシュをクリアした
- [ ] 動作確認を実施した

---

## 📚 参考情報

### 関連ドキュメント

- [ASP.NET Core 設定ファイルの読み込み順序](https://learn.microsoft.com/ja-jp/aspnet/core/fundamentals/configuration/)
- [Azure App Service 環境変数の設定](https://learn.microsoft.com/ja-jp/azure/app-service/configure-common)

### 関連ファイル

- `backend/ShopifyAnalyticsApi/appsettings.Production.json`
- `backend/ShopifyAnalyticsApi/Program.cs`

---

**最終更新**: 2026年1月19日  
**作成者**: 福田  
**修正者**: AI Assistant
