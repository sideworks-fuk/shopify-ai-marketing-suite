# 認証関連問題のトラブルシューティング

## 概要
Shopify AI Marketing Suiteの認証関連で発生する問題と解決策をまとめています。

---

## 問題1: JWTトークンが無効

### 症状
- 401 Unauthorized エラー
- 認証が必要なAPIにアクセスできない
- ログイン状態が維持されない

### 原因
- トークンの期限切れ（1時間）
- トークンの署名エラー
- トークンの形式が間違っている

### 解決策

#### 1. トークンの有効期限確認
```javascript
// フロントエンド
const token = localStorage.getItem('access_token');
if (token) {
  const payload = JSON.parse(atob(token.split('.')[1]));
  const expiration = new Date(payload.exp * 1000);
  const now = new Date();
  
  if (now > expiration) {
    console.log('⏰ トークンが期限切れです');
    // 再認証を実行
  }
}
```

#### 2. トークンの再取得
```javascript
// リフレッシュトークンを使用
const refreshToken = localStorage.getItem('refresh_token');
if (refreshToken) {
  const response = await fetch('/api/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refreshToken })
  });
  
  if (response.ok) {
    const data = await response.json();
    localStorage.setItem('access_token', data.accessToken);
  }
}
```

#### 3. バックエンドでの検証
```csharp
// バックエンド
public bool ValidateToken(string token)
{
    try
    {
        var handler = new JwtSecurityTokenHandler();
        var jsonToken = handler.ReadJwtToken(token);
        
        // 有効期限確認
        if (jsonToken.ValidTo < DateTime.UtcNow)
        {
            _logger.LogWarning("トークンが期限切れです");
            return false;
        }
        
        return true;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "トークン検証エラー");
        return false;
    }
}
```

---

## 問題2: Shopify OAuth認証失敗

### 症状
- OAuth認証画面でエラー
- インストールが完了しない
- HMAC検証エラー

### 原因
- HMAC検証エラー
- リダイレクトURL不一致
- 環境変数の設定ミス

### 解決策

#### 1. HMAC検証の確認
```csharp
// バックエンド
private bool VerifyHmac(string queryString, string secret)
{
    var hmac = queryString.Split('&')
        .Where(p => !p.StartsWith("hmac="))
        .OrderBy(p => p)
        .Aggregate((a, b) => a + "&" + b);
    
    var computedHmac = Convert.ToHexString(
        new HMACSHA256(Encoding.UTF8.GetBytes(secret))
            .ComputeHash(Encoding.UTF8.GetBytes(hmac)));
    
    return computedHmac.Equals(queryString.Split('&')
        .First(p => p.StartsWith("hmac="))
        .Split('=')[1], StringComparison.OrdinalIgnoreCase);
}
```

#### 2. 環境変数の確認
```bash
# 環境変数の確認
echo $SHOPIFY_API_KEY
echo $SHOPIFY_API_SECRET
echo $SHOPIFY_REDIRECT_URI
```

#### 3. 開発環境での一時的な回避
```csharp
// 開発環境でのみHMAC検証をスキップ
var isDevelopment = _configuration["ASPNETCORE_ENVIRONMENT"] == "Development";

if (!isDevelopment && !VerifyHmac(request.Code, request.Shop, request.State, request.Timestamp, request.Hmac))
{
    _logger.LogWarning("HMAC検証失敗. Shop: {Shop}", request.Shop);
    return Unauthorized(new { error = "HMAC validation failed" });
}
```

---

## 問題3: デモモード認証エラー

### 症状
- デモモードでログインできない
- パスワードが正しくない
- セッションが維持されない

### 原因
- パスワードの不一致
- セッション期限切れ
- 環境変数の設定ミス

### 解決策

#### 1. パスワードの確認
```javascript
// フロントエンド
const correctPassword = process.env.NEXT_PUBLIC_DEV_PASSWORD;
const inputPassword = document.getElementById('password').value;

if (inputPassword === correctPassword) {
  // 認証成功
  localStorage.setItem('dev_mode_auth', 'true');
  localStorage.setItem('dev_session_expires', Date.now() + 3600000); // 1時間
} else {
  // 認証失敗
  console.error('❌ パスワードが間違っています');
}
```

#### 2. セッション期限の確認
```javascript
// セッション期限の確認
const sessionExpires = localStorage.getItem('dev_session_expires');
if (sessionExpires && Date.now() > parseInt(sessionExpires)) {
  // セッション期限切れ
  localStorage.removeItem('dev_mode_auth');
  localStorage.removeItem('dev_session_expires');
  // 再認証を要求
}
```

#### 3. 環境変数の確認
```bash
# 環境変数の確認
echo $NEXT_PUBLIC_DEV_PASSWORD
echo $NEXT_PUBLIC_ENABLE_DEV_TOOLS
```

---

## 問題4: マルチテナント認証エラー

### 症状
- 他のストアのデータにアクセスできる
- ストアIDが正しく設定されていない
- データの分離ができていない

### 原因
- ストアIDの検証不足
- 認証トークンにストアIDが含まれていない
- データアクセス時のストアIDチェック不足

### 解決策

#### 1. ストアIDの検証
```csharp
// バックエンド
public async Task<IActionResult> GetData(int storeId)
{
    // 認証トークンからストアIDを取得
    var tokenStoreId = GetStoreIdFromToken();
    
    if (tokenStoreId != storeId)
    {
        _logger.LogWarning("ストアID不一致: Token={TokenStoreId}, Request={RequestStoreId}", 
            tokenStoreId, storeId);
        return Forbid("他のストアのデータにアクセスできません");
    }
    
    // データ取得処理
    var data = await _dataService.GetDataAsync(storeId);
    return Ok(data);
}
```

#### 2. フロントエンドでのストアID管理
```javascript
// ストアIDの取得と保存
const currentStoreId = localStorage.getItem('currentStoreId');
if (!currentStoreId) {
  // ストアIDが設定されていない場合は認証画面にリダイレクト
  window.location.href = '/auth';
}

// APIリクエスト時にストアIDを含める
const response = await fetch(`/api/data?storeId=${currentStoreId}`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

---

## 問題5: セッション管理エラー

### 症状
- ログイン状態が維持されない
- ページリロード時に認証が切れる
- 複数タブで認証状態が同期されない

### 原因
- LocalStorageの設定ミス
- セッション期限の管理不足
- 複数タブ間の同期不足

### 解決策

#### 1. LocalStorageの適切な管理
```javascript
// セッション情報の保存
const saveSession = (token, expiresIn) => {
  localStorage.setItem('access_token', token);
  localStorage.setItem('session_expires', Date.now() + (expiresIn * 1000));
  localStorage.setItem('is_authenticated', 'true');
};

// セッション情報の取得
const getSession = () => {
  const token = localStorage.getItem('access_token');
  const expires = localStorage.getItem('session_expires');
  const isAuthenticated = localStorage.getItem('is_authenticated');
  
  if (!token || !expires || Date.now() > parseInt(expires)) {
    // セッション期限切れ
    clearSession();
    return null;
  }
  
  return { token, isAuthenticated: isAuthenticated === 'true' };
};

// セッション情報のクリア
const clearSession = () => {
  localStorage.removeItem('access_token');
  localStorage.removeItem('session_expires');
  localStorage.removeItem('is_authenticated');
};
```

#### 2. 複数タブ間の同期
```javascript
// ストレージイベントの監視
window.addEventListener('storage', (event) => {
  if (event.key === 'is_authenticated' && event.newValue === 'false') {
    // 他のタブでログアウトされた場合
    window.location.href = '/auth';
  }
});
```

---

## チェックリスト

### 認証問題の診断
- [ ] トークンの有効期限を確認
- [ ] トークンの形式を確認
- [ ] 環境変数の設定を確認
- [ ] ネットワーク接続を確認
- [ ] ブラウザのコンソールエラーを確認

### 設定確認
- [ ] Shopify API設定の確認
- [ ] リダイレクトURLの確認
- [ ] 環境変数の確認
- [ ] データベース接続の確認

### ログ確認
- [ ] フロントエンドのコンソールログ
- [ ] バックエンドのアプリケーションログ
- [ ] ネットワークタブのリクエスト/レスポンス
- [ ] ブラウザの開発者ツール

---

## 関連ドキュメント

- [認証モード一覧](../09-認証・セキュリティ/認証モード一覧.md)
- [認証画面表示仕様](../09-認証・セキュリティ/認証画面表示仕様.md)
- [環境変数チェックリスト](../09-認証・セキュリティ/環境変数チェックリスト.md)
- [HMAC検証問題](./01-problem-analysis/2025-08/hmac-verification-issue/問題分析.md)

---

**最終更新**: 2025年10月25日
**次回レビュー**: 2025年11月1日（週次）
