# 管理者ダッシュボード使用方法

## 📋 概要

バックエンドAPIのバージョン情報、デプロイ状況、システム情報を確認できる管理者向けの簡易サイトです。

## 🔗 アクセス方法

### 基本URL

```
https://{your-backend-url}/admin
```

### 例

```
https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net/admin
```

**アクセス時**: ブラウザでBasic認証のダイアログが表示されます。ユーザー名とパスワードを入力してください。

---

## 🔑 Basic認証の設定

管理者ダッシュボード、Swagger UI、HangFireダッシュボードは**共通のBasic認証**で保護されています。

### 方法1: 環境変数（推奨）

Azure App Serviceの設定で環境変数を追加：

```
Admin__BasicAuth__Username=admin
Admin__BasicAuth__Password=your-secure-password-here
```

または、従来の設定名もサポートされています：

```
Swagger__BasicAuth__Username=admin
Swagger__BasicAuth__Password=your-secure-password-here
Hangfire__Dashboard__Username=admin
Hangfire__Dashboard__Password=your-secure-password-here
```

### 方法2: appsettings.json

`appsettings.json`または`appsettings.Production.json`に追加：

```json
{
  "Admin": {
    "BasicAuth": {
      "Username": "admin",
      "Password": "your-secure-password-here",
      "SkipInDevelopment": false
    }
  }
}
```

**設定の優先順位**:
1. `Admin:BasicAuth:Username` / `Admin:BasicAuth:Password`（最優先）
2. `Swagger:BasicAuth:Username` / `Swagger:BasicAuth:Password`
3. `Hangfire:Dashboard:Username` / `Hangfire:Dashboard:Password`
4. デフォルト値（`admin` / `Admin2025!`）

**⚠️ セキュリティ注意事項**:
- パスワードは強力なランダム文字列を使用してください（推奨: 32文字以上）
- `appsettings.json`に設定する場合は、Gitにコミットしないでください（`.gitignore`に追加）
- 本番環境では必ず環境変数を使用してください
- 認証成功後、8時間有効なセッションCookieが設定されます（`admin_auth_session`）

---

## 📊 表示される情報

### アプリケーション情報
- アプリケーション名
- バージョン
- 詳細バージョン
- 環境（Production/Development）

### デプロイ情報
- ビルド日時
- デプロイ日時（実行ファイルの更新日時）
- サーバー時刻（UTC/JST）

### システム情報
- マシン名
- OS情報
- .NET フレームワークバージョン
- プロセスID
- メモリ使用量

---

## 🔗 管理リンク

管理者ダッシュボードから以下のリンクにアクセスできます：

- **HangFire ダッシュボード**: バックグラウンドジョブの状態を確認（同じBasic認証でアクセス可能）
- **ヘルスチェック**: アプリケーションの健全性を確認
- **JSON形式で取得**: APIとして情報を取得（`/admin/info`、同じBasic認証でアクセス可能）
- **Swagger UI**: API仕様を確認（同じBasic認証でアクセス可能）

**認証について**: 一度Basic認証に成功すると、8時間有効なセッションCookieが設定されるため、同じブラウザセッション内では再認証不要でアクセスできます。

---

## 📡 JSON API

### エンドポイント

```
GET /admin/info
```

**認証**: Basic認証が必要です（ブラウザの認証ダイアログ、または`Authorization: Basic {base64(username:password)}`ヘッダー）

### レスポンス例

```json
{
  "versionInfo": {
    "applicationName": "ShopifyAnalyticsApi",
    "version": "1.0.0.0",
    "informationalVersion": "1.0.0",
    "buildDate": "2026-01-23T10:00:00Z",
    "deployDate": "2026-01-23T15:30:00Z",
    "environment": "Production",
    "isDevelopment": false,
    "isProduction": true,
    "machineName": "EC-RANGER-BACKEND",
    "osVersion": "Microsoft Windows 10.0.20348",
    "frameworkVersion": ".NET 8.0.0",
    "processId": 12345,
    "workingSet": 524288000,
    "serverTime": "2026-01-23T18:00:00Z",
    "serverTimeLocal": "2026-01-24T03:00:00"
  },
  "database": {
    "canConnect": true,
    "connectionString": "Server=***;Database=***;User Id=***;Password=***"
  },
  "hangfireUrl": "/hangfire",
  "healthCheckUrl": "/health"
}
```

---

## 🚀 デプロイ確認の使い方

### ステップ1: デプロイ前の確認

デプロイ前に現在のデプロイ日時を確認：

```
https://{your-backend-url}/admin
```

Basic認証のダイアログで認証後、「デプロイ日時」を記録しておきます。

### ステップ2: デプロイ実行

GitHub Actionsでデプロイを実行します。

### ステップ3: デプロイ後の確認

デプロイ後、再度管理者ダッシュボードにアクセス：

```
https://{your-backend-url}/admin
```

「デプロイ日時」が更新されていることを確認します。

**✅ デプロイ日時が更新されていれば、デプロイは成功しています**

---

## 🔧 トラブルシューティング

### 問題: Basic認証が失敗する

**原因**: 認証情報が設定されていない、または間違っている

**解決方法**:
1. Azure Portalで環境変数`Admin__BasicAuth__Username`と`Admin__BasicAuth__Password`が設定されているか確認
2. `appsettings.json`に`Admin:BasicAuth:Username`と`Admin:BasicAuth:Password`が設定されているか確認
3. ユーザー名とパスワードが正しいか確認
4. 設定の優先順位を確認（`Admin:BasicAuth` > `Swagger:BasicAuth` > `Hangfire:Dashboard`）

### 問題: デプロイ日時が更新されない

**原因**: デプロイが失敗している、またはスワップが実行されていない

**解決方法**:
1. GitHub Actionsのログを確認
2. Azure PortalでApp Serviceのデプロイスロットを確認
3. スワップが実行されているか確認

### 問題: ページが表示されない

**原因**: ルーティングの問題、または認証ミドルウェアの影響

**解決方法**:
1. `/admin`の形式でアクセスしているか確認
2. Basic認証のダイアログが表示されているか確認
3. 認証情報が正しく設定されているか確認
4. アプリケーションログを確認

---

## 🔐 セキュリティ

- パスワードは強力なランダム文字列を使用してください（推奨: 32文字以上）
- 本番環境では必ず環境変数を使用してください
- 認証情報をGitにコミットしないでください
- 定期的にパスワードをローテーションしてください
- セッションCookieは8時間有効です（`admin_auth_session`）
- HTTPS必須（`Secure`フラグが有効）

---

## 📝 今後の拡張予定

以下の機能を将来的に追加予定：

- [ ] ログダウンロード機能
- [ ] 同期状況の確認
- [ ] データベース接続状態の詳細表示
- [ ] パフォーマンスメトリクスの表示
- [ ] エラー統計の表示

---

## 🔗 関連ドキュメント

- [HangFireダッシュボード使用方法](../04-Azure_DevOps/HangFire設定ガイド.md)
- [デプロイメントガイド](../04-Azure_DevOps/デプロイメントマスターガイド.md)
- [ヘルスチェック設定](../04-Azure_DevOps/Application-Insights-ログ確認方法.md)
