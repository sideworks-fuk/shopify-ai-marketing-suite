# データ同期デバッグ - テスト手順

## 📋 概要

修正した注文データ同期処理（Protected Customer Dataエラー対応）をローカル環境でデバッグ・テストする手順です。

---

## ✅ 前提条件

- [x] バックエンドが起動している（`http://localhost:5168`）
- [x] Postmanで開発者認証が完了している
- [x] トークンが環境変数に設定されている
- [x] StoreId=18のストアがデータベースに存在する

---

## 🧪 テスト手順

### ステップ1: 初期データ同期を実行

#### Postmanでの設定

1. **新しいリクエストを作成**
   - Method: `POST`
   - URL: `{{baseUrl}}/api/sync/initial`

2. **Authorizationタブ**
   - Type: `Bearer Token`
   - Token: `{{token}}`

3. **Headersタブ**
   - `X-Store-Id`: `{{storeId}}`（18）
   - `Content-Type`: `application/json`

4. **Bodyタブ**
   - `raw` → `JSON`
   ```json
   {
     "syncPeriod": "3months"
   }
   ```

5. **リクエストを実行**
   - 「Send」ボタンをクリック
   - レスポンスを確認:
     ```json
     {
       "syncId": 20,
       "jobId": "abc123...",
       "status": "started",
       "message": "Initial sync has been started"
     }
     ```

---

### ステップ2: 同期ステータスを確認

#### 同期ステータス取得

1. **新しいリクエストを作成**
   - Method: `GET`
   - URL: `{{baseUrl}}/api/sync/status/{{syncId}}`
     - `{{syncId}}`はステップ1で取得した`syncId`（例: 20）

2. **Authorizationタブ**
   - Type: `Bearer Token`
   - Token: `{{token}}`

3. **Headersタブ**
   - `X-Store-Id`: `{{storeId}}`（18）

4. **リクエストを実行**
   - 「Send」ボタンをクリック
   - レスポンスを確認:
     ```json
     {
       "id": "20",
       "status": "running",
       "currentTask": "注文データ取得中",
       "processedRecords": 150,
       "totalRecords": 0
     }
     ```

5. **ポーリング**
   - 10秒ごとにリクエストを実行
   - ステータスが`completed`または`failed`になるまで繰り返し

---

### ステップ3: バックエンドログを確認

バックエンドを起動したターミナルで、以下のログを確認：

#### 期待されるログ（修正後の動作）

```
[INF] 🟡 [ShopifyDataSyncService] 顧客データ同期開始
[ERR] 🔴 [CustomerSyncJob] Failed to fetch customers: Forbidden
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ 顧客データ同期が失敗しました（Protected Customer Data未承認）
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ 商品・注文データの同期を続行します

[INF] 🟡 [ShopifyDataSyncService] 商品データ同期開始
[INF] 🟡 [ShopifyDataSyncService] ✅ 商品データ同期完了: Count=150, StoreId=18

[INF] 🟡 [ShopifyDataSyncService] 注文データ同期開始
[ERR] 🔴 [OrderSyncJob] Failed to fetch orders: Forbidden
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ 注文データ同期が失敗しました（Protected Customer Data未承認）
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ エラー詳細: Failed to fetch orders: Protected customer data. Forbidden
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ 商品データの同期は完了しています
[INF] 🟡 [ShopifyDataSyncService] ✅ 部分的な同期完了: Total=150 (Customers=0, Products=150, Orders=0), StoreId=18
```

#### 確認ポイント

- ✅ 顧客データ同期が`Forbidden`エラーで失敗しても、処理が続行される
- ✅ 商品データ同期が成功する
- ✅ 注文データ同期が`Forbidden`エラーで失敗しても、処理が続行される
- ✅ 最終的に「部分的な同期完了」ログが出力される
- ✅ 同期ステータスが`completed`になる（部分的な成功）

---

### ステップ4: 同期結果の確認

#### 同期ステータスの最終確認

1. **同期ステータスを取得**
   ```
   GET {{baseUrl}}/api/sync/status/{{syncId}}
   ```

2. **期待されるレスポンス**
   ```json
   {
     "id": "20",
     "status": "completed",
     "currentTask": "注文データ同期スキップ（Protected Customer Data未承認）",
     "processedRecords": 150,
     "totalRecords": 150,
     "message": "注文データ同期がスキップされました: Protected Customer Data未承認。詳細: Failed to fetch orders: Protected customer data. Forbidden"
   }
   ```

3. **確認ポイント**
   - `status`: `completed`（部分的な成功）
   - `processedRecords`: 150（商品データのみ）
   - `message`: 注文データ同期がスキップされた旨が記載されている

---

## 🔍 デバッグのポイント

### 1. ログレベルの調整

詳細なログを確認する場合、`appsettings.Development.json`でログレベルを調整：

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "ShopifyAnalyticsApi.Services.ShopifyDataSyncService": "Debug",
      "ShopifyAnalyticsApi.Jobs.ShopifyOrderSyncJob": "Debug"
    }
  }
}
```

### 2. ブレークポイントの設定

Visual StudioやVS Codeでデバッグ実行する場合：

1. **ブレークポイントを設定**
   - `ShopifyDataSyncService.cs` の `RunInitialSyncWithJobs` メソッド（注文データ同期部分）
   - `ShopifyApiService.cs` の `FetchOrdersPageAsync` メソッド（エラーハンドリング部分）

2. **F5キーでデバッグ実行**
   - ブレークポイントで停止して、変数の値を確認
   - `errorMessage`の内容を確認
   - `isProtectedCustomerDataError`の判定結果を確認

### 3. エラーレスポンスの詳細確認

`ShopifyApiService.FetchOrdersPageAsync`でエラーレスポンスの内容を確認：

```csharp
var errorContent = await response.Content.ReadAsStringAsync();
_logger.LogError("🛒 [ShopifyApiService] Failed to fetch orders: StatusCode={StatusCode}, ErrorContent={ErrorContent}, StoreId={StoreId}", 
    response.StatusCode, errorContent, storeId);
```

このログで、`Protected Customer Data`エラーかどうかを確認できます。

---

## ✅ 検証チェックリスト

### 修正前の動作確認（参考）

- [ ] 注文データ同期が`Forbidden`エラーで失敗すると、同期全体が失敗する
- [ ] 商品データ同期は成功しているにもかかわらず、同期全体が失敗として扱われる

### 修正後の動作確認（必須）

- [ ] 顧客データ同期が`Forbidden`エラーの場合、警告を出して続行する
- [ ] 商品データ同期が成功する
- [ ] 注文データ同期が`Forbidden`エラーの場合、警告を出して続行する
- [ ] 同期ステータスが`completed`になる（部分的な成功）
- [ ] エラーメッセージに「注文データ同期がスキップされました」が含まれる
- [ ] ログに「部分的な同期完了」が出力される
- [ ] `processedRecords`が商品データの件数（例: 150）になっている

---

## 🎯 期待される動作フロー

### 正常な同期（すべて成功）

```
1. 顧客データ同期: 成功 ✅
2. 商品データ同期: 成功 ✅
3. 注文データ同期: 成功 ✅
4. 同期ステータス: completed ✅
```

### 部分的な同期（Protected Customer Data未承認）

```
1. 顧客データ同期: Forbiddenエラー → 警告を出して続行 ⚠️
2. 商品データ同期: 成功 ✅
3. 注文データ同期: Forbiddenエラー → 警告を出して続行 ⚠️
4. 同期ステータス: completed（部分的な成功）✅
5. processedRecords: 150（商品データのみ）✅
```

---

## 📊 ログの見方

### 成功ログの例

```
[INF] ✅ 商品データ同期完了: Count=150, StoreId=18
[INF] ✅ 部分的な同期完了: Total=150 (Customers=0, Products=150, Orders=0), StoreId=18
```

### エラーログの例

```
[ERR] 🔴 [OrderSyncJob] Failed to fetch orders from Shopify for store 18. Error: Failed to fetch orders: Forbidden
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ 注文データ同期が失敗しました（Protected Customer Data未承認）
[WRN] 🟡 [ShopifyDataSyncService] ⚠️ エラー詳細: Failed to fetch orders: Protected customer data. Forbidden
```

---

## 🚨 トラブルシューティング

### 問題1: 同期が完了しない

**症状**: 同期ステータスが`running`のまま

**確認事項**:
1. バックエンドログでエラーが発生していないか確認
2. Hangfireダッシュボードでジョブの状態を確認（`http://localhost:5168/hangfire`）
3. データベース接続が正常か確認

---

### 問題2: 商品データ同期も失敗する

**症状**: 商品データ同期が`Forbidden`エラーで失敗

**確認事項**:
1. ストアのAccessTokenが正しく設定されているか確認
2. Shopify APIのレート制限に達していないか確認
3. ネットワーク接続が正常か確認

---

### 問題3: ログに「部分的な同期完了」が出力されない

**症状**: 注文データ同期が失敗しても、ログに「部分的な同期完了」が出力されない

**確認事項**:
1. 修正が正しくデプロイされているか確認
2. バックエンドを再起動して、最新のコードが読み込まれているか確認
3. ログレベルが`Information`以上に設定されているか確認

---

## 📚 関連ドキュメント

- [ローカルAPIデバッグ手順-データ同期テスト](./ローカルAPIデバッグ手順-データ同期テスト.md)
- [データ同期-注文データForbiddenエラー対応](../01-problem-analysis/2026-01/2026-01-19-データ同期-注文データForbiddenエラー対応.md)
- [データ同期失敗-Protected-Customer-Dataエラー](../01-problem-analysis/2026-01/2026-01-19-データ同期失敗-Protected-Customer-Dataエラー.md)

---

**最終更新**: 2026年1月19日  
**作成者**: AI Assistant
