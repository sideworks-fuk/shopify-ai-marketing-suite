# ステージングスロット - ログ取得方法

## 📋 概要

Azure App Serviceのステージングスロットのログを取得する方法を説明します。

## 🚀 クイックスタート

**Kuduサイトに直接アクセスできない場合の推奨方法**:

### 最も簡単な方法: Azure Portal経由

1. **Azure Portal**にログイン → https://portal.azure.com
2. **App Service**を開く → `ec-ranger-backend-prod-ghf3bbarghcwh4gn`
3. **デプロイスロット** → `staging`をクリック
4. **開発ツール** → **高度なツール (Kudu)** → **移動**
5. **Debug console** → **CMD**
6. フォルダパス: `LogFiles\Application`
7. 最新のログファイルをダウンロード

### コマンドラインで取得（Azure CLI）

```powershell
az login
az webapp log download --resource-group ec-ranger-prod --name ec-ranger-backend-prod-ghf3bbarghcwh4gn --slot staging --log-file staging-logs.zip
Expand-Archive -Path staging-logs.zip -DestinationPath staging-logs
```

### リアルタイム検索（Application Insights）

1. Azure Portal → Application Insights → **ログ (Logs)**
2. クエリを実行:
   ```kusto
   traces
   | where timestamp > ago(1h)
   | where message contains "Admin Basic"
   | order by timestamp desc
   ```

---

## 🔧 方法1: Azure Portalから直接ダウンロード（推奨・最も確実）

### ステップ1: ステージングスロットを開く

1. **Azure Portal**にログイン
   - https://portal.azure.com

2. **App Serviceを開く**
   - リソースグループ: `ec-ranger-prod`
   - App Service名: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`

3. **デプロイスロットを選択**
   - 左メニュー → 「デプロイ」→ 「デプロイ スロット」
   - `staging`スロットをクリック
   - **重要**: ステージングスロットのページが開いていることを確認（URLに`staging`が含まれている）

### ステップ2: Kuduサイトを開く（Azure Portal経由）

1. **高度なツール (Kudu) を開く**
   - 左メニュー → 「開発ツール」→ 「高度なツール (Kudu)」
   - 「移動」をクリック
   - **注意**: この方法で開くと、Azure Portalの認証が自動的に適用されます

2. **Kuduサイトが開くことを確認**
   - URLが `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.scm.japanwest-01.azurewebsites.net` になっていることを確認

### ステップ3: ログファイルにアクセス

1. **Debug consoleを開く**
   - Kuduサイトで、上部メニュー → 「Debug console」→ 「CMD」

2. **ログフォルダに移動**
   - フォルダパス: `LogFiles\Application`
   - または、上部のアドレスバーに直接入力:
     ```
     LogFiles\Application
     ```

3. **ログファイルをダウンロード**
   - 最新のログファイル（例: `app-20260123_008.log`）をクリック
   - 「Download」をクリックしてダウンロード

### ステップ4: ログストリームでリアルタイム確認（オプション）

1. **ログストリームを開く**
   - Azure Portalでステージングスロットのページに戻る
   - 左メニュー → 「監視」→ 「ログストリーム」
   - リアルタイムでログを確認できます

---

## 🔧 方法2: Kudu (SCM) サイトから直接アクセス

**⚠️ 注意**: この方法は認証が必要な場合があります。アクセスできない場合は、**方法1（Azure Portal経由）**を使用してください。

### ステップ1: Kuduサイトにアクセス

**URL形式**:
```
https://{app-service-name}-staging.scm.{region}.azurewebsites.net
```

**例**:
```
https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.scm.japanwest-01.azurewebsites.net
```

**認証が必要な場合**:
- Azure Portalにログインしている状態で、同じブラウザでアクセスを試してください
- それでもアクセスできない場合は、**方法1（Azure Portal経由）**を使用してください

### ステップ2: ログファイルにアクセス

1. **Debug consoleを開く**
   - 上部メニュー → 「Debug console」→ 「CMD」

2. **ログフォルダに移動**
   - フォルダパス: `LogFiles\Application`
   - または、直接URL（認証が必要な場合があります）:
     ```
     https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.scm.japanwest-01.azurewebsites.net/api/vfs/LogFiles/Application/
     ```

3. **ログファイルをダウンロード**
   - 最新のログファイルをクリック
   - 「Download」をクリック

---

## 🔧 方法3: Azure CLIを使用（推奨・コマンドライン）

**✅ この方法は認証の問題を回避できます**

### 前提条件

- Azure CLIがインストールされていること
- Azureにログインしていること

### ステップ1: Azure CLIのインストール確認

```powershell
# Azure CLIがインストールされているか確認
az --version
```

**インストールされていない場合**:
- Windows: `winget install -e --id Microsoft.AzureCLI`
- または、[Azure CLI公式サイト](https://learn.microsoft.com/ja-jp/cli/azure/install-azure-cli)からダウンロード

### ステップ2: Azureにログイン

```powershell
# Azureにログイン
az login

# ブラウザが開き、Azureアカウントでログインします
# ログイン後、ターミナルに「You have logged in to Microsoft Azure!」と表示されます
```

### ステップ3: ログをダウンロード

```powershell
# ステージングスロットのログをダウンロード
az webapp log download `
  --resource-group ec-ranger-prod `
  --name ec-ranger-backend-prod-ghf3bbarghcwh4gn `
  --slot staging `
  --log-file staging-logs.zip
```

**実行結果**:
- `staging-logs.zip`ファイルが現在のディレクトリにダウンロードされます

### ステップ4: ログファイルを展開

```powershell
# ZIPファイルを展開
Expand-Archive -Path staging-logs.zip -DestinationPath staging-logs

# ログファイルの場所を確認
Get-ChildItem staging-logs\LogFiles\Application
```

### ログファイルの場所

ダウンロードしたZIPファイルを展開すると、以下のフォルダ構造になります：

```
staging-logs/
  └── LogFiles/
      └── Application/
          └── app-YYYYMMDD_NNN.log
```

### ステップ5: ログを検索

```powershell
# Admin Basic関連のログを検索
Select-String -Path "staging-logs\LogFiles\Application\app-*.log" -Pattern "Admin Basic" -Context 5
```

---

## 🔧 方法4: Application Insightsを使用（推奨・リアルタイム検索）

**✅ この方法は認証の問題を回避でき、リアルタイムでログを検索できます**

### 前提条件

- Application Insightsが有効になっていること
- ログがApplication Insightsに送信されていること

### ステップ1: Application Insightsを開く

1. **Azure Portal**でステージングスロットを開く
   - リソースグループ: `ec-ranger-prod`
   - App Service名: `ec-ranger-backend-prod-ghf3bbarghcwh4gn`
   - デプロイスロット: `staging`

2. **Application Insightsを開く**
   - 左メニュー → 「監視」→ 「Application Insights」
   - Application Insightsリソースを開く

### ステップ2: ログを検索

1. **ログ (Logs)** を開く
   - 左メニュー → 「ログ (Logs)」

2. **クエリを実行**
   ```kusto
   traces
   | where timestamp > ago(1h)
   | where message contains "Admin Basic"
   | order by timestamp desc
   ```

3. **より詳細な検索**
   ```kusto
   traces
   | where timestamp > ago(24h)
   | where message contains "Admin Basic" or message contains "authentication"
   | project timestamp, message, severityLevel
   | order by timestamp desc
   ```

4. **結果をエクスポート**
   - 「エクスポート」→ 「CSVにエクスポート」または「Excelにエクスポート」
   - または、「結果をコピー」でクリップボードにコピー

---

## 🔧 方法5: Log Streamでリアルタイム確認

### ステップ1: Log Streamを開く

1. **Azure Portal**でステージングスロットを開く
2. 左メニュー → 「監視」→ 「ログストリーム」

### ステップ2: ログを確認

- リアルタイムでログが表示されます
- ブラウザの開発者ツールで「ネットワーク」タブを開き、ログストリームのURLを確認できます

---

## 📝 ログファイルの命名規則

ログファイルは以下の命名規則に従います：

```
app-YYYYMMDD_NNN.log
```

- `YYYYMMDD`: 日付（例: 20260123）
- `NNN`: 連番（例: 008）

**例**:
- `app-20260123_008.log` - 2026年1月23日の8番目のログファイル

---

## 🔍 ログの検索方法

### PowerShellでログを検索

```powershell
# ログファイルをダウンロード後、検索
Select-String -Path "app-20260123_008.log" -Pattern "Admin Basic" -Context 5
```

### 特定の時間範囲のログを検索

```powershell
# 特定の時間範囲のログを抽出
Get-Content "app-20260123_008.log" | 
  Where-Object { $_ -match "2026-01-23 04:4[0-9]" } | 
  Where-Object { $_ -match "Admin Basic" }
```

---

## ⚠️ 注意事項

### 1. ログファイルの保持期間

- **デフォルト**: ログファイルは一定期間後に自動削除されます
- **推奨**: 重要なログは定期的にダウンロードして保存してください

### 2. ログファイルのサイズ

- ログファイルは大きくなる可能性があります（数百MB以上）
- ダウンロードに時間がかかる場合があります

### 3. ステージングスロットのURL

- ステージングスロットのURLは本番スロットと異なります
- 例:
  - 本番: `https://ec-ranger-backend-prod-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`
  - ステージング: `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.japanwest-01.azurewebsites.net`

---

## 🔧 トラブルシューティング

### 問題1: Kuduサイトに直接アクセスできない

**症状**: 
- `https://ec-ranger-backend-prod-staging-ghf3bbarghcwh4gn.scm.japanwest-01.azurewebsites.net` にアクセスできない
- 401 Unauthorized エラーが表示される

**解決方法**:

1. **Azure Portal経由でアクセス**（推奨）
   - Azure Portal → App Service → デプロイスロット → `staging` → 「開発ツール」→ 「高度なツール (Kudu)」→ 「移動」
   - この方法で開くと、Azure Portalの認証が自動的に適用されます

2. **Azure CLIを使用**
   ```powershell
   az webapp log download --resource-group ec-ranger-prod --name ec-ranger-backend-prod-ghf3bbarghcwh4gn --slot staging --log-file staging-logs.zip
   ```

3. **Application Insightsを使用**
   - Azure Portal → Application Insights → 「ログ (Logs)」
   - クエリでログを検索

### 問題2: ログファイルが見つからない

**症状**: 
- `LogFiles\Application` フォルダが空
- ログファイルが存在しない

**解決方法**:

1. **ログ出力が有効になっているか確認**
   - Azure Portal → App Service → ステージングスロット → 「設定」→ 「App Service ログ」
   - 「アプリケーション ログ記録 (ファイル システム)」が「オン」になっているか確認

2. **ログレベルを確認**
   - `appsettings.Production.json` または環境変数でログレベルが適切に設定されているか確認

3. **ログストリームで確認**
   - Azure Portal → 「監視」→ 「ログストリーム」
   - リアルタイムでログが表示されるか確認

### 問題3: ログファイルが大きすぎてダウンロードできない

**症状**: 
- ログファイルが数百MB以上
- ダウンロードに時間がかかる、またはタイムアウトする

**解決方法**:

1. **Application Insightsを使用**
   - 必要な期間のログのみを検索・エクスポート

2. **Azure CLIで特定の期間のみダウンロード**
   ```powershell
   # 過去1時間のログのみを検索（Application Insights推奨）
   ```

3. **ログファイルを分割してダウンロード**
   - Kuduサイトで、古いログファイルから順にダウンロード

---

## 🔗 関連ドキュメント

- [Azure App Service - ログ出力設定](../01-problem-analysis/2025-12/Azure-App-Service-ログ出力設定.md)
- [ログ解析ツールガイド](./ログ解析ツールガイド.md)
- [デプロイスロット作成-手順書](../../04-Azure_DevOps/デプロイスロット作成-手順書.md)

---

## 📚 参考リンク

- [Azure App Service - ログの有効化と確認](https://learn.microsoft.com/ja-jp/azure/app-service/troubleshoot-diagnostic-logs)
- [Kudu (SCM) サイトの使用方法](https://github.com/projectkudu/kudu/wiki)
- [Azure CLI - webapp log コマンド](https://learn.microsoft.com/ja-jp/cli/azure/webapp/log)
