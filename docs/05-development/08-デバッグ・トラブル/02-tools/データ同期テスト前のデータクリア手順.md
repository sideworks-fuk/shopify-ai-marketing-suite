# データ同期テスト前のデータクリア手順

## 📋 概要

データ同期機能をテストする前に、既存の同期データをクリアすることで、クリーンな状態でテストできます。

---

## 🎯 クリアすべきテーブル

### 1. 同期データテーブル

以下のテーブルは、データ同期テスト前にクリアすることを推奨します：

| テーブル名 | 説明 | 削除理由 |
|----------|------|---------|
| **Customers** | 顧客データ | 重複データの作成を防ぐ |
| **Products** | 商品データ | 重複データの作成を防ぐ |
| **Orders** | 注文データ | 重複データの作成を防ぐ |
| **SyncStatuses** | 同期ステータス | 古い同期ステータスをクリア |
| **SyncHistory** | 同期履歴 | 古い同期履歴をクリア（存在する場合） |

### 2. 保持すべきテーブル

以下のテーブルは削除**しない**でください（テストに必要）：

| テーブル名 | 説明 | 保持理由 |
|----------|------|---------|
| **Stores** | ストア情報 | テスト対象のストア情報 |
| **StoreSubscriptions** | サブスクリプション情報 | 機能アクセス制御に必要 |
| **SubscriptionPlans** | プラン情報 | 機能アクセス制御に必要 |
| **ShopifyApps** | アプリ情報 | OAuth認証に必要 |
| **AccessTokens** | アクセストークン | Shopify API呼び出しに必要 |

---

## 🛠️ データクリア方法

### 方法1: SQLスクリプトを使用（推奨）

#### ステップ1: SQLスクリプトを開く

`docs/05-development/03-データベース/運用/2026-01-19-clear-sync-data-for-testing.sql`を開きます。

#### ステップ2: パラメータを設定

```sql
DECLARE @StoreId INT = 18; -- テスト対象のStoreIdを指定
DECLARE @ConfirmDelete BIT = 1; -- 1に設定すると削除を実行
```

#### ステップ3: 削除対象データを確認

スクリプトを実行して、削除対象のデータ件数を確認します。

```sql
-- 削除対象データの確認
SELECT 
    (SELECT COUNT(*) FROM Customers WHERE StoreId = 18) AS CustomerCount,
    (SELECT COUNT(*) FROM Products WHERE StoreId = 18) AS ProductCount,
    (SELECT COUNT(*) FROM Orders WHERE StoreId = 18) AS OrderCount,
    (SELECT COUNT(*) FROM SyncStatuses WHERE StoreId = 18) AS SyncStatusCount;
```

#### ステップ4: 削除を実行

`@ConfirmDelete = 1`に設定して、スクリプトを実行します。

#### ステップ5: 削除結果を確認

削除後のデータ件数を確認します。

#### ステップ6: トランザクションをコミット

問題がなければ、`COMMIT TRANSACTION;`を実行します。

問題があれば、`ROLLBACK TRANSACTION;`を実行します。

---

### 方法2: Azure Data Studio / SSMSで直接削除

#### ステップ1: 削除対象データを確認

```sql
-- 削除対象データの確認
SELECT 
    'Customers' AS TableName, COUNT(*) AS RecordCount
FROM Customers WHERE StoreId = 18
UNION ALL
SELECT 
    'Products' AS TableName, COUNT(*) AS RecordCount
FROM Products WHERE StoreId = 18
UNION ALL
SELECT 
    'Orders' AS TableName, COUNT(*) AS RecordCount
FROM Orders WHERE StoreId = 18
UNION ALL
SELECT 
    'SyncStatuses' AS TableName, COUNT(*) AS RecordCount
FROM SyncStatuses WHERE StoreId = 18;
```

#### ステップ2: トランザクションを開始

```sql
BEGIN TRANSACTION;
```

#### ステップ3: データを削除

```sql
-- 注文データを削除（外部キー制約のため最初に削除）
DELETE FROM Orders WHERE StoreId = 18;

-- 顧客データを削除
DELETE FROM Customers WHERE StoreId = 18;

-- 商品データを削除
DELETE FROM Products WHERE StoreId = 18;

-- 同期ステータスを削除
DELETE FROM SyncStatuses WHERE StoreId = 18;

-- 同期履歴を削除（存在する場合）
IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'SyncHistory')
BEGIN
    DELETE FROM SyncHistory WHERE StoreId = 18;
END
```

#### ステップ4: 削除結果を確認

```sql
-- 削除後の確認
SELECT 
    (SELECT COUNT(*) FROM Customers WHERE StoreId = 18) AS CustomerCount,
    (SELECT COUNT(*) FROM Products WHERE StoreId = 18) AS ProductCount,
    (SELECT COUNT(*) FROM Orders WHERE StoreId = 18) AS OrderCount,
    (SELECT COUNT(*) FROM SyncStatuses WHERE StoreId = 18) AS SyncStatusCount;
```

#### ステップ5: トランザクションをコミットまたはロールバック

```sql
-- 問題がなければ
COMMIT TRANSACTION;

-- 問題があれば
-- ROLLBACK TRANSACTION;
```

---

## ⚠️ 注意事項

### 1. 本番環境では使用しない

このスクリプトは**テスト環境専用**です。本番環境では使用しないでください。

### 2. トランザクションを使用

必ずトランザクション内で削除を実行し、削除結果を確認してからコミットしてください。

### 3. バックアップを取得

重要なデータがある場合は、削除前にバックアップを取得してください。

### 4. StoreIdを確認

削除対象のStoreIdが正しいことを確認してください。

---

## 🔍 削除後の確認項目

### 1. データ件数の確認

```sql
SELECT 
    'Customers' AS TableName, COUNT(*) AS RecordCount
FROM Customers WHERE StoreId = 18
UNION ALL
SELECT 
    'Products' AS TableName, COUNT(*) AS RecordCount
FROM Products WHERE StoreId = 18
UNION ALL
SELECT 
    'Orders' AS TableName, COUNT(*) AS RecordCount
FROM Orders WHERE StoreId = 18
UNION ALL
SELECT 
    'SyncStatuses' AS TableName, COUNT(*) AS RecordCount
FROM SyncStatuses WHERE StoreId = 18;
```

**期待される結果**: すべてのRecordCountが0であること

### 2. ストア情報の確認

```sql
SELECT 
    Id, Name, Domain, IsActive, CreatedAt
FROM Stores
WHERE Id = 18;
```

**期待される結果**: ストア情報が存在すること

### 3. アクセストークンの確認

```sql
SELECT 
    Id, StoreId, AccessToken, CreatedAt, UpdatedAt
FROM Stores
WHERE Id = 18 AND AccessToken IS NOT NULL;
```

**期待される結果**: アクセストークンが設定されていること

---

## 📚 関連ドキュメント

- [データ同期デバッグ-テスト手順](./データ同期デバッグ-テスト手順.md)
- [ローカルAPIデバッグ手順-データ同期テスト](./ローカルAPIデバッグ手順-データ同期テスト.md)
- [データ同期-注文データBadRequestエラー対応](../01-problem-analysis/2026-01/2026-01-19-データ同期-注文データBadRequestエラー対応.md)

---

**最終更新**: 2026年1月19日  
**作成者**: AI Assistant
