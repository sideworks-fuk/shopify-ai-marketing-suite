# デモモード ローカルデバッグ ブレイクポイント設定ガイド

**作成日**: 2026-01-22  
**目的**: デモモードのローカルデバッグ時に設定すべきブレイクポイント一覧

---

## 🔍 デモモードのフロー

```
1. フロントエンド: /demo/login でログイン
   ↓
2. バックエンド: POST /api/demo/login
   ↓
3. DemoAuthService.AuthenticateAsync (認証・トークン生成)
   ↓
4. フロントエンド: トークンをlocalStorageに保存
   ↓
5. フロントエンド: APIリクエスト（Authorization: Bearer {token}）
   ↓
6. バックエンド: AuthModeMiddleware (トークン検証・StoreId設定)
   ↓
7. バックエンド: StoreContextMiddleware (ストアコンテキスト設定)
   ↓
8. バックエンド: 各APIエンドポイント (データ取得)
```

---

## 🎯 必須ブレイクポイント（優先度: 高）

### 1. ログイン処理

#### `DemoAuthController.Login` (76行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs`

```csharp
// 🔧 ブレイクポイント設定箇所
var result = await _demoAuthService.AuthenticateAsync(
    request.Password,
    request.ShopDomain,
    ipAddress,
    userAgent);
```

**確認項目**:
- `request.Password` が正しく渡されているか
- `request.ShopDomain` が正しく渡されているか
- `result.Success` が `true` か
- `result.Token` にトークンが含まれているか

#### `DemoAuthService.AuthenticateAsync` (開始位置)
**ファイル**: `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs`

**確認項目**:
- パスワード検証が成功しているか
- ストアドメインからストアが正しく取得できているか
- `DataType` 制限が正しく適用されているか
- トークンに `store_id` が含まれているか

---

### 2. トークン検証

#### `AuthenticationService.ValidateDemoTokenAsync` (240行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Services/AuthenticationService.cs`

```csharp
// 🔧 ブレイクポイント設定箇所
var storeIdClaim = principal.FindFirst("store_id")?.Value;
int? storeId = null;
if (!string.IsNullOrEmpty(storeIdClaim) && int.TryParse(storeIdClaim, out var parsedStoreId))
{
    storeId = parsedStoreId;
    _logger.LogDebug("StoreId extracted from demo token: {StoreId}", storeId);
}
```

**確認項目**:
- `principal` に `store_id` クレームが含まれているか
- `storeId` が正しく抽出できているか
- `AuthenticationResult.StoreId` が設定されているか

#### `AuthModeMiddleware` - デモトークン検証 (199行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs`

```csharp
// 🔧 ブレイクポイント設定箇所
var demoResult = await authService.ValidateDemoTokenAsync(token);
isDemoValid = demoResult.IsValid;

if (isDemoValid)
{
    authResult = demoResult;
    _logger.LogDebug("Demo token validation successful");
}
```

**確認項目**:
- `demoResult.IsValid` が `true` か
- `demoResult.StoreId` が設定されているか

#### `AuthModeMiddleware` - StoreId設定 (456行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs`

```csharp
// 🔧 ブレイクポイント設定箇所
if (extractedStoreId.HasValue)
{
    context.Items["StoreId"] = extractedStoreId.Value;
    _logger.LogDebug("Demo mode: StoreId set in context.Items: {StoreId}", extractedStoreId.Value);
}
```

**確認項目**:
- `extractedStoreId` が正しく取得できているか
- `context.Items["StoreId"]` が正しく設定されているか

---

### 3. ストアコンテキスト設定

#### `StoreContextMiddleware` - StoreId取得 (44行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Middleware/StoreContextMiddleware.cs`

```csharp
// 🔧 ブレイクポイント設定箇所
if (context.Items.TryGetValue("StoreId", out var existingStoreId) && existingStoreId is int existingId)
{
    _logger.LogDebug("StoreContextMiddleware - StoreId already set by AuthModeMiddleware: StoreId={StoreId}", existingId);
    // ...
}
```

**確認項目**:
- `context.Items["StoreId"]` が正しく取得できているか
- `existingId` が正しい値か

---

## 📊 データ取得API（優先度: 中）

### 4. ダッシュボードデータ取得

#### `DashboardController.GetDashboard` (36行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/DashboardController.cs`

**確認項目**:
- `storeId` が正しく取得できているか
- クエリが正しく実行されているか
- データが正しく返されているか

#### `CustomerController.GetDashboardData` (39行目)
**ファイル**: `backend/ShopifyAnalyticsApi/Controllers/CustomerController.cs`

**確認項目**:
- ストアコンテキストが正しく設定されているか
- データが正しく取得できているか

---

## 🔧 推奨ブレイクポイント（優先度: 低）

### 5. セッション管理

#### `DemoAuthService.ValidateSessionAsync`
**ファイル**: `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs`

**確認項目**:
- セッションが正しく検証されているか
- セッションの有効期限が正しいか

---

## 🎯 デバッグ時の確認ポイント

### ログイン時
1. ✅ パスワードが正しく検証されているか
2. ✅ ストアドメインからストアが正しく取得できているか
3. ✅ `DataType` 制限が正しく適用されているか
4. ✅ トークンに `store_id` が含まれているか

### APIリクエスト時
1. ✅ `Authorization` ヘッダーにトークンが含まれているか
2. ✅ トークンが正しく検証されているか
3. ✅ `StoreId` が正しく設定されているか
4. ✅ ストアコンテキストが正しく設定されているか
5. ✅ データが正しく取得できているか

---

## 📝 デバッグ手順

### ステップ1: ログイン処理の確認
1. `DemoAuthController.Login` にブレイクポイントを設定
2. フロントエンドからログインリクエストを送信
3. リクエストパラメータを確認
4. `DemoAuthService.AuthenticateAsync` の結果を確認

### ステップ2: トークン検証の確認
1. `AuthenticationService.ValidateDemoTokenAsync` にブレイクポイントを設定
2. APIリクエストを送信
3. トークンから `store_id` が正しく抽出できているか確認
4. `AuthenticationResult.StoreId` が設定されているか確認

### ステップ3: StoreId設定の確認
1. `AuthModeMiddleware` の `StoreId` 設定箇所にブレイクポイントを設定
2. `context.Items["StoreId"]` が正しく設定されているか確認
3. `StoreContextMiddleware` で `StoreId` が正しく取得できているか確認

### ステップ4: データ取得の確認
1. `DashboardController.GetDashboard` にブレイクポイントを設定
2. データが正しく取得できているか確認
3. ストアコンテキストが正しく適用されているか確認

---

## 🔗 関連ファイル

- `backend/ShopifyAnalyticsApi/Controllers/DemoAuthController.cs` - デモログインコントローラー
- `backend/ShopifyAnalyticsApi/Services/DemoAuthService.cs` - デモ認証サービス
- `backend/ShopifyAnalyticsApi/Services/AuthenticationService.cs` - 認証サービス（トークン検証）
- `backend/ShopifyAnalyticsApi/Middleware/AuthModeMiddleware.cs` - 認証ミドルウェア
- `backend/ShopifyAnalyticsApi/Middleware/StoreContextMiddleware.cs` - ストアコンテキストミドルウェア
- `backend/ShopifyAnalyticsApi/Controllers/DashboardController.cs` - ダッシュボードコントローラー
- `backend/ShopifyAnalyticsApi/Controllers/CustomerController.cs` - 顧客コントローラー

---

## 💡 デバッグのヒント

### よくある問題
1. **StoreIdが設定されていない**
   - `AuthModeMiddleware` で `StoreId` が設定されていない
   - トークンに `store_id` が含まれていない

2. **トークン検証が失敗する**
   - トークンの有効期限が切れている
   - トークンの署名が正しくない

3. **ストアコンテキストが設定されていない**
   - `StoreContextMiddleware` で `StoreId` が取得できていない
   - `context.Items["StoreId"]` が設定されていない

### デバッグ時のログ確認
- `_logger.LogDebug` で出力されるログを確認
- `context.Items["StoreId"]` の値を確認
- トークンのクレームを確認
