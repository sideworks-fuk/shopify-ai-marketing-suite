# ログ解析ツールガイド

## 概要

バックエンドAPI（Serilog構造化ログ）のログファイルをローカルで解析する際に使用できるツールをまとめます。

## ログ形式

本プロジェクトのログは以下の形式です：
- **形式**: Serilog構造化ログ（JSON形式のプロパティを含む）
- **出力テンプレート**: `[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}`
- **ログレベル**: INF, ERR, WRN, DBG など
- **構造化データ**: JSON形式で末尾に含まれる（SourceContext, ActionId, RequestId, RequestPath など）

---

## 推奨ツール一覧

### 1. **LogViewer**（Windows専用・無料）

**特徴**:
- Windows専用のログビューア
- リアルタイムログ監視対応
- フィルタリング・検索機能が充実
- 複数ファイルの同時表示
- 正規表現検索対応

**ダウンロード**: https://github.com/zarunbal/LogViewer/releases

**使い方**:
1. ログファイルを開く
2. フィルタバーでログレベル（INF, ERR, WRN）でフィルタ
3. 検索バーでキーワード検索（例: `RequestId`, `SourceContext`）
4. 正規表現検索で複雑なパターン検索

**メリット**:
- 軽量で高速
- 日本語対応
- 無料

**デメリット**:
- JSON構造化データの可視化は限定的

---

### 2. **BareTail Pro**（Windows・有料版あり）

**特徴**:
- リアルタイムログ監視に特化
- カラーハイライト設定可能
- フィルタリング機能
- 複数ファイルの同時監視

**ダウンロード**: https://www.baremetalsoft.com/baretail/

**使い方**:
- ログファイルを開いてリアルタイム監視
- カラーハイライトでログレベルを色分け
- フィルタで特定のログのみ表示

**メリット**:
- リアルタイム監視が優秀
- カスタマイズ性が高い

**デメリット**:
- 有料版は機能が充実（無料版は機能制限あり）
- JSON解析機能は限定的

---

### 3. **Visual Studio Code + 拡張機能**（推奨・無料）

**特徴**:
- 既に開発環境として使用している
- 拡張機能でログ解析機能を追加可能
- JSON構造化データの可視化が可能
- 正規表現検索・置換対応

**推奨拡張機能**:

#### a) **Log Viewer**（拡張機能）
- 拡張機能ID: `emilast.logviewer`
- ログファイルの構文ハイライト
- ログレベルの色分け
- タイムスタンプの解析

#### b) **Log File Highlighter**
- 拡張機能ID: `emilast.logfile-highlighter`
- ログレベルの自動ハイライト
- エラーログの強調表示

**使い方**:
1. VS Codeでログファイルを開く
2. 拡張機能をインストール
3. 検索機能（Ctrl+F）でキーワード検索
4. 正規表現検索（`.*`）でパターン検索
5. JSON構造化データをコピーしてJSONビューアで確認

**メリット**:
- 既存ツールの活用
- 無料
- 拡張機能で機能追加可能
- JSON構造化データの解析が容易

**デメリット**:
- リアルタイム監視は限定的

---

### 4. **Notepad++**（Windows・無料）

**特徴**:
- 軽量テキストエディタ
- 正規表現検索・置換対応
- プラグインで機能拡張可能
- 複数ファイルの同時編集

**推奨プラグイン**:
- **JSON Viewer**: JSON構造化データの可視化
- **Compare**: ログファイルの差分比較

**使い方**:
1. ログファイルを開く
2. 検索（Ctrl+F）でキーワード検索
3. 正規表現検索（`.*`）でパターン検索
4. JSON Viewerプラグインで構造化データを確認

**メリット**:
- 軽量・高速
- 無料
- プラグインで機能拡張

**デメリット**:
- ログ専用機能は限定的

---

### 5. **PowerShell + スクリプト**（Windows・無料・推奨）

**特徴**:
- 既に使用している環境
- カスタムスクリプトで柔軟な解析が可能
- JSON構造化データの解析が容易
- フィルタリング・集計が可能

**サンプルスクリプト例**:

```powershell
# エラーログのみ抽出
Get-Content "app-2026-01-19.log" | Select-String "ERR"

# 特定のRequestIdでログを抽出
Get-Content "app-2026-01-19.log" | Select-String "RequestId.*40000599"

# JSON構造化データを解析
Get-Content "app-2026-01-19.log" | 
    Where-Object { $_ -match 'ERR' } | 
    ForEach-Object {
        if ($_ -match '\{.*\}') {
            $json = $_ -replace '.*(\{.*\})', '$1'
            $json | ConvertFrom-Json | Select-Object SourceContext, RequestId, RequestPath
        }
    }

# ログレベル別の集計
Get-Content "app-2026-01-19.log" | 
    Select-String -Pattern '\[(\d{2}:\d{2}:\d{2}) (INF|ERR|WRN|DBG)\]' | 
    ForEach-Object { 
        if ($_ -match '\[(\d{2}:\d{2}:\d{2}) (INF|ERR|WRN|DBG)\]') {
            [PSCustomObject]@{
                Time = $matches[1]
                Level = $matches[2]
            }
        }
    } | 
    Group-Object Level | 
    Select-Object Name, Count
```

**メリット**:
- 既存環境の活用
- 柔軟な解析が可能
- JSON解析が容易
- 無料

**デメリット**:
- スクリプト作成が必要

---

### 6. **LogParser Studio**（Windows・無料・Microsoft製）

**特徴**:
- Microsoft製のログ解析ツール
- SQLライクなクエリでログ解析
- 複数ファイルの同時解析
- グラフ・チャート表示

**ダウンロード**: https://www.microsoft.com/en-us/download/details.aspx?id=24659

**使い方**:
1. ログファイルをインポート
2. SQLライクなクエリで検索
3. 結果をグラフで表示

**メリット**:
- SQLライクなクエリで柔軟な解析
- グラフ表示
- 無料

**デメリット**:
- インストールが必要
- 学習コストあり

---

### 7. **Seq**（Webベース・無料版あり）

**特徴**:
- Serilog専用のログ解析ツール
- Web UIでログを可視化
- 構造化ログの解析に最適
- リアルタイム監視対応

**ダウンロード**: https://datalust.co/seq

**使い方**:
1. Seqサーバーを起動（ローカルまたはクラウド）
2. ログファイルをインポート
3. Web UIでログを検索・フィルタ
4. 構造化データを可視化

**メリット**:
- Serilog構造化ログに最適
- 構造化データの可視化が優秀
- リアルタイム監視対応

**デメリット**:
- インストール・設定が必要
- 無料版は機能制限あり

---

#### **SeqのAzureデプロイ方法**

SeqはAzure上にデプロイ可能です。以下の方法があります：

##### **1. Azure VM（推奨・小規模運用）**

**概要**: Windows Server VMまたはLinux VM上にSeqをインストール

**メリット**:
- 完全なコントロールが可能
- ストレージ・ネットワーキング・証明書を自由に設定
- スケールやパフォーマンス要件が高い場合に有利

**デメリット**:
- メンテナンス・バックアップ・アップデートを自前で管理
- VMサイズ・ディスク性能によってコストが変動

**手順**:
1. Azure PortalでWindows Server VMまたはLinux VMを作成
2. VMにSSH/RDPで接続
3. Seqをインストール（Windows: MSIインストーラー、Linux: Docker）
4. ストレージ（プレミアムSSD）をマウント
5. カスタムドメイン・TLS証明書を設定

**参考**: https://docs.datalust.co/docs/azure-installation

---

##### **2. Azure Kubernetes Service (AKS)（推奨・本番運用）**

**概要**: AKSクラスターにSeqをHelmチャートでデプロイ

**メリット**:
- 可用性・柔軟性が高い
- スケールアウト可能
- CI/CDと親和性が良い
- マネージドディスクで永続ストレージを確保

**デメリット**:
- Kubernetesの運用知見が必要
- Ingress、Persistent Volumeの設定が必要

**手順**:
1. AKSクラスターを作成
2. Helmチャートを使用してSeqをデプロイ
3. マネージドディスク（`managed-premium`ストレージクラス）を設定
4. Ingressで証明書・カスタムドメインを設定

**参考**: https://datalust.co/docs/using-aks

---

##### **3. Azure Container Instances (ACI)（検証・短期利用）**

**概要**: SeqをDockerコンテナとしてACI上で稼働

**メリット**:
- 軽量
- セットアップが比較的簡単
- インフラ管理が少ない

**デメリット**:
- ストレージ永続性の問題
- 可用性・スケール対応は限定的
- 商用・本番用途には不向き

**手順**:
1. SeqのDockerイメージを準備
2. Azure Container Instancesを作成
3. ストレージアカウントをマウント（制限あり）

**参考**: https://docs.datalust.co/docs/azure-installation

---

##### **4. Azure App Service / Container Apps（非推奨）**

**⚠️ 重要**: 公式で「App Service、Container Apps、Azure Websites上でのSeqはサポート外」と明記されています。

**理由**:
- 複数コンテナ実行時のストレージ破損などの問題が発生する可能性
- ストレージの永続性に関する制約

**推奨**: 本番運用では使用しない。検証用途でも他のオプションを推奨。

**参考**: https://datalust.co/docs/using-azure-websites-or-app-service

---

#### **Azureデプロイ時の注意点**

##### **ストレージの永続性**
- Seqはログなどのデータをディスクに保存するため、パフォーマンスの良いディスク（AzureではプレミアムSSD等）の確保が重要
- マネージドディスクを使用する場合は、適切なストレージクラスを選択

##### **HTTPS / 証明書**
- カスタムドメインを使う場合はTLS証明書を適切に設定
- VMやAKSの場合にはIngressで証明書管理

##### **可用性・スケール**
- ログ量が多くなるとCPU・メモリ・ストレージI/Oに負荷がかかる
- AKSでのオートスケールや複数レプリカ構成などを検討

##### **バックアップ・復旧**
- 障害時のデータ損失を防ぐため、ストレージのスナップショットやVMのバックアップなどを運用プロセスに含める

---

#### **推奨構成（本プロジェクト向け）**

**現時点（小規模運用）**:
- **Azure VM（Windows Server）** 1台でSeqを設置
- スタートとしてはこれでも十分
- 証明書とバックアップ、モニタリングを整える

**将来（本番運用・スケールが必要な場合）**:
- **AKSにSeqをHelmチャートで導入**
- マネージドディスク（`managed-premium`ストレージクラス）を利用して永続ストレージを確保
- Ingressや証明書の配置も自動化
- スケーラビリティと可用性を重視

---

#### **Seq Cloud（マネージドサービス）**

**概要**: Datalustが提供するマネージドSeqサービス

**メリット**:
- 運用負荷が最小限
- 自動スケーリング
- バックアップ・セキュリティが管理されている

**デメリット**:
- 有料（従量課金）
- データがクラウド上に保存される

**参考**: https://datalust.co/seq-cloud

---

#### **SerilogからSeqへの送信設定**

SeqをAzureにデプロイした後、バックエンドAPIからSeqにログを送信する設定：

**NuGetパッケージ**:
```xml
<PackageReference Include="Serilog.Sinks.Seq" Version="8.0.0" />
```

**appsettings.json**:
```json
{
  "Serilog": {
    "WriteTo": [
      {
        "Name": "Seq",
        "Args": {
          "serverUrl": "https://seq.your-domain.com",
          "apiKey": "your-api-key",
          "restrictedToMinimumLevel": "Information"
        }
      }
    ]
  }
}
```

**環境変数（Azure App Service）**:
```
SEQ_SERVER_URL=https://seq.your-domain.com
SEQ_API_KEY=your-api-key
```

---

## 用途別推奨ツール

### リアルタイム監視
1. **LogViewer**（Windows専用）
2. **BareTail Pro**
3. **Seq**（Serilog専用）

### 構造化ログ（JSON）解析
1. **PowerShell + スクリプト**（推奨）
2. **Seq**（Serilog専用）
3. **VS Code + 拡張機能**

### 簡単な検索・フィルタ
1. **VS Code + 拡張機能**（推奨）
2. **Notepad++**
3. **LogViewer**

### 複雑な解析・集計
1. **PowerShell + スクリプト**（推奨）
2. **LogParser Studio**
3. **Seq**

---

## 実践例：HMAC検証失敗の調査

提供されたログサンプルで、HMAC検証失敗を調査する場合：

### PowerShellスクリプト例

```powershell
# 1. HMAC検証失敗のログを抽出
$logFile = "app-2026-01-19.log"
$hmacErrors = Get-Content $logFile | Select-String "HMAC検証失敗"

# 2. 関連するRequestIdを抽出
$requestIds = $hmacErrors | ForEach-Object {
    if ($_ -match 'RequestId.*"([^"]+)"') {
        $matches[1]
    }
} | Select-Object -Unique

# 3. 同じRequestIdのログを全て抽出（前後のコンテキスト確認）
foreach ($requestId in $requestIds) {
    Write-Host "=== RequestId: $requestId ===" -ForegroundColor Yellow
    Get-Content $logFile | Select-String $requestId
    Write-Host ""
}

# 4. OAuth認証フローのログを時系列で抽出
Get-Content $logFile | 
    Select-String "OAuth|HMAC|ShopifyAuth" | 
    ForEach-Object {
        if ($_ -match '\[(\d{2}:\d{2}:\d{2})\]') {
            [PSCustomObject]@{
                Time = $matches[1]
                Log = $_
            }
        }
    } | 
    Sort-Object Time | 
    Format-Table -AutoSize
```

### VS Codeでの調査手順

1. ログファイルを開く
2. 検索（Ctrl+F）で `HMAC検証失敗` を検索
3. 見つかった行の `RequestId` をコピー
4. 再度検索でその `RequestId` を検索
5. 同じRequestIdのログを全て確認

---

## まとめ

### おすすめの組み合わせ

1. **日常的なログ確認**: **VS Code + Log Viewer拡張機能**
   - 既存ツールの活用
   - 無料
   - 十分な機能

2. **リアルタイム監視**: **LogViewer** または **BareTail Pro**
   - リアルタイム監視に特化
   - カラーハイライトで視認性向上

3. **複雑な解析**: **PowerShell + カスタムスクリプト**
   - 柔軟な解析が可能
   - JSON構造化データの解析が容易

4. **Serilog専用解析**: **Seq**（本格的な運用時）
   - 構造化ログの解析に最適
   - リアルタイム監視・アラート機能
   - **Azure VMまたはAKSにデプロイ可能**（App Serviceは非推奨）

---

**最終更新**: 2026年1月19日（Azureデプロイ情報追加）  
**作成者**: 福田
