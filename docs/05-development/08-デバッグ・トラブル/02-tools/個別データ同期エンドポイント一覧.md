# 個別データ同期エンドポイント一覧

## 概要

データ同期は、初期同期（`/api/sync/initial`）以外にも、個別のデータタイプ（Customers, Products, Orders）を個別に同期実行できるエンドポイントがあります。

---

## 利用可能なエンドポイント

### 1. 手動同期（任意のデータタイプを選択）

**エンドポイント**: `POST /api/sync/trigger`

**説明**: Customers、Products、Ordersのいずれか、または全てを選択して同期を実行できます。

**リクエストボディ**:
```json
{
  "type": "orders"  // "customers" | "products" | "orders" | "all"
}
```

**例: Ordersだけを同期**
```http
POST http://localhost:5168/api/sync/trigger
Authorization: Bearer {{token}}
X-Store-Id: 46
Content-Type: application/json

{
  "type": "orders"
}
```

**レスポンス例**:
```json
{
  "success": true,
  "message": "ordersデータの同期を開始しました",
  "jobIds": ["orders:abc123def456"]
}
```

---

### 2. Orders専用の同期エンドポイント

**エンドポイント**: `POST /api/manual-sync/sync-orders/{storeId}`

**説明**: Ordersのみを同期実行する専用エンドポイントです。

**リクエスト例**:
```http
POST http://localhost:5168/api/manual-sync/sync-orders/46
Authorization: Bearer {{token}}
X-Store-Id: 46
Content-Type: application/json

{
  "syncPeriod": "3months"  // オプション
}
```

**レスポンス例**:
```json
{
  "success": true,
  "message": "Order sync started",
  "jobId": "abc123def456",
  "storeId": 46,
  "storeName": "xn-fbkq6e5da0fpb"
}
```

---

### 3. 初期同期（全データタイプ）

**エンドポイント**: `POST /api/sync/initial`

**説明**: Customers、Products、Ordersの全てを同期実行します。

**リクエスト例**:
```http
POST http://localhost:5168/api/sync/initial
Authorization: Bearer {{token}}
X-Store-Id: 46
Content-Type: application/json

{
  "syncPeriod": "3months"
}
```

---

## エンドポイントの比較

| エンドポイント | 対象データ | 同期期間指定 | チェックポイント対応 |
|---|---|---|---|
| `POST /api/sync/initial` | Customers, Products, Orders（全て） | ✅ | ✅ |
| `POST /api/sync/trigger` | 選択可能（customers/products/orders/all） | ❌ | ✅ |
| `POST /api/manual-sync/sync-orders/{storeId}` | Ordersのみ | ✅ | ✅ |

---

## 推奨使用方法

### Ordersだけを同期したい場合

**方法1: `/api/sync/trigger` を使用（推奨）**

```http
POST /api/sync/trigger
Body: { "type": "orders" }
```

**メリット**:
- StoreIdを自動取得（X-Store-Idヘッダーから）
- 簡潔で使いやすい
- 他のデータタイプも同じエンドポイントで実行可能

**方法2: `/api/manual-sync/sync-orders/{storeId}` を使用**

```http
POST /api/manual-sync/sync-orders/46
Body: { "syncPeriod": "3months" }  // オプション
```

**メリット**:
- 同期期間を指定できる
- Orders専用のエンドポイントで明確

---

## 同期進捗の確認

同期を開始した後、以下のエンドポイントで進捗を確認できます：

**エンドポイント**: `GET /api/sync/status/{storeId}`

**リクエスト例**:
```http
GET http://localhost:5168/api/sync/status/46
Authorization: Bearer {{token}}
X-Store-Id: 46
```

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "customers": {
      "count": 25,
      "status": "synced",
      "lastSyncAt": "2026-01-20T09:00:00Z"
    },
    "products": {
      "count": 10,
      "status": "synced",
      "lastSyncAt": "2026-01-20T09:00:00Z"
    },
    "orders": {
      "count": 0,
      "status": "syncing",
      "lastSyncAt": null
    }
  }
}
```

---

## Postmanでの使用例

### Ordersだけを同期する（推奨方法）

1. **`POST /api/sync/trigger` リクエストを作成**
   - URL: `{{baseUrl}}/api/sync/trigger`
   - Method: `POST`
   - Headers:
     - `Authorization: Bearer {{token}}`
     - `X-Store-Id: 46`
     - `Content-Type: application/json`
   - Body:
     ```json
     {
       "type": "orders"
     }
     ```

2. **レスポンスでJobIdを確認**
   - `jobIds` フィールドにHangfireのJob IDが含まれます

3. **進捗を確認**
   - `GET /api/sync/status/46` をポーリングして進捗を確認

---

## 注意事項

1. **既に同期中の場合はエラー**
   - 同じデータタイプで既に同期が実行中の場合は、`BadRequest` エラーが返されます
   - エラーメッセージ: `"同期が既に実行中です。完了するまでお待ちください。"`

2. **チェックポイントから再開**
   - 以前の同期が途中で失敗した場合、チェックポイントから自動的に再開されます
   - チェックポイントをクリアしたい場合は、手動でSQLを実行する必要があります

3. **Hangfireジョブとして実行**
   - すべての同期はHangfireのバックグラウンドジョブとして実行されます
   - 即座に完了するわけではなく、非同期で実行されます

---

## トラブルシューティング

### チェックポイントが原因でエラーが発生する場合

Orders同期で `BadRequest` エラーが発生する場合、無効なチェックポイントが保存されている可能性があります。

**チェックポイントをクリアするSQL**:
```sql
-- StoreId=46のOrdersチェックポイントをクリア
DELETE FROM SyncCheckpoints
WHERE StoreId = 46 AND DataType = 'Orders';
```

---

## 関連ドキュメント

- `docs/05-development/08-デバッグ・トラブル/02-tools/ローカルAPIデバッグ手順-データ同期テスト.md`
- `docs/05-development/08-デバッグ・トラブル/02-tools/Postman-トークン自動保存スクリプト.md`
