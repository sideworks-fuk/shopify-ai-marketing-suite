# æœ¬ç•ªç’°å¢ƒå±é™ºã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

**ä½œæˆæ—¥**: 2025-01-23  
**æœ€çµ‚æ›´æ–°**: 2025-01-23  
**ç›®çš„**: æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å‰Šé™¤ã¾ãŸã¯ä¿è­·ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š

## âœ… å®Ÿè£…å®Œäº†ï¼ˆ2025-01-23ï¼‰

ã™ã¹ã¦ã®å±é™ºãªãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«**é–‹ç™ºè€…èªè¨¼ï¼ˆ`RequireDeveloperAuth`ï¼‰**ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚

### å®Ÿè£…å†…å®¹

1. **`RequireDeveloperAuthAttribute`** ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’ä½œæˆ
   - é–‹ç™ºç’°å¢ƒã§ã¯è‡ªå‹•çš„ã«è¨±å¯
   - æœ¬ç•ªç’°å¢ƒã§ã¯é–‹ç™ºè€…èªè¨¼ï¼ˆ`can_access_dev_tools` ã‚¯ãƒ¬ãƒ¼ãƒ ï¼‰ãŒå¿…è¦

2. **ä¿è­·ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
   - âœ… `/api/shopify/test-settings` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/shopify/debug-shopify-apps` - é–‹ç™ºè€…èªè¨¼å¿…é ˆã€`ApiKeyFull`å‰Šé™¤
   - âœ… `/api/shopify/debug-stores` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/shopify/test-encryption` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/shopify/test-oauth-url` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/shopify/test-hybrid-mode` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/shopify/test-config` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/debug/segment-analysis` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ
   - âœ… `/api/hangfire/test-job` - é–‹ç™ºè€…èªè¨¼å¿…é ˆ

### ä½¿ç”¨æ–¹æ³•

æœ¬ç•ªç’°å¢ƒã§ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆï¼š

1. é–‹ç™ºè€…èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³:
   ```bash
   POST /api/developer/login
   {
     "password": "é–‹ç™ºè€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
   }
   ```

2. å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’`Authorization`ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š:
   ```bash
   Authorization: Bearer {token}
   ```

3. ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹

---

## å®Ÿè£…å‰ã®çŠ¶æ…‹ï¼ˆå‚è€ƒï¼‰

## ğŸ”´ æœ€é«˜å±é™ºåº¦ï¼ˆå³åº§ã«å‰Šé™¤ã¾ãŸã¯ä¿è­·ãŒå¿…è¦ï¼‰

### 1. `/api/shopify/test-settings`
**å±é™ºåº¦**: ğŸ”´ **æœ€é«˜**  
**ç†ç”±**: `ApiKey`ã¨`ApiSecret`ã‚’å®Œå…¨ã«è¿”ã—ã¦ã„ã‚‹

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:810-844
[HttpGet("test-settings")]
[AllowAnonymous]
public IActionResult TestSettings()
{
    var settings = new
    {
        ApiKey = GetShopifySetting("ApiKey"),      // âš ï¸ å®Œå…¨ãªApiKeyã‚’è¿”ã™
        ApiSecret = GetShopifySetting("ApiSecret"), // âš ï¸ å®Œå…¨ãªApiSecretã‚’è¿”ã™
        // ...
    };
    return Ok(settings);
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆ`if (app.Environment.IsDevelopment())`ï¼‰

---

### 2. `/api/shopify/debug-shopify-apps`
**å±é™ºåº¦**: ğŸ”´ **æœ€é«˜**  
**ç†ç”±**: `ApiKeyFull`ï¼ˆå®Œå…¨ãªApiKeyï¼‰ã‚’è¿”ã—ã¦ã„ã‚‹

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:661-695
[HttpGet("debug-shopify-apps")]
[AllowAnonymous]
public async Task<IActionResult> DebugShopifyApps()
{
    var apps = await _context.ShopifyApps
        .Select(a => new
        {
            ApiKey = a.ApiKey.Substring(0, Math.Min(8, a.ApiKey.Length)) + "...",
            ApiKeyFull = a.ApiKey,  // âš ï¸ å®Œå…¨ãªApiKeyã‚’è¿”ã™
            // ...
        })
        .ToListAsync();
    return Ok(new { apps = apps });
}
```

**å¯¾ç­–**:
- `ApiKeyFull`ã‚’å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹

---

### 3. `/api/shopify/debug-stores`
**å±é™ºåº¦**: ğŸ”´ **é«˜**  
**ç†ç”±**: `AccessToken`ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å¾©å·åŒ–ãƒ†ã‚¹ãƒˆçµæœã‚’è¿”ã—ã¦ã„ã‚‹

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:701-805
[HttpGet("debug-stores")]
[AllowAnonymous]
public async Task<IActionResult> DebugStores([FromQuery] string? shop = null)
{
    // AccessTokenã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿”ã™
    AccessTokenPreview = s.AccessToken != null 
        ? s.AccessToken.Substring(0, Math.Min(20, s.AccessToken.Length)) + "..." 
        : null,
    // å¾©å·åŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦çµæœã‚’è¿”ã™
    var decrypted = DecryptToken(store.AccessToken);
    decryptError = $"å¾©å·åŒ–æˆåŠŸ: {decrypted.Substring(0, Math.Min(10, decrypted.Length))}...";
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹
- ã¾ãŸã¯ã€èªè¨¼ã‚’å¿…é ˆã«ã™ã‚‹ï¼ˆ`[AllowAnonymous]`ã‚’å‰Šé™¤ï¼‰

---

## ğŸŸ¡ é«˜å±é™ºåº¦ï¼ˆå‰Šé™¤ã¾ãŸã¯ä¿è­·ã‚’æ¨å¥¨ï¼‰

### 4. `/api/debug/segment-analysis`
**å±é™ºåº¦**: ğŸŸ¡ **é«˜**  
**ç†ç”±**: ãƒ‡ãƒãƒƒã‚°å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

```csharp
// backend/ShopifyAnalyticsApi/Controllers/DebugController.cs:9-125
[AllowAnonymous]
[ApiController]
[Route("api/[controller]")]
public class DebugController : ControllerBase
{
    [HttpGet("segment-analysis")]
    public async Task<ActionResult<object>> GetSegmentDebugInfo(...)
    {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿”ã™
        // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚‚è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹
    }
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹
- ã¾ãŸã¯ã€èªè¨¼ã‚’å¿…é ˆã«ã™ã‚‹

---

### 5. `/api/hangfire/test-job`
**å±é™ºåº¦**: ğŸŸ¡ **ä¸­**  
**ç†ç”±**: ãƒ†ã‚¹ãƒˆç”¨ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã€èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

```csharp
// backend/ShopifyAnalyticsApi/Controllers/HangFireJobController.cs:150-173
[HttpPost("test-job")]
[AllowAnonymous] // ãƒ†ã‚¹ãƒˆç”¨ãªã®ã§èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
public IActionResult TriggerTestJob()
{
    var jobId = _backgroundJobClient.Enqueue(() => 
        Console.WriteLine($"[HangFire Test Job] Executed at {DateTime.UtcNow}"));
    return Ok(new { jobId = jobId });
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹

---

### 6. `/api/shopify/test-encryption`
**å±é™ºåº¦**: ğŸŸ¡ **ä¸­**  
**ç†ç”±**: æš—å·åŒ–ãƒ†ã‚¹ãƒˆã€èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:849-850
[HttpPost("test-encryption")]
[AllowAnonymous]
public IActionResult TestEncryption([FromBody] TestEncryptionRequest request)
{
    // æš—å·åŒ–/å¾©å·åŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹

---

### 7. `/api/shopify/test-oauth-url`
**å±é™ºåº¦**: ğŸŸ¡ **ä½**  
**ç†ç”±**: OAuth URLç”Ÿæˆãƒ†ã‚¹ãƒˆã€æ©Ÿå¯†æƒ…å ±ã¯è¿”ã•ãªã„ãŒä¸è¦

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:615-656
[HttpGet("test-oauth-url")]
[AllowAnonymous]
public IActionResult TestOAuthUrl([FromQuery] string shop = "fuk-dev1.myshopify.com")
{
    // OAuth URLã‚’ç”Ÿæˆã—ã¦è¿”ã™ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯å«ã¾ã‚Œãªã„ï¼‰
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹

---

### 8. `/api/shopify/test-config`
**å±é™ºåº¦**: ğŸŸ¡ **ä½**  
**ç†ç”±**: è¨­å®šå€¤ã®å­˜åœ¨ç¢ºèªã®ã¿ï¼ˆå€¤ã¯è¿”ã•ãªã„ï¼‰

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs:496-545
[HttpGet("test-config")]
[AllowAnonymous]
public IActionResult TestConfig()
{
    var config = new
    {
        ApiKey = !string.IsNullOrEmpty(GetShopifySetting("ApiKey")),  // å€¤ã§ã¯ãªãå­˜åœ¨ã®ã¿
        ApiSecret = !string.IsNullOrEmpty(GetShopifySetting("ApiSecret")), // å€¤ã§ã¯ãªãå­˜åœ¨ã®ã¿
        // ...
    };
}
```

**å¯¾ç­–**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹
- ã¾ãŸã¯ã€é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹

---

## ğŸŸ¢ å®‰å…¨ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

### 9. `/api/store`
**å±é™ºåº¦**: ğŸŸ¢ **å®‰å…¨**  
**ç†ç”±**: ã‚¹ãƒˆã‚¢ä¸€è¦§ã‚’è¿”ã™ã€æ©Ÿå¯†æƒ…å ±ã¯å«ã¾ã‚Œã¦ã„ãªã„ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

```csharp
// backend/ShopifyAnalyticsApi/Controllers/StoreController.cs:29-72
[HttpGet]
[AllowAnonymous]
public async Task<ActionResult<ApiResponse<StoreListResponse>>> GetActiveStores()
{
    var stores = await _storeService.GetActiveStoresAsync();
    // StoreDtoã«ã¯æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„
}
```

**ç¢ºèªçµæœ**:
- âœ… `StoreListResponse`ã«`AccessToken`ã€`ApiKey`ã€`ApiSecret`ã¯å«ã¾ã‚Œã¦ã„ãªã„
- âœ… `StoreDto`ã«ã¯`Id`, `Name`, `Description`, `DataType`, `IsActive`, `ShopDomain`, `TenantId`ã®ã¿

---

### 10. `/api/store/{id}`
**å±é™ºåº¦**: ğŸŸ¢ **å®‰å…¨**  
**ç†ç”±**: ã‚¹ãƒˆã‚¢è©³ç´°ã‚’è¿”ã™ã€æ©Ÿå¯†æƒ…å ±ã¯å«ã¾ã‚Œã¦ã„ãªã„ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰

```csharp
// backend/ShopifyAnalyticsApi/Controllers/StoreController.cs:78-79
[HttpGet("{id}")]
[AllowAnonymous]
public async Task<ActionResult<ApiResponse<StoreDetailResponse>>> GetStore(int id)
{
    // StoreDetailResponseã«ã¯æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„
}
```

**ç¢ºèªçµæœ**:
- âœ… `StoreDetailResponse`ã«`AccessToken`ã€`ApiKey`ã€`ApiSecret`ã¯å«ã¾ã‚Œã¦ã„ãªã„
- âœ… `StoreDetailResponse`ã«ã¯`Store`ï¼ˆStoreDtoï¼‰ã€`LastDataUpdate`ã€`Statistics`ã®ã¿

---

## âœ… å®‰å…¨ï¼ˆOAuthèªè¨¼ç”¨ã€å¿…è¦ï¼‰

### 11. `/api/shopify/install`
**å±é™ºåº¦**: âœ… **å®‰å…¨**  
**ç†ç”±**: OAuthèªè¨¼é–‹å§‹ã€å¿…è¦

### 12. `/api/shopify/callback`
**å±é™ºåº¦**: âœ… **å®‰å…¨**  
**ç†ç”±**: OAuthèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€å¿…è¦

### 13. `/api/shopify/process-callback`
**å±é™ºåº¦**: âœ… **å®‰å…¨**  
**ç†ç”±**: OAuthèªè¨¼å‡¦ç†ã€å¿…è¦

### 14. `/api/webhook/*`
**å±é™ºåº¦**: âœ… **å®‰å…¨**  
**ç†ç”±**: Webhookã€HMACæ¤œè¨¼ã‚ã‚Š

---

## æ¨å¥¨å¯¾ç­–

### 1. ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼ˆæ¨å¥¨ï¼‰

```csharp
// é–‹ç™ºç’°å¢ƒã®ã¿ã§æœ‰åŠ¹ã«ã™ã‚‹
if (app.Environment.IsDevelopment())
{
    // ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–
}
```

### 2. èªè¨¼ã‚’å¿…é ˆã«ã™ã‚‹

```csharp
// [AllowAnonymous]ã‚’å‰Šé™¤
[Authorize]
[HttpGet("debug-stores")]
public async Task<IActionResult> DebugStores(...)
```

### 3. æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤

```csharp
#if DEBUG
[HttpGet("debug-stores")]
[AllowAnonymous]
public async Task<IActionResult> DebugStores(...)
#endif
```

### 4. æ¡ä»¶ä»˜ãã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```csharp
#if !RELEASE
[HttpGet("test-settings")]
[AllowAnonymous]
public IActionResult TestSettings()
#endif
```

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å³åº§ã«å¯¾å¿œãŒå¿…è¦

- [ ] `/api/shopify/test-settings` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·
- [ ] `/api/shopify/debug-shopify-apps` ã®`ApiKeyFull`ã‚’å‰Šé™¤
- [ ] `/api/shopify/debug-stores` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·

### æ¨å¥¨å¯¾å¿œ

- [ ] `/api/debug/segment-analysis` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·
- [ ] `/api/hangfire/test-job` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·
- [ ] `/api/shopify/test-encryption` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·
- [ ] `/api/shopify/test-oauth-url` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·
- [ ] `/api/shopify/test-config` ã‚’å‰Šé™¤ã¾ãŸã¯ä¿è­·

### ç¢ºèªæ¸ˆã¿ï¼ˆå®‰å…¨ï¼‰

- [x] `/api/store` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
- [x] `/api/store/{id}` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/DebugController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/HangFireJobController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/StoreController.cs`

---

## å‚è€ƒ

- [ASP.NET Core ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](https://learn.microsoft.com/ja-jp/aspnet/core/security/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

