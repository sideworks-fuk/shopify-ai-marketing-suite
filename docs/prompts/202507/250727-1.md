## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ä½œæˆæŒ‡ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰

### ä½œæ¥­æ¦‚è¦
ç¾åœ¨ã®DDLã¨ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚’åŸºã«ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ­£ç¢ºã«ç†è§£ãƒ»å‚ç…§ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ç‰¹ã«ã€ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¨ã€ãƒ‡ãƒ¼ã‚¿ä¿æŒæ–¹é‡ï¼ˆå‚ç…§ vs ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‚’æ˜Žç¢ºã«æ–‡æ›¸åŒ–ã—ã¾ã™ã€‚

### 1. èª¿æŸ»å¯¾è±¡ã®åŽé›†

#### A. DDLï¼ˆãƒ‡ãƒ¼ã‚¿å®šç¾©è¨€èªžï¼‰ã®åŽé›†
ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰DDLã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š

```markdown
## DDLåŽé›†å…ƒ
1. **Migrationãƒ•ã‚¡ã‚¤ãƒ«**
   - `backend/ShopifyAnalyticsApi/Migrations/*.cs`
   - å„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ CREATE TABLE æ–‡ã‚’æŠ½å‡º

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
   - `backend/ShopifyAnalyticsApi/*.sql`
   - åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

3. **Entity Framework ã‚¹ã‚­ãƒ¼ãƒž**
   - DbContextã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹DDL
   - `dotnet ef dbcontext script` ã‚³ãƒžãƒ³ãƒ‰ã§å‡ºåŠ›
```

#### B. ãƒ¢ãƒ‡ãƒ«å®šç¾©ã®åŽé›†
```markdown
## ãƒ¢ãƒ‡ãƒ«å®šç¾©åŽé›†å…ƒ
1. **Entityã‚¯ãƒ©ã‚¹**
   - `backend/ShopifyAnalyticsApi/Models/*.cs`
   - å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã®å®šç¾©

2. **DbContextå®šç¾©**
   - `backend/ShopifyAnalyticsApi/Data/ShopifyDbContext.cs`
   - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—è¨­å®šã€åˆ¶ç´„å®šç¾©

3. **DTO/ViewModel**
   - APIå¿œç­”ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§ä½¿ç”¨ã•ã‚Œã‚‹é›†è¨ˆãƒ¢ãƒ‡ãƒ«
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ã®æ§‹æˆ

#### A. ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
docs/03-design-specs/database/
â”œâ”€â”€ DATABASE-DESIGN.md                    # ãƒ¡ã‚¤ãƒ³è¨­è¨ˆæ›¸
â”œâ”€â”€ table-definitions/                    # å€‹åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
â”‚   â”œâ”€â”€ stores-table.md
â”‚   â”œâ”€â”€ products-table.md
â”‚   â”œâ”€â”€ customers-table.md
â”‚   â”œâ”€â”€ orders-table.md
â”‚   â”œâ”€â”€ order-items-table.md
â”‚   â”œâ”€â”€ customer-summary-table.md
â”‚   â””â”€â”€ [ãã®ä»–ãƒ†ãƒ¼ãƒ–ãƒ«].md
â”œâ”€â”€ relationships/                        # ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—è©³ç´°
â”‚   â””â”€â”€ entity-relationships.md
â”œâ”€â”€ design-decisions/                     # è¨­è¨ˆåˆ¤æ–­
â”‚   â”œâ”€â”€ snapshot-vs-reference.md
â”‚   â””â”€â”€ aggregation-strategy.md
â””â”€â”€ diagrams/                            # ERå›³ç­‰
    â”œâ”€â”€ er-diagram-overview.mermaid
    â””â”€â”€ er-diagram-detailed.mermaid
```

#### B. ãƒ¡ã‚¤ãƒ³è¨­è¨ˆæ›¸ã®æ§‹é€ 
**ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/03-design-specs/database/DATABASE-DESIGN.md`

```markdown
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸

## ðŸ“‹ æ¦‚è¦
æœ€çµ‚æ›´æ–°æ—¥: [æ—¥ä»˜]
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: SQL Server / PostgreSQL
ORM: Entity Framework Core [ãƒãƒ¼ã‚¸ãƒ§ãƒ³]

## ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ãƒ‡ãƒ¼ã‚¿ä¿æŒæ–¹é‡
æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä»¥ä¸‹ã®æ–¹é‡ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ï¼š

1. **ãƒžã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå‚ç…§åž‹ï¼‰**
   - Products: å•†å“ãƒžã‚¹ã‚¿ãƒ¼ï¼ˆShopifyã‹ã‚‰åŒæœŸï¼‰
   - Customers: é¡§å®¢ãƒžã‚¹ã‚¿ãƒ¼ï¼ˆShopifyã‹ã‚‰åŒæœŸï¼‰
   - Stores: åº—èˆ—ãƒžã‚¹ã‚¿ãƒ¼

2. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåž‹ï¼‰**
   - Orders: æ³¨æ–‡æ™‚ç‚¹ã®æƒ…å ±ã‚’ä¿æŒ
   - OrderItems: æ³¨æ–‡æ™‚ç‚¹ã®å•†å“æƒ…å ±ã‚’å«ã‚€ï¼ˆProductTitle, Priceç­‰ï¼‰

3. **é›†è¨ˆãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åž‹ï¼‰**
   - CustomerSummary: é¡§å®¢åˆ†æžç”¨ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥æ¬¡æ›´æ–°ï¼‰
   - ProductAnalytics: å•†å“åˆ†æžç”¨ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿

### è¨­è¨ˆåŽŸå‰‡
- **æ­£è¦åŒ–ãƒ¬ãƒ™ãƒ«**: ç¬¬3æ­£è¦å½¢ã‚’åŸºæœ¬ã¨ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®ãŸã‚ä¸€éƒ¨éžæ­£è¦åŒ–
- **å‘½åè¦å‰‡**: PascalCaseã€è¤‡æ•°å½¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«å
- **ä¸»ã‚­ãƒ¼**: åŸºæœ¬çš„ã«Id (int IDENTITY)ã‚’ä½¿ç”¨
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: CreatedAt, UpdatedAtã‚’æ¨™æº–è£…å‚™

## ðŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç¨®é¡ž | èª¬æ˜Ž | ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼ˆæƒ³å®šï¼‰ | æ›´æ–°é »åº¦ |
|-----------|------|------|------------------|----------|
| Stores | ãƒžã‚¹ã‚¿ãƒ¼ | åº—èˆ—æƒ…å ± | 10-100 | ä½Ž |
| Products | ãƒžã‚¹ã‚¿ãƒ¼ | å•†å“ãƒžã‚¹ã‚¿ãƒ¼ | 1,000-10,000 | æ—¥æ¬¡åŒæœŸ |
| Customers | ãƒžã‚¹ã‚¿ãƒ¼ | é¡§å®¢ãƒžã‚¹ã‚¿ãƒ¼ | 10,000-100,000 | æ—¥æ¬¡åŒæœŸ |
| Orders | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ | æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ | 100,000-1,000,000 | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  |
| OrderItems | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ | æ³¨æ–‡æ˜Žç´° | 500,000-5,000,000 | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  |
| CustomerSummary | é›†è¨ˆ | é¡§å®¢åˆ†æžã‚µãƒžãƒªãƒ¼ | 10,000-100,000 | æ—¥æ¬¡ãƒãƒƒãƒ |

## ðŸ”— ä¸»è¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—

### 1. Orders - OrderItems (1:N)
- Orders.Id â†’ OrderItems.OrderId
- ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤: ãªã—
- è¨­è¨ˆæ„å›³: æ³¨æ–‡ã¨æ˜Žç´°ã®è¦ªå­é–¢ä¿‚

### 2. Orders - Customers (N:1)  
- Orders.CustomerId â†’ Customers.Id
- å‚ç…§æ•´åˆæ€§: å¿…é ˆ
- è¨­è¨ˆæ„å›³: é¡§å®¢ã®æ³¨æ–‡å±¥æ­´ç®¡ç†

### 3. OrderItems - Products (N:1)
- OrderItems.ProductId â†’ Products.Id
- å‚ç…§æ•´åˆæ€§: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆNULLè¨±å¯ï¼‰
- è¨­è¨ˆæ„å›³: å•†å“ãƒžã‚¹ã‚¿ãƒ¼ã¨ã®é–¢é€£ä»˜ã‘ï¼ˆåˆ†æžç”¨ï¼‰

[è©³ç´°ã¯ relationships/entity-relationships.md å‚ç…§]

## ðŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåž‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­è¨ˆ
**OrderItemsãƒ†ãƒ¼ãƒ–ãƒ«**ã¯å•†å“æƒ…å ±ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿æŒï¼š
- ProductTitle: æ³¨æ–‡æ™‚ç‚¹ã®å•†å“åï¼ˆå¿…é ˆï¼‰
- Price: æ³¨æ–‡æ™‚ç‚¹ã®ä¾¡æ ¼ï¼ˆå¿…é ˆï¼‰
- ProductId: å•†å“ãƒžã‚¹ã‚¿ãƒ¼ã¸ã®å‚ç…§ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ç†ç”±**: 
- å•†å“æƒ…å ±ã¯å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€æ³¨æ–‡å±¥æ­´ã¯ä¸å¤‰ã§ã‚ã‚‹ã¹ã
- å•†å“ãŒå‰Šé™¤ã•ã‚Œã¦ã‚‚æ³¨æ–‡å±¥æ­´ã¯æ®‹ã‚‹å¿…è¦ãŒã‚ã‚‹

[è©³ç´°ã¯ design-decisions/snapshot-vs-reference.md å‚ç…§]

## ðŸ” ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

ä¸»è¦ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆï¼š
1. é¡§å®¢åˆ¥æ³¨æ–‡å±¥æ­´: IX_Orders_CustomerId
2. æœŸé–“åˆ¥å£²ä¸Šé›†è¨ˆ: IX_Orders_CreatedAt
3. å•†å“åˆ¥å£²ä¸Šåˆ†æž: IX_OrderItems_ProductId

[è©³ç´°ã¯å„ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸å‚ç…§]
```

### 3. å€‹åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

**ä¾‹**: `docs/03-design-specs/database/table-definitions/order-items-table.md`

```markdown
# OrderItems ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

## æ¦‚è¦
æ³¨æ–‡æ˜Žç´°æƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚å•†å“æƒ…å ±ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã—ã¦ä¿æŒã—ã€æ³¨æ–‡æ™‚ç‚¹ã®æ­£ç¢ºãªæƒ…å ±ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

### DDL
```sql
CREATE TABLE [dbo].[OrderItems](
    [Id] [int] IDENTITY(1,1) NOT NULL,
    [OrderId] [int] NOT NULL,
    [ProductId] [nvarchar](50) NULL,
    [ProductTitle] [nvarchar](255) NOT NULL,
    [VariantTitle] [nvarchar](255) NULL,
    [Quantity] [int] NOT NULL,
    [Price] [decimal](18, 2) NOT NULL,
    [TotalPrice] [decimal](18, 2) NOT NULL,
    [CreatedAt] [datetime2](7) NOT NULL DEFAULT GETDATE(),
    [UpdatedAt] [datetime2](7) NULL,
    CONSTRAINT [PK_OrderItems] PRIMARY KEY CLUSTERED ([Id] ASC),
    CONSTRAINT [FK_OrderItems_Orders] FOREIGN KEY([OrderId]) REFERENCES [dbo].[Orders] ([Id]),
    CONSTRAINT [FK_OrderItems_Products] FOREIGN KEY([ProductId]) REFERENCES [dbo].[Products] ([Id])
);
```

### ã‚«ãƒ©ãƒ è©³ç´°

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|----------|------|------------|------|
| Id | int | NO | IDENTITY | ä¸»ã‚­ãƒ¼ |
| OrderId | int | NO | - | æ³¨æ–‡IDï¼ˆFKï¼‰ |
| ProductId | nvarchar(50) | YES | - | å•†å“IDï¼ˆå‚ç…§ç”¨ï¼‰ |
| ProductTitle | nvarchar(255) | NO | - | å•†å“åï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ |
| VariantTitle | nvarchar(255) | YES | - | ãƒãƒªã‚¢ãƒ³ãƒˆå |
| Price | decimal(18,2) | NO | - | å˜ä¾¡ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ |
| Quantity | int | NO | - | æ•°é‡ |
| TotalPrice | decimal(18,2) | NO | - | å°è¨ˆ |
| CreatedAt | datetime2 | NO | GETDATE() | ä½œæˆæ—¥æ™‚ |
| UpdatedAt | datetime2 | YES | - | æ›´æ–°æ—¥æ™‚ |

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```sql
-- ã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
PK_OrderItems ON [Id]

-- éžã‚¯ãƒ©ã‚¹ã‚¿åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX IX_OrderItems_OrderId ON OrderItems(OrderId);
CREATE INDEX IX_OrderItems_ProductId ON OrderItems(ProductId) WHERE ProductId IS NOT NULL;
CREATE INDEX IX_OrderItems_CreatedAt ON OrderItems(CreatedAt);
```

### è¨­è¨ˆä¸Šã®é‡è¦äº‹é …

#### ðŸ” ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ vs å‚ç…§ã®ä½¿ã„åˆ†ã‘

**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜é …ç›®**:
- ProductTitle: æ³¨æ–‡æ™‚ã®å•†å“åã‚’æ°¸ç¶šä¿å­˜
- Price: æ³¨æ–‡æ™‚ã®ä¾¡æ ¼ã‚’æ°¸ç¶šä¿å­˜
- VariantTitle: æ³¨æ–‡æ™‚ã®ãƒãƒªã‚¢ãƒ³ãƒˆåã‚’æ°¸ç¶šä¿å­˜

**å‚ç…§ä¿å­˜é …ç›®**:
- ProductId: ç¾åœ¨ã®å•†å“ãƒžã‚¹ã‚¿ãƒ¼ã¨ã®é–¢é€£ä»˜ã‘ï¼ˆNULLè¨±å¯ï¼‰

**è¨­è¨ˆç†ç”±**:
1. æ³¨æ–‡å±¥æ­´ã®ä¸å¤‰æ€§ã‚’ä¿è¨¼
2. å•†å“ãƒžã‚¹ã‚¿ãƒ¼ã®å¤‰æ›´ã‚„å‰Šé™¤ã®å½±éŸ¿ã‚’å—ã‘ãªã„
3. åˆ†æžæ™‚ã¯ ProductId ã§ç¾åœ¨ã®å•†å“æƒ…å ±ã¨çµåˆå¯èƒ½

### Entity Framework ãƒ¢ãƒ‡ãƒ«å®šç¾©
```csharp
public class OrderItem
{
    public int Id { get; set; }
    public int OrderId { get; set; }
    public string? ProductId { get; set; }
    public string ProductTitle { get; set; } = string.Empty;
    public string? VariantTitle { get; set; }
    public int Quantity { get; set; }
    public decimal Price { get; set; }
    public decimal TotalPrice { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    public virtual Order Order { get; set; } = null!;
    public virtual Product? Product { get; set; }
}
```

### å…¸åž‹çš„ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³

```sql
-- 1. æ³¨æ–‡æ˜Žç´°ã¨ç¾åœ¨ã®å•†å“æƒ…å ±ã‚’çµåˆ
SELECT 
    oi.ProductTitle as OrderedProductName,
    p.Title as CurrentProductName,
    oi.Price as OrderedPrice,
    p.Price as CurrentPrice,
    oi.Price - p.Price as PriceDifference
FROM OrderItems oi
LEFT JOIN Products p ON oi.ProductId = p.Id
WHERE oi.OrderId = @orderId;

-- 2. å•†å“åˆ¥å£²ä¸Šé›†è¨ˆï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
SELECT 
    ProductTitle,
    COUNT(*) as OrderCount,
    SUM(Quantity) as TotalQuantity,
    SUM(TotalPrice) as TotalRevenue
FROM OrderItems
WHERE CreatedAt >= @startDate AND CreatedAt < @endDate
GROUP BY ProductTitle
ORDER BY TotalRevenue DESC;
```

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```sql
-- ProductIdãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®æ•´åˆæ€§ç¢ºèª
SELECT oi.*
FROM OrderItems oi
WHERE oi.ProductId IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM Products p WHERE p.Id = oi.ProductId
  );
```
```

### 4. ERå›³ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/03-design-specs/database/diagrams/er-diagram-overview.mermaid`

```mermaid
erDiagram
    Stores ||--o{ Products : has
    Stores ||--o{ Customers : has
    Stores ||--o{ Orders : has
    
    Customers ||--o{ Orders : places
    Customers ||--|| CustomerSummary : "has summary"
    
    Orders ||--|{ OrderItems : contains
    Products ||--o{ OrderItems : "referenced in"
    
    Orders {
        int Id PK
        int StoreId FK
        int CustomerId FK
        string OrderNumber UK
        decimal TotalPrice
        string Status
        datetime CreatedAt
    }
    
    OrderItems {
        int Id PK
        int OrderId FK
        string ProductId FK "nullable"
        string ProductTitle "snapshot"
        decimal Price "snapshot"
        int Quantity
        decimal TotalPrice
    }
    
    Products {
        string Id PK
        int StoreId FK
        string Title
        decimal Price
        string Status
        datetime UpdatedAt
    }
    
    CustomerSummary {
        int Id PK
        int CustomerId FK "unique"
        int StoreId FK
        decimal TotalSpent "aggregated"
        int TotalOrders "aggregated"
        datetime LastPurchaseDate "aggregated"
        string DormancySegment "calculated"
    }
```

### 5. è¨­è¨ˆåˆ¤æ–­æ–‡æ›¸

**ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/03-design-specs/database/design-decisions/snapshot-vs-reference.md`

```markdown
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ vs å‚ç…§ã®è¨­è¨ˆåˆ¤æ–­

## è¨­è¨ˆæ–¹é‡

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæŽ¡ç”¨ç®‡æ‰€

#### OrderItems ãƒ†ãƒ¼ãƒ–ãƒ«
- **ProductTitle**: å•†å“åã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
- **Price**: ä¾¡æ ¼ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ  
- **VariantTitle**: ãƒãƒªã‚¢ãƒ³ãƒˆåã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

**æŽ¡ç”¨ç†ç”±**:
1. æ³¨æ–‡å±¥æ­´ã®ä¸å¤‰æ€§ä¿è¨¼
2. å•†å“æƒ…å ±å¤‰æ›´ã®å½±éŸ¿ã‚’å—ã‘ãªã„
3. æ³•çš„è¦ä»¶ï¼ˆå–å¼•è¨˜éŒ²ã®ä¿å­˜ï¼‰

### å‚ç…§æŽ¡ç”¨ç®‡æ‰€

#### Orders ãƒ†ãƒ¼ãƒ–ãƒ«
- **CustomerId**: é¡§å®¢ãƒžã‚¹ã‚¿ãƒ¼ã¸ã®å‚ç…§

**æŽ¡ç”¨ç†ç”±**:
1. é¡§å®¢æƒ…å ±ã®ä¸€å…ƒç®¡ç†
2. é¡§å®¢åˆ†æžã®å¿…è¦æ€§
3. ãƒ‡ãƒ¼ã‚¿é‡ã®å‰Šæ¸›

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æŽ¡ç”¨ç®‡æ‰€

#### OrderItems ãƒ†ãƒ¼ãƒ–ãƒ«
- **ProductId**: å•†å“ãƒžã‚¹ã‚¿ãƒ¼ã¸ã®å‚ç…§ï¼ˆNULLè¨±å¯ï¼‰
- **ProductTitle**: å•†å“åã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆå¿…é ˆï¼‰

**æŽ¡ç”¨ç†ç”±**:
1. å±¥æ­´ã®ä¿è¨¼ã¨ãƒžã‚¹ã‚¿ãƒ¼é€£æºã®ä¸¡ç«‹
2. å•†å“å‰Šé™¤æ™‚ã®å±¥æ­´ä¿æŒ
3. åˆ†æžæ™‚ã®æŸ”è»Ÿæ€§ç¢ºä¿
```

### 6. æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

è¨­è¨ˆæ›¸ä½œæˆå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªï¼š

- [ ] ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] å¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚ãŒã™ã¹ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ vs å‚ç…§ã®è¨­è¨ˆåˆ¤æ–­ãŒæ˜Žè¨˜ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
- [ ] NULLè¨±å¯ã®ç†ç”±ãŒèª¬æ˜Žã•ã‚Œã¦ã„ã‚‹
- [ ] DDLã¨ãƒ¢ãƒ‡ãƒ«å®šç¾©ãŒä¸€è‡´ã—ã¦ã„ã‚‹
- [ ] ERå›³ãŒæœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ ã—ã¦ã„ã‚‹
- [ ] å…¸åž‹çš„ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¤ºã•ã‚Œã¦ã„ã‚‹

### 7. AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘ãƒ«ãƒ¼ãƒ«è¨­å®š

è¨­è¨ˆæ›¸å®Œæˆå¾Œã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®READMEã¾ãŸã¯é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```markdown
## ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆå‚ç…§ãƒ«ãƒ¼ãƒ«

### å¿…é ˆå‚ç…§
AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŠã‚ˆã³é–‹ç™ºè€…ã¯ä»¥ä¸‹ã®å ´åˆã€å¿…ãšDBè¨­è¨ˆæ›¸ã‚’å‚ç…§ã™ã‚‹ã“ã¨ï¼š

1. **æ–°è¦é–‹ç™ºæ™‚**
   - ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚«ãƒ©ãƒ ã®è¿½åŠ ææ¡ˆ
   - ã‚¯ã‚¨ãƒªã‚„LINQã®ä½œæˆ
   - APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆ

2. **ãƒ‡ãƒ¼ã‚¿æ“ä½œæ™‚**
   - OrderItemsã®ProductTitle, Priceã¯**ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**ã¨ã—ã¦æ‰±ã†
   - CustomerSummaryã¯**é›†è¨ˆãƒ‡ãƒ¼ã‚¿**ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã¯ãªã„ï¼‰
   - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã«å¾“ã£ãŸæ“ä½œ

3. **åˆ†æžæ©Ÿèƒ½å®Ÿè£…æ™‚**
   - é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åˆ©ç”¨
   - ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã¨ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã®ä½¿ã„åˆ†ã‘

### è¨­è¨ˆæ›¸ã®å ´æ‰€
`docs/03-design-specs/database/DATABASE-DESIGN.md`
```

### å®Œäº†æ¡ä»¶
- [ ] ãƒ¡ã‚¤ãƒ³è¨­è¨ˆæ›¸ã®ä½œæˆ
- [ ] å…¨ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸ã®ä½œæˆï¼ˆæœ€ä½Ž6ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] ERå›³ã®ä½œæˆï¼ˆoverviewç‰ˆã¨detailedç‰ˆï¼‰
- [ ] è¨­è¨ˆåˆ¤æ–­æ–‡æ›¸ã®ä½œæˆ
- [ ] ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨˜è¼‰
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ¤œè¨¼å®Œäº†

æœŸé™ï¼š3æ—¥ä»¥å†…