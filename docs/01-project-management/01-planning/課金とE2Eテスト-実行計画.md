# 課金とE2Eテスト 実行計画（たたき台）

参照: `ai-team/handover/2025-08-25-handover.md`, `docs/01-project-management/00_meeting/250825_会議議事録.md`, `docs/06-shopify/02-課金システム/`

---

## 1. 目的・範囲
- 目的: 本番公開前に「課金関連機能の完成」と「インストール→同期→画面表示」のE2E品質を担保する。
- 範囲: Shopify App Subscription（GraphQL）、無料プランゲーティング、GDPR必須Webhook、データ同期、主要画面表示確認。

## 2. 完了条件（Definition of Done）
- 課金
  - appSubscriptionCreate 成功/キャンセル/更新が通る（試験モード0円含む）
  - Webhook: `app_subscriptions/update|cancelled` 受信・冪等処理・永続化
  - プラン選択: 有料/無料の二択 UI 完了、有料はアクティブ顧客数で自動レベル決定
- 無料プラン
  - 休眠顧客分析のみアクセス可。他機能はアップグレード誘導
  - 月1回の機能変更制約（必要に応じて実装/無効化の最終判断）
- GDPR
  - `customers/redact`, `customers/data_request`, `shop/redact`, `app/uninstalled` 実装・署名検証・冪等
- E2E
  - 新規インストール→OAuth完了→初期同期開始→ダッシュボード表示まで手順書通りに成功
  - 主要画面（ダッシュボード/休眠顧客分析/設定/課金）でエラーなし、計測項目が閾値内

## 3. 実行タスク分解（担当/期限/成果物）
- Backend（Takashi）
  - 課金GraphQL実装の最終化（リトライ/Polly、Idempotency、例外整備）
  - 課金Webhook群の処理（状態遷移、StoreSubscriptions永続化、監査ログ）
  - GDPR 4種Webhook実装（署名検証、IdempotencyKey、GDPRComplianceLog）
  - 同期ジョブ初期化/再開（Hangfire想定）と進捗API
- Frontend（Yuki）
  - プラン選択UI（有料/無料二択、無料は休眠顧客分析誘導）
  - 機能ゲート（`useFeatureAccess`）の全画面適用、アップグレード導線
  - Billing/設定ページのSubscription状態表示・遷移
  - アイコン/ヘッダ画像適用、スクショ取得
- PM（Kenji）
  - 料金/トライアル最終確定、パートナーダッシュボード設定
  - 申請チェックと資料整備（規約/ポリシーURL、説明文、スクショ）

## 4. 手順（E2E流れ）
1. テストストア準備（スコープ・権限確認、既存アプリの削除→再インストール）
2. OAuth → アプリ初回起動（オンボーディング内でプラン選択）
3. 無料選択パス: 休眠顧客分析へ誘導、他機能はゲート表示
4. 有料選択パス: 課金承認（試験モード）、成功後に全機能解放
5. 初期同期開始（キュー投入→進捗監視→完了）
6. ダッシュボード/主要画面の表示確認
7. Webhook各種シナリオ（購読更新/キャンセル、GDPR）を擬似/実機で検証
8. ログ/メトリクス確認（失敗時の再実行・冪等性）

## 5. テスト（抜粋）
- 参照: `docs/06-shopify/02-課金システム/03-実装管理/テスト仕様書-課金と無料プラン.md`、`課金0円テスト完全手順書.md`
- 観点: 課金成功/キャンセル、無料ゲート、Webhook冪等、同期完了、UIレンダリング、リトライ/タイムアウト

## 6. ログ/監視/計測
- 重要ログ: Billing GraphQLレスポンス、Webhook受信ID/IdempotencyKey、同期進捗、UIエラー
- メトリクス閾値（例）: API 95p < 300ms、同期完了 < 10分、フロントLCP < 2.5s

## 7. リスク/対策
- 課金Webhook未達/遅延 → リトライ/キュー化、署名検証、監査ログ
- 同期長時間化 → バッチ分割/チェックポイント、タイムアウトと再開
- 申請却下 → ガイドライン再確認、GDPR/サポート/説明文の網羅

## 8. スケジュール（暫定）
- DDL適用→GDPR→統合テスト→素材確定→申請チェック→提出（目標: 9/2 要再確認）
- 次回ミーティング: 月曜夜枠（議事録参照）

## 9. 成果物パス
- 課金: `docs/06-shopify/02-課金システム/`
- GDPR: `docs/06-shopify/02-課金システム/04-理解と運用/`
- 同期: `docs/04-development/04-移行計画/` / `.../マイグレーション/`

## 10. Backlog 運用（チケット粒度の例）
- feat: Billing GraphQL 完了（DoD明記）
- feat: 課金Webhook処理（状態遷移/冪等/監査）
- feat: GDPR 4種Webhook
- feat: 機能ゲート全適用＋アップグレード導線
- chore: アイコン/ヘッダ適用＋スクショ
- chore: パートナーダッシュボード設定
- test: E2E通しテスト（無料/有料/キャンセル/再課金）

## 11. 不明点（確認をお願いします）
1. 料金/トライアルの最終案（金額・日数）は確定済みですか？（確定値をご指定ください）
2. 無料プランの「月1回の機能変更」制約は実装対象に含めますか？現行は休眠顧客分析のみで確定で問題ありませんか？
3. 9/2申請提出は維持しますか？調整が必要な場合、目標日をご指定ください。
4. 規約・プライバシーポリシーのURL最終版はいつ受領可能でしょうか？
5. テストで使用するストア/アカウントの指定と権限は問題ありませんか？
6. スクリーンショットに含める必須画面の最終リストに変更はありますか？

## 12. 関係者別タスクと期限（暫定）
- Backend（Takashi）
  - Billing GraphQL最終化（Polly/Idempotency/例外整理）［期限: 8/28 目安］
  - 課金Webhook（update/cancelled）処理・監査ログ［期限: 8/29 目安］
  - GDPR 4種Webhook実装/試験［期限: 8/28 目安］
  - 同期ジョブ初期化/再開・進捗API［期限: 8/29 目安］
- Frontend（Yuki）
  - プラン選択UI・機能ゲート適用［期限: 8/28-29 目安］
  - Billing/設定ページの状態表示/遷移［期限: 8/29 目安］
  - アイコン/ヘッダ適用・スクショ取得［期限: 8/30 目安］
- PM（Kenji）
  - 料金/トライアル確定・パートナーダッシュボード反映［期限: 8/30 目安］
  - 申請チェック・資料整備（規約/説明文/スクショ）［期限: 提出-1日］
- 顧客側（ご協力）
  - 価格/トライアル承認、規約URL提供、テスト協力［期限: 各所定日］
