# 技術確認: アプリ起動時の自動接続フロー改善

## 現状の技術実装

### 1. `/install` ページの自動リダイレクトロジック（既存）

**実装場所**: `frontend/src/app/install/page.tsx`

**既存の自動リダイレクト条件**:
- ✅ 認証済み (`isAuthenticated === true`)
- ✅ OAuth認証成功フラグ (`localStorage.getItem('oauth_authenticated') === 'true'`)
- ✅ ストアIDが存在 (`localStorage.getItem('currentStoreId')`)
- ✅ ショップドメインがURLパラメータに存在 (`shop` パラメータ)

**問題点**:
1. **複数のuseEffectに分散**: 自動リダイレクトのロジックが複数のuseEffect（3つ以上）に分散しており、実行順序が複雑
2. **条件チェックが複雑**: `isAuthenticated`、`oauth_authenticated`、`currentStoreId` の3つの条件を複数箇所でチェック
3. **タイミング問題**: 認証状態の初期化を待つ処理が複数箇所にあり、競合する可能性
4. **重複実行防止の複雑さ**: `hasCheckedStoreRef` で重複実行を防いでいるが、条件が複雑

### 2. 認証状態の管理（AuthProvider）

**実装場所**: `frontend/src/components/providers/AuthProvider.tsx`

**認証状態の保存場所**:
- `isAuthenticated`: React state（AuthProvider内）
- `oauth_authenticated`: localStorage
- `currentStoreId`: localStorage + React state（AuthProvider内）

## 技術的な確認結果

### ✅ 技術的に実現可能

**理由**:
1. 既にインストール済みでOAuth認証も完了している場合、以下の条件が揃っているはず：
   - `localStorage.getItem('oauth_authenticated') === 'true'`
   - `localStorage.getItem('currentStoreId')` が存在
   - `isAuthenticated === true`（AuthProviderが初期化後）

2. 既存の自動リダイレクトロジックが動作する条件：
   - `checkAndRedirect` 関数（line 334-514）で、認証済みかつ登録済みストアの場合、自動で `/customers/dormant` または `/setup/initial` にリダイレクト

### ⚠️ 現状の問題点

1. **実行タイミングの問題**:
   - 認証状態の初期化を待つ処理が複数箇所にあり、条件によっては自動リダイレクトが実行されない可能性
   - `isInitializing` が `true` の間は自動リダイレクトがスキップされる

2. **条件の複雑さ**:
   - 複数のuseEffectが相互に影響し合っており、デバッグが困難
   - 条件分岐が多く、想定外のパスで自動リダイレクトが実行されない可能性

3. **OAuth処理中フラグの影響**:
   - `oauth_in_progress` フラグがある場合、自動リダイレクトがスキップされる
   - フラグがクリアされない場合、自動リダイレクトが実行されない

## 改善案

### 案1: シンプルな早期リダイレクト（推奨）

**実装方針**:
1. マウント時に即座に認証状態をチェック
2. 認証済みかつストアIDが存在する場合、即座にリダイレクト
3. 条件を1箇所に集約

**実装箇所**: `frontend/src/app/install/page.tsx`

**変更内容**:
```typescript
// マウント時に即座に認証状態をチェック
useEffect(() => {
  if (typeof window === 'undefined') return;
  if (isInitializing) return; // 初期化中は待機
  
  // 認証済みチェック（シンプル化）
  const oauthAuthenticated = localStorage.getItem('oauth_authenticated') === 'true';
  const currentStoreId = localStorage.getItem('currentStoreId');
  const shopFromUrl = searchParams.get('shop');
  
  // 認証済みかつストアIDが存在する場合、即座にリダイレクト
  if (oauthAuthenticated && currentStoreId && shopFromUrl) {
    console.log('✅ [Install] 認証済みを検出: 自動リダイレクト', {
      storeId: currentStoreId,
      shop: shopFromUrl
    });
    
    const redirectParams = new URLSearchParams();
    redirectParams.set('shop', shopFromUrl);
    if (searchParams.get('host')) redirectParams.set('host', searchParams.get('host')!);
    redirectParams.set('embedded', '1');
    
    // 初期設定が完了しているかチェック（オプション）
    // 完了していない場合は /setup/initial にリダイレクト
    const redirectUrl = `/customers/dormant?${redirectParams.toString()}`;
    window.location.replace(redirectUrl);
    return;
  }
}, [isInitializing, searchParams]); // 依存配列を最小限に
```

**メリット**:
- ✅ シンプルで理解しやすい
- ✅ 実行タイミングが明確
- ✅ 既存の複雑なロジックと競合しない

**デメリット**:
- ⚠️ 初期設定が完了していない場合、`/customers/dormant` にリダイレクト後、再度 `/setup/initial` にリダイレクトされる可能性

### 案2: 既存ロジックの改善

**実装方針**:
1. 既存の `checkAndRedirect` 関数を改善
2. 条件チェックを簡素化
3. 実行タイミングを明確化

**変更内容**:
- `checkAndRedirect` 関数の条件を簡素化
- 複数のuseEffectを1つに統合
- タイミング問題を解決

**メリット**:
- ✅ 既存のロジックを活用
- ✅ 他の機能への影響が少ない

**デメリット**:
- ⚠️ 既存の複雑なロジックを理解する必要がある
- ⚠️ デバッグが困難

## 推奨実装

**案1（シンプルな早期リダイレクト）を推奨**

**理由**:
1. シンプルで理解しやすい
2. 既存の複雑なロジックと競合しない
3. デバッグが容易
4. ユーザー体験が向上（即座にリダイレクト）

**実装手順**:
1. `/install` ページのマウント時に、認証状態をチェックするuseEffectを追加
2. 認証済みかつストアIDが存在する場合、即座にリダイレクト
3. 既存の複雑なロジックは残しつつ、早期リダイレクトを優先

## 注意事項

1. **OAuth処理中フラグの確認**:
   - `oauth_in_progress` フラグがある場合は、自動リダイレクトをスキップする必要がある
   - 理由: OAuth認証フロー中に自動リダイレクトが実行されると、認証フローが中断される

2. **初期設定の確認**:
   - 初期設定が完了していない場合、`/setup/initial` にリダイレクトする必要がある
   - バックエンドAPIで初期設定の完了状態を確認する必要がある

3. **エラーハンドリング**:
   - 自動リダイレクトが失敗した場合、通常のインストール画面を表示する必要がある

## 次のステップ

1. ✅ 技術的な確認完了
2. ⏳ 実装方針の決定（案1を推奨）
3. ⏳ 実装
4. ⏳ 動作確認
