# 技術確認: 商品削除同期と同期履歴表示の改善

## 調査日
2026-01-23

## 調査対象
1. 商品数カウントの不整合問題
2. Shopify商品削除時の同期方法
3. 同期履歴の表示問題

---

## 1. Shopify公式ドキュメントの調査結果

### 1.1 商品削除の検知方法

Shopify APIでは、削除された商品を検知する方法が**2つ**あります。

#### 方法A: `products/delete` Webhook（リアルタイム）

**公式ドキュメント**: https://shopify.dev/docs/api/admin-rest/2025-04/resources/webhook

```json
// Webhook ペイロード
{
  "id": 788032119674292922
}
```

- **発火タイミング**: 商品が削除されたとき
- **ペイロード**: 削除された商品の `id` のみ
- **必要スコープ**: `read_products`
- **メリット**: リアルタイムで削除を検知できる
- **デメリット**: Webhookの信頼性（配信失敗の可能性）

#### 方法B: Event API（バッチ処理）

**公式ドキュメント**: https://shopify.dev/docs/api/admin-rest/2025-04/resources/event

```http
GET /admin/api/2025-04/events.json?filter=Product&verb=destroy
```

```json
// レスポンス例
{
  "events": [
    {
      "id": 123456789,
      "subject_id": 788032119674292922,
      "subject_type": "Product",
      "verb": "destroy",
      "created_at": "2026-01-23T10:00:00-05:00",
      "message": "Product was deleted: Example Product"
    }
  ]
}
```

- **取得方法**: Event APIで `verb=destroy` を指定
- **メリット**: 同期ジョブで定期的に確認可能
- **デメリット**: リアルタイムではない

### 1.2 重要な仕様

⚠️ **Shopifyの商品削除は物理削除**
- 削除された商品のデータは完全に削除される
- `deleted_at` のような論理削除フラグは**存在しない**
- 削除後は `GET /products/{id}.json` で404が返る

---

## 2. 現在の実装状況

### 2.1 Webhook実装

**実装状況**: ❌ `products/delete` Webhookは未実装

現在実装されているWebhook:
- `app/uninstalled` ✅
- `customers/data_request` ✅（GDPR必須）
- `customers/redact` ✅（GDPR必須）
- `shop/redact` ✅（GDPR必須）

### 2.2 商品同期ジョブ

**ファイル**: `backend/ShopifyAnalyticsApi/Jobs/ShopifyProductSyncJob.cs`

**問題点**: 削除商品を検出・処理するロジックが**コメントアウト**されている

```csharp
// 削除された商品を特定
// var deletedProductIds = dbProductIds.Except(shopifyProductIds).ToList();

// if (deletedProductIds.Any())
// {
//     // 削除された商品を非アクティブ化
//     var productsToDeactivate = await _context.Products
//         .Where(p => p.StoreId == storeId && deletedProductIds.Contains(p.ShopifyProductId))
//         .ToListAsync();
    
//     foreach (var product in productsToDeactivate)
//     {
//         product.IsActive = false;
//         product.UpdatedAt = DateTime.UtcNow;
//     }
    
//     await _context.SaveChangesAsync();
    
//     _logger.LogInformation($"Deactivated {deletedProductIds.Count} deleted products");
// }
```

### 2.3 Productモデル

**ファイル**: `backend/ShopifyAnalyticsApi/Models/DatabaseModels.cs`

**問題点**: Productモデルに `IsActive` フィールドが**存在しない**

```csharp
public class Product
{
    public int Id { get; set; }
    public int StoreId { get; set; }
    public string Title { get; set; }
    public string? ShopifyProductId { get; set; }
    // ... その他のフィールド
    // ❌ IsActive フィールドがない
}
```

※ Customer、Store、ShopifyApp には `IsActive` フィールドがある

### 2.4 商品カウント処理

**現在の実装**: 全商品を単純にカウント

```csharp
// DatabaseController.cs
var productCount = await _context.Products.Where(p => p.StoreId == storeId).CountAsync();
```

**問題点**: 削除フラグを考慮していないため、削除された商品も含まれる

---

## 3. 技術的な対応オプション

### Option A: products/delete Webhookを実装（リアルタイム削除）

**実装内容**:
1. WebhookControllerに `products/delete` エンドポイントを追加
2. 受信時にローカルDBから該当商品を物理削除

**メリット**:
- ✅ リアルタイムで同期
- ✅ 実装がシンプル

**デメリット**:
- ⚠️ Webhookの配信失敗時にデータ不整合
- ⚠️ Webhookの登録が必要（Shopify App設定）

**推奨度**: ⭐⭐⭐ (高)

### Option B: 同期時に差分比較して削除（バッチ処理）

**実装内容**:
1. コメントアウトされているロジックを有効化
2. Productモデルに `IsActive` を追加（または物理削除）

**メリット**:
- ✅ Webhookに依存しない
- ✅ 既存の同期ジョブに統合可能

**デメリット**:
- ⚠️ 全商品を取得する必要がある（大規模ストアで負荷）
- ⚠️ リアルタイム性がない

**推奨度**: ⭐⭐⭐ (高)

### Option C: Event APIで削除イベントを取得

**実装内容**:
1. 同期ジョブでEvent APIを呼び出し
2. `verb=destroy` のイベントを取得して処理

**メリット**:
- ✅ 差分のみ処理可能
- ✅ 履歴として記録される

**デメリット**:
- ⚠️ 追加のAPI呼び出しが必要
- ⚠️ イベントの保持期間に制限がある可能性

**推奨度**: ⭐⭐ (中)

---

## 4. 推奨対応方針

### 第1段階: 即時対応（Option B）

**理由**: 既存のロジックを活用でき、最小限の変更で実装可能

**実装手順**:
1. Productモデルに `IsActive` フィールドを追加（マイグレーション必要）
2. ShopifyProductSyncJobのコメントアウトを解除
3. 商品カウント時に `IsActive = true` でフィルタ

```csharp
// Productモデルに追加
public bool IsActive { get; set; } = true;

// カウント時
var productCount = await _context.Products
    .Where(p => p.StoreId == storeId && p.IsActive)
    .CountAsync();
```

### 第2段階: 将来対応（Option A）

**理由**: リアルタイム性を向上させるため

**実装手順**:
1. Shopify App設定で `products/delete` Webhookを登録
2. WebhookControllerにエンドポイントを追加
3. 受信時に `IsActive = false` に更新

---

## 5. 同期履歴表示の調査

### 5.1 SyncStatesテーブルの確認

**必要な調査**:
- SyncStatesテーブルにデータが保存されているか
- フロントエンドの同期履歴表示コンポーネントの実装状況

### 5.2 対応オプション

**Option 1**: 同期履歴の表示を改善
- SyncStatesテーブルからデータを正しく取得
- UIコンポーネントを修正

**Option 2**: 同期履歴タブを削除
- 機能として不要であれば削除
- UIをシンプルに保つ

**推奨**: まずはSyncStatesテーブルのデータを確認し、データがあれば表示改善、なければタブ削除を検討

---

## 6. 次のステップ

1. ✅ 技術調査完了
2. ⏳ 方針決定: 物理削除 vs 論理削除（IsActive）
3. ⏳ マイグレーション作成（IsActive追加の場合）
4. ⏳ 同期ジョブの修正
5. ⏳ 商品カウントの修正
6. ⏳ 同期履歴表示の調査・対応

---

## 7. 関連ファイル

- `backend/ShopifyAnalyticsApi/Jobs/ShopifyProductSyncJob.cs`
- `backend/ShopifyAnalyticsApi/Models/DatabaseModels.cs`
- `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/DatabaseController.cs`
