# Shopify ECマーケティングアプリ 優先機能テスト手順書

**作成日**: 2025-09-17
**対象バージョン**: MVP Release 1.0
**テスト環境**: Shopify Development Store + Azure Development Environment

---

## 📋 テスト実行前チェックリスト

### 環境準備
- [ ] Shopify Partners アカウントが有効
- [ ] Development Store が作成済み
- [ ] ngrok または類似ツールでローカル環境を公開可能
- [ ] Azure開発環境へのアクセス権限確認
- [ ] テスト用Shopifyストアにサンプルデータ投入済み

### 必要なツール
- [ ] Postman/Insomnia（API テスト用）
- [ ] Chrome DevTools（ネットワーク監視）
- [ ] Azure Portal アクセス（ログ確認用）
- [ ] Git（バージョン管理）

---

## 1️⃣ インストール機能テスト

### 1.1 正常インストールフロー

#### テスト手順
1. **Development Store でアプリインストール開始**
   ```
   URL: https://[your-dev-store].myshopify.com/admin/apps
   操作: "カスタムアプリを追加" → アプリURLを入力
   ```
   - [ ] アプリ一覧画面が表示される
   - [ ] インストールボタンが有効である

2. **OAuth認証フロー確認**
   ```
   期待URL: /auth/shopify?shop=[store-name].myshopify.com
   ```
   - [ ] Shopify認証画面にリダイレクトされる
   - [ ] 必要な権限が正しく表示される：
     - [ ] 商品の読み取り（read_products）
     - [ ] 顧客の読み取り（read_customers）
     - [ ] 注文の読み取り（read_orders）
     - [ ] 課金の作成（write_billing）
   - [ ] "インストール" ボタンが表示される

3. **認証完了後の処理**
   ```
   確認項目:
   - Response Header: X-Frame-Options: DENY
   - Session Token が発行されている
   - データベースにショップ情報が保存されている
   ```
   - [ ] 正常にアプリ画面にリダイレクトされる
   - [ ] 初期設定画面が表示される
   - [ ] ウェルカムメッセージが表示される

4. **初期設定完了**
   - [ ] 基本設定の保存が成功する
   - [ ] ダッシュボードが表示される
   - [ ] ナビゲーションメニューが有効である

### 1.2 異常系テスト

#### 認証エラーケース
- [ ] **認証拒否時**: エラーメッセージ「インストールがキャンセルされました」が表示
- [ ] **無効なショップURL**: エラーメッセージ「有効なShopifyストアURLを入力してください」が表示
- [ ] **ネットワークエラー**: 再試行オプションが表示される
- [ ] **既インストール済み**: 既存のアプリ画面にリダイレクト

#### セキュリティ確認
```bash
# DevToolsでネットワークタブを確認
- [ ] すべての通信がHTTPS
- [ ] CSRFトークンが含まれている
- [ ] セッショントークンの有効期限確認（通常24時間）
```

---

## 2️⃣ データ同期機能テスト

### 2.1 初期データ同期

#### 商品データ同期テスト
```javascript
// テスト確認コマンド（Console）
await fetch('/api/sync/products', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
});
```
- [ ] 全商品が取得される（ページネーション含む）
- [ ] 商品バリアント情報が正確
- [ ] 画像URLが正しく保存される
- [ ] 在庫情報が同期される
- [ ] 同期完了通知が表示される

#### 顧客データ同期テスト
```javascript
// 顧客数確認
await fetch('/api/sync/customers/count');
```
- [ ] 顧客の基本情報が同期される
- [ ] メールアドレスが正しく保存される
- [ ] 顧客タグが同期される
- [ ] 作成日・更新日が正確
- [ ] プライバシー設定が反映される

#### 注文データ同期テスト
- [ ] 過去90日分の注文が取得される
- [ ] 注文ステータスが正確
- [ ] 金額計算が一致する
- [ ] 配送先情報が保存される
- [ ] 商品明細が正確

### 2.2 差分同期・Webhook

#### Webhook受信テスト
```bash
# ngrokでローカル環境を公開
ngrok http 3000

# Shopify管理画面でWebhook設定
- products/update
- customers/update
- orders/create
```
- [ ] 商品更新Webhookが受信される
- [ ] 顧客更新Webhookが処理される
- [ ] 注文作成Webhookが反映される
- [ ] 重複処理が防止される
- [ ] エラー時のリトライが動作する

#### データ整合性確認
```sql
-- データベース確認クエリ例
SELECT COUNT(*) FROM Products WHERE ShopId = @shopId;
SELECT COUNT(*) FROM Customers WHERE ShopId = @shopId;
SELECT COUNT(*) FROM Orders WHERE ShopId = @shopId;
```
- [ ] Shopify APIとデータ数が一致
- [ ] NULL値の適切な処理
- [ ] 文字エンコーディングが正しい
- [ ] タイムゾーンが正確（UTC）

### 2.3 パフォーマンステスト

#### 大量データ処理
- [ ] 1000商品の同期：3分以内
- [ ] 5000顧客の同期：5分以内
- [ ] 10000注文の同期：10分以内
- [ ] メモリ使用量：2GB以内
- [ ] CPU使用率：80%以下

---

## 3️⃣ 課金機能テスト

### 3.1 プラン選択・課金開始

#### 無料トライアル開始
```javascript
// 課金API確認
POST /api/billing/activate-trial
{
  "plan": "basic",
  "trial_days": 14
}
```
- [ ] プラン一覧が表示される
- [ ] 各プランの機能比較が正確
- [ ] 無料トライアル期間が表示される
- [ ] トライアル開始ボタンが動作する
- [ ] 確認画面が表示される

#### 課金承認フロー
- [ ] Shopify課金承認画面へリダイレクト
- [ ] 金額が正しく表示される
- [ ] 承認後アプリに戻る
- [ ] プラン情報がDBに保存される
- [ ] 使用制限が解除される

### 3.2 課金管理機能

#### 現在のプラン確認
- [ ] 現在のプラン名が表示される
- [ ] 次回請求日が表示される
- [ ] 使用量/制限が表示される
- [ ] アップグレードオプションが表示される

#### プラン変更テスト
```javascript
// プラン変更API
POST /api/billing/change-plan
{
  "from_plan": "basic",
  "to_plan": "professional"
}
```
- [ ] プラン変更確認画面が表示
- [ ] 差額計算が正しい
- [ ] 即座にプランが切り替わる
- [ ] 機能制限が更新される
- [ ] 変更履歴が記録される

### 3.3 エラーハンドリング

#### 異常系テスト
- [ ] **決済失敗時**: エラーメッセージと再試行オプション
- [ ] **プラン制限到達**: アップグレード促進メッセージ
- [ ] **APIレート制限**: 適切な待機処理
- [ ] **課金停止時**: 読み取り専用モードへ移行
- [ ] **無効なプラン**: エラーメッセージ表示

---

## 4️⃣ 休眠顧客分析機能テスト

### 4.1 休眠顧客抽出ロジック

#### 抽出条件設定
```javascript
// 休眠条件設定
{
  "inactive_days": 90,
  "exclude_recent_visitors": true,
  "minimum_order_count": 1
}
```
- [ ] 休眠期間（30/60/90/180日）が選択可能
- [ ] 除外条件が適用される
- [ ] 抽出結果の件数が妥当
- [ ] フィルタ条件が保存される

#### 抽出精度確認
- [ ] 最終購入日が正確
- [ ] 購入回数が正しい
- [ ] 平均購入額が計算される
- [ ] VIP顧客フラグが機能する

### 4.2 復帰予測機能

#### スコア算出テスト
```javascript
// 予測スコア取得
GET /api/analysis/dormant/scores?customer_id=xxx
```
- [ ] 復帰可能性スコア（0-100）が表示
- [ ] スコアの根拠が表示される：
  - [ ] 過去の購入パターン
  - [ ] 季節性の考慮
  - [ ] 商品カテゴリの影響
- [ ] スコア更新が日次で実行される

### 4.3 分析結果UI

#### 一覧表示
- [ ] 顧客一覧が表示される
- [ ] ページネーション（50件/ページ）
- [ ] ソート機能：
  - [ ] 復帰スコア順
  - [ ] 休眠期間順
  - [ ] 購入額順
- [ ] 検索機能が動作する

#### 詳細画面
- [ ] 顧客の購入履歴が表示
- [ ] 復帰予測の詳細が表示
- [ ] 推奨アクションが提示される
- [ ] メモ機能が動作する

### 4.4 エクスポート機能

#### CSVエクスポート
```javascript
// エクスポートAPI
POST /api/export/dormant-customers
{
  "format": "csv",
  "columns": ["email", "name", "score", "last_order_date"]
}
```
- [ ] CSVファイルがダウンロードされる
- [ ] 文字コードがUTF-8 BOM付き
- [ ] Excelで正しく開ける
- [ ] 全データが含まれる
- [ ] ヘッダー行が正しい

---

## 🔄 統合テストシナリオ

### エンドツーエンドテスト手順

1. **新規インストールから分析まで**
   ```
   所要時間目安: 30分
   ```
   - [ ] Development Storeを初期化
   - [ ] アプリをインストール
   - [ ] 初期データ同期を実行（5分待機）
   - [ ] 無料トライアルを開始
   - [ ] 休眠顧客分析を実行
   - [ ] 結果をCSVエクスポート
   - [ ] プランをアップグレード
   - [ ] 追加機能が利用可能か確認

2. **日常運用シミュレーション**
   - [ ] Webhook経由でデータ更新
   - [ ] 分析結果の自動更新確認
   - [ ] 複数ユーザーでの同時アクセス
   - [ ] 24時間連続稼働テスト

---

## ⚡ パフォーマンス基準

### レスポンスタイム目標
| 機能 | 目標時間 | 許容時間 |
|------|----------|----------|
| ダッシュボード表示 | 1秒以内 | 3秒以内 |
| データ同期（100件） | 5秒以内 | 10秒以内 |
| 休眠顧客分析 | 3秒以内 | 5秒以内 |
| CSVエクスポート | 5秒以内 | 10秒以内 |

### 負荷テスト基準
- 同時接続数: 50ユーザー
- データ量: 10,000顧客、5,000商品、50,000注文
- エラー率: 0.1%以下
- 可用性: 99.9%

---

## 🐛 よくある問題と対処法

### インストール関連
| 問題 | 原因 | 対処法 |
|------|------|--------|
| 認証ループ | Cookie設定 | SameSite=None確認 |
| 404エラー | ngrok URL変更 | アプリ設定更新 |
| 権限エラー | スコープ不足 | 再インストール |

### データ同期関連
| 問題 | 原因 | 対処法 |
|------|------|--------|
| 同期停止 | APIレート制限 | リトライ間隔調整 |
| データ欠損 | ページング処理 | cursor確認 |
| 文字化け | エンコーディング | UTF-8設定確認 |

### 課金関連
| 問題 | 原因 | 対処法 |
|------|------|--------|
| 課金失敗 | テストモード | 本番環境確認 |
| プラン反映されない | キャッシュ | Redis更新 |

---

## 📊 テスト結果記録テンプレート

```markdown
## テスト実施記録

**実施日**: 2025-09-XX
**実施者**: [名前]
**環境**: Development/Staging/Production
**バージョン**: vX.X.X

### テスト結果サマリー
- 総テスト項目数: XXX
- 成功: XXX
- 失敗: XXX
- スキップ: XXX
- 成功率: XX%

### 発見された問題
1. [問題の概要]
   - 重要度: High/Medium/Low
   - 再現手順:
   - 期待結果:
   - 実際の結果:
   - 対応状況:

### 次回アクション
- [ ] 修正確認テスト
- [ ] 回帰テスト
- [ ] パフォーマンステスト
```

---

## 📝 補足事項

- このテスト手順書は継続的に更新してください
- 新機能追加時は対応するテストケースを追加してください
- 本番環境テストは必ず承認を得てから実施してください
- テスト結果は必ず記録・共有してください

**最終更新日**: 2025-09-17
**次回レビュー予定**: プロジェクト再開時