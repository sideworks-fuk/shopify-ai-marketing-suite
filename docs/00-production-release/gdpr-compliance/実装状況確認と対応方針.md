### ç¾çŠ¶ã®å®Ÿè£…çŠ¶æ³ï¼ˆè¦ç‚¹ï¼‰
- å¿…é ˆWebhook4ç¨®ã‚’å®Ÿè£…æ¸ˆã¿ï¼ˆHMACæ¤œè¨¼ãƒ»å¿…é ˆãƒ˜ãƒƒãƒ€æ¤œè¨¼ãƒ»å³æ™‚200å¿œç­”ãƒ»å†ªç­‰åŒ–ãƒ»ç›£æŸ»ãƒ­ã‚°ï¼‰
  - app/uninstalled
  - customers/redact
  - shop/redact
  - customers/data_request
- HMACæ¤œè¨¼ï¼ˆå›ºå®šæ™‚é–“æ¯”è¼ƒï¼‰ã€ãƒœãƒ‡ã‚£å†èª­è¾¼ã€ã‚µã‚¤ã‚ºä¸Šé™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
```426:475:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
private async Task<bool> VerifyWebhookRequest()
{
    // ... çœç•¥ ...
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(secret));
    var computedHashBytes = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
    // å—ä¿¡å€¤ã‚’Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
    // ...
    // å›ºå®šæ™‚é–“æ¯”è¼ƒã§æ¤œè¨¼
    return CryptographicOperations.FixedTimeEquals(computedHashBytes, receivedHmacBytes);
}
```
- ãƒˆãƒ”ãƒƒã‚¯è¨±å¯ãƒªã‚¹ãƒˆã¨å¿…é ˆãƒ˜ãƒƒãƒ€æ¤œè¨¼ã‚’å®Ÿè£…
```893:931:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
private bool ValidateRequiredHeaders(string expectedTopic, out string topic, out string shopDomain, out string webhookId)
{
    // ... çœç•¥ ...
    var allowed = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        "app/uninstalled","customers/redact","shop/redact",
        "customers/data_request","app_subscriptions/update","app_subscriptions/cancel"
    };
    // ... çœç•¥ ...
    if (!allowed.Contains(topic)) { return false; }
    if (!string.Equals(topic, expectedTopic, StringComparison.OrdinalIgnoreCase)) { return false; }
    return true;
}
```
- å³æ™‚200å¿œç­”ï¼ˆ5ç§’è¦ä»¶å¯¾ç­–ï¼‰ã¨éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨
```104:115:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
// å³åº§ã«200 OKã‚’è¿”ã™ï¼ˆ5ç§’ãƒ«ãƒ¼ãƒ«ï¼‰
started.Stop();
_logger.LogInformation("app/uninstalled ... Result={Result} LatencyMs={Latency}", "accepted", started.ElapsedMilliseconds, ...);
return Ok();
```
- Webhookã‚¤ãƒ™ãƒ³ãƒˆã®å†ªç­‰åŒ–ã¨è¨˜éŒ²ï¼ˆIdempotencyKeyç”Ÿæˆãƒ»é‡è¤‡æŠ‘æ­¢ï¼‰
```836:886:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
private async Task LogWebhookEvent(string shopDomain, string topic, object payload)
{
    // ... çœç•¥ ...
    var idempotencyKey = GenerateWebhookIdempotencyKey(shopDomain, topic, serialized);
    var exists = await _context.WebhookEvents.AnyAsync(w => w.IdempotencyKey == idempotencyKey);
    if (exists) { /* æ—¢å­˜ */ return; }
    // WebhookEventsã«è¨˜éŒ²
    _context.Add(webhookEvent);
    await _context.SaveChangesAsync();
}
```
- Hangfireãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ã¨GDPR Pendingå‡¦ç†ã®å®šæœŸã‚¸ãƒ§ãƒ–ç™»éŒ²
```311:323:backend/ShopifyAnalyticsApi/Program.cs
app.UseHangfireDashboard("/hangfire", new Hangfire.DashboardOptions { /* èªå¯ç­‰ */ });
RecurringJob.AddOrUpdate<GdprProcessingJob>(
    "gdpr-process-pending",
    job => job.ProcessPendingRequests(),
    "*/5 * * * *");
```

### èª²é¡Œãƒ»ã‚®ãƒ£ãƒƒãƒ—ï¼ˆè¦ä¿®æ­£ï¼‰
- æœ¬ç•ªã®ã€Œå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã€ãŒä¸€éƒ¨TODOã®ã¾ã¾
```576:586:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
// é–‹ç™ºç’°å¢ƒã§ã¯å³åº§ã«å‰Šé™¤ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã¹ãï¼‰
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
}
else
{
    // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("æœ¬ç•ªç’°å¢ƒã§ã¯{Days}æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", daysToDelete, shopDomain);
}
```
- ç›£æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ï¼ˆIdempotencyKeyï¼‰ã®DBå´æ‹…ä¿ãŒæœªç¢ºèªï¼ˆã‚³ãƒ¼ãƒ‰å´ã¯äº‹å‰Existsãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
- ä»•æ§˜æ›¸ã®ãƒ«ãƒ¼ãƒˆè¡¨è¨˜ã¨å®Ÿè£…ãƒ«ãƒ¼ãƒˆã®è»½å¾®ãªå·®ï¼ˆ`/api/webhooks/...` vs `/api/webhook/...`ï¼‰ã¯é‹ç”¨ä¸Šå•é¡Œãªã—ã ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆã¯è¦æ›´æ–°
- æœŸé™ç®¡ç†ï¼ˆ30æ—¥/90æ—¥/10æ—¥ï¼‰ã¨é€šçŸ¥ãƒ»è¨¼è·¡ã®è‡ªå‹•åŒ–ãƒ¬ãƒ™ãƒ«ã¯è¦ç‚¹æ¤œï¼ˆå®Ÿè£…è¨ˆç”»æ›¸ã®SLAæº–æ‹ ï¼‰

### å½“åˆè¨­è¨ˆãƒ»è¨ˆç”»ã®å¦¥å½“æ€§ï¼ˆè¦ç‚¹ï¼‰
- è¨­è¨ˆæ–¹é‡ï¼ˆå³æ™‚200å¿œç­”ï¼‹éåŒæœŸã€HMACå›ºå®šæ™‚é–“æ¯”è¼ƒã€å†ªç­‰åŒ–ã€ç›£æŸ»ãƒ­ã‚°ã€Hangfireå‡¦ç†ï¼‰ã¯Shopify/GDPRè¦ä»¶ã«é©åˆã€‚å•é¡Œãªã—
- ä»•æ§˜æ›¸ã®DBã‚¹ã‚­ãƒ¼ãƒï¼ˆGDPRRequestsãƒ»RetentionPoliciesç­‰ï¼‰ã¯è¨ˆç”»ã«å¦¥å½“ã€‚å®Ÿè£…ãŒæœªé©ç”¨ã®å ´åˆã¯é©ç”¨æ¨å¥¨
- é‹ç”¨ï¼ˆç›£è¦–/ã‚¢ãƒ©ãƒ¼ãƒˆ/KPIï¼‰ã¯ä»•æ§˜æ›¸é€šã‚Šã§å¦¥å½“ã€‚App Insightsé€£æºã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹å¯è¦–åŒ–ã‚’å®Ÿæ¸¬ã§ç¢ºèªæ¨å¥¨

### ä»Šå¾Œã®ä½œæ¥­ï¼ˆå„ªå…ˆåº¦é †ï¼‰
1) æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Ÿè£…å®Œäº†
- å¯¾è±¡: `ScheduleDataDeletion`/`ScheduleCustomerDataDeletion`/`ScheduleShopDataDeletion` ã®ã€ŒTODOã€ã‚’Hangfireã‚¸ãƒ§ãƒ–ç™»éŒ²ã«ç½®æ›
- æœŸé™å€¤ï¼ˆ48h/30d/90dï¼‰ã‚’ã‚¸ãƒ§ãƒ–å¼•æ•°ã«ä»˜ä¸ã—ã€`GdprProcessingJob`å´ã§æœŸé™ãƒ»çŠ¶æ…‹é·ç§»ã‚’ç®¡ç†

2) ç›£æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€æ„åˆ¶ç´„è¿½åŠ 
- `WebhookEvents.IdempotencyKey` ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä»˜ä¸ï¼ˆç«¶åˆæ™‚ã‚‚DBã§ä¸€æ„æ€§æ‹…ä¿ï¼‰

3) E2Eæ¤œè¨¼ï¼ˆStagingï¼‰
- 4ç¨®Webhookã®HMACæˆåŠŸ/å¤±æ•—ã€é‡è¤‡é…ä¿¡ã€é †ä¸åŒã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¸Šé™ã€5ç§’å¿œç­”ã®å®Ÿæ¸¬è¨¼è·¡ï¼ˆãƒ­ã‚°/å‹•ç”»/ã‚¹ã‚¯ã‚·ãƒ§ï¼‰
- `app/uninstalled`ã§ã‚µãƒ–ã‚¹ã‚¯å–æ¶ˆï¼‹å‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ãŒç¢ºå®Ÿã«æ®‹ã‚‹ã“ã¨

4) æœŸé™SLAã®è‡ªå‹•åŒ–
- GDPRRequestsï¼ˆpendingâ†’processingâ†’completedï¼‰ã¨æœŸé™è¶…éæ¤œçŸ¥ãƒ»é€šçŸ¥ã‚’Hangfireã§å®šæœŸè©•ä¾¡
- æœŸé™å‰ã‚¢ãƒ©ãƒ¼ãƒˆ/è¶…éã‚¢ãƒ©ãƒ¼ãƒˆã‚’App Insights/Slackç­‰ã«é€£æº

5) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆã¨é‹ç”¨æ‰‹é †
- ä»•æ§˜æ›¸ã®ãƒ«ãƒ¼ãƒˆè¡¨è¨˜æ›´æ–°ï¼ˆwebhook(s)ã®çµ±ä¸€ï¼‰
- ãƒ†ã‚¹ãƒˆæ‰‹é †ã®æœ€æ–°åŒ–ï¼ˆ.http / curlä¾‹ã€HMACè¨ˆç®—æ‰‹é †ã€AI/KQLã‚¯ã‚¨ãƒªï¼‰

6) PIIãƒ­ã‚°ã‚¬ãƒ¼ãƒ‰
- ç›£æŸ»ãƒ­ã‚°ã«å€‹äººæƒ…å ±ã‚’å‡ºã•ãªã„ã“ã¨ã®å†ç‚¹æ¤œï¼ˆç¾çŠ¶LogInformationã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€Email/ä½æ‰€ç­‰ã¯å«ã‚ãªã„ï¼‰

å¿…è¦ãŒã‚ã‚Œã°ã€ä¸Šè¨˜(1)(2)ã®å…·ä½“ã‚³ãƒ¼ãƒ‰å·®åˆ†æ¡ˆã‚‚æç¤ºã—ã¾ã™ï¼ˆHangfireç™»éŒ²ç®‡æ‰€ãƒ»ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹DDLï¼‰ã€‚


# è¿½è¨˜ï¼ˆé€²ã‚æ–¹ï¼‰ - 2025-10-06 13:46:38 JST

## ã‚´ãƒ¼ãƒ«ï¼ˆå®Œäº†æ¡ä»¶ï¼‰
- 4ç¨®Webhookã®Staging E2Eè¨¼è·¡ï¼ˆHMACæˆåŠŸ/å¤±æ•—ã€é‡è¤‡ã€é †ä¸åŒã€5ç§’å¿œç­”ã€ã‚µã‚¤ã‚ºä¸Šé™ï¼‰ãŒæƒã£ã¦ã„ã‚‹
- æœ¬ç•ªç”¨å‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ48h/30d/90dï¼‰ãŒHangfireã§é‹ç”¨åŒ–æ¸ˆã¿ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ‰‹é †å«ã‚€ï¼‰
- `WebhookEvents.IdempotencyKey` ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä»˜ä¸æ¸ˆã¿
- ä»•æ§˜æ›¸/æ‰‹é †æ›¸ã‚’ç¾è¡Œå®Ÿè£…ã«æ•´åˆï¼ˆãƒ«ãƒ¼ãƒˆè¡¨è¨˜ã€.httpã€KQLã€é‹ç”¨ã‚¬ã‚¤ãƒ‰ï¼‰

## å®Ÿè¡Œé †åºï¼ˆMVPæœ€çŸ­ï¼‰
1. æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Ÿè£…å®Œäº†ï¼ˆHangfireã‚¸ãƒ§ãƒ–å®Ÿè£…/ç™»éŒ²ï¼‰
2. DBãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆIdempotencyKeyï¼‰
3. Staging E2Eæ¤œè¨¼ï¼ˆ.http + å®Ÿé‹ç”¨ãƒ­ã‚°å–å¾—ï¼‰
4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ›´æ–°ï¼ˆä»•æ§˜/æ‰‹é †/ç›£è¦–ï¼‰

## ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆæ‹…å½“/æ‰€è¦ç›®å®‰ï¼‰
- T1: Hangfireã‚¸ãƒ§ãƒ–å®Ÿè£…ï¼ˆå‰Šé™¤/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ï¼»Takashiï½œ0.5dï¼½
- T2: ã‚¸ãƒ§ãƒ–ç™»éŒ²ãƒ•ãƒ­ãƒ¼ï¼ˆProgram.cs or å°‚ç”¨ç™»éŒ²ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ï¼»Takashiï½œ0.25dï¼½
- T3: ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹DDLé©ç”¨ï¼ˆStgâ†’Prodè¨ˆç”»å«ã‚€ï¼‰ï¼»Takashiï½œ0.25dï¼½
- T4: E2Eæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•´å‚™ï¼ˆ.http, curl, HMACè¨ˆç®—ï¼‰ï¼»Kenjiï½œ0.25dï¼½
- T5: æ¤œè¨¼å®Ÿæ–½ã¨è¨¼è·¡æ¡å–ï¼ˆãƒ­ã‚°/å‹•ç”»/ã‚¹ã‚¯ã‚·ãƒ§ï¼‰ï¼»å…¨å“¡ï½œ0.5dï¼½
- T6: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆä»•æ§˜/æ‰‹é †/ç›£è¦–/KQLï¼‰ï¼»Kenjiï½œ0.25dï¼½

## ãƒ†ã‚¹ãƒˆè¨ˆç”»ï¼ˆStagingï¼‰
- æ­£å¸¸ç³»: 4ç¨®Webhookã«å¯¾ã—200/5ç§’ä»¥å†…ã€å±¥æ­´è¨˜éŒ²ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²
- ã‚¨ãƒ©ãƒ¼ç³»: ä¸æ­£HMAC/æœªè¨±å¯ãƒˆãƒ”ãƒƒã‚¯/ãƒ˜ãƒƒãƒ€ä¸è¶³/ã‚µã‚¤ã‚ºè¶…é
- å†ªç­‰: åŒä¸€WebhookId/created_atã§é‡è¤‡é€ä¿¡â†’é‡è¤‡è¨˜éŒ²ãªã—
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°: ç™»éŒ²â†’æœŸé™åˆ°æ¥å‰å¾Œã®çŠ¶æ…‹é·ç§»ã‚’ç¢ºèª

## è¨¼è·¡ã®å–ã‚Šæ–¹
- Application Insightsï¼ˆã‚¯ã‚¨ãƒªãƒ†ãƒ³ãƒ—ãƒ¬/KQLï¼‰
- Hangfireãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚¸ãƒ§ãƒ–å±¥æ­´ã‚¹ã‚¯ã‚·ãƒ§
- Web APIãƒ­ã‚°ï¼ˆç›¸é–¢ID/RequestIdã‚’å«ã‚€é€£é–ç¢ºèªï¼‰
- .http å®Ÿè¡Œå±¥æ­´ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœªå®Ÿè¡Œ: ã‚¸ãƒ§ãƒ–ã®ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ /å†å®Ÿè¡Œæ‰‹é †ã‚’RunbookåŒ–
- PIIæ··å…¥: ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã®å†ç‚¹æ¤œï¼ˆãƒ¡ãƒ¼ãƒ«/ä½æ‰€ç­‰ã¯å‡ºåŠ›ç¦æ­¢ï¼‰
- æ™‚é–“è¦ä»¶é€¸è„±: å¿œç­”ã‚’å…ˆã«è¿”ã—ã€éåŒæœŸå‡¦ç†ã«å¾¹åº•åˆ†é›¢


# è¿½è¨˜ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã¨ã®æ•´åˆæ€§ç¢ºèªï¼‰ - 2025-10-06 12:52 JST

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã®ç›¸é•ç¢ºèª

### å®Ÿè£…çŠ¶æ³ã®èªè­˜ç›¸é•
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆPM-001ï½004ï¼‰ã‚’ç²¾æŸ»ã—ãŸçµæœã€ä»¥ä¸‹ã®é‡è¦ãªèªè­˜ç›¸é•ã‚’ç™ºè¦‹ï¼š

| é …ç›® | PMæ–‡æ›¸ã®èªè­˜ | å®Ÿéš›ã®çŠ¶æ³ | ã‚®ãƒ£ãƒƒãƒ— |
|------|------------|-----------|---------|
| GDPR Webhookå®Ÿè£… | ğŸ”´ æœªç€æ‰‹ï¼ˆFR-007ï¼‰ | âœ… åŸºæœ¬å®Ÿè£…å®Œäº† | èªè­˜æ›´æ–°å¿…è¦ |
| HMACæ¤œè¨¼ | æœªå®Ÿè£…æ‰±ã„ | âœ… å®Ÿè£…æ¸ˆã¿ | - |
| å³æ™‚200å¿œç­” | æœªå®Ÿè£…æ‰±ã„ | âœ… å®Ÿè£…æ¸ˆã¿ | - |
| å†ªç­‰åŒ–å‡¦ç† | æœªå®Ÿè£…æ‰±ã„ | âœ… å®Ÿè£…æ¸ˆã¿ | - |
| Hangfireçµ±åˆ | æœªå®Ÿè£…æ‰±ã„ | âœ… å®Ÿè£…æ¸ˆã¿ | - |
| æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | - | ğŸŸ¡ TODOæ®‹å­˜ | æ­£ã—ãèªè­˜å¿…è¦ |

### ç”³è«‹ã«å‘ã‘ãŸçœŸã®å„ªå…ˆäº‹é …

#### ğŸ”´ æœ€å„ªå…ˆï¼ˆç”³è«‹ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
1. **æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Œäº†**
   - å¯¾è±¡: `WebhookController.cs:576-586`ã®TODOéƒ¨åˆ†
   - Hangfireã‚¸ãƒ§ãƒ–ç™»éŒ²ã®å®Ÿè£…
   - è¦‹ç©: 0.5æ—¥ï¼ˆTakashiï¼‰
   - **ç”³è«‹å´ä¸‹ãƒªã‚¹ã‚¯**: é«˜

2. **ç’°å¢ƒå¤‰æ•°è¨­å®š**
   - `SHOPIFY_FRONTEND_BASEURL`ã®è¨­å®š
   - Azure App Serviceã§ã®è¨­å®šç¢ºèª
   - è¦‹ç©: 30åˆ†ï¼ˆKenjiï¼‰
   - **ç”³è«‹å´ä¸‹ãƒªã‚¹ã‚¯**: ä¸­ï¼ˆOAuthå‹•ä½œä¸è‰¯ï¼‰

3. **E2Eæ¤œè¨¼ã®å®Ÿæ–½**
   - Stagingç’°å¢ƒã§ã®4ç¨®Webhookå‹•ä½œç¢ºèª
   - è¨¼è·¡æ¡å–ï¼ˆãƒ­ã‚°ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰
   - è¦‹ç©: 0.5æ—¥ï¼ˆå…¨å“¡ï¼‰
   - **ç”³è«‹å´ä¸‹ãƒªã‚¹ã‚¯**: ä¸­ï¼ˆæœªæ¤œè¨¼ã§ã®ä¸å…·åˆï¼‰

#### ğŸŸ¡ ç”³è«‹å‰æ¨å¥¨
4. **DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ **
   - `WebhookEvents.IdempotencyKey`
   - è¦‹ç©: 0.25æ—¥ï¼ˆTakashiï¼‰
   - **ç”³è«‹å´ä¸‹ãƒªã‚¹ã‚¯**: ä½ï¼ˆã‚³ãƒ¼ãƒ‰å´ã§å¯¾å¿œæ¸ˆã¿ï¼‰

5. **ç”³è«‹ç´ ææº–å‚™**
   - ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ1024x1024pxï¼‰ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€èª¬æ˜æ–‡
   - è¦‹ç©: 1-2æ—¥
   - **ç”³è«‹å´ä¸‹ãƒªã‚¹ã‚¯**: é«˜ï¼ˆç´ æä¸è¶³ã¯å³å´ä¸‹ï¼‰

### å®Ÿè£…å®Œäº†åº¦ã®æ­£ç¢ºãªè©•ä¾¡

| ã‚«ãƒ†ã‚´ãƒª | å®Œäº†åº¦ | æ®‹ä½œæ¥­ |
|---------|--------|--------|
| **GDPRåŸºæœ¬å®Ÿè£…** | 95% | æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®ã¿ |
| **èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | 100% | - |
| **èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ** | 90% | æœ€çµ‚ç¢ºèªã®ã¿ |
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | 80% | ãƒ¢ãƒƒã‚¯ç”»é¢ã®å®Ÿè£…åŒ– |
| **ãƒ†ã‚¹ãƒˆ** | 20% | E2Eæ¤œè¨¼å¿…é ˆ |
| **ç”³è«‹ç´ æ** | 0% | å…¨ã¦ä½œæˆå¿…è¦ |

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿®æ­£æ¡ˆ

```
2025-10-06ï¼ˆæœ¬æ—¥ï¼‰:
  - ç’°å¢ƒå¤‰æ•°è¨­å®š [30åˆ†]
  - æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å®Ÿè£…ç€æ‰‹ [é–‹å§‹]

2025-10-07:
  - æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å®Œäº† [åˆå‰]
  - DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ  [åˆå¾Œ]
  - E2Eæ¤œè¨¼æº–å‚™ [åˆå¾Œ]

2025-10-08:
  - E2Eæ¤œè¨¼å®Ÿæ–½ [å…¨æ—¥]
  - ç”³è«‹ç´ æä½œæˆé–‹å§‹ [ä¸¦è¡Œ]

2025-10-09:
  - æ¤œè¨¼çµæœç¢ºèªãƒ»ä¿®æ­£
  - ç”³è«‹ç´ æå®Œæˆ

2025-10-10:
  - æœ€çµ‚ç¢ºèª
  - Shopifyç”³è«‹æå‡º
```

### çµè«–
**GDPRå¯¾å¿œã¯æƒ³å®šä»¥ä¸Šã«é€²ã‚“ã§ãŠã‚Šã€ç”³è«‹ã¯ç¾å®Ÿçš„ã«å¯èƒ½**ã€‚ãŸã ã—ï¼š
1. æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¯å¿…é ˆå®Ÿè£…ï¼ˆ0.5æ—¥ã§å®Œäº†å¯èƒ½ï¼‰
2. E2Eæ¤œè¨¼ã¯çœç•¥ä¸å¯ï¼ˆè¨¼è·¡å¿…é ˆï¼‰
3. ç”³è«‹ç´ ææº–å‚™ã‚’ä¸¦è¡Œã§é€²ã‚ã‚‹å¿…è¦ã‚ã‚Š

PMæ–‡æ›¸ã¨ã®èªè­˜ã‚®ãƒ£ãƒƒãƒ—ã‚’è§£æ¶ˆã—ã€çœŸã®æ®‹ã‚¿ã‚¹ã‚¯ã«é›†ä¸­ã™ã‚‹ã“ã¨ã§ã€**ä»Šé€±ä¸­ã®ç”³è«‹æå‡ºãŒå¯èƒ½**ã€‚


# è¿½è¨˜ï¼ˆæ®‹ä½œæ¥­è©³ç´°ï¼šã‚½ãƒ¼ã‚¹ç¢ºèªãƒ™ãƒ¼ã‚¹ï¼‰ - 2025-10-06 13:56:27 JST

## 1) æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Ÿè£…ï¼ˆå¿…é ˆï¼‰
- ç¾çŠ¶: Webhookå´ã¯ã€Œé–‹ç™ºç’°å¢ƒã¯å³æ™‚å‰Šé™¤ã€æœ¬ç•ªã¯TODOã§ãƒ­ã‚°ã®ã¿ã€
```576:586:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
// é–‹ç™ºç’°å¢ƒã§ã¯å³åº§ã«å‰Šé™¤ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã¹ãï¼‰
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
}
else
{
    // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("æœ¬ç•ªç’°å¢ƒã§ã¯{Days}æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", daysToDelete, shopDomain);
}
```
- å®Ÿæ–½å†…å®¹:
  - Hangfireã§ã€Œé…å»¶ã‚¸ãƒ§ãƒ–ã€ç™»éŒ²ï¼ˆShop/Customer/Shopå…¨ä½“ã®3ç¨®ï¼‰
  - `GdprProcessingJob`ã¯pendingå‡¦ç†ã‚’å®Ÿè£…æ¸ˆã¿ï¼ˆ*/5åˆ†ï¼‰ã€‚æœ¬ä»¶ã¯ã€ŒæœŸé™ä»˜ãå˜ç™ºã‚¸ãƒ§ãƒ–ã€ã‚’è¿½åŠ 
  - ç›®å®‰: 0.5æ—¥ï¼ˆTakashiï¼‰

## 2) WebhookEvents.IdempotencyKey ã®DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ 
- ç¾çŠ¶: ã‚¢ãƒ—ãƒªå´ã§Existsãƒã‚§ãƒƒã‚¯ã¯å®Ÿè£…æ¸ˆã¿ã€DBå´ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªç¢ºèª
```836:856:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
var idempotencyKey = GenerateWebhookIdempotencyKey(shopDomain, topic, serialized);
var exists = await _context.WebhookEvents.AnyAsync(w => w.IdempotencyKey == idempotencyKey);
if (exists) { /* æ—¢å­˜ */ return; }
```
- ç¢ºèªçµæœ: Migrationsé…ä¸‹ã«`IdempotencyKey`ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ã¯æ¤œå‡ºã•ã‚Œãš
- å®Ÿæ–½å†…å®¹: æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆStgâ†’Prodæ‰‹é †åŒ–ï¼‰

## 3) ç’°å¢ƒå¤‰æ•°/è¨­å®šã®ç¢ºèªï¼ˆWebhookSecret/Frontend URLï¼‰
- WebhookSecretå‚ç…§ç®‡æ‰€:
```445:451:backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs
var secret = _configuration["Shopify:WebhookSecret"]; // æœªè¨­å®šæ™‚ã¯æ¤œè¨¼NG
```
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¾çŠ¶ï¼ˆä¾‹ï¼‰:
```69:72:backend/ShopifyAnalyticsApi/appsettings.Staging.json
"WebhookSecret": "your_staging_webhook_secret",
```
- å®Ÿæ–½å†…å®¹: Staging/Productionã®å®Ÿå€¤æŠ•å…¥ã€Azure App Service æ§‹æˆç¢ºèª

## 4) GDPRService/å‰Šé™¤ã‚µãƒ¼ãƒ“ã‚¹ã®å¦¥å½“æ€§ç¢ºèª
- å®Ÿè£…æ¸ˆ: `IGDPRService`, `GDPRService`, `IDataCleanupService`, `DataCleanupService`
- é‡è¦ãƒ­ã‚¸ãƒƒã‚¯:
```200:227:backend/ShopifyAnalyticsApi/Services/GDPRService.cs
// é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆâ†’ä¿å­˜â†’å®Œäº†
```
```262:286:backend/ShopifyAnalyticsApi/Services/GDPRService.cs
// é¡§å®¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã¨å‰Šé™¤ãƒ­ã‚°è¨˜éŒ²
```
```314:325:backend/ShopifyAnalyticsApi/Services/GDPRService.cs
// ã‚·ãƒ§ãƒƒãƒ—å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã¨å‰Šé™¤ãƒ­ã‚°è¨˜éŒ²
```
- å®Ÿæ–½å†…å®¹: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿é‡ã‚’æƒ³å®šã—ãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³/ä¾‹å¤–æ™‚ãƒªãƒˆãƒ©ã‚¤ã®æœ€çµ‚ç‚¹æ¤œ

## 5) E2Eæ¤œè¨¼ã®è¨¼è·¡ä½œæˆ
- 4ç¨®Webhookã®HMACæˆåŠŸ/å¤±æ•—ã€é‡è¤‡ã€é †ä¸åŒã€5ç§’å¿œç­”ã€ã‚µã‚¤ã‚ºä¸Šé™
- å–å¾—æ‰‹æ®µ: .httpå®Ÿè¡Œçµæœä¿å­˜ã€Application Insightsã‚¯ã‚¨ãƒªã€Hangfireãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å±¥æ­´

## 6) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆ
- ä»•æ§˜ã®ãƒ«ãƒ¼ãƒˆè¡¨è¨˜å·®ç•°ï¼ˆ`/api/webhooks/...` vs `/api/webhook/...`ï¼‰ã®æ˜ç¤º
- KQL/ãƒ†ã‚¹ãƒˆæ‰‹é †ã®æœ€æ–°ç‰ˆåæ˜ 

## å®Ÿæ–½å„ªå…ˆåº¦
1. æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å®Ÿè£…ï¼ˆé…å»¶ã‚¸ãƒ§ãƒ–ï¼‰
2. IdempotencyKeyãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ 
3. ç’°å¢ƒå¤‰æ•°æœ€çµ‚åŒ–ï¼ˆWebhookSecret/Frontend URLï¼‰
4. E2Eæ¤œè¨¼ï¼‹è¨¼è·¡
5. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆ

