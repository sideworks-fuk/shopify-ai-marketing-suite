# MVP課金仕様書（顧客数ベース／通知とグレースフル制限）

- 作成日: 2025-09-17
- 作成者: Kenji（AI PM）＋ 福田
- 対象: EC Ranger（Shopify App）
- 目的: from_ono_20250917.md の要望をMVPとして実装可能な形に落とし込む

---

## 1. プラン定義（MVP）
- 無料（Free）: 休眠顧客分析のみ（顧客数制限なし）
- Basic: 顧客3,000件まで（$50）
- Professional: 顧客10,000件まで（$150）
- Enterprise: 顧客50,000件まで（$300）
- 全プラン: 30日トライアル

補足:
- Shopify Billingのサブスクリプションを使用（作成/更新/キャンセルはWebhookで同期）

---

## 2. 決定事項（MVPの選択）

1) 顧客数の定義（MVP）
- 定義: 「アプリDBにスナップショットされた顧客総数（Customersテーブル等の件数）」
- 取得: 日次ジョブでShopifyから総数を取得・反映（初期はDB件数を使用、取得失敗時は前回値）
- 目的: 実装を単純化しつつ、審査・運用に耐える整合性を確保

2) 判定タイミング（MVP）
- 日次判定（UTC 00:30想定）で超過フラグ更新
- 請求更新日当日のみ「ダウングレード提案」フラグを付与（BillingのCurrentPeriodEnd準拠）

3) 通知チャネル（MVP）
- アプリ内のみ（バナー/モーダル/トースト）。メールは後日拡張

4) 無料化時のデータ扱い（MVP）
- 原則保持＋アクセス制限（GDPR要請時/明示同意時のみ削除）
- 無料化・解約時には不可逆性・制限内容をモーダルで明示

---

## 3. 通知・制限仕様（要望ケース対応）

- ケース1: トライアル終了7日前・3日前アラート
  - 仕様: `trialEndsAt` 基準でD-7/D-3にアプリ内バナー表示
  - 表示例: 「トライアル終了まで残り7日です」

- ケース2: 顧客数超過時のアップグレード促し＋新規分の反映停止
  - 仕様: 日次判定で超過→「アップグレードが必要」バナー＋対象機能でグレースフル制限
  - 制限例: 最新の顧客（超過分）は分析集計に含めない（閲覧は可、集計・新規分析反映は不可）

- ケース3: ダウングレード提案（契約更新日）
  - 仕様: 請求更新日当日に「一つ下のプランが適用可能」提案バナー
  - 自動ダウン/アップグレードは行わない（同意ベース）

- ケース4: 無料版へのダウン
  - 仕様: 確認モーダルで注意喚起（データは保持、アクセスが制限される旨）

- ケース5: 解約
  - 仕様: 確認モーダルで注意喚起（以後の閲覧不可）。データ保持方針は上記に準拠

---

## 4. 実装構成（MVP）

### Backend（Takashi）
- Subscription/Webhooks
  - app_subscriptions/update, .../cancelled, app/uninstalled の処理最終化（冪等・署名検証・監査ログ）
- 顧客数スナップショットジョブ
  - 毎日UTC 00:30実行でShopify顧客数取得→`CustomerCountSnapshots(StoreId, Count, CapturedAt)`
  - `Stores`に`CurrentCustomerCount`キャッシュ更新
- 制限判定
  - `PlanLimitRules`: Free/3k/10k/50k
  - `Stores.PlanStatus`: within_limit / over_limit / trialing / trial_ending_7 / trial_ending_3
- 機能制御ミドルウェア
  - 超過時: 分析集計の新規反映を抑止（最新N件除外のフィルタ適用）
  - 無料プラン: 対象外機能に403 + upgradeUrl
- 通知状態API
  - `GET /api/billing/notifications` → バナー表示用のフラグ群を返却

### Frontend（Yuki）
- バナー/モーダル
  - トライアル終了、超過、ダウングレ提案、無料化/解約確認
- 課金UI
  - プラン表示／アップグレード導線／状態反映
- 制限ガード
  - 403/409時の理由表示＋Upgrade導線
- 設定
  - API URL統一、認証チェック、モック外し

---

## 5. 必要なDB/モデル（最小）
- `CustomerCountSnapshots(Id, StoreId, Count, CapturedAt)`
- `Stores(CurrentCustomerCount, CurrentPlan, TrialEndsAt, CurrentPeriodEnd, PlanStatus)`
- 監査/ログ: 既存の`WebhookEvents`, `BillingHistory`を流用

---

## 6. API（サンプル）
- `GET /api/billing/notifications` → { trialDaysLeft, overLimit, suggestDowngrade, messages[] }
- `GET /api/billing/current` → 現在のプラン/試用状況/顧客数
- `POST /api/billing/upgrade` → アップグレード（Shopify承認URLに遷移）

---

## 7. 検証項目（MVP）
- トライアル終了7/3日の表示タイミング
- 超過時の集計結果から最新超過分が除外されること
- ダウングレード提案が請求日当日のみ表示されること
- 無料化/解約時の確認モーダルと権限制御

---

## 8. 将来拡張（非MVP）
- メール通知（SendGrid等）
- 自動提案に対する1クリック同意フロー
- 顧客数の定義高度化（アクティブ顧客、期間平均等）

---

## 9. リスク/補足
- 顧客数のソースはMVPでDBスナップショットとするため、Shopify実数と一時乖離する可能性（翌日解消）。
- 自動アップ/ダウンは実装しない（審査・信頼性観点）。

---

## 10. 顧客要件（from_ono_20250917）との対応状況

- 料金プラン4種＋30日トライアル: 対応（MVP）
- トライアル終了7日前・3日前アラート: 対応（MVP・アプリ内通知）
- 顧客数超過時のアップグレード促し: 対応（MVP）
  - 超過時は「最新登録の顧客（超過分）を分析集計に反映しない」グレースフル制限
- ダウングレード提案（契約更新日）: 対応（MVP・自動変更しない／提案のみ）
- 無償版へのダウン時のデータ扱い: 要件との差異あり
  - 要件: データ削除の強い注意喚起
  - MVP: データ保持＋アクセス制限（削除は明示同意時/GDPR要請時のみ）
- 解約時の最終確認と注意喚起: 対応（MVP・確認モーダル）
- 自動アップ/ダウングレード: 非対応（ポリシー/信頼性観点で不採用）

---

## 11. 未充足/保留（今後の拡張候補）

- メール通知（トライアル終了/超過/提案）: 保留（将来拡張）
- 顧客数定義の高度化（アクティブ顧客、期間平均、重み付け）: 保留
- 請求サイクルの厳密同期（CurrentPeriodEndのE2E検証/表示）: 要E2E確認
- ワンクリック同意フロー（プラン変更のUX改善）: 保留
- 無料化に伴う自動データ削除: 非推奨（法務/規約観点。明示同意でのみ実行）

---

## 12. 仕様上の注意事項（関係者向け）

- 顧客数カウントはDBスナップショットのため、最大24hの乖離が生じ得る（翌日解消）。
- 超過時の制限は「集計からの最新超過分除外」であり、データ自体は保持（閲覧は可能な場合あり）。
- 通知はMVPではアプリ内のみ。メール未実装のため見落としリスクがある。
- 自動プラン変更は行わない。ユーザー同意を必須とし、Shopify審査/信頼性に配慮。
- Billing/Webhookに依存（update/cancelled/uninstalled）。遅延/重複に対する冪等性を実装。
- スケジューラ（Hangfire）は本番でAlways On等の稼働確保設定が必要。
- 再インストール時のトライアルはShopify規約準拠（原則再付与不可）。
- GDPR: Data Request/Redactは48時間内の確実対応。データ削除は監査ログに記録。

---

## 13. 合意と次ステップ

- 本MVP仕様で実装を進め、メール通知/顧客数定義高度化は次フェーズ提案。
- ステークホルダー合意後、Takashi/Yukiに着手指示（該当会話ファイルに記録）。
