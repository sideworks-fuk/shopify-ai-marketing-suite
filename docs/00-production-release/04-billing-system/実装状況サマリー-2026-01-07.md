# 課金システム実装状況サマリー

**作成日**: 2026-01-07  
**作成者**: AI Assistant  
**目的**: 課金システムの実装状況を整理し、テスト準備のための現状把握

---

## 📊 実装状況概要

### 全体完成度: **85%**

| カテゴリ | 完成度 | 実装済み | 未実装 |
|---------|--------|---------|--------|
| **バックエンドAPI** | 90% | ✅ 基本機能 | ⏳ 一部エッジケース |
| **フロントエンドUI** | 75% | ✅ 基本画面 | ⏳ 使用量ダッシュボード |
| **データベース** | 90% | ✅ テーブル実装 | ⏳ 一部テーブル |
| **Webhook処理** | 85% | ✅ 基本処理 | ⏳ エラーハンドリング強化 |
| **機能制限システム** | 80% | ✅ 基本実装 | ⏳ 使用量制限 |
| **テスト** | 60% | ✅ 単体テスト | ⏳ 統合/E2Eテスト |

---

## ✅ 実装済み機能

### 1. バックエンドAPI

#### コントローラー
- ✅ **BillingController.cs**
  - `GET /api/billing/plans` - プラン一覧取得
  - `GET /api/billing/current` - 現在のサブスクリプション取得
  - `GET /api/billing/info` - 課金情報詳細取得
  - `POST /api/billing/subscribe` - サブスクリプション作成
  - `POST /api/billing/cancel` - サブスクリプションキャンセル
  - `POST /api/billing/change-plan` - プラン変更
  - `POST /api/billing/start-trial` - トライアル開始

- ✅ **SubscriptionController.cs**
  - `GET /api/subscription/status` - サブスクリプション状態取得
  - `GET /api/subscription/plans` - プラン一覧取得
  - `POST /api/subscription/create` - サブスクリプション作成
  - `GET /api/subscription/confirm` - サブスクリプション確認（コールバック）
  - `POST /api/subscription/cancel` - サブスクリプションキャンセル
  - `GET /api/subscription/history` - サブスクリプション履歴取得
  - `POST /api/subscription/change-plan` - プラン変更

- ✅ **FeatureSelectionController.cs**
  - `GET /api/feature-selection/current` - 現在の機能選択取得
  - `POST /api/feature-selection/select` - 機能選択/変更

#### サービス
- ✅ **ShopifySubscriptionService.cs**
  - `CreateSubscription()` - Shopify GraphQL API統合
  - `ConfirmSubscription()` - サブスクリプション確認
  - `CancelSubscription()` - サブスクリプションキャンセル
  - `ChangePlan()` - プラン変更
  - `CheckTrialExpirations()` - トライアル期限チェック
  - `UpdateSubscriptionStatus()` - サブスクリプション状態更新

#### Webhook処理
- ✅ **WebhookController.cs**
  - `app_subscriptions/update` - サブスクリプション更新Webhook
  - `app_subscriptions/cancel` - サブスクリプションキャンセルWebhook
  - HMAC署名検証実装済み
  - 冪等性処理実装済み（IdempotencyKey）

#### ミドルウェア
- ✅ **FeatureAccessMiddleware.cs**
  - 機能アクセス制御
  - プラン別アクセス制限
  - 無料プラン機能選択チェック

---

### 2. フロントエンドUI

#### コンポーネント
- ✅ **SubscriptionContext.tsx**
  - サブスクリプション状態管理
  - プラン情報管理
  - トライアル状態管理

- ✅ **useFeatureAccess.ts**
  - 機能アクセス制御フック
  - プラン別機能判定
  - 使用量制限チェック

- ✅ **billing/page.tsx**
  - 課金管理画面
  - プラン選択UI
  - プラン比較表
  - トライアルバナー

- ✅ **FeatureLockedScreen.tsx**
  - 機能ロック画面
  - アップグレード誘導

- ✅ **UpgradePrompt.tsx**
  - アップグレード促進コンポーネント

---

### 3. データベース

#### テーブル
- ✅ **SubscriptionPlans**
  - プラン情報（ID、名前、価格、機能、トライアル日数）

- ✅ **StoreSubscriptions**
  - ストア別サブスクリプション情報
  - 状態管理（pending、active、trialing、cancelled）
  - Shopify Charge ID連携

- ✅ **FeatureLimits**
  - プラン別機能制限マスタ

- ✅ **UserFeatureSelections**
  - 無料プラン機能選択情報
  - 30日制限管理

- ✅ **FeatureUsageLogs**
  - 機能使用ログ

- ✅ **WebhookEvents**
  - Webhook受信履歴
  - 冪等性管理

---

### 4. Shopify API統合

- ✅ **GraphQL API 2024-01対応**
  - `appSubscriptionCreate` mutation
  - `appSubscriptionCancel` mutation
  - `appSubscriptionUpdate` mutation
  - `currentAppInstallation` query

- ✅ **テストモード対応**
  - `test: true` フラグによるテストモード実装

- ✅ **Rate Limit対策**
  - 指数バックオフ実装
  - Retry-After ヘッダー対応

---

## ⏳ 未実装・部分実装機能

### 1. バックエンド

#### 未実装機能
- ❌ **顧客数ベースの使用量制限**
  - `CustomerCountSnapshots` テーブル未実装
  - 制限チェックロジック未実装

- ❌ **自動ダウングレード機能**
  - 使用量超過時の自動ダウングレード未実装

- ❌ **請求履歴管理**
  - `BillingHistory` テーブル未実装
  - 請求履歴API未実装

#### 部分実装機能
- ⚠️ **エラーハンドリング**
  - 基本エラーハンドリングは実装済み
  - 一部エッジケースの処理が不完全

- ⚠️ **トランザクション処理**
  - 基本トランザクションは実装済み
  - 一部複雑な処理でトランザクション範囲の見直しが必要

---

### 2. フロントエンド

#### 未実装機能
- ❌ **使用量ダッシュボード**
  - 使用量表示画面未実装
  - 使用量グラフ未実装

- ❌ **請求履歴表示**
  - 請求履歴一覧画面未実装
  - 請求書ダウンロード機能未実装

- ❌ **詳細な制限アラート表示**
  - 使用量接近時のアラート未実装
  - 制限超過時のアラート未実装

---

### 3. データベース

#### 未実装テーブル
- ❌ **CustomerCountSnapshots**
  - 顧客数履歴管理テーブル

- ❌ **PlanLimitRules**
  - プラン別制限ルールテーブル

- ❌ **BillingNotifications**
  - 通知管理テーブル

---

## 🔍 実装詳細

### APIエンドポイント一覧

#### 課金管理API
```
GET    /api/billing/plans              - プラン一覧取得
GET    /api/billing/current            - 現在のサブスクリプション取得
GET    /api/billing/info               - 課金情報詳細取得
POST   /api/billing/subscribe          - サブスクリプション作成
POST   /api/billing/cancel             - サブスクリプションキャンセル
POST   /api/billing/change-plan        - プラン変更
POST   /api/billing/start-trial        - トライアル開始
```

#### サブスクリプションAPI
```
GET    /api/subscription/status        - サブスクリプション状態取得
GET    /api/subscription/plans        - プラン一覧取得
POST   /api/subscription/create       - サブスクリプション作成
GET    /api/subscription/confirm      - サブスクリプション確認（コールバック）
POST   /api/subscription/cancel       - サブスクリプションキャンセル
GET    /api/subscription/history      - サブスクリプション履歴取得
POST   /api/subscription/change-plan  - プラン変更
```

#### 機能選択API
```
GET    /api/feature-selection/current  - 現在の機能選択取得
POST   /api/feature-selection/select  - 機能選択/変更
```

#### Webhook API
```
POST   /api/webhook/subscriptions-update  - サブスクリプション更新Webhook
POST   /api/webhook/subscriptions-cancel  - サブスクリプションキャンセルWebhook
```

---

### データベーススキーマ

#### SubscriptionPlans
```sql
Id              INT PRIMARY KEY
Name            NVARCHAR(50)
Price           DECIMAL(10,2)
CustomerLimit   INT NULL
Features        NVARCHAR(MAX)  -- JSON形式
TrialDays       INT DEFAULT 30
IsActive        BIT DEFAULT 1
CreatedAt       DATETIME2
UpdatedAt       DATETIME2
```

#### StoreSubscriptions
```sql
Id                  INT PRIMARY KEY
StoreId             INT FOREIGN KEY -> Stores.Id
PlanId              INT FOREIGN KEY -> SubscriptionPlans.Id
Status              NVARCHAR(20)  -- pending, active, trialing, cancelled
PlanName            NVARCHAR(100)
ShopifyChargeId     BIGINT NULL
TrialEndsAt         DATETIME2 NULL
CurrentPeriodEnd    DATETIME2 NULL
CancelledAt         DATETIME2 NULL
ActivatedAt         DATETIME2 NULL
CreatedAt           DATETIME2
UpdatedAt           DATETIME2
```

#### UserFeatureSelections
```sql
Id                      INT PRIMARY KEY
StoreId                 INT FOREIGN KEY -> Stores.Id
SelectedFeatureId       NVARCHAR(100)
LastChangeDate          DATETIME2
NextChangeAvailableDate DATETIME2
IsActive                BIT DEFAULT 1
CreatedAt               DATETIME2
UpdatedAt               DATETIME2
```

#### FeatureLimits
```sql
Id              INT PRIMARY KEY
PlanType        NVARCHAR(50)
FeatureId       NVARCHAR(100)
DailyLimit      INT NULL
MonthlyLimit    INT NULL
CreatedAt       DATETIME2
UpdatedAt       DATETIME2
```

---

## 🎯 テスト準備状況

### テスト環境
- ✅ 開発環境セットアップ完了
- ✅ テストストア準備可能
- ✅ Webhook受信環境準備可能（ngrok等）

### テストデータ
- ⚠️ プラン初期データ投入が必要
- ⚠️ テストストアデータ準備が必要

### テストツール
- ✅ Postmanコレクション準備可能
- ✅ curlコマンド準備可能
- ✅ ブラウザ開発者ツール準備可能

---

## 📋 次のアクション

### Critical（必須）
1. **プラン初期データ投入**
   - `SubscriptionPlans` テーブルに初期データ投入
   - 推定時間: 30分

2. **基本機能テスト実施**
   - プラン一覧取得テスト
   - サブスクリプション作成フローテスト
   - Webhook処理テスト
   - 推定時間: 7時間

### High Priority（推奨）
3. **機能制限システムテスト**
   - 無料プラン機能選択テスト
   - 機能アクセス制御テスト
   - 推定時間: 5時間

4. **本番環境テスト**
   - カスタムアプリでのE2Eテスト
   - 推定時間: 4時間

### Medium Priority（任意）
5. **エラーハンドリング強化**
   - エッジケース処理の追加
   - 推定時間: 2-3時間

6. **使用量ダッシュボード実装**
   - フロントエンド実装
   - 推定時間: 3-5日

---

## 🔗 関連ドキュメント

- [テストタスクリスト](./課金システムテストタスクリスト-2026-01-07.md)
- [実装状況レポート](./billing-implementation-status-2025-10-06.md)
- [テストガイド](./課金機能テストガイド.md)
- [0円テスト手順書](../../08-shopify/02-課金システム/04-理解と運用/課金0円テスト完全手順書.md)

---

**最終更新**: 2026-01-07  
**次回更新予定**: テスト実施後
