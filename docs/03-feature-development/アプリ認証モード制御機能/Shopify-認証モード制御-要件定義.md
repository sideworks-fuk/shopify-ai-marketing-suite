# Shopify アプリ認証モード制御機能 要件定義書

## プロジェクト概要

**プロジェクト名**: Shopify アプリ認証モード制御機能  
**作成日**: 2025年10月25日  
**作成者**: Kenji  
**ステータス**: 要件定義中  

---

## 🎯 プロジェクト目標

### 主要目標
環境別に認証方式を安全に切り替える「認証モード制御機能」を実装し、本番環境ではShopify OAuth認証を強制、検証・デモ環境では開発者パスワードによる限定的アクセスを許可する。

**重要**: すべての認証・認可判定はサーバー側で実施し、クライアント側の環境変数（`NEXT_PUBLIC_*`）はUI表示のヒントとしてのみ使用する。

### 成功基準
- 本番環境でのセキュリティ強化（OAuth認証強制、サーバー側環境チェック）
- ステージング環境でのデモリンク表示問題解決
- 開発環境での効率的なテスト・デバッグ
- 認証フローの明確化と運用性向上
- Shopify埋め込みアプリでの安定した認証（App Bridgeセッショントークン）
- デモモードでのデータ保護（グローバル読み取り専用ポリシー）

---

## 🚨 現状の問題

### 問題1: ステージング環境でのデモリンク表示問題
- **現象**: ステージング環境で「デモサイトを開く」リンクが表示されない
- **原因**: 環境変数 `NEXT_PUBLIC_ENVIRONMENT` の判定ロジックの問題
- **影響**: デモ・プレゼンテーション時のアクセス困難

### 問題2: 認証モードの不統一
- **現象**: 環境によって認証方式が混在
- **原因**: 統一された認証モード制御の不在
- **影響**: セキュリティリスク、運用の複雑化

### 問題3: デモモードの制限不足
- **現象**: デモモードでも本番データにアクセス可能
- **原因**: 適切なアクセス制限の実装不足
- **影響**: データ漏洩リスク

### 問題4: クライアント側環境変数によるセキュリティ制御
- **現象**: `NEXT_PUBLIC_AUTH_MODE` や `NEXT_PUBLIC_DEV_PASSWORD` などのクライアント側環境変数でセキュリティを制御
- **原因**: クライアントバンドルに含まれる環境変数は改ざん可能
- **影響**: 認証バイパスのリスク、セキュリティ脆弱性

### 問題5: Shopify埋め込みアプリでのCookie認証の問題
- **現象**: 3rdパーティCookie制限により認証が失敗する可能性
- **原因**: Cookieベースの認証実装
- **影響**: ユーザーの認証失敗、アプリの利用不可

---

## 👥 ステークホルダー

### 主要ユーザー
- **本番ユーザー**: Shopify OAuth認証でアプリを利用
- **検証担当者**: ステージング環境でOAuth認証をテスト
- **開発者**: デモモードでデータ確認・デバッグ
- **プレゼンテーション対象者**: デモモードでアプリ機能を確認

### 影響を受けるシステム
- フロントエンド認証システム
- バックエンドAPI認証
- Shopify OAuth認証フロー
- デモモード機能

---

## 📋 機能要件

### 1. 環境別認証モード制御

#### 1.1 本番環境（Production）
- **要件**: Shopify OAuth認証のみを許可
- **詳細**:
  - デモモード機能を完全に無効化
  - OAuth認証失敗時は認証画面にリダイレクト
  - セキュリティログの記録
  - **サーバー起動時チェック**: 環境が `Production` で認証モードが `OAuthRequired` 以外の場合、起動を失敗させる
  - **App Bridgeセッショントークン**: Cookieではなく、Shopify App Bridgeのセッショントークンを使用
- **優先度**: 高
- **受け入れ基準**:
  - デモモードへのアクセスが完全にブロックされる
  - OAuth認証以外の認証方法が使用できない
  - 認証失敗時の適切なエラーハンドリング
  - 本番環境で誤った認証モード設定の場合、サーバーが起動しない
  - Shopify埋め込みアプリで3rdパーティCookie制限の影響を受けない

#### 1.2 ステージング環境（Staging）
- **要件**: OAuth認証 + デモモードの両方を許可
- **詳細**:
  - 認証画面でOAuth認証ボタンとデモリンクを表示
  - デモモードでは制限された機能のみアクセス可能
  - 環境変数による制御
- **優先度**: 高
- **受け入れ基準**:
  - 認証画面でOAuth認証とデモリンクが両方表示される
  - デモモードで適切な機能制限が適用される
  - 環境変数による制御が正常に動作する

#### 1.3 開発環境（Development）
- **要件**: 全認証モードを許可
- **詳細**:
  - OAuth認証、デモモード、開発者ツールすべて利用可能
  - デバッグ機能の有効化
  - 詳細ログの出力
- **優先度**: 中
- **受け入れ基準**:
  - すべての認証モードが利用可能
  - デバッグ機能が正常に動作する
  - 詳細ログが適切に出力される

### 2. 認証画面の動的制御

#### 2.1 タイトル表示制御
- **要件**: 環境に応じてタイトルを変更
- **詳細**:
  - 本番環境: 「Shopify認証が必要です」
  - その他環境: 「認証が必要です」
- **優先度**: 中
- **受け入れ基準**:
  - 環境変数に応じてタイトルが正しく表示される
  - タイトル変更が即座に反映される

#### 2.2 ボタン表示制御
- **要件**: 環境に応じてボタンを動的に表示
- **詳細**:
  - 本番環境: OAuth認証ボタンのみ
  - ステージング環境: OAuth認証ボタン + デモリンク
  - 開発環境: 全ボタン表示
- **優先度**: 高
- **受け入れ基準**:
  - 環境に応じて適切なボタンが表示される
  - ボタンの表示/非表示が正しく制御される

#### 2.3 メッセージ表示制御
- **要件**: 環境に応じてメッセージを変更
- **詳細**:
  - 本番環境: Shopify特化メッセージ
  - その他環境: 汎用メッセージ
- **優先度**: 中
- **受け入れ基準**:
  - 環境に応じてメッセージが正しく表示される
  - メッセージの内容が適切である

### 3. デモモード機能制限

#### 3.1 アクセス制限
- **要件**: デモモードでの機能制限
- **詳細**:
  - データ閲覧のみ許可
  - データ変更・削除を禁止
  - **グローバル読み取り専用ポリシー**: デモモードクレームが存在する場合、すべての変更操作（POST/PUT/PATCH/DELETE）をデフォルトでブロック
  - 明示的に `[AllowDemoWrite]` 属性を付けたエンドポイントのみ許可（理想的にはゼロ）
  - クライアント側とサーバー側の両方で制限を実施（サーバー側が最終的な判定）
- **優先度**: 高
- **受け入れ基準**:
  - データ変更操作が実行できない
  - 適切なエラーメッセージが表示される
  - セキュリティログが記録される
  - クライアントが直接APIを呼び出してもサーバー側でブロックされる

#### 3.2 セッション管理
- **要件**: デモモードのセッション管理
- **詳細**:
  - セッション期限: 1時間
  - 自動ログアウト機能
  - 手動ログアウト機能
  - **分散セッションストレージ**: Redisまたはデータベーステーブルによるセッション管理（`IMemoryCache` は使用しない）
  - TTLと定期的なクリーンアップジョブ
  - スケールアウトやサーバー再起動に対応
- **優先度**: 高
- **受け入れ基準**:
  - セッション期限が正しく管理される
  - 自動ログアウトが正常に動作する
  - 手動ログアウトが正常に動作する
  - サーバー再起動後もセッションが維持される（または適切に失効する）
  - 複数サーバーインスタンス間でセッションが共有される

#### 3.3 バナー表示
- **要件**: デモモード時のバナー表示
- **詳細**:
  - デモモードであることを明示
  - セッション残り時間の表示
  - ログアウトボタンの提供
- **優先度**: 中
- **受け入れ基準**:
  - バナーが適切に表示される
  - セッション残り時間が正確に表示される
  - ログアウトボタンが正常に動作する

### 4. 環境変数管理

#### 4.1 環境変数設定
- **要件**: 環境別の環境変数設定
- **詳細**:
  - **フロントエンド（UI表示用のみ）**:
    - `NEXT_PUBLIC_ENVIRONMENT`: 環境識別（UI表示のヒント）
    - `NEXT_PUBLIC_AUTH_MODE`: 認証モード（UI表示のヒント、セキュリティ判定には使用しない）
  - **バックエンド（セキュリティ制御用）**:
    - `ASPNETCORE_ENVIRONMENT`: 環境識別（Production/Staging/Development）
    - `Authentication__Mode`: 認証モード制御（OAuthRequired/DemoAllowed/AllAllowed）
    - `Demo__PasswordHash`: デモモードパスワード（bcryptハッシュ、平文は保存しない）
    - `Authentication__JwtSecret`: JWT署名用シークレット
    - `Demo__SessionTimeoutHours`: デモセッションタイムアウト時間
  - **重要**: `NEXT_PUBLIC_DEV_PASSWORD` は完全に削除（クライアントにパスワードを露出しない）
- **優先度**: 高
- **受け入れ基準**:
  - 環境変数が正しく設定される
  - サーバー側環境変数のみがセキュリティ判定に使用される
  - クライアント側環境変数はUI表示のみに使用される
  - `NEXT_PUBLIC_DEV_PASSWORD` が存在しない
  - 環境変数の検証が正常に動作する

#### 4.2 環境変数検証
- **要件**: 起動時の環境変数検証
- **詳細**:
  - 必須環境変数の存在確認
  - 環境変数の値の妥当性確認
  - 設定不備時のエラー表示
  - **本番環境チェック**: `ASPNETCORE_ENVIRONMENT == Production` かつ `Authentication__Mode != OAuthRequired` の場合、起動を失敗させる
  - **ホスト名許可リスト**: 環境ごとに許可されたホスト名のリストを設定し、誤った環境での起動を防止
- **優先度**: 高
- **受け入れ基準**:
  - 必須環境変数の検証が正常に動作する
  - 設定不備時のエラーメッセージが分かりやすい
  - 起動時の検証が適切に実行される
  - 本番環境で誤った認証モード設定の場合、起動が失敗する
  - 環境とホスト名の不一致がある場合、警告またはエラーが表示される

---

## 🚫 非機能要件

### 1. セキュリティ要件

#### 1.1 認証セキュリティ
- **要件**: 強固な認証セキュリティ
- **詳細**:
  - OAuth認証の適切な実装
  - **Shopify App Bridgeセッショントークン**: Cookieではなく、Authorizationヘッダーベースの認証
  - セッショントークンの安全な管理（JWT）
  - CSRF攻撃の防止
  - **デモパスワードのブルートフォース対策**: レート制限、ロックアウト、失敗試行のログ記録
  - パスワードハッシュ化（bcrypt）
- **検証方法**: セキュリティテストの実施

#### 1.2 データ保護
- **要件**: 機密データの保護
- **詳細**:
  - デモモードでのデータアクセス制限
  - ログからの機密情報除外（パスワード、トークンは記録しない）
  - 適切なアクセス制御
  - **サーバー側での最終判定**: クライアント側の環境変数は信頼せず、すべての認証・認可判定はサーバー側で実施
  - **グローバル読み取り専用ポリシー**: デモモードでのすべての変更操作をデフォルトでブロック
- **検証方法**: データアクセステストの実施

#### 1.3 環境分離
- **要件**: 環境間の厳格な分離
- **詳細**:
  - 本番環境でのデモモード完全無効化
  - 環境設定の誤りによる起動失敗
  - ホスト名許可リストによる環境検証
  - CI/CDパイプラインでの環境変数検証
- **検証方法**: 環境設定テスト、起動時検証テスト

### 2. パフォーマンス要件

#### 2.1 応答時間
- **要件**: 認証処理の応答時間
- **詳細**:
  - 認証画面表示: 1秒以内
  - OAuth認証処理: 5秒以内
  - デモモード認証: 2秒以内
- **測定方法**: 実際の認証処理時間の測定

#### 2.2 スループット
- **要件**: 同時認証処理数
- **詳細**:
  - 最大100ユーザーの同時認証
  - レート制限の遵守
- **測定方法**: 負荷テストの実施

### 3. 可用性要件

#### 3.1 稼働率
- **要件**: 認証システムの稼働率
- **詳細**:
  - 本番環境: 99.9%以上
  - ステージング環境: 95%以上
  - 開発環境: 90%以上
- **測定方法**: 稼働時間の記録

#### 3.2 障害復旧
- **要件**: 障害発生時の復旧時間
- **詳細**:
  - 軽微な障害: 5分以内
  - 重大な障害: 30分以内
- **測定方法**: 障害発生から復旧までの時間記録

---

## 🎨 ユーザーストーリー

### エピック1: 環境別認証制御

#### ストーリー1: 本番環境でのOAuth認証強制
```
As a 本番ユーザー
I want to Shopify OAuth認証のみでアプリにアクセスできる
So that I can セキュアにアプリを利用できる

受け入れ基準:
- デモモードへのアクセスが完全にブロックされる
- OAuth認証以外の認証方法が使用できない
- 認証失敗時に適切なエラーメッセージが表示される
```

#### ストーリー2: ステージング環境での認証選択
```
As a 検証担当者
I want to OAuth認証とデモモードの両方を選択できる
So that I can 効率的にテストを実行できる

受け入れ基準:
- 認証画面でOAuth認証とデモリンクが両方表示される
- デモモードで適切な機能制限が適用される
- 環境変数による制御が正常に動作する
```

#### ストーリー3: 開発環境での全機能利用
```
As a 開発者
I want to すべての認証モードを利用できる
So that I can 効率的に開発・デバッグできる

受け入れ基準:
- すべての認証モードが利用可能
- デバッグ機能が正常に動作する
- 詳細ログが適切に出力される
```

### エピック2: 認証画面制御

#### ストーリー4: 動的タイトル表示
```
As a ユーザー
I want to 環境に応じた適切なタイトルが表示される
So that I can 現在の状況を理解できる

受け入れ基準:
- 本番環境で「Shopify認証が必要です」が表示される
- その他環境で「認証が必要です」が表示される
- タイトル変更が即座に反映される
```

#### ストーリー5: 動的ボタン表示
```
As a ユーザー
I want to 環境に応じた適切なボタンが表示される
So that I can 利用可能な認証方法を理解できる

受け入れ基準:
- 本番環境でOAuth認証ボタンのみが表示される
- ステージング環境でOAuth認証ボタンとデモリンクが表示される
- 開発環境で全ボタンが表示される
```

### エピック3: デモモード制限

#### ストーリー6: データ変更制限
```
As a デモモードユーザー
I want to データの変更ができない
So that I can 安全にアプリを確認できる

受け入れ基準:
- データ変更操作が実行できない
- 適切なエラーメッセージが表示される
- セキュリティログが記録される
```

#### ストーリー7: セッション管理
```
As a デモモードユーザー
I want to セッションが適切に管理される
So that I can セキュアにアプリを利用できる

受け入れ基準:
- セッション期限が正しく管理される
- 自動ログアウトが正常に動作する
- 手動ログアウトが正常に動作する
```

---

## 🔄 受け入れ基準

### 機能要件の受け入れ基準

| 機能 | 受け入れ基準 | テスト方法 |
|------|-------------|-----------|
| 本番環境OAuth強制 | デモモードアクセスが完全にブロックされる | 手動テスト |
| ステージング環境認証選択 | OAuth認証とデモリンクが両方表示される | 手動テスト |
| 開発環境全機能利用 | すべての認証モードが利用可能 | 手動テスト |
| 動的タイトル表示 | 環境に応じてタイトルが正しく表示される | 手動テスト |
| 動的ボタン表示 | 環境に応じてボタンが正しく表示される | 手動テスト |
| デモモード制限 | データ変更操作が実行できない | 自動テスト |
| セッション管理 | セッション期限が正しく管理される | 自動テスト |
| 環境変数管理 | 環境変数が正しく設定・検証される | 自動テスト |

### 非機能要件の受け入れ基準

| 要件 | 受け入れ基準 | テスト方法 |
|------|-------------|-----------|
| 認証セキュリティ | OAuth認証が適切に実装される | セキュリティテスト |
| データ保護 | デモモードでデータアクセスが制限される | データアクセステスト |
| 応答時間 | 認証画面表示が1秒以内 | パフォーマンステスト |
| 稼働率 | 本番環境で99.9%以上 | 監視テスト |

---

## 📊 成功指標

### 定量的指標

| 指標 | 現在値 | 目標値 | 測定方法 |
|------|--------|--------|----------|
| ステージング環境デモリンク表示率 | 0% | 100% | 手動確認 |
| 認証エラー率 | 100% | 10%以下 | エラーログ |
| デモモードセキュリティ違反 | 未測定 | 0件 | セキュリティ監査 |
| 認証処理時間 | 未測定 | 3秒以内 | パフォーマンス測定 |

### 定性的指標

| 指標 | 評価方法 | 目標 |
|------|----------|------|
| ユーザー満足度 | アンケート調査 | 4.0/5.0以上 |
| セキュリティレベル | セキュリティ監査 | 向上 |
| 運用効率 | 観察・記録 | 向上 |
| 開発効率 | 開発者インタビュー | 向上 |

---

## 🚧 制約事項

### 技術的制約
- 既存の認証システムとの互換性維持
- Shopify OAuth 2.0仕様の遵守
- Next.js App Routerの制約
- Azure Static Web Appsの制約

### ビジネス制約
- 開発時間の制限（4週間）
- 既存機能への影響最小化
- セキュリティ要件の遵守

### 法的制約
- データ保護法の遵守
- Shopify利用規約の遵守
- セキュリティ要件の遵守

---

## 📅 スケジュール

### Phase 0: セキュリティ強化（実装前必須）
- [ ] `NEXT_PUBLIC_DEV_PASSWORD` の完全削除
- [ ] コードベース監査（`NODE_ENV` vs `NEXT_PUBLIC_ENVIRONMENT`）
- [ ] CI/CDワークフローの環境変数検証
- [ ] サーバー起動時環境チェックの設計
- [ ] App Bridgeセッショントークン認証への切り替え設計
- [ ] グローバル読み取り専用ポリシーの設計
- [ ] 分散セッションストレージの設計（Redis/DB）

### Phase 1: 要件定義・設計（1週間）
- [ ] 要件定義完了
- [ ] 技術設計完了
- [ ] 環境変数設計完了（フロントエンド/バックエンド分離）
- [ ] セキュリティ設計完了（App Bridge、グローバルポリシー）
- [ ] 環境・認証モードマトリックス作成
- [ ] 運用手順書作成

### Phase 2: 基本実装（2週間）
- [ ] サーバー起動時環境チェック実装
- [ ] App Bridgeセッショントークン認証実装
- [ ] グローバル読み取り専用ポリシー実装
- [ ] 分散セッションストレージ実装
- [ ] 環境別認証制御実装
- [ ] 認証画面動的制御実装
- [ ] デモモード制限実装
- [ ] レート制限・ブルートフォース対策実装

### Phase 3: テスト・統合（1週間）
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] セキュリティテスト（環境設定誤り、デモモード書き込み試行）
- [ ] E2Eテスト（Shopify埋め込みコンテキスト）
- [ ] パフォーマンステスト

---

## 📚 関連ドキュメント

### 既存ドキュメント
- [認証モード一覧](../05-development/09-認証・セキュリティ/認証モード一覧.md)
- [認証画面表示仕様](../05-development/09-認証・セキュリティ/認証画面表示仕様.md)
- [環境変数チェックリスト](../05-development/09-認証・セキュリティ/環境変数チェックリスト.md)
- [Shopify アプリ認証・認可設計](../08-shopify/06-技術ガイド/Shopify-アプリ認証・認可設計.md)

### 外部ドキュメント
- [Shopify OAuth認証ガイド](https://shopify.dev/docs/apps/auth/oauth)
- [Session Tokens](https://shopify.dev/docs/apps/auth/session-tokens)
- [App Bridge 認証](https://shopify.dev/docs/apps/tools/app-bridge)

---

## 📝 更新履歴

| 日付 | 内容 | 担当者 |
|------|------|--------|
| 2025-10-25 | 初版作成 | Kenji |

---

**最終更新**: 2025年10月25日  
**次回レビュー**: 2025年11月1日（週次）
