# Shopify アプリ認証モード制御機能 要件定義書

## プロジェクト概要

**プロジェクト名**: Shopify アプリ認証モード制御機能  
**作成日**: 2025年10月25日  
**最終更新日**: 2025年10月27日  
**作成者**: Kenji  
**ステータス**: 要件定義完了（3段階認証レベル統合版）  

---

## 🎯 プロジェクト目標

### 主要目標
環境別に認証方式を安全に切り替える「3段階認証レベル制御機能」を実装し、本番環境ではShopify OAuth認証を強制、ステージング環境ではデモモードを許可、開発環境では開発者モードを追加で許可する。

**重要**: すべての認証・認可判定はサーバー側で実施し、クライアント側の環境変数（`NEXT_PUBLIC_*`）はUI表示のヒントとしてのみ使用する。

### 3段階認証レベル

```
Level 3: OAuth認証モード（本番・ステージング・開発）
  ↓ 最もセキュア
  - Shopify OAuth必須
  - 全機能利用可能
  - データ変更可能
  - read_only: false

Level 2: デモモード（ステージング・開発）
  ↓ 中程度のセキュリティ
  - パスワード認証（bcrypt、サーバー側）
  - 全画面閲覧可能
  - 読み取り専用（データ変更不可）
  - read_only: true
  - セッション管理あり

Level 1: 開発者モード（開発環境のみ）
  ↓ 開発用（低セキュリティ）
  - パスワード認証（bcrypt、サーバー側）
  - 開発ツール（/dev-bookmarks）にアクセス可能
  - デバッグ機能有効
  - 全機能利用可能
  - read_only: false
  - can_access_dev_tools: true
```

### 成功基準
- 本番環境でのセキュリティ強化（OAuth認証強制、サーバー側環境チェック）
- ステージング環境でのデモリンク表示問題解決
- 開発環境での効率的なテスト・デバッグ（開発者モード）
- 認証フローの明確化と運用性向上（3段階の明確な階層）
- Shopify埋め込みアプリでの安定した認証（App Bridgeセッショントークン）
- デモモードでのデータ保護（read_onlyクレームベースの読み取り専用ポリシー）
- 開発者モードの安全な実装（サーバー側認証、開発環境のみ）
- クライアント側パスワード（NEXT_PUBLIC_DEV_PASSWORD）の完全削除

---

## 🚨 現状の問題

### 問題1: ステージング環境でのデモリンク表示問題
- **現象**: ステージング環境で「デモサイトを開く」リンクが表示されない
- **原因**: 環境変数 `NEXT_PUBLIC_ENVIRONMENT` の判定ロジックの問題
- **影響**: デモ・プレゼンテーション時のアクセス困難

### 問題2: 認証モードの不統一
- **現象**: 環境によって認証方式が混在
- **原因**: 統一された認証モード制御の不在
- **影響**: セキュリティリスク、運用の複雑化

### 問題3: デモモードの制限不足
- **現象**: デモモードでも本番データにアクセス可能
- **原因**: 適切なアクセス制限の実装不足
- **影響**: データ漏洩リスク

### 問題4: クライアント側環境変数によるセキュリティ制御
- **現象**: `NEXT_PUBLIC_AUTH_MODE` や `NEXT_PUBLIC_DEV_PASSWORD` などのクライアント側環境変数でセキュリティを制御
- **原因**: クライアントバンドルに含まれる環境変数は改ざん可能
- **影響**: 認証バイパスのリスク、セキュリティ脆弱性

### 問題6: デモモードと開発者ツールの機能重複
- **現象**: `/dev-bookmarks`とデモモードが両方とも「認証なしでアプリを見る」という同じ目的を持つ
- **原因**: 統一された認証レベル設計の不在
- **影響**: ユーザー混乱、2つのパスワード管理、メンテナンス負担

### 問題5: Shopify埋め込みアプリでのCookie認証の問題
- **現象**: 3rdパーティCookie制限により認証が失敗する可能性
- **原因**: Cookieベースの認証実装
- **影響**: ユーザーの認証失敗、アプリの利用不可

---

## 👥 ステークホルダー

### 主要ユーザー
- **本番ユーザー**: Shopify OAuth認証でアプリを利用（Level 3）
- **検証担当者**: ステージング環境でOAuth認証をテスト（Level 3）
- **営業・プレゼンテーション担当者**: デモモードでアプリ機能を確認（Level 2、読み取り専用）
- **開発者**: 開発者モードでデバッグ・開発ツールを利用（Level 1、全機能）

### 影響を受けるシステム
- フロントエンド認証システム
- バックエンドAPI認証
- Shopify OAuth認証フロー
- デモモード機能
- 開発者モード機能（/dev-bookmarks）
- DemoReadOnlyFilter（read_onlyクレームベース）
- AuthModeMiddleware（3段階認証レベル対応）

---

## 📋 機能要件

### 1. 環境別認証モード制御

#### 1.1 本番環境（Production）
- **要件**: Shopify OAuth認証（Level 3）のみを許可
- **詳細**:
  - デモモード機能を完全に無効化
  - 開発者モード機能を完全に無効化
  - OAuth認証失敗時は認証画面にリダイレクト
  - セキュリティログの記録
  - **サーバー起動時チェック**: 環境が `Production` で認証モードが `OAuthRequired` 以外の場合、起動を失敗させる
  - **App Bridgeセッショントークン**: Cookieではなく、Shopify App Bridgeのセッショントークンを使用
  - `/api/demo/*` エンドポイントは404を返す
  - `/api/developer/*` エンドポイントは404を返す
  - `/dev-bookmarks` ページは404を返す
- **優先度**: 高
- **受け入れ基準**:
  - デモモードへのアクセスが完全にブロックされる
  - 開発者モードへのアクセスが完全にブロックされる
  - OAuth認証以外の認証方法が使用できない
  - 認証失敗時の適切なエラーハンドリング
  - 本番環境で誤った認証モード設定の場合、サーバーが起動しない
  - Shopify埋め込みアプリで3rdパーティCookie制限の影響を受けない

#### 1.2 ステージング環境（Staging）
- **要件**: OAuth認証（Level 3）+ デモモード（Level 2）の両方を許可
- **詳細**:
  - 認証画面でOAuth認証ボタンとデモリンクを表示
  - デモモードでは読み取り専用（read_only: true）
  - 開発者モード機能は無効化
  - 環境変数による制御
  - `/api/demo/*` エンドポイントは有効
  - `/api/developer/*` エンドポイントは404を返す
  - `/dev-bookmarks` ページは404を返す
- **優先度**: 高
- **受け入れ基準**:
  - 認証画面でOAuth認証とデモリンクが両方表示される
  - デモモードで読み取り専用制限が適用される（書き込み操作が403）
  - 開発者モードへのアクセスがブロックされる
  - 環境変数による制御が正常に動作する

#### 1.3 開発環境（Development）
- **要件**: 全認証モード（Level 3, 2, 1）を許可
- **詳細**:
  - OAuth認証（Level 3）: 全機能、read_only: false
  - デモモード（Level 2）: 読み取り専用、read_only: true
  - 開発者モード（Level 1）: 全機能 + 開発ツール、read_only: false、can_access_dev_tools: true
  - 認証画面で3つのオプションを表示（OAuth、デモ、開発者）
  - デバッグ機能の有効化
  - 詳細ログの出力
  - `/api/demo/*` エンドポイントは有効
  - `/api/developer/*` エンドポイントは有効
  - `/dev-bookmarks` ページは有効（開発者モードトークン必須）
- **優先度**: 中
- **受け入れ基準**:
  - すべての認証モードが利用可能
  - 開発者モードで/dev-bookmarksにアクセス可能
  - 開発者モードで書き込み操作が可能（read_only: false）
  - デモモードで書き込み操作が403
  - デバッグ機能が正常に動作する
  - 詳細ログが適切に出力される

### 2. 認証画面の動的制御

#### 2.1 タイトル表示制御
- **要件**: 環境に応じてタイトルを変更
- **詳細**:
  - 本番環境: 「Shopify認証が必要です」
  - その他環境: 「認証が必要です」
- **優先度**: 中
- **受け入れ基準**:
  - 環境変数に応じてタイトルが正しく表示される
  - タイトル変更が即座に反映される

#### 2.2 ボタン表示制御
- **要件**: 環境に応じてボタンを動的に表示
- **詳細**:
  - 本番環境: OAuth認証ボタンのみ
  - ステージング環境: OAuth認証ボタン + デモリンク
  - 開発環境: OAuth認証ボタン + デモリンク + 開発者モードリンク
- **優先度**: 高
- **受け入れ基準**:
  - 環境に応じて適切なボタンが表示される
  - ボタンの表示/非表示が正しく制御される
  - 開発環境でのみ開発者モードリンクが表示される

#### 2.3 メッセージ表示制御
- **要件**: 環境に応じてメッセージを変更
- **詳細**:
  - 本番環境: Shopify特化メッセージ
  - その他環境: 汎用メッセージ
- **優先度**: 中
- **受け入れ基準**:
  - 環境に応じてメッセージが正しく表示される
  - メッセージの内容が適切である

### 3. 認証レベル別機能制限

#### 3.1 read_onlyクレームベースのアクセス制限
- **要件**: read_onlyクレームに基づく機能制限
- **設計原則**:
  - **auth_modeではなくread_onlyクレームで判定**: DemoReadOnlyFilterは`auth_mode`を見ずに`read_only`クレームのみで判定
  - **柔軟性の向上**: 将来的にOAuthユーザーにも読み取り専用モードを提供可能
  - **明確な責任分離**: 認証モード（OAuth/Demo/Developer）と権限（read_only）を分離
- **詳細**:
  - **Level 3 (OAuth)**: read_only: false → 全機能利用可能
  - **Level 2 (Demo)**: read_only: true → データ閲覧のみ、変更・削除禁止
  - **Level 1 (Developer)**: read_only: false → 全機能利用可能 + 開発ツール
  - **グローバル読み取り専用ポリシー**: `read_only: true`の場合、すべての変更操作（POST/PUT/PATCH/DELETE）をデフォルトでブロック
  - 明示的に `[AllowDemoWrite]` 属性を付けたエンドポイントのみ許可（理想的にはゼロ）
  - クライアント側とサーバー側の両方で制限を実施（サーバー側が最終的な判定）
- **優先度**: 高
- **受け入れ基準**:
  - デモモードでデータ変更操作が実行できない（403エラー）
  - 開発者モードでデータ変更操作が実行できる
  - 適切なエラーメッセージが表示される
  - セキュリティログが記録される
  - クライアントが直接APIを呼び出してもサーバー側でブロックされる

#### 3.2 セッション管理
- **要件**: デモモードのセッション管理
- **詳細**:
  - セッション期限: 1時間
  - 自動ログアウト機能
  - 手動ログアウト機能
  - **分散セッションストレージ**: Redisまたはデータベーステーブルによるセッション管理（`IMemoryCache` は使用しない）
  - TTLと定期的なクリーンアップジョブ
  - スケールアウトやサーバー再起動に対応
- **優先度**: 高
- **受け入れ基準**:
  - セッション期限が正しく管理される
  - 自動ログアウトが正常に動作する
  - 手動ログアウトが正常に動作する
  - サーバー再起動後もセッションが維持される（または適切に失効する）
  - 複数サーバーインスタンス間でセッションが共有される

#### 3.3 バナー表示
- **要件**: 認証レベル別のバナー表示
- **詳細**:
  - **デモモード（Level 2）**:
    - 「デモモード」であることを明示
    - 「読み取り専用」の表示
    - セッション残り時間の表示
    - ログアウトボタンの提供
  - **開発者モード（Level 1）**:
    - 「開発者モード」であることを明示
    - 「開発環境のみ」の警告
    - セッション残り時間の表示
    - ログアウトボタンの提供
- **優先度**: 中
- **受け入れ基準**:
  - 各モードで適切なバナーが表示される
  - セッション残り時間が正確に表示される
  - ログアウトボタンが正常に動作する

### 4. 開発者モード機能（Level 1）

#### 4.1 開発者モード認証
- **要件**: サーバー側bcrypt認証
- **詳細**:
  - **クライアント側パスワード（NEXT_PUBLIC_DEV_PASSWORD）の完全削除**
  - サーバー側でbcryptによるパスワード検証
  - JWT発行（auth_mode: 'developer', read_only: false, can_access_dev_tools: true）
  - 開発環境（ASPNETCORE_ENVIRONMENT == Development）でのみ有効
  - ステージング・本番環境では`/api/developer/*`エンドポイントが404を返す
- **優先度**: 高
- **受け入れ基準**:
  - NEXT_PUBLIC_DEV_PASSWORDが存在しない
  - サーバー側でパスワードが検証される
  - 開発環境でのみ開発者モードが利用可能
  - ステージング・本番環境で開発者モードが完全にブロックされる

#### 4.2 開発ツールアクセス制御
- **要件**: can_access_dev_toolsクレームによるアクセス制御
- **詳細**:
  - `/dev-bookmarks`ページは`can_access_dev_tools: true`クレームが必要
  - 開発者モードトークンがない場合は認証画面にリダイレクト
  - フロントエンドとバックエンドの両方でアクセス制御
  - 本番・ステージング環境では`/dev-bookmarks`が404を返す
- **優先度**: 高
- **受け入れ基準**:
  - 開発者モードトークンで/dev-bookmarksにアクセス可能
  - デモモードトークンで/dev-bookmarksにアクセス不可
  - 本番・ステージング環境で/dev-bookmarksが404

#### 4.3 開発者モードの機能範囲
- **要件**: 全機能 + 開発ツールへのアクセス
- **詳細**:
  - read_only: false（書き込み操作可能）
  - can_access_dev_tools: true（開発ツールアクセス可能）
  - デバッグ機能の有効化
  - 詳細ログの出力
  - APIテストページへのアクセス
  - データベーステストページへのアクセス
- **優先度**: 中
- **受け入れ基準**:
  - 開発者モードで書き込み操作が可能
  - 開発者モードで全開発ツールにアクセス可能
  - デバッグ機能が正常に動作する

### 5. 環境変数管理

#### 5.1 環境変数設定
- **要件**: 環境別の環境変数設定
- **詳細**:
  - **フロントエンド（UI表示用のみ）**:
    - `NEXT_PUBLIC_ENVIRONMENT`: 環境識別（UI表示のヒント）
    - `NEXT_PUBLIC_AUTH_MODE`: 認証モード（UI表示のヒント、セキュリティ判定には使用しない）
  - **バックエンド（セキュリティ制御用）**:
    - `ASPNETCORE_ENVIRONMENT`: 環境識別（Production/Staging/Development）
    - `Authentication__Mode`: 認証モード制御（OAuthRequired/DemoAllowed/AllAllowed）
    - `Demo__Enabled`: デモモード有効化フラグ
    - `Demo__PasswordHash`: デモモードパスワード（bcryptハッシュ、平文は保存しない）
    - `Demo__SessionTimeoutHours`: デモセッションタイムアウト時間
    - `Developer__Enabled`: 開発者モード有効化フラグ（開発環境のみtrue）
    - `Developer__PasswordHash`: 開発者モードパスワード（bcryptハッシュ、デモとは別のパスワード）
    - `Developer__SessionTimeoutHours`: 開発者セッションタイムアウト時間
    - `Authentication__JwtSecret`: JWT署名用シークレット
  - **削除された変数（セキュリティリスクのため）**:
    - `NEXT_PUBLIC_DEV_PASSWORD`: クライアントにパスワードを露出しない
  - **重要**: `NEXT_PUBLIC_DEV_PASSWORD` は完全に削除（クライアントにパスワードを露出しない）
- **優先度**: 高
- **受け入れ基準**:
  - 環境変数が正しく設定される
  - サーバー側環境変数のみがセキュリティ判定に使用される
  - クライアント側環境変数はUI表示のみに使用される
  - `NEXT_PUBLIC_DEV_PASSWORD` が存在しない
  - 環境変数の検証が正常に動作する

#### 5.2 環境変数検証
- **要件**: 起動時の環境変数検証
- **詳細**:
  - 必須環境変数の存在確認
  - 環境変数の値の妥当性確認
  - 設定不備時のエラー表示
  - **本番環境チェック**: `ASPNETCORE_ENVIRONMENT == Production` かつ `Authentication__Mode != OAuthRequired` の場合、起動を失敗させる
  - **ホスト名許可リスト**: 環境ごとに許可されたホスト名のリストを設定し、誤った環境での起動を防止
- **優先度**: 高
- **受け入れ基準**:
  - 必須環境変数の検証が正常に動作する
  - 設定不備時のエラーメッセージが分かりやすい
  - 起動時の検証が適切に実行される
  - 本番環境で誤った認証モード設定の場合、起動が失敗する
  - 環境とホスト名の不一致がある場合、警告またはエラーが表示される

---

## 🚫 非機能要件

### 1. セキュリティ要件

#### 1.1 認証セキュリティ
- **要件**: 強固な認証セキュリティ
- **詳細**:
  - OAuth認証の適切な実装
  - **Shopify App Bridgeセッショントークン**: Cookieではなく、Authorizationヘッダーベースの認証
  - セッショントークンの安全な管理（JWT）
  - CSRF攻撃の防止
  - **デモパスワードのブルートフォース対策**: レート制限、ロックアウト、失敗試行のログ記録
  - パスワードハッシュ化（bcrypt）
- **検証方法**: セキュリティテストの実施

#### 1.2 データ保護
- **要件**: 機密データの保護
- **詳細**:
  - デモモードでのデータアクセス制限
  - ログからの機密情報除外（パスワード、トークンは記録しない）
  - 適切なアクセス制御
  - **サーバー側での最終判定**: クライアント側の環境変数は信頼せず、すべての認証・認可判定はサーバー側で実施
  - **グローバル読み取り専用ポリシー**: デモモードでのすべての変更操作をデフォルトでブロック
- **検証方法**: データアクセステストの実施

#### 1.3 環境分離
- **要件**: 環境間の厳格な分離
- **詳細**:
  - 本番環境でのデモモード完全無効化
  - 環境設定の誤りによる起動失敗
  - ホスト名許可リストによる環境検証
  - CI/CDパイプラインでの環境変数検証
- **検証方法**: 環境設定テスト、起動時検証テスト

### 2. パフォーマンス要件

#### 2.1 応答時間
- **要件**: 認証処理の応答時間
- **詳細**:
  - 認証画面表示: 1秒以内
  - OAuth認証処理: 5秒以内
  - デモモード認証: 2秒以内
- **測定方法**: 実際の認証処理時間の測定

#### 2.2 スループット
- **要件**: 同時認証処理数
- **詳細**:
  - 最大100ユーザーの同時認証
  - レート制限の遵守
- **測定方法**: 負荷テストの実施

### 3. 可用性要件

#### 3.1 稼働率
- **要件**: 認証システムの稼働率
- **詳細**:
  - 本番環境: 99.9%以上
  - ステージング環境: 95%以上
  - 開発環境: 90%以上
- **測定方法**: 稼働時間の記録

#### 3.2 障害復旧
- **要件**: 障害発生時の復旧時間
- **詳細**:
  - 軽微な障害: 5分以内
  - 重大な障害: 30分以内
- **測定方法**: 障害発生から復旧までの時間記録

---

## 🎨 ユーザーストーリー

### エピック1: 環境別認証制御

#### ストーリー1: 本番環境でのOAuth認証強制
```
As a 本番ユーザー
I want to Shopify OAuth認証のみでアプリにアクセスできる
So that I can セキュアにアプリを利用できる

受け入れ基準:
- デモモードへのアクセスが完全にブロックされる
- OAuth認証以外の認証方法が使用できない
- 認証失敗時に適切なエラーメッセージが表示される
```

#### ストーリー2: ステージング環境での認証選択
```
As a 検証担当者
I want to OAuth認証とデモモードの両方を選択できる
So that I can 効率的にテストを実行できる

受け入れ基準:
- 認証画面でOAuth認証とデモリンクが両方表示される
- デモモードで適切な機能制限が適用される
- 環境変数による制御が正常に動作する
```

#### ストーリー3: 開発環境での全機能利用
```
As a 開発者
I want to すべての認証モードを利用できる
So that I can 効率的に開発・デバッグできる

受け入れ基準:
- すべての認証モードが利用可能
- デバッグ機能が正常に動作する
- 詳細ログが適切に出力される
```

### エピック2: 認証画面制御

#### ストーリー4: 動的タイトル表示
```
As a ユーザー
I want to 環境に応じた適切なタイトルが表示される
So that I can 現在の状況を理解できる

受け入れ基準:
- 本番環境で「Shopify認証が必要です」が表示される
- その他環境で「認証が必要です」が表示される
- タイトル変更が即座に反映される
```

#### ストーリー5: 動的ボタン表示
```
As a ユーザー
I want to 環境に応じた適切なボタンが表示される
So that I can 利用可能な認証方法を理解できる

受け入れ基準:
- 本番環境でOAuth認証ボタンのみが表示される
- ステージング環境でOAuth認証ボタンとデモリンクが表示される
- 開発環境で全ボタンが表示される
```

### エピック3: デモモード制限

#### ストーリー6: データ変更制限
```
As a デモモードユーザー
I want to データの変更ができない
So that I can 安全にアプリを確認できる

受け入れ基準:
- データ変更操作が実行できない
- 適切なエラーメッセージが表示される
- セキュリティログが記録される
```

#### ストーリー7: セッション管理
```
As a デモモードユーザー
I want to セッションが適切に管理される
So that I can セキュアにアプリを利用できる

受け入れ基準:
- セッション期限が正しく管理される
- 自動ログアウトが正常に動作する
- 手動ログアウトが正常に動作する
```

---

## 🔄 受け入れ基準

### 機能要件の受け入れ基準

| 機能 | 受け入れ基準 | テスト方法 |
|------|-------------|-----------|
| 本番環境OAuth強制 | デモモードアクセスが完全にブロックされる | 手動テスト |
| ステージング環境認証選択 | OAuth認証とデモリンクが両方表示される | 手動テスト |
| 開発環境全機能利用 | すべての認証モードが利用可能 | 手動テスト |
| 動的タイトル表示 | 環境に応じてタイトルが正しく表示される | 手動テスト |
| 動的ボタン表示 | 環境に応じてボタンが正しく表示される | 手動テスト |
| デモモード制限 | データ変更操作が実行できない | 自動テスト |
| セッション管理 | セッション期限が正しく管理される | 自動テスト |
| 環境変数管理 | 環境変数が正しく設定・検証される | 自動テスト |

### 非機能要件の受け入れ基準

| 要件 | 受け入れ基準 | テスト方法 |
|------|-------------|-----------|
| 認証セキュリティ | OAuth認証が適切に実装される | セキュリティテスト |
| データ保護 | デモモードでデータアクセスが制限される | データアクセステスト |
| 応答時間 | 認証画面表示が1秒以内 | パフォーマンステスト |
| 稼働率 | 本番環境で99.9%以上 | 監視テスト |

---

## 📊 成功指標

### 定量的指標

| 指標 | 現在値 | 目標値 | 測定方法 |
|------|--------|--------|----------|
| ステージング環境デモリンク表示率 | 0% | 100% | 手動確認 |
| 認証エラー率 | 100% | 10%以下 | エラーログ |
| デモモードセキュリティ違反 | 未測定 | 0件 | セキュリティ監査 |
| 認証処理時間 | 未測定 | 3秒以内 | パフォーマンス測定 |

### 定性的指標

| 指標 | 評価方法 | 目標 |
|------|----------|------|
| ユーザー満足度 | アンケート調査 | 4.0/5.0以上 |
| セキュリティレベル | セキュリティ監査 | 向上 |
| 運用効率 | 観察・記録 | 向上 |
| 開発効率 | 開発者インタビュー | 向上 |

---

## 🚧 制約事項

### 技術的制約
- 既存の認証システムとの互換性維持
- Shopify OAuth 2.0仕様の遵守
- Next.js App Routerの制約
- Azure Static Web Appsの制約

### ビジネス制約
- 開発時間の制限（4週間）
- 既存機能への影響最小化
- セキュリティ要件の遵守

### 法的制約
- データ保護法の遵守
- Shopify利用規約の遵守
- セキュリティ要件の遵守

---

## 📅 スケジュール

### Phase 0: セキュリティ強化（実装前必須）
- [ ] `NEXT_PUBLIC_DEV_PASSWORD` の完全削除
- [ ] コードベース監査（`NODE_ENV` vs `NEXT_PUBLIC_ENVIRONMENT`）
- [ ] CI/CDワークフローの環境変数検証
- [ ] サーバー起動時環境チェックの設計
- [ ] App Bridgeセッショントークン認証への切り替え設計
- [ ] グローバル読み取り専用ポリシーの設計
- [ ] 分散セッションストレージの設計（Redis/DB）

### Phase 1: 要件定義・設計（1週間）
- [ ] 要件定義完了
- [ ] 技術設計完了
- [ ] 環境変数設計完了（フロントエンド/バックエンド分離）
- [ ] セキュリティ設計完了（App Bridge、グローバルポリシー）
- [ ] 環境・認証モードマトリックス作成
- [ ] 運用手順書作成

### Phase 2: 基本実装（2週間）
- [ ] サーバー起動時環境チェック実装
- [ ] App Bridgeセッショントークン認証実装
- [ ] グローバル読み取り専用ポリシー実装
- [ ] 分散セッションストレージ実装
- [ ] 環境別認証制御実装
- [ ] 認証画面動的制御実装
- [ ] デモモード制限実装
- [ ] レート制限・ブルートフォース対策実装

### Phase 3: テスト・統合（1週間）
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] セキュリティテスト（環境設定誤り、デモモード書き込み試行）
- [ ] E2Eテスト（Shopify埋め込みコンテキスト）
- [ ] パフォーマンステスト

---

## 📚 関連ドキュメント

### 既存ドキュメント
- [認証モード一覧](../05-development/09-認証・セキュリティ/認証モード一覧.md)
- [認証画面表示仕様](../05-development/09-認証・セキュリティ/認証画面表示仕様.md)
- [環境変数チェックリスト](../05-development/09-認証・セキュリティ/環境変数チェックリスト.md)
- [Shopify アプリ認証・認可設計](../08-shopify/06-技術ガイド/Shopify-アプリ認証・認可設計.md)

### 外部ドキュメント
- [Shopify OAuth認証ガイド](https://shopify.dev/docs/apps/auth/oauth)
- [Session Tokens](https://shopify.dev/docs/apps/auth/session-tokens)
- [App Bridge 認証](https://shopify.dev/docs/apps/tools/app-bridge)

---

## 📝 更新履歴

| 日付 | 内容 | 担当者 |
|------|------|--------|
| 2025-10-25 | 初版作成 | Kenji |

---

**最終更新**: 2025年10月25日  
**次回レビュー**: 2025年11月1日（週次）
