# 分析画面「テスト注文」取り扱い調査報告

## 概要

以下3画面の分析仕様において、「テスト注文」の取り扱いが一定かどうかを調査した。

| 画面 | 対応API | コントローラ | サービス層 |
|------|---------|--------------|------------|
| 前年同月比分析 | `GET /api/analytics/year-over-year` | AnalyticsController | YearOverYearService |
| 購入回数分析 | `GET /api/purchase/count-analysis` 等 | PurchaseController | PurchaseCountAnalysisService, PurchaseCountDataService, PurchaseCountOrchestrationService |
| 休眠顧客分析 | `GET /api/customer/dormant` 等 | CustomerController | DormantCustomerService, DormantCustomerQueryService |

---

## 結論

- **3画面ともテスト注文を除外していない。** 取り扱いは「すべて含める」で一致している。
- **一方で、テスト注文を識別・除外する仕様はどこにも存在しない。**  
  Order に `Test` カラムがなく、同期でも Shopify の `test` を取得・保存していない。  
  その結果、テスト注文は常に全分析に含まれる。

**→ 2026-01-28 に「テスト注文を除外する」仕様で統一する実装を実施。**  
詳細は **§5. 実装済み対応** を参照。

---

## 1. データモデル・同期でのテスト注文の扱い

### 1.1 Order エンティティ

- **場所**: `backend/ShopifyAnalyticsApi/Models/DatabaseModels.cs`
- **内容**: `Order` に `Test` / `IsTest` などのプロパティは **存在しない**。  
  マイグレーションでも Order に test 系カラムの追加は行っていない。

### 1.2 Shopify 注文同期

- **REST**: `ShopifyApiService.BuildOrdersUrl`  
  - `orders.json?limit=250&status=any` 等で **全注文** を取得（テスト注文も含む）。
- **ShopifyOrder DTO** (`ShopifyApiService` 内):  
  - `id`, `email`, `order_number`, `total_price`, `financial_status`, `processed_at` 等のみ。  
  - **`test` はマッピングしていない。**
- **Upsert**: `UpsertOrderAsync` で `Order` へマッピングするが、`test` に相当する項目はない。
- **同期ジョブ**: `ShopifyOrderSyncJob` は上記 API 経由で取得した注文をそのまま保存。  
  テスト注文のフィルタや `Test` の保存は行っていない。

→ **同期時点でテスト注文かどうかは保存されておらず、後から分析で除外することもできない。**

---

## 2. 各分析での注文参照の仕方とテスト注文扱い

### 2.1 前年同月比分析

- **サービス**: `YearOverYearService`
- **データソース**: `OrderItems` JOIN `Orders`
- **主なクエリ**:  
  - `GetOrderItemsDataAsync`:  
    - `StoreId` / `ShopifyProcessedAt`（年・月）/ `ExcludeServiceItems` 等でフィルタ。  
    - **Order の `Test` 等による条件はなし。**
  - `GetAvailableProductTypesAsync` / `GetAvailableVendorsAsync`:  
    - 同様に Order を参照するが、テスト注文の除外はなし。
  - `GetAnalysisDateRangeAsync`:  
    - `Orders` の日付範囲のみ使用。テスト注文の考慮なし。

**テスト注文**: **常に含まれる。**

---

### 2.2 購入回数分析

- **サービス**:  
  - `PurchaseCountDataService`（注文の集計・取得）  
  - `PurchaseCountAnalysisService`（分析ロジック）  
  - `PurchaseCountOrchestrationService`（通常版・簡易版のオーケストレーション）
- **データソース**: いずれも `Orders`（`PurchaseCountDataService` 経由）。

主なメソッドとクエリ:

| メソッド | 用途 | 注文フィルタ（テスト以外） | テスト注文 |
|----------|------|----------------------------|------------|
| `GetCustomerPurchaseCountsAsync` | 顧客別購入回数 | StoreId, ShopifyProcessedAt, 期間, CustomerId | 除外なし |
| `GetTotalRevenueAsync` | 期間売上 | StoreId, ShopifyProcessedAt, 期間 | 除外なし |
| `GetSegmentCustomerIdsAsync` | セグメント（new/returning/existing 等） | 上に同じ | 除外なし |
| `GetSegmentCustomerPurchaseCountsAsync` | セグメント別購入データ | 上に同じ | 除外なし |
| `GetMonthlyCustomerPurchaseCountsAsync` | 月別購入データ | 上に同じ | 除外なし |

- 通常版（`GetPurchaseCountAnalysisAsync`）・簡易版（`GetSimplifiedPurchaseCountAnalysisAsync`）・サマリー・トレンド・セグメント分析はいずれも上記データソースを利用。  
- **テスト注文の除外は一切なし。**

**テスト注文**: **常に含まれる。**

---

### 2.3 休眠顧客分析

- **サービス**: `DormantCustomerQueryService`（および `DormantStatisticsService` 等）
- **主なデータソース**:  
  - **メイン**: `Customer` の `TotalOrders`, `LastOrderDate`（非正規化）。  
  - **補助**:  
    - `GetDormantCustomerByIdAsync`: 最終注文日の取得で `Orders` を直接参照。  
    - `GetPreferredCategories`: `OrderItems` 経由で参照。

#### Customer 集計値の更新元

- `CustomerDataMaintenanceService.UpdateCustomerTotalOrdersAsync`:  
  - `Orders` を `CustomerId` で集計し、`TotalOrders` / `TotalSpent` / `LastOrderDate` を更新。  
  - **テスト注文の除外はなし。**
- `DatabaseController` 内の Customer 集計更新: 同様に `Orders` のみで集計。除外なし。
- `ShopifyApiService.UpsertOrderAsync`: 注文同期時に `Customer.LastOrderDate` を更新。  
  ここでもテスト注文の判定・除外はなし。

`BuildBaseQuery` は `Customer.TotalOrders > 0` および `LastOrderDate` のみを使用。  
元データがすべて `Orders` 由来で、テスト注文が除外されていないため、**休眠顧客分析にもテスト注文が反映される。**

**テスト注文**: **常に含まれる。**

---

## 3. まとめ表

| 分析 | 注文の参照箇所 | テスト注文の除外 |
|------|----------------|------------------|
| 前年同月比 | YearOverYearService → Orders / OrderItems | なし |
| 購入回数 | PurchaseCountDataService → Orders | なし |
| 休眠顧客 | Customer 集計（Orders 由来）+ Orders / OrderItems の補助参照 | なし |

**→ 3画面とも「テスト注文を除外しない」で一致している。**

---

## 4. 推奨アクション（今後の方針を決める場合）

1. **方針の決定**  
   - 分析では「テスト注文を除外する」とするか、現状どおり「含める」かのどちらにするか確定する。

2. **除外する場合に必要な対応**  
   - **Order に `Test`（または `IsTest`）を追加**  
     - マイグレーションでカラム追加。
   - **同期で `test` を取得・保存**  
     - Shopify REST `order.test` を DTO に追加し、`Order` にマッピング。  
     - 既存データは `UPDATE` で埋めるか、再同期で補う。
   - **分析クエリで統一除外**  
     - 前年同月比・購入回数・休眠顧客の **すべて** の Order 参照箇所で  
       `Test == false`（など）を適用する。  
     - Customer 集計（`TotalOrders` / `LastOrderDate`）も、テスト注文を除いた `Orders` で再計算するように変更。
   - **一括更新**  
     - `CustomerDataMaintenanceService.UpdateCustomerTotalOrdersAsync` および  
       Database 更新処理で、テスト注文を除外した集計に切り替える。

3. **一貫性の維持**  
   - テスト注文の除外は「全分析で統一」することを推奨。  
     一部の画面だけ除外すると、指標の意味がずれ、比較・解釈が難しくなる。

---

## 5. 実装済み対応（2026-01-28）

「テスト注文を除外する」仕様で統一するため、以下を実施した。

### 5.1 Order に IsTest 追加・マイグレーション

- `Order` に `IsTest`（bool）を追加（`DatabaseModels.cs`）。
- EF マイグレーション `20260128092303_AddIsTestToOrders` を追加。既存行は `defaultValue: false`。
- 手動SQL: `docs/05-development/03-データベース/マイグレーション/2026-01-28-AddIsTestToOrders.sql`（EF未使用環境用）。

### 5.2 同期で test 取得・保存

- **ShopifyOrder DTO**: `[JsonPropertyName("test")] public bool Test` を追加。
- **ShopifyApiService.UpsertOrderAsync**: 新規・更新時に `IsTest = order.Test` を設定。  
  `LastOrderDate` 更新は **テスト注文のときは行わない**。
- **ShopifyOrderSyncJob**:  
  - `ConvertToOrderEntity`: `IsTest = shopifyOrder.Test`。  
  - `SaveOrUpdateOrdersBatch`: 既存注文更新時に `IsTest` を反映。  
  - `UpdateCustomerLastOrderDatesAsync`: 最新注文日取得時に `!o.IsTest` でフィルタ。

### 5.3 分析クエリで統一除外

- **前年同月比**:  
  `GetOrderItemsDataAsync`、`GetAvailableProductTypesAsync`、`GetAvailableVendorsAsync`、  
  `GetAnalysisDateRangeAsync`、デバッグ用注文分布で `!order.IsTest` を適用。  
  キャッシュキーを `YearOverYear_ExcludeTest` に変更し、旧キャッシュを無効化。
- **購入回数**:  
  `PurchaseCountDataService` の全 Order 参照（顧客別購入回数・総売上・セグメント・月次等）に  
  `!o.IsTest` を追加。
- **休眠顧客**:  
  - `GetDormantCustomerByIdAsync` の最終注文日取得、`GetPreferredCategories` の OrderItems 参照で  
    `!o.IsTest` / `!oi.Order.IsTest` を適用。  
  - キャッシュキーを `dormant_query_v4` に変更。

### 5.4 Customer 集計でテスト注文除外

- **CustomerDataMaintenanceService**:  
  `UpdateCustomerTotalOrdersAsync`、`GetCustomerUpdateSummaryAsync` の Orders 集計で `!o.IsTest`。
- **DatabaseController.UpdateCustomerTotals**: 同様に `!o.IsTest`。
- **CustomerController デバッグ** (`GetStoreDataSummary`):  
  休眠・注文分布用の Orders 参照で `!o.IsTest`。

### 5.5 運用上の注意

- **マイグレーション適用**: 本対応反映後、`dotnet ef database update` または  
  `2026-01-28-AddIsTestToOrders.sql` を適用すること。
- **既存データ**: 既存 Order は `IsTest = false` のまま。  
  過去のテスト注文を正しく付け直すには、Shopify 再同期が必要。
- **Customer 再集計**: 反映後、`POST /api/database/update-customer-totals` を実行し、  
  `TotalOrders` / `LastOrderDate` をテスト注文除外ベースで再計算することを推奨。

---

## 6. 参照した主なファイル

- `backend/ShopifyAnalyticsApi/Models/DatabaseModels.cs`（Order）
- `backend/ShopifyAnalyticsApi/Services/ShopifyApiService.cs`（同期・DTO）
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyOrderSyncJob.cs`（注文同期）
- `backend/ShopifyAnalyticsApi/Services/YearOverYearService.cs`
- `backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountDataService.cs`
- `backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountAnalysisService.cs`
- `backend/ShopifyAnalyticsApi/Services/PurchaseCount/PurchaseCountOrchestrationService.cs`
- `backend/ShopifyAnalyticsApi/Services/Dormant/DormantCustomerQueryService.cs`
- `backend/ShopifyAnalyticsApi/Services/CustomerDataMaintenanceService.cs`
- `backend/ShopifyAnalyticsApi/Controllers/AnalyticsController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/PurchaseController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/CustomerController.cs`

---

**作成日**: 2026-01-28  
**担当**: 福田＋AI Assistant
