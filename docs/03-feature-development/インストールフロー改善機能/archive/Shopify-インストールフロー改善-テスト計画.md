# Shopify ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼æ”¹å–„æ©Ÿèƒ½ ãƒ†ã‚¹ãƒˆè¨ˆç”»æ›¸

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Shopifyã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼æ”¹å–„æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆè¨ˆç”»ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã«åŸºã¥ãã€å˜ä½“ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã€E2Eãƒ†ã‚¹ãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

---

## ğŸ¯ ãƒ†ã‚¹ãƒˆç›®æ¨™

### ä¸»è¦ç›®æ¨™
1. ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒè¦ä»¶é€šã‚Šã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒãªã„ã“ã¨ã‚’ç¢ºèª
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
4. æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
5. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### æˆåŠŸåŸºæº–
- å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Š
- çµ±åˆãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ä¸»è¦ãƒ•ãƒ­ãƒ¼100%
- E2Eãƒ†ã‚¹ãƒˆ: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ªãŒåˆæ ¼
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ: è„†å¼±æ€§ã‚¼ãƒ­
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: ã™ã¹ã¦ã®æŒ‡æ¨™ãŒç›®æ¨™å€¤ä»¥å†…

---

## ğŸ—ï¸ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰

```
        /\
       /  \
      / E2E \         10% - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼å…¨ä½“
     /--------\
    /          \
   / Integration \    20% - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€£æº
  /--------------\
 /                \
/   Unit Tests     \  70% - å€‹åˆ¥æ©Ÿèƒ½
--------------------
```

### ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«

#### 1. å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆUnit Testsï¼‰
- **ç›®çš„**: å€‹åˆ¥ã®é–¢æ•°ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã®å‹•ä½œç¢ºèª
- **ãƒ„ãƒ¼ãƒ«**: xUnit (C#), Jest (TypeScript)
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 80%ä»¥ä¸Š

#### 2. çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆIntegration Testsï¼‰
- **ç›®çš„**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€£æºç¢ºèª
- **ãƒ„ãƒ¼ãƒ«**: xUnit + WebApplicationFactory (C#), React Testing Library (TypeScript)
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: ä¸»è¦ãƒ•ãƒ­ãƒ¼100%

#### 3. E2Eãƒ†ã‚¹ãƒˆï¼ˆEnd-to-End Testsï¼‰
- **ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®å‹•ä½œç¢ºèª
- **ãƒ„ãƒ¼ãƒ«**: Playwright
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒŠãƒªã‚ª

#### 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆSecurity Testsï¼‰
- **ç›®çš„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®æ¤œå‡º
- **ãƒ„ãƒ¼ãƒ«**: OWASP ZAP, æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

#### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆPerformance Testsï¼‰
- **ç›®çš„**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã®ç¢ºèª
- **ãƒ„ãƒ¼ãƒ«**: k6, Application Insights
- **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: ã™ã¹ã¦ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

---

## ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆ

#### 1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯API

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `Tests/Controllers/ShopifyAuthControllerTests.cs`

```csharp
using Xunit;
using Moq;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using ShopifyAnalyticsApi.Controllers;
using ShopifyAnalyticsApi.Services;
using ShopifyAnalyticsApi.Data;

public class ShopifyAuthControllerTests : IDisposable
{
    private readonly Mock<ILogger<ShopifyAuthController>> _mockLogger;
    private readonly Mock<IRateLimiter> _mockRateLimiter;
    private readonly Mock<IShopifyOAuthService> _mockOAuthService;
    private readonly ApplicationDbContext _context;
    private readonly ShopifyAuthController _controller;

    public ShopifyAuthControllerTests()
    {
        _mockLogger = new Mock<ILogger<ShopifyAuthController>>();
        _mockRateLimiter = new Mock<IRateLimiter>();
        _mockOAuthService = new Mock<IShopifyOAuthService>();
        
        // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
        var options = new DbContextOptionsBuilder<ApplicationDbContext>()
            .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
            .Options;
        _context = new ApplicationDbContext(options);
        
        _controller = new ShopifyAuthController(
            _mockLogger.Object,
            _mockRateLimiter.Object,
            _mockOAuthService.Object,
            _context
        );
    }

    [Fact]
    public async Task GetInstallationStatus_UninstalledShop_ReturnsCorrectResponse()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        // Act
        var result = await _controller.GetInstallationStatus(shop);
        
        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = okResult.Value as dynamic;
        Assert.False(response.installed);
        Assert.NotNull(response.installUrl);
        Assert.Contains("not installed", response.message.ToString().ToLower());
    }

    [Fact]
    public async Task GetInstallationStatus_InstalledShopWithValidScopes_ReturnsCorrectResponse()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var store = new Store
        {
            Domain = shop,
            AccessToken = "test-token",
            Scopes = "read_orders,read_products,read_customers",
            InstalledAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        _context.Stores.Add(store);
        await _context.SaveChangesAsync();
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        // Act
        var result = await _controller.GetInstallationStatus(shop);
        
        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = okResult.Value as dynamic;
        Assert.True(response.installed);
        Assert.True(response.scopesValid);
    }

    [Fact]
    public async Task GetInstallationStatus_InstalledShopWithMissingScopes_ReturnsCorrectResponse()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var store = new Store
        {
            Domain = shop,
            AccessToken = "test-token",
            Scopes = "read_orders", // ä¸è¶³ã—ã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—
            InstalledAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        _context.Stores.Add(store);
        await _context.SaveChangesAsync();
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        // Act
        var result = await _controller.GetInstallationStatus(shop);
        
        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = okResult.Value as dynamic;
        Assert.True(response.installed);
        Assert.False(response.scopesValid);
        Assert.NotEmpty(response.missingScopes);
        Assert.NotNull(response.reauthUrl);
    }

    [Fact]
    public async Task GetInstallationStatus_InvalidShopDomain_ReturnsBadRequest()
    {
        // Arrange
        var shop = "invalid-shop";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(false);
        
        // Act
        var result = await _controller.GetInstallationStatus(shop);
        
        // Assert
        var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
        var response = badRequestResult.Value as dynamic;
        Assert.Contains("invalid", response.error.ToString().ToLower());
    }

    [Fact]
    public async Task GetInstallationStatus_RateLimitExceeded_ReturnsTooManyRequests()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(false);
        
        // Act
        var result = await _controller.GetInstallationStatus(shop);
        
        // Assert
        var statusCodeResult = Assert.IsType<ObjectResult>(result);
        Assert.Equal(429, statusCodeResult.StatusCode);
    }

    public void Dispose()
    {
        _context.Database.EnsureDeleted();
        _context.Dispose();
    }
}
```

#### 2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```csharp
public class InstallEndpointTests : IDisposable
{
    private readonly Mock<ILogger<ShopifyAuthController>> _mockLogger;
    private readonly Mock<IRateLimiter> _mockRateLimiter;
    private readonly Mock<IShopifyOAuthService> _mockOAuthService;
    private readonly Mock<IMemoryCache> _mockCache;
    private readonly ShopifyAuthController _controller;

    public InstallEndpointTests()
    {
        _mockLogger = new Mock<ILogger<ShopifyAuthController>>();
        _mockRateLimiter = new Mock<IRateLimiter>();
        _mockOAuthService = new Mock<IShopifyOAuthService>();
        _mockCache = new Mock<IMemoryCache>();
        
        _controller = new ShopifyAuthController(
            _mockLogger.Object,
            _mockRateLimiter.Object,
            _mockOAuthService.Object,
            _mockCache.Object
        );
    }

    [Fact]
    public void Install_ValidShopWithoutHost_ReturnsRedirectWithoutHost()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        // Act
        var result = _controller.Install(shop, null, null);
        
        // Assert
        var redirectResult = Assert.IsType<RedirectResult>(result);
        Assert.Contains($"https://{shop}/admin/oauth/authorize", redirectResult.Url);
        Assert.DoesNotContain("&host=", redirectResult.Url);
    }

    [Fact]
    public void Install_ValidShopWithHost_ReturnsRedirectWithHost()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var host = "dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockOAuthService.Setup(x => x.IsValidHostParameter(host)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        // Act
        var result = _controller.Install(shop, host, null);
        
        // Assert
        var redirectResult = Assert.IsType<RedirectResult>(result);
        Assert.Contains($"https://{shop}/admin/oauth/authorize", redirectResult.Url);
        Assert.Contains($"&host={Uri.EscapeDataString(host)}", redirectResult.Url);
    }

    [Fact]
    public void Install_InvalidShopDomain_ReturnsBadRequest()
    {
        // Arrange
        var shop = "invalid-shop";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(false);
        
        // Act
        var result = _controller.Install(shop, null, null);
        
        // Assert
        var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
    }

    [Fact]
    public void Install_InvalidHostParameter_ReturnsBadRequest()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var host = "invalid-host";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockOAuthService.Setup(x => x.IsValidHostParameter(host)).Returns(false);
        
        // Act
        var result = _controller.Install(shop, host, null);
        
        // Assert
        var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
    }

    [Fact]
    public void Install_StateIsCachedWithHost()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var host = "dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu";
        
        _mockOAuthService.Setup(x => x.IsValidShopDomain(shop)).Returns(true);
        _mockOAuthService.Setup(x => x.IsValidHostParameter(host)).Returns(true);
        _mockRateLimiter.Setup(x => x.CheckRateLimitAsync(It.IsAny<string>(), It.IsAny<int>(), It.IsAny<TimeSpan>()))
            .ReturnsAsync(true);
        
        OAuthStateData? cachedData = null;
        _mockCache.Setup(x => x.Set(
            It.IsAny<string>(),
            It.IsAny<OAuthStateData>(),
            It.IsAny<TimeSpan>()))
            .Callback<string, OAuthStateData, TimeSpan>((key, value, expiry) => {
                cachedData = value;
            });
        
        // Act
        var result = _controller.Install(shop, host, null);
        
        // Assert
        Assert.NotNull(cachedData);
        Assert.Equal(shop, cachedData.Shop);
        Assert.Equal(host, cachedData.Host);
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}
```

#### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚µãƒ¼ãƒ“ã‚¹

```csharp
public class RateLimiterTests
{
    private readonly Mock<IDistributedCache> _mockCache;
    private readonly Mock<ILogger<RateLimiter>> _mockLogger;
    private readonly RateLimiter _rateLimiter;

    public RateLimiterTests()
    {
        _mockCache = new Mock<IDistributedCache>();
        _mockLogger = new Mock<ILogger<RateLimiter>>();
        _rateLimiter = new RateLimiter(_mockCache.Object, _mockLogger.Object);
    }

    [Fact]
    public async Task CheckRateLimitAsync_FirstRequest_ReturnsTrue()
    {
        // Arrange
        var key = "test-key";
        _mockCache.Setup(x => x.GetStringAsync(It.IsAny<string>(), default))
            .ReturnsAsync((string?)null);
        
        // Act
        var result = await _rateLimiter.CheckRateLimitAsync(key, 10, TimeSpan.FromMinutes(1));
        
        // Assert
        Assert.True(result);
    }

    [Fact]
    public async Task CheckRateLimitAsync_WithinLimit_ReturnsTrue()
    {
        // Arrange
        var key = "test-key";
        _mockCache.Setup(x => x.GetStringAsync(It.IsAny<string>(), default))
            .ReturnsAsync("5");
        
        // Act
        var result = await _rateLimiter.CheckRateLimitAsync(key, 10, TimeSpan.FromMinutes(1));
        
        // Assert
        Assert.True(result);
    }

    [Fact]
    public async Task CheckRateLimitAsync_ExceedsLimit_ReturnsFalse()
    {
        // Arrange
        var key = "test-key";
        _mockCache.Setup(x => x.GetStringAsync(It.IsAny<string>(), default))
            .ReturnsAsync("10");
        
        // Act
        var result = await _rateLimiter.CheckRateLimitAsync(key, 10, TimeSpan.FromMinutes(1));
        
        // Assert
        Assert.False(result);
    }

    [Fact]
    public async Task CheckRateLimitAsync_IncrementsCounter()
    {
        // Arrange
        var key = "test-key";
        var callCount = 0;
        
        _mockCache.Setup(x => x.GetStringAsync(It.IsAny<string>(), default))
            .ReturnsAsync("5");
        
        _mockCache.Setup(x => x.SetStringAsync(
            It.IsAny<string>(),
            It.IsAny<string>(),
            It.IsAny<DistributedCacheEntryOptions>(),
            default))
            .Callback(() => callCount++)
            .Returns(Task.CompletedTask);
        
        // Act
        await _rateLimiter.CheckRateLimitAsync(key, 10, TimeSpan.FromMinutes(1));
        
        // Assert
        Assert.Equal(1, callCount);
    }
}
```

#### 4. ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼

```csharp
public class ShopifyOAuthServiceTests
{
    private readonly ShopifyOAuthService _service;

    public ShopifyOAuthServiceTests()
    {
        _service = new ShopifyOAuthService();
    }

    [Theory]
    [InlineData("test-store.myshopify.com", true)]
    [InlineData("my-shop-123.myshopify.com", true)]
    [InlineData("a.myshopify.com", true)]
    [InlineData("test_store.myshopify.com", false)] // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ä¸å¯
    [InlineData("test store.myshopify.com", false)] // ã‚¹ãƒšãƒ¼ã‚¹ä¸å¯
    [InlineData("test-store", false)] // .myshopify.comãªã—
    [InlineData("test-store.com", false)] // ä¸æ­£ãªãƒ‰ãƒ¡ã‚¤ãƒ³
    [InlineData("", false)] // ç©ºæ–‡å­—
    [InlineData(null, false)] // null
    [InlineData("<script>alert('xss')</script>.myshopify.com", false)] // XSSè©¦è¡Œ
    public void IsValidShopDomain_VariousInputs_ReturnsExpectedResult(string shop, bool expected)
    {
        // Act
        var result = _service.IsValidShopDomain(shop);
        
        // Assert
        Assert.Equal(expected, result);
    }

    [Theory]
    [InlineData("dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu", true)] // æœ‰åŠ¹ãªbase64
    [InlineData("invalid-base64", false)] // ç„¡åŠ¹ãªbase64
    [InlineData("", false)] // ç©ºæ–‡å­—
    [InlineData(null, false)] // null
    public void IsValidHostParameter_VariousInputs_ReturnsExpectedResult(string host, bool expected)
    {
        // Act
        var result = _service.IsValidHostParameter(host);
        
        // Assert
        Assert.Equal(expected, result);
    }
}
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆ

#### 1. AppBridgeProvider

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/providers/__tests__/AppBridgeProvider.test.tsx`

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { AppBridgeProvider, useAppBridge } from '../AppBridgeProvider';
import createApp from '@shopify/app-bridge';
import { getSessionToken } from '@shopify/app-bridge/utilities';

jest.mock('@shopify/app-bridge');
jest.mock('@shopify/app-bridge/utilities');

describe('AppBridgeProvider', () => {
  beforeEach(() => {
    // URLSearchParamsã®ãƒ¢ãƒƒã‚¯
    delete (window as any).location;
    (window as any).location = { search: '' };
  });

  it('hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€App Bridgeã‚’åˆæœŸåŒ–ã™ã‚‹', () => {
    // Arrange
    (window as any).location.search = '?host=dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu';
    process.env.NEXT_PUBLIC_SHOPIFY_API_KEY = 'test-api-key';
    
    const mockApp = {};
    (createApp as jest.Mock).mockReturnValue(mockApp);
    
    // Act
    const TestComponent = () => {
      const { isEmbedded } = useAppBridge();
      return <div>{isEmbedded ? 'Embedded' : 'Not Embedded'}</div>;
    };
    
    render(
      <AppBridgeProvider>
        <TestComponent />
      </AppBridgeProvider>
    );
    
    // Assert
    expect(createApp).toHaveBeenCalledWith({
      apiKey: 'test-api-key',
      host: 'dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu'
    });
    expect(screen.getByText('Embedded')).toBeInTheDocument();
  });

  it('hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹', () => {
    // Arrange
    (window as any).location.search = '';
    
    // Act
    const TestComponent = () => {
      const { isEmbedded } = useAppBridge();
      return <div>{isEmbedded ? 'Embedded' : 'Not Embedded'}</div>;
    };
    
    render(
      <AppBridgeProvider>
        <TestComponent />
      </AppBridgeProvider>
    );
    
    // Assert
    expect(screen.getByText('Not Embedded')).toBeInTheDocument();
  });

  it('getToken()ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹', async () => {
    // Arrange
    (window as any).location.search = '?host=dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu';
    process.env.NEXT_PUBLIC_SHOPIFY_API_KEY = 'test-api-key';
    
    const mockApp = {};
    (createApp as jest.Mock).mockReturnValue(mockApp);
    (getSessionToken as jest.Mock).mockResolvedValue('mock-session-token');
    
    // Act
    const TestComponent = () => {
      const { getToken } = useAppBridge();
      const [token, setToken] = React.useState('');
      
      React.useEffect(() => {
        getToken().then(setToken);
      }, [getToken]);
      
      return <div>{token}</div>;
    };
    
    render(
      <AppBridgeProvider>
        <TestComponent />
      </AppBridgeProvider>
    );
    
    // Assert
    await waitFor(() => {
      expect(screen.getByText('mock-session-token')).toBeInTheDocument();
    });
  });

  it('extractShopFromToken()ãŒã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡ºã™ã‚‹', () => {
    // Arrange
    const token = 'header.' + btoa(JSON.stringify({ dest: 'https://test-store.myshopify.com' })) + '.signature';
    
    // Act
    const TestComponent = () => {
      const { extractShopFromToken } = useAppBridge();
      const shop = extractShopFromToken(token);
      return <div>{shop}</div>;
    };
    
    render(
      <AppBridgeProvider>
        <TestComponent />
      </AppBridgeProvider>
    );
    
    // Assert
    expect(screen.getByText('test-store.myshopify.com')).toBeInTheDocument();
  });
});
```

#### 2. AuthGuard

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/auth/__tests__/AuthGuard.test.tsx`

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { AuthGuard } from '../AuthGuard';
import { useAppBridge } from '@/components/providers/AppBridgeProvider';
import { useSearchParams } from 'next/navigation';

jest.mock('@/components/providers/AppBridgeProvider');
jest.mock('next/navigation');

describe('AuthGuard', () => {
  beforeEach(() => {
    global.fetch = jest.fn();
    (useSearchParams as jest.Mock).mockReturnValue(new URLSearchParams());
  });

  it('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹', async () => {
    // Arrange
    const mockGetToken = jest.fn().mockResolvedValue('mock-token');
    const mockRedirectToUrl = jest.fn();
    const mockExtractShopFromToken = jest.fn().mockReturnValue('test-store.myshopify.com');
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      getToken: mockGetToken,
      redirectToUrl: mockRedirectToUrl,
      extractShopFromToken: mockExtractShopFromToken
    });

    (global.fetch as jest.Mock).mockResolvedValue({
      ok: true,
      json: async () => ({
        installed: false,
        installUrl: 'https://example.com/install?shop=test-store.myshopify.com'
      })
    });

    // Act
    render(<AuthGuard><div>Content</div></AuthGuard>);

    // Assert
    await waitFor(() => {
      expect(mockRedirectToUrl).toHaveBeenCalledWith(
        expect.stringContaining('https://example.com/install')
      );
    });
  });

  it('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º', async () => {
    // Arrange
    const mockGetToken = jest.fn().mockResolvedValue('mock-token');
    const mockExtractShopFromToken = jest.fn().mockReturnValue('test-store.myshopify.com');
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      getToken: mockGetToken,
      redirectToUrl: jest.fn(),
      extractShopFromToken: mockExtractShopFromToken
    });

    (global.fetch as jest.Mock).mockResolvedValue({
      ok: true,
      json: async () => ({
        installed: true,
        scopesValid: true
      })
    });

    // Act
    render(<AuthGuard><div>Content</div></AuthGuard>);

    // Assert
    await waitFor(() => {
      expect(screen.getByText('Content')).toBeInTheDocument();
    });
  });

  it('ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ã®å ´åˆã€å†èªè¨¼URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹', async () => {
    // Arrange
    const mockGetToken = jest.fn().mockResolvedValue('mock-token');
    const mockRedirectToUrl = jest.fn();
    const mockExtractShopFromToken = jest.fn().mockReturnValue('test-store.myshopify.com');
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      getToken: mockGetToken,
      redirectToUrl: mockRedirectToUrl,
      extractShopFromToken: mockExtractShopFromToken
    });

    (global.fetch as jest.Mock).mockResolvedValue({
      ok: true,
      json: async () => ({
        installed: true,
        scopesValid: false,
        missingScopes: ['read_products'],
        reauthUrl: 'https://example.com/install?shop=test-store.myshopify.com&scopes=...'
      })
    });

    // Act
    render(<AuthGuard><div>Content</div></AuthGuard>);

    // Assert
    await waitFor(() => {
      expect(mockRedirectToUrl).toHaveBeenCalledWith(
        expect.stringContaining('https://example.com/install')
      );
    });
  });

  it('éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¢ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º', async () => {
    // Arrange
    localStorage.setItem('demo_token', 'demo-token');
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: false,
      getToken: jest.fn(),
      redirectToUrl: jest.fn(),
      extractShopFromToken: jest.fn()
    });

    // Act
    render(<AuthGuard><div>Content</div></AuthGuard>);

    // Assert
    await waitFor(() => {
      expect(screen.getByText('Content')).toBeInTheDocument();
      expect(screen.getByText(/ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰/)).toBeInTheDocument();
    });
    
    // Cleanup
    localStorage.removeItem('demo_token');
  });
});
```

#### 3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/app/install/__tests__/page.test.tsx`

```typescript
import { render, screen, waitFor, fireEvent } from '@testing-library/react';
import InstallPage from '../page';
import { useSearchParams } from 'next/navigation';
import { useAppBridge } from '@/components/providers/AppBridgeProvider';

jest.mock('next/navigation');
jest.mock('@/components/providers/AppBridgeProvider');

describe('InstallPage', () => {
  beforeEach(() => {
    delete (window as any).location;
    (window as any).location = { href: '' };
  });

  it('shopãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹', async () => {
    // Arrange
    const mockSearchParams = new URLSearchParams('?shop=test-store.myshopify.com');
    (useSearchParams as jest.Mock).mockReturnValue(mockSearchParams);
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: false,
      redirectToUrl: jest.fn()
    });

    // Act
    render(<InstallPage />);

    // Assert
    await waitFor(() => {
      expect(screen.getByText(/Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­/)).toBeInTheDocument();
    });
    
    await waitFor(() => {
      expect((window as any).location.href).toContain('/api/shopify/install');
      expect((window as any).location.href).toContain('shop=test-store.myshopify.com');
    }, { timeout: 1000 });
  });

  it('hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹', async () => {
    // Arrange
    const mockSearchParams = new URLSearchParams('?host=dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu');
    (useSearchParams as jest.Mock).mockReturnValue(mockSearchParams);
    
    const mockRedirectToUrl = jest.fn();
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      redirectToUrl: mockRedirectToUrl
    });

    // Act
    render(<InstallPage />);

    // Assert
    await waitFor(() => {
      expect(mockRedirectToUrl).toHaveBeenCalledWith(
        expect.stringContaining('/api/shopify/install')
      );
      expect(mockRedirectToUrl).toHaveBeenCalledWith(
        expect.stringContaining('host=')
      );
    }, { timeout: 1000 });
  });

  it('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹', async () => {
    // Arrange
    const mockSearchParams = new URLSearchParams('');
    (useSearchParams as jest.Mock).mockReturnValue(mockSearchParams);
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: false,
      redirectToUrl: jest.fn()
    });

    // Act
    render(<InstallPage />);

    // Assert
    await waitFor(() => {
      expect(screen.getByLabelText('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeInTheDocument();
      expect(screen.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' })).toBeInTheDocument();
    });
  });

  it('æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã§æœ‰åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹', async () => {
    // Arrange
    const mockSearchParams = new URLSearchParams('');
    (useSearchParams as jest.Mock).mockReturnValue(mockSearchParams);
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: false,
      redirectToUrl: jest.fn()
    });

    render(<InstallPage />);

    await waitFor(() => {
      expect(screen.getByLabelText('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeInTheDocument();
    });

    // Act
    const input = screen.getByLabelText('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³');
    const button = screen.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' });
    
    fireEvent.change(input, { target: { value: 'test-store' } });
    fireEvent.click(button);

    // Assert
    await waitFor(() => {
      expect((window as any).location.href).toContain('/api/shopify/install');
      expect((window as any).location.href).toContain('shop=test-store.myshopify.com');
    }, { timeout: 1000 });
  });

  it('æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã§ç„¡åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹', async () => {
    // Arrange
    const mockSearchParams = new URLSearchParams('');
    (useSearchParams as jest.Mock).mockReturnValue(mockSearchParams);
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: false,
      redirectToUrl: jest.fn()
    });

    render(<InstallPage />);

    await waitFor(() => {
      expect(screen.getByLabelText('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeInTheDocument();
    });

    // Act
    const input = screen.getByLabelText('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³');
    const button = screen.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' });
    
    fireEvent.change(input, { target: { value: 'invalid_store' } }); // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ä¸å¯
    fireEvent.click(button);

    // Assert
    await waitFor(() => {
      expect(screen.getByText(/æœ‰åŠ¹ãªã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„/)).toBeInTheDocument();
    });
  });
});
```

---

## ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ

#### 1. OAuthãƒ•ãƒ­ãƒ¼å…¨ä½“

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `Tests/Integration/OAuthFlowTests.cs`

```csharp
using Microsoft.AspNetCore.Mvc.Testing;
using Xunit;

public class OAuthFlowTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;

    public OAuthFlowTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory;
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task CompleteOAuthFlow_WithoutHost_Success()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        
        // Act - Step 1: Install
        var installResponse = await _client.GetAsync(
            $"/api/shopify/install?shop={shop}");
        
        // Assert - Step 1
        Assert.Equal(HttpStatusCode.Redirect, installResponse.StatusCode);
        var redirectUrl = installResponse.Headers.Location?.ToString();
        Assert.Contains($"https://{shop}/admin/oauth/authorize", redirectUrl);
        Assert.DoesNotContain("&host=", redirectUrl);
        
        // Extract state from redirect URL
        var state = ExtractStateFromUrl(redirectUrl);
        Assert.NotNull(state);
        
        // Act - Step 2: Callback (mock Shopify response)
        var callbackResponse = await _client.GetAsync(
            $"/api/shopify/callback?code=mock-code&shop={shop}&state={state}");
        
        // Assert - Step 2
        Assert.Equal(HttpStatusCode.Redirect, callbackResponse.StatusCode);
        var successUrl = callbackResponse.Headers.Location?.ToString();
        Assert.Contains("/auth/success", successUrl);
        Assert.Contains($"shop={Uri.EscapeDataString(shop)}", successUrl);
    }

    [Fact]
    public async Task CompleteOAuthFlow_WithHost_PreservesHost()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var host = "dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu";
        
        // Act - Step 1: Install
        var installResponse = await _client.GetAsync(
            $"/api/shopify/install?shop={shop}&host={host}");
        
        // Assert - Step 1
        Assert.Equal(HttpStatusCode.Redirect, installResponse.StatusCode);
        var redirectUrl = installResponse.Headers.Location?.ToString();
        Assert.Contains("&host=", redirectUrl);
        Assert.Contains(host, redirectUrl);
        
        // Extract state from redirect URL
        var state = ExtractStateFromUrl(redirectUrl);
        
        // Act - Step 2: Callback
        var callbackResponse = await _client.GetAsync(
            $"/api/shopify/callback?code=mock-code&shop={shop}&state={state}&host={host}");
        
        // Assert - Step 2
        Assert.Equal(HttpStatusCode.Redirect, callbackResponse.StatusCode);
        var successUrl = callbackResponse.Headers.Location?.ToString();
        Assert.Contains("host=", successUrl);
        Assert.Contains(host, successUrl);
    }

    [Fact]
    public async Task OAuthFlow_InvalidState_ReturnsUnauthorized()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        var invalidState = "invalid-state-12345";
        
        // Act
        var callbackResponse = await _client.GetAsync(
            $"/api/shopify/callback?code=mock-code&shop={shop}&state={invalidState}");
        
        // Assert
        Assert.Equal(HttpStatusCode.Unauthorized, callbackResponse.StatusCode);
    }

    [Fact]
    public async Task OAuthFlow_RateLimitExceeded_ReturnsTooManyRequests()
    {
        // Arrange
        var shop = "test-store.myshopify.com";
        
        // Act - åˆ¶é™ã‚’è¶…ãˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        var responses = new List<HttpResponseMessage>();
        for (int i = 0; i < 10; i++)
        {
            responses.Add(await _client.GetAsync($"/api/shopify/install?shop={shop}"));
        }
        
        // Assert - æœ€å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
        var lastResponse = responses.Last();
        Assert.Equal(HttpStatusCode.TooManyRequests, lastResponse.StatusCode);
    }

    private string? ExtractStateFromUrl(string? url)
    {
        if (string.IsNullOrEmpty(url)) return null;
        
        var uri = new Uri(url);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        return query["state"];
    }
}
```

#### 2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯APIçµ±åˆãƒ†ã‚¹ãƒˆ

```csharp
public class InstallationStatusIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;

    public InstallationStatusIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory;
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task StatusCheck_AfterSuccessfulInstall_ReturnsInstalled()
    {
        // Arrange - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Œäº†
        var shop = "test-store.myshopify.com";
        await CompleteInstallation(shop);
        
        // Act - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
        var statusResponse = await _client.GetAsync(
            $"/api/shopify/status?shop={shop}");
        
        // Assert
        Assert.Equal(HttpStatusCode.OK, statusResponse.StatusCode);
        var content = await statusResponse.Content.ReadAsStringAsync();
        var status = JsonSerializer.Deserialize<InstallationStatusResponse>(content);
        
        Assert.True(status.Installed);
        Assert.True(status.ScopesValid);
    }

    [Fact]
    public async Task StatusCheck_UninstalledShop_ReturnsNotInstalled()
    {
        // Arrange
        var shop = "uninstalled-store.myshopify.com";
        
        // Act
        var statusResponse = await _client.GetAsync(
            $"/api/shopify/status?shop={shop}");
        
        // Assert
        Assert.Equal(HttpStatusCode.OK, statusResponse.StatusCode);
        var content = await statusResponse.Content.ReadAsStringAsync();
        var status = JsonSerializer.Deserialize<InstallationStatusResponse>(content);
        
        Assert.False(status.Installed);
        Assert.NotNull(status.InstallUrl);
    }

    private async Task CompleteInstallation(string shop)
    {
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
        var installResponse = await _client.GetAsync($"/api/shopify/install?shop={shop}");
        var state = ExtractStateFromUrl(installResponse.Headers.Location?.ToString());
        await _client.GetAsync($"/api/shopify/callback?code=mock-code&shop={shop}&state={state}");
    }
}
```

---

## ğŸŒ E2Eãƒ†ã‚¹ãƒˆ

### Playwrightãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/tests/e2e/install-flow.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼', () => {
  test('shopãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install?shop=test-store.myshopify.com');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèª
    await expect(page.getByText('Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­')).toBeVisible();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¾…ã¤ï¼ˆé–‹ç™ºç’°å¢ƒã§ã¯ãƒ¢ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
    await page.waitForURL(/.*\/api\/shopify\/install.*/, { timeout: 5000 });
    
    // URLã«shopãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(page.url()).toContain('shop=test-store.myshopify.com');
  });

  test('hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    const host = 'dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu';
    await page.goto(`/install?host=${host}`);
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèª
    await expect(page.getByText('Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­')).toBeVisible();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¾…ã¤
    await page.waitForURL(/.*\/api\/shopify\/install.*/, { timeout: 5000 });
    
    // URLã«hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(page.url()).toContain(`host=${host}`);
  });

  test('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install');
    
    // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeVisible();
    await expect(page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' })).toBeVisible();
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ­ã‚´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText('EC Ranger')).toBeVisible();
    
    // æ©Ÿèƒ½èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText('ã“ã®ã‚¢ãƒ—ãƒªã§ã§ãã‚‹ã“ã¨')).toBeVisible();
  });

  test('æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã§æœ‰åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    await expect(page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeVisible();
    
    // ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›
    await page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³').fill('test-store');
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' }).click();
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèª
    await expect(page.getByText('Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­')).toBeVisible();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¾…ã¤
    await page.waitForURL(/.*\/api\/shopify\/install.*/, { timeout: 5000 });
    
    // URLã«æ­£ã—ã„ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(page.url()).toContain('shop=test-store.myshopify.com');
  });

  test('æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã§ç„¡åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    await expect(page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeVisible();
    
    // ç„¡åŠ¹ãªã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰
    await page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³').fill('invalid_store');
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' }).click();
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText(/æœ‰åŠ¹ãªã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„/)).toBeVisible();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
    await page.waitForTimeout(1000);
    expect(page.url()).toContain('/install');
  });

  test('æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã§ç©ºã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é€ä¿¡ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install');
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    await expect(page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeVisible();
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆç©ºã®ã¾ã¾ï¼‰
    await page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' }).click();
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText(/ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„/)).toBeVisible();
  });
});

test.describe('AuthGuard', () => {
  test('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼ã«é€²ã‚€', async ({ page, context }) => {
    // ãƒ¢ãƒƒã‚¯ã®App Bridgeã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
    await context.addInitScript(() => {
      (window as any).mockAppBridge = {
        isEmbedded: true,
        sessionToken: 'mock-session-token'
      };
    });
    
    // ä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/?host=dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu');
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText(/èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­/)).toBeVisible();
    
    // æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
    // ï¼ˆå®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯ãƒ¢ãƒƒã‚¯APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨­å®šï¼‰
  });

  test('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã€ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤º', async ({ page, context }) => {
    // ãƒ¢ãƒƒã‚¯ã®App Bridgeã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
    await context.addInitScript(() => {
      (window as any).mockAppBridge = {
        isEmbedded: true,
        sessionToken: 'mock-session-token'
      };
    });
    
    // ãƒ¢ãƒƒã‚¯APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨­å®šï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰
    await page.route('**/api/shopify/status*', route => {
      route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          installed: true,
          scopesValid: true,
          message: 'App is properly installed'
        })
      });
    });
    
    // ä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/?host=dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu');
    
    // ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByText(/ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰/)).toBeVisible({ timeout: 10000 });
  });
});
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

### 1. ã‚·ãƒ§ãƒƒãƒ—åˆ—æŒ™æ”»æ’ƒãƒ†ã‚¹ãƒˆ

```typescript
test.describe('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚·ãƒ§ãƒƒãƒ—åˆ—æŒ™æ”»æ’ƒ', () => {
  test('ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæ©Ÿèƒ½ã™ã‚‹', async ({ request }) => {
    const shop = 'test-store.myshopify.com';
    const responses = [];
    
    // åˆ¶é™ã‚’è¶…ãˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    for (let i = 0; i < 15; i++) {
      const response = await request.get(`/api/shopify/status?shop=${shop}`);
      responses.push(response);
    }
    
    // æœ€å¾Œã®ã„ãã¤ã‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ429ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
    const lastResponses = responses.slice(-5);
    const tooManyRequests = lastResponses.filter(r => r.status() === 429);
    
    expect(tooManyRequests.length).toBeGreaterThan(0);
  });

  test('ç•°ãªã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯', async ({ request }) => {
    // è¤‡æ•°ã®ç•°ãªã‚‹ã‚·ãƒ§ãƒƒãƒ—ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const shops = Array.from({ length: 100 }, (_, i) => `shop-${i}.myshopify.com`);
    const responses = [];
    
    for (const shop of shops) {
      const response = await request.get(`/api/shopify/status?shop=${shop}`);
      responses.push(response);
    }
    
    // IPãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒç™ºå‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    const tooManyRequests = responses.filter(r => r.status() === 429);
    expect(tooManyRequests.length).toBeGreaterThan(0);
  });
});
```

### 2. CSRFæ”»æ’ƒãƒ†ã‚¹ãƒˆ

```csharp
[Fact]
public async Task OAuthCallback_WithoutValidState_ReturnsUnauthorized()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    var code = "mock-authorization-code";
    var invalidState = "attacker-generated-state";
    
    // Act
    var response = await _client.GetAsync(
        $"/api/shopify/callback?code={code}&shop={shop}&state={invalidState}");
    
    // Assert
    Assert.Equal(HttpStatusCode.Unauthorized, response.StatusCode);
}

[Fact]
public async Task OAuthCallback_WithExpiredState_ReturnsUnauthorized()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¦stateã‚’å–å¾—
    var installResponse = await _client.GetAsync($"/api/shopify/install?shop={shop}");
    var state = ExtractStateFromUrl(installResponse.Headers.Location?.ToString());
    
    // 11åˆ†å¾…æ©Ÿï¼ˆstateã®æœ‰åŠ¹æœŸé™ã¯10åˆ†ï¼‰
    await Task.Delay(TimeSpan.FromMinutes(11));
    
    // Act - æœŸé™åˆ‡ã‚Œã®stateã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    var callbackResponse = await _client.GetAsync(
        $"/api/shopify/callback?code=mock-code&shop={shop}&state={state}");
    
    // Assert
    Assert.Equal(HttpStatusCode.Unauthorized, callbackResponse.StatusCode);
}
```

### 3. ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãƒ†ã‚¹ãƒˆ

```csharp
[Theory]
[InlineData("<script>alert('xss')</script>.myshopify.com")]
[InlineData("'; DROP TABLE Stores; --")]
[InlineData("../../../etc/passwd")]
[InlineData("%00.myshopify.com")]
public async Task StatusCheck_WithMaliciousInput_ReturnsBadRequest(string maliciousShop)
{
    // Act
    var response = await _client.GetAsync(
        $"/api/shopify/status?shop={Uri.EscapeDataString(maliciousShop)}");
    
    // Assert
    Assert.Equal(HttpStatusCode.BadRequest, response.StatusCode);
}
```

### 4. HMACæ¤œè¨¼ãƒ†ã‚¹ãƒˆ

```csharp
[Fact]
public async Task OAuthCallback_WithInvalidHmac_ReturnsUnauthorized()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    var code = "mock-code";
    var state = await GetValidState(shop);
    var invalidHmac = "invalid-hmac-signature";
    var timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds().ToString();
    
    // Act
    var response = await _client.GetAsync(
        $"/api/shopify/callback?code={code}&shop={shop}&state={state}&hmac={invalidHmac}&timestamp={timestamp}");
    
    // Assert
    Assert.Equal(HttpStatusCode.Unauthorized, response.StatusCode);
}
```

---

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### 1. k6è² è·ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/performance/install-flow-load-test.js`

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '1m', target: 10 },  // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
    { duration: '3m', target: 50 },  // é€šå¸¸è² è·
    { duration: '2m', target: 100 }, // ãƒ”ãƒ¼ã‚¯è² è·
    { duration: '1m', target: 0 },   // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ500msä»¥å†…
    errors: ['rate<0.1'],              // ã‚¨ãƒ©ãƒ¼ç‡10%æœªæº€
  },
};

export default function () {
  const shop = `test-store-${__VU}-${__ITER}.myshopify.com`;
  
  // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  const statusRes = http.get(`${__ENV.API_BASE_URL}/api/shopify/status?shop=${shop}`);
  
  check(statusRes, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  }) || errorRate.add(1);
  
  sleep(1);
}
```

### 2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ æ¸¬å®š

```csharp
[Fact]
public async Task StatusCheck_ResponseTime_IsAcceptable()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    var stopwatch = Stopwatch.StartNew();
    
    // Act
    var response = await _client.GetAsync($"/api/shopify/status?shop={shop}");
    stopwatch.Stop();
    
    // Assert
    Assert.Equal(HttpStatusCode.OK, response.StatusCode);
    Assert.True(stopwatch.ElapsedMilliseconds < 500, 
        $"Response time was {stopwatch.ElapsedMilliseconds}ms, expected < 500ms");
}
```

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

```csharp
[Fact]
public async Task StatusCheck_DatabaseQuery_IsOptimized()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    
    // å¤§é‡ã®ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    for (int i = 0; i < 10000; i++)
    {
        _context.Stores.Add(new Store
        {
            Domain = $"store-{i}.myshopify.com",
            AccessToken = "token",
            Scopes = "read_orders",
            InstalledAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        });
    }
    await _context.SaveChangesAsync();
    
    var stopwatch = Stopwatch.StartNew();
    
    // Act
    var response = await _client.GetAsync($"/api/shopify/status?shop={shop}");
    stopwatch.Stop();
    
    // Assert
    Assert.True(stopwatch.ElapsedMilliseconds < 100, 
        $"Database query took {stopwatch.ElapsedMilliseconds}ms, expected < 100ms");
}
```

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ« | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ | æ¸¬å®šæ–¹æ³• |
|-------------|--------------|---------|
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 80%ä»¥ä¸Š | Coverlet (C#), Jest Coverage (TS) |
| çµ±åˆãƒ†ã‚¹ãƒˆ | ä¸»è¦ãƒ•ãƒ­ãƒ¼100% | æ‰‹å‹•ç¢ºèª |
| E2Eãƒ†ã‚¹ãƒˆ | å…¨ã‚·ãƒŠãƒªã‚ª | æ‰‹å‹•ç¢ºèª |

### ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
reportgenerator -reports:coverage.opencover.xml -targetdir:coverage-report
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:
```bash
npm run test -- --coverage
```

---

## ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ‰‹é †

### 1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆ
cd backend/ShopifyAnalyticsApi.Tests
dotnet test

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆ
cd frontend
npm run test

# E2Eãƒ†ã‚¹ãƒˆ
cd frontend
npm run test:e2e
```

### 2. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

**GitHub Actions**: `.github/workflows/test.yml`
```yaml
name: Tests

on: [push, pull_request]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
      - name: Run tests
        run: |
          cd backend/ShopifyAnalyticsApi.Tests
          dotnet test --logger "trx;LogFileName=test-results.trx"
      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: backend-test-results
          path: backend/ShopifyAnalyticsApi.Tests/TestResults/test-results.trx

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      - name: Run tests
        run: |
          cd frontend
          npm run test -- --coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install
      - name: Run E2E tests
        run: |
          cd frontend
          npm run test:e2e
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
```

---

## ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã®è¨˜éŒ²

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨˜éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

| æ—¥ä»˜ | ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ« | å®Ÿè¡Œè€… | åˆæ ¼/å¤±æ•— | ã‚«ãƒãƒ¬ãƒƒã‚¸ | å‚™è€ƒ |
|------|------------|--------|----------|-----------|------|
| 2025-10-25 | å˜ä½“ãƒ†ã‚¹ãƒˆ | Devin | 45/45 | 85% | ã™ã¹ã¦åˆæ ¼ |
| 2025-10-25 | çµ±åˆãƒ†ã‚¹ãƒˆ | Devin | 12/12 | 100% | ã™ã¹ã¦åˆæ ¼ |
| 2025-10-25 | E2Eãƒ†ã‚¹ãƒˆ | Devin | 8/8 | 100% | ã™ã¹ã¦åˆæ ¼ |

---

## ğŸ› ãƒã‚°è¿½è·¡

### ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```markdown
## ãƒã‚°æ¦‚è¦
[ãƒã‚°ã®ç°¡æ½”ãªèª¬æ˜]

## å†ç¾æ‰‹é †
1. [æ‰‹é †1]
2. [æ‰‹é †2]
3. [æ‰‹é †3]

## æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ
[æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã®èª¬æ˜]

## å®Ÿéš›ã®å‹•ä½œ
[å®Ÿéš›ã«ç™ºç”Ÿã—ãŸå‹•ä½œã®èª¬æ˜]

## ç’°å¢ƒ
- OS: [ä¾‹: Windows 11]
- ãƒ–ãƒ©ã‚¦ã‚¶: [ä¾‹: Chrome 120]
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: [ä¾‹: .NET 8.0]

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
[è©²å½“ã™ã‚‹å ´åˆã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ·»ä»˜]

## è¿½åŠ æƒ…å ±
[ãã®ä»–ã®é–¢é€£æƒ…å ±]
```

---

## ğŸ“‹ å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|-----------|---------|--------|
| 2025-10-25 | 1.0 | åˆç‰ˆä½œæˆ | Devin |
