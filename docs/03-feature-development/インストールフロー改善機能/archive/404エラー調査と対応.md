# 404エラー調査と対応

## 問題の概要

インストールフローからストア選択後に404エラーが発生している。

## 調査結果

### 1. AllAllowedモードの問題

**現象**:
- バックエンドログに`AllAllowed mode enabled`が表示されている
- しかし、コードベースには`AllAllowed`のケースが存在しない

**原因**:
- デプロイされたバージョンが古い可能性が高い
- `appsettings.Development.json`では`"Mode": "DemoAllowed"`に設定されているが、デプロイされたバージョンが反映されていない可能性

**対応**:
1. バックエンドを再デプロイして最新コードを反映
2. デプロイ後にログを確認し、`AllAllowed mode enabled`が表示されないことを確認

### 2. 404エラーの原因

**現象**:
- Shopify App BridgeのリダイレクトURLで404エラーが発生
- URL形式: `https://admin.shopify.com/store/xn-fbkq6e5da0fpb/apps/2d7e0e1mJrcTZLNWRhMGZwYg&shop=xn-fbkq6e5da0fpb.myshopify.com&timestamp=1766764194`

**原因の可能性**:
1. `/setup/initial`ページが存在するが、Shopify App BridgeのリダイレクトURLが正しく処理されていない
2. `auth/success/page.tsx`で`/setup/initial`にリダイレクトしているが、Shopify App Bridgeの埋め込みアプリコンテキストで正しく動作していない可能性

**確認事項**:
- `/setup/initial`ページは存在する（`frontend/src/app/setup/initial/page.tsx`）
- `auth/success/page.tsx`では`router.replace(redirectPath)`を使用してリダイレクトしている
- Shopify App Bridgeの埋め込みアプリコンテキストで`router.replace`が正しく動作するか確認が必要

**対応方針**:
1. `auth/success/page.tsx`でShopify App Bridgeの`Redirect.toApp()`を使用してリダイレクトするように修正
2. 埋め込みアプリコンテキストで正しく動作するように、`host`パラメータを維持してリダイレクト

## 修正方針

### 修正1: auth/success/page.tsxのリダイレクト処理を改善

```typescript
// 現在の実装
router.replace(redirectPath);

// 修正案: Shopify App Bridgeを使用してリダイレクト
if (host && app) {
  // 埋め込みアプリコンテキストの場合、App Bridgeを使用
  app.dispatch(Redirect.toApp({ path: redirectPath }));
} else {
  // 通常のブラウザリダイレクト
  router.replace(redirectPath);
}
```

### 修正2: バックエンドの再デプロイ

1. 最新のコードがデプロイされていることを確認
2. `appsettings.Development.json`の`Authentication.Mode`が`DemoAllowed`であることを確認
3. デプロイ後にログを確認し、`AllAllowed mode enabled`が表示されないことを確認

## 次のステップ

1. バックエンドを再デプロイ
2. `auth/success/page.tsx`のリダイレクト処理を修正
3. テストして404エラーが解消されることを確認
