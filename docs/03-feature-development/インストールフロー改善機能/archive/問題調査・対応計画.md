# インストールフロー問題 調査・対応計画

## 作成日
2025-12-26

## 概要
「認証状態を確認中...」画面から進まない問題について、本格的な調査と対応を行うための計画書です。

---

## 📋 問題の整理

### 症状
1. ルートページ（`/`）で「認証状態を確認中...」と表示されたまま進まない
2. `Stores`テーブルにレコードが作成されない
3. 401エラーが発生する（`/api/store`、`/api/subscription/status`など）

### 既存の対応
- `SubscriptionContext`を修正して、ルートページ（`/`）とインストールページ（`/install`）ではAPIを呼び出さないようにした
- しかし、問題は解決していない

---

## 🔍 調査計画

### Phase 1: 現状の把握

#### 1.1 ログの収集

**フロントエンド**:
- [ ] ブラウザのコンソールログを確認
- [ ] ネットワークタブでリクエスト/レスポンスを確認
- [ ] `localStorage`、`sessionStorage`の内容を確認

**バックエンド**:
- [ ] Application Insightsのログを確認
- [ ] `/api/shopify/install`へのリクエストログを確認
- [ ] `/api/shopify/callback`へのリクエストログを確認
- [ ] `SaveOrUpdateStore()`の実行ログを確認

#### 1.2 OAuth認証フローの追跡

**確認項目**:
- [ ] ユーザーが「接続を開始」ボタンをクリックした時点のログ
- [ ] バックエンドの`/api/shopify/install`にリクエストが到達しているか
- [ ] OAuth URLが正しく生成されているか
- [ ] Shopify OAuth認証画面が表示されているか
- [ ] ユーザーが権限を承認した後のリダイレクト先
- [ ] フロントエンドの`/api/shopify/callback`にリクエストが到達しているか
- [ ] バックエンドの`/api/shopify/callback`にリクエストが到達しているか
- [ ] `SaveOrUpdateStore()`が実行されているか
- [ ] データベースにレコードが作成されているか

#### 1.3 認証状態の初期化の確認

**確認項目**:
- [ ] `AuthProvider`の`isInitializing`が`false`になるか
- [ ] `AuthProvider`の`isApiClientReady`が`true`になるか
- [ ] `AuthProvider`の`isAuthenticated`が`true`になるか
- [ ] App Bridgeセッショントークンが取得できているか（埋め込みアプリの場合）

---

### Phase 2: 根本原因の特定

#### 2.1 OAuth認証フローが完了していない場合

**考えられる原因**:
1. バックエンドの`/api/shopify/install`にリクエストが到達していない
   - ネットワークエラー
   - CORSエラー
   - リダイレクトが正しく実行されていない

2. OAuth URLが正しく生成されていない
   - API Key/Secretの設定が間違っている
   - `redirect_uri`が正しく設定されていない
   - Shopify Partners Dashboardの設定が間違っている

3. バックエンドの`/api/shopify/callback`にリクエストが到達していない
   - `redirect_uri`がShopify Partners Dashboardに登録されていない
   - フロントエンドの`/api/shopify/callback`が正しく動作していない

4. `SaveOrUpdateStore()`が実行されていない
   - エラーが発生している
   - データベースへの接続が失敗している

#### 2.2 認証状態の初期化が完了しない場合

**考えられる原因**:
1. App Bridgeセッショントークンが取得できていない（埋め込みアプリの場合）
   - App Bridgeが正しく初期化されていない
   - `host`パラメータが正しく設定されていない

2. OAuth認証フラグが設定されていない（スタンドアロンアプリの場合）
   - `localStorage`の`oauth_authenticated`が`true`になっていない
   - `/auth/success`ページが正しく動作していない

3. APIクライアントの初期化が失敗している
   - `ApiClient`のコンストラクタでエラーが発生している

---

### Phase 3: 対応策の検討

#### 3.1 OAuth認証フローの修正

**対応策**:
1. バックエンドのログを強化
   - 各ステップでログを出力
   - エラー発生時にスタックトレースを出力

2. フロントエンドのエラーハンドリングを強化
   - リダイレクト失敗時のエラーメッセージを表示
   - タイムアウト処理を追加

3. Shopify Partners Dashboard設定の確認
   - Redirect URLsが正しく設定されているか
   - Required scopesが正しく設定されているか

#### 3.2 認証状態の初期化の修正

**対応策**:
1. `AuthProvider`の初期化ロジックを改善
   - タイムアウト処理を追加
   - エラー発生時のフォールバック処理を追加

2. デバッグログの追加
   - 各ステップでログを出力
   - 状態遷移を可視化

---

## 🛠️ 実装手順

### Step 1: ログの強化

1. バックエンドのログを強化
   - `ShopifyAuthController.cs`の各メソッドにログを追加
   - `SaveOrUpdateStore()`の実行前後でログを出力

2. フロントエンドのログを強化
   - `AuthProvider`の各ステップでログを出力
   - ルートページのリダイレクト処理でログを出力

### Step 2: デバッグツールの追加

1. フロントエンドにデバッグページを追加
   - 認証状態の可視化
   - `localStorage`、`sessionStorage`の内容表示
   - API呼び出しの履歴表示

2. バックエンドにデバッグエンドポイントを追加
   - OAuth認証フローの状態確認
   - データベースの状態確認

### Step 3: 問題の再現と検証

1. 開発環境で問題を再現
2. ログを確認して原因を特定
3. 修正を実装
4. 動作確認

---

## 📊 調査結果の記録

### 調査結果テンプレート

```markdown
## 調査結果: [日付]

### 確認した項目
- [ ] 項目1
- [ ] 項目2

### 発見した問題
1. 問題1の説明
2. 問題2の説明

### 根本原因
- 原因1の説明
- 原因2の説明

### 対応策
- 対応策1の説明
- 対応策2の説明

### 次のステップ
- [ ] ステップ1
- [ ] ステップ2
```

---

## 📝 参考資料

- [現状のインストール機能設計書](./現状のインストール機能設計書.md)
- [インストール関連ソースファイル一覧](../../../05-development/08-デバッグ・トラブル/01-problem-analysis/2025-12/インストール関連ソースファイル一覧.md)
- [Shopify OAuth認証ドキュメント](https://shopify.dev/docs/apps/auth/oauth)

---

## 🔄 更新履歴

- 2025-12-26: 初版作成
