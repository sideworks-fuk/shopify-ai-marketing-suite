# Shopify ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼æ”¹å–„æ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»æ›¸

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Shopifyã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼æ”¹å–„æ©Ÿèƒ½ã®å®Ÿè£…è¨ˆç”»ã‚’å®šç¾©ã—ã¾ã™ã€‚æ®µéšçš„ãªå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãªãŒã‚‰ç¢ºå®Ÿã«æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ¯ å®Ÿè£…ç›®æ¨™

### ä¸»è¦ç›®æ¨™
1. åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè£…
2. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã®è‡ªå‹•æ¤œå‡ºã¨é©åˆ‡ãªãƒ•ãƒ­ãƒ¼åˆ†å²
3. ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ›´æ™‚ã®è‡ªå‹•å†èªè¨¼ãƒ•ãƒ­ãƒ¼
4. App Bridgeã‚’ä½¿ç”¨ã—ãŸãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
5. æ—¢å­˜æ©Ÿèƒ½ã¨ã®äº’æ›æ€§ç¶­æŒ

### æˆåŠŸåŸºæº–
- ã™ã¹ã¦ã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- E2Eãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ãªã—

---

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Phase 0: æº–å‚™ãƒ»ç’°å¢ƒæ§‹ç¯‰ï¼ˆ1æ—¥ï¼‰
**ç›®æ¨™**: é–‹ç™ºç’°å¢ƒã®æº–å‚™ã¨ãƒ–ãƒ©ãƒ³ãƒä½œæˆ

**ã‚¿ã‚¹ã‚¯**:
- [ ] é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ
- [ ] ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèªãƒ»æ›´æ–°
- [ ] é–‹ç™ºç’°å¢ƒã®å‹•ä½œç¢ºèª
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™

**æˆæœç‰©**:
- é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒ: `feature/install-flow-improvement`
- ç’°å¢ƒæ§‹ç¯‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

---

### Phase 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤å®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

#### 1.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ
**ç›®æ¨™**: Storesãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¹ã‚³ãƒ¼ãƒ—æƒ…å ±ã‚’è¿½åŠ 

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
- [ ] Storesãƒ†ãƒ¼ãƒ–ãƒ«ã«`Scopes`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
- [ ] Entityã‚¯ãƒ©ã‚¹ã®æ›´æ–°

**å®Ÿè£…è©³ç´°**:

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«**: `Migrations/YYYYMMDDHHMMSS_AddScopesToStores.cs`
```csharp
using Microsoft.EntityFrameworkCore.Migrations;

public partial class AddScopesToStores : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<string>(
            name: "Scopes",
            table: "Stores",
            type: "nvarchar(500)",
            maxLength: 500,
            nullable: true);

        migrationBuilder.CreateIndex(
            name: "IX_Stores_Domain",
            table: "Stores",
            column: "Domain");

        migrationBuilder.CreateIndex(
            name: "IX_Stores_InstalledAt",
            table: "Stores",
            column: "InstalledAt");
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropIndex(
            name: "IX_Stores_Domain",
            table: "Stores");

        migrationBuilder.DropIndex(
            name: "IX_Stores_InstalledAt",
            table: "Stores");

        migrationBuilder.DropColumn(
            name: "Scopes",
            table: "Stores");
    }
}
```

**Entityã‚¯ãƒ©ã‚¹æ›´æ–°**: `Models/Store.cs`
```csharp
public class Store
{
    public Guid Id { get; set; }
    
    [Required]
    [MaxLength(100)]
    public string Domain { get; set; } = string.Empty;
    
    [Required]
    [MaxLength(500)]
    public string AccessToken { get; set; } = string.Empty;
    
    [MaxLength(500)]
    public string? Scopes { get; set; } // æ–°è¦è¿½åŠ 
    
    [MaxLength(200)]
    public string? ShopName { get; set; }
    
    [MaxLength(200)]
    public string? Email { get; set; }
    
    public DateTime InstalledAt { get; set; }
    
    public DateTime UpdatedAt { get; set; }
}
```

**æ¤œè¨¼**:
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
- [ ] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãŒãªã„
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã‚‹

---

#### 1.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…
**ç›®æ¨™**: ã‚·ãƒ§ãƒƒãƒ—åˆ—æŒ™æ”»æ’ƒã‚’é˜²æ­¢ã™ã‚‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½

**ã‚¿ã‚¹ã‚¯**:
- [ ] RateLimiterã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
- [ ] åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè£…
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ

**å®Ÿè£…è©³ç´°**:

**ã‚µãƒ¼ãƒ“ã‚¹**: `Services/RateLimiter.cs`
```csharp
public interface IRateLimiter
{
    Task<bool> CheckRateLimitAsync(string key, int maxRequests, TimeSpan window);
    Task<RateLimitInfo> GetRateLimitInfoAsync(string key);
}

public class RateLimitInfo
{
    public int CurrentCount { get; set; }
    public int MaxRequests { get; set; }
    public TimeSpan? ResetIn { get; set; }
}

public class RateLimiter : IRateLimiter
{
    private readonly IDistributedCache _cache;
    private readonly ILogger<RateLimiter> _logger;

    public RateLimiter(IDistributedCache cache, ILogger<RateLimiter> logger)
    {
        _cache = cache;
        _logger = logger;
    }

    public async Task<bool> CheckRateLimitAsync(string key, int maxRequests, TimeSpan window)
    {
        var cacheKey = $"ratelimit_{key}";
        var currentCount = await GetCurrentCountAsync(cacheKey);

        if (currentCount >= maxRequests)
        {
            _logger.LogWarning("ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é: {Key}, Count: {Count}, Max: {Max}", 
                key, currentCount, maxRequests);
            return false;
        }

        await IncrementCountAsync(cacheKey, window);
        return true;
    }

    public async Task<RateLimitInfo> GetRateLimitInfoAsync(string key)
    {
        var cacheKey = $"ratelimit_{key}";
        var currentCount = await GetCurrentCountAsync(cacheKey);
        
        // TTLã‚’å–å¾—ï¼ˆå®Ÿè£…ã¯ç’°å¢ƒä¾å­˜ï¼‰
        return new RateLimitInfo
        {
            CurrentCount = currentCount,
            MaxRequests = 0, // å‘¼ã³å‡ºã—å…ƒã§è¨­å®š
            ResetIn = null // å®Ÿè£…ã«ã‚ˆã‚Šå–å¾—å¯èƒ½
        };
    }

    private async Task<int> GetCurrentCountAsync(string key)
    {
        var value = await _cache.GetStringAsync(key);
        return value != null ? int.Parse(value) : 0;
    }

    private async Task IncrementCountAsync(string key, TimeSpan expiry)
    {
        var currentCount = await GetCurrentCountAsync(key);
        var newCount = currentCount + 1;
        
        await _cache.SetStringAsync(
            key, 
            newCount.ToString(), 
            new DistributedCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = expiry
            });
    }
}
```

**DIç™»éŒ²**: `Program.cs`
```csharp
// åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
builder.Services.AddStackExchangeRedisCache(options =>
{
    options.Configuration = builder.Configuration.GetConnectionString("Redis");
    options.InstanceName = "ShopifyApp_";
});

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚µãƒ¼ãƒ“ã‚¹ã®ç™»éŒ²
builder.Services.AddSingleton<IRateLimiter, RateLimiter>();
```

**æ¤œè¨¼**:
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã™ã‚‹
- [ ] åˆ¶é™è¶…éæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã™ã‚‹

---

#### 1.3 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯APIã®å®Ÿè£…
**ç›®æ¨™**: ã‚·ãƒ§ãƒƒãƒ—ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã¨ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç¢ºèªã™ã‚‹API

**ã‚¿ã‚¹ã‚¯**:
- [ ] `/api/shopify/status` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®çµ±åˆ
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ

**å®Ÿè£…è©³ç´°**:

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼**: `Controllers/ShopifyAuthController.cs`
```csharp
[HttpGet("status")]
[AllowAnonymous]
public async Task<IActionResult> GetInstallationStatus([FromQuery] string shop)
{
    try
    {
        // ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼
        if (string.IsNullOrWhiteSpace(shop) || !_oauthService.IsValidShopDomain(shop))
        {
            _logger.LogWarning("ç„¡åŠ¹ãªã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³: {Shop}", shop);
            return BadRequest(new { error = "Invalid shop domain" });
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆã‚·ãƒ§ãƒƒãƒ—ã”ã¨ï¼‰
        var shopRateLimitKey = $"status_check_shop_{shop}";
        if (!await _rateLimiter.CheckRateLimitAsync(shopRateLimitKey, 10, TimeSpan.FromMinutes(1)))
        {
            _logger.LogWarning("ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éï¼ˆã‚·ãƒ§ãƒƒãƒ—ï¼‰: {Shop}", shop);
            return StatusCode(429, new { error = "Rate limit exceeded" });
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
        var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
        var ipRateLimitKey = $"status_check_ip_{ipAddress}";
        if (!await _rateLimiter.CheckRateLimitAsync(ipRateLimitKey, 50, TimeSpan.FromMinutes(1)))
        {
            _logger.LogWarning("ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éï¼ˆIPï¼‰: {IP}", ipAddress);
            return StatusCode(429, new { error = "Rate limit exceeded" });
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’å–å¾—
        var store = await _context.Stores
            .AsNoTracking()
            .FirstOrDefaultAsync(s => s.Domain == shop);

        if (store == null)
        {
            // æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            var installUrl = GenerateInstallUrl(shop, null);
            return Ok(new
            {
                installed = false,
                installUrl = installUrl,
                message = "App not installed for this shop"
            });
        }

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ - ã‚¹ã‚³ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯
        var requiredScopes = GetRequiredScopes();
        var currentScopes = ParseScopes(store.Scopes);
        var missingScopes = requiredScopes.Except(currentScopes).ToList();

        if (missingScopes.Any())
        {
            // ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ - å†èªè¨¼ãŒå¿…è¦
            var reauthUrl = GenerateInstallUrl(shop, requiredScopes);
            return Ok(new
            {
                installed = true,
                scopesValid = false,
                missingScopes = missingScopes,
                reauthUrl = reauthUrl,
                message = "App requires additional permissions"
            });
        }

        // ã™ã¹ã¦æ­£å¸¸
        return Ok(new
        {
            installed = true,
            scopesValid = true,
            message = "App is properly installed"
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {Shop}", shop);
        return StatusCode(500, new { error = "Internal server error" });
    }
}

private HashSet<string> GetRequiredScopes()
{
    var scopesString = _configuration["Shopify:Scopes"] ?? "read_orders,read_products,read_customers";
    return scopesString.Split(',')
        .Select(s => s.Trim())
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToHashSet();
}

private HashSet<string> ParseScopes(string? scopesString)
{
    if (string.IsNullOrWhiteSpace(scopesString))
        return new HashSet<string>();
    
    return scopesString.Split(',')
        .Select(s => s.Trim())
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .ToHashSet();
}

private string GenerateInstallUrl(string shop, HashSet<string>? scopes)
{
    var baseUrl = _configuration["Frontend:BaseUrl"];
    var scopesParam = scopes != null 
        ? string.Join(",", scopes) 
        : _configuration["Shopify:Scopes"];
    
    return $"{baseUrl}/api/shopify/install?shop={Uri.EscapeDataString(shop)}&scopes={Uri.EscapeDataString(scopesParam)}";
}
```

**æ¤œè¨¼**:
- [ ] æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ã‚·ãƒ§ãƒƒãƒ—ã§æ­£ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§æ­£å¸¸ãªã‚·ãƒ§ãƒƒãƒ—ã§æ­£ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ã®ã‚·ãƒ§ãƒƒãƒ—ã§æ­£ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã™ã‚‹

---

#### 1.4 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ”¹ä¿®
**ç›®æ¨™**: hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å—ã‘å–ã‚Šã¨ä¿æŒ

**ã‚¿ã‚¹ã‚¯**:
- [ ] `Install` ãƒ¡ã‚½ãƒƒãƒ‰ã®æ”¹ä¿®
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [ ] OAuthStateDataã‚¯ãƒ©ã‚¹ã®ä½œæˆ
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®æ›´æ–°

**å®Ÿè£…è©³ç´°**:

**ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹**: `Models/OAuthStateData.cs`
```csharp
public class OAuthStateData
{
    public string Shop { get; set; } = string.Empty;
    public string? Host { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ”¹ä¿®**: `Controllers/ShopifyAuthController.cs`
```csharp
[HttpGet("install")]
[AllowAnonymous]
public IActionResult Install(
    [FromQuery] string shop,
    [FromQuery] string? host = null,
    [FromQuery] string? scopes = null)
{
    try
    {
        // ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼
        if (string.IsNullOrWhiteSpace(shop) || !_oauthService.IsValidShopDomain(shop))
        {
            _logger.LogWarning("ç„¡åŠ¹ãªã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³: {Shop}", shop);
            return BadRequest(new { error = "Invalid shop domain" });
        }

        // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if (!string.IsNullOrWhiteSpace(host) && !IsValidHostParameter(host))
        {
            _logger.LogWarning("ç„¡åŠ¹ãªhostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: {Host}", host);
            return BadRequest(new { error = "Invalid host parameter" });
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
        var rateLimitKey = $"install_{shop}";
        if (!_rateLimiter.CheckRateLimitAsync(rateLimitKey, 5, TimeSpan.FromMinutes(1)).Result)
        {
            _logger.LogWarning("ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é: {Shop}", shop);
            return StatusCode(429, new { error = "Rate limit exceeded" });
        }

        // CSRFå¯¾ç­–ç”¨ã®stateã‚’ç”Ÿæˆ
        var state = GenerateRandomString(32);
        var cacheKey = $"{StateCacheKeyPrefix}{state}";
        
        // stateã¨hostã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ10åˆ†é–“æœ‰åŠ¹ï¼‰
        var stateData = new OAuthStateData
        {
            Shop = shop,
            Host = host,
            CreatedAt = DateTime.UtcNow
        };
        _cache.Set(cacheKey, stateData, TimeSpan.FromMinutes(StateExpirationMinutes));
        
        _logger.LogInformation("OAuthèªè¨¼é–‹å§‹. Shop: {Shop}, State: {State}, Host: {Host}", 
            shop, state, host != null ? "present" : "null");

        // Shopify OAuth URLã‚’æ§‹ç¯‰
        var apiKey = GetShopifySetting("ApiKey");
        var scopesParam = scopes ?? GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
        var redirectUri = GetRedirectUri();

        var authUrl = $"https://{shop}/admin/oauth/authorize" +
            $"?client_id={apiKey}" +
            $"&scope={scopesParam}" +
            $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
            $"&state={state}";

        // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€Shopifyã«æ¸¡ã™
        if (!string.IsNullOrWhiteSpace(host))
        {
            authUrl += $"&host={Uri.EscapeDataString(host)}";
        }

        // Shopifyã®èªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        return Redirect(authUrl);
    }
    catch (Exception ex)
    {
        return HandleOAuthError(ex, shop, "Install");
    }
}

private bool IsValidHostParameter(string host)
{
    try
    {
        // base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
        var decoded = Convert.FromBase64String(host);
        var decodedString = Encoding.UTF8.GetString(decoded);
        
        // ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®æ–‡å­—åˆ—ã«ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (!decodedString.Contains(".myshopify.com"))
            return false;

        // é•·ã•ãƒã‚§ãƒƒã‚¯
        if (host.Length > 500)
            return false;

        return true;
    }
    catch
    {
        return false;
    }
}
```

**æ¤œè¨¼**:
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ã‚Šã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ä¸æ­£ãªhostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ‹’å¦ã™ã‚‹
- [ ] stateã¨hostãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã‚‹

---

#### 1.5 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ”¹ä¿®
**ç›®æ¨™**: hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¼æ’­ã¨ã‚¹ã‚³ãƒ¼ãƒ—ã®ä¿å­˜

**ã‚¿ã‚¹ã‚¯**:
- [ ] `Callback` ãƒ¡ã‚½ãƒƒãƒ‰ã®æ”¹ä¿®
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ 
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¼æ’­
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã®æ›´æ–°

**å®Ÿè£…è©³ç´°**:

**ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ”¹ä¿®**: `Controllers/ShopifyAuthController.cs`
```csharp
[HttpGet("callback")]
[AllowAnonymous]
public async Task<IActionResult> Callback(
    [FromQuery] string code,
    [FromQuery] string shop,
    [FromQuery] string state,
    [FromQuery] string? host = null,
    [FromQuery] string? hmac = null,
    [FromQuery] string? timestamp = null)
{
    try
    {
        _logger.LogInformation("OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å—ä¿¡. Shop: {Shop}, State: {State}, Host: {Host}", 
            shop, state, host != null ? "present" : "null");

        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
        if (string.IsNullOrWhiteSpace(code) || 
            string.IsNullOrWhiteSpace(shop) || 
            string.IsNullOrWhiteSpace(state))
        {
            _logger.LogWarning("å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
            return BadRequest(new { error = "Missing required parameters" });
        }

        // Stateæ¤œè¨¼ï¼ˆCSRFå¯¾ç­–ï¼‰
        var cacheKey = $"{StateCacheKeyPrefix}{state}";
        if (!_cache.TryGetValue<OAuthStateData>(cacheKey, out var stateData) || 
            stateData.Shop != shop)
        {
            _logger.LogWarning("ç„¡åŠ¹ãªstate. Shop: {Shop}, State: {State}", shop, state);
            return Unauthorized(new { error = "Invalid state parameter" });
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰stateã‚’å‰Šé™¤ï¼ˆä½¿ã„æ¨ã¦ï¼‰
        _cache.Remove(cacheKey);

        // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å„ªå…ˆé †ä½: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ > ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        var finalHost = host ?? stateData.Host;

        // HMACæ¤œè¨¼
        if (!string.IsNullOrWhiteSpace(hmac) && !string.IsNullOrWhiteSpace(timestamp))
        {
            var isDevelopment = _configuration["ASPNETCORE_ENVIRONMENT"] == "Development";
            var queryParams = HttpContext.Request.Query
                .Select(q => new KeyValuePair<string, StringValues>(q.Key, q.Value))
                .ToList();
            
            var isValidHmac = _oauthService.VerifyHmac(queryParams);
            
            if (!isValidHmac && !isDevelopment)
            {
                _logger.LogWarning("HMACæ¤œè¨¼å¤±æ•—. Shop: {Shop}", shop);
                return Unauthorized(new { error = "HMAC validation failed" });
            }
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        var accessToken = await ExchangeCodeForAccessTokenWithRetry(code, shop);
        if (string.IsNullOrWhiteSpace(accessToken))
        {
            _logger.LogError("ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—. Shop: {Shop}", shop);
            return StatusCode(500, new { error = "Failed to obtain access token" });
        }

        // ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’ä¿å­˜ãƒ»æ›´æ–°ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ã‚‚ä¿å­˜ï¼‰
        await SaveOrUpdateStore(shop, accessToken);

        // Webhookç™»éŒ²
        await RegisterWebhooks(shop, accessToken);

        _logger.LogInformation("OAuthèªè¨¼å®Œäº†. Shop: {Shop}", shop);

        // æˆåŠŸãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆhostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰
        var frontendUrl = _configuration["Frontend:BaseUrl"];
        var successUrl = $"{frontendUrl}/auth/success?shop={Uri.EscapeDataString(shop)}";
        
        if (!string.IsNullOrWhiteSpace(finalHost))
        {
            successUrl += $"&host={Uri.EscapeDataString(finalHost)}";
        }

        return Redirect(successUrl);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ. Shop: {Shop}", shop);
        
        var frontendUrl = _configuration["Frontend:BaseUrl"];
        var errorUrl = $"{frontendUrl}/auth/error?message={Uri.EscapeDataString(ex.Message)}";
        return Redirect(errorUrl);
    }
}

private async Task SaveOrUpdateStore(string shop, string accessToken)
{
    // Shopify APIã‹ã‚‰ã‚¹ãƒˆã‚¢æƒ…å ±ã‚’å–å¾—
    var shopInfo = await _shopifyService.GetShopInfoAsync(shop, accessToken);
    
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å–å¾—
    var scopes = await _shopifyService.GetTokenScopesAsync(shop, accessToken);
    
    var store = await _context.Stores.FirstOrDefaultAsync(s => s.Domain == shop);
    
    if (store == null)
    {
        // æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        store = new Store
        {
            Domain = shop,
            AccessToken = accessToken,
            Scopes = string.Join(",", scopes),
            ShopName = shopInfo.Name,
            Email = shopInfo.Email,
            InstalledAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
        _context.Stores.Add(store);
        _logger.LogInformation("æ–°è¦ã‚¹ãƒˆã‚¢ç™»éŒ². Shop: {Shop}, Scopes: {Scopes}", shop, store.Scopes);
    }
    else
    {
        // æ—¢å­˜ã‚¹ãƒˆã‚¢ã®æ›´æ–°
        store.AccessToken = accessToken;
        store.Scopes = string.Join(",", scopes);
        store.ShopName = shopInfo.Name;
        store.Email = shopInfo.Email;
        store.UpdatedAt = DateTime.UtcNow;
        _logger.LogInformation("ã‚¹ãƒˆã‚¢æƒ…å ±æ›´æ–°. Shop: {Shop}, Scopes: {Scopes}", shop, store.Scopes);
    }
    
    await _context.SaveChangesAsync();
}
```

**Shopifyã‚µãƒ¼ãƒ“ã‚¹æ‹¡å¼µ**: `Services/ShopifyService.cs`
```csharp
public async Task<List<string>> GetTokenScopesAsync(string shop, string accessToken)
{
    try
    {
        // Shopify APIã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å–å¾—
        var service = new AccessScopeService(shop, accessToken);
        var scopes = await service.ListAsync();
        
        return scopes.Select(s => s.Handle).ToList();
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "ã‚¹ã‚³ãƒ¼ãƒ—å–å¾—ã‚¨ãƒ©ãƒ¼: {Shop}", shop);
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—
        var configScopes = _configuration["Shopify:Scopes"] ?? "";
        return configScopes.Split(',').Select(s => s.Trim()).ToList();
    }
}
```

**æ¤œè¨¼**:
- [ ] ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã‚‹
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæˆåŠŸURLã«å«ã¾ã‚Œã‚‹
- [ ] WebhookãŒç™»éŒ²ã•ã‚Œã‚‹

---

### Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

#### 2.1 App Bridgeãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®å®Ÿè£…
**ç›®æ¨™**: App Bridgeã®åˆæœŸåŒ–ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

**ã‚¿ã‚¹ã‚¯**:
- [ ] AppBridgeProviderã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ
- [ ] useAppBridgeãƒ•ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æ©Ÿèƒ½
- [ ] ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½

**å®Ÿè£…è©³ç´°**:

**ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: `frontend/src/components/providers/AppBridgeProvider.tsx`
```typescript
'use client';

import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import createApp from '@shopify/app-bridge';
import { getSessionToken } from '@shopify/app-bridge/utilities';
import { Redirect } from '@shopify/app-bridge/actions';

interface AppBridgeContextType {
  app: any | null;
  isEmbedded: boolean;
  getToken: () => Promise<string>;
  redirectToUrl: (url: string) => void;
  extractShopFromToken: (token: string) => string | null;
}

const AppBridgeContext = createContext<AppBridgeContextType | null>(null);

export function AppBridgeProvider({ children }: { children: ReactNode }) {
  const [app, setApp] = useState<any | null>(null);
  const [isEmbedded, setIsEmbedded] = useState(false);

  useEffect(() => {
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰hostã‚’å–å¾—
    const params = new URLSearchParams(window.location.search);
    const host = params.get('host');

    if (host) {
      // åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã¨ã—ã¦åˆæœŸåŒ–
      const apiKey = process.env.NEXT_PUBLIC_SHOPIFY_API_KEY;
      
      if (!apiKey) {
        console.error('âŒ NEXT_PUBLIC_SHOPIFY_API_KEY is not defined');
        return;
      }

      try {
        const appInstance = createApp({
          apiKey: apiKey,
          host: host,
        });

        setApp(appInstance);
        setIsEmbedded(true);
        
        console.log('âœ… App BridgeåˆæœŸåŒ–æˆåŠŸ', { host });
      } catch (error) {
        console.error('âŒ App BridgeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    } else {
      console.log('â„¹ï¸ éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆhostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ï¼‰');
      setIsEmbedded(false);
    }
  }, []);

  const getToken = async (): Promise<string> => {
    if (!app) {
      throw new Error('App Bridge is not initialized');
    }

    try {
      const token = await getSessionToken(app);
      console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ');
      return token;
    } catch (error) {
      console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }
  };

  const redirectToUrl = (url: string) => {
    console.log('ğŸ”„ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:', { url, isEmbedded });
    
    if (app && isEmbedded) {
      // åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã®å ´åˆã€App Bridgeã§ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      try {
        const redirect = Redirect.create(app);
        redirect.dispatch(Redirect.Action.REMOTE, url);
        console.log('âœ… App Bridge ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ');
      } catch (error) {
        console.error('âŒ App Bridge ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        window.top!.location.href = url;
      }
    } else {
      // éåŸ‹ã‚è¾¼ã¿ã®å ´åˆã€é€šå¸¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      window.location.href = url;
    }
  };

  const extractShopFromToken = (token: string): string | null => {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      const dest = payload.dest;
      
      if (!dest) return null;
      
      // "https://my-store.myshopify.com" -> "my-store.myshopify.com"
      return dest.replace('https://', '').replace('http://', '');
    } catch (error) {
      console.error('âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ã‚·ãƒ§ãƒƒãƒ—æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  };

  return (
    <AppBridgeContext.Provider value={{ 
      app, 
      isEmbedded, 
      getToken, 
      redirectToUrl,
      extractShopFromToken 
    }}>
      {children}
    </AppBridgeContext.Provider>
  );
}

export function useAppBridge() {
  const context = useContext(AppBridgeContext);
  if (!context) {
    throw new Error('useAppBridge must be used within AppBridgeProvider');
  }
  return context;
}
```

**ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ã®çµ±åˆ**: `frontend/src/app/layout.tsx`
```typescript
import { AppBridgeProvider } from '@/components/providers/AppBridgeProvider';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <AppBridgeProvider>
          {children}
        </AppBridgeProvider>
      </body>
    </html>
  );
}
```

**æ¤œè¨¼**:
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€App BridgeãŒåˆæœŸåŒ–ã•ã‚Œã‚‹
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã‚‹
- [ ] ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚æ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

#### 2.2 AuthGuardã®æ”¹ä¿®
**ç›®æ¨™**: è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
- [ ] AuthGuardã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ”¹ä¿®
- [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯APIã®çµ±åˆ
- [ ] è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®å®Ÿè£…

**å®Ÿè£…è©³ç´°**:

**AuthGuard**: `frontend/src/components/auth/AuthGuard.tsx`
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';
import { useAppBridge } from '@/components/providers/AppBridgeProvider';
import { getCurrentEnvironmentConfig } from '@/lib/config/environments';
import AuthenticationRequired from '@/components/errors/AuthenticationRequired';
import { Spinner, Frame } from '@shopify/polaris';

interface InstallationStatus {
  installed: boolean;
  scopesValid?: boolean;
  missingScopes?: string[];
  installUrl?: string;
  reauthUrl?: string;
  message: string;
}

export function AuthGuard({ children }: { children: React.ReactNode }) {
  const searchParams = useSearchParams();
  const { isEmbedded, getToken, redirectToUrl, extractShopFromToken } = useAppBridge();
  const [isChecking, setIsChecking] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isDemoMode, setIsDemoMode] = useState(false);
  const [checkMessage, setCheckMessage] = useState('èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');

  useEffect(() => {
    const checkInstallation = async () => {
      try {
        // åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã®å ´åˆ
        if (isEmbedded) {
          console.log('ğŸ” åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒª: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
          setCheckMessage('Shopifyã‚¹ãƒˆã‚¢ã¨ã®æ¥ç¶šã‚’ç¢ºèªä¸­...');
          
          // App Bridgeã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          const sessionToken = await getToken();
          
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡º
          const shop = extractShopFromToken(sessionToken);

          if (!shop) {
            console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“');
            setIsAuthenticated(false);
            setIsChecking(false);
            return;
          }

          console.log('ğŸª ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³:', shop);
          setCheckMessage('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');

          // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          const config = getCurrentEnvironmentConfig();
          const statusResponse = await fetch(
            `${config.apiBaseUrl}/api/shopify/status?shop=${encodeURIComponent(shop)}`,
            {
              headers: {
                'Authorization': `Bearer ${sessionToken}`,
                'Content-Type': 'application/json'
              }
            }
          );

          if (!statusResponse.ok) {
            console.error('âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯API ã‚¨ãƒ©ãƒ¼:', statusResponse.status);
            setIsAuthenticated(false);
            setIsChecking(false);
            return;
          }

          const status: InstallationStatus = await statusResponse.json();
          console.log('ğŸ“Š ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹:', status);

          // æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ãŸã¯ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ã®å ´åˆ
          if (!status.installed) {
            console.log('ğŸ”„ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦');
            setCheckMessage('ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...');
            
            if (status.installUrl) {
              console.log('â†ªï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:', status.installUrl);
              
              // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
              const host = searchParams.get('host');
              const finalUrl = host 
                ? `${status.installUrl}&host=${encodeURIComponent(host)}`
                : status.installUrl;
              
              redirectToUrl(finalUrl);
            } else {
              console.error('âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«URLãŒå–å¾—ã§ãã¾ã›ã‚“');
              setIsAuthenticated(false);
            }
            
            setIsChecking(false);
            return;
          }

          if (!status.scopesValid) {
            console.log('ğŸ”„ å†èªè¨¼ãŒå¿…è¦ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ï¼‰');
            setCheckMessage('è¿½åŠ ã®æ¨©é™ã‚’è¦æ±‚ä¸­...');
            
            if (status.reauthUrl) {
              console.log('â†ªï¸ å†èªè¨¼URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:', status.reauthUrl);
              
              // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
              const host = searchParams.get('host');
              const finalUrl = host 
                ? `${status.reauthUrl}&host=${encodeURIComponent(host)}`
                : status.reauthUrl;
              
              redirectToUrl(finalUrl);
            } else {
              console.error('âŒ å†èªè¨¼URLãŒå–å¾—ã§ãã¾ã›ã‚“');
              setIsAuthenticated(false);
            }
            
            setIsChecking(false);
            return;
          }

          // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§æ­£å¸¸
          console.log('âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ»ã‚¹ã‚³ãƒ¼ãƒ—æ­£å¸¸');
          setIsAuthenticated(true);
        } else {
          // éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãªã©ï¼‰
          console.log('â„¹ï¸ éåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰: ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');
          setCheckMessage('èªè¨¼æƒ…å ±ã‚’ç¢ºèªä¸­...');
          
          const demoToken = localStorage.getItem('demo_token');
          if (demoToken) {
            console.log('âœ… ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰èªè¨¼æ¸ˆã¿');
            setIsDemoMode(true);
            setIsAuthenticated(true);
          } else {
            console.log('âŒ èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            setIsAuthenticated(false);
          }
        }
      } catch (error) {
        console.error('âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        setIsAuthenticated(false);
      } finally {
        setIsChecking(false);
      }
    };

    checkInstallation();
  }, [isEmbedded, getToken, redirectToUrl, extractShopFromToken, searchParams]);

  if (isChecking) {
    return (
      <Frame>
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          gap: '1rem'
        }}>
          <Spinner size="large" />
          <p>{checkMessage}</p>
        </div>
      </Frame>
    );
  }

  if (!isAuthenticated) {
    return <AuthenticationRequired />;
  }

  return (
    <>
      {isDemoMode && <DemoModeBanner />}
      {children}
    </>
  );
}

function DemoModeBanner() {
  return (
    <div style={{
      backgroundColor: '#FFF4E5',
      borderBottom: '1px solid #FFD79D',
      padding: '0.75rem',
      textAlign: 'center'
    }}>
      <strong>ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</strong> - èª­ã¿å–ã‚Šå°‚ç”¨ã§ã™
    </div>
  );
}
```

**æ¤œè¨¼**:
- [ ] åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- [ ] æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€è‡ªå‹•çš„ã«OAuthãƒ•ãƒ­ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ã®å ´åˆã€è‡ªå‹•çš„ã«å†èªè¨¼ãƒ•ãƒ­ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã€ã‚¢ãƒ—ãƒªãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

#### 2.3 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®æ”¹ä¿®
**ç›®æ¨™**: è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¨æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ã‚¿ã‚¹ã‚¯**:
- [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®æ”¹ä¿®
- [ ] è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
- [ ] UIã®æ”¹å–„

**å®Ÿè£…è©³ç´°**:

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸**: `frontend/src/app/install/page.tsx`
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';
import { useAppBridge } from '@/components/providers/AppBridgeProvider';
import { getCurrentEnvironmentConfig } from '@/lib/config/environments';
import {
  Page,
  Card,
  FormLayout,
  TextField,
  Button,
  Banner,
  Text,
  List,
  BlockStack,
  Box,
  Spinner,
  Frame,
} from '@shopify/polaris';

export default function InstallPage() {
  const searchParams = useSearchParams();
  const { isEmbedded, redirectToUrl } = useAppBridge();
  const [showManualForm, setShowManualForm] = useState(false);
  const [isRedirecting, setIsRedirecting] = useState(false);
  const [shopDomain, setShopDomain] = useState('');
  const [error, setError] = useState('');

  useEffect(() => {
    const autoRedirect = async () => {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰shopã¾ãŸã¯hostã‚’å–å¾—
      const shop = searchParams.get('shop');
      const host = searchParams.get('host');

      // shopã¾ãŸã¯hostãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹
      if (shop || host) {
        console.log('ğŸš€ è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹:', { shop, host });
        setIsRedirecting(true);

        const shopDomain = shop || extractShopFromHost(host);
        if (shopDomain) {
          const config = getCurrentEnvironmentConfig();
          let installUrl = `${config.apiBaseUrl}/api/shopify/install?shop=${encodeURIComponent(shopDomain)}`;
          
          // hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚‚å«ã‚ã‚‹
          if (host) {
            installUrl += `&host=${encodeURIComponent(host)}`;
          }

          console.log('ğŸ“ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ:', installUrl);

          // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦UXã‚’å‘ä¸Š
          setTimeout(() => {
            // åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã®å ´åˆã€App Bridgeã§ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            if (isEmbedded && host) {
              redirectToUrl(installUrl);
            } else {
              // é€šå¸¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
              window.location.href = installUrl;
            }
          }, 500);
          
          return;
        }
      }

      // shopã‚‚hostã‚‚ãªã„å ´åˆã®ã¿æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      console.log('â„¹ï¸ æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º');
      setShowManualForm(true);
    };

    autoRedirect();
  }, [searchParams, isEmbedded, redirectToUrl]);

  const handleInstall = async () => {
    setError('');

    if (!shopDomain.trim()) {
      setError('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (!validateShopDomain(shopDomain)) {
      setError('æœ‰åŠ¹ãªã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: my-storeï¼‰');
      return;
    }

    setIsRedirecting(true);

    const fullDomain = shopDomain.includes('.myshopify.com') 
      ? shopDomain 
      : `${shopDomain}.myshopify.com`;

    const config = getCurrentEnvironmentConfig();
    const installUrl = `${config.apiBaseUrl}/api/shopify/install?shop=${encodeURIComponent(fullDomain)}`;
    
    setTimeout(() => {
      window.location.href = installUrl;
    }, 500);
  };

  const validateShopDomain = (domain: string): boolean => {
    // è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿è¨±å¯
    const pattern = /^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]$/;
    return pattern.test(domain);
  };

  if (isRedirecting) {
    return (
      <Frame>
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          gap: '1rem'
        }}>
          <Spinner size="large" />
          <Text as="p" variant="bodyLg">Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­...</Text>
          <Text as="p" variant="bodySm" tone="subdued">
            Shopifyã®èªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™
          </Text>
        </div>
      </Frame>
    );
  }

  if (!showManualForm) {
    return (
      <Frame>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh'
        }}>
          <Spinner size="large" />
        </div>
      </Frame>
    );
  }

  // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ UI
  return (
    <div style={{ backgroundColor: '#F6F6F7', minHeight: '100vh' }}>
      <Box padding="800">
        <div style={{ maxWidth: '600px', margin: '0 auto' }}>
          <Page narrowWidth>
            <BlockStack gap="800">
              {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div style={{ textAlign: 'center' }}>
                <Box padding="400">
                  <div style={{ 
                    width: '56px', 
                    height: '56px', 
                    backgroundColor: '#008060',
                    borderRadius: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto'
                  }}>
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                      <path d="M21 4H7a2 2 0 0 0-2 2v2.5h0v6h0V20l6-1.5 6 1.5v-5.5h0v-6h0V6a2 2 0 0 0-2-2m-1 11.5c0 .5-.5 1-1 1s-1-.5-1-1V15h-2v.5c0 .5-.5 1-1 1s-1-.5-1-1V15h-2v.5c0 .5-.5 1-1 1s-1-.5-1-1V15H8v.5c0 .5-.5 1-1 1s-1-.5-1-1V9c0-.5.5-1 1-1s1 .5 1 1v.5h2V9c0-.5.5-1 1-1s1 .5 1 1v.5h2V9c0-.5.5-1 1-1s1 .5 1 1v.5h2V9c0-.5.5-1 1-1s1 .5 1 1v6.5M4 6H3v14h1c.6 0 1-.4 1-1V7c0-.6-.4-1-1-1z"/>
                    </svg>
                  </div>
                </Box>
                <Text as="h1" variant="heading2xl">
                  EC Ranger
                </Text>
                <Box paddingBlockStart="200">
                  <Text as="p" variant="bodyLg" tone="subdued">
                    Shopifyã‚¹ãƒˆã‚¢ã®å£²ä¸Šã‚’æœ€å¤§åŒ–ã™ã‚‹åˆ†æãƒ„ãƒ¼ãƒ«
                  </Text>
                </Box>
              </div>

              {/* èª¬æ˜ãƒãƒŠãƒ¼ */}
              <Banner tone="info">
                <p>
                  ã“ã®ãƒšãƒ¼ã‚¸ã¯é€šå¸¸ã€è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚
                  æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã«ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </p>
              </Banner>

              {/* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ  */}
              <Card>
                <BlockStack gap="400">
                  <FormLayout>
                    <TextField
                      label="ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³"
                      type="text"
                      value={shopDomain}
                      onChange={setShopDomain}
                      placeholder="your-store"
                      suffix=".myshopify.com"
                      autoComplete="off"
                      error={error}
                      helpText="ä¾‹: your-store-nameï¼ˆ.myshopify.comã¯è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ï¼‰"
                    />
                  </FormLayout>

                  <Button
                    variant="primary"
                    size="large"
                    fullWidth
                    onClick={handleInstall}
                    disabled={!shopDomain.trim()}
                  >
                    ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                  </Button>
                </BlockStack>
              </Card>

              {/* æ©Ÿèƒ½èª¬æ˜ */}
              <Card>
                <BlockStack gap="400">
                  <Text as="h2" variant="headingMd">
                    ã“ã®ã‚¢ãƒ—ãƒªã§ã§ãã‚‹ã“ã¨
                  </Text>
                  <List type="bullet">
                    <List.Item>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®AIåˆ†æ</List.Item>
                    <List.Item>é¡§å®¢è¡Œå‹•ã®è©³ç´°ãªåˆ†æ</List.Item>
                    <List.Item>å•†å“ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å¯è¦–åŒ–</List.Item>
                    <List.Item>ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ã®æœ€é©åŒ–ææ¡ˆ</List.Item>
                  </List>
                </BlockStack>
              </Card>

              {/* å¿…è¦ãªæ¨©é™ */}
              <Card>
                <BlockStack gap="400">
                  <Text as="h2" variant="headingMd">
                    å¿…è¦ãªæ¨©é™
                  </Text>
                  <List type="bullet">
                    <List.Item>æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š</List.Item>
                    <List.Item>å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š</List.Item>
                    <List.Item>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Š</List.Item>
                  </List>
                  <Text as="p" variant="bodySm" tone="subdued">
                    ã“ã‚Œã‚‰ã®æ¨©é™ã¯åˆ†ææ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
                    ãƒ‡ãƒ¼ã‚¿ã¯å®‰å…¨ã«ä¿è­·ã•ã‚Œã€ç¬¬ä¸‰è€…ã¨å…±æœ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                  </Text>
                </BlockStack>
              </Card>
            </BlockStack>
          </Page>
        </div>
      </Box>
    </div>
  );
}

function extractShopFromHost(host: string | null): string | null {
  if (!host) return null;
  try {
    const decoded = atob(host);
    const match = decoded.match(/([^/]+\.myshopify\.com)/);
    return match ? match[1] : null;
  } catch {
    return null;
  }
}
```

**æ¤œè¨¼**:
- [ ] shopãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- [ ] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] UIãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹

---

### Phase 3: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆï¼ˆ2-3æ—¥ï¼‰

#### 3.1 å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ
**ç›®æ¨™**: ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å˜ä½“ãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆä¾‹**: `Tests/Controllers/ShopifyAuthControllerTests.cs`
```csharp
[Fact]
public async Task GetInstallationStatus_UninstalledShop_ReturnsCorrectResponse()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    
    // Act
    var result = await _controller.GetInstallationStatus(shop);
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result);
    var response = okResult.Value as dynamic;
    Assert.False(response.installed);
    Assert.NotNull(response.installUrl);
}

[Fact]
public async Task GetInstallationStatus_InstalledShopWithValidScopes_ReturnsCorrectResponse()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    await SeedStore(shop, "read_orders,read_products,read_customers");
    
    // Act
    var result = await _controller.GetInstallationStatus(shop);
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result);
    var response = okResult.Value as dynamic;
    Assert.True(response.installed);
    Assert.True(response.scopesValid);
}

[Fact]
public async Task GetInstallationStatus_InstalledShopWithMissingScopes_ReturnsCorrectResponse()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    await SeedStore(shop, "read_orders"); // ä¸è¶³ã—ã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—
    
    // Act
    var result = await _controller.GetInstallationStatus(shop);
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result);
    var response = okResult.Value as dynamic;
    Assert.True(response.installed);
    Assert.False(response.scopesValid);
    Assert.NotEmpty(response.missingScopes);
    Assert.NotNull(response.reauthUrl);
}
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆä¾‹**: `frontend/src/components/auth/__tests__/AuthGuard.test.tsx`
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { AuthGuard } from '../AuthGuard';
import { useAppBridge } from '@/components/providers/AppBridgeProvider';

jest.mock('@/components/providers/AppBridgeProvider');

describe('AuthGuard', () => {
  it('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹', async () => {
    const mockGetToken = jest.fn().mockResolvedValue('mock-token');
    const mockRedirectToUrl = jest.fn();
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      getToken: mockGetToken,
      redirectToUrl: mockRedirectToUrl,
      extractShopFromToken: jest.fn().mockReturnValue('test-store.myshopify.com')
    });

    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: async () => ({
        installed: false,
        installUrl: 'https://example.com/install'
      })
    });

    render(<AuthGuard><div>Content</div></AuthGuard>);

    await waitFor(() => {
      expect(mockRedirectToUrl).toHaveBeenCalledWith(
        expect.stringContaining('https://example.com/install')
      );
    });
  });

  it('åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º', async () => {
    const mockGetToken = jest.fn().mockResolvedValue('mock-token');
    
    (useAppBridge as jest.Mock).mockReturnValue({
      isEmbedded: true,
      getToken: mockGetToken,
      redirectToUrl: jest.fn(),
      extractShopFromToken: jest.fn().mockReturnValue('test-store.myshopify.com')
    });

    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: async () => ({
        installed: true,
        scopesValid: true
      })
    });

    render(<AuthGuard><div>Content</div></AuthGuard>);

    await waitFor(() => {
      expect(screen.getByText('Content')).toBeInTheDocument();
    });
  });
});
```

**æ¤œè¨¼**:
- [ ] ã™ã¹ã¦ã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Š

---

#### 3.2 çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
**ç›®æ¨™**: OAuthãƒ•ãƒ­ãƒ¼å…¨ä½“ã®çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
- [ ] OAuthãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] hostãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¼æ’­ãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆã®ä½œæˆ

**çµ±åˆãƒ†ã‚¹ãƒˆä¾‹**: `Tests/Integration/OAuthFlowTests.cs`
```csharp
[Fact]
public async Task CompleteOAuthFlow_WithHostParameter_PreservesHost()
{
    // Arrange
    var shop = "test-store.myshopify.com";
    var host = "dGVzdC1zdG9yZS5teXNob3BpZnkuY29tL2FkbWlu"; // base64
    
    // Act - Step 1: Install
    var installResponse = await _client.GetAsync(
        $"/api/shopify/install?shop={shop}&host={host}");
    
    // Assert - Step 1
    Assert.Equal(HttpStatusCode.Redirect, installResponse.StatusCode);
    var redirectUrl = installResponse.Headers.Location?.ToString();
    Assert.Contains("host=", redirectUrl);
    
    // Extract state from redirect URL
    var state = ExtractStateFromUrl(redirectUrl);
    
    // Act - Step 2: Callback (mock Shopify response)
    var callbackResponse = await _client.GetAsync(
        $"/api/shopify/callback?code=mock-code&shop={shop}&state={state}&host={host}");
    
    // Assert - Step 2
    Assert.Equal(HttpStatusCode.Redirect, callbackResponse.StatusCode);
    var successUrl = callbackResponse.Headers.Location?.ToString();
    Assert.Contains("host=", successUrl);
    Assert.Contains(host, successUrl);
}
```

**æ¤œè¨¼**:
- [ ] ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] OAuthãƒ•ãƒ­ãƒ¼å…¨ä½“ãŒæ­£å¸¸ã«å‹•ä½œ

---

#### 3.3 E2Eãƒ†ã‚¹ãƒˆã®ä½œæˆ
**ç›®æ¨™**: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®E2Eãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
- [ ] Playwrightãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] åŸ‹ã‚è¾¼ã¿ã‚¢ãƒ—ãƒªã‚·ãƒŠãƒªã‚ªã®ãƒ†ã‚¹ãƒˆ
- [ ] æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚·ãƒŠãƒªã‚ªã®ãƒ†ã‚¹ãƒˆ

**E2Eãƒ†ã‚¹ãƒˆä¾‹**: `frontend/tests/e2e/install-flow.spec.ts`
```typescript
import { test, expect } from '@playwright/test';

test.describe('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼', () => {
  test('shopãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install?shop=test-store.myshopify.com');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºèª
    await expect(page.getByText('Shopifyã‚¹ãƒˆã‚¢ã«æ¥ç¶šä¸­')).toBeVisible();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¾…ã¤
    await page.waitForURL(/.*shopify\.com.*/, { timeout: 5000 });
    
    // Shopify OAuthãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(page.url()).toContain('.myshopify.com');
  });

  test('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º', async ({ page }) => {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    await page.goto('/install');
    
    // æ‰‹å‹•ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³')).toBeVisible();
    await expect(page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' })).toBeVisible();
    
    // ã‚·ãƒ§ãƒƒãƒ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›
    await page.getByLabel('ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³').fill('test-store');
    
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.getByRole('button', { name: 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«' }).click();
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¾…ã¤
    await page.waitForURL(/.*shopify\.com.*/, { timeout: 5000 });
  });
});
```

**æ¤œè¨¼**:
- [ ] ã™ã¹ã¦ã®E2Eãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œ

---

### Phase 4: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ç›£è¦–ï¼ˆç¶™ç¶šï¼‰

#### 4.1 ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
**ç›®æ¨™**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®å‹•ä½œç¢ºèª

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®šç¢ºèª
- [ ] å‹•ä½œç¢ºèª

**ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †**:
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   ```bash
   dotnet ef database update --project backend/ShopifyAnalyticsApi
   ```

2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
   ```bash
   cd backend/ShopifyAnalyticsApi
   dotnet publish -c Release
   # Azure App Serviceã«ãƒ‡ãƒ—ãƒ­ã‚¤
   ```

3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
   ```bash
   cd frontend
   npm run build
   # Azure Static Web Appsã«ãƒ‡ãƒ—ãƒ­ã‚¤
   ```

**æ¤œè¨¼**:
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§æ­£å¸¸ã«å‹•ä½œ
- [ ] ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²å†…

---

#### 4.2 æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
**ç›®æ¨™**: æœ¬ç•ªç’°å¢ƒã¸ã®å®‰å…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤

**ã‚¿ã‚¹ã‚¯**:
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ã®ä½œæˆ
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ã®ä½œæˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] å‹•ä½œç¢ºèª
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š

**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§å‹•ä½œç¢ºèªæ¸ˆã¿
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèª
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

**æ¤œè¨¼**:
- [ ] æœ¬ç•ªç’°å¢ƒã§æ­£å¸¸ã«å‹•ä½œ
- [ ] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ãªã—
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè¨±å®¹ç¯„å›²å†…

---

#### 4.3 ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
**ç›®æ¨™**: ç¶™ç¶šçš„ãªç›£è¦–ã¨æ”¹å–„

**ã‚¿ã‚¹ã‚¯**:
- [ ] Application Insightsã®è¨­å®š
- [ ] ãƒ­ã‚°ç›£è¦–ã®è¨­å®š
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åé›†

**ç›£è¦–é …ç›®**:
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸç‡
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰€è¦æ™‚é–“
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç™ºå‹•å›æ•°

**æ¤œè¨¼**:
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒæ­£å¸¸ã«å‹•ä½œ
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæœ‰ç”¨ãªæƒ…å ±ã‚’æä¾›

---

## ğŸ“Š é€²æ—ç®¡ç†

### ã‚¿ã‚¹ã‚¯ç®¡ç†
- GitHub Issuesã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†
- å„Phaseã”ã¨ã«ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ä½œæˆ
- æ¯æ—¥ã®é€²æ—ã‚’è¨˜éŒ²

### ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- æ¯æ—¥ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒƒãƒ—ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- é€±æ¬¡ã®é€²æ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- å•é¡Œç™ºç”Ÿæ™‚ã®å³åº§ã®å ±å‘Š

---

## ğŸš¨ ãƒªã‚¹ã‚¯ç®¡ç†

### æŠ€è¡“çš„ãƒªã‚¹ã‚¯
| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| App Bridgeäº’æ›æ€§å•é¡Œ | é«˜ | æ—©æœŸãƒ†ã‚¹ãƒˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£… |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®èª¤å‹•ä½œ | ä¸­ | ååˆ†ãªãƒ†ã‚¹ãƒˆã€ç›£è¦– |
| ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— | é«˜ | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”» |

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ã‚¯
| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| å®Ÿè£…é…å»¶ | ä¸­ | ãƒãƒƒãƒ•ã‚¡æ™‚é–“ã®ç¢ºä¿ |
| ãƒ†ã‚¹ãƒˆä¸è¶³ | é«˜ | è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å……å®Ÿ |

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|-----------|---------|--------|
| 2025-10-25 | 1.0 | åˆç‰ˆä½œæˆ | Devin |
