# 現状設計の問題点と修正方針

## 作成日
2025-12-26

## 基本方針
**Shopify公式ドキュメント通りに実装することを基本方針とする**

---

## 📋 目次

1. [Shopify公式ドキュメントの推奨実装](#shopify公式ドキュメントの推奨実装)
2. [現状の実装の問題点](#現状の実装の問題点)
3. [修正方針](#修正方針)
4. [実装手順](#実装手順)

---

## 🎯 Shopify公式ドキュメントの推奨実装

### 埋め込みアプリの場合（推奨）

**Shopify Managed Installation + Token Exchange**

1. **Shopify Managed Installation**を有効化
   - `shopify.app.toml`で`scopes`を定義
   - `shopify app deploy`でデプロイ
   - Shopifyが自動的にインストールとスコープ更新を管理

2. **Token Exchange**でアクセストークンを取得
   - App Bridgeセッショントークンを取得
   - セッショントークンをアクセストークンに交換
   - リダイレクト不要

**メリット**:
- リダイレクト不要（パフォーマンス向上）
- 画面のちらつきなし（UX向上）
- 実装がシンプル

### 非埋め込みアプリまたはレガシー埋め込みアプリの場合

**Authorization Code Grant**

1. **Step 1: インストールリクエストの検証**
   - `shop`、`timestamp`、`hmac`パラメータを検証
   - HMAC-SHA256で検証

2. **Step 2: 認証コードのリクエスト**
   - 埋め込みアプリの場合:
     - `embedded=1`をチェック
     - App Bridgeの`Redirect.toApp()`でiframeから脱出
     - その後、3xxリダイレクトでOAuth認証画面へ
   - 非埋め込みアプリの場合:
     - 直接3xxリダイレクトでOAuth認証画面へ

3. **Step 3: 認証コードの検証**
   - `state`（nonce）の検証
   - HMACの検証
   - `shop`パラメータの検証

4. **Step 4: アクセストークンの取得**
   - `POST https://{shop}.myshopify.com/admin/oauth/access_token`
   - `client_id`、`client_secret`、`code`を送信

5. **Step 5: アプリUIへのリダイレクト**
   - 埋め込みアプリの場合: `https://{base64_decode(host)}/apps/{api_key}/`
   - 非埋め込みアプリの場合: アプリURL（`shop`、`host`パラメータ付き）

---

## ⚠️ 現状の実装の問題点

### 問題1: フロントエンドとバックエンドの役割分担が不明確

**現状**:
- フロントエンドに`/api/shopify/callback`（Next.js API Route）が存在
- バックエンドにも`/api/shopify/callback`が存在
- フロントエンドがプロキシとして機能している

**Shopify公式ドキュメント**:
- OAuthコールバックは**バックエンドで直接処理**することを想定
- フロントエンドのプロキシは不要（複雑性を増すだけ）

**問題点**:
- フロントエンドのプロキシがエラーの原因になる可能性
- リダイレクトURIの設定が複雑になる
- デバッグが困難

### 問題2: リダイレクトURIの設定が不適切

**現状**:
```csharp
var redirectUri = !string.IsNullOrWhiteSpace(shopifyAppUrl)
    ? $"{shopifyAppUrl.TrimEnd('/')}/api/shopify/callback"  // フロントエンドURL
    : GetRedirectUri();  // バックエンドURL（フォールバック）
```

**Shopify公式ドキュメント**:
- リダイレクトURIは**バックエンドURLを直接使用**することを推奨
- フロントエンドURLを使用する場合は、フロントエンドがバックエンドに転送する必要があるが、これは複雑性を増す

**問題点**:
- フロントエンドURLとバックエンドURLの両方をShopify Partners Dashboardに登録する必要がある
- どちらが使用されるかが不明確

### 問題3: iframe脱出処理が不完全

**現状** (`frontend/src/app/install/page.tsx`):
```typescript
if (isEmbeddedMode && app) {
  // App Bridgeを使用してiframeから脱出
  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.set('embedded', '0');
  const escapedUrl = currentUrl.toString();
  app.dispatch(Redirect.toApp({ path: escapedUrl }));
}
```

**Shopify公式ドキュメント**:
- `embedded=1`の場合、**専用のExitIframeページ**を表示
- ExitIframeページでApp Bridgeの`Redirect.toApp()`を使用
- その後、バックエンドの`/api/shopify/install`にリダイレクト

**問題点**:
- インストールページ内でiframe脱出を試みている
- ExitIframe専用ページがない

### 問題4: OAuthコールバックの検証が不完全

**現状**:
- `state`の検証は実装されている
- HMAC検証は実装されているが、開発環境でスキップされている
- `shop`パラメータの検証は実装されている

**Shopify公式ドキュメント**:
- **すべての検証を必須**とする
- 開発環境でも検証を実施（エラーログを出力するだけでも良い）

**問題点**:
- 開発環境でHMAC検証をスキップしているため、本番環境で問題が発生する可能性

### 問題5: リダイレクト先の決定ロジックが不適切

**現状** (`backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`):
```csharp
var redirectUrl = $"{appUrl}/auth/success?shop={Uri.EscapeDataString(shop)}&storeId={storeId}&success=true";
```

**Shopify公式ドキュメント**:
- 埋め込みアプリの場合: `https://{base64_decode(host)}/apps/{api_key}/`
- 非埋め込みアプリの場合: アプリURL（`shop`、`host`パラメータ付き）

**問題点**:
- 埋め込みアプリの場合、埋め込みアプリURLにリダイレクトしていない
- `host`パラメータをデコードして埋め込みアプリURLを構築していない

### 問題6: ルートページの複雑なリダイレクトロジック

**現状** (`frontend/src/app/page.tsx`):
- 認証状態をチェック
- ストアの存在を確認
- 複雑な条件分岐

**Shopify公式ドキュメント**:
- ルートページは**シンプル**に実装
- 認証が必要な場合は、認証ガードで処理

**問題点**:
- ルートページが複雑すぎる
- 認証状態の初期化を待つロジックが複雑

### 問題7: Shopify Managed Installationを使用していない

**現状**:
- Authorization Code Grantのみを使用
- スコープはOAuth URLの`scope`パラメータで指定

**Shopify公式ドキュメント**:
- **Shopify Managed Installationを推奨**
- `shopify.app.toml`でスコープを定義
- `shopify app deploy`でデプロイ

**問題点**:
- リダイレクトが必要（パフォーマンス低下）
- 画面のちらつき（UX低下）
- 実装が複雑

---

## 🔧 修正方針

### 方針1: Shopify Managed Installation + Token Exchangeへの移行（推奨）

**目標**: 埋め込みアプリの場合、Shopify Managed Installation + Token Exchangeを使用

**メリット**:
- リダイレクト不要
- 画面のちらつきなし
- 実装がシンプル

**実装手順**:
1. `shopify.app.toml`を作成・更新
2. `scopes`を定義
3. `shopify app deploy`でデプロイ
4. Token Exchangeを実装
5. Authorization Code Grantを削除（または非埋め込みアプリ用にのみ残す）

### 方針2: Authorization Code Grantの修正（レガシー対応）

**目標**: 現状のAuthorization Code GrantをShopify公式ドキュメント通りに修正

**修正内容**:

#### 2.1 リダイレクトURIの統一

**修正前**:
```csharp
var redirectUri = !string.IsNullOrWhiteSpace(shopifyAppUrl)
    ? $"{shopifyAppUrl.TrimEnd('/')}/api/shopify/callback"
    : GetRedirectUri();
```

**修正後**:
```csharp
// 常にバックエンドURLを使用
var redirectUri = GetRedirectUri();
```

**理由**:
- Shopify公式ドキュメントでは、OAuthコールバックはバックエンドで直接処理することを想定
- フロントエンドのプロキシは不要

#### 2.2 ExitIframeページの追加

**新規作成**: `frontend/src/app/auth/exit-iframe/page.tsx`

**実装内容**:
```typescript
'use client';

import { useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { useAppBridge } from '@/lib/shopify/app-bridge-provider';
import { Redirect } from '@shopify/app-bridge/actions';

export default function ExitIframePage() {
  const searchParams = useSearchParams();
  const { app } = useAppBridge();
  const redirectUri = searchParams?.get('redirectUri');

  useEffect(() => {
    if (!app || !redirectUri) {
      console.error('App BridgeまたはredirectUriがありません');
      return;
    }

    // App Bridgeを使用してiframeから脱出
    const redirect = Redirect.create(app);
    redirect.dispatch(Redirect.Action.APP, { path: redirectUri });
  }, [app, redirectUri]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p className="text-gray-600">認証画面へ移動中...</p>
      </div>
    </div>
  );
}
```

#### 2.3 インストールページの修正

**修正前**:
```typescript
if (isEmbeddedMode && app) {
  // インストールページ内でiframe脱出を試みている
  app.dispatch(Redirect.toApp({ path: escapedUrl }));
}
```

**修正後**:
```typescript
if (isEmbeddedMode && app) {
  // ExitIframeページにリダイレクト
  const exitIframeUrl = `/auth/exit-iframe?redirectUri=${encodeURIComponent(installUrl)}`;
  app.dispatch(Redirect.toApp({ path: exitIframeUrl }));
}
```

#### 2.4 バックエンドのリダイレクト先の修正

**修正前**:
```csharp
var redirectUrl = $"{appUrl}/auth/success?shop={Uri.EscapeDataString(shop)}&storeId={storeId}&success=true";
```

**修正後**:
```csharp
// 埋め込みアプリの場合
if (!string.IsNullOrWhiteSpace(hostParam))
{
    // hostパラメータをデコード
    var decodedHost = DecodeHost(hostParam);
    var embeddedAppUrl = $"https://{decodedHost}/apps/{apiKey}/";
    redirectUrl = embeddedAppUrl;
}
else
{
    // 非埋め込みアプリの場合
    redirectUrl = $"{appUrl}?shop={Uri.EscapeDataString(shop)}&host={Uri.EscapeDataString(hostParam)}";
}
```

#### 2.5 OAuthコールバックの検証の強化

**修正前**:
```csharp
if (!isValidHmac && !isDevelopment)
{
    return Unauthorized(new { error = "HMAC validation failed" });
}
```

**修正後**:
```csharp
if (!isValidHmac)
{
    _logger.LogError("HMAC検証失敗. Shop: {Shop}, IsDevelopment: {IsDevelopment}", shop, isDevelopment);
    if (isDevelopment)
    {
        // 開発環境でもエラーログを出力
        _logger.LogWarning("開発環境のためHMAC検証失敗を許可しますが、本番環境ではエラーになります");
    }
    else
    {
        return Unauthorized(new { error = "HMAC validation failed" });
    }
}
```

#### 2.6 フロントエンドのプロキシの削除（オプション）

**検討事項**:
- フロントエンドの`/api/shopify/callback`を削除するか、残すか
- 削除する場合: Shopify Partners DashboardのRedirect URLsをバックエンドURLのみに変更
- 残す場合: プロキシとして機能することを明確にドキュメント化

**推奨**: 削除（シンプル化のため）

---

## 📝 実装手順

### Phase 1: 現状の問題を修正（Authorization Code Grant）

#### Step 1: リダイレクトURIの統一

1. `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`を修正
   - `BuildOAuthUrlAsync()`で`redirectUri`を常にバックエンドURLに統一

2. Shopify Partners Dashboardの設定を確認
   - Redirect URLsにバックエンドURLを登録
   - フロントエンドURLは削除（プロキシを削除する場合）

#### Step 2: ExitIframeページの追加

1. `frontend/src/app/auth/exit-iframe/page.tsx`を作成
2. App Bridgeの`Redirect.toApp()`を使用してiframeから脱出

#### Step 3: インストールページの修正

1. `frontend/src/app/install/page.tsx`を修正
   - `embedded=1`の場合、ExitIframeページにリダイレクト

#### Step 4: バックエンドのリダイレクト先の修正

1. `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`を修正
   - 埋め込みアプリの場合、埋め込みアプリURLにリダイレクト
   - `host`パラメータをデコードしてURLを構築

#### Step 5: OAuthコールバックの検証の強化

1. `backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs`を修正
   - 開発環境でもHMAC検証を実施（エラーログを出力）

#### Step 6: フロントエンドのプロキシの削除（オプション）

1. `frontend/src/app/api/shopify/callback/route.ts`を削除
2. Shopify Partners DashboardのRedirect URLsを更新

### Phase 2: Shopify Managed Installation + Token Exchangeへの移行（推奨）

#### Step 1: shopify.app.tomlの作成・更新

1. `shopify.app.toml`を作成
2. `scopes`を定義
3. `embedded = true`を設定

#### Step 2: Token Exchangeの実装

1. バックエンドにToken Exchangeエンドポイントを追加
2. フロントエンドでApp Bridgeセッショントークンを取得
3. セッショントークンをアクセストークンに交換

#### Step 3: 設定のデプロイ

1. `shopify app deploy`を実行
2. Shopify Managed Installationが有効になることを確認

#### Step 4: Authorization Code Grantの削除（オプション）

1. 埋め込みアプリの場合、Authorization Code Grantを削除
2. 非埋め込みアプリの場合のみ残す

---

## 🔍 修正後のフロー

### 修正後のAuthorization Code Grantフロー（レガシー対応）

```
1. ユーザーがShopify管理画面でアプリをクリック
   ↓
2. フロントエンド `/install` にアクセス（`shop`、`host`、`embedded=1`パラメータ付き）
   ↓
3. `embedded=1`の場合:
   - `/auth/exit-iframe?redirectUri=/api/shopify/install?shop=...` にリダイレクト
   - ExitIframeページでApp Bridgeの`Redirect.toApp()`を使用してiframeから脱出
   ↓
4. バックエンド `/api/shopify/install` にリクエスト（`embedded=0`）
   ↓
5. バックエンドがOAuth URLを生成（`redirect_uri`はバックエンドURL）
   ↓
6. Shopify OAuth認証画面にHTTP 302リダイレクト
   ↓
7. ユーザーが権限を承認
   ↓
8. Shopifyがバックエンド `/api/shopify/callback` にリダイレクト
   ↓
9. バックエンドがアクセストークンを取得
   ↓
10. バックエンドが`Stores`テーブルにレコードを作成・更新
    ↓
11. バックエンドが埋め込みアプリURLにリダイレクト:
    - `https://{base64_decode(host)}/apps/{api_key}/`
    ↓
12. フロントエンドが認証状態を設定
    ↓
13. アプリが表示
```

### Shopify Managed Installation + Token Exchangeフロー（推奨）

```
1. ユーザーがShopify管理画面でアプリをクリック
   ↓
2. Shopifyが自動的にインストールとスコープ更新を管理
   ↓
3. フロントエンドがApp Bridgeセッショントークンを取得
   ↓
4. フロントエンドがバックエンドのToken Exchangeエンドポイントを呼び出し
   ↓
5. バックエンドがセッショントークンをアクセストークンに交換
   ↓
6. バックエンドが`Stores`テーブルにレコードを作成・更新（初回のみ）
   ↓
7. アプリが表示（リダイレクト不要）
```

---

## 📊 比較表

| 項目 | 現状（Authorization Code Grant） | 修正後（Shopify Managed Installation） |
|------|--------------------------------|--------------------------------------|
| リダイレクト | 必要 | 不要 |
| 画面のちらつき | あり | なし |
| 実装の複雑さ | 高い | 低い |
| パフォーマンス | 低い | 高い |
| UX | 低い | 高い |
| Shopify推奨 | 非推奨（レガシー） | 推奨 |

---

## 🎯 優先順位

### 優先度: 高

1. **リダイレクトURIの統一**（即座に修正）
   - バックエンドURLを常に使用
   - Shopify Partners Dashboardの設定を確認

2. **ExitIframeページの追加**（即座に修正）
   - iframe脱出処理を正しく実装

3. **バックエンドのリダイレクト先の修正**（即座に修正）
   - 埋め込みアプリURLに正しくリダイレクト

### 優先度: 中

4. **OAuthコールバックの検証の強化**（次回リリースまでに修正）
   - 開発環境でもHMAC検証を実施

5. **フロントエンドのプロキシの削除**（次回リリースまでに検討）
   - シンプル化のため

### 優先度: 低（将来の改善）

6. **Shopify Managed Installation + Token Exchangeへの移行**（将来的に検討）
   - パフォーマンスとUXの向上
   - 実装のシンプル化

---

## 📚 参考資料

- [Shopify公式ドキュメント: Authorization Code Grant](https://shopify.dev/docs/apps/build/authentication-authorization/access-tokens/authorization-code-grant)
- [Shopify公式ドキュメント: Token Exchange](https://shopify.dev/docs/apps/build/authentication-authorization/access-tokens/token-exchange)
- [Shopify公式ドキュメント: Shopify Managed Installation](https://shopify.dev/docs/apps/build/authentication-authorization/app-installation)
- [Shopify公式ドキュメント: App Bridge Redirect](https://shopify.dev/docs/api/app-bridge/previous-versions/actions/navigation/redirect-navigate)

---

## ⚠️ 実装前の検討事項

### 1. 既存インストール済みストアへの影響

**検討が必要な点**:
- 既にインストール済みのストアは、修正後も正常に動作するか？
- リダイレクトURIの変更により、既存のアクセストークンが無効になることはないか？
- 既存ストアの再認証が必要になる可能性はあるか？

**確認事項**:
- [ ] 既存ストアのアクセストークンは有効なままか
- [ ] リダイレクトURIの変更が既存ストアに影響しないか
- [ ] 既存ストアの再インストールが必要か

**対応方針**:
- Phase 1の修正は既存ストアに影響しない（リダイレクトURIの変更は新規インストールのみに影響）
- Phase 2（Shopify Managed Installation）への移行時は、既存ストアの再認証が必要になる可能性がある

### 2. 段階的な移行計画の詳細

**Phase 1（Authorization Code Grantの修正）の移行手順**:

1. **開発環境での検証**
   - [ ] 開発環境で修正を適用
   - [ ] 新規インストールフローをテスト
   - [ ] 既存ストアの動作を確認

2. **Staging環境での検証**
   - [ ] Staging環境にデプロイ
   - [ ] 新規インストールフローをテスト
   - [ ] 既存ストアの動作を確認

3. **本番環境への適用**
   - [ ] 本番環境にデプロイ
   - [ ] 新規インストールフローをテスト
   - [ ] 既存ストアの動作を監視

**Phase 2（Shopify Managed Installation）の移行手順**:

1. **shopify.app.tomlの作成・更新**
   - [ ] `shopify.app.toml`を作成
   - [ ] `scopes`を定義
   - [ ] `shopify app deploy`でデプロイ

2. **Token Exchangeの実装**
   - [ ] バックエンドにToken Exchangeエンドポイントを追加
   - [ ] フロントエンドでApp Bridgeセッショントークンを取得
   - [ ] セッショントークンをアクセストークンに交換

3. **段階的な移行**
   - [ ] 新規インストールのみShopify Managed Installationを使用
   - [ ] 既存ストアはAuthorization Code Grantを継続使用
   - [ ] 将来的に既存ストアも移行（オプション）

### 3. テスト計画

**テストケース**:

#### 3.1 新規インストールフローのテスト

- [ ] **埋め込みアプリ（embedded=1）の場合**
  - [ ] ExitIframeページが正しく表示されるか
  - [ ] iframeから正しく脱出できるか
  - [ ] OAuth認証フローが正常に完了するか
  - [ ] `Stores`テーブルにレコードが作成されるか
  - [ ] 埋め込みアプリURLに正しくリダイレクトされるか

- [ ] **非埋め込みアプリ（embedded=0）の場合**
  - [ ] OAuth認証フローが正常に完了するか
  - [ ] `Stores`テーブルにレコードが作成されるか
  - [ ] アプリURLに正しくリダイレクトされるか

#### 3.2 既存ストアの動作確認

- [ ] 既存ストアのアクセストークンが有効なままか
- [ ] 既存ストアのAPI呼び出しが正常に動作するか
- [ ] 既存ストアの再認証が必要にならないか

#### 3.3 エラーハンドリングのテスト

- [ ] HMAC検証失敗時のエラーハンドリング
- [ ] `state`検証失敗時のエラーハンドリング
- [ ] アクセストークン取得失敗時のエラーハンドリング
- [ ] ネットワークエラー時のエラーハンドリング

#### 3.4 セキュリティテスト

- [ ] CSRF攻撃の対策（`state`パラメータの検証）
- [ ] HMAC検証が正しく動作するか
- [ ] リダイレクトURIの検証が正しく動作するか

### 4. 環境変数・設定変更の詳細

#### 4.1 Shopify Partners Dashboardでの設定変更

**Phase 1（Authorization Code Grantの修正）**:

1. **Redirect URLsの更新**
   - [ ] バックエンドURLを追加: `https://{backend-url}/api/shopify/callback`
   - [ ] フロントエンドURLを削除（プロキシを削除する場合）: `https://{frontend-url}/api/shopify/callback`

2. **設定の確認**
   - [ ] Required scopesが正しく設定されているか
   - [ ] App URLが正しく設定されているか

**Phase 2（Shopify Managed Installation）**:

1. **shopify.app.tomlの設定**
   - [ ] `client_id`が正しく設定されているか
   - [ ] `scopes`が正しく設定されているか
   - [ ] `application_url`が正しく設定されているか
   - [ ] `embedded = true`が設定されているか

2. **shopify app deployの実行**
   - [ ] `shopify app deploy`を実行
   - [ ] Shopify Managed Installationが有効になることを確認

#### 4.2 環境変数の変更

**バックエンド（Azure App Service）**:

- [ ] `Backend:BaseUrl`が正しく設定されているか
- [ ] `Shopify:ApiKey`が正しく設定されているか
- [ ] `Shopify:ApiSecret`が正しく設定されているか

**フロントエンド（Azure Static Web Apps）**:

- [ ] `NEXT_PUBLIC_BACKEND_URL`が正しく設定されているか
- [ ] `NEXT_PUBLIC_SHOPIFY_API_KEY`が正しく設定されているか

### 5. エラーハンドリング

**各ステップでのエラーハンドリング**:

#### 5.1 インストールページ（`/install`）

- [ ] `shop`パラメータが不正な場合のエラーメッセージ
- [ ] App Bridgeが利用できない場合のエラーメッセージ
- [ ] リダイレクト失敗時のエラーメッセージ

#### 5.2 ExitIframeページ（`/auth/exit-iframe`）

- [ ] `redirectUri`パラメータが不正な場合のエラーメッセージ
- [ ] App Bridgeが利用できない場合のエラーメッセージ
- [ ] iframe脱出失敗時のエラーメッセージ

#### 5.3 OAuthコールバック（`/api/shopify/callback`）

- [ ] HMAC検証失敗時のエラーログとレスポンス
- [ ] `state`検証失敗時のエラーログとレスポンス
- [ ] アクセストークン取得失敗時のエラーログとレスポンス
- [ ] データベース保存失敗時のエラーログとレスポンス

### 6. ロールバック計画

**問題が発生した場合のロールバック手順**:

#### 6.1 Phase 1のロールバック

1. **コードのロールバック**
   - [ ] 前のバージョンにロールバック
   - [ ] Shopify Partners DashboardのRedirect URLsを元に戻す

2. **動作確認**
   - [ ] 新規インストールフローが正常に動作するか
   - [ ] 既存ストアの動作が正常か

#### 6.2 Phase 2のロールバック

1. **shopify.app.tomlのロールバック**
   - [ ] 前のバージョンの`shopify.app.toml`に戻す
   - [ ] `shopify app deploy`を実行

2. **コードのロールバック**
   - [ ] Token Exchangeの実装を削除
   - [ ] Authorization Code Grantに戻す

### 7. データベース変更の必要性

**確認事項**:
- [ ] Phase 1の修正でデータベーススキーマの変更は不要（既存の`Stores`テーブルで対応可能）
- [ ] Phase 2の移行でもデータベーススキーマの変更は不要（既存の`Stores`テーブルで対応可能）

### 8. 既存コードとの互換性

**確認事項**:
- [ ] 既存のAPIエンドポイントへの影響
- [ ] 既存の認証ロジックへの影響
- [ ] 既存のWebhook処理への影響

**対応方針**:
- Phase 1の修正は既存コードへの影響を最小限に抑える
- Phase 2の移行時は、新規インストールのみShopify Managed Installationを使用し、既存ストアは既存のロジックを継続使用

### 9. パフォーマンス影響

**確認事項**:
- [ ] リダイレクトURIの変更によるパフォーマンスへの影響
- [ ] ExitIframeページの追加によるパフォーマンスへの影響
- [ ] Token Exchangeの実装によるパフォーマンスへの影響

**期待される改善**:
- Phase 2（Shopify Managed Installation）への移行により、リダイレクトが不要になり、パフォーマンスが向上する

### 10. セキュリティ検証

**確認事項**:
- [ ] HMAC検証が正しく実装されているか
- [ ] `state`パラメータの検証が正しく実装されているか
- [ ] リダイレクトURIの検証が正しく実装されているか
- [ ] CSRF攻撃の対策が正しく実装されているか

---

## 📝 更新履歴

- 2025-12-26: 初版作成（Shopify公式ドキュメントに基づく問題点の洗い出しと修正方針）
- 2025-12-26: 実装前の検討事項を追加（既存ストアへの影響、テスト計画、ロールバック計画など）