# 404エラー再発調査と対応

## 問題の概要

インストールフローからストア選択後に404エラーが再発している。また、Shopify Adminのメニューにも追加されなくなった。

## 調査結果

### 1. AllAllowedモードがまだ有効

**現象**:
- バックエンドログに`AllAllowed mode enabled`が表示されている
- コードベースでは`AllAllowed`は削除済み

**原因**:
- バックエンドのデプロイが最新でない可能性が高い
- テストコードの修正は完了したが、デプロイがまだ完了していない可能性

**対応**:
1. バックエンドを再デプロイして最新コードを反映
2. デプロイ後にログを確認し、`AllAllowed mode enabled`が表示されないことを確認

### 2. 404エラーの原因

**現象**:
- Shopify Adminからアプリにアクセスする際のURLで404エラーが発生
- URL形式: `https://admin.shopify.com/store/xn-fbkq6e5da0fpb/apps/2d7e0e1f5da14eb9d299aa746738e44b/?hmac=...&host=...&shop=...&timestamp=...`
- React Routerが404エラーをキャッチしている

**原因の可能性**:
1. **Shopify App Bridgeのリダイレクト処理**: `AppBridgeProvider`で`window.location.pathname`を使用してリダイレクトしているが、ルートパス（`/`）の場合に不要なリダイレクトが発生している可能性
2. **クエリパラメータの保持**: `hmac`、`timestamp`パラメータがリダイレクト時に失われている可能性
3. **初回インストール処理**: ストア情報が未登録の初回インストール時に問題が発生している可能性

**確認事項**:
- ルートページ（`/`）は`hmac`、`timestamp`パラメータを保持してリダイレクトするように修正済み
- `AppBridgeProvider`のリダイレクト処理を修正（ルートパスの場合はリダイレクトしない）

### 3. Shopify Adminメニューに追加されない問題

**原因の可能性**:
1. **Shopifyアプリ側の設定**: App URL、Redirect URLsの設定が正しくない可能性
2. **初回インストール処理**: OAuth認証が完了していない、またはストア情報が正しく登録されていない可能性

## 修正内容

### 修正1: ルートページのクエリパラメータ保持

`frontend/src/app/page.tsx`を修正：
- `hmac`、`timestamp`パラメータを`buildRedirectUrl`関数で保持するように追加
- タイムアウト処理でも`hmac`、`timestamp`パラメータを保持

### 修正2: AppBridgeProviderのリダイレクト処理

`frontend/src/lib/shopify/app-bridge-provider.tsx`を修正：
- ルートパス（`/`）の場合は、App Bridgeでリダイレクトしない
- ルートページ内で適切なページにリダイレクトされるため、不要なリダイレクトを防止

## 次のステップ

### 優先度1: バックエンドの再デプロイ
1. テストコードの修正が反映されていることを確認
2. バックエンドを再デプロイ
3. デプロイ後にログを確認し、`AllAllowed mode enabled`が表示されないことを確認

### 優先度2: Shopifyアプリ設定の確認
1. Shopify Partners Dashboardで以下を確認：
   - App URLが正しく設定されているか
   - Redirect URLsが正しく設定されているか
   - アプリが有効化されているか

### 優先度3: 初回インストールフローの確認
1. ストア情報が未登録の状態で初回インストールを実行
2. OAuth認証フローが正しく完了するか確認
3. ストア情報が正しく登録されるか確認
4. `/setup/initial`ページに正しくリダイレクトされるか確認

## 確認すべきポイント

1. **バックエンドログ**: `AllAllowed mode enabled`が表示されないことを確認
2. **フロントエンドコンソール**: 404エラーが発生しないことを確認
3. **Shopify Admin**: アプリがメニューに表示されることを確認
4. **初回インストール**: ストア情報が未登録の状態で正しく動作することを確認
