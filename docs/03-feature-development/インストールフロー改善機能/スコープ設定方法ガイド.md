# スコープ設定方法ガイド

## 作成日
2025-12-26

## 概要

Shopifyアプリのアクセススコープ（権限）を設定する方法は、以下の2つがあります：

1. **Shopify Partners Dashboardでの設定**（推奨）
2. **shopify.app.tomlでの設定**（Shopify CLI使用時）

---

## 📋 目次

1. [Shopify Partners Dashboardでの設定](#shopify-partners-dashboardでの設定)
2. [shopify.app.tomlでの設定](#shopifyapptomlでの設定)
3. [現在の実装でのスコープ取得方法](#現在の実装でのスコープ取得方法)
4. [Phase 2（Shopify Managed Installation）でのスコープ管理](#phase-2shopify-managed-installationでのスコープ管理)
5. [推奨される設定方法](#推奨される設定方法)

---

## Shopify Partners Dashboardでの設定

### 設定場所

1. **Shopify Partners Dashboard**にログイン
2. 対象のアプリを選択
3. **「App setup」**または**「Settings」**タブを開く
4. **「App versions」**セクションで**「Create a version」**をクリック
5. **「Select scopes」**画面で必要なスコープを選択

### 設定画面の説明

- **API Name**: 各スコープが属するAPI（例: Admin API）
- **Category/Feature**: スコープのカテゴリ（例: Analytics, Customers, Orders）
- **Permissions**: 各カテゴリの読み取り/書き込み権限
  - `read_*`: 読み取り権限
  - `write_*`: 書き込み権限

### 現在のアプリで必要なスコープ

以下のスコープが現在の実装で使用されています：

```
read_orders,read_products,read_customers
```

**詳細**:
- `read_orders`: 注文情報の読み取り
  - 休眠顧客分析（最終購入日の取得）
  - 前年同月比分析（注文データの取得）
  - 購入回数分析（注文数の集計）
  - 月別売上統計（注文データの集計）
- `read_products`: 商品情報の読み取り
  - 前年同月比分析（商品データの取得）
  - 商品分析（商品情報の表示）
  - 注文内の商品情報の取得
- `read_customers`: 顧客情報の読み取り
  - 休眠顧客分析（顧客情報の取得）
  - 顧客購買分析（顧客データの取得）
  - 購入回数分析（顧客別の集計）

**確認結果**: この3つのスコープで現在の実装済み機能はすべて動作します。

### 将来の機能拡張を考慮した追加スコープ（オプション）

将来的に以下の機能を追加する場合は、追加のスコープが必要になる可能性があります：

- `write_customers`: 顧客タグの追加・更新（顧客セグメント管理機能など）
- `read_analytics`: Shopify Analytics APIの利用（より詳細な分析データの取得）
- `read_inventory`: 在庫情報の取得（在庫回転率分析など）

**注意**: 現時点では上記のスコープは不要です。必要になった時点で追加してください。

### 注意事項

- **一部のスコープは追加の承認が必要**:
  - 画面下部に「Some scopes require Shopify permission before you can include them in a version. Request access」という警告が表示される場合があります
  - その場合は「Request access」をクリックして承認をリクエストする必要があります

- **スコープの変更はバージョン管理される**:
  - 新しいバージョンを作成してスコープを変更する必要があります
  - 既存のインストール済みストアには、次回の再認証時に新しいスコープが適用されます

---

## shopify.app.tomlでの設定

### 設定方法

`shopify.app.toml`ファイルに`scopes`を定義します：

```toml
[access_scopes]
scopes = "read_orders,read_products,read_customers"
```

### デプロイ方法

```bash
shopify app deploy
```

このコマンドを実行すると、`shopify.app.toml`の設定がShopify Partners Dashboardに反映されます。

### 注意事項

- `shopify.app.toml`で設定したスコープは、Shopify Partners Dashboardの設定を**上書き**します
- `shopify app deploy`を実行すると、Shopify Partners Dashboardの設定が自動的に更新されます

---

## 現在の実装でのスコープ取得方法

### バックエンドでのスコープ取得

現在の実装では、以下の方法でスコープを取得しています：

```csharp
// backend/ShopifyAnalyticsApi/Controllers/ShopifyAuthController.cs
var scopes = GetShopifySetting("Scopes", "read_orders,read_products,read_customers");
```

**設定の優先順位**:
1. 環境変数: `SHOPIFY_SCOPES`
2. 設定ファイル: `appsettings.json`の`Shopify:Scopes`
3. デフォルト値: `"read_orders,read_products,read_customers"`

### 設定ファイルの例

**appsettings.json**:
```json
{
  "Shopify": {
    "Scopes": "read_orders,read_products,read_customers"
  }
}
```

**環境変数**:
```bash
SHOPIFY_SCOPES=read_orders,read_products,read_customers
```

---

## Phase 2（Shopify Managed Installation）でのスコープ管理

### Shopify Managed Installationとは

Shopify Managed Installationを使用すると、Shopifyが自動的にインストールとスコープ更新を管理します。

### スコープ管理の変更点

**Phase 1（現在の実装）**:
- バックエンドの設定ファイル（`appsettings.json`）でスコープを定義
- OAuth認証時に`scope`パラメータでスコープを指定

**Phase 2（Shopify Managed Installation）**:
- `shopify.app.toml`でスコープを定義
- `shopify app deploy`でShopify Partners Dashboardにデプロイ
- Shopifyが自動的にスコープを管理

### 移行手順

1. **shopify.app.tomlを作成**:
   ```toml
   [access_scopes]
   scopes = "read_orders,read_products,read_customers"
   ```

2. **shopify app deployを実行**:
   ```bash
   shopify app deploy
   ```

3. **バックエンドの設定を更新**（オプション）:
   - `appsettings.json`の`Shopify:Scopes`は、Shopify Managed Installationでは使用されません
   - ただし、後方互換性のために残しておくことを推奨します

---

## 推奨される設定方法

### Phase 1（現在）の推奨方法

1. **Shopify Partners Dashboardでスコープを設定**
   - アプリのバージョンを作成してスコープを選択
   - これが**唯一の真実の源（Single Source of Truth）**になります

2. **バックエンドの設定ファイルと同期**
   - `appsettings.json`の`Shopify:Scopes`を、Shopify Partners Dashboardで設定したスコープと一致させる
   - これにより、OAuth認証時に正しいスコープが使用されます

### Phase 2（将来）の推奨方法

1. **shopify.app.tomlでスコープを定義**
   - `shopify.app.toml`に`scopes`を定義
   - これが**唯一の真実の源（Single Source of Truth）**になります

2. **shopify app deployでデプロイ**
   - `shopify app deploy`を実行してShopify Partners Dashboardに反映
   - Shopifyが自動的にスコープを管理

3. **バックエンドの設定は削除しない**
   - 後方互換性のために`appsettings.json`の`Shopify:Scopes`は残しておく
   - ただし、Shopify Managed Installationでは使用されません

---

## スコープ設定の確認方法

### Shopify Partners Dashboardでの確認

1. Shopify Partners Dashboardにログイン
2. 対象のアプリを選択
3. **「App setup」**または**「Settings」**タブを開く
4. **「App versions」**セクションで現在のバージョンのスコープを確認

### バックエンドAPIでの確認

```bash
# テスト用エンドポイント
GET /api/shopify/test-config
```

レスポンスに`Scopes`が含まれます。

---

## トラブルシューティング

### スコープが正しく適用されない場合

1. **Shopify Partners Dashboardの設定を確認**
   - 最新のバージョンでスコープが正しく設定されているか確認

2. **バックエンドの設定を確認**
   - `appsettings.json`の`Shopify:Scopes`が正しく設定されているか確認
   - 環境変数`SHOPIFY_SCOPES`が設定されている場合は、それが優先されます

3. **OAuth認証フローを再実行**
   - スコープを変更した場合は、再認証が必要です
   - 既存のインストール済みストアには、次回の再認証時に新しいスコープが適用されます

---

## 参考資料

- [Shopify公式ドキュメント: Access scopes](https://shopify.dev/docs/api/usage/access-scopes)
- [Shopify公式ドキュメント: App installation](https://shopify.dev/docs/apps/build/authentication-authorization/app-installation)
- [shopify.app.toml-デプロイ解説.md](./shopify.app.toml-デプロイ解説.md)
- [現状設計の問題点と修正方針.md](./現状設計の問題点と修正方針.md)

---

## 更新履歴

- 2025-12-26: 初版作成
