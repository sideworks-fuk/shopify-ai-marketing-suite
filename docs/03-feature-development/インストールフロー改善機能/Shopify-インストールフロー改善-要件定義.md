# Shopify アプリインストールフロー改善機能 要件定義書

## プロジェクト概要

**プロジェクト名**: Shopify アプリインストールフロー改善機能  
**作成日**: 2025年10月25日  
**作成者**: Devin  
**ステータス**: 要件定義中  

---

## 🎯 プロジェクト目標

### 主要目標
Shopifyアプリの標準的なインストールフローに準拠し、ユーザーが手動でショップドメインを入力する必要をなくし、埋め込みアプリとして自動的にインストール状態を検出・管理する機能を実装する。

**重要**: Shopifyアプリの標準的なパターンでは、ユーザーがショップドメインを手動入力することはほとんどない。埋め込みアプリとして、App Bridgeセッショントークンから自動的にショップ情報を取得し、インストール状態を検出して適切なフローに誘導する。

### 成功基準
- 埋め込みアプリでの自動インストールフロー実装（手動入力不要）
- インストール状態の自動検出と適切なフロー分岐
- スコープ変更時の自動再認証フロー
- App Bridgeを使用したトップレベルリダイレクト
- 外部エントリーポイント（マーケティングリンク等）のフォールバック対応
- インストールページの表示率を90%削減（自動リダイレクトにより）

---

## 🚨 現状の問題

### 問題1: 手動ショップドメイン入力の必要性
- **現象**: ユーザーが `/install` ページでショップドメインを手動入力する必要がある
- **原因**: Shopify埋め込みアプリの標準的なフローに準拠していない
- **影響**: ユーザーエクスペリエンスの低下、インストール離脱率の増加

### 問題2: インストール状態チェックの欠如
- **現象**: 既にインストール済みのショップでも毎回OAuthフローを実行する
- **原因**: インストール状態を確認するAPIエンドポイントが存在しない
- **影響**: 不要な認証フロー、ユーザーの混乱

### 問題3: スコープ変更時の再認証フローの欠如
- **現象**: アプリのスコープを追加しても、既存ユーザーに再認証を促す仕組みがない
- **原因**: スコープ検証ロジックの不在
- **影響**: 新機能が使用できない、エラーの発生

### 問題4: 埋め込みアプリでのリダイレクト問題
- **現象**: iframeからのリダイレクトがブロックされる可能性がある
- **原因**: App Bridgeを使用したトップレベルリダイレクトの未実装
- **影響**: インストールフローの失敗、ユーザーの混乱

### 問題5: hostパラメータの伝播不足
- **現象**: OAuthフロー完了後、埋め込みアプリとして正しく読み込まれない
- **原因**: `host`パラメータがリダイレクトチェーン全体で保持されていない
- **影響**: 埋め込みアプリとして動作しない、再読み込みが必要

### 問題6: 外部エントリーポイントの考慮不足
- **現象**: マーケティングリンクや外部サイトからのアクセス時の対応が不十分
- **原因**: `shop`パラメータがない場合のフォールバック処理の不足
- **影響**: 外部からのユーザー獲得機会の損失

---

## 👥 ステークホルダー

### 主要ユーザー
- **Shopify管理画面からのユーザー**: 埋め込みアプリとしてアクセス（最も一般的）
- **App Storeからのユーザー**: App Storeリスティングからインストール
- **マーケティングリンクからのユーザー**: 外部サイトやメールからアクセス
- **既存ユーザー**: 既にインストール済みで再アクセス
- **スコープ更新が必要なユーザー**: アプリ更新後の再認証が必要

### 影響を受けるシステム
- フロントエンド認証システム
- バックエンドOAuth認証フロー
- Shopify App Bridge統合
- インストールページUI
- 認証ガード（AuthGuard）

---

## 📋 機能要件

### 1. インストール状態チェックAPI

#### 1.1 ステータスエンドポイント
- **要件**: ショップのインストール状態を返すAPIエンドポイント
- **詳細**:
  - エンドポイント: `GET /api/shopify/status?shop=<domain>`
  - レスポンス:
    - `installed`: boolean（インストール済みかどうか）
    - `scopesValid`: boolean（スコープが最新かどうか）
    - `missingScopes`: string[]（不足しているスコープのリスト）
    - `installUrl`: string（インストールURL）
    - `reauthUrl`: string（再認証URL）
  - 認証: 不要（公開エンドポイント、ショップドメイン検証のみ）
- **優先度**: 高
- **受け入れ基準**:
  - 未インストールのショップで `installed: false` を返す
  - インストール済みで最新スコープのショップで `installed: true, scopesValid: true` を返す
  - スコープ不足のショップで `installed: true, scopesValid: false, missingScopes: [...]` を返す
  - レスポンスタイム: 500ms以内

#### 1.2 スコープ検証ロジック
- **要件**: 現在のアクセストークンのスコープと必要なスコープを比較
- **詳細**:
  - データベースに保存されたスコープと設定ファイルの必要スコープを比較
  - 不足しているスコープをリストアップ
  - 再認証URLを生成（新しいスコープを含む）
- **優先度**: 高
- **受け入れ基準**:
  - スコープの追加・削除を正確に検出
  - 再認証URLに新しいスコープが含まれる
  - スコープ検証のパフォーマンス: 100ms以内

### 2. 自動インストールフロー

#### 2.1 インストールページの自動リダイレクト
- **要件**: `shop`または`host`パラメータがある場合、自動的にOAuthフローを開始
- **詳細**:
  - URLパラメータから`shop`または`host`を検出
  - `host`パラメータからショップドメインを抽出（base64デコード）
  - 埋め込みアプリの場合、App Bridgeでトップレベルリダイレクト
  - 非埋め込みの場合、通常のリダイレクト
  - パラメータがない場合のみ手動フォームを表示
- **優先度**: 高
- **受け入れ基準**:
  - `shop`パラメータがある場合、自動的にOAuthフローを開始
  - `host`パラメータがある場合、App Bridgeでトップレベルリダイレクト
  - パラメータがない場合、手動フォームを表示
  - 自動リダイレクトまでの時間: 1秒以内

#### 2.2 手動フォームのフォールバック
- **要件**: パラメータがない場合の手動入力フォーム
- **詳細**:
  - 既存のPolarisフォームUIを保持
  - 「このページは通常、自動的にリダイレクトされます」というメッセージを追加
  - 外部エントリーポイントやテスト用途のフォールバック
- **優先度**: 中
- **受け入れ基準**:
  - パラメータがない場合のみ表示
  - フォーム送信で正常にOAuthフローを開始
  - バリデーションエラーの適切な表示

### 3. AuthGuardでの自動インストールチェック

#### 3.1 埋め込みアプリでのインストールチェック
- **要件**: 認証ガードで自動的にインストール状態をチェック
- **詳細**:
  - App Bridgeセッショントークンを取得
  - セッショントークンからショップドメインを抽出
  - `/api/shopify/status` APIを呼び出してインストール状態を確認
  - 未インストールまたはスコープ不足の場合、自動的にOAuthフローを開始
  - インストール済みで正常な場合、アプリを表示
- **優先度**: 高
- **受け入れ基準**:
  - 埋め込みアプリで初回アクセス時、自動的にOAuthフローを開始
  - インストール済みの場合、通常通りアプリを表示
  - スコープ不足の場合、自動的に再認証フローを開始
  - チェック処理時間: 1秒以内

#### 3.2 非埋め込みモードでのフォールバック
- **要件**: デモモードや開発モードでの認証チェック
- **詳細**:
  - デモトークンの存在確認
  - 開発者ツールの認証状態確認
  - 既存の認証ロジックとの互換性維持
- **優先度**: 中
- **受け入れ基準**:
  - デモモードで正常に動作
  - 開発モードで正常に動作
  - 既存機能との互換性維持

### 4. App Bridgeトップレベルリダイレクト

#### 4.1 App Bridge Redirectの実装
- **要件**: 埋め込みアプリでのトップレベルリダイレクト
- **詳細**:
  - `@shopify/app-bridge` の `Redirect` アクションを使用
  - `Redirect.Action.REMOTE` でShopify OAuthページにリダイレクト
  - `host`パラメータを保持してリダイレクト
  - iframeリダイレクトのブロックを回避
- **優先度**: 高
- **受け入れ基準**:
  - 埋め込みアプリでリダイレクトがブロックされない
  - トップレベルでShopify OAuthページが開く
  - `host`パラメータが正しく伝播される

#### 4.2 App Bridgeプロバイダーの実装
- **要件**: App Bridgeインスタンスの管理
- **詳細**:
  - App Bridgeプロバイダーコンポーネントの作成
  - セッショントークン取得機能
  - 埋め込みモード検出機能
  - App Bridgeインスタンスのコンテキスト提供
- **優先度**: 高
- **受け入れ基準**:
  - App Bridgeインスタンスが正しく初期化される
  - セッショントークンが取得できる
  - 埋め込みモードが正しく検出される

### 5. hostパラメータの伝播

#### 5.1 OAuthフロー全体でのhost保持
- **要件**: インストールからコールバックまで`host`パラメータを保持
- **詳細**:
  - `/api/shopify/install` に`host`パラメータを追加
  - Shopify OAuthリダイレクトURLに`host`を含める
  - コールバック処理で`host`を抽出
  - 成功リダイレクトに`host`を含める
  - 最終的なアプリURLに`host`を含める
- **優先度**: 高
- **受け入れ基準**:
  - OAuthフロー全体で`host`が保持される
  - 最終リダイレクト後、埋め込みアプリとして正しく動作
  - `host`の欠落によるエラーが発生しない

#### 5.2 hostパラメータの検証
- **要件**: `host`パラメータの妥当性検証
- **詳細**:
  - base64エンコードの検証
  - デコード後のショップドメイン検証
  - 改ざん検出
- **優先度**: 中
- **受け入れ基準**:
  - 不正な`host`パラメータを検出
  - 改ざんされた`host`を拒否
  - 適切なエラーメッセージを表示

### 6. レート制限とセキュリティ

#### 6.1 インストールエンドポイントのレート制限
- **要件**: ショップ列挙攻撃の防止
- **詳細**:
  - IPアドレスベースのレート制限
  - ショップドメインベースのレート制限
  - 異常なアクセスパターンの検出
  - レート制限超過時の適切なエラーレスポンス
- **優先度**: 高
- **受け入れ基準**:
  - レート制限が正しく機能
  - 正常なユーザーに影響しない
  - 攻撃を効果的に防止

#### 6.2 ショップドメイン検証の強化
- **要件**: 不正なショップドメインの検出
- **詳細**:
  - `.myshopify.com` で終わることを確認
  - 危険な文字の検出
  - オープンリダイレクトの防止
  - ホワイトリスト機能（カスタムアプリの場合）
- **優先度**: 高
- **受け入れ基準**:
  - 不正なドメインを拒否
  - オープンリダイレクトが発生しない
  - セキュリティログが記録される

---

## 🔒 非機能要件

### 1. パフォーマンス要件

#### 1.1 レスポンスタイム
- インストール状態チェックAPI: 500ms以内
- スコープ検証: 100ms以内
- 自動リダイレクト: 1秒以内
- AuthGuardチェック: 1秒以内

#### 1.2 スループット
- インストールエンドポイント: 100リクエスト/秒
- ステータスエンドポイント: 200リクエスト/秒

### 2. セキュリティ要件

#### 2.1 認証・認可
- すべてのセキュリティ判定はサーバー側で実施
- クライアント側のパラメータを信頼しない
- App Bridgeセッショントークンの検証

#### 2.2 データ保護
- ショップドメインの検証
- `host`パラメータの検証
- オープンリダイレクトの防止

#### 2.3 レート制限
- IPベースのレート制限
- ショップベースのレート制限
- ブルートフォース攻撃対策

### 3. 可用性要件

#### 3.1 稼働率
- 目標稼働率: 99.9%
- 計画メンテナンス: 月1回、深夜時間帯

#### 3.2 障害対応
- 自動フェイルオーバー
- エラーハンドリング
- フォールバック機能

### 4. 拡張性要件

#### 4.1 スケーラビリティ
- 水平スケーリング対応
- ステートレス設計
- 分散キャッシュ対応

#### 4.2 保守性
- ログ記録
- モニタリング
- デバッグ機能

---

## 📊 ユースケース

### ユースケース1: Shopify管理画面からの初回アクセス（埋め込みアプリ）

**アクター**: Shopifyストアオーナー

**前提条件**:
- アプリが未インストール
- Shopify管理画面からアプリを開く
- `host`パラメータが存在

**フロー**:
1. ユーザーがShopify管理画面でアプリをクリック
2. アプリが埋め込みiframeで読み込まれる
3. AuthGuardがApp Bridgeセッショントークンを取得
4. セッショントークンからショップドメインを抽出
5. `/api/shopify/status` APIを呼び出し
6. APIが `installed: false` を返す
7. AuthGuardがApp Bridge Redirectでトップレベルリダイレクトを実行
8. Shopify OAuthページが開く
9. ユーザーが権限を承認
10. コールバックが実行され、アクセストークンを取得
11. ストア情報とWebhookを登録
12. `host`パラメータを含む成功ページにリダイレクト
13. アプリが埋め込みモードで正常に表示される

**事後条件**:
- アプリがインストール済み
- アクセストークンが保存される
- Webhookが登録される

### ユースケース2: 既にインストール済みのショップでの再アクセス

**アクター**: Shopifyストアオーナー

**前提条件**:
- アプリが既にインストール済み
- スコープが最新
- Shopify管理画面からアプリを開く

**フロー**:
1. ユーザーがShopify管理画面でアプリをクリック
2. アプリが埋め込みiframeで読み込まれる
3. AuthGuardがApp Bridgeセッショントークンを取得
4. セッショントークンからショップドメインを抽出
5. `/api/shopify/status` APIを呼び出し
6. APIが `installed: true, scopesValid: true` を返す
7. AuthGuardが認証済みと判定
8. アプリが通常通り表示される

**事後条件**:
- OAuthフローが実行されない
- アプリが即座に表示される

### ユースケース3: スコープ更新後の再認証

**アクター**: Shopifyストアオーナー

**前提条件**:
- アプリが既にインストール済み
- アプリのスコープが更新された（新機能追加）
- 既存のアクセストークンのスコープが不足

**フロー**:
1. ユーザーがShopify管理画面でアプリをクリック
2. アプリが埋め込みiframeで読み込まれる
3. AuthGuardがApp Bridgeセッショントークンを取得
4. セッショントークンからショップドメインを抽出
5. `/api/shopify/status` APIを呼び出し
6. APIが `installed: true, scopesValid: false, missingScopes: [...]` を返す
7. AuthGuardがApp Bridge Redirectで再認証URLにリダイレクト
8. Shopify OAuthページが開く（新しいスコープを含む）
9. ユーザーが追加権限を承認
10. コールバックが実行され、新しいアクセストークンを取得
11. ストア情報を更新
12. アプリが正常に表示される

**事後条件**:
- 新しいスコープでアクセストークンが更新される
- 新機能が使用可能になる

### ユースケース4: 外部マーケティングリンクからのアクセス

**アクター**: 潜在的なユーザー

**前提条件**:
- 外部サイトやメールからアクセス
- `shop`も`host`もURLパラメータに存在しない

**フロー**:
1. ユーザーが外部リンクをクリック
2. インストールページが読み込まれる
3. `shop`と`host`パラメータがないことを検出
4. 手動入力フォームを表示
5. ユーザーがショップドメインを入力
6. フォームを送信
7. OAuthフローが開始される
8. 以降は通常のインストールフローと同じ

**事後条件**:
- 手動入力フォームがフォールバックとして機能
- 外部からのユーザー獲得が可能

### ユースケース5: App Storeからのインストール

**アクター**: Shopifyストアオーナー

**前提条件**:
- Shopify App Storeでアプリを発見
- インストールボタンをクリック
- `shop`パラメータが存在

**フロー**:
1. ユーザーがApp Storeでインストールボタンをクリック
2. インストールページが`shop`パラメータ付きで読み込まれる
3. `shop`パラメータを検出
4. 自動的にOAuthフローを開始
5. Shopify OAuthページにリダイレクト
6. ユーザーが権限を承認
7. コールバックが実行される
8. アプリがインストールされる

**事後条件**:
- App Storeからのスムーズなインストール
- 手動入力が不要

---

## 🎨 UI/UX要件

### 1. インストールページ

#### 1.1 自動リダイレクト時の表示
- ローディングスピナー
- 「Shopifyストアに接続中...」メッセージ
- プログレスインジケーター

#### 1.2 手動フォーム表示時
- 「このページは通常、自動的にリダイレクトされます」という説明
- ショップドメイン入力フィールド
- インストールボタン
- アプリの機能説明
- 必要な権限の説明

### 2. エラーハンドリング

#### 2.1 エラーメッセージ
- ユーザーフレンドリーなエラーメッセージ
- 具体的な解決方法の提示
- サポートリンク

#### 2.2 エラーモーダル
- エラー詳細の表示
- 「もう一度試す」ボタン
- 「ヘルプを見る」ボタン

---

## 📝 制約事項

### 技術的制約
- Shopify App Bridge 4.x以降を使用
- Next.js App Routerを使用
- .NET 8.0を使用
- SQL Serverデータベースを使用

### ビジネス的制約
- Shopifyのレート制限に準拠
- Shopify Partner規約に準拠
- GDPRおよびプライバシー規制に準拠

### 運用的制約
- 既存のOAuthフローとの互換性維持
- 既存ユーザーへの影響最小化
- 段階的なロールアウト

---

## 🔄 依存関係

### 前提条件
- Shopify Partner アカウント
- App Bridge設定の完了
- OAuth認証の基本実装
- データベーススキーマの準備

### 関連機能
- 認証モード制御機能
- OAuth認証フロー
- セッション管理
- Webhook管理

---

## 📈 成功指標（KPI）

### 定量的指標
- インストールページの手動表示率: 90%削減（目標: 10%以下）
- インストール完了率: 20%向上（目標: 80%以上）
- インストール所要時間: 50%短縮（目標: 30秒以内）
- エラー発生率: 50%削減（目標: 5%以下）
- 再認証成功率: 目標95%以上

### 定性的指標
- ユーザーエクスペリエンスの向上
- インストールフローのシンプル化
- エラーメッセージの明確化
- サポート問い合わせの削減

---

## 🗓️ マイルストーン

### Phase 0: 設計・準備（1週間）
- 要件定義の完了
- 設計書の作成
- 実装計画の策定
- テスト計画の策定

### Phase 1: バックエンド実装（1週間）
- インストール状態チェックAPIの実装
- スコープ検証ロジックの実装
- hostパラメータ伝播の実装
- レート制限の実装

### Phase 2: フロントエンド実装（1週間）
- インストールページの自動リダイレクト実装
- App Bridgeプロバイダーの実装
- AuthGuardの改修
- エラーハンドリングの実装

### Phase 3: 統合・テスト（1週間）
- 統合テスト
- E2Eテスト
- セキュリティテスト
- パフォーマンステスト

### Phase 4: デプロイ・監視（継続）
- ステージング環境へのデプロイ
- 本番環境へのデプロイ
- モニタリング
- フィードバック収集

---

## 📚 参考資料

### Shopify公式ドキュメント
- [Shopify App Bridge](https://shopify.dev/docs/api/app-bridge)
- [OAuth Authentication](https://shopify.dev/docs/apps/auth/oauth)
- [Session Tokens](https://shopify.dev/docs/apps/auth/oauth/session-tokens)
- [App Installation](https://shopify.dev/docs/apps/launch/deployment/app-installation)

### 内部ドキュメント
- 認証モード制御機能 要件定義書
- OAuth認証フロー設計書
- データベーススキーマ設計書

---

## 📞 連絡先

### プロジェクトオーナー
- 名前: Hirofumi Fukuda
- メール: h.fukuda1207@gmail.com

### 開発チーム
- バックエンド: Kenji
- フロントエンド: YUKI
- DevOps: 未定

---

## 📋 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-10-25 | 1.0 | 初版作成 | Devin |

---

## ✅ 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | | | |
| 技術リード | | | |
| セキュリティ担当 | | | |
