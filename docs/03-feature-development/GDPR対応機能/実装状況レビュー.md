# GDPRå¯¾å¿œæ©Ÿèƒ½ - å®Ÿè£…çŠ¶æ³ãƒ¬ãƒ“ãƒ¥ãƒ¼

**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ—¥**: 2025-12-31
**ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…**: ç¦ç”° + AI Assistant
**å¯¾è±¡**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

---

## 1. å®Ÿè£…æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | æ¦‚è¦ | å®Œäº†åº¦ |
|----------|------|--------|
| `Controllers/WebhookController.cs` | Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | âœ… 100% |
| `Services/GDPRService.cs` | GDPRå‡¦ç†ã‚µãƒ¼ãƒ“ã‚¹ | âœ… 100% |
| `Services/DataCleanupService.cs` | ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚µãƒ¼ãƒ“ã‚¹ | âœ… 100% |
| `Jobs/GdprProcessingJob.cs` | Hangfireã‚¸ãƒ§ãƒ– | âœ… 100% |
| `Models/GDPRModels.cs` | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ¢ãƒ‡ãƒ« | âœ… 100% |
| `Middleware/HmacValidationMiddleware.cs` | HMACæ¤œè¨¼ | âš ï¸ å•é¡Œã‚ã‚Š |

---

## 2. WebhookController.cs è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼

### 2.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…çŠ¶æ³

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ«ãƒ¼ãƒˆ | å®Ÿè£…çŠ¶æ³ | å‚™è€ƒ |
|---------------|--------|---------|------|
| app/uninstalled | `POST /api/webhook/uninstalled` | âœ… å®Œäº† | |
| customers/redact | `POST /api/webhook/customers-redact` | âœ… å®Œäº† | |
| shop/redact | `POST /api/webhook/shop-redact` | âœ… å®Œäº† | |
| customers/data_request | `POST /api/webhook/customers-data-request` | âœ… å®Œäº† | |
| app_subscriptions/update | `POST /api/webhook/subscriptions-update` | âœ… å®Œäº† | èª²é‡‘é€£æº |
| app_subscriptions/cancel | `POST /api/webhook/subscriptions-cancel` | âœ… å®Œäº† | èª²é‡‘é€£æº |

### 2.2 å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½

#### âœ… å¿…é ˆãƒ˜ãƒƒãƒ€æ¤œè¨¼
```csharp
// WebhookController.cs:936-970
private bool ValidateRequiredHeaders(string expectedTopic, out string topic, out string shopDomain, out string webhookId)
{
    topic = Request.Headers["X-Shopify-Topic"].ToString();
    shopDomain = Request.Headers["X-Shopify-Shop-Domain"].ToString();
    webhookId = Request.Headers["X-Shopify-Webhook-Id"].ToString();
    
    // è¨±å¯ãƒˆãƒ”ãƒƒã‚¯ãƒªã‚¹ãƒˆã§æ¤œè¨¼
    var allowed = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        "app/uninstalled", "customers/redact", "shop/redact",
        "customers/data_request", "app_subscriptions/update", "app_subscriptions/cancel"
    };
    // ...
}
```

#### âœ… HMACæ¤œè¨¼ï¼ˆãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œï¼‰
```csharp
// WebhookController.cs:429-511
private async Task<bool> VerifyWebhookRequest()
{
    // 1. X-Shopify-Hmac-SHA256ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—
    // 2. X-Shopify-Shop-Domainã‹ã‚‰ã‚¹ãƒˆã‚¢ã®ShopifyAppã‚’ç‰¹å®š
    // 3. ShopifyApp.ApiSecretã§HMACæ¤œè¨¼
    // 4. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®WebhookSecret
    // 5. å›ºå®šæ™‚é–“æ¯”è¼ƒã§æ¤œè¨¼
    return CryptographicOperations.FixedTimeEquals(computedHashBytes, receivedHmacBytes);
}
```

#### âœ… å³æ™‚200å¿œç­”ï¼ˆ5ç§’ãƒ«ãƒ¼ãƒ«å¯¾ç­–ï¼‰
```csharp
// WebhookController.cs:87-107
// éåŒæœŸã§å‡¦ç†ã‚’å®Ÿè¡Œ
_ = Task.Run(async () =>
{
    try
    {
        await CancelStoreSubscription(webhook.Domain);
        await ScheduleDataDeletion(webhook.Domain, 48);
    }
    catch (Exception ex) { /* ãƒ­ã‚°è¨˜éŒ² */ }
});

// å³åº§ã«200 OKã‚’è¿”ã™ï¼ˆ5ç§’ãƒ«ãƒ¼ãƒ«ï¼‰
return Ok();
```

#### âœ… å†ªç­‰æ€§ã‚­ãƒ¼ç”Ÿæˆ
```csharp
// WebhookController.cs:977-1001
private string GenerateWebhookIdempotencyKey(string shopDomain, string topic, string payloadJson)
{
    // hash(StoreDomain + Topic + created_at + X-Shopify-Webhook-Id)
    var seed = $"{shopDomain}|{topic}|{createdAt}|{webhookId}";
    using var sha = SHA256.Create();
    var hash = sha.ComputeHash(Encoding.UTF8.GetBytes(seed));
    return Convert.ToBase64String(hash);
}
```

#### âœ… ã‚µã‚¤ã‚ºä¸Šé™ãƒã‚§ãƒƒã‚¯
```csharp
// WebhookController.cs:24
[RequestSizeLimit(262144)] // 256 KB ä¸Šé™

// WebhookController.cs:522-527
if (Encoding.UTF8.GetByteCount(body) > 262144)
{
    throw new InvalidOperationException("Payload too large");
}
```

### 2.3 å•é¡Œç‚¹ãƒ»èª²é¡Œ

#### ğŸ”´ æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒæœªå®Œæˆ

```csharp
// WebhookController.cs:616-626
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    // é–‹ç™ºç’°å¢ƒã§ã¯å³åº§ã«å‰Šé™¤
    await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
}
else
{
    // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("æœ¬ç•ªç’°å¢ƒã§ã¯{Days}æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™...");
}
```

**åŒæ§˜ã®TODOãŒä»¥ä¸‹ã«ã‚‚å­˜åœ¨**:
- `ScheduleDataDeletion()` - 624è¡Œç›®
- `ScheduleCustomerDataDeletion()` - 649è¡Œç›®
- `ScheduleShopDataDeletion()` - 659è¡Œç›®
- `ScheduleCustomerDataExport()` - 672è¡Œç›®

---

## 3. GDPRService.cs è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼

### 3.1 å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç›®çš„ | çŠ¶æ³ |
|---------|------|------|
| `CreateRequestAsync()` | GDPRè¦æ±‚ã‚’ä½œæˆ | âœ… å®Œäº† |
| `ProcessCustomerDataRequestAsync()` | ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | âœ… å®Œäº† |
| `ProcessCustomerRedactAsync()` | é¡§å®¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | âœ… å®Œäº† |
| `ProcessShopRedactAsync()` | ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | âœ… å®Œäº† |
| `MarkAsCompletedAsync()` | å®Œäº†ãƒãƒ¼ã‚¯ | âœ… å®Œäº† |
| `MarkAsFailedAsync()` | å¤±æ•—ãƒãƒ¼ã‚¯ï¼ˆãƒªãƒˆãƒ©ã‚¤å¯¾å¿œï¼‰ | âœ… å®Œäº† |
| `GetStatisticsAsync()` | çµ±è¨ˆå–å¾— | âœ… å®Œäº† |
| `GenerateComplianceReportAsync()` | ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ | âœ… å®Œäº† |

### 3.2 æœŸé™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

```csharp
// GDPRService.cs:513-521
private DateTime CalculateDueDate(string requestType)
{
    return requestType.ToLower() switch
    {
        "customers_data_request" => DateTime.UtcNow.AddDays(10),  // 10æ—¥ä»¥å†…
        "customers_redact" => DateTime.UtcNow.AddDays(30),        // 30æ—¥ä»¥å†…
        "shop_redact" => DateTime.UtcNow.AddDays(90),            // 90æ—¥ä»¥å†…
        _ => DateTime.UtcNow.AddDays(30)
    };
}
```

### 3.3 ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒãƒƒã‚¯ã‚ªãƒ•

```csharp
// GDPRService.cs:406-414
if (request.CanRetry)
{
    request.Status = "pending";
    request.ScheduledFor = DateTime.UtcNow.AddHours(Math.Pow(2, request.RetryCount)); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
}
```

---

## 4. GdprProcessingJob.cs è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼

### 4.1 Hangfireã‚¸ãƒ§ãƒ–ç™»éŒ²

```csharp
// Program.cs:311-323
RecurringJob.AddOrUpdate<GdprProcessingJob>(
    "gdpr-process-pending",
    job => job.ProcessPendingRequests(),
    "*/5 * * * *");  // 5åˆ†ã”ã¨ã«å®Ÿè¡Œ
```

### 4.2 å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯

```csharp
// GdprProcessingJob.cs:24-66
[DisableConcurrentExecution(timeoutInSeconds: 300)]
public async Task ProcessPendingRequests()
{
    var pending = await _gdprService.GetPendingRequestsAsync();
    foreach (var request in pending)
    {
        switch (request.RequestType.ToLower())
        {
            case "customers_data_request":
                await _gdprService.ProcessCustomerDataRequestAsync(request.Id);
                break;
            // ...
        }
    }
}
```

---

## 5. HmacValidationMiddleware.cs å•é¡Œåˆ†æ

### 5.1 äºŒé‡æ¤œè¨¼å•é¡Œ

ç¾åœ¨ã€HMACæ¤œè¨¼ãŒ**2ç®‡æ‰€ã§å®Ÿè¡Œ**ã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢** (`HmacValidationMiddleware.cs`)
   - `Program.cs:542` ã§ç™»éŒ²
   - `/api/webhook/*` ãƒ‘ã‚¹ã«é©ç”¨
   - **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®`WebhookSecret`ã®ã¿ä½¿ç”¨**
   - å¤±æ•—æ™‚: **401 Unauthorized**

2. **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼** (`WebhookController.cs:VerifyWebhookRequest()`)
   - å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å€‹åˆ¥ã«å‘¼ã³å‡ºã—
   - **ãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œï¼ˆã‚¹ãƒˆã‚¢åˆ¥ApiSecretå–å¾—ï¼‰**
   - å¤±æ•—æ™‚: **403 Forbid**

### 5.2 å•é¡Œã®å½±éŸ¿

```
Shopify â†’ Webhookã‚’é€ä¿¡
    â†“
HmacValidationMiddleware (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®WebhookSecretã§æ¤œè¨¼)
    â†“ å¤±æ•— â†’ 401 Unauthorized â† å•é¡Œç™ºç”Ÿç®‡æ‰€
    â†“ æˆåŠŸ
WebhookController.VerifyWebhookRequest() (ã‚¹ãƒˆã‚¢åˆ¥ApiSecretã§æ¤œè¨¼)
    â†“ å¤±æ•— â†’ 403 Forbid
    â†“ æˆåŠŸ
å‡¦ç†å®Ÿè¡Œ
```

### 5.3 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¾çŠ¶

```json
// appsettings.Development.json
"WebhookSecret": ""  // ç©ºæ–‡å­—

// appsettings.Staging.json
"WebhookSecret": "your_staging_webhook_secret"  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼

// appsettings.Production.json
"WebhookSecret": ""  // ç©ºæ–‡å­—ã¾ãŸã¯æœªè¨­å®š
```

**å•é¡Œ**: `WebhookSecret`ãŒæœªè¨­å®šã¾ãŸã¯ç„¡åŠ¹ãªå€¤ã®ãŸã‚ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

### 5.4 ä¿®æ­£æ–¹é‡

**æ¨å¥¨**: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œæ¤œè¨¼ã®ã¿ã‚’ä½¿ç”¨

```csharp
// Program.cs - ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
// app.UseHmacValidation();
```

---

## 6. GDPRModels.cs è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼

### 6.1 ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¸€è¦§

| ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ | ç›®çš„ | çŠ¶æ³ |
|-------------|------|------|
| `GDPRRequest` | GDPRè¦æ±‚ç®¡ç† | âœ… å®Œäº† |
| `GDPRDeletionLog` | å‰Šé™¤ç›£æŸ»è¨¼è·¡ | âœ… å®Œäº† |
| `GDPRStatistics` | çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ | âœ… å®Œäº† |

### 6.2 è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

```csharp
// GDPRModels.cs:151-158
[NotMapped]
public bool IsOverdue => Status != "completed" && DateTime.UtcNow > DueDate;

[NotMapped]
public int DaysUntilDue => (int)(DueDate - DateTime.UtcNow).TotalDays;

[NotMapped]
public bool CanRetry => RetryCount < MaxRetries && Status == "failed";
```

---

## 7. ç·åˆè©•ä¾¡

### 7.1 å®Œäº†åº¦ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | å®Œäº†åº¦ | è©³ç´° |
|---------|--------|------|
| Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | âœ… 100% | 6ç¨®ã™ã¹ã¦å®Ÿè£…æ¸ˆã¿ |
| HMACæ¤œè¨¼ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼‰ | âœ… 100% | ãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œæ¸ˆã¿ |
| å³æ™‚200å¿œç­” | âœ… 100% | éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³æ¡ç”¨ |
| å†ªç­‰åŒ–å‡¦ç† | âœ… 100% | IdempotencyKeyå®Ÿè£…æ¸ˆã¿ |
| GDPRè¦æ±‚ç®¡ç† | âœ… 100% | ä½œæˆãƒ»æ›´æ–°ãƒ»å®Œäº†ç®¡ç† |
| ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚µãƒ¼ãƒ“ã‚¹ | âœ… 100% | é¡§å®¢ãƒ»ã‚·ãƒ§ãƒƒãƒ—å‰Šé™¤å¯¾å¿œ |
| ç›£æŸ»ãƒ­ã‚° | âœ… 100% | å‰Šé™¤è¨¼è·¡ã®è¨˜éŒ² |
| Hangfireå®šæœŸã‚¸ãƒ§ãƒ– | âœ… 100% | 5åˆ†é–“éš”ã§å®Ÿè¡Œ |
| ~~æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«~~ | âœ… 100% | **2025-12-31 ä¿®æ­£æ¸ˆã¿** |
| ~~ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢äºŒé‡æ¤œè¨¼~~ | âœ… 100% | **2025-12-31 ä¿®æ­£æ¸ˆã¿** |
| ~~DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„~~ | âœ… 100% | **2025-12-31 è¿½åŠ æ¸ˆã¿** |

### 7.2 ã‚³ãƒ¼ãƒ‰å“è³ª

- âœ… ãƒ­ã‚°å‡ºåŠ›ãŒé©åˆ‡ï¼ˆå€‹äººæƒ…å ±ã‚’å«ã¾ãªã„ï¼‰
- âœ… ä¾‹å¤–å‡¦ç†ãŒå®Ÿè£…æ¸ˆã¿
- âœ… éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©åˆ‡ã«ä½¿ç”¨
- âœ… å›ºå®šæ™‚é–“æ¯”è¼ƒã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–
- âœ… DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãŒè¿½åŠ æ¸ˆã¿ï¼ˆ2025-12-31ï¼‰

---

## 8. å®Œäº†ã—ãŸä¿®æ­£ï¼ˆ2025-12-31ï¼‰

| # | ä¿®æ­£å†…å®¹ | è©³ç´° |
|---|---------|------|
| 1 | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç„¡åŠ¹åŒ– | `Program.cs` ã® `app.UseHmacValidation()` ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ |
| 2 | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ä¿®æ­£ | `Forbid()` â†’ `Unauthorized()` (12ç®‡æ‰€) |
| 3 | æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚° | `Hangfire.BackgroundJob.Schedule()` å®Ÿè£… |
| 4 | DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ | `IX_WebhookEvents_IdempotencyKey` ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ  |

## 9. æ®‹ã‚¿ã‚¹ã‚¯

- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ï¼ˆStaging/Productionï¼‰
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] E2Eæ¤œè¨¼
