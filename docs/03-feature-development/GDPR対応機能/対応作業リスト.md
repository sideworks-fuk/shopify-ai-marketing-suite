# GDPR対応機能 - 対応作業リスト

**作成日**: 2025-12-31
**目的**: 公開アプリ申請前に完了すべき作業を優先度順に整理

---

## 1. 申請ブロッカー（必須対応）

### 1.1 🔴 HMAC検証の修正（二重検証問題 + 401対応）

**問題**: 
1. ミドルウェアとコントローラーで二重HMAC検証が行われ、ミドルウェアが401を返している
2. コントローラーは403 Forbidを返しているが、**Shopify公式は401 Unauthorizedを要求**

**修正箇所**: 
- `backend/ShopifyAnalyticsApi/Program.cs`
- `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

**修正内容①**: ミドルウェア無効化
```csharp
// Program.cs 542行目付近 - コメントアウト
// app.UseHmacValidation();
```

**修正内容②**: 403 → 401 に変更（12箇所）
```csharp
// Before:
return Forbid();

// After:
return Unauthorized();
```

**対象箇所**:
- 63行目, 70行目 (app/uninstalled)
- 129行目, 135行目 (customers/redact)
- 195行目, 201行目 (shop/redact)
- 260行目, 266行目 (customers/data_request)
- 325行目, 331行目 (subscriptions/update)
- 381行目, 387行目 (subscriptions/cancel)

**理由**:
- Shopify公式: HMAC検証失敗時は401 Unauthorizedを返す必要がある
- WebhookController.VerifyWebhookRequest() がマルチアプリ対応済み
- ミドルウェアは設定ファイルのWebhookSecretのみ参照（マルチアプリ非対応）

**工数**: 30分

**担当**: バックエンド

---

### 1.2 🔴 本番削除スケジューリングの実装

**問題**: 本番環境でのデータ削除がTODOのまま

**修正箇所**: `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

**現状コード**:
```csharp
// 624-626行目
else
{
    // TODO: 本番環境ではHangfireでスケジュール
    _logger.LogInformation("本番環境では{Days}日後にデータを削除します...");
}
```

**修正案**:
```csharp
else
{
    // Hangfireで遅延ジョブをスケジュール
    var scheduledTime = DateTime.UtcNow.AddHours(daysToDelete * 24);
    BackgroundJob.Schedule<IDataCleanupService>(
        service => service.DeleteStoreDataAsync(shopDomain),
        scheduledTime);
    
    _logger.LogInformation("データ削除をスケジュール. Shop: {Shop}, 予定日時: {ScheduledTime}", 
        shopDomain, scheduledTime);
}
```

**修正が必要なメソッド**:

| メソッド | 行番号 | 対象 |
|---------|--------|------|
| `ScheduleDataDeletion()` | 617-626 | ストアデータ削除 |
| `ScheduleCustomerDataDeletion()` | 641-651 | 顧客データ削除 |
| `ScheduleShopDataDeletion()` | 657-665 | ショップデータ削除 |
| `ScheduleCustomerDataExport()` | 669-678 | 顧客データエクスポート |

**工数**: 0.5日

**担当**: バックエンド

---

### 1.3 🔴 E2E検証の実施

**問題**: 実環境でのWebhook動作確認が未実施

**検証内容**:

| 項目 | 確認内容 | 証跡 |
|------|---------|------|
| HMAC検証成功 | 正しい署名で200 OK | ログ/スクショ |
| HMAC検証失敗 | 不正署名で403 Forbid | ログ |
| 即時応答 | 5秒以内に応答 | Application Insights |
| 冪等性 | 同一WebhookIdで重複処理なし | DB確認 |
| 削除スケジュール | GDPRRequestsにpending登録 | DB確認 |
| 処理完了 | completedステータスに遷移 | DB確認 |

**工数**: 0.5日

**担当**: 全員

---

## 2. 申請前推奨（高優先度）

### 2.1 🟡 Shopify Partners Dashboard設定確認

**問題**: GDPR Webhookの登録状況とプライバシーポリシーURLの設定が未確認

**確認項目**:

| 項目 | 確認方法 | 現状 |
|------|---------|------|
| Webhook登録状況 | Shopify Admin API で確認 | ❓ |
| プライバシーポリシーURL | Partners Dashboard | ❓ |
| 利用規約URL | Partners Dashboard | ❓ |

**Webhook登録確認方法**:
```bash
# Shopify Admin API で登録済みWebhookを確認
curl -X GET "https://{shop}.myshopify.com/admin/api/2024-01/webhooks.json" \
  -H "X-Shopify-Access-Token: {access_token}"
```

**プライバシーポリシーURL設定手順**:
1. Shopify Partners Dashboard にログイン
2. アプリ「ECレンジャー(local)」を選択
3. 「Configuration」または「App setup」をクリック
4. 「App URLs」セクションで以下を設定:
   - **Privacy policy URL**: `https://your-domain.com/privacy-policy`
   - **Terms of service URL**: `https://your-domain.com/terms`（任意）

**工数**: 30分

**担当**: 福田

---

### 2.3 🟡 DBユニーク制約の追加

**問題**: `WebhookEvents.IdempotencyKey` にDBレベルのユニーク制約がない

**現状**: コード側でExistsチェックのみ実施

**修正案**: EF Core Migrationでユニークインデックス追加

```csharp
// Migration
migrationBuilder.CreateIndex(
    name: "IX_WebhookEvents_IdempotencyKey",
    table: "WebhookEvents",
    column: "IdempotencyKey",
    unique: true);
```

**工数**: 0.25日

**担当**: バックエンド

---

### 2.4 🟡 プライバシーポリシー・利用規約の英語版作成

**問題**: 日本語版のみ存在

**現状**:
- `docs/08-shopify/05-法的文書/プライバシーポリシー案.md` ✅
- `docs/08-shopify/05-法的文書/利用規約案.md` ✅
- 英語版: ❌

**工数**: 0.5日

**担当**: 福田（または翻訳サービス使用）

---

### 2.5 🟡 環境変数の最終確認

**確認項目**:

| 環境変数 | 用途 | Staging | Production |
|---------|------|---------|------------|
| `Shopify:WebhookSecret` | Webhook検証（フォールバック用） | 確認 | 確認 |
| `Shopify:ApiSecret` | OAuth認証 | 確認 | 確認 |
| `SHOPIFY_FRONTEND_BASEURL` | フロントエンドURL | 確認 | 確認 |

**工数**: 30分

**担当**: バックエンド

---

## 3. 申請後対応可能（中優先度）

### 3.1 🟢 期限アラート機能の実装

**概要**: 処理期限が近づいた場合の通知機能

**対象**:
- 期限24時間前: 警告
- 期限超過: 緊急アラート

**通知先候補**:
- Application Insights
- Slack
- メール

**工数**: 0.5日

---

### 3.2 🟢 コンプライアンスレポートの自動生成

**概要**: 月次でGDPR処理状況レポートを生成

**現状**: `GDPRService.GenerateComplianceReportAsync()` が実装済みだが、定期実行未設定

**工数**: 0.25日

---

### 3.3 🟢 PIIログガード強化

**概要**: ログに個人情報が出力されないことの再点検

**確認ポイント**:
- メールアドレス
- 電話番号
- 住所
- 顧客名

**工数**: 0.25日

---

## 4. 作業スケジュール案

```
Day 1:
  ├── [30分] HmacValidationMiddleware無効化
  ├── [2時間] 本番スケジューリング実装
  └── [1時間] DBユニーク制約追加

Day 2:
  ├── [4時間] E2E検証実施
  └── [2時間] 証跡採取・ドキュメント化

Day 3:
  ├── [2時間] 法的文書英語版作成
  └── [2時間] 最終確認・申請準備
```

---

## 5. チェックリスト

### 申請前必須
- [ ] HmacValidationMiddleware無効化
- [ ] 本番スケジューリング実装
- [ ] E2E検証完了（4種Webhook）
- [ ] 証跡採取（ログ/スクショ/動画）

### 申請前推奨
- [ ] DBユニーク制約追加
- [ ] 法的文書英語版
- [ ] 環境変数最終確認
- [ ] ドキュメント整合確認

### 申請後対応
- [ ] 期限アラート機能
- [ ] レポート自動生成
- [ ] PIIログガード強化
