# GDPRå¯¾å¿œæ©Ÿèƒ½ - å¯¾å¿œä½œæ¥­ãƒªã‚¹ãƒˆ

**ä½œæˆæ—¥**: 2025-12-31  
**æœ€çµ‚æ›´æ–°**: 2025-12-31  
**ä½œæ¥­è€…**: ç¦ç”° + AI Assistant

---

## 1. ä½œæ¥­æ¦‚è¦

### 1.1 èƒŒæ™¯

Shopify App Storeã¸ã®å…¬é–‹ç”³è«‹ã«ã¯GDPRå¯¾å¿œãŒå¿…é ˆã§ã™ã€‚
åŸºæœ¬å®Ÿè£…ã¯å®Œäº†ã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®å•é¡Œã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### 1.2 ä½œæ¥­ä¸€è¦§

| # | ä½œæ¥­å†…å®¹ | å„ªå…ˆåº¦ | å·¥æ•° | çŠ¶æ…‹ |
|---|---------|--------|------|------|
| 1 | HmacValidationMiddleware ã®ç„¡åŠ¹åŒ– | ğŸ”´ æœ€é«˜ | 5åˆ† | âœ… å®Œäº† (2025-12-31) |
| 2 | HMACæ¤œè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ | ğŸ”´ æœ€é«˜ | 30åˆ† | âœ… å®Œäº† (2025-12-31) |
| 3 | æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Ÿè£… | ğŸ”´ æœ€é«˜ | 2æ™‚é–“ | âœ… å®Œäº† (2025-12-31) |
| 4 | DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã®è¿½åŠ  | ğŸŸ¡ é«˜ | 30åˆ† | âœ… å®Œäº† (2025-12-31) |
| 5 | E2Eãƒ†ã‚¹ãƒˆã®å®Ÿæ–½ | ğŸ”´ æœ€é«˜ | 4æ™‚é–“ | æœªç€æ‰‹ |

---

## 2. ä½œæ¥­è©³ç´°

---

### ä½œæ¥­1: HmacValidationMiddleware ã®ç„¡åŠ¹åŒ–

#### å•é¡Œ

ç¾åœ¨ã€HMACæ¤œè¨¼ãŒ**2ç®‡æ‰€ã§å®Ÿè¡Œ**ã•ã‚Œã¦ãŠã‚Šã€äºŒé‡æ¤œè¨¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼š

1. **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢** (`HmacValidationMiddleware`) - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®`WebhookSecret`ã®ã¿å‚ç…§
2. **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼** (`WebhookController.VerifyWebhookRequest()`) - ãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œæ¸ˆã¿

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®`WebhookSecret`ï¼ˆç©ºã¾ãŸã¯ç„¡åŠ¹ï¼‰ã§æ¤œè¨¼ã™ã‚‹ãŸã‚ã€
æ­£å½“ãªWebhookã‚‚**401 Unauthorized**ã§æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚

#### ä¿®æ­£å¯¾è±¡

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Program.cs`  
**è¡Œç•ªå·**: 425è¡Œç›®

#### ä¿®æ­£å†…å®¹

```csharp
// ä¿®æ­£å‰ï¼ˆ425è¡Œç›®ï¼‰
app.UseHmacValidation();

// ä¿®æ­£å¾Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
// Shopify Webhookç”¨ã®HMACæ¤œè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
// â€» WebhookController.VerifyWebhookRequest() ãŒãƒãƒ«ãƒã‚¢ãƒ—ãƒªå¯¾å¿œã§æ¤œè¨¼ã™ã‚‹ãŸã‚ç„¡åŠ¹åŒ–
// app.UseHmacValidation();
```

#### ç¢ºèªæ–¹æ³•

1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
2. èµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
3. Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¾ã§åˆ°é”ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### ä½œæ¥­2: HMACæ¤œè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

#### å•é¡Œ

Shopifyå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€HMACæ¤œè¨¼å¤±æ•—æ™‚ã«**401 Unauthorized**ã‚’è¿”ã™ã‚ˆã†æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
ç¾åœ¨ã®å®Ÿè£…ã¯**403 Forbid**ã‚’è¿”ã—ã¦ãŠã‚Šã€Shopifyå¯©æŸ»ã§å•é¡Œã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

> å‚è€ƒ: https://shopify.dev/docs/apps/build/webhooks/subscribe/https#step-5-verify-the-webhook
> "If the HMAC signature doesn't match, then respond with a 401 Unauthorized"

#### ä¿®æ­£å¯¾è±¡

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

#### ä¿®æ­£ç®‡æ‰€ä¸€è¦§

| # | ãƒ¡ã‚½ãƒƒãƒ‰ | è¡Œç•ªå·ï¼ˆæ¦‚ç®—ï¼‰ | ä¿®æ­£å†…å®¹ |
|---|---------|--------------|---------|
| 1 | `AppUninstalled()` | 63, 70 | `Forbid()` â†’ `Unauthorized()` |
| 2 | `CustomersRedact()` | 129, 136 | `Forbid()` â†’ `Unauthorized()` |
| 3 | `ShopRedact()` | 196, 203 | `Forbid()` â†’ `Unauthorized()` |
| 4 | `CustomersDataRequest()` | 261, 268 | `Forbid()` â†’ `Unauthorized()` |
| 5 | `SubscriptionsUpdate()` | 326, 333 | `Forbid()` â†’ `Unauthorized()` |
| 6 | `SubscriptionsCancel()` | 382, 389 | `Forbid()` â†’ `Unauthorized()` |

#### ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³

å„ãƒ¡ã‚½ãƒƒãƒ‰ã§ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿®æ­£ï¼š

```csharp
// ä¿®æ­£å‰
if (!ValidateRequiredHeaders("app/uninstalled", out var topic, out var shopDomainHeader, out var webhookId))
{
    return Forbid();  // â† ä¿®æ­£å¯¾è±¡
}

if (!await VerifyWebhookRequest())
{
    _logger.LogWarning("HMAC verification failed: app/uninstalled");
    return Forbid();  // â† ä¿®æ­£å¯¾è±¡
}

// ä¿®æ­£å¾Œ
if (!ValidateRequiredHeaders("app/uninstalled", out var topic, out var shopDomainHeader, out var webhookId))
{
    return Unauthorized();  // â† 401ã‚’è¿”ã™
}

if (!await VerifyWebhookRequest())
{
    _logger.LogWarning("HMAC verification failed: app/uninstalled");
    return Unauthorized();  // â† 401ã‚’è¿”ã™
}
```

#### ç¢ºèªæ–¹æ³•

1. ä¸æ­£ãªHMACç½²åã§Webhookã‚’é€ä¿¡
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ**401 Unauthorized**ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ãƒ­ã‚°ã«`HMAC verification failed`ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### ä½œæ¥­3: æœ¬ç•ªå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®å®Ÿè£…

#### å•é¡Œ

ç¾åœ¨ã€æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒ**TODOã®ã¾ã¾**ã§ã™ã€‚
é–‹ç™ºç’°å¢ƒã§ã¯å³åº§ã«å‰Šé™¤ã•ã‚Œã¾ã™ãŒã€æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã§å®Ÿéš›ã®å‰Šé™¤ãŒè¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

#### ä¿®æ­£å¯¾è±¡

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs`

#### ä¿®æ­£ç®‡æ‰€

| # | ãƒ¡ã‚½ãƒƒãƒ‰ | è¡Œç•ªå·ï¼ˆæ¦‚ç®—ï¼‰ | ç”¨é€” |
|---|---------|--------------|------|
| 1 | `ScheduleDataDeletion()` | 617-626 | ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆ48æ™‚é–“å¾Œï¼‰ |
| 2 | `ScheduleCustomerDataDeletion()` | 641-651 | é¡§å®¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆ30æ—¥å¾Œï¼‰ |
| 3 | `ScheduleShopDataDeletion()` | 657-665 | ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆ90æ—¥å¾Œï¼‰ |
| 4 | `ScheduleCustomerDataExport()` | 669-678 | é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ |

#### ä¿®æ­£å†…å®¹

**ä¿®æ­£1: ScheduleDataDeletion() ãƒ¡ã‚½ãƒƒãƒ‰**

```csharp
// ä¿®æ­£å‰ï¼ˆ617-626è¡Œç›®ä»˜è¿‘ï¼‰
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    _logger.LogWarning("é–‹ç™ºç’°å¢ƒã®ãŸã‚ã€å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", shopDomain);
    await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
}
else
{
    // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("æœ¬ç•ªç’°å¢ƒã§ã¯{Days}æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", daysToDelete, shopDomain);
}

// ä¿®æ­£å¾Œ
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    _logger.LogWarning("é–‹ç™ºç’°å¢ƒã®ãŸã‚ã€å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", shopDomain);
    await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
}
else
{
    // æœ¬ç•ªç’°å¢ƒ: Hangfireã§é…å»¶ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    var scheduledTime = TimeSpan.FromHours(daysToDelete * 24);
    var jobId = BackgroundJob.Schedule<IDataCleanupService>(
        service => service.DeleteStoreDataAsync(shopDomain),
        scheduledTime);
    
    _logger.LogInformation(
        "ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, JobId: {JobId}, äºˆå®š: {Hours}æ™‚é–“å¾Œ",
        shopDomain, jobId, daysToDelete * 24);
}
```

**ä¿®æ­£2: ScheduleCustomerDataDeletion() ãƒ¡ã‚½ãƒƒãƒ‰**

```csharp
// ä¿®æ­£å‰ï¼ˆ641-651è¡Œç›®ä»˜è¿‘ï¼‰
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    _logger.LogWarning("é–‹ç™ºç’°å¢ƒã®ãŸã‚ã€å³åº§ã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}, CustomerId: {CustomerId}", shopDomain, customerId);
    await _dataCleanupService.DeleteCustomerDataAsync(shopDomain, customerId);
}
else
{
    // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("æœ¬ç•ªç’°å¢ƒã§ã¯{Days}æ—¥å¾Œã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}, CustomerId: {CustomerId}", daysToDelete, shopDomain, customerId);
}

// ä¿®æ­£å¾Œ
if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development" || daysToDelete == 0)
{
    _logger.LogWarning("é–‹ç™ºç’°å¢ƒã®ãŸã‚ã€å³åº§ã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}, CustomerId: {CustomerId}", shopDomain, customerId);
    await _dataCleanupService.DeleteCustomerDataAsync(shopDomain, customerId);
}
else
{
    // æœ¬ç•ªç’°å¢ƒ: Hangfireã§é…å»¶ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    var scheduledTime = TimeSpan.FromDays(daysToDelete);
    var jobId = BackgroundJob.Schedule<IDataCleanupService>(
        service => service.DeleteCustomerDataAsync(shopDomain, customerId),
        scheduledTime);
    
    _logger.LogInformation(
        "é¡§å®¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, CustomerId: {CustomerId}, JobId: {JobId}, äºˆå®š: {Days}æ—¥å¾Œ",
        shopDomain, customerId, jobId, daysToDelete);
}
```

**ä¿®æ­£3: ScheduleShopDataDeletion() ãƒ¡ã‚½ãƒƒãƒ‰**

```csharp
// ä¿®æ­£å‰ï¼ˆ657-665è¡Œç›®ä»˜è¿‘ï¼‰
private async Task ScheduleShopDataDeletion(string shopDomain, int daysToDelete)
{
    // TODO: Azure Service Busã¾ãŸã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, Days: {Days}", 
        shopDomain, daysToDelete);

    // Webhookå±¥æ­´ã‚’è¨˜éŒ²
    await LogWebhookEvent(shopDomain, "shop/redact", new { daysToDelete });
}

// ä¿®æ­£å¾Œ
private async Task ScheduleShopDataDeletion(string shopDomain, int daysToDelete)
{
    _logger.LogInformation("ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, Days: {Days}", 
        shopDomain, daysToDelete);

    // Webhookå±¥æ­´ã‚’è¨˜éŒ²
    await LogWebhookEvent(shopDomain, "shop/redact", new { daysToDelete });

    // æœ¬ç•ªç’°å¢ƒ: Hangfireã§é…å»¶ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") != "Development")
    {
        var scheduledTime = TimeSpan.FromDays(daysToDelete);
        var jobId = BackgroundJob.Schedule<IDataCleanupService>(
            service => service.DeleteStoreDataAsync(shopDomain),
            scheduledTime);
        
        _logger.LogInformation(
            "ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, JobId: {JobId}, äºˆå®š: {Days}æ—¥å¾Œ",
            shopDomain, jobId, daysToDelete);
    }
    else
    {
        _logger.LogWarning("é–‹ç™ºç’°å¢ƒã®ãŸã‚ã€å³åº§ã«ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™. Shop: {Shop}", shopDomain);
        await _dataCleanupService.DeleteStoreDataAsync(shopDomain);
    }
}
```

**ä¿®æ­£4: ScheduleCustomerDataExport() ãƒ¡ã‚½ãƒƒãƒ‰**

```csharp
// ä¿®æ­£å‰ï¼ˆ669-678è¡Œç›®ä»˜è¿‘ï¼‰
private async Task ScheduleCustomerDataExport(string shopDomain, long customerId, long requestId)
{
    // TODO: Azure Service Busã¾ãŸã¯Hangfireã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    _logger.LogInformation("é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, CustomerId: {CustomerId}, RequestId: {RequestId}", 
        shopDomain, customerId, requestId);

    // Webhookå±¥æ­´ã‚’è¨˜éŒ²
    await LogWebhookEvent(shopDomain, "customers/data_request", new { customerId, requestId });
}

// ä¿®æ­£å¾Œ
private async Task ScheduleCustomerDataExport(string shopDomain, long customerId, long requestId)
{
    _logger.LogInformation("é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«. Shop: {Shop}, CustomerId: {CustomerId}, RequestId: {RequestId}", 
        shopDomain, customerId, requestId);

    // Webhookå±¥æ­´ã‚’è¨˜éŒ²
    await LogWebhookEvent(shopDomain, "customers/data_request", new { customerId, requestId });

    // æ³¨: customers/data_request ã¯ GDPRService.ProcessCustomerDataRequestAsync() ã§
    // éåŒæœŸã«å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦
    // GdprProcessingJob ãŒ5åˆ†ã”ã¨ã«pendingãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹
}
```

#### å¿…è¦ãªusingè¿½åŠ 

ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼ˆæœªè¿½åŠ ã®å ´åˆï¼‰ï¼š

```csharp
using Hangfire;
```

#### ç¢ºèªæ–¹æ³•

1. Hangfire Dashboard (`/hangfire`) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. Scheduled Jobs ã‚¿ãƒ–ã‚’ç¢ºèª
3. å‰Šé™¤ã‚¸ãƒ§ãƒ–ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### ä½œæ¥­4: DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã®è¿½åŠ 

#### å•é¡Œ

`WebhookEvents.IdempotencyKey` ã«DBãƒ¬ãƒ™ãƒ«ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ç¾åœ¨ã¯ã‚³ãƒ¼ãƒ‰å´ã§ã®Existsãƒã‚§ãƒƒã‚¯ã®ã¿ã§ã€ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«é‡è¤‡ç™»éŒ²ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### ä¿®æ­£æ–¹æ³•

**Step 1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ**

```bash
cd backend/ShopifyAnalyticsApi
dotnet ef migrations add AddWebhookEventsIdempotencyKeyIndex
```

**Step 2: ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†**

```csharp
// Migrations/XXXXXXXX_AddWebhookEventsIdempotencyKeyIndex.cs

protected override void Up(MigrationBuilder migrationBuilder)
{
    migrationBuilder.CreateIndex(
        name: "IX_WebhookEvents_IdempotencyKey",
        table: "WebhookEvents",
        column: "IdempotencyKey",
        unique: true,
        filter: "[IdempotencyKey] IS NOT NULL");  // NULLå€¤ã‚’è¨±å®¹
}

protected override void Down(MigrationBuilder migrationBuilder)
{
    migrationBuilder.DropIndex(
        name: "IX_WebhookEvents_IdempotencyKey",
        table: "WebhookEvents");
}
```

**Step 3: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨**

```bash
# Stagingç’°å¢ƒ
dotnet ef database update --connection "YOUR_STAGING_CONNECTION_STRING"

# Productionç’°å¢ƒï¼ˆæ…é‡ã«å®Ÿæ–½ï¼‰
dotnet ef database update --connection "YOUR_PRODUCTION_CONNECTION_STRING"
```

#### ç¢ºèªæ–¹æ³•

1. SQL Server Management Studio ã¾ãŸã¯ Azure Data Studio ã§æ¥ç¶š
2. ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç¢ºèªï¼š

```sql
SELECT 
    i.name AS IndexName,
    c.name AS ColumnName,
    i.is_unique
FROM sys.indexes i
JOIN sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id
JOIN sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
WHERE i.object_id = OBJECT_ID('WebhookEvents')
AND i.name = 'IX_WebhookEvents_IdempotencyKey';
```

---

### ä½œæ¥­5: E2Eãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

#### ãƒ†ã‚¹ãƒˆç’°å¢ƒ

| é …ç›® | å€¤ |
|------|-----|
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URL | `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net` |
| ãƒ†ã‚¹ãƒˆã‚¹ãƒˆã‚¢ | `xn-fbkq6e5da0fpb.myshopify.com` |
| Hangfire Dashboard | `/hangfire` |

#### HMACç½²åã®è¨ˆç®—æ–¹æ³•

**PowerShell**:
```powershell
$apiSecret = "YOUR_API_SECRET_HERE"  # ShopifyAppsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—
$body = '{"id":123456,"domain":"xn-fbkq6e5da0fpb.myshopify.com"}'

$hmac = New-Object System.Security.Cryptography.HMACSHA256
$hmac.Key = [System.Text.Encoding]::UTF8.GetBytes($apiSecret)
$hash = $hmac.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($body))
$signature = [Convert]::ToBase64String($hash)

Write-Host "X-Shopify-Hmac-SHA256: $signature"
```

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| # | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ | ç¢ºèªæ–¹æ³• |
|---|-------------|---------|---------|
| 1 | app/uninstalled æ­£å¸¸ç³» | 200 OK | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 2 | customers/redact æ­£å¸¸ç³» | 200 OK | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 3 | shop/redact æ­£å¸¸ç³» | 200 OK | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 4 | customers/data_request æ­£å¸¸ç³» | 200 OK | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 5 | HMACç½²åãªã— | 401 Unauthorized | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 6 | HMACç½²åä¸æ­£ | 401 Unauthorized | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª |
| 7 | å¿œç­”æ™‚é–“ | 5ç§’ä»¥å†… | ã‚¿ã‚¤ãƒãƒ¼è¨ˆæ¸¬ |
| 8 | å†ªç­‰æ€§ï¼ˆé‡è¤‡é€ä¿¡ï¼‰ | 2å›ç›®ã¯å‡¦ç†ã‚¹ã‚­ãƒƒãƒ— | ãƒ­ã‚°ç¢ºèª |
| 9 | GDPRRequestsç™»éŒ² | pendingçŠ¶æ…‹ã§ç™»éŒ² | DBç¢ºèª |
| 10 | Hangfireã‚¸ãƒ§ãƒ– | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ² | Dashboardç¢ºèª |

#### ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ‰‹é †

**1. Shopifyç®¡ç†ç”»é¢ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆï¼ˆæ¨å¥¨ï¼‰**

```
Shopify Admin
  â””â”€â”€ é¡§å®¢
        â””â”€â”€ [ãƒ†ã‚¹ãƒˆé¡§å®¢ã‚’é¸æŠ]
              â””â”€â”€ ã€Œãã®ä»–ã®æ“ä½œã€
                    â”œâ”€â”€ ã€ŒãŠå®¢æ§˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ â†’ customers/data_request
                    â””â”€â”€ ã€Œå€‹äººãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã™ã‚‹ã€   â†’ customers/redact
```

**2. curlã«ã‚ˆã‚‹æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**

```bash
# app/uninstalled ãƒ†ã‚¹ãƒˆ
curl -X POST "https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net/api/webhook/uninstalled" \
  -H "Content-Type: application/json" \
  -H "X-Shopify-Topic: app/uninstalled" \
  -H "X-Shopify-Shop-Domain: xn-fbkq6e5da0fpb.myshopify.com" \
  -H "X-Shopify-Webhook-Id: test-webhook-001" \
  -H "X-Shopify-Hmac-SHA256: {calculated_hmac}" \
  -d '{"id":123456789,"name":"Test Shop","email":"test@example.com","domain":"xn-fbkq6e5da0fpb.myshopify.com"}'
```

#### è¨¼è·¡ã®å–å¾—

| è¨¼è·¡ | å–å¾—æ–¹æ³• |
|------|---------|
| ãƒ­ã‚° | Application Insights ã¾ãŸã¯ Azure Log Stream |
| DBçŠ¶æ…‹ | SQL ã‚¯ã‚¨ãƒªå®Ÿè¡Œçµæœã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ |
| Hangfire | Dashboard ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹ | curl ã®å‡ºåŠ›ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ« |

#### DBã‚¯ã‚¨ãƒªï¼ˆè¨¼è·¡å–å¾—ç”¨ï¼‰

```sql
-- GDPRãƒªã‚¯ã‚¨ã‚¹ãƒˆç¢ºèª
SELECT TOP 10 
    Id, ShopDomain, RequestType, Status, 
    ReceivedAt, DueDate, CompletedAt
FROM GDPRRequests
ORDER BY ReceivedAt DESC;

-- Webhookã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª
SELECT TOP 10 
    Id, ShopDomain, Topic, Status, 
    IdempotencyKey, ProcessedAt
FROM WebhookEvents
ORDER BY CreatedAt DESC;
```

---

## 3. ä½œæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Day 1: ä¿®æ­£ä½œæ¥­                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  09:00 - 09:05  ä½œæ¥­1: HmacValidationMiddlewareç„¡åŠ¹åŒ–ï¼ˆ5åˆ†ï¼‰     â”‚
â”‚  09:05 - 09:35  ä½œæ¥­2: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ä¿®æ­£ï¼ˆ30åˆ†ï¼‰               â”‚
â”‚  09:35 - 11:35  ä½œæ¥­3: æœ¬ç•ªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å®Ÿè£…ï¼ˆ2æ™‚é–“ï¼‰          â”‚
â”‚  11:35 - 12:05  ä½œæ¥­4: DBãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„è¿½åŠ ï¼ˆ30åˆ†ï¼‰                â”‚
â”‚  12:05 - 12:30  ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤                                 â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Day 2: ãƒ†ã‚¹ãƒˆä½œæ¥­                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  09:00 - 13:00  ä½œæ¥­5: E2Eãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆ4æ™‚é–“ï¼‰                    â”‚
â”‚  13:00 - 14:00  è¨¼è·¡æ¡å–ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼ˆ1æ™‚é–“ï¼‰                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. å®Œäº†æ¡ä»¶

### 4.1 ä¿®æ­£å®Œäº†ã®æ¡ä»¶

- [x] Program.cs ã® `app.UseHmacValidation();` ãŒã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹ âœ… 2025-12-31
- [x] WebhookController.cs ã®å…¨12ç®‡æ‰€ãŒ `Unauthorized()` ã«ä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ âœ… 2025-12-31
- [x] 4ã¤ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Hangfire ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ âœ… 2025-12-31
- [x] `WebhookEvents.IdempotencyKey` ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ âœ… 2025-12-31
- [x] ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ âœ… 2025-12-31
- [ ] Stagingç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã™ã‚‹
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ï¼ˆStaging/Productionï¼‰

### 4.2 ãƒ†ã‚¹ãƒˆå®Œäº†ã®æ¡ä»¶

- [ ] 4ç¨®é¡ã®Webhookæ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦200 OKã‚’è¿”ã™
- [ ] HMACæ¤œè¨¼å¤±æ•—æ™‚ã«401 Unauthorizedã‚’è¿”ã™
- [ ] ã™ã¹ã¦ã®WebhookãŒ5ç§’ä»¥å†…ã«å¿œç­”ã™ã‚‹
- [ ] GDPRRequestsãƒ†ãƒ¼ãƒ–ãƒ«ã«pendingçŠ¶æ…‹ã§ç™»éŒ²ã•ã‚Œã‚‹
- [ ] Hangfire Dashboardã§ã‚¸ãƒ§ãƒ–ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
- [ ] å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã§é‡è¤‡å‡¦ç†ãŒç™ºç”Ÿã—ãªã„
- [ ] è¨¼è·¡ï¼ˆãƒ­ã‚°ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹

---

## 5. å‚è€ƒè³‡æ–™

### 5.1 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” |
|---------|------|
| `backend/ShopifyAnalyticsApi/Program.cs` | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š |
| `backend/ShopifyAnalyticsApi/Controllers/WebhookController.cs` | Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `backend/ShopifyAnalyticsApi/Services/GDPRService.cs` | GDPRå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ |
| `backend/ShopifyAnalyticsApi/Services/DataCleanupService.cs` | ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯ |
| `backend/ShopifyAnalyticsApi/Jobs/GdprProcessingJob.cs` | å®šæœŸå‡¦ç†ã‚¸ãƒ§ãƒ– |

### 5.2 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å ´æ‰€ |
|-------------|------|
| è¦ä»¶å®šç¾© | `docs/03-feature-development/GDPRå¯¾å¿œæ©Ÿèƒ½/è¦ä»¶å®šç¾©.md` |
| å®Ÿè£…çŠ¶æ³ãƒ¬ãƒ“ãƒ¥ãƒ¼ | `docs/03-feature-development/GDPRå¯¾å¿œæ©Ÿèƒ½/å®Ÿè£…çŠ¶æ³ãƒ¬ãƒ“ãƒ¥ãƒ¼.md` |
| ãƒ†ã‚¹ãƒˆè¨ˆç”» | `docs/03-feature-development/GDPRå¯¾å¿œæ©Ÿèƒ½/ãƒ†ã‚¹ãƒˆè¨ˆç”».md` |
| ãƒ“ã‚¸ãƒã‚¹å‘ã‘è§£èª¬ | `docs/03-feature-development/GDPRå¯¾å¿œæ©Ÿèƒ½/ãƒ“ã‚¸ãƒã‚¹å‘ã‘è§£èª¬.md` |

### 5.3 å¤–éƒ¨å‚è€ƒè³‡æ–™

- [Shopify GDPR Requirements](https://help.shopify.com/en/manual/privacy-and-security/privacy/gdpr)
- [Shopify Webhook Verification](https://shopify.dev/docs/apps/build/webhooks/verify)
- [Hangfire Documentation](https://docs.hangfire.io/)

---

**ä½œæ¥­é–‹å§‹å‰ã«æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã€ä¸æ˜ç‚¹ãŒã‚ã‚Œã°äº‹å‰ã«è³ªå•ã—ã¦ãã ã•ã„ã€‚**
