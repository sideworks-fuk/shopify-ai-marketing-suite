# GDPR対応機能 - テスト計画

**作成日**: 2025-12-31
**目的**: Shopify公開アプリ申請に向けたE2E検証計画

---

## 1. テスト環境

### 1.1 環境情報

| 項目 | 値 |
|------|-----|
| バックエンドURL | `https://shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net` |
| Webhookエンドポイント | `/api/webhook/{topic}` |
| テストストア | `xn-fbkq6e5da0fpb.myshopify.com` |
| Application Insights | Azure Portal で確認 |
| Hangfire Dashboard | `/hangfire` |

### 1.2 テストツール

| ツール | 用途 |
|--------|------|
| .http ファイル | Webhook手動テスト |
| curl | コマンドラインテスト |
| Application Insights | ログ・メトリクス確認 |
| Azure SQL Database | データ確認 |
| Hangfire Dashboard | ジョブ確認 |

---

## 2. HMAC署名の計算方法

### 2.1 PowerShell

```powershell
$apiSecret = "your-api-secret-here"
$body = '{"id":123456,"domain":"test.myshopify.com"}'

$hmac = New-Object System.Security.Cryptography.HMACSHA256
$hmac.Key = [System.Text.Encoding]::UTF8.GetBytes($apiSecret)
$hash = $hmac.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($body))
$signature = [Convert]::ToBase64String($hash)

Write-Host "X-Shopify-Hmac-SHA256: $signature"
```

### 2.2 C#

```csharp
using System.Security.Cryptography;
using System.Text;

var apiSecret = "your-api-secret-here";
var body = "{\"id\":123456,\"domain\":\"test.myshopify.com\"}";

using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(apiSecret));
var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
var signature = Convert.ToBase64String(hash);

Console.WriteLine($"X-Shopify-Hmac-SHA256: {signature}");
```

---

## 3. テストケース

### 3.1 app/uninstalled

#### 正常系

**リクエスト**:
```http
POST /api/webhook/uninstalled HTTP/1.1
Host: shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net
Content-Type: application/json
X-Shopify-Topic: app/uninstalled
X-Shopify-Shop-Domain: xn-fbkq6e5da0fpb.myshopify.com
X-Shopify-Webhook-Id: test-webhook-001
X-Shopify-Hmac-SHA256: {calculated_hmac}

{
  "id": 123456789,
  "name": "Test Shop",
  "email": "test@example.com",
  "domain": "xn-fbkq6e5da0fpb.myshopify.com"
}
```

**期待結果**:
- ステータスコード: 200 OK
- 応答時間: 5秒以内
- ログ: `App uninstall notification received` が記録
- DB: `Stores.IsActive = false` に更新
- DB: `StoreSubscriptions.Status = 'CANCELLED'` に更新

#### 異常系

| ケース | 期待結果 |
|--------|---------|
| HMAC署名なし | 403 Forbid |
| HMAC署名不正 | 403 Forbid |
| トピックヘッダなし | 403 Forbid |
| ペイロード不正 | 200 OK（エラーでも200） |

---

### 3.2 customers/redact

**リクエスト**:
```http
POST /api/webhook/customers-redact HTTP/1.1
Host: shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net
Content-Type: application/json
X-Shopify-Topic: customers/redact
X-Shopify-Shop-Domain: xn-fbkq6e5da0fpb.myshopify.com
X-Shopify-Webhook-Id: test-webhook-002
X-Shopify-Hmac-SHA256: {calculated_hmac}

{
  "shop_id": 123456,
  "shop_domain": "xn-fbkq6e5da0fpb.myshopify.com",
  "customer": {
    "id": 987654321,
    "email": "customer@example.com",
    "phone": "+81-90-1234-5678"
  },
  "orders_to_redact": [111111, 222222]
}
```

**期待結果**:
- ステータスコード: 200 OK
- 応答時間: 5秒以内
- DB: `GDPRRequests` に `pending` ステータスで登録
- DB: `GDPRRequests.RequestType = 'customers_redact'`
- DB: `GDPRRequests.DueDate` が30日後

---

### 3.3 shop/redact

**リクエスト**:
```http
POST /api/webhook/shop-redact HTTP/1.1
Host: shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net
Content-Type: application/json
X-Shopify-Topic: shop/redact
X-Shopify-Shop-Domain: xn-fbkq6e5da0fpb.myshopify.com
X-Shopify-Webhook-Id: test-webhook-003
X-Shopify-Hmac-SHA256: {calculated_hmac}

{
  "shop_id": 123456,
  "shop_domain": "xn-fbkq6e5da0fpb.myshopify.com"
}
```

**期待結果**:
- ステータスコード: 200 OK
- 応答時間: 5秒以内
- DB: `GDPRRequests` に `pending` ステータスで登録
- DB: `GDPRRequests.RequestType = 'shop_redact'`
- DB: `GDPRRequests.DueDate` が90日後

---

### 3.4 customers/data_request

**リクエスト**:
```http
POST /api/webhook/customers-data-request HTTP/1.1
Host: shopifyapp-backend-develop-a0e6fec4ath6fzaa.japanwest-01.azurewebsites.net
Content-Type: application/json
X-Shopify-Topic: customers/data_request
X-Shopify-Shop-Domain: xn-fbkq6e5da0fpb.myshopify.com
X-Shopify-Webhook-Id: test-webhook-004
X-Shopify-Hmac-SHA256: {calculated_hmac}

{
  "shop_id": 123456,
  "shop_domain": "xn-fbkq6e5da0fpb.myshopify.com",
  "customer": {
    "id": 987654321,
    "email": "customer@example.com"
  },
  "data_request": {
    "id": 555555
  },
  "orders_requested": [111111, 222222]
}
```

**期待結果**:
- ステータスコード: 200 OK
- 応答時間: 5秒以内
- DB: `GDPRRequests` に `pending` ステータスで登録
- DB: `GDPRRequests.RequestType = 'customers_data_request'`
- DB: `GDPRRequests.DueDate` が10日後

---

## 4. 冪等性テスト

### 4.1 同一Webhookの重複送信

**手順**:
1. 同一の `X-Shopify-Webhook-Id` で2回リクエスト送信
2. DBの `WebhookEvents` テーブルを確認

**期待結果**:
- 1回目: 正常登録
- 2回目: 「既に記録済み」ログ出力、DB重複登録なし

---

## 5. タイムアウトテスト

### 5.1 応答時間の計測

**手順**:
1. 各Webhookを送信
2. Application Insights で `LatencyMs` を確認

**期待結果**:
- すべてのWebhookが5秒以内に200 OKを返す
- 長時間処理は非同期で実行

---

## 6. 証跡の取得方法

### 6.1 Application Insights クエリ

```kql
// Webhook処理ログ
traces
| where message contains "WebhookEvent" or message contains "webhook"
| project timestamp, message, customDimensions
| order by timestamp desc
| take 100

// 応答時間分析
traces
| where customDimensions.LatencyMs != ""
| project timestamp, 
          Topic = customDimensions.Topic,
          LatencyMs = todouble(customDimensions.LatencyMs),
          Result = customDimensions.Result
| order by timestamp desc

// エラー分析
traces
| where severityLevel >= 3
| where message contains "webhook" or message contains "GDPR"
| project timestamp, message, severityLevel
| order by timestamp desc
```

### 6.2 データベース確認クエリ

```sql
-- GDPRリクエスト一覧
SELECT 
    Id, ShopDomain, RequestType, Status, 
    ReceivedAt, DueDate, CompletedAt, RetryCount
FROM GDPRRequests
ORDER BY ReceivedAt DESC;

-- Webhookイベント一覧
SELECT 
    Id, ShopDomain, Topic, Status, 
    IdempotencyKey, ProcessedAt
FROM WebhookEvents
ORDER BY CreatedAt DESC;

-- 削除ログ
SELECT 
    Id, GDPRRequestId, EntityType, EntityId,
    DeletionMethod, DeletedAt
FROM GDPRDeletionLogs
ORDER BY DeletedAt DESC;
```

### 6.3 Hangfire Dashboard

1. `/hangfire` にアクセス
2. Recurring Jobs → `gdpr-process-pending` の実行履歴を確認
3. Scheduled Jobs → 削除ジョブのスケジュールを確認

---

## 7. 証跡チェックリスト

| 項目 | 確認方法 | 採取証跡 |
|------|---------|---------|
| app/uninstalled 正常動作 | .http + ログ | スクショ + ログ |
| customers/redact 正常動作 | .http + DB | スクショ + ログ |
| shop/redact 正常動作 | .http + DB | スクショ + ログ |
| customers/data_request 正常動作 | .http + DB | スクショ + ログ |
| HMAC検証失敗 | 不正署名送信 | ログ |
| 5秒以内応答 | Application Insights | KQLクエリ結果 |
| 冪等性 | 重複送信 + DB | スクショ |
| GDPRRequests登録 | DB確認 | SQLクエリ結果 |
| Hangfireジョブ | Dashboard | スクショ |

---

## 8. 実施スケジュール

```
[1時間] 環境準備・HMAC計算ツール準備
[2時間] 4種Webhookの正常系テスト
[1時間] 異常系テスト（HMAC失敗など）
[1時間] 冪等性・タイムアウトテスト
[1時間] 証跡採取・ドキュメント化
```

---

## 9. 参考資料

- Shopify Webhook Testing: https://shopify.dev/docs/apps/build/webhooks/test
- 既存テスト手順: `docs/04-design-specs/10-testing/install-uninstall-test-plan-2025-08-05.md`
- Webhook仕様書: `docs/00-production-release/03-gdpr-compliance/GDPR_Webhook仕様.md`
