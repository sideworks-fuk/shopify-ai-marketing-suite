# GDPR対応機能 - 要件定義

**作成日**: 2025-12-31
**最終更新**: 2025-12-31
**背景**: Shopify公開アプリとして申請するために必須

---

## 1. 概要

### 1.1 GDPRとは

GDPR（General Data Protection Regulation）は、EU一般データ保護規則であり、個人データの保護と移動に関する法的枠組みです。Shopifyアプリは、GDPRに準拠するために特定の機能を実装する必要があります。

### 1.2 Shopifyが求めるGDPR対応

Shopifyは**すべての公開アプリ**に対し、以下の対応を必須としています：

1. **必須Webhook（3種）** の実装
2. **app/uninstalled Webhook** の実装
3. **プライバシーポリシー** の公開
4. **データ削除期限** の遵守

---

## 2. 必須Webhook一覧

### 2.1 Webhook概要表

| Webhook | 目的 | 応答期限 | データ処理期限 | 優先度 |
|---------|------|---------|---------------|--------|
| `app/uninstalled` | アプリアンインストール通知 | 5秒 | 48時間以内にデータ削除 | 最高 |
| `customers/redact` | 顧客データ削除要求 | 5秒 | 30日以内に削除完了 | 高 |
| `shop/redact` | ショップデータ削除要求 | 5秒 | 90日以内に削除完了 | 高 |
| `customers/data_request` | 顧客データ開示要求 | 5秒 | 10日以内にデータ提供 | 中 |

### 2.2 各Webhookの詳細

#### 2.2.1 app/uninstalled

**トリガー**: ストアオーナーがアプリをアンインストール

**必須対応**:
- アクセストークンを即座に無効化
- ストアデータを48時間以内に削除
- 課金を停止

**ペイロード例**:
```json
{
  "id": 123456789,
  "name": "Example Shop",
  "email": "shop@example.com",
  "domain": "example.myshopify.com",
  "created_at": "2023-01-01T00:00:00Z"
}
```

#### 2.2.2 customers/redact

**トリガー**: 顧客がストアに対してデータ削除を要求

**必須対応**:
- 指定された顧客の個人情報を削除
- 関連する注文データの個人情報を匿名化
- 30日以内に完了

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com",
  "customer": {
    "id": 191167,
    "email": "john@example.com",
    "phone": "+16135551111"
  },
  "orders_to_redact": [299938, 280263]
}
```

#### 2.2.3 shop/redact

**トリガー**: ストアがShopifyから削除されるか、ストアオーナーがデータ削除を要求

**必須対応**:
- ストアに関連するすべてのデータを削除
- 90日以内に完了

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com"
}
```

#### 2.2.4 customers/data_request

**トリガー**: 顧客がストアに対してデータ開示を要求

**必須対応**:
- 保持している顧客データをエクスポート
- ストアオーナーに提供
- 10日以内に完了

**ペイロード例**:
```json
{
  "shop_id": 954889,
  "shop_domain": "example.myshopify.com",
  "customer": {
    "id": 191167,
    "email": "john@example.com"
  },
  "data_request": {
    "id": 123456
  },
  "orders_requested": [299938, 280263]
}
```

---

## 3. 技術要件

### 3.1 Webhook受信要件

| 項目 | 要件 | 備考 |
|------|------|------|
| 応答時間 | **5秒以内に200 OK** | タイムアウトで再送される |
| HMAC検証 | **X-Shopify-Hmac-SHA256** ヘッダーで署名検証 | API Secretを使用 |
| サイズ上限 | 256KB推奨 | 大きいペイロードは拒否可 |
| 冪等性 | 同一Webhookの重複処理を防止 | IdempotencyKeyで管理 |
| エラー時も200 | エラーでも200 OKを返す | 例外時のリトライループ防止 |

### 3.2 HMAC検証

Shopifyは各Webhookに `X-Shopify-Hmac-SHA256` ヘッダーを付与します。

**検証手順**:
1. リクエストボディを取得
2. アプリの `API Secret` を使用してHMAC-SHA256を計算
3. 計算結果とヘッダー値をBase64で比較
4. 固定時間比較（タイミング攻撃防止）

```csharp
using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(apiSecret));
var computedHashBytes = hmac.ComputeHash(Encoding.UTF8.GetBytes(requestBody));
var receivedHmacBytes = Convert.FromBase64String(hmacHeader);
return CryptographicOperations.FixedTimeEquals(computedHashBytes, receivedHmacBytes);
```

### 3.3 マルチアプリ対応

複数のShopifyアプリを1つのバックエンドで管理する場合：

1. `X-Shopify-Shop-Domain` ヘッダーからストアを特定
2. ストアに紐づく `ShopifyApp` の `ApiSecret` を取得
3. そのシークレットでHMAC検証

---

## 4. データベース要件

### 4.1 必要なテーブル

| テーブル名 | 目的 |
|-----------|------|
| `GDPRRequests` | GDPR要求の管理 |
| `GDPRDeletionLogs` | 削除処理の監査証跡 |
| `GDPRStatistics` | 統計・コンプライアンスレポート用 |
| `WebhookEvents` | Webhook受信履歴（冪等性管理） |

### 4.2 GDPRRequestsテーブル

```sql
CREATE TABLE GDPRRequests (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    StoreId INT NULL,
    ShopDomain NVARCHAR(255) NOT NULL,
    RequestType NVARCHAR(50) NOT NULL,
    Status NVARCHAR(50) NOT NULL DEFAULT 'pending',
    ReceivedAt DATETIME2 NOT NULL,
    DueDate DATETIME2 NOT NULL,
    ScheduledFor DATETIME2 NULL,
    CompletedAt DATETIME2 NULL,
    RetryCount INT DEFAULT 0,
    IdempotencyKey NVARCHAR(255),
    WebhookPayload NVARCHAR(MAX),
    CreatedAt DATETIME2 DEFAULT GETUTCDATE()
);
```

---

## 5. 法的要件

### 5.1 プライバシーポリシー

以下の内容を含むプライバシーポリシーを公開：

- 収集するデータの種類
- データの使用目的
- データの保管場所と期間
- ユーザーの権利（アクセス、修正、削除）
- 連絡先情報

**現状**: 
- 日本語版: ✅ 作成済み (`docs/08-shopify/05-法的文書/プライバシーポリシー案.md`)
- 英語版: ❌ 未作成

### 5.2 利用規約

**現状**:
- 日本語版: ✅ 作成済み (`docs/08-shopify/05-法的文書/利用規約案.md`)
- 英語版: ❌ 未作成

---

## 6. 監視・運用要件

### 6.1 監視項目

| 項目 | 閾値 | アラート |
|------|------|---------|
| Webhook応答時間 | > 4秒 | 警告 |
| HMAC検証失敗 | 連続3回 | エラー |
| 処理失敗 | 発生時 | エラー |
| 期限超過リスク | 期限24時間前 | 警告 |
| 期限超過 | 発生時 | 緊急 |

### 6.2 Application Insightsクエリ

```kql
// Webhook処理時間の分析
traces
| where message contains "WebhookEvent"
| project timestamp, operation_Name, customDimensions.LatencyMs
| summarize avg(todouble(customDimensions_LatencyMs)) by bin(timestamp, 1h)
```

---

## 7. 参考リソース

- [Shopify GDPR Requirements](https://shopify.dev/docs/apps/build/privacy-and-data-handling/customer-data)
- [Shopify Webhook Topics](https://shopify.dev/docs/api/webhooks?reference=toml#configuration)
- 既存仕様書: `docs/00-production-release/03-gdpr-compliance/GDPR_Webhook仕様.md`
