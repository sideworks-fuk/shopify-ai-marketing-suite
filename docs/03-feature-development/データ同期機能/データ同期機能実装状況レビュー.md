# データ同期機能実装状況レビュー

**作成日**: 2025-01-23  
**レビュー対象**: バックエンド側のデータ同期機能とHangFire自動同期機能

## 概要

バックエンド側のデータ同期機能の実装状況を確認し、修正が必要な箇所をまとめました。

## 実装状況

### ✅ 実装済みの機能

#### 1. HangFire基盤
- **状態**: ✅ 実装済み
- **場所**: `Program.cs` (238-257行目)
- **内容**:
  - HangFireの設定とSQL Serverストレージ設定
  - HangFireダッシュボード (`/hangfire`)
  - HangFireサーバー設定（WorkerCount: 1）
- **問題点**: なし

#### 2. 同期ジョブクラス
- **状態**: ✅ 実装済み
- **場所**: 
  - `Jobs/ShopifyProductSyncJob.cs`
  - `Jobs/ShopifyCustomerSyncJob.cs`
  - `Jobs/ShopifyOrderSyncJob.cs`
- **機能**:
  - チェックポイント管理による再開機能
  - 同期範囲管理（日付範囲指定）
  - 進捗トラッキング
  - 自動リトライ（3回）
- **問題点**: なし

#### 3. 手動同期API
- **状態**: ✅ 実装済み
- **場所**: `Controllers/ManualSyncController.cs`
- **機能**:
  - 商品/顧客/注文の個別同期
  - 全データ一括同期
  - HangFireバックグラウンドジョブを使用
- **問題点**: なし

#### 4. 同期状態管理API
- **状態**: ✅ 実装済み
- **場所**: `Controllers/SyncController.cs`
- **機能**:
  - 同期状態の取得 (`/api/sync/status/{syncId}`)
  - 最新同期状態の取得 (`/api/sync/latest`)
  - 同期履歴の取得 (`/api/sync/history`)
  - 同期進捗の取得 (`/api/sync/progress`)
- **問題点**: なし

#### 5. 定期同期ジョブ登録メソッド
- **状態**: ✅ 実装済み
- **場所**: 各ジョブクラスの `RegisterRecurringJobs` メソッド
- **機能**:
  - アクティブなストアごとに1時間ごとの同期ジョブを登録
  - 全ストア一括同期ジョブ（1日1回）
- **問題点**: ⚠️ **自動登録されていない**（後述）

### ⚠️ 修正が必要な箇所

#### 1. 初期同期処理がHangFireを使用していない

**問題**: `SyncController.StartInitialSync` が `Task.Run` を使用しており、HangFireのバックグラウンドジョブを使用していません。

**現在の実装** (`SyncController.cs` 76-86行目):
```csharp
// バックグラウンドで同期を開始
_ = Task.Run(async () =>
{
    try
    {
        await _syncService.StartInitialSync(currentStore.Id, syncStatus.Id, request.SyncPeriod);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error in background sync for store {StoreId}", currentStore.Id);
    }
});
```

**問題点**:
- アプリケーション再起動時に実行中の同期が失われる
- ジョブの状態管理ができない
- HangFireダッシュボードで監視できない
- リトライ機能が利用できない

**修正案**:
```csharp
// HangFireバックグラウンドジョブとして登録
var jobId = _backgroundJobClient.Enqueue(() => 
    _syncService.StartInitialSync(currentStore.Id, syncStatus.Id, request.SyncPeriod));

_logger.LogInformation("Initial sync job enqueued. JobId: {JobId}, StoreId: {StoreId}", 
    jobId, currentStore.Id);
```

**必要な変更**:
- `SyncController` に `IBackgroundJobClient` を注入
- `Task.Run` を `BackgroundJob.Enqueue` に変更

#### 2. 定期同期ジョブが自動登録されていない

**問題**: 各ジョブの `RegisterRecurringJobs` メソッドが存在しますが、`Program.cs` で自動的に呼び出されていません。

**現在の状況**:
- `Program.cs` では `GdprProcessingJob` のみが登録されている（470-473行目）
- データ同期の定期ジョブは登録されていない

**修正案**:
`Program.cs` の `app.Build()` 後に以下を追加:

```csharp
// データ同期の定期ジョブを登録
using (var scope = app.Services.CreateScope())
{
    try
    {
        ShopifyProductSyncJob.RegisterRecurringJobs(scope.ServiceProvider);
        ShopifyCustomerSyncJob.RegisterRecurringJobs(scope.ServiceProvider);
        ShopifyOrderSyncJob.RegisterRecurringJobs(scope.ServiceProvider);
        Log.Information("Data sync recurring jobs registered successfully");
    }
    catch (Exception ex)
    {
        Log.Error(ex, "Failed to register data sync recurring jobs");
    }
}
```

**注意点**:
- アプリケーション起動時に毎回登録されるため、既存のジョブは上書きされる
- ストアが追加/削除された場合、手動で再登録が必要（または自動再登録ロジックを追加）

#### 3. 手動同期トリガーがHangFireを使用していない

**問題**: `SyncController.TriggerSync` が `Task.Run` を使用しており、HangFireを使用していません。

**現在の実装** (`SyncController.cs` 379-408行目):
```csharp
// バックグラウンドで同期を実行（本来はHangfireなどを使用）
_ = Task.Run(async () =>
{
    // ...
});
```

**修正案**:
`ManualSyncController` と同様に、HangFireの `IBackgroundJobClient` を使用する。

#### 4. 初期同期サービスが実際のジョブを使用していない

**問題**: `ShopifyDataSyncService.StartInitialSync` が古い実装（`ShopifyApiService` を直接使用）を使用しており、新しいジョブクラス（`ShopifyProductSyncJob` など）を使用していません。

**現在の実装** (`ShopifyDataSyncService.cs` 33-82行目):
- `ShopifyApiService.SyncCustomersAsync` などを直接呼び出し
- 新しいジョブクラスの機能（チェックポイント、進捗トラッキングなど）を活用していない

**修正案**:
- `ShopifyDataSyncService` を修正して、各ジョブクラスを呼び出すように変更
- または、`StartInitialSync` を削除し、直接ジョブを呼び出すように変更

#### 5. 定期同期ジョブの自動再登録機能がない

**問題**: 新しいストアが追加された場合、定期同期ジョブが自動的に登録されません。

**修正案**:
- ストア追加時に自動的に定期ジョブを登録する処理を追加
- または、定期同期ジョブを全ストア対象のジョブに変更し、実行時にアクティブなストアをフィルタリング

## 推奨される修正優先順位

### 優先度: 高

1. **初期同期処理をHangFireに移行**
   - 影響: アプリケーション再起動時の同期継続性
   - 工数: 小（1-2時間）

2. **定期同期ジョブの自動登録**
   - 影響: 定期同期が動作しない
   - 工数: 小（30分-1時間）

### 優先度: 中

3. **手動同期トリガーをHangFireに移行**
   - 影響: 手動同期の監視とリトライ機能
   - 工数: 小（1時間）

4. **初期同期サービスをジョブクラスに統一**
   - 影響: コードの一貫性と保守性
   - 工数: 中（2-3時間）

### 優先度: 低

5. **定期同期ジョブの自動再登録機能**
   - 影響: 新規ストア追加時の利便性
   - 工数: 中（2-3時間）

## 実装チェックリスト

### 初期同期処理の修正

- [ ] `SyncController` に `IBackgroundJobClient` を注入
- [ ] `StartInitialSync` メソッドで `Task.Run` を `BackgroundJob.Enqueue` に変更
- [ ] ジョブIDをレスポンスに含める
- [ ] エラーハンドリングを確認

### 定期同期ジョブの自動登録

- [ ] `Program.cs` に定期ジョブ登録処理を追加
- [ ] アプリケーション起動時のログを確認
- [ ] HangFireダッシュボードでジョブが登録されていることを確認

### 手動同期トリガーの修正

- [ ] `SyncController.TriggerSync` を `IBackgroundJobClient` を使用するように修正
- [ ] `ManualSyncController` の実装を参考にする

### 初期同期サービスの統一

- [ ] `ShopifyDataSyncService.StartInitialSync` を各ジョブクラスを呼び出すように修正
- [ ] または、`StartInitialSync` を削除し、直接ジョブを呼び出す

## 参考情報

### HangFireダッシュボード
- URL: `/hangfire`
- 認証: Basic認証（設定ファイルで設定）
- 確認項目:
  - 登録されているRecurring Jobs
  - 実行中のJobs
  - 失敗したJobs

### 定期同期のスケジュール
- **商品同期**: 1時間ごと（`Cron.Hourly`）
- **顧客同期**: 1時間ごと（`Cron.Hourly`）
- **注文同期**: 1時間ごと（`Cron.Hourly`）
- **全ストア一括同期**: 1日1回（`Cron.Daily`）

### 関連ファイル

- `backend/ShopifyAnalyticsApi/Controllers/SyncController.cs`
- `backend/ShopifyAnalyticsApi/Controllers/ManualSyncController.cs`
- `backend/ShopifyAnalyticsApi/Services/ShopifyDataSyncService.cs`
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyProductSyncJob.cs`
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyCustomerSyncJob.cs`
- `backend/ShopifyAnalyticsApi/Jobs/ShopifyOrderSyncJob.cs`
- `backend/ShopifyAnalyticsApi/Program.cs`

## 修正完了状況（2025-01-23）

### ✅ 完了した修正

1. **初期同期処理をHangFireに移行**
   - `SyncController.StartInitialSync` で `IBackgroundJobClient.Enqueue` を使用
   - `Task.Run` から `BackgroundJob.Enqueue` に変更
   - ファイル: `backend/ShopifyAnalyticsApi/Controllers/SyncController.cs`

2. **手動同期トリガーをHangFireに移行**
   - `SyncController.TriggerSync` で各ジョブクラスを `Enqueue` で登録
   - `Task.Run` から `BackgroundJob.Enqueue` に変更
   - ファイル: `backend/ShopifyAnalyticsApi/Controllers/SyncController.cs`

3. **初期同期サービスをジョブクラスに統一**
   - `ShopifyDataSyncService.StartInitialSync` で新しいジョブクラスを使用
   - `RunActualSync` を `RunInitialSyncWithJobs` に置き換え
   - ファイル: `backend/ShopifyAnalyticsApi/Services/ShopifyDataSyncService.cs`

4. **定期同期ジョブの自動登録**
   - `Program.cs` でアプリ起動時に自動登録
   - `ShopifyProductSyncJob.RegisterRecurringJobs`
   - `ShopifyCustomerSyncJob.RegisterRecurringJobs`
   - `ShopifyOrderSyncJob.RegisterRecurringJobs`
   - ファイル: `backend/ShopifyAnalyticsApi/Program.cs`

### 📊 分析結果表示に必要なデータ

以下のデータが正しく同期されていることを確認しました：

- **Customers テーブル**: TotalSpent, TotalOrders, ProvinceCode, CountryCode, Tags, CreatedAt
- **Orders テーブル**: TotalPrice, SubtotalPrice, TaxPrice, Status, FinancialStatus, CreatedAt, CustomerId
- **Products テーブル**: Title, Category, Vendor, ProductType, InventoryQuantity

各ジョブクラスの `SaveOrUpdate*` メソッドで、これらのフィールドが正しく保存されています。

## 次のステップ

1. ✅ 優先度の高い修正から順に実装（完了）
2. 各修正後に動作確認
3. HangFireダッシュボードでジョブの実行状況を確認
4. エラーログを監視

