# 対応残タスクと改善案

**作成日**: 2026-01-19  
**最終更新**: 2026-01-19  
**対象**: データ同期機能の日時明確化・OrderNumberユニーク制約対応

---

## 1. 対応済み項目 ✅

### 1.1 日時の意味明確化
- ✅ `ShopifyCreatedAt` / `ShopifyUpdatedAt` / `SyncedAt` カラム追加
- ✅ 分析クエリを `ShopifyCreatedAt` 優先に変更
- ✅ EF Coreマイグレーション作成
- ✅ 手動適用用SQLスクリプト作成

### 1.2 OrderNumberユニーク制約の修正
- ✅ `StoreId + OrderNumber` 複合ユニーク制約に変更
- ✅ EF Coreマイグレーション作成
- ✅ 手動適用用SQLスクリプト作成
- ✅ フロントエンドへの影響確認（影響なし）

### 1.3 JSONマッピング対応
- ✅ `JsonPropertyName` 属性を付与（`snake_case` → `PascalCase`）

---

## 2. 対応残タスク ⏳

### 2.1 マイグレーション適用（優先度: 高）

**現状**: 以下のマイグレーションが未適用
- `2026-01-19-AddShopifyTimestampsAndSyncedAt.sql`
- `2026-01-19-FixOrderNumberUniqueConstraint.sql`

**対象環境**:
- ⏳ Development環境
- ⏳ Staging環境
- ⏳ Production環境

**アクション**:
1. Development環境でSQLスクリプトを実行
2. 動作確認（データ同期テスト）
3. Staging環境に適用
4. Production環境に適用

**注意事項**:
- マイグレーション適用前にバックアップを取得
- `FixOrderNumberUniqueConstraint.sql` は重複データチェックを実施
- 重複データが存在する場合は事前に解消が必要

---

### 2.2 動作確認・テスト（優先度: 中）

**現状**: ローカル同期テストが未実施

**確認項目**:
1. **日時データの整合性**
   - `ShopifyCreatedAt` が正しく保存されているか
   - 分析クエリが `ShopifyCreatedAt` を優先参照しているか
   - 旧データ（`ShopifyCreatedAt = NULL`）で `CreatedAt` フォールバックが機能するか

2. **OrderNumberユニーク制約**
   - 異なる `StoreId` で同じ `OrderNumber` を登録できるか
   - 同じ `StoreId` 内で `OrderNumber` の重複が防止されているか

3. **データ同期の動作**
   - 初期同期が正常に完了するか
   - 増分同期が正常に動作するか
   - エラーハンドリングが適切に機能するか

**テスト手順**:
1. ローカル環境でバックエンドを起動
2. テスト用ストアでデータ同期を実行
3. データベースを直接確認して整合性を検証
4. 分析画面でデータが正しく表示されるか確認

**参考ドキュメント**:
- `docs/05-development/08-デバッグ・トラブル/02-tools/ローカルAPIデバッグ手順-データ同期テスト.md`
- `docs/05-development/03-データベース/運用/2026-01-19-clear-sync-data-for-testing-v2.sql`

---

### 2.3 ドキュメント整理（優先度: 低）

**現状**: `database-migration-tracking.md` に重複記載あり

**問題**:
- 76行目と78行目に同じマイグレーション `2026-01-19-AddShopifyTimestampsAndSyncedAt.sql` が2回記載されている

**アクション**:
- 重複行を削除（78行目を削除）

---

## 3. 改善提案 💡

### 3.1 旧実装パスの整理（優先度: 中）

**現状**: `ShopifyApiService` に以下の未使用メソッドが存在
- `SyncCustomersAsync(int storeId, DateTime? sinceDate = null)`
- `SyncProductsAsync(int storeId, DateTime? sinceDate = null)`
- `SyncOrdersAsync(int storeId, DateTime? sinceDate = null)`

**問題点**:
- ジョブベースの実装（`ShopifyCustomerSyncJob`, `ShopifyProductSyncJob`, `ShopifyOrderSyncJob`）と重複
- コードの保守性が低下
- どちらの実装を使用すべきか不明確

**改善案**:
1. **オプションA: 旧メソッドを削除**
   - 未使用であることを確認後、メソッドを削除
   - コードベースをシンプルに保つ

2. **オプションB: 旧メソッドを非推奨マーク**
   - `[Obsolete]` 属性を付与
   - コメントでジョブベース実装への移行を推奨
   - 将来的に削除予定であることを明示

**推奨**: オプションA（削除）を推奨
- 未使用であることが確認済み
- コードの複雑性を削減できる

---

### 3.2 データ整合性チェック機能の追加（優先度: 低）

**提案**: データ同期後の整合性を自動チェックする機能

**チェック項目**:
- `ShopifyCreatedAt` が `NULL` のレコードの割合
- `OrderNumber` の重複（同一 `StoreId` 内）
- 同期日時（`SyncedAt`）の最新性

**実装方法**:
- データ同期完了後に自動実行
- 問題があれば警告ログを出力
- ダッシュボードに整合性ステータスを表示

**メリット**:
- データ品質の早期発見
- 問題の自動検知

---

### 3.3 マイグレーション適用の自動化（優先度: 低）

**現状**: マイグレーションは手動適用

**提案**: CI/CDパイプラインにマイグレーション適用ステップを追加

**実装方法**:
- GitHub Actionsワークフローにマイグレーション適用ステップを追加
- 適用前に自動バックアップを取得
- 適用後の動作確認を自動化

**注意事項**:
- Production環境では手動承認が必要
- ロールバック手順を事前に準備

---

## 4. 次のアクション優先順位

### 即座に対応（今週中）
1. ✅ **マイグレーション適用（Development環境）**
   - `2026-01-19-AddShopifyTimestampsAndSyncedAt.sql`
   - `2026-01-19-FixOrderNumberUniqueConstraint.sql`

2. ✅ **動作確認（ローカル同期テスト）**
   - 日時データの整合性確認
   - OrderNumberユニーク制約の動作確認

### 短期対応（来週中）
3. **ドキュメント整理**
   - `database-migration-tracking.md` の重複削除

4. **旧実装パスの整理**
   - `ShopifyApiService` の未使用メソッド削除または非推奨マーク

### 中期対応（1ヶ月以内）
5. **Staging/Production環境へのマイグレーション適用**
   - 本番環境適用前に十分なテストを実施

6. **データ整合性チェック機能の検討**
   - 要件定義と実装計画の作成

---

## 5. 関連ドキュメント

- `docs/03-feature-development/データ同期機能/2026-01-19-データ同期機能ソースレビュー.md`
- `docs/05-development/03-データベース/マイグレーション/database-migration-tracking.md`
- `docs/05-development/03-データベース/マイグレーション/2026-01-19-AddShopifyTimestampsAndSyncedAt.sql`
- `docs/05-development/03-データベース/マイグレーション/2026-01-19-FixOrderNumberUniqueConstraint.sql`
- `tasks/task-260119-order-date-clarification.md`
