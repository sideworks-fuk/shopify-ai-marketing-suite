# データ同期機能ソースレビュー

**作成日**: 2026-01-19  
**対象**: `docs/03-feature-development/データ同期機能` 配下の仕様・現行実装

---

## 1. レビューの結論（要点）

- **オーダー日時の不整合は発生し得る**。`created_at` のJSONマッピングが機能しない場合、`DateTime.UtcNow` が保存され、注文日時が現在時刻で上書きされる可能性がある。
- **複数ストア運用時のユニーク制約**により、別ストアの同一 `OrderNumber` が登録できず同期失敗の原因になり得る。
- **重複登録は理論上発生しない**（Upsert設計）が、JSONデシリアライズ失敗により「空データでの更新」が起きるリスクがある。

---

## 2. 主要な懸念点

### 2.1 オーダー日時が正しく登録されない可能性（高）

**原因**: RESTレスポンスのJSONが `snake_case` であるのに対し、`System.Text.Json` は `snake_case → PascalCase` の変換を行わない。  
`ShopifyApiService` の `JsonSerializerOptions` は `PropertyNameCaseInsensitive` のみで、`created_at` を `CreatedAt` に自動変換できない。

**影響**:
- `ShopifyOrder.CreatedAt` が `null` のままになり、`DateTime.UtcNow` が保存される
- 注文日時が現在時刻で登録され、月別/年別集計が崩れる

**該当箇所**:
- `ShopifyApiService` の `_jsonOptions` 設定
- `ShopifyOrderSyncJob.ConvertToOrderEntity` で `CreatedAt = shopifyOrder.CreatedAt ?? DateTime.UtcNow`

---

### 2.2 複数ストアのユニーク制約問題（中）

**原因**: `OrderNumber` に対してグローバルユニーク制約が設定されている。  
マルチテナント構成では `StoreId + OrderNumber` でユニークにすべき。

**影響**:
- 別ストアの同一 `OrderNumber` が登録できず同期が失敗
- 実運用で多店舗追加時の障害になり得る

---

### 2.3 JSONマッピングの網羅性不足（中）

**原因**: `snake_case` のプロパティが `PascalCase` に変換されないため、以下のようなフィールドも未取得になりやすい。  

**影響例**:
- `line_items` が `LineItems` に入らず、注文明細が空
- `financial_status` / `fulfillment_status` 等が `null` になり、分析値が崩れる
- `total_price`, `total_tax` などが `null` → 金額が `0` になる

---

### 2.4 同期失敗時の部分更新（低）

**原因**: Upsert処理がレコード単位で `SaveChangesAsync()` を呼び出す設計が残っている。  
ジョブベースのバッチ処理では改善されているが、旧実装パスが残っている。

**影響**:
- 途中失敗時に部分的な更新だけが残る
- 再実行時に「重複ではなく更新」が発生する（データは壊れないが整合性の監視が必要）

---

## 3. オーダー日時の確認ポイント（ユーザーの質問への直接回答）

**結論**: 「正しく登録できていない可能性」は高い。  
`CreatedAt` が `null` の場合、現在時刻が保存されるため、実際の注文日時とずれる。

**想定される症状**:
- 初期同期後の注文が「すべて今日の注文」として登録される
- 月別売上の集計が異常に偏る

---

## 4. 対応内容（実装済み）

1. **日時の意味を明確化（Orders/Customers/Products）**
   - `ShopifyCreatedAt` / `ShopifyUpdatedAt` / `SyncedAt` を追加
   - 既存の `CreatedAt` / `UpdatedAt` はDBレコード作成/更新日時として統一
   - 分析クエリは `ShopifyCreatedAt` を優先して参照

2. **JSONの `snake_case` 変換対応**
   - `JsonPropertyName` 属性を付与し、`created_at` などを確実にマッピング

3. **分析クエリの参照カラム変更**
   - `Orders.CreatedAt` → `Orders.ShopifyCreatedAt`（null時は `CreatedAt` をフォールバック）

--- 

## 5. 改善提案（方向性のみ・変更は未実施）

> 本セクションは「改善案」です。実装変更は別途承認が必要。

1. **JSONの `snake_case` 変換対応**
   - `JsonPropertyName` 属性を付与
   - もしくは `JsonNamingPolicy` に `snake_case` を適用

2. **`OrderNumber` のユニーク制約を `StoreId` と複合に変更**
   - `StoreId + OrderNumber` をユニーク化

3. **旧実装パスの整理**
   - `ShopifyApiService.Sync*Async` 系はジョブベースと重複
   - 一貫したバッチ処理に統一

---

## 6. 次のアクション候補

- オーダー日時の検証クエリを発行して実態を確認
- JSONマッピングの方法を確定させ、修正計画を作成
- 影響範囲（顧客・商品・注文の全エンティティ）を整理

---

## 7. 関連ドキュメント

- `データ同期機能実装状況レビュー.md`
- `データ同期機能詳細レビュー.md`
- `データ同期機能-重複登録問題とソースレビュー.md`

