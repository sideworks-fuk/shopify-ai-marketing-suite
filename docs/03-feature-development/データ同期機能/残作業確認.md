# データ同期機能 残作業確認

**確認日**: 2025-01-23  
**目的**: データ同期機能の実装状況と残作業を確認

## ✅ 実装完了項目

### 1. コア機能の実装
- ✅ HangFire基盤の構築
- ✅ 同期ジョブクラス（Product/Customer/Order）の実装
- ✅ 実際のShopify API呼び出しの実装
- ✅ ページネーション処理の実装
- ✅ バッチ処理によるパフォーマンス改善
- ✅ OrderとCustomerの関連付け
- ✅ 分析に必要なフィールドの保存

### 2. 初期同期・手動同期
- ✅ 初期同期処理をHangFireに移行
- ✅ 手動同期トリガーをHangFireに移行
- ✅ 初期同期サービスをジョブクラスに統一
- ✅ 定期同期ジョブの自動登録

### 3. エラーハンドリング
- ✅ HangFireの自動リトライ（3回）
- ✅ 基本的な例外処理
- ✅ エラーログ出力

## 📋 残作業・推奨事項

### 🔴 必須（本番環境デプロイ前に推奨）

#### 1. 動作確認・テスト
**状態**: ⏳ 未実施  
**内容**:
- [ ] 開発環境で実際のShopifyストアに接続してデータ取得をテスト
- [ ] 初期同期の動作確認
- [ ] 定期同期の動作確認
- [ ] 手動同期の動作確認
- [ ] 大量データでのパフォーマンステスト
- [ ] HangFireダッシュボードでジョブ実行状況を確認

**確認項目**:
- データが正しく取得できているか
- データベースに正しく保存されているか
- ページネーションが正しく動作しているか
- バッチ処理が正しく動作しているか
- OrderとCustomerの関連付けが正しいか
- 分析に必要なフィールドが保存されているか

#### 2. Shopify APIレスポンスのフィールドマッピング確認
**状態**: ⏳ 未確認  
**内容**:
- [ ] `ProvinceCode`, `CountryCode`, `Tags`などのフィールドがShopify APIレスポンスに存在するか確認
- [ ] JSONデシリアライゼーション時のフィールドマッピングが正しいか確認
- [ ] 必要に応じて`ShopifyCustomer`などのモデルを調整

**注意点**:
- Shopify APIのバージョンによってフィールド名が異なる可能性
- 一部のフィールドが存在しない場合の処理を確認

### 🟡 推奨（パフォーマンス・信頼性向上）

#### 3. エラーハンドリングの強化
**状態**: ⏳ 未実装  
**優先度**: 中  
**内容**:
- [ ] Rate Limit エラー（429）時の待機処理を追加
- [ ] 認証エラー（401）時のリトライロジック
- [ ] 部分的な失敗時の処理を改善
- [ ] ネットワークエラー時のリトライ処理

**現在の状態**:
- Pollyによるリトライポリシーは実装済み
- Rate Limitエラー時の特別な処理は未実装

#### 4. ログ出力の改善
**状態**: ⏳ 未実装  
**優先度**: 低  
**内容**:
- [ ] 同期開始・完了時の詳細ログ
- [ ] パフォーマンスメトリクス（処理時間、レコード数など）のログ出力
- [ ] エラー発生時のコンテキスト情報の追加

**現在の状態**:
- 基本的なログ出力は実装済み
- 詳細なメトリクスは未実装

### 🟢 改善提案（任意）

#### 5. コードの重複解消
**状態**: ⏳ 未実施  
**優先度**: 低  
**内容**:
- [ ] `SaveOrUpdateCustomer` と `ShopifyApiService.UpsertCustomerAsync` の共通処理を抽出
- [ ] または、ジョブクラスから `ShopifyApiService` を直接使用

#### 6. データ検証の追加
**状態**: ⏳ 未実装  
**優先度**: 低  
**内容**:
- [ ] 取得したデータの検証（必須フィールドのチェックなど）
- [ ] 不正データのログ出力とスキップ処理

#### 7. 定期同期ジョブのスケジュール統一
**状態**: ⏳ 未実施  
**優先度**: 低  
**内容**:
- [ ] 各ジョブクラスの定期同期スケジュールを統一
- [ ] または、設定ファイルから読み込む

**現在の状態**:
- `ShopifyCustomerSyncJob`: 2時間ごと
- `ShopifyProductSyncJob`: 1時間ごと
- `ShopifyOrderSyncJob`: 3時間ごと

## 📊 実装完了度

### コア機能: 100% ✅
- HangFire基盤: ✅
- ジョブクラス: ✅
- Shopify API呼び出し: ✅
- ページネーション: ✅
- バッチ処理: ✅
- データ関連付け: ✅

### 動作確認: 0% ⏳
- 開発環境でのテスト: ⏳
- パフォーマンステスト: ⏳
- フィールドマッピング確認: ⏳

### エラーハンドリング: 60% 🟡
- 基本的な例外処理: ✅
- HangFire自動リトライ: ✅
- Rate Limit処理: ⏳
- 認証エラー処理: ⏳

### ログ・監視: 70% 🟡
- 基本的なログ: ✅
- 詳細メトリクス: ⏳
- エラーコンテキスト: ⏳

## 🎯 次のアクション

### 即座に実施すべき（本番環境デプロイ前）

1. **動作確認**
   - 開発環境で実際のShopifyストアに接続
   - 初期同期・定期同期・手動同期をテスト
   - データが正しく取得・保存されているか確認

2. **フィールドマッピング確認**
   - Shopify APIレスポンスの実際の構造を確認
   - 必要に応じてモデルを調整

### 可能な限り実施（パフォーマンス・信頼性向上）

3. **エラーハンドリングの強化**
   - Rate Limitエラー時の待機処理
   - 認証エラー時のリトライロジック

4. **ログ出力の改善**
   - パフォーマンスメトリクスの追加
   - エラーコンテキストの追加

## 📝 参考ドキュメント

- [データ同期機能実装状況レビュー](./データ同期機能実装状況レビュー.md)
- [データ同期機能詳細レビュー](./データ同期機能詳細レビュー.md)
- [同期範囲管理](./同期範囲管理.md)

