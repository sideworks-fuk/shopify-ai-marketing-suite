# 休眠顧客一覧画面 リスクレベル仕様と改善案

**作成日**: 2025年12月3日  
**作成者**: 開発チーム  
**ステータス**: 改善案検討中

---

## 1. 現在のリスクレベル仕様

### 1.1 リスクレベルの定義と判定基準

現在の実装（`backend/ShopifyAnalyticsApi/Services/Dormant/DormantCustomerQueryService.cs`）：

```csharp
private string CalculateRiskLevel(int daysSinceLastPurchase, int totalOrders)
{
    // 購入回数も考慮したリスク判定
    var baseRisk = daysSinceLastPurchase switch
    {
        <= 120 => "low",      // 120日以内：低リスク
        <= 240 => "medium",    // 240日以内：中リスク
        <= 365 => "high",      // 365日以内：高リスク
        _ => "critical"        // 365日超：危険
    };

    // 過去の購入回数が多い場合はリスクを下げる調整
    if (totalOrders >= 10 && baseRisk == "high") return "medium";
    if (totalOrders >= 5 && baseRisk == "critical") return "high";

    return baseRisk;
}
```

### 1.2 リスクレベルの種類と表示

| リスクレベル | 内部値 | 表示ラベル | 表示色 | 判定基準 |
|------------|--------|----------|--------|---------|
| **低リスク** | low | 低 | 緑（bg-green-100） | 最終購入から120日以内 |
| **中リスク** | medium | 中 | 黄（bg-yellow-100） | 121-240日以内<br/>または365日以内で購入10回以上 |
| **高リスク** | high | 高 | オレンジ（bg-orange-100） | 241-365日以内<br/>または365日超で購入5回以上 |
| **危険** | critical | 危険 | 赤（bg-red-100） | 365日超 |
| **未評価** | unrated | 未評価 | グレー（bg-gray-100） | 購入履歴なしの顧客 |

### 1.3 復帰確率（チャーン確率）の計算

```csharp
private decimal CalculateChurnProbability(int daysSinceLastPurchase)
{
    // 簡易的なチャーン確率計算
    return daysSinceLastPurchase switch
    {
        <= 90 => 0.1m,    // 10%のリスク（90%の復帰確率）
        <= 180 => 0.3m,   // 30%のリスク（70%の復帰確率）
        <= 365 => 0.5m,   // 50%のリスク（50%の復帰確率）
        <= 730 => 0.7m,   // 70%のリスク（30%の復帰確率）
        _ => 0.9m         // 90%のリスク（10%の復帰確率）
    };
}
```

**画面表示**: 復帰確率 = (1 - チャーン確率) × 100%

## 2. 現在の画面の問題点

### 2.1 フィルター部分の問題
- **問題**: フィルター項目に見出しがなく、何でフィルタリングしているか不明確
- **現状**: プルダウンメニューのプレースホルダーのみで判断

### 2.2 リスクレベルの説明不足
- **問題**: リスクレベルの判定基準が画面上で確認できない
- **現状**: 「高」「中」「低」の表示のみで、その意味が不明

### 2.3 復帰確率の不透明性
- **問題**: 復帰確率がどのように計算されているか不明
- **現状**: パーセンテージのみ表示

## 3. 改善案

### 3.1 フィルター部分の見出し改善

#### 現在のフィルター構成
```
[テキスト検索] [購買履歴▼] [リスクレベル▼] [購入回数▼] [フィルタクリア]
```

#### 改善案A：ラベル付きフィルター
```html
<div className="grid grid-cols-5 gap-4">
  <div>
    <label className="text-xs text-gray-600 mb-1 block">顧客検索</label>
    <Input placeholder="名前・メール・電話番号" />
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">購買状態</label>
    <Select>
      <SelectItem value="all">すべて</SelectItem>
      <SelectItem value="with-purchase">購入履歴あり</SelectItem>
      <SelectItem value="no-purchase">購入履歴なし</SelectItem>
    </Select>
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">リスク評価</label>
    <Select>
      <SelectItem value="all">全レベル</SelectItem>
      <SelectItem value="critical">危険（365日超）</SelectItem>
      <SelectItem value="high">高（241-365日）</SelectItem>
      <SelectItem value="medium">中（121-240日）</SelectItem>
      <SelectItem value="low">低（120日以内）</SelectItem>
    </Select>
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">購入回数</label>
    <Select>
      <SelectItem value="0">すべて</SelectItem>
      <SelectItem value="1">1回以上</SelectItem>
      <SelectItem value="3">3回以上</SelectItem>
      <SelectItem value="5">5回以上</SelectItem>
      <SelectItem value="10">10回以上</SelectItem>
    </Select>
  </div>
  
  <div className="flex items-end">
    <Button variant="outline">フィルタクリア</Button>
  </div>
</div>
```

#### 改善案B：グループ化されたフィルター
```html
<div className="space-y-3">
  <!-- 顧客情報フィルター -->
  <div className="border rounded-lg p-3 bg-gray-50">
    <h4 className="text-sm font-medium mb-2">顧客情報</h4>
    <div className="flex gap-3">
      <Input placeholder="名前・メール・電話番号で検索" className="flex-1" />
      <Select className="w-40">
        <SelectTrigger>購買状態</SelectTrigger>
        <!-- options -->
      </Select>
    </div>
  </div>
  
  <!-- リスク評価フィルター -->
  <div className="border rounded-lg p-3 bg-gray-50">
    <h4 className="text-sm font-medium mb-2">リスク評価</h4>
    <div className="flex gap-3">
      <Select className="w-48">
        <SelectTrigger>リスクレベル</SelectTrigger>
        <!-- options -->
      </Select>
      <Select className="w-40">
        <SelectTrigger>購入回数</SelectTrigger>
        <!-- options -->
      </Select>
    </div>
  </div>
</div>
```

### 3.2 リスクレベルの説明表示

#### 案1：ツールチップによる説明
```tsx
const RiskLevelBadge = ({ level, daysSince, totalOrders }) => {
  const riskInfo = {
    low: { 
      label: "低", 
      color: "bg-green-100", 
      tooltip: "120日以内に購入\n再購入の可能性が高い"
    },
    medium: { 
      label: "中", 
      color: "bg-yellow-100", 
      tooltip: "121-240日経過\nフォローアップ推奨"
    },
    high: { 
      label: "高", 
      color: "bg-orange-100", 
      tooltip: "241-365日経過\n早急な対応が必要"
    },
    critical: { 
      label: "危険", 
      color: "bg-red-100", 
      tooltip: "365日超経過\n離脱リスク極めて高い"
    }
  };

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger>
          <Badge className={riskInfo[level].color}>
            {riskInfo[level].label}
          </Badge>
        </TooltipTrigger>
        <TooltipContent>
          <div className="text-xs">
            <div className="font-semibold">{riskInfo[level].tooltip}</div>
            <div className="mt-1">
              休眠期間: {daysSince}日
              {totalOrders >= 5 && <div>購入回数による調整済</div>}
            </div>
          </div>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
};
```

#### 案2：インフォアイコン付き表示
```tsx
<TableHead>
  リスクレベル
  <InfoIcon 
    className="inline ml-1 w-3 h-3 cursor-help"
    onClick={() => setShowRiskLegend(true)}
  />
</TableHead>

// リスクレベル凡例モーダル
{showRiskLegend && (
  <Dialog open={showRiskLegend} onOpenChange={setShowRiskLegend}>
    <DialogContent>
      <DialogHeader>
        <DialogTitle>リスクレベルについて</DialogTitle>
      </DialogHeader>
      <div className="space-y-3">
        <div className="flex items-center gap-3">
          <Badge className="bg-green-100">低</Badge>
          <div>
            <div className="font-medium">120日以内</div>
            <div className="text-sm text-gray-600">アクティブ顧客・再購入可能性高</div>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <Badge className="bg-yellow-100">中</Badge>
          <div>
            <div className="font-medium">121-240日</div>
            <div className="text-sm text-gray-600">要注意・フォローアップ推奨</div>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <Badge className="bg-orange-100">高</Badge>
          <div>
            <div className="font-medium">241-365日</div>
            <div className="text-sm text-gray-600">休眠化進行・早急な対応必要</div>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <Badge className="bg-red-100">危険</Badge>
          <div>
            <div className="font-medium">365日超</div>
            <div className="text-sm text-gray-600">完全休眠・特別施策が必要</div>
          </div>
        </div>
      </div>
      <div className="mt-4 p-3 bg-blue-50 rounded">
        <p className="text-sm">
          <strong>補足:</strong> 過去の購入回数が多い顧客（5回以上）は、
          リスクレベルが自動的に1段階下げられます。
        </p>
      </div>
    </DialogContent>
  </Dialog>
)}
```

### 3.3 復帰確率の可視化

#### 案1：プログレスバー表示
```tsx
const ReturnProbability = ({ probability }) => {
  const color = probability >= 70 ? 'bg-green-500' : 
                probability >= 40 ? 'bg-yellow-500' : 
                'bg-red-500';
  
  return (
    <div className="w-full">
      <div className="flex justify-between text-xs mb-1">
        <span>{probability}%</span>
        <span className="text-gray-500">
          {probability >= 70 ? '高' : probability >= 40 ? '中' : '低'}
        </span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2">
        <div 
          className={`h-2 rounded-full ${color}`}
          style={{ width: `${probability}%` }}
        />
      </div>
    </div>
  );
};
```

#### 案2：数値と視覚的インジケーター
```tsx
const ReturnProbabilityIndicator = ({ probability, daysSince }) => {
  const getIcon = () => {
    if (probability >= 70) return <TrendingUp className="text-green-500" />;
    if (probability >= 40) return <TrendingFlat className="text-yellow-500" />;
    return <TrendingDown className="text-red-500" />;
  };
  
  return (
    <div className="flex items-center gap-2">
      {getIcon()}
      <div>
        <div className="font-medium">{probability}%</div>
        <div className="text-xs text-gray-500">
          {daysSince <= 90 ? '短期休眠' : 
           daysSince <= 180 ? '中期休眠' : 
           daysSince <= 365 ? '長期休眠' : '超長期休眠'}
        </div>
      </div>
    </div>
  );
};
```

## 4. 実装優先順位

### Phase 1（即座に実装可能）
1. フィルターへのラベル追加
2. リスクレベルの選択肢に日数を併記

### Phase 2（軽微な改修）
1. リスクレベルのツールチップ追加
2. 復帰確率のプログレスバー表示

### Phase 3（中規模改修）
1. リスクレベル凡例モーダル
2. フィルターのグループ化
3. 詳細な統計情報の表示

## 5. 推奨実装案

### 5.1 最小限の改善（1日で実装可能）

```tsx
// フィルター部分の改善
<div className="flex gap-2 items-end">
  <div className="flex-1">
    <label className="text-xs text-gray-600 mb-1 block">検索</label>
    <Input placeholder="名前・メール・電話番号" />
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">購買状態</label>
    <Select>...</Select>
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">リスク</label>
    <Select>
      <SelectItem value="all">すべて</SelectItem>
      <SelectItem value="critical">危険（1年超）</SelectItem>
      <SelectItem value="high">高（8-12ヶ月）</SelectItem>
      <SelectItem value="medium">中（4-8ヶ月）</SelectItem>
      <SelectItem value="low">低（4ヶ月以内）</SelectItem>
    </Select>
  </div>
  
  <div>
    <label className="text-xs text-gray-600 mb-1 block">購入回数</label>
    <Select>...</Select>
  </div>
  
  <Button variant="outline" size="sm">クリア</Button>
</div>

// テーブルヘッダーの改善
<TableHead>
  リスクレベル
  <HelpCircle className="inline ml-1 w-3 h-3" />
</TableHead>

// 復帰確率の表示改善
<TableCell>
  <div className="flex items-center gap-2">
    <span className="font-medium">{probability}%</span>
    <div className="w-16 bg-gray-200 rounded-full h-1.5">
      <div 
        className={`h-1.5 rounded-full ${getColorClass(probability)}`}
        style={{ width: `${probability}%` }}
      />
    </div>
  </div>
</TableCell>
```

## 6. まとめ

### 現状の課題
1. リスクレベルの判定基準が不透明
2. フィルター項目の意味が不明確
3. 復帰確率の計算根拠が不明

### 提案する改善
1. **即座対応**: フィルターにラベルを追加
2. **短期対応**: リスクレベルの説明をツールチップで表示
3. **中期対応**: 復帰確率の視覚化とリスク凡例の追加

これらの改善により、ユーザーはリスクレベルの意味を理解しやすくなり、適切なアクションを取ることができるようになります。

---

**改訂履歴**
- 2025-12-03: 初版作成
