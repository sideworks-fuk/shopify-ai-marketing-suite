# カスタム配布設定ガイド

## 最終更新: 2025-12-23

## 概要

Shopify Partners Dashboardの「カスタム配布」設定について説明します。

## カスタム配布の設定項目

### 1. ストアドメイン（Store Domain）

**設定方法**:
- ストアドメインを入力するか、空欄のままにする

**動作**:

#### ストアドメインを指定した場合
```
例: shop1.myshopify.com
```
- ✅ **指定したストアにのみインストール可能**
- ❌ 他のストアにはインストールできない
- **用途**: 特定のクライアント向けのカスタムアプリ

#### ストアドメインを空欄にした場合
```
（入力なし）
```
- ⚠️ **注意**: カスタムアプリは、**作成元のストア以外にはインストールできない**という制限があります
- ✅ 開発・テスト用に便利（同じストア内でのテスト）
- **用途**: 開発環境、テスト環境での同一ストア内でのテスト
- **制限**: 他のストアにはインストールできない（公開アプリとして登録する必要がある）

### 2. Plus組織での複数ストアインストール

**チェックボックス**: 「1つのPlus組織に対して複数ストアのインストールを許可する」

#### チェックを入れた場合（推奨）
- ✅ **同じPlus組織に属する複数のストアにインストール可能**
- ✅ 1つのPlus組織内のすべてのストアで使用可能
- **用途**: 企業が複数のストアを運営している場合

**例**:
```
Plus組織: "ABC株式会社"
  ├─ shop1.myshopify.com（本店）
  ├─ shop2.myshopify.com（支店A）
  └─ shop3.myshopify.com（支店B）

→ すべてのストアに同じカスタムアプリをインストール可能
```

#### チェックを入れない場合
- ❌ **1つのストアにのみインストール可能**
- **用途**: 単一ストア専用のカスタムアプリ

## 推奨設定（開発環境）

### 開発・テスト用の設定

```
ストアドメイン: （空欄）
✅ 1つのPlus組織に対して複数ストアのインストールを許可する
```

**注意**: カスタムアプリは作成元のストア以外にはインストールできません。開発環境では、**同じストア内でのテスト**が主な用途です。

**メリット**:
- 同じストア内での開発・テストが可能
- Shopify Plusプランの場合、同じPlus組織内の複数ストアでテスト可能
- 柔軟性が高い（ストアドメインを指定する必要がない）

### 本番環境（特定クライアント向け）の設定

```
ストアドメイン: client-store.myshopify.com
✅ 1つのPlus組織に対して複数ストアのインストールを許可する
```

**メリット**:
- 特定のクライアントのストアにのみインストール可能
- セキュリティが高い
- Plus組織内の複数ストアにも対応

## 現在の設定（ECレンジャー (local)）

### 推奨設定

開発環境でのテストを考慮して、以下を推奨します：

```
ストアドメイン: （空欄）
✅ 1つのPlus組織に対して複数ストアのインストールを許可する
```

**理由**:
1. **開発の柔軟性**: ストアドメインを指定する必要がない（同じストア内でのテスト）
2. **Plus組織対応**: Shopify Plusプランの場合、同じPlus組織内の複数ストアでテスト可能
3. **将来の拡張性**: 公開アプリへの移行を検討する際の準備

**⚠️ 重要な注意事項**:
- カスタムアプリは**作成元のストア以外にはインストールできません**
- 複数のストアで使用する場合は、**公開アプリとして登録**する必要があります

### ストアドメインを指定する場合

特定のストアにのみインストールを制限したい場合：

```
ストアドメイン: fuk-dev1.myshopify.com
✅ 1つのPlus組織に対して複数ストアのインストールを許可する
```

**注意**: この設定では、`fuk-dev1.myshopify.com`と、同じPlus組織に属する他のストアにのみインストール可能です。

## 公開アプリとカスタムアプリの違い

### 公開アプリの配布状態

| 状態 | App Store掲載 | インストールリンク | 誰がインストール可能 | 審査の必要性 |
|------|--------------|------------------|-------------------|------------|
| **未申請/審査中** | ❌ | ✅ 使用可能 | リンクを知っている人のみ | ⚠️ **審査申請は必要**（App Store掲載のため） |
| **審査通過（公開済み）** | ✅ | ✅ 使用可能 | 誰でも | ✅ 審査通過済み |

#### 重要なポイント

1. **審査申請は必要**
   - Shopify App Storeで公開するには、**必ず審査を受ける必要があります**
   - 審査を通過したアプリのみが、App Storeに掲載され、誰でもインストールできるようになります

2. **審査前でもインストールリンクは使用可能**
   - 審査前の段階でも、特定の条件を満たせばインストールリンクを通じてアプリをインストールできます
   - この場合、アプリはApp Storeには掲載されていませんが、リンクを知っているユーザーに対して直接インストールリンクを共有することで、アプリを利用してもらうことができます

#### 審査前でもインストールできる条件

公開アプリ（未掲載）でインストールリンクを使うには：

1. **App URLとRedirect URLが正しく設定されている**
2. **アプリが「開発中」ではなく有効な状態**
3. **審査申請は後で行う**（App Store掲載のため）

#### インストールリンクの形式

**公開アプリのインストールリンク**:
```
https://partners.shopify.com/[partner-id]/apps/[app-id]/install
```

**カスタムアプリのインストールリンク**:
```
https://partners.shopify.com/[partner-id]/apps/[app-id]/install?store=[store-domain]
```

**カスタムアプリのストアドメインを空欄にした場合**:
- リンクに`store`パラメータが含まれない
- 作成元のストアでのみインストール可能

**カスタムアプリのストアドメインを指定した場合**:
- リンクに`store`パラメータが含まれる
- 指定したストアでのみインストール可能

### インストールリンクの生成方法

1. **公開アプリの場合**:
   - Shopify Partners Dashboardで「公開アプリ」を選択
   - 「インストールリンク」セクションからリンクを生成
   - ⚠️ **審査申請は必要**（App Store掲載のため）
   - 審査前でもリンクを使用可能（リンクを知っている人のみ）

2. **カスタムアプリの場合**:
   - Shopify Partners Dashboardで「カスタム配布」を設定
   - 「リンクを生成」ボタンをクリック
   - 生成されたリンクをコピー

### カスタムアプリの制限事項

**カスタムアプリは、作成元のストア以外にはインストールできません。**

- ❌ **他のストアにはインストールできない**
- ✅ **作成元のストアにのみインストール可能**
- ✅ **Shopify Plusプランの場合**: 同じPlus組織に属する複数のストアにインストール可能（「1つのPlus組織に対して複数ストアのインストールを許可する」にチェックを入れた場合）

### 複数のストアで使用する場合

複数のストアで同じアプリを使用したい場合は、以下のいずれかの方法が必要です：

1. **公開アプリとして登録（推奨）**
   - Shopify App Storeに公開アプリとして登録
   - **⚠️ 審査申請は必要**（App Store掲載のため）
   - **審査前でもインストールリンクを使用可能**（リンクを知っている人のみ）
   - 審査通過後はApp Storeに掲載され、誰でもインストール可能
   - **1つのアプリで複数の顧客（ストア）に対応可能**
   - 複数のストアでインストール可能

2. **Shopify Plusプランを利用**
   - カスタム配布を選択
   - 「1つのPlus組織に対して複数ストアのインストールを許可する」にチェック
   - 同じPlus組織に属する複数のストアにインストール可能
   - **注意**: 異なるPlus組織（異なる顧客）には対応できない

3. **カスタムアプリを顧客ごとに作成**
   - 各顧客（ストア）ごとにカスタムアプリを作成
   - 各カスタムアプリを`ShopifyApps`テーブルに登録
   - **注意**: 顧客数が増えると管理が複雑になる
   - **用途**: 特定の顧客専用の機能を提供する場合

## よくある質問

### Q1: カスタムアプリは作成元ストア以外にインストールできないのか？

**A**: はい、**カスタムアプリは作成元のストア以外にはインストールできません**。ただし、Shopify Plusプランを利用している場合、同じPlus組織に属する複数のストアにインストール可能です（「1つのPlus組織に対して複数ストアのインストールを許可する」にチェックを入れた場合）。

### Q2: 公開アプリは審査申請が必要なのか？

**A**: はい、**公開アプリは審査申請が必要です**。Shopify App Storeで公開するには、必ず審査を受ける必要があります。ただし、**審査前でもインストールリンクを使用できます**（リンクを知っている人のみ）。以下の条件を満たしていれば、審査通過前でもインストール可能です：
- App URLとRedirect URLが正しく設定されている
- アプリが「開発中」ではなく有効な状態

**注意**: 審査前のインストールは、App Storeに掲載される前のテストや限定配布に使用できます。広く一般に公開するためには、審査を通過する必要があります。

### Q3: ストアドメインを空欄にすると、誰でもインストールできるのか？

**A**: 
- **カスタムアプリの場合**: いいえ。カスタムアプリは、生成されたインストールリンクを知っている人だけがインストールできます。ただし、**作成元のストアにのみインストール可能**です。App Storeには公開されません。
- **公開アプリの場合**: 審査通過後は誰でもインストール可能です。未申請/審査中の場合は、リンクを知っている人のみがインストール可能です。

### Q2: Plus組織の設定は必須か？

**A**: 必須ではありませんが、**推奨**します。将来的にPlus組織のクライアントに対応する可能性があるため、チェックを入れておくと便利です。

### Q3: ストアドメインを後から変更できるか？

**A**: はい、変更可能です。ただし、既にインストールされているストアには影響しません。

### Q4: 複数のストアドメインを指定できるか？

**A**: いいえ、1つのストアドメインのみ指定可能です。複数のストアに対応する場合は、ストアドメインを空欄にして、Plus組織の設定を有効にしてください。

### Q6: カスタムアプリのインストールリンクに`redirect_uri`が含まれないのはなぜか？

**A**: カスタムアプリのインストールリンク（`/oauth/install_custom_app`）には、**`redirect_uri`パラメータが含まれません**。これは、カスタムアプリのインストールプロセスがShopify管理画面内で完結するためです。

**重要なポイント**:
- カスタムアプリの場合、コールバックURLは**Shopify Partners Dashboardで設定された「Redirect URLs」**が使用されます
- そのため、**「Redirect URLs」が正しく設定されていることが必須**です
- 設定されていない場合、OAuth認証後のコールバックが失敗します

**設定例**:
```
Redirect URLs: https://fe155b402044.ngrok-free.app/api/shopify/callback
```

**確認方法**:
1. Shopify Partners Dashboardで「Redirect URLs」を確認
2. バックエンドの`GetRedirectUri()`メソッドが生成するURLと一致しているか確認
3. 一致していない場合、Shopify Partners Dashboardの設定を更新

### Q7: カスタムアプリのインストールリンク（`/oauth/install_custom_app`）と通常のOAuth認証URL（`/admin/oauth/authorize`）の違いは？

**A**: これらは**異なるインストールフロー**です。

#### 1. カスタムアプリのインストールリンク（`/oauth/install_custom_app`）

**URL形式**:
```
https://admin.shopify.com/oauth/install_custom_app?client_id={apiKey}&no_redirect=true&signature={signature}
```

**特徴**:
- ✅ **インストールできる**（Shopify管理画面内で完結）
- ❌ **コールバックが来ない可能性がある**（`no_redirect=true`の場合）
- Shopify Partners Dashboardで生成される専用リンク
- カスタムアプリ専用のフロー

**問題点**:
- `no_redirect=true`が設定されている場合、コールバックが発生しない
- バックエンドの`Callback`メソッドが呼ばれない
- `Stores`テーブルにレコードが作成されない

#### 2. 通常のOAuth認証URL（`/admin/oauth/authorize`）

**URL形式**:
```
https://{shop}/admin/oauth/authorize?client_id={apiKey}&scope={scopes}&redirect_uri={redirectUri}&state={state}
```

**特徴**:
- ✅ **コールバックが来る**（`redirect_uri`にリダイレクト）
- ✅ **バックエンドの`Callback`メソッドが呼ばれる**
- ✅ **`Stores`テーブルにレコードが作成される**
- 公開アプリとカスタムアプリの両方で使用可能

**問題点**:
- カスタムアプリの場合、このURLではインストールできない可能性がある
- カスタムアプリは`/oauth/install_custom_app`を使用する必要がある

#### 解決策

**カスタムアプリの場合**:
1. **カスタムアプリのインストールリンクを使用する場合**:
   - Shopify Partners Dashboardで生成されたリンクを直接使用
   - ただし、`no_redirect=true`が設定されている場合、コールバックが来ない
   - **推奨**: カスタムアプリのインストールリンクは使用せず、通常のOAuth認証フローを使用

2. **通常のOAuth認証フローを使用する場合**:
   - フロントエンドの`/install`ページから開始
   - バックエンドの`/api/shopify/install`エンドポイントを経由
   - 通常のOAuth認証URL（`/admin/oauth/authorize`）にリダイレクト
   - コールバックが正常に動作する

**推奨アプローチ**:
- カスタムアプリでも、**通常のOAuth認証フロー（`/admin/oauth/authorize`）を使用することを推奨**
- フロントエンドの`/install`ページから開始することで、コールバックが正常に動作する

### Q8: カスタムアプリのインストールリンクからインストールした後、`/install`ページが動作するのはなぜか？

**A**: カスタムアプリのインストールリンク（`/oauth/install_custom_app`）からインストールした後、Shopify側でアプリが「インストール済み」状態になります。その後、フロントエンドの`/install`ページから通常のOAuth認証フロー（`/admin/oauth/authorize`）を開始すると、既にインストールされているアプリに対してOAuth認証が実行され、コールバックが正常に動作します。

**動作の流れ**:

1. **カスタムアプリのインストールリンクからインストール**:
   ```
   https://admin.shopify.com/oauth/install_custom_app?client_id=...&no_redirect=true&signature=...
   ```
   - ✅ インストールは完了する
   - ❌ コールバックが来ない（`no_redirect=true`のため）
   - ❌ `Stores`テーブルにレコードが作成されない

2. **その後、`/install`ページから通常のOAuth認証フローを開始**:
   ```
   https://fe155b402044.ngrok-free.app/install
   ```
   - ✅ バックエンドの`/api/shopify/install`が呼ばれる
   - ✅ 通常のOAuth認証URL（`/admin/oauth/authorize`）が生成される
   - ✅ Shopify側で既にインストールされているアプリに対してOAuth認証が実行される
   - ✅ コールバックが正常に動作する
   - ✅ `Stores`テーブルにレコードが作成/更新される

**重要なポイント**:
- カスタムアプリのインストールリンクからインストールした後、Shopify側でアプリが「インストール済み」状態になる
- その後、通常のOAuth認証フロー（`/admin/oauth/authorize`）が動作するようになる
- この方法で、コールバックが正常に動作し、`Stores`テーブルにレコードが作成される

**推奨ワークフロー**:
1. カスタムアプリのインストールリンクからインストール（Shopify側でアプリを認識させる）
2. その後、`/install`ページから通常のOAuth認証フローを開始（コールバックを正常に動作させる）

**注意**: この方法は、カスタムアプリのインストールリンクからインストールした後、`Stores`テーブルにレコードが作成されない問題を回避するためのワークアラウンドです。理想的には、カスタムアプリのインストールリンクからもコールバックが来るべきですが、`no_redirect=true`が設定されているため、コールバックが発生しません。

### Q9: カスタムアプリの2段階インストールフローの仕様は？

**A**: カスタムアプリの場合、**2段階のプロセス**が必要です。

#### パターン1: 未インストール状態で `/install` 実行

```
┌─────────────────────────────────────────────────────────┐
│ パターン1: 未インストール状態で /install 実行            │
│                                                         │
│ /install → OAuth認証画面 → 「インストールリンクは無効」  │
│                           （カスタムアプリはOAuth不可）  │
└─────────────────────────────────────────────────────────┘
```

**結果**: ❌ 「インストールリンクは無効」エラーが発生

**理由**: カスタムアプリの場合、未インストール状態では通常のOAuth認証フロー（`/admin/oauth/authorize`）が動作しない

#### パターン2: Shopifyリンクでインストール済み → `/install`

```
┌─────────────────────────────────────────────────────────┐
│ パターン2: Shopifyリンクでインストール済み → /install    │
│                                                         │
│ Shopifyリンク → インストール完了（トークン未取得）       │
│       ↓                                                 │
│ /install → OAuth認証画面 → 既にインストール済みなので    │
│            スコープ確認のみ → callback成功              │
└─────────────────────────────────────────────────────────┘
```

**結果**: ✅ コールバックが正常に動作し、`Stores`テーブルにレコードが作成される

**理由**: 
1. **Shopify生成リンク**: アプリをストアに「インストール」するが、**アクセストークンは発行しない**
2. **/install（OAuth）**: 既にインストール済みのアプリに対して、**アクセストークンを取得**する

#### 解決策: App URLを `/install` に設定

**方法A: App URLを `/install` に設定**

Shopify Partners Dashboardの「App URL」を以下のように設定：

```
App URL: https://fe155b402044.ngrok-free.app/install
```

**効果**:
- カスタムアプリのインストールリンクからインストール後、自動的に `/install` にリダイレクトされる
- `/install` ページから通常のOAuth認証フローが開始される
- コールバックが正常に動作する

**設定例**:
```
App URL: https://fe155b402044.ngrok-free.app/install
Redirect URLs: https://fe155b402044.ngrok-free.app/api/shopify/callback
```

**注意**: 
- App URLを `/install` に設定すると、アプリのルートURL（`https://fe155b402044.ngrok-free.app`）にアクセスした場合、自動的に `/install` にリダイレクトされる必要があります
- フロントエンドのルートページ（`/`）から `/install` へのリダイレクトを実装することを推奨します

**方法B: 2段階インストールフローを実装（現在の動作）**

1. 顧客にShopify生成リンクを送る
2. インストール完了後、手動で `/install` にアクセス
3. OAuth認証でアクセストークン取得

**推奨**: **方法A（App URLを `/install` に設定）**を推奨します。これにより、カスタムアプリのインストール後に自動的にOAuthフローが開始され、ユーザー体験が向上します。

### Q5: カスタムアプリの場合、顧客ごとにアプリを登録していく必要があるか？

**A**: はい、**カスタムアプリで複数の顧客（異なるストア）に対応する場合、顧客ごとにアプリを登録する必要があります**。

**理由**:
- カスタムアプリは、作成元のストア（またはPlus組織内の複数ストア）にのみインストール可能
- 異なる顧客（異なるストア）に提供する場合は、各顧客ごとにカスタムアプリを作成する必要がある

**対応方法**:

1. **公開アプリを使用（推奨）**
   - 1つの公開アプリで複数の顧客（ストア）に対応可能
   - 審査申請は必要だが、審査前でもインストールリンクを使用可能
   - 管理が簡単

2. **カスタムアプリを顧客ごとに作成**
   - 各顧客ごとにShopify Partners Dashboardでカスタムアプリを作成
   - 各カスタムアプリのAPI Key/Secretを`ShopifyApps`テーブルに登録
   - 顧客数が増えると管理が複雑になる

**例**:
```
顧客A（shop-a.myshopify.com）
  → カスタムアプリAを作成
  → ShopifyAppsテーブルに登録（ApiKey: AAA, ApiSecret: XXX）

顧客B（shop-b.myshopify.com）
  → カスタムアプリBを作成
  → ShopifyAppsテーブルに登録（ApiKey: BBB, ApiSecret: YYY）

顧客C（shop-c.myshopify.com）
  → カスタムアプリCを作成
  → ShopifyAppsテーブルに登録（ApiKey: CCC, ApiSecret: ZZZ）
```

**推奨**: 複数の顧客に対応する場合は、**公開アプリを使用することを推奨**します。

## 関連ドキュメント

- [ShopifyAppsテーブル設計書](./ShopifyAppsテーブル設計書.md)
- [マルチアプリ対応設計書](./マルチアプリ対応設計書.md)
- [インストール時のAPI Key判定方法](./インストール時のAPI Key判定方法.md)

