# マルチアプリ対応実装前確認事項

## 1. 設計の確認

### 1.1 設計方針
✅ **データベースベースのCredentials管理**を採用
- ストアごとに異なるAPI Key/Secretをデータベースで管理
- 後方互換性を維持（既存ストアはデフォルトCredentialsで動作）

### 1.2 重要な設計判断

#### 判断1: 既存Credentialsの保護
- **決定**: データベースに既に保存されているApiKey/ApiSecretは上書きしない
- **理由**: 手動で設定したCredentialsを誤って上書きすることを防ぐ
- **実装**: `SaveOrUpdateStore`で既存値がNULLの場合のみ保存

#### 判断2: フォールバック機構
- **決定**: データベースにCredentialsが存在しない場合は、設定ファイル/環境変数から取得
- **理由**: 既存ストアの後方互換性を維持
- **実装**: `GetShopifyCredentialsAsync`でデータベース優先、フォールバックは設定ファイル

#### 判断3: セキュリティ（Phase 1）
- **決定**: ApiSecretは平文で保存（Phase 2で暗号化予定）
- **理由**: Phase 1では実装をシンプルに保つ
- **注意**: 本番環境ではデータベースアクセスを制限し、ログに出力しない

---

## 2. 現在の実装状況

### 2.1 既に実装済み
- ✅ `GetShopifyCredentialsAsync`メソッド
  - データベース優先、フォールバックは設定ファイル/環境変数
  - エラーハンドリングとログ出力も実装済み
- ✅ `SaveOrUpdateStore`メソッドの拡張
  - API Key/Secretの保存機能を追加
  - 既存Credentials保護機能を実装
- ✅ OAuth認証フローの修正
  - `Callback`と`ProcessCallback`で使用したAPI Key/Secretを保存

### 2.2 実装前の確認が必要な項目

#### 2.2.1 データベース
- [ ] `Domain`カラムにインデックスが設定されているか確認
- [ ] 既存データのバックアップ
- [ ] テスト環境での動作確認

#### 2.2.2 設定
- [ ] デフォルトのAPI Key/Secretが環境変数に設定されているか確認
- [ ] テスト用のAPI Key/Secretが準備されているか確認
- [ ] 公開アプリとカスタムアプリのAPI Key/Secretが準備されているか確認

#### 2.2.3 コード
- [ ] エラーハンドリングの確認
- [ ] ログ出力の確認（API Secretが出力されていないか）
- [ ] 既存コードとの互換性確認

#### 2.2.4 ShopifyAppsテーブル
- [ ] `ShopifyApp`エンティティが作成されているか確認
- [ ] `Store`エンティティに`ShopifyAppId`プロパティが追加されているか確認
- [ ] EF Core Migrationが作成されているか確認
- [ ] 初期データ投入SQLが準備されているか確認

---

## 3. 実装後の検証計画

### 3.1 機能検証

#### テストケース1: 新規ストアのインストール（公開アプリ用）
1. データベースに`ApiKey`と`ApiSecret`がNULLのストアでOAuth認証を実行
2. デフォルトCredentials（設定ファイル）で認証が成功することを確認
3. データベースに使用したAPI Key/Secretが保存されることを確認
4. 次回のOAuth認証で保存されたCredentialsが使用されることを確認

#### テストケース2: 既存ストアの再認証
1. データベースに既に`ApiKey`と`ApiSecret`が保存されているストアでOAuth認証を実行
2. 既存のCredentialsが保護されること（上書きされないこと）を確認
3. 保存済みのCredentialsで認証が成功することを確認

#### テストケース3: 手動設定されたストア
1. SQLで手動に`ApiKey`と`ApiSecret`を設定
2. OAuth認証を実行
3. 手動設定したCredentialsが使用されることを確認
4. 手動設定したCredentialsが保護されること（上書きされないこと）を確認

### 3.2 エラーケース検証

#### エラーケース1: API Keyが見つからない
- データベースにも設定ファイルにもAPI Keyが存在しない場合
- 期待動作: エラーログ出力、500エラーを返す

#### エラーケース2: データベースアクセスエラー
- データベース接続エラーが発生した場合
- 期待動作: エラーログ出力、設定ファイルから取得（フォールバック）

#### エラーケース3: 無効なAPI Key/Secret
- 無効なAPI Key/SecretでOAuth認証を実行
- 期待動作: Shopify APIからエラーが返される、適切なエラーハンドリング

---

## 4. 実装の詳細設計

### 4.1 データフロー

```
[インストール開始]
  ↓
GetShopifyCredentialsAsync(shop)
  ├─ データベースから取得（優先）
  └─ 存在しない → 設定ファイルから取得（フォールバック）
  ↓
Shopify OAuth URL構築
  ↓
[ユーザー認証]
  ↓
[OAuth認証完了]
  ↓
GetShopifyCredentialsAsync(shop)  // 再度取得
  ↓
ExchangeCodeForAccessToken(code, shop, apiKey, apiSecret)
  ↓
SaveOrUpdateStore(shop, accessToken, apiKey, apiSecret)
  ├─ 新規ストア → API Key/Secretを保存
  └─ 既存ストア → 既存Credentialsを保護（上書きしない）
```

### 4.2 メソッドの責務

#### `GetShopifyCredentialsAsync`
- **入力**: ショップドメイン
- **出力**: (ApiKey, ApiSecret) のタプル
- **責務**: ストアドメインに基づいてCredentialsを取得（データベース優先）

#### `SaveOrUpdateStore`
- **入力**: ショップドメイン、アクセストークン、API Key（オプション）、API Secret（オプション）
- **出力**: なし（void）
- **責務**: ストア情報とOAuth認証情報を保存（既存Credentialsを保護）

---

## 5. セキュリティ考慮事項

### 5.1 Phase 1（現在）
- ApiKey: 平文で保存
- ApiSecret: 平文で保存
- AccessToken: 暗号化して保存（既存実装）

### 5.2 セキュリティ対策
- ✅ データベースアクセス制限（Azure SQL Databaseのファイアウォール設定）
- ✅ ログにAPI Secretが出力されないように注意
- ⚠️ ApiSecretの暗号化は未実装（Phase 2で対応予定）

### 5.3 ログ出力の注意点
- API Key/Secretをログに出力しない
- デバッグログでも機密情報は出力しない
- エラーログには機密情報を含めない

---

## 6. 実装前の最終確認

### 6.1 コードレビュー項目
- [ ] `GetShopifyCredentialsAsync`の実装確認
- [ ] `SaveOrUpdateStore`の実装確認
- [ ] エラーハンドリングの確認
- [ ] ログ出力の確認（機密情報が含まれていないか）
- [ ] 既存コードとの互換性確認

### 6.2 テスト環境の準備
- [ ] テスト用のShopifyアプリ（公開/カスタム）の準備
- [ ] テスト用のAPI Key/Secretの準備
- [ ] テスト用データベースの準備
- [ ] テスト用ストアの準備

### 6.3 ドキュメント
- [x] 設計書の作成
- [ ] 実装手順書の作成（必要に応じて）
- [ ] 運用マニュアルの更新（必要に応じて）

---

## 7. 次のステップ

### 7.1 実装前
1. 設計書のレビュー
2. 実装前確認事項のチェック
3. テスト環境の準備

### 7.2 実装後
1. 機能検証
2. エラーケース検証
3. パフォーマンス検証
4. ドキュメント更新

---

## 8. 関連ドキュメント
- `マルチアプリ対応設計書.md` - 詳細設計
- `マルチアプリ対応アーキテクチャ.md` - 全体アーキテクチャ
- `マルチCredentials管理方法.md` - Credentials管理の詳細
- `公開アプリとカスタムアプリの構成パターン.md` - 構成パターンの比較

