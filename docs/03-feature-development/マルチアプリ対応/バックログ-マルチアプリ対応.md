# バックログチケット: マルチアプリ対応（公開アプリ・カスタムアプリ）

## チケット情報

| 項目 | 内容 |
|------|------|
| **タイトル** | マルチアプリ対応: 公開アプリとカスタムアプリの両方に対応 |
| **優先度** | 中 |
| **見積もり** | 8時間（1日） |
| **担当** | 開発チーム |
| **ステータス** | バックログ |

---

## 概要

現在、Shopifyアプリは1つのAPI Key/Secretのみをサポートしていますが、公開アプリ（本番環境）とカスタムアプリ（公開前レビュー用）の両方に対応できるように拡張します。

これにより、公開前に特別なユーザーにレビューしてもらうためのカスタムアプリと、一般公開用の公開アプリを分離しながら、同じバックエンド・データベースインフラを使用できるようになり、コスト効率を維持しながら柔軟性を向上させます。

---

## 背景・目的

### 現状の課題

- 1つのShopifyアプリ（API Key/Secret）のみをサポート
- 公開前のレビュー用と一般公開用で同じアプリを使用する必要がある
- レビュー時に一般公開環境に影響を与えるリスクがある

### 解決後のメリット

- ✅ 公開アプリ（一般公開）とカスタムアプリ（公開前レビュー用）を分離
- ✅ 公開前レビューでの動作確認が一般公開環境に影響しない
- ✅ コスト効率を維持（追加のインフラ不要）
- ✅ ストアごとに異なるアプリを使用可能

---

## 受け入れ基準（Acceptance Criteria）

### 必須要件

- [ ] ストアドメインに基づいて、データベースからAPI Key/Secretを取得できる
- [ ] データベースに保存されていない場合は、環境変数のデフォルト値を使用する
- [ ] OAuth認証フローが、ストア固有のAPI Key/Secretで正常に動作する
- [ ] 既存のストア（データベースにAPI Key/Secretが設定されていない）は、環境変数のデフォルト値で動作する（後方互換性）
- [ ] エラーハンドリングとログ出力が適切に実装されている

### 非機能要件

- [ ] パフォーマンス: データベースクエリの追加による影響は最小限（キャッシュ検討）
- [ ] セキュリティ: API Secretは平文で保存（将来的に暗号化を検討）
- [ ] ログ: 使用したAPI Keyの識別情報をログに記録（Secretは記録しない）

---

## 実装内容

### 1. バックエンドの修正

#### 1.1 `ShopifyAuthController.cs` の修正

**追加するメソッド**:
```csharp
private async Task<(string ApiKey, string ApiSecret)> GetShopifyCredentialsAsync(string shopDomain)
{
    // データベースからストア情報を取得
    // ストア固有のCredentialsがあれば使用
    // なければ環境変数のデフォルト値を使用
}
```

**修正するメソッド**:
- `Install` メソッド: `GetShopifyCredentialsAsync`を使用
- `ProcessCallback` メソッド: `GetShopifyCredentialsAsync`を使用
- `ExchangeCodeForAccessTokenWithRetry` メソッド: `GetShopifyCredentialsAsync`を使用

#### 1.2 エラーハンドリングとログ出力

- データベースアクセスエラー時のフォールバック処理
- 使用したAPI Keyのログ出力（Secretは出力しない）
- エラー時の適切な例外処理

### 2. データベース設定

#### 2.1 既存フィールドの確認

- `Store`テーブルの`ApiKey`と`ApiSecret`フィールドが存在することを確認
- 既存のデータに影響がないことを確認

#### 2.2 レビュー用データの設定

```sql
-- 公開前レビュー用ストアにAPI Key/Secretを設定
UPDATE Stores 
SET ApiKey = 'カスタムアプリのAPIキー',
    ApiSecret = 'カスタムアプリのAPIシークレット'
WHERE Domain = 'review-store.myshopify.com';
```

### 3. テスト・検証

#### 3.1 単体テスト

- `GetShopifyCredentialsAsync`メソッドのテスト
- データベースに保存されている場合のテスト
- データベースに保存されていない場合のテスト（フォールバック）
- エラー時のテスト

#### 3.2 統合テスト

- OAuth認証フローのテスト（ストア固有のAPI Key/Secret使用）
- OAuth認証フローのテスト（環境変数のデフォルト値使用）
- 既存ストアの後方互換性テスト

---

## 実装手順

### Phase 1: 基本実装（推奨）

1. **既存実装の確認**
   - `Store`テーブルの`ApiKey`と`ApiSecret`フィールドを確認
   - 既存のOAuth認証フローを確認

2. **バックエンドの修正**
   - `GetShopifyCredentialsAsync`メソッドを追加
   - `Install`、`ProcessCallback`、`ExchangeCodeForAccessTokenWithRetry`メソッドを修正
   - エラーハンドリングとログ出力を追加

3. **データベースへの設定**
   - 公開前レビュー用ストアにAPI Key/Secretを設定
   - 動作確認

4. **テスト・検証**
   - 単体テスト
   - 統合テスト
   - 既存ストアの後方互換性テスト

### Phase 2: セキュリティ強化（オプション・将来対応）

- `ApiSecret`の暗号化（ASP.NET Core Data Protection使用）
- Azure Key Vaultの活用を検討

---

## 技術的な詳細

### アーキテクチャ

**パターン2: バックエンド共有（推奨）**

```
Shopifyアプリ
  ├─ 公開アプリ（一般公開用）
  └─ カスタムアプリ（公開前レビュー用）
    ↓
フロントエンド（環境変数でAPI Keyを設定）
    ↓
バックエンド（共有、データベースからCredentials取得）
    ↓
データベース（全ストアを管理）
```

### データフロー

1. ユーザーがストアドメインを入力
2. バックエンドがデータベースからストア情報を取得
3. ストア情報に`ApiKey`と`ApiSecret`が保存されていれば使用
4. 保存されていない場合は、環境変数のデフォルト値を使用
5. OAuth認証フローを実行

### 既存実装との互換性

- ✅ 既存のストア（データベースにAPI Key/Secretが設定されていない）は、環境変数のデフォルト値で動作
- ✅ 既存のコードへの影響は最小限
- ✅ 段階的な移行が可能

---

## リスク・課題

### リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| データベースアクセスのパフォーマンス影響 | 低 | キャッシュの検討、インデックスの確認 |
| API Secretの平文保存 | 中 | Phase 2で暗号化を実装 |
| 既存ストアへの影響 | 低 | 後方互換性を確保（環境変数のデフォルト値を使用） |

### 課題

- ストアごとにAPI Key/Secretを設定する必要がある（管理負荷）
- 将来的にセキュリティを強化する必要がある（暗号化）

---

## 関連ドキュメント

- `公開アプリとカスタムアプリの構成パターン.md` - 詳細なアーキテクチャ説明
- `マルチCredentials管理方法.md` - Credentials管理の詳細
- `マルチアプリ対応アーキテクチャ.md` - 全体アーキテクチャ

---

## 備考

- この実装により、1つのバックエンドで複数のShopifyアプリ（公開/カスタム）に対応可能
- 追加のインフラ（App Service、Static Web Apps、SQL Database）は不要
- コスト効率を維持しながら柔軟性を向上

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-22 | 初版作成 |

